# 直接回答依據與水晶處方 — 命理說理層（Explainability Layer）交付說明

## 一、修改檔案清單

| 檔案 | 改動摘要 |
|------|----------|
| **js/explainability-layer.js** | 新增。命理說理輸出層：八字（日主/身強弱/喜忌神/流年作用/白話結論）、紫微（宮位/主星/四化/加分扣分）、梅花（本卦/體用/動爻/結論）、塔羅（牌名/牌組/含義/阻礙）、姓名學；`buildAll()` 產出「依據」用 evidenceList，缺項改為「未參與判斷：XXX」。 |
| **js/explainability-guard.js** | 新增。守門：八字說理須含身強/身弱、喜神、忌神；禁止「流年與命盤互動」「缺完整命理資料」「僅供參考」等抽象語；`crystalHasMingliReason` 檢查水晶是否綁定命理理由。 |
| **engine/fusionEngine.js** | 修改。產生「直接回答」時呼叫 `ExplainabilityLayer.buildAll()`，以說理結果取代原 evidenceList；組 fullText 後以 `ExplainabilityGuard.checkEvidenceText` 檢查；factorTexts 改為使用說理產出的 evidenceListForDisplay。 |
| **js/crystal-advice-synthesizer.js** | 修改。新增參數 `baziExplain`；每張卡片產出「命理背景」（日主/身強弱/喜神/忌神）、「為什麼選這顆」（補哪五行、補喜神或洩忌神）、「配戴方式為何這樣」（左/右手補洩、是否適合晚上）；跨系統證據缺項改為「未參與判斷：XXX」，不再使用「缺完整命理資料、僅供參考」；注意事項補強「能量過強時」處理。 |
| **js/crystal-recommendation.js** | 修改。`getCrystalRecommendationCards` 內呼叫 `ExplainabilityLayer.buildAll()` 取得 `texts.bazi`，傳入 `synthesizeCrystalCards(..., baziExplain)`。 |
| **js/main.js** | 修改。水晶卡片區塊新增顯示「命理背景」「為什麼選這顆」段落（`mingliBackground`、`whyThisCrystal`）。 |
| **index.html** | 修改。於 fusionEngine 前載入 `explainability-layer.js`、`explainability-guard.js`。 |

---

## 二、原本空話 → 現在怎麼寫

| 情境 | 原本（空話／禁止） | 現在（說理／合規） |
|------|---------------------|---------------------|
| 八字依據 | 「八字：八字流年與命盤互動」 | 「八字：日主：乙木（日主）。身強／身弱：身弱。喜神：水、金。忌神：火、土。本流年：丙午（火）。流年對日主：剋（流年剋日主，壓力較大）。白話：身弱宜借大運流年補益；流年丙午（火）流年剋日主…喜用水、金、忌火、土…」 |
| 紫微依據 | 「紫微：整體穩定」「紫微顯示有機會」 | 「紫微斗數：宮位：財帛。主星：武曲、天府。四化：武曲化祿。對本問題：星曜多，對本問題多為加分。」 |
| 梅花依據 | 「梅花：本卦水地比，體用比和，卦象尚可」 | 「梅花易數：本卦：水地比。體用：體卦為體，用卦為用（體用比和）。動爻：有（第3爻）。對應問題：卦象偏吉，短期／本月有機會，宜把握。」 |
| 塔羅依據 | 「塔羅：凱爾特十字十張牌綜合」 | 「塔羅：抽到：聖杯三正位（聖杯）；權杖五逆位（權杖）；… 牌組已標於括號。對本問題：核心位：…；阻礙或條件：…」 |
| 資料缺失 | 「缺完整命理資料，僅供參考」 | 「未參與判斷的項目：八字、塔羅（若已輸入請重新執行該步驟）」 |
| 水晶跨系統證據 | 「塔羅 (Cups)；（缺完整命理資料，僅供參考）」 | 「八字（相符）；梅花易數（相符）；（未參與判斷：塔羅）」 |
| 水晶卡片 | 僅「強推：與您目前命理象徵相符」＋通用配戴 | 每張卡片含「命理背景：日主 …；身強／身弱：…；喜神：…；忌神：…。」「為什麼選這顆：補土行；屬補喜神，利於命盤喜用。」「配戴方式為何這樣：左手為補…本水晶建議左手配戴以補益；…」＋該顆專屬注意事項（含能量過強時處理）。 |

---

## 三、完整實例（問題：「今年我年終可以破十萬嗎？」）

假設使用者已輸入八字、紫微、梅花、塔羅、姓名學，且八字為乙木日主身弱、喜水金忌火土，流年丙午火年。

### 直接回答

- **直接回答：** 有機會，但需條件配合。（整體機率約 52%）

### 依據（命理說理）

- **八字：** 日主：乙木（日主）。身強／身弱：身弱。喜神：水、金。忌神：火、土。本流年：丙午（火）。流年對日主：剋（流年剋日主，壓力較大）。白話：身弱宜借大運流年補益；流年丙午（火）流年剋日主，喜用水、金、忌火、土，流年為喜用則利、為忌則宜穩守。
- **紫微斗數：** 宮位：財帛。主星：武曲、天府。四化：武曲化祿。對本問題：星曜多，對本問題多為加分。
- **梅花易數：** 本卦：水地比。體用：體卦為體，用卦為用（體用比和）。動爻：有（第3爻）。對應問題：卦象偏吉，短期／本月有機會，宜把握。
- **塔羅：** 抽到：聖杯三正位（聖杯）；權杖五逆位（權杖）；… 對本問題：核心位：…；阻礙或條件：…
- **姓名學：** 人格／總格數理與三才五行已納入綜合評估。

### 水晶處方（單顆範例：黃水晶）

- **推薦結論：** 強推：與您目前命理象徵相符，可優先考慮。
- **命理背景：** 日主 乙木（日主）；身強／身弱：身弱；喜神：水、金；忌神：火、土。
- **為什麼選這顆：** 補土行；依問題意圖與五行傾向選配（或：屬補喜神，利於命盤喜用）。
- **跨系統證據：** 八字（相符）；梅花易數（相符）；（未參與判斷：塔羅）
- **配戴方式：** 配戴方式為何這樣：左手為補、右手為洩；本水晶建議左手配戴以補益；左手配戴；手鍊、項鍊為佳；白天、晚上皆可；…
- **注意事項：** 避免長時間曝曬，易褪色。若鑲金屬，金屬過敏者留意材質。能量過強時可縮短時段或搭配白水晶緩衝。

---

## 四、輸出守門（Guard）規則

- 八字說理未出現「身強／身弱」「喜神」「忌神」→ `ExplainabilityGuard.checkBaziExplainability` 不通過 → 仍輸出說理，但 console 會警告。
- 依據全文出現「流年與命盤互動」「缺完整命理資料」「僅供參考」等禁止語 → `checkEvidenceText` 不通過。
- 水晶推薦：每張卡片皆綁定「命理背景」與「為什麼選這顆」；若未提供八字則寫「未參與判斷：八字；其餘系統見跨系統證據」。

---

## 五、限制與備註

- 未使用任何外部 AI／API，僅規則、資料表與模板。
- 右側「可能性評估」各系統說明仍來自 ScoringEngine；若日後要改為說理文案，可改為使用 `ExplainabilityLayer` 的對應輸出。
- 紫微四化依 iztro 星盤結構讀取（`majorStars[].transform` 等）；若庫未提供四化欄位，四化顯示為「未取四化」。
