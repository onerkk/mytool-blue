# 八字分析邏輯架構（至尊版：輸入校準→定格→明病→察運→斷事）

本文件對應前端 `bazi-system.js`、`dayun-calculator.js`、`solar-term-calculator.js`、`scoring-engine.js` 的實際運行邏輯。

---

## 第零步：輸入校準——獲取絕對正確的四柱八字

**前提**：所有分析以正確四柱為根，錯則全錯。

### 年柱確認

- **規則**：以**立春**為年柱分界，非農曆正月初一。
- **操作**：輸入公曆年月日時，依萬年曆或節氣確認出生年立春時刻；立春前為上一年，立春後為當年。
- **爭議**：若軟體與古籍差異，以當年《紫金曆》或權威天文台節氣時刻為準。
- **程式**：`bazi-system.js` 年柱依節氣（立春）定年；`solar-term-calculator.js` 提供節氣資料。

### 月柱確認

- **規則**：以**十二節**（立春、驚蟄、清明…芒種、小暑…）為月柱分界，**不可用公曆月份直接對應**（否則如 6 月錯成辰月會導致季節錯、喜用神錯）。
- **操作**：查出生日處於哪兩個「節」之間；如 1994 年 6 月 20 日在芒種與小暑之間，故為**午月**（夏）。口訣「甲己之年丙作首…」依年干定月干。
- **季節鐵則**：寅卯辰=春、巳午未=夏、申酉戌=秋、亥子丑=冬；喜用神中的「季節」必須由此月支對照取得，避免與月支錯配。
- **程式**：`bazi-system.js` 月柱優先依 `SolarTermCalculator.getTermsForYear` 節氣定月支；fallback 用 `CALENDAR_MONTH_TO_ZHI_INDEX`（6→午）；季節用 `MONTH_ZHI_TO_SEASON`。

### 日柱確認（最關鍵易錯點）

- **規則**：以**每日 23:00（子時初）**為日界，本系統採用**主流「晚子時換日柱」**：任何軟體或個人習慣不得違背 23:00 為界。
- **操作**：
  - **23:00 前出生**：日柱用**當日**干支。
  - **23:00 後出生**：日柱用**次日**干支（晚子時換日柱）。
  - **早子時（00:00–00:59）**：日曆已為次日，日柱即當日日干。
- **參照**：公曆 1994 年 6 月 20 日 23:26 → 日柱取 6 月 21 日 → **戊寅**（非丁丑）。
- **程式**：`bazi-system.js` 之 `calculateDayPillarWithZiHourRule`：`hour >= 23` 時 `logicalDate` 為次日。

### 時柱確認

- **規則**：依日柱天干（已按 23:00 換日柱）按「五鼠遁」起時干；子時天干一定，順推即可。
- **採用晚子時換日柱時**：日柱已是次日干支，子時（23:00–01:00）**一律用日柱天干**起五鼠遁即可，無須再取「次日」天干。
- **示例**：1994-6-20 23:26 日柱戊寅 → 子時**壬子**（戊日起壬子）。
- **程式**：`bazi-system.js` 之 `calculateHourPillarWithZiHourRule`：子時用 `dayStem`（日柱天干）起五鼠遁。

**參照案例（學習排盤與喜用）**：公曆 1994 年 6 月 20 日 23:26 女 彰化 → 八字 **甲戌 庚午 戊寅 壬子**。年柱甲戌（立春後）、月柱庚午（芒種～小暑午月）、日柱戊寅（23:00 後換次日）、時柱壬子（戊日起壬子）。戊土午月印旺、年支戌比肩，身強；喜用金、水（食傷、財星），忌火、土。十神：年柱七殺比肩、月柱食神正印、日柱日主七殺、時柱偏財正財。

---

## 第一步：定格·定強弱（判斷身強身弱／特殊格局）

**權重：得令 50% + 得地 30% + 得勢 20%**

### 得令分析（月令權重 50%）

- **規則**：日主五行與月支五行的關係，依「旺相休囚死」。
- **旺**：月令與日主同五行 → 得令極強（分數 100）。
- **相**：月令生我 → 得令之生（75）。
- **休**：我生月令 → 泄氣（40）。
- **囚**：我克月令 → 耗力（20）。
- **死**：月令克我 → 失令（0）。

### 得地分析（地支根氣 30%）

- **強根**：地支本氣為日主同類（比劫），如甲木見寅卯。
- **生根**：地支為印星（生我者），如甲木見亥子。
- **餘氣根**：辰未戌丑藏干中含日主或印星。
- 依根氣多寡換算 0～100 分，再乘以權重 30%。

### 得勢分析（天干生扶 20%）

- 天干中印星與比劫多寡，換算 0～100 分，再乘以權重 20%。

### 綜合判定

- **身強**：綜合分 ≥ 55。喜克、泄、耗（官殺、食傷、財星）。
- **中和**：45 ≤ 綜合分 < 55。
- **身弱**：25 ≤ 綜合分 < 45。喜生、扶（印星、比劫）。
- **極弱**：綜合分 < 25。
- **專旺格**：日主五行佔比 ≥ 70%。
- **從格**：日主極弱且某一五行極旺（超過日主 2.5 倍以上）。

---

## 第二步：明病·定喜忌（喜用神與忌神）

### 找命局最旺／最弱五行

- 最旺五行：常為「病」源。
- 最弱或缺失五行：輔助判斷失衡。

### 治病方法與綜合裁定優先級

1. **調候**（優先）：冬生（亥子丑月）需火暖；夏生（巳午未月）需水潤。調候用神有時優先於扶抑。
2. **通關**：金木相戰時用水流通化解；兩五行相戰取能流通其氣之五行。
3. **扶抑**（最常用）：身強需抑制（喜官殺、食傷、財）；身弱需扶助（喜印、比劫）。
4. **病藥**：命局最旺五行為「病」，能克此病之五行為「藥」。

**綜合裁定**：以上四法結論需綜合權衡。**優先級為：調候 > 通關 > 扶抑**。若調候用神與扶抑用神衝突，以全局平衡為重。

### 輸出

- **喜用神**：對日主最有利、能平衡或改善命局的五行（含第一喜神、第二喜神）。
- **忌神**：會加劇失衡的五行（第一忌神、第二忌神）。

---

## 第三步：察運·觀流通（排大運與起運）

- **大運順逆鐵則**：**陽年男、陰年女 → 順排**（數至下一「節」）；**陰年男、陽年女 → 逆排**（數至上一「節」）。**陽年女命必逆排**，不可順排（順排會導致整條大運軌跡錯誤）。
- **起運歲數**：3 天 = 1 歲，1 日 = 4 月，1 時辰 = 10 天。逆排時從出生日逆數至上一節（如芒種），天數 ÷ 3 得起運歲數；約 4 歲 8 個月起運即約 14 天 ÷ 3。
- **大運排法**：順排從月柱下一組干支；逆排從月柱上一組干支。每步 10 年。每步大運可標註十神（如己巳 = 劫財+偏印，以日主推）。
- **真太陽時**：若有經度，起運以出生地真太陽時為準。
- **節氣**：無精確資料年份時，以近似 12 節推算，使每人起運歲數不同。
- **參照**：1994-6-20 23:26 女 彰化 → 甲戌年（陽年）女命逆排，起運約 4 歲 8 個月；4–13 己巳、14–23 戊辰、24–33 丁卯（當前）、34–43 丙寅、44–53 乙丑、54–73 甲子／癸亥（用神旺地）。

---

## 第四步：斷事·應吉凶（大運流年綜合判斷）

### 大運判斷

- **大運干支需整體分析，但地支力量占七成**（天干三成、地支七成）。
- **喜用神大運**：大運干支五行皆為喜用 → 人生順遂、機遇多的十年。
- **忌神大運**：大運干支五行皆為忌神 → 壓力大、宜蟄伏守成。
- **喜忌參半**：天干喜地支忌或反之 → 吉凶皆有，需細分時段與事件；地支為忌時影響更大。

### 流年判斷（見 `scoring-engine.js`）

- 流年干支與命盤喜用／忌神比對。
- 流年天干十神（正財、偏財、正官、七殺等）與問題類別（財運、事業、感情、健康）結合。
- 桃花星、天乙貴人等神煞納入理由文案。

### 輸出

- 命局特點（格局、身強弱、喜忌）。
- 大運每步標註：喜用神大運／忌神大運／喜忌參半／中性。
- 流年機率與理由（各維度評分與文字說明）。

---

## 總訣與心法

- **原局為根，大運為苗，流年為花**。命局決定基本盤，大運勾勒十年大勢，流年引發具體事件。
- **專論重點**：抓住命局最突出矛盾（如身弱傷官佩印），圍繞其分析。
- **知命用運**：分析為了解能量曲線，在順境中把握、在逆境中修心，做出更明智選擇。

---

## 程式對應

| 架構步驟         | 主要檔案／方法 |
|------------------|----------------|
| 第零步 輸入校準   | `bazi-system.js`: 年/月柱依節氣；`calculateDayPillarFor19830825`、`calculateDayPillarGeneric`（日柱 23:00 與早子／晚子）；`calculateHourPillar`（五鼠遁、夜子時用次日天干）；`solar-term-calculator.js`: 節氣 |
| 第一步 定格定強弱 | `bazi-system.js`: `_getDeLing`, `_getDeDi`, `_getDeShi`, `calculateElementStrength` |
| 第二步 明病定喜忌 | `bazi-system.js`: `calculateFavorableElements`（優先級：調候 > 通關 > 扶抑 > 病藥） |
| 第三步 察運觀流通 | `dayun-calculator.js`: `computeStartAge`, `calculate`；`solar-term-calculator.js`: `getTermsForYear`, `getNearestSolarTerms` |
| 第四步 斷事應吉凶 | `bazi-system.js`: `_tagDayunWithFavorable`（大運地支七成）；`scoring-engine.js`: `calculateBaziScore`（流年＋喜忌） |
