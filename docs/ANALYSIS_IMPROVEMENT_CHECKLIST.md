# 八字／多維分析系統：錯誤與改進校準清單

本文件整理外部回饋之主要錯誤與矛盾點，以及對應之架構／實作要點，供排盤與分析改進時對齊。

---

## 溶入運作狀態（已寫入規格 vs 已改程式）

| 項目 | 規格／文件 | 程式邏輯已溶入 |
|------|------------|----------------|
| 性別與大運順逆 | ✓ 架構 1.1、本清單 | ✓ 已有：dayun-calculator、bazi-system、main 表單傳 gender |
| 大運干支與分段 | ✓ 本清單 | ✓ 已有：JIAZI 表、起運歲數計算；**已加**：大運區塊顯示「起運：X歲Y月；大運順行/逆行」 |
| 流年流月針對提問時間 | ✓ 架構 11、本清單 | ✓ **已溶入**：scoring-engine 以 referenceDate（預設當前時間）排流年＋流月，buildSummaryReport 傳入 referenceDate；八字評分理由含流年流月 |
| 喜用神優先級／辯證 | ✓ 架構 6、本清單 | ✓ **已溶入**：bazi-system BaziUI 顯示「喜用神優先級」首要/次要/首要忌神＋「條件性用神／歲運注意」 |
| 姓名學結合性別（數理宜忌） | ✓ 本清單 | ✓ **已溶入**：總格 29 等陽剛之數，女性使用時加入「女性慎用」提示（generateSuggestions） |
| 多模塊機率權重透明 | ✓ MULTI_DIMENSION、本清單 | ✓ **已溶入**：結果頁直接回答區顯性標示「整合方式：加權平均（權重=置信度×方法可靠性；八字 0.85、姓名學 0.7、梅花 0.75、塔羅 0.75）」 |
| 梅花起卦與問題關聯 | ✓ 本清單 | ✓ **已溶入**：梅花區塊新增說明「與問題相關的起卦方式（時間／數字／漢字）更利解讀」 |
| 塔羅牌面與位置解讀 | ✓ 本清單 | ✓ 已有：位置解讀卡片含每張牌位置名稱、正逆位、牌義與建議 |
| 輸入標準化（顯性顯示） | ✓ 本清單 | ✓ **已溶入**：結果頁頂部「本次分析使用」卡片顯示性別、出生日期時間、真太陽時、經緯度；userData 存 useSolarTime |

**結論**：學習內容已**寫入規格與校準清單**，並**全部溶入運作**（網頁與手機共用同一套 JS/HTML，同步更新）。

---

## 一、性別與大運順逆（男女區別判定）

### 回饋要點
- 性別直接決定大運順逆：**男命陰年（如癸亥）大運逆排；女命則順排**。兩者格局與運勢截然不同。
- 若介面中性別選擇與使用者自述不一致（例如選「女」卻為男命），會導致整盤大運錯誤。

### 系統現狀（已具備男女區別）
- **有男女區別判定**：排盤時依性別決定大運順逆。
- **規則**：陽年男命、陰年女命 → **順行**（順數下一節）；陰年男命、陽年女命 → **逆行**（逆數上一節）。
- **實作位置**：
  - `js/dayun-calculator.js`：`forward = (isYangYear && isMale) || (!isYangYear && !isMale)`，並以 `forward` 決定月柱干支順逆推演。
  - `js/bazi-system.js`：`calculateBazi(fullBirthDate, gender, ...)`、`calculateGreatFortune(..., gender, ...)`，`direction = (isYangYear && isMale) || (!isYangYear && !isMale) ? '順行' : '逆行'`。
  - `js/main.js`：表單 `input[name="gender"]:checked` → `userData.gender`（'male'|'female'），傳入 `calculator.calculateBazi(..., this.userData.gender, ...)`。
- **注意**：錯誤多來自**輸入端性別與當事人實際性別不一致**，非程式未區分男女。UI 應提醒使用者確認性別，並在報告中顯性標示「男命／女命」與「大運順／逆」。

### 架構對齊
- `BAZI_FULL_ANALYSIS_ARCHITECTURE.md` 第 1 節：必要輸入含「性別（用於大運順逆）」。
- 大運輸出應註明：**起運歲數**、**順行／逆行**、**年干陰陽＋性別**（例：癸年陰年、男命、大運逆行）。

---

## 二、大運干支正確性與分段

### 回饋要點
- 大運干支不得出現不存在的組合（如「丁午」；正確應為六十甲子內，如戊午）。
- 大運年齡分段應以**精確起運歲數**為起點，每十年一運，而非固定 5–14、15–24。

### 系統現狀
- 干支來源：`dayun-calculator.js` 使用 `JIAZI` 六十甲子表，由月柱索引 `mx` 依順逆推 `idx`，取 `JIAZI[idx]`，故**理論上不會產生非法干支**。若曾出現「丁午」，可能為 UI 顯示時 gan/zhi 錯配或舊版 bug，需排查顯示邏輯。
- 起運歲數：`computeStartAge()` 依節氣差換算（3 日 = 1 歲），可回傳 `startYears`、`startMonths`、`startAgeInYears`；主流程會用 `startAge` 作為第一步大運起點。
- 分段：`ageStart = startAge + i * 10`，以起運歲為基準每十年一運；若節氣模組未注入或回傳 null，fallback 為固定 5 歲起。

### 改進對齊
- 大運列表與 UI 一律顯示**合法干支**（僅來自 JIAZI）；若發現 gan+zhi 拼裝處，改為從 `ganzhi` 或同一索引取成對干支。
- 輸出欄位註明「起運：虛歲 x 歲 y 月」及「大運順行／逆行」，並以起運為第一柱起算。

---

## 三、流年流月與問題針對性

### 回饋要點
- 針對「本月副業收入」等問題，應結合**提問當時**的流年、流月干支分析，而非僅引用單一未來年（如 2026 丙午）。

### 架構對齊
- `BAZI_FULL_ANALYSIS_ARCHITECTURE.md` 第 11 節：時序疊加須含流年、流月；應期與吉凶打分應可依「提問日」排流年流月。
- 實作建議：取「問題提交時間」或「當前時間」為基準，排流年＋流月干支，再與本命、大運疊加後做財運／事業等維度打分。

---

## 四、喜用神辯證與優先級

### 回饋要點
- 喜用神應分優先級並具辯證：例如身弱不宜洩，但「水木有力時，火可制金為用」。
- 建議：首用水（化殺生身），次喜木（助身抗殺），再次為火（制殺，需水木支撐）；忌神金、土。

### 架構對齊
- 第 6 節用神決策流程：格局 → 身強弱（扶抑）→ 五行偏枯／通關 → 調候；並需「用神失效條件」。
- 輸出應區分：Primary / Secondary / Conditional Favor，以及「在何種大運／流年下可轉為有用」的簡要說明。

---

## 五、姓名學與性別、五格／三才

### 回饋要點
- 總格 29 數等吉數，女性使用時需謹慎（陽剛之數）；應結合性別、五格搭配與三才配置綜合判斷。

### 系統現狀與改進
- 姓名學目前可傳入 `gender`（`nameology-system.js` 之 `analyzeFullName(name, birthYear, gender, baziFav)`）；可擴充：依性別對特定數理（如 29）給予「女性慎用」等提示，並在依據欄位註明「性別＋數理＋三才」。

---

## 六、多模塊機率整合透明度

### 回饋要點
- 整體成功率與各模塊（八字、姓名學、塔羅、梅花）的權重與整合方式應說明，避免僅簡單平均、缺乏依據。

### 架構對齊
- `MULTI_DIMENSION_PROBABILITY_STATUS.md` 已說明現狀與改進方向；整合公式或權重（如：財運以八字為主、姓名學為輔）應在介面或文件中**顯性標示**。

---

## 七、梅花易數起卦與問題關聯

### 回饋要點
- 建議以與問題相關的時間、數字或漢字起卦，確保卦象針對性，避免純隨機起卦。

### 架構對齊
- 起卦方法選項中，優先推廣「時間起卦（取當下或問題時間）」「數字／漢字起卦」，並在 UI 說明「與問題相關的起卦方式更利解讀」。

---

## 八、塔羅牌陣解讀透明化

### 回饋要點
- 應展示抽到的具體牌面、正逆位，以及每張牌在牌陣中的位置意義與綜合解讀。

### 架構對齊
- 結果區應含：牌陣圖／列表、每張牌名稱＋正逆位＋位置意義＋簡要解讀，以便驗證與追溯。

---

## 九、數據輸入標準化

### 回饋要點
- 性別、出生時間、姓名等關鍵資訊須一致且準確；真太陽時自動校正，並可提供經緯度查詢。

### 系統現狀
- 真太陽時可選啟用；出生地可選地區與城市（含經緯度）。可加強：在排盤結果旁顯性顯示「使用的性別、出生日期時間、是否真太陽時、經緯度」，減少輸入不一致造成的誤解。

---

## 總結對照

| 項目           | 架構／實作要點 |
|----------------|----------------|
| 性別與大運順逆 | 已有男女區別；輸入端性別須與當事人一致，並在輸出註明「男命／女命、大運順／逆」 |
| 大運干支與分段 | 干支限六十甲子；分段以精確起運歲數為起點，並註明起運時間 |
| 流年流月       | 以提問時間排流年流月，針對問題維度分析 |
| 喜用神         | 分優先級與辯證，標註條件性用神與失效條件 |
| 姓名學         | 結合性別、五格、三才，必要時標註數理性別宜忌 |
| 多模塊機率     | 公開權重與整合邏輯 |
| 梅花起卦       | 建議與問題相關之時間／數字／漢字起卦 |
| 塔羅           | 展示牌面、正逆位、位置意義與解讀 |
| 輸入標準化     | 顯性顯示所用性別、時間、真太陽時、經緯度 |

上述要點已納入本清單；後續實作與架構修訂時請依此校準。
