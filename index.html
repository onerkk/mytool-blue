<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes,viewport-fit=cover">
<meta name="description" content="靜月之光能量占卜儀：整合八字、紫微斗數、梅花易數、塔羅牌的多維度命理分析系統">
<meta name="theme-color" content="#1a0a0a">
<title>靜月之光能量占卜儀 v3.0</title>
<!-- Open Graph / Facebook / Threads -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://onerkk.github.io/mytool-blue/">
<meta property="og:title" content="靜月之光能量占卜儀 v3.0">
<meta property="og:description" content="靜月之光能量占卜儀：整合八字、紫微斗數、梅花易數、塔羅牌的多維度命理分析系統">
<meta property="og:image" content="https://onerkk.github.io/mytool-blue/ogimage.jpg">
<meta property="og:image:secure_url" content="https://onerkk.github.io/mytool-blue/ogimage.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:type" content="image/jpeg">
<meta property="og:image:alt" content="靜月之光能量占卜儀">
<meta property="og:locale" content="zh_TW">
<meta property="og:site_name" content="靜月之光">
<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="靜月之光能量占卜儀 v3.0">
<meta name="twitter:description" content="整合八字、紫微斗數、梅花易數、塔羅牌的多維度命理分析系統">
<meta name="twitter:image" content="https://onerkk.github.io/mytool-blue/ogimage.jpg">
<!-- Security Protection -->
<script>
(function(){
  var _0x=['onerkk.github.io','localhost','127.0.0.1'];
  var _h=location.hostname;
  var _ok=false;
  for(var i=0;i<_0x.length;i++){if(_h===_0x[i]||_h.endsWith('.'+_0x[i])){_ok=true;break;}}
  if(!_ok&&_h!==''){document.title='';document.body&&(document.body.innerHTML='<div style="text-align:center;padding:80px;font-family:sans-serif;color:#888"><h2>⛔ 未授權的存取</h2><p>此應用僅限於授權網域使用</p></div>');throw new Error('Domain not authorized');}
})();
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* ================================================================
   靜月之光 v3.0 — Complete Design System
   Aesthetic: Chinese Traditional Luxury (紅金傳統奢華)
   ================================================================ */
:root{
  --c-bg-deep:#0d0404;--c-bg:#1a0808;--c-bg-card:#1e0c0c;--c-bg-card-alt:#251010;
  --c-surface:rgba(255,255,255,0.04);--c-border:rgba(212,175,55,0.18);--c-border-hi:rgba(212,175,55,0.45);
  --c-gold:#d4af37;--c-gold-light:#e8c968;--c-gold-pale:#f5e6b8;
  --c-crimson:#8b0000;--c-crimson-hi:#b22222;
  --c-text:#f5e6d3;--c-text-dim:rgba(245,230,211,0.65);--c-text-muted:rgba(245,230,211,0.4);
  --c-success:#4ade80;--c-warn:#fbbf24;--c-danger:#f87171;--c-info:#60a5fa;
  --el-metal:#c0c0c0;--el-wood:#22c55e;--el-water:#3b82f6;--el-fire:#ef4444;--el-earth:#a78b5a;
  --f-display:'Noto Serif TC',serif;--f-body:'Noto Sans TC',sans-serif;
  --sp-xs:0.25rem;--sp-sm:0.5rem;--sp-md:1rem;--sp-lg:1.5rem;--sp-xl:2.5rem;
  --r-sm:8px;--r-md:14px;--r-lg:20px;--r-pill:999px;
  --sh-card:0 4px 24px rgba(0,0,0,0.4),0 0 0 1px var(--c-border);
  --t-fast:0.2s cubic-bezier(0.4,0,0.2,1);--t-smooth:0.4s cubic-bezier(0.4,0,0.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{
  font-family:var(--f-body);color:var(--c-text);
  background:var(--c-bg-deep);
  background-image:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(139,0,0,0.25) 0%,transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 100%,rgba(139,0,0,0.15) 0%,transparent 50%);
  background-attachment:fixed;min-height:100vh;line-height:1.6;
  -webkit-font-smoothing:antialiased;overflow-x:hidden;
}
a{color:var(--c-gold);text-decoration:none;transition:color var(--t-fast)}
a:hover{color:var(--c-gold-light)}
button,input,select,textarea{font-family:inherit;font-size:inherit;color:inherit}
::selection{background:rgba(212,175,55,0.3);color:#fff}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--c-bg)}
::-webkit-scrollbar-thumb{background:rgba(212,175,55,0.3);border-radius:3px}

/* — Layout — */
.app{max-width:960px;margin:0 auto;padding:0 var(--sp-md);padding-bottom:calc(env(safe-area-inset-bottom,0px) + 1rem)}

/* — Navigation — */
.nav{position:sticky;top:0;z-index:100;background:rgba(13,4,4,0.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--c-border);padding:0.75rem var(--sp-md)}
.nav-inner{max-width:960px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:var(--sp-md)}
.nav-brand{display:flex;align-items:center;gap:var(--sp-sm);font-family:var(--f-display);font-weight:700;font-size:1.1rem;color:var(--c-gold)}
.nav-brand i{font-size:1.3rem}
.nav-links{display:flex;gap:var(--sp-xs);flex-wrap:wrap}
.nav-link{padding:0.4rem 0.75rem;border-radius:var(--r-pill);font-size:0.8rem;font-weight:500;color:var(--c-text-dim);border:1px solid transparent;transition:all var(--t-fast);cursor:pointer;background:none;white-space:nowrap}
.nav-link:hover,.nav-link.active{color:var(--c-gold);border-color:var(--c-border-hi);background:rgba(212,175,55,0.08)}

/* — Step Sections — */
.step{display:none;animation:fadeIn .45s ease both}
.step.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
@keyframes slideInLeft{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}

.result-verdict{animation:scaleIn .6s ease .1s both}
.card{animation:fadeIn .5s ease both}
.card:nth-child(2){animation-delay:.1s}
.card:nth-child(3){animation-delay:.2s}
.card:nth-child(4){animation-delay:.3s}
.verdict-prob{
  background-size:200% 100%;
  animation:shimmer 3s ease-in-out infinite;
  background-image:linear-gradient(90deg,var(--c-gold),var(--c-gold-light),#fff,var(--c-gold-light),var(--c-gold));
  -webkit-background-clip:text;background-clip:text;
}
.hero-icon{animation:pulse 3s ease-in-out infinite}
.dy-item{animation:slideInLeft .3s ease both}
.dy-item:nth-child(2){animation-delay:.05s}
.dy-item:nth-child(3){animation-delay:.1s}
.dy-item:nth-child(4){animation-delay:.15s}
.dy-item:nth-child(5){animation-delay:.2s}

/* — Cards — */
.card{background:var(--c-bg-card);border:1px solid var(--c-border);border-radius:var(--r-lg);padding:var(--sp-lg);margin-bottom:2rem;box-shadow:var(--sh-card);transition:border-color var(--t-fast)}
.card:hover{border-color:var(--c-border-hi)}
.card-title{font-family:var(--f-display);font-weight:700;font-size:1.15rem;color:var(--c-gold);margin-bottom:var(--sp-md);display:flex;align-items:center;gap:var(--sp-sm)}
.card-title i{font-size:1rem;opacity:.8}

/* — Buttons — */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:var(--sp-sm);padding:.75rem 1.25rem;border-radius:var(--r-md);font-weight:600;font-size:.95rem;cursor:pointer;border:1px solid var(--c-border-hi);transition:all var(--t-fast);white-space:nowrap}
.btn-primary{background:linear-gradient(135deg,var(--c-crimson),#6b0000);color:var(--c-gold-pale);border-color:var(--c-gold);box-shadow:0 2px 12px rgba(139,0,0,.4)}
.btn-lg{font-size:1.1rem;padding:.9rem 2rem;animation:ctaPulse 2.5s ease-in-out infinite}
@keyframes ctaPulse{0%,100%{box-shadow:0 2px 12px rgba(139,0,0,.4)}50%{box-shadow:0 4px 24px rgba(212,175,55,.5)}}
.btn-primary:hover{background:linear-gradient(135deg,var(--c-crimson-hi),var(--c-crimson));box-shadow:0 4px 20px rgba(139,0,0,.6);transform:translateY(-1px)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-outline{background:transparent;color:var(--c-text-dim);border-color:rgba(255,255,255,.15)}
.btn-outline:hover{color:var(--c-gold);border-color:var(--c-border-hi);background:rgba(212,175,55,.06)}
.btn-gold{background:linear-gradient(135deg,var(--c-gold),#b8941f);color:var(--c-bg-deep);border:none;font-weight:700}
.btn-gold:hover{box-shadow:0 4px 20px rgba(212,175,55,.4);transform:translateY(-1px)}
.btn-sm{padding:.5rem .85rem;font-size:.85rem}
.btn-tab-active{background:linear-gradient(135deg,var(--c-crimson),#6b0000)!important;color:var(--c-gold-pale)!important;border-color:var(--c-gold)!important}
.btn-lg{padding:1rem 2rem;font-size:1.05rem}
.btn-block{width:100%}

/* — Form — */
.form-group{margin-bottom:var(--sp-lg)}
.form-label{display:block;font-size:.9rem;font-weight:600;color:var(--c-text);margin-bottom:var(--sp-xs)}
.form-label .req{color:var(--c-danger);margin-left:2px}
.form-hint{font-size:.8rem;color:var(--c-text-muted);margin-top:var(--sp-xs)}
.form-input,.form-select,.form-textarea{width:100%;padding:.75rem 1rem;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:var(--r-sm);color:var(--c-text);font-size:1rem;transition:border-color var(--t-fast),box-shadow var(--t-fast)}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--c-gold);box-shadow:0 0 0 3px rgba(212,175,55,.15)}
.form-textarea{resize:vertical;min-height:80px}
.radio-pills{display:flex;gap:var(--sp-sm);flex-wrap:wrap}
.radio-pill{position:relative}
.radio-pill input{position:absolute;opacity:0;pointer-events:none}
.radio-pill span{display:inline-block;padding:.6rem 1.2rem;border:1px solid rgba(255,255,255,.12);border-radius:var(--r-pill);cursor:pointer;font-size:.9rem;transition:all var(--t-fast)}
.radio-pill input:checked+span{border-color:var(--c-gold);color:var(--c-gold);background:rgba(212,175,55,.12)}

/* — Stepper — */
.stepper{display:flex;align-items:center;justify-content:center;padding:var(--sp-md) 0;margin-bottom:var(--sp-md)}
.stepper-item{display:flex;align-items:center;gap:.4rem;font-size:.8rem;color:var(--c-text-muted);transition:color var(--t-fast)}
.stepper-item.active{color:var(--c-gold);font-weight:600}
.stepper-item.done{color:var(--c-success)}
.stepper-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.15);font-size:.75rem;font-weight:700;transition:all var(--t-fast)}
.stepper-item.active .stepper-dot{border-color:var(--c-gold);background:rgba(212,175,55,.15);color:var(--c-gold)}
.stepper-item.done .stepper-dot{border-color:var(--c-success);background:rgba(74,222,128,.15);color:var(--c-success)}
.stepper-line{width:30px;height:2px;background:rgba(255,255,255,.1);margin:0 .3rem}

/* — Hero — */
.hero{text-align:center;padding:var(--sp-xl) 0 var(--sp-lg)}
.hero-icon{font-size:2.5rem;color:var(--c-gold);margin-bottom:var(--sp-md);text-shadow:0 0 40px rgba(212,175,55,.4)}
.hero h1{font-family:var(--f-display);font-weight:900;font-size:clamp(1.5rem,5vw,2.2rem);color:var(--c-gold-light);margin-bottom:var(--sp-sm);letter-spacing:.05em}
.hero p{color:var(--c-text-dim);font-size:.95rem;max-width:500px;margin:0 auto}

/* — BaZi Grid — */
.bazi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;background:var(--c-border);border-radius:var(--r-md);overflow:hidden;margin:var(--sp-md) 0}
.bazi-cell{background:var(--c-bg-card);padding:var(--sp-sm) var(--sp-xs);text-align:center}
.bazi-cell.header{background:rgba(212,175,55,.08);font-size:.75rem;color:var(--c-text-dim);font-weight:600}
.bazi-cell .gz{font-family:var(--f-display);font-size:1.3rem;font-weight:700;display:block;margin-bottom:2px}
.bazi-cell .gz-sub{font-size:.7rem;color:var(--c-text-muted)}
.el-tag{display:inline-block;padding:1px 6px;border-radius:var(--r-pill);font-size:.65rem;font-weight:600;margin-top:2px}
.el-金{background:rgba(192,192,192,.15);color:var(--el-metal)}
.el-木{background:rgba(34,197,94,.15);color:var(--el-wood)}
.el-水{background:rgba(59,130,246,.15);color:var(--el-water)}
.el-火{background:rgba(239,68,68,.15);color:var(--el-fire)}
.el-土{background:rgba(167,139,90,.15);color:var(--el-earth)}

/* — Five Element Bar — */
.el-bar{margin:var(--sp-sm) 0}
.el-row{display:flex;align-items:center;gap:var(--sp-sm);margin-bottom:6px}
.el-lbl{width:28px;text-align:center;font-weight:700;font-size:.85rem}
.el-track{flex:1;height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden}
.el-fill{height:100%;border-radius:4px;transition:width .8s ease}
.el-val{width:36px;text-align:right;font-size:.8rem;color:var(--c-text-dim)}

/* — DaYun Timeline — */
.dayun-tl{display:flex;overflow-x:auto;gap:2px;padding:var(--sp-sm) 0;-webkit-overflow-scrolling:touch}
.dy-item{flex:0 0 auto;min-width:78px;padding:var(--sp-sm) 6px;text-align:center;border-radius:var(--r-sm);border:1px solid var(--c-border);background:var(--c-bg-card);cursor:pointer;transition:all var(--t-fast);font-size:.8rem;position:relative}
.dy-item.current{border-width:2.5px!important;border-color:var(--c-gold)!important;box-shadow:0 0 14px rgba(212,175,55,.45),inset 0 0 8px rgba(212,175,55,.08)!important;position:relative}
.dy-item.current::after{content:'當前';position:absolute;top:-9px;left:50%;transform:translateX(-50%);background:var(--c-gold);color:#1a0a0a;font-size:.55rem;font-weight:700;padding:1px 6px;border-radius:8px;line-height:1.3;white-space:nowrap}
.dy-item .dy-gz{font-family:var(--f-display);font-weight:700;font-size:1.05rem;display:block}
.dy-item .dy-age{color:var(--c-text-muted);font-size:.7rem}
.dy-item .dy-lv{display:inline-block;padding:2px 8px;border-radius:var(--r-pill);font-size:.65rem;font-weight:600;margin-top:4px}
/* ── 能量等級：pill 標籤色 ── */
.lv-dj{background:rgba(74,222,128,.2);color:#4ade80}
.lv-zj{background:rgba(96,165,250,.2);color:#60a5fa}
.lv-xj{background:rgba(212,175,55,.2);color:var(--c-gold)}
.lv-p{background:rgba(255,255,255,.08);color:var(--c-text-dim)}
.lv-xk{background:rgba(251,191,36,.18);color:#fbbf24}
.lv-zk{background:rgba(248,113,113,.18);color:#f87171}
.lv-dk{background:rgba(180,40,40,.25);color:#ff6b6b}
/* ── 能量等級：格子邊框 + 底色 ── */
.dy-item.dy-lv-dj{border-color:#4ade80;background:rgba(74,222,128,.08)}
.dy-item.dy-lv-zj{border-color:#60a5fa;background:rgba(96,165,250,.07)}
.dy-item.dy-lv-xj{border-color:var(--c-gold);background:rgba(212,175,55,.07)}
.dy-item.dy-lv-p{border-color:var(--c-border);background:var(--c-bg-card)}
.dy-item.dy-lv-xk{border-color:#fbbf24;background:rgba(251,191,36,.06)}
.dy-item.dy-lv-zk{border-color:#f87171;background:rgba(248,113,113,.07)}
.dy-item.dy-lv-dk{border-color:#ef4444;background:rgba(180,40,40,.1)}
/* current 已用 !important 統一覆蓋所有 dy-lv 邊框色 */

/* — Hexagram — */
.hex-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp-sm);margin:var(--sp-md) 0;overflow:hidden}
.hex-card{text-align:center;padding:var(--sp-sm);background:rgba(0,0,0,.2);border:1px solid var(--c-border);border-radius:var(--r-md);min-width:0;overflow:hidden}
.hex-card h4{color:var(--c-text-dim);font-size:.75rem;margin-bottom:var(--sp-xs)}
.hex-sym{font-size:1.8rem;line-height:1;margin-bottom:var(--sp-xs)}
.hex-name{font-family:var(--f-display);font-weight:700;color:var(--c-gold);font-size:0.95rem;word-break:keep-all}

/* — Tarot — */
.tarot-hand{display:flex;justify-content:center;gap:var(--sp-sm);flex-wrap:wrap;padding:var(--sp-lg) 0}
.t-card{width:76px;height:114px;perspective:600px;cursor:pointer}
.t-card-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .6s ease}
.t-card.flipped .t-card-inner{transform:rotateY(180deg)}
.t-card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:.7rem;text-align:center;padding:4px}
.t-back{background:linear-gradient(135deg,#2a1a3e,#1a0a2e);border:2px solid var(--c-gold);color:var(--c-gold)}
.t-back::after{content:'✦';font-size:1.5rem;opacity:.6}
.t-front{transform:rotateY(180deg);background:var(--c-bg-card-alt);border:2px solid var(--c-border-hi);color:var(--c-text);gap:2px}
.t-front .tc-name{font-family:var(--f-display);font-weight:700;font-size:.72rem;color:var(--c-gold)}
.t-front .tc-dir{font-size:.6rem;color:var(--c-text-dim)}

/* ── Interactive Tarot Deck ── */
.tarot-deck-wrap{position:relative;width:100%;overflow:hidden;padding:16px 0}
.tarot-deck-scroll{display:flex;gap:6px;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding:12px 24px;scrollbar-width:none}
.tarot-deck-scroll::-webkit-scrollbar{display:none}
.tarot-deck-card{flex:0 0 58px;height:90px;perspective:800px;cursor:pointer;scroll-snap-align:center;transition:transform .25s,opacity .3s;position:relative}
.tarot-deck-card:hover{transform:translateY(-12px)}
.tarot-deck-card.picked{opacity:.25;pointer-events:none;transform:scale(.85)}
.tarot-deck-card-inner{width:100%;height:100%;border-radius:6px;background:linear-gradient(145deg,#1e0e30,#12082a);border:1.5px solid rgba(212,175,55,.5);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.5);position:relative;overflow:hidden}
.tarot-deck-card-inner::before{content:'';position:absolute;inset:3px;border:1px solid rgba(212,175,55,.15);border-radius:4px}
.tarot-deck-card-inner::after{content:'✦';font-size:1.1rem;color:var(--c-gold);opacity:.5}
.tarot-deck-card.glow .tarot-deck-card-inner{border-color:var(--c-gold);box-shadow:0 0 16px rgba(212,175,55,.5)}
.tarot-chosen-area{position:relative;padding:12px 0;display:flex;justify-content:center;gap:12px}
/* Celtic Cross Grid: left=十字(6), right=直列(4) */
.celtic-cross{position:relative;width:210px;height:260px;flex-shrink:0}
.celtic-staff{display:flex;flex-direction:column;gap:6px;align-items:center;width:68px}
.tarot-chosen-slot{width:62px;height:92px;border:1.5px dashed rgba(212,175,55,.18);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.5rem;color:rgba(212,175,55,.3);position:absolute;transition:all .3s}
.celtic-staff .tarot-chosen-slot{position:relative}
.tarot-chosen-slot.filled{border-color:transparent}
.tarot-chosen-slot .slot-label{position:absolute;bottom:-13px;font-size:.45rem;color:var(--c-text-muted);white-space:nowrap;text-align:center;width:76px;left:50%;transform:translateX(-50%)}
.tarot-chosen-slot .slot-num{font-size:.6rem;opacity:.35}
/* Cross positions */
.cc-1{left:74px;top:84px}
.cc-2{left:74px;top:84px;z-index:2}
.cc-2 .tarot-reveal,.cc-2 .tarot-reveal-inner,.cc-2 .tarot-reveal-back,.cc-2 .tarot-reveal-front{transform-origin:center}
.cc-2.filled{transform:rotate(90deg)}
.cc-3{left:74px;top:168px}
.cc-4{left:2px;top:84px}
.cc-5{left:74px;top:0px}
.cc-6{left:146px;top:84px}
.tarot-fly-card{position:fixed;width:58px;height:90px;border-radius:6px;background:linear-gradient(145deg,#1e0e30,#12082a);border:1.5px solid var(--c-gold);z-index:9999;pointer-events:none;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(212,175,55,.6);transition:all .5s cubic-bezier(.4,0,.2,1)}
.tarot-fly-card::after{content:'✦';font-size:1.1rem;color:var(--c-gold)}
.tarot-reveal{width:68px;height:102px;perspective:800px;position:absolute;top:0;left:0}
.tarot-reveal-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .7s ease}
.tarot-reveal.flipping .tarot-reveal-inner{transform:rotateY(180deg)}
.tarot-reveal-back{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:6px;background:linear-gradient(145deg,#1e0e30,#12082a);border:1.5px solid var(--c-gold);display:flex;align-items:center;justify-content:center}
.tarot-reveal-back::after{content:'✦';font-size:1.2rem;color:var(--c-gold);opacity:.6}
.tarot-reveal-front{position:absolute;width:100%;height:100%;backface-visibility:hidden;transform:rotateY(180deg);border-radius:6px;border:1.5px solid var(--c-border-hi);background:var(--c-bg-card-alt);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3px;overflow:hidden}
.tarot-reveal-front .tc-name{font-family:var(--f-display);font-weight:700;font-size:.6rem;color:var(--c-gold);line-height:1.2}
.tarot-reveal-front .tc-dir{font-size:.5rem;padding:1px 4px;border-radius:3px;margin-top:1px}
.tarot-reveal-front .tc-dir.up{color:#6cf;background:rgba(102,204,255,.1)}
.tarot-reveal-front .tc-dir.rv{color:#f66;background:rgba(255,102,102,.1)}
.tarot-reveal-front .tc-img{width:48px;height:74px;object-fit:cover;border-radius:3px}
.tarot-pick-hint{text-align:center;padding:6px;font-size:.7rem;color:var(--c-gold);opacity:0;animation:hintPulse 2s infinite}
.act2-card{margin-bottom:var(--sp-sm)!important}
.act2-card .card-title{margin-bottom:var(--sp-xs)}
.expert-comment-card{position:relative;overflow:hidden}
.expert-comment-card::before{content:'';position:absolute;top:0;right:0;width:80px;height:80px;background:radial-gradient(circle,rgba(212,175,55,.08),transparent);border-radius:50%}
.energy-locked-badge{display:inline-flex;align-items:center;gap:6px;margin-top:8px;padding:6px 14px;background:linear-gradient(135deg,rgba(212,175,55,.12),rgba(212,175,55,.05));border:1px solid rgba(212,175,55,.35);border-radius:20px;font-size:.75rem;color:var(--c-gold);animation:lockPulse 3s ease-in-out infinite}
@keyframes lockPulse{0%,100%{box-shadow:0 0 0 0 rgba(212,175,55,0)}50%{box-shadow:0 0 12px 2px rgba(212,175,55,.2)}}
@keyframes hintPulse{0%,100%{opacity:.3}50%{opacity:.8}}

/* — Result — */
.result-verdict{text-align:center;padding:var(--sp-lg);border:2px solid var(--c-gold);border-radius:var(--r-lg);background:linear-gradient(180deg,rgba(212,175,55,.08),rgba(139,0,0,.08));margin-bottom:var(--sp-lg)}
.verdict-label{font-family:var(--f-display);font-weight:900;font-size:1.8rem;color:var(--c-gold-light);margin-bottom:var(--sp-xs)}
.verdict-prob{font-size:2.5rem;font-weight:900;background:linear-gradient(135deg,var(--c-gold),var(--c-gold-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.verdict-note{color:var(--c-text-dim);font-size:.9rem;margin-top:var(--sp-sm)}
.prob-meter{margin:var(--sp-md) 0}
.prob-bar{height:12px;background:rgba(255,255,255,.06);border-radius:6px;overflow:hidden}
.prob-fill{height:100%;border-radius:6px;background:linear-gradient(90deg,var(--c-crimson),var(--c-gold),var(--c-success));transition:width 1.2s cubic-bezier(.4,0,.2,1)}
.prob-labels{display:flex;justify-content:space-between;font-size:.7rem;color:var(--c-text-muted);margin-top:4px}

/* — Dimension Tabs — */
.dim-tabs{display:flex;gap:2px;margin-bottom:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.dim-tab{flex:0 0 auto;padding:.6rem 1rem;border-radius:var(--r-sm) var(--r-sm) 0 0;background:rgba(255,255,255,.04);border:1px solid var(--c-border);border-bottom:none;font-size:.85rem;font-weight:500;color:var(--c-text-dim);cursor:pointer;transition:all var(--t-fast);white-space:nowrap}
.dim-tab.active{background:var(--c-bg-card);color:var(--c-gold);border-color:var(--c-border-hi)}
.dim-pane{display:none;padding:var(--sp-lg);background:var(--c-bg-card);border:1px solid var(--c-border);border-radius:0 var(--r-md) var(--r-md) var(--r-md)}
.dim-pane.active{display:block;animation:fadeIn .3s ease}

/* — Conclusion — */
.conclusion{background:linear-gradient(135deg,rgba(139,0,0,.15),rgba(212,175,55,.08));border:1px solid var(--c-border-hi);border-radius:var(--r-lg);padding:var(--sp-lg);margin-top:var(--sp-lg)}
/* Collapsible cards */
.collapsible-card{overflow:hidden}
.collapsible-toggle{cursor:pointer;display:flex;justify-content:space-between;align-items:center;user-select:none;margin:0}
.collapsible-toggle:hover{opacity:.85}
.collapse-arrow{transition:transform .3s ease;font-size:.8rem;opacity:.6}
.collapsible-card.open .collapse-arrow{transform:rotate(180deg)}
.collapsible-body{max-height:0;overflow:hidden;transition:max-height .4s ease,padding .3s ease;padding:0 var(--sp-md)}
.collapsible-card.open .collapsible-body{max-height:5000px;padding:var(--sp-md)}
/* Daily fortune collapse on step-0 */
.daily-mini{border:1px solid var(--c-border);border-radius:var(--r-md);margin-bottom:var(--sp-md);overflow:hidden}
.daily-mini-toggle{display:flex;justify-content:space-between;align-items:center;padding:var(--sp-sm) var(--sp-md);cursor:pointer;background:rgba(212,175,55,.06);font-size:.9rem;color:var(--c-gold)}
.daily-mini-toggle:hover{background:rgba(212,175,55,.12)}
.daily-mini-body{max-height:0;overflow:hidden;transition:max-height .4s ease}
.daily-mini.open .daily-mini-body{max-height:2000px}
.daily-mini.open .daily-mini-arrow{transform:rotate(180deg)}
.daily-mini-arrow{transition:transform .3s ease}
/* Remedy Alert - emotional trigger */
.remedy-alert{border:1px solid var(--c-border);background:linear-gradient(135deg,rgba(212,175,55,.04),rgba(30,12,12,.6));position:relative;overflow:visible}
.remedy-alert.alert-danger{border-color:rgba(248,113,113,0.5);background:linear-gradient(135deg,rgba(180,30,30,.12),rgba(30,12,12,.8));animation:pulse-danger 2s ease-in-out infinite}
@keyframes pulse-danger{0%,100%{box-shadow:0 0 0 0 rgba(248,113,113,0)}50%{box-shadow:0 0 20px 2px rgba(248,113,113,0.15)}}
.remedy-alert-header{display:flex;align-items:flex-start;gap:var(--sp-md);margin-bottom:var(--sp-md)}
.remedy-icon{font-size:2.2rem;flex-shrink:0;line-height:1}
.remedy-title{color:var(--c-gold);font-size:1.15rem;margin:0 0 .3rem 0;font-weight:700}
.remedy-subtitle{color:var(--c-text-dim);font-size:.9rem;margin:0}
.remedy-diagnosis{background:rgba(0,0,0,.2);border-radius:var(--r-md);padding:var(--sp-md);margin-bottom:var(--sp-md)}
.remedy-diagnosis .diag-row{display:flex;align-items:center;gap:var(--sp-sm);padding:.5rem 0;border-bottom:1px solid rgba(255,255,255,.06)}
.remedy-diagnosis .diag-row:last-child{border-bottom:none}
.diag-label{font-size:.85rem;color:var(--c-text-dim);min-width:4.5rem}
.diag-value{font-size:.95rem;font-weight:600}
.diag-bar-wrap{flex:1;height:8px;background:rgba(255,255,255,.08);border-radius:4px;overflow:hidden}
.diag-bar{height:100%;border-radius:4px;transition:width .6s ease}
.diag-tag{font-size:.75rem;padding:2px 6px;border-radius:3px;font-weight:600}
.diag-tag-lack{background:rgba(248,113,113,.2);color:#f87171}
.diag-tag-critical{background:rgba(248,60,60,.25);color:#ff4444;font-weight:700}
.diag-tag-excess{background:rgba(100,200,255,.2);color:#64c8ff}
.diag-tag-ok{background:rgba(100,255,100,.15);color:#7ddf7d}
.remedy-arrow{display:flex;align-items:center;justify-content:center;gap:var(--sp-sm);padding:var(--sp-sm) 0}
.text-gold{color:var(--c-gold)}
/* Remedy Plan */
.remedy-plan{border:2px solid rgba(212,175,55,.3);background:linear-gradient(135deg,rgba(212,175,55,.06),rgba(139,0,0,.04))}
.remedy-actions .action-item{display:flex;gap:var(--sp-md);padding:var(--sp-md);border-bottom:1px solid var(--c-border);align-items:flex-start}
.remedy-actions .action-item:last-child{border-bottom:none}
.action-num{width:2rem;height:2rem;background:var(--c-gold);color:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem;flex-shrink:0}
.action-content{flex:1}
.action-title{font-weight:700;color:var(--c-gold);margin-bottom:.3rem}
.action-desc{font-size:.9rem;color:var(--c-text-dim);line-height:1.6}
.action-crystal{display:inline-flex;align-items:center;gap:.3rem;background:rgba(212,175,55,.12);border:1px solid rgba(212,175,55,.3);border-radius:var(--r-sm);padding:.2rem .6rem;margin-top:.5rem;font-size:.85rem;color:var(--c-gold);cursor:pointer}
.action-crystal:hover{background:rgba(212,175,55,.2)}
/* Detail toggle in answer section */
.detail-toggle-wrap.open .detail-toggle-body{max-height:3000px !important;overflow:visible !important}
.detail-toggle-wrap.open .fa-chevron-right{transform:rotate(90deg)}
.conclusion h3{font-family:var(--f-display);color:var(--c-gold);margin-bottom:var(--sp-md)}

/* — Actions — */
.actions{display:flex;gap:var(--sp-sm);justify-content:space-between;margin-top:var(--sp-lg);flex-wrap:wrap}
.actions-center{justify-content:center}

/* — Utilities — */
.text-gold{color:var(--c-gold)}.text-dim{color:var(--c-text-dim)}.text-muted{color:var(--c-text-muted)}
.text-success{color:var(--c-success)}.text-warn{color:var(--c-warn)}.text-danger{color:var(--c-danger)}
.text-center{text-align:center}.text-sm{font-size:.85rem}.text-xs{font-size:.75rem}
.mt-sm{margin-top:var(--sp-sm)}.mt-md{margin-top:var(--sp-md)}.mt-lg{margin-top:var(--sp-lg)}
.mb-sm{margin-bottom:var(--sp-sm)}.mb-md{margin-bottom:var(--sp-md)}.mb-lg{margin-bottom:var(--sp-lg)}
.hidden{display:none!important}
.serif{font-family:var(--f-display)}
.tag{display:inline-block;padding:2px 8px;border-radius:var(--r-pill);font-size:.75rem;font-weight:600}
.tag-gold{background:rgba(212,175,55,.15);color:var(--c-gold)}
.tag-red{background:rgba(239,68,68,.15);color:var(--c-danger)}
.tag-green{background:rgba(74,222,128,.15);color:var(--c-success)}
.tag-blue{background:rgba(96,165,250,.15);color:var(--c-info)}
.divider{height:1px;background:linear-gradient(90deg,transparent,var(--c-border-hi),transparent);margin:var(--sp-lg) 0}

/* — ZiWei Grid — */
.zw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;background:var(--c-border);border-radius:var(--r-md);overflow:hidden;margin:var(--sp-md) 0}
.zw-cell{background:var(--c-bg-card);padding:var(--sp-sm);min-height:85px;font-size:.75rem;position:relative}
.zw-cell.zw-center{grid-column:2/4;grid-row:2/4;display:flex;align-items:center;justify-content:center;flex-direction:column;background:var(--c-bg-card-alt);text-align:center;min-height:170px}
.zw-palace{font-weight:700;color:var(--c-gold);font-size:.8rem;margin-bottom:2px}
.zw-branch{font-size:.65rem;color:var(--c-text-muted)}
.zw-stars{margin-top:3px;line-height:1.5}
.zw-star{display:inline;margin-right:3px}
.zw-star.major{color:var(--c-gold-light);font-weight:600}
.zw-star.minor{color:var(--c-text-dim)}
.zw-star.zw-m2{color:#8ba;font-size:.65rem}
.zw-star.zw-m3{color:#777;font-size:.6rem}
.zw-bright{font-size:.5rem;color:#9ab;vertical-align:super;margin-left:-2px;margin-right:2px}
.zw-hua{font-size:.55rem;padding:0 2px;border-radius:2px;background:rgba(212,175,55,.2);color:var(--c-gold);vertical-align:super;margin-left:1px}
.zw-cell.active-palace{border:1px solid var(--c-gold);background:rgba(212,175,55,.06)}

/* — Crystal — */
.crystal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:var(--sp-md);margin:var(--sp-md) 0}
.crystal-card{padding:var(--sp-md);border-radius:var(--r-md);border:1px solid var(--c-border);background:var(--c-bg-card);text-align:center;transition:all var(--t-fast)}
.crystal-card:hover{border-color:var(--c-gold);transform:translateY(-2px)}
.crystal-icon{font-size:2rem;margin-bottom:var(--sp-sm)}
.crystal-name{font-family:var(--f-display);font-weight:700;color:var(--c-gold);margin-bottom:var(--sp-xs)}

/* — Responsive — */
@media(max-width:640px){
  .bazi-cell .gz{font-size:1.1rem}
  .nav-links{display:none}
  .stepper{flex-wrap:wrap;gap:.3rem}
  .stepper-line{width:16px}
  .hex-grid{gap:var(--sp-xs)}
  .hex-card{padding:var(--sp-xs) 2px}
  .hex-name{font-size:0.85rem}
}
@media(max-width:380px){
  .hero h1{font-size:1.3rem}
  .card{padding:var(--sp-md)}
}

/* — Shop Buttons — */
.shop-btns{display:flex;flex-direction:column;gap:var(--sp-sm)}
.shop-btn-card{display:flex;align-items:center;gap:var(--sp-md);padding:1rem 1.2rem;border-radius:var(--r-md);border:1px solid var(--c-border);background:var(--c-bg-card-alt);color:var(--c-text);text-decoration:none;transition:all var(--t-fast);cursor:pointer;font-family:inherit;font-size:inherit;text-align:left;width:100%}
.shop-btn-card:hover{border-color:var(--c-gold);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.shop-btn-card i{font-size:1.3rem;width:32px;text-align:center;flex:0 0 auto}
.shop-btn-card div{display:flex;flex-direction:column;gap:1px}
.shop-btn-card.shopee i{color:var(--c-gold)}
.shop-btn-card.seven i{color:var(--c-gold)}
.shop-btn-card.custom i{color:var(--c-gold)}
.shop-btn-card strong{color:var(--c-text)}
.shop-card{border:2px solid rgba(212,175,55,.4);background:linear-gradient(135deg,rgba(139,0,0,.1),rgba(212,175,55,.06));margin-top:var(--sp-xl);padding:var(--sp-xl)}

/* — Nav Shop — */
.nav-shop{display:flex;gap:var(--sp-xs);align-items:center}
.nav-shop a{font-size:.75rem;padding:.35rem .6rem;border-radius:var(--r-pill);border:1px solid rgba(255,255,255,.12);color:var(--c-text-dim);transition:all var(--t-fast);white-space:nowrap}
.nav-shop a:first-child{color:var(--c-gold);border-color:rgba(212,175,55,.35)}
.nav-shop a:last-child{color:var(--c-gold);border-color:rgba(212,175,55,.35)}
.nav-shop a:hover{border-color:var(--c-gold);color:var(--c-gold)}

/* — Modal — */
.modal-overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:var(--sp-md)}
.modal-box{background:var(--c-bg-card);border:1px solid var(--c-border-hi);border-radius:var(--r-lg);padding:var(--sp-lg);max-width:480px;width:100%;max-height:90vh;overflow-y:auto;position:relative;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:scaleIn .3s ease}
.modal-close{position:absolute;top:var(--sp-sm);right:var(--sp-md);background:none;border:none;color:var(--c-text-dim);font-size:1.5rem;cursor:pointer;padding:4px 8px;border-radius:var(--r-sm);transition:color var(--t-fast)}
.modal-close:hover{color:var(--c-gold)}

/* — Floating Buttons — */
.floating-root{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 56px);right:12px;z-index:900;display:flex;flex-direction:column-reverse;align-items:flex-end;gap:var(--sp-sm)}
.fab{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(212,175,55,.5);cursor:pointer;transition:all var(--t-fast);text-decoration:none;font-family:inherit;flex-direction:column;gap:2px;font-size:.6rem;color:var(--c-text)}
.fab i{font-size:1rem}
.fab span{font-size:.5rem;line-height:1}
.fab-toggle{background:rgba(30,12,12,.9);color:var(--c-gold);border-color:rgba(212,175,55,.4);box-shadow:0 4px 16px rgba(0,0,0,.4)}
.fab-toggle:hover{transform:scale(1.1)}
.fab-shopee{background:rgba(212,175,55,.1);color:var(--c-gold);border-color:rgba(212,175,55,.3)}
.fab-711{background:rgba(212,175,55,.1);color:var(--c-gold);border-color:rgba(212,175,55,.3)}
.fab-custom{background:rgba(212,175,55,.12);color:var(--c-gold);border-color:rgba(212,175,55,.4)}
.fab-menu{display:flex;flex-direction:column-reverse;gap:var(--sp-sm)}
.fab-menu.hidden{display:none}
@media(max-width:640px){
  .fab{width:44px;height:44px}
  .fab span{display:none}
}

/* — Product Grid — */
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:var(--sp-md);margin:var(--sp-md) 0}
.product-card{display:flex;gap:var(--sp-md);padding:var(--sp-md);border:1px solid var(--c-border);border-radius:var(--r-md);background:var(--c-bg-card-alt);transition:border-color var(--t-fast)}
.product-card:hover{border-color:var(--c-gold)}
.product-icon{font-size:2rem;flex:0 0 auto;padding-top:2px}
.product-body{flex:1;min-width:0}
.product-name{font-weight:700;color:var(--c-text);font-size:1rem;margin-bottom:4px}
.product-meta{display:flex;gap:var(--sp-xs);margin-bottom:var(--sp-xs)}
.product-desc{font-size:.85rem;color:var(--c-text-dim);margin-bottom:var(--sp-xs);line-height:1.5}
.product-price{font-size:1.1rem;font-weight:700;color:var(--c-gold);margin-bottom:var(--sp-xs)}
.product-wear{font-size:.78rem;color:var(--c-text-muted);margin-bottom:var(--sp-sm)}
.product-actions{display:flex;gap:var(--sp-xs)}
.product-btn{display:inline-flex;align-items:center;gap:4px;padding:.4rem .7rem;border-radius:var(--r-sm);border:1px solid var(--c-border);font-size:.78rem;text-decoration:none;color:var(--c-text);transition:all var(--t-fast)}
.product-btn:hover{border-color:var(--c-gold);color:var(--c-gold)}
.product-btn.shopee:hover{border-color:var(--c-gold);color:var(--c-gold)}
.product-btn.seven:hover{border-color:var(--c-gold);color:var(--c-gold)}
.btn-full{width:100%;justify-content:center;padding:.9rem}
.custom-cta{text-align:center}
.custom-cta .btn{word-break:keep-all;white-space:normal;line-height:1.4;font-size:clamp(0.85rem,3.5vw,1rem)}

/* — Share Gate — */
.share-gate-card{border:2px dashed rgba(212,175,55,.4);border-radius:var(--r-lg);padding:var(--sp-lg);text-align:center;background:linear-gradient(135deg,rgba(212,175,55,.04),rgba(139,0,0,.04))}
.share-gate-card h4{color:var(--c-gold);margin-bottom:var(--sp-sm)}
.share-gate-card p{color:var(--c-text-dim);font-size:.9rem;margin-bottom:var(--sp-md)}
.btn-share-big{padding:.85rem 2rem;font-size:1rem;border-radius:var(--r-pill);background:linear-gradient(135deg,#25D366,#128C7E);color:#fff;border:none;cursor:pointer;transition:all var(--t-fast);font-weight:700}
.btn-share-big:hover{transform:scale(1.03);box-shadow:0 4px 20px rgba(37,211,102,.3)}
.btn-save-card{padding:.7rem 1.5rem;font-size:.9rem;border-radius:var(--r-pill);background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;cursor:pointer;transition:all var(--t-fast);font-weight:600}
.btn-save-card:hover{transform:scale(1.03);box-shadow:0 4px 20px rgba(118,75,162,.3)}

/* — Urgency Strip — */
.urgency-strip{display:flex;gap:var(--sp-sm);flex-wrap:wrap;margin-top:var(--sp-xs);font-size:.72rem}
.urgency-critical{color:#ff4444;font-weight:700;animation:pulse 2s infinite}
.urgency-normal{color:rgba(255,255,255,.6)}
.urgency-views{color:rgba(255,255,255,.45)}

/* — Social Proof — */
.social-proof{border:1px solid rgba(212,175,55,.2);border-radius:var(--r-md);padding:var(--sp-md);margin:var(--sp-md) 0;background:rgba(212,175,55,.04)}
.sp-item{font-size:.85rem;color:var(--c-text-dim);margin:var(--sp-xs) 0}
.sp-item strong{color:var(--c-gold)}

/* — Live Counter + Marquee — */
.live-counter-bar{display:flex;align-items:center;justify-content:center;gap:var(--sp-md);padding:var(--sp-sm) var(--sp-md);background:rgba(212,175,55,.06);border:1px solid rgba(212,175,55,.15);border-radius:var(--r-md);margin-bottom:var(--sp-lg);font-size:.85rem;color:var(--c-text-dim);flex-wrap:wrap}
.live-counter-bar strong{color:var(--c-gold);font-size:1.1rem}
.live-marquee{text-align:center;font-size:.78rem;color:rgba(255,255,255,.55);padding:var(--sp-xs);transition:opacity .3s;min-height:1.4em;margin-bottom:var(--sp-md)}

/* — Discount Reveal — */
.discount-reveal{border:2px solid var(--c-gold);border-radius:var(--r-lg);padding:var(--sp-lg);text-align:center;background:linear-gradient(135deg,rgba(212,175,55,.08),rgba(139,0,0,.06));margin-top:var(--sp-md)}
.discount-code{font-size:1.8rem;font-weight:900;color:var(--c-gold);letter-spacing:4px;font-family:monospace;padding:var(--sp-md);background:rgba(0,0,0,.3);border-radius:var(--r-md);display:inline-block;margin:var(--sp-sm) 0}

/* — PWA Banner — */
.pwa-banner{position:fixed;top:0;left:0;right:0;z-index:800;background:linear-gradient(135deg,#1a0505,#2D0A0A);border-bottom:2px solid var(--c-gold);padding:var(--sp-sm) var(--sp-md);display:flex;align-items:center;gap:var(--sp-md);box-shadow:0 4px 20px rgba(0,0,0,.5);animation:slideDown .4s ease}
@keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
.pwa-banner.hidden{display:none}
.pwa-banner-text{flex:1;font-size:.85rem;color:var(--c-text)}
.pwa-banner-text strong{color:var(--c-gold)}
.pwa-install-btn{padding:.5rem 1rem;border-radius:var(--r-pill);background:var(--c-gold);color:#2D0A0A;border:none;font-weight:700;cursor:pointer;white-space:nowrap;font-size:.85rem}
.pwa-close-btn{background:none;border:none;color:var(--c-text-dim);font-size:1.2rem;cursor:pointer;padding:4px}

/* — Remind Button — */
.btn-remind{padding:.6rem 1.2rem;border-radius:var(--r-pill);border:1px solid rgba(212,175,55,.4);background:rgba(212,175,55,.08);color:var(--c-gold);cursor:pointer;font-size:.85rem;transition:all var(--t-fast)}
.btn-remind:hover{background:rgba(212,175,55,.15);border-color:var(--c-gold)}

/* — Print (after all shop/fab styles) — */
@media print{
  .nav,.stepper,.actions,.btn,.floating-root,.shop-card,.modal-overlay{display:none!important}
  body{background:#fff!important;color:#000!important}
  .card,.dim-pane,.conclusion{border:1px solid #ccc!important;background:#fff!important;box-shadow:none!important}
  .text-gold,.card-title,.verdict-label,.hex-name,.zw-palace{color:#8b0000!important}
  .tag{border:1px solid #ccc}
  .prob-fill{background:#8b0000!important}
  .step{display:none!important}
  #step-3{display:block!important}
  .dim-pane{display:block!important;margin-bottom:1rem}
  .dim-tabs{display:none!important}
}
/* 能量行事曆 + 靈氣濾鏡 */
.cal30-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin:var(--sp-md) 0}
.cal30-hdr{text-align:center;font-size:.7rem;font-weight:600;color:var(--c-text-muted);padding:4px 0}
.cal30-day{text-align:center;font-size:.75rem;padding:5px 2px;border-radius:6px;border:1px solid transparent;cursor:pointer;transition:all var(--t-fast);min-height:40px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px}
.cal30-day.empty{border:none;pointer-events:none}
.cal30-day .cd-num{font-weight:600;line-height:1;font-size:.78rem}
.cal30-day .cd-icon{font-size:.6rem;line-height:1}
.cal30-day.lv5{border-color:rgba(74,222,128,.45);background:rgba(74,222,128,.12);color:#4ade80}
.cal30-day.lv4{border-color:rgba(96,165,250,.35);background:rgba(96,165,250,.08);color:#93bbfd}
.cal30-day.lv3{border-color:rgba(212,175,55,.3);background:rgba(212,175,55,.06);color:var(--c-gold)}
.cal30-day.lv2{border-color:var(--c-border);background:rgba(255,255,255,.03);color:var(--c-text-dim)}
.cal30-day.lv1{border-color:rgba(251,191,36,.25);background:rgba(251,191,36,.05);color:#fbbf24}
.cal30-day.lv0{border-color:rgba(248,113,113,.25);background:rgba(248,113,113,.06);color:#f87171}
.cal30-day.lvN{border-color:rgba(220,50,50,.35);background:rgba(220,50,50,.1);color:#ef4444}
.cal30-day.is-today{box-shadow:0 0 0 2px var(--c-gold);border-color:var(--c-gold)}
.cal30-legend{display:flex;flex-wrap:wrap;gap:var(--sp-xs) var(--sp-sm);margin:var(--sp-sm) 0;padding:var(--sp-xs) var(--sp-sm);background:rgba(0,0,0,.2);border-radius:var(--r-sm);font-size:.65rem;color:var(--c-text-muted)}
.cal30-legend span{display:flex;align-items:center;gap:3px}
.cal30-legend i{width:8px;height:8px;display:inline-block;border-radius:2px}
.cal30-mnav{display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--sp-xs)}
.cal30-mnav button{background:none;border:1px solid var(--c-border);color:var(--c-gold);width:28px;height:28px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.7rem;transition:all var(--t-fast)}
.cal30-mnav button:hover{border-color:var(--c-border-hi);background:rgba(212,175,55,.08)}
.cal30-mt{font-family:var(--f-display);font-weight:700;font-size:.95rem;color:var(--c-gold)}
.cal30-det{margin:var(--sp-md) 0;max-height:300px;overflow-y:auto}
.cal30-di{display:flex;gap:var(--sp-sm);padding:6px 0;border-bottom:1px solid rgba(255,255,255,.04);align-items:flex-start;font-size:.8rem}
.cal30-di:last-child{border-bottom:none}
.cal30-sts{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp-xs);margin:var(--sp-sm) 0}
.cal30-st{text-align:center;padding:6px;background:rgba(0,0,0,.2);border-radius:var(--r-sm);border:1px solid var(--c-border)}
.cal30-sn{font-family:var(--f-display);font-weight:900;font-size:1.1rem;line-height:1.2}
.cal30-sl{font-size:.65rem;color:var(--c-text-muted);margin-top:1px}
.cal30-ct{display:inline-flex;align-items:center;gap:3px;background:rgba(212,175,55,.1);border:1px solid rgba(212,175,55,.2);border-radius:var(--r-sm);padding:1px 5px;font-size:.7rem;color:var(--c-gold);margin-top:2px}
.aura-up{border:2px dashed rgba(212,175,55,.25);border-radius:var(--r-lg);padding:var(--sp-lg);text-align:center;cursor:pointer;transition:all var(--t-smooth)}
.aura-up:hover{border-color:var(--c-gold);background:rgba(212,175,55,.03)}
.aura-cw{position:relative;margin:var(--sp-md) 0;text-align:center}
.aura-cw canvas{max-width:100%;border-radius:var(--r-md);border:2px solid var(--c-border-hi);box-shadow:0 8px 40px rgba(0,0,0,.4)}
.aura-nfo{text-align:center;margin:var(--sp-md) 0;padding:var(--sp-md);border:1px solid var(--c-border-hi);border-radius:var(--r-md);background:linear-gradient(180deg,rgba(212,175,55,.04),rgba(139,0,0,.04))}
.aura-orb{width:56px;height:56px;border-radius:50%;margin:0 auto var(--sp-sm);animation:aGlow 2s ease-in-out infinite alternate}
@keyframes aGlow{from{transform:scale(1);filter:brightness(1)}to{transform:scale(1.06);filter:brightness(1.15)}}
.aura-cn{font-family:var(--f-display);font-weight:900;font-size:1.2rem}
.aura-cd{font-size:.82rem;color:var(--c-text-dim);margin-top:2px}
.aura-sh{background:rgba(212,175,55,.04);border:1px solid var(--c-border);border-radius:var(--r-sm);padding:var(--sp-sm) var(--sp-md);margin-top:var(--sp-sm);text-align:center;font-size:.78rem;color:var(--c-text-dim)}
.aura-sh strong{color:var(--c-gold)}
/* =============================================================
   UI POLISH v2 — 全站視覺升級
   ============================================================= */

/* ── 背景：深色漸層 + 微光粒子感 ── */
body::before{
  content:'';position:fixed;inset:0;z-index:-1;
  background:
    radial-gradient(ellipse 600px 400px at 20% 10%, rgba(139,0,0,0.15), transparent),
    radial-gradient(ellipse 500px 350px at 80% 85%, rgba(212,175,55,0.06), transparent),
    radial-gradient(ellipse 300px 300px at 50% 50%, rgba(139,0,0,0.05), transparent);
  pointer-events:none;
}

/* ── 對航列升級 ── */
.nav{
  background:rgba(13,4,4,0.88)!important;
  backdrop-filter:blur(16px) saturate(1.4)!important;
  border-bottom:1px solid rgba(212,175,55,0.12)!important;
  box-shadow:0 2px 20px rgba(0,0,0,0.3);
}
.nav-brand i{
  text-shadow:0 0 16px rgba(212,175,55,0.5);
}

/* ── Hero 重設計 ── */
.hero{
  padding:var(--sp-xl) var(--sp-md) var(--sp-lg)!important;
  text-align:center;
  position:relative;
}
.hero::before{
  content:'';position:absolute;top:-20px;left:50%;transform:translateX(-50%);
  width:200px;height:200px;
  background:radial-gradient(circle,rgba(212,175,55,0.12) 0%,transparent 70%);
  border-radius:50%;pointer-events:none;
}
.hero-icon{
  font-size:3rem!important;
  text-shadow:0 0 40px rgba(212,175,55,0.5),0 0 80px rgba(212,175,55,0.2)!important;
  position:relative;z-index:1;
}
.hero h1{
  font-size:clamp(1.5rem,5vw,2.2rem)!important;
  background:linear-gradient(135deg,#d4af37 0%,#f5e6b8 40%,#d4af37 60%,#b8941f 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
  line-height:1.4!important;
  letter-spacing:0.05em;
}
.hero p{
  color:var(--c-text-dim)!important;font-size:0.95rem!important;
  letter-spacing:0.08em;
}

/* ── 卡片獻璃態 ── */
.card{
  background:rgba(30,12,12,0.75)!important;
  backdrop-filter:blur(8px);
  border:1px solid rgba(212,175,55,0.12)!important;
  box-shadow:0 8px 32px rgba(0,0,0,0.3),inset 0 1px 0 rgba(255,255,255,0.03)!important;
}
.card:hover{
  border-color:rgba(212,175,55,0.25)!important;
  box-shadow:0 12px 40px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.05)!important;
}

/* ═══ Hook Grid (首屏四宮格) ═══ */
.hook-grid{
  display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-md);
  max-width:400px;margin:0 auto;
}
.hook-card{
  display:flex;flex-direction:column;align-items:center;gap:6px;
  padding:var(--sp-lg) var(--sp-sm);
  background:rgba(30,12,12,0.7);
  border:1.5px solid rgba(212,175,55,0.18);
  border-radius:var(--r-lg);
  cursor:pointer;transition:all .25s ease;
  -webkit-tap-highlight-color:transparent;
}
.hook-card:hover,.hook-card:active{
  border-color:var(--c-gold);
  background:rgba(212,175,55,0.08);
  transform:translateY(-2px);
  box-shadow:0 8px 24px rgba(212,175,55,0.15);
}
.hook-emoji{font-size:2rem;line-height:1}
.hook-title{font-weight:700;font-size:1rem;color:var(--c-gold-light);font-family:var(--f-display)}
.hook-sub{font-size:.78rem;color:var(--c-text-muted)}
.hook-card-mini{
  padding:.5rem 1rem;background:rgba(30,12,12,0.5);
  border:1px solid rgba(212,175,55,0.12);border-radius:var(--r-pill);
  color:var(--c-text-dim);font-size:.82rem;cursor:pointer;
  transition:all .2s ease;-webkit-tap-highlight-color:transparent;
}
.hook-card-mini:hover,.hook-card-mini:active{
  border-color:var(--c-gold);color:var(--c-gold);
  background:rgba(212,175,55,0.06);
}

/* ═══ Preset Questions ═══ */
.q-preset-grid{display:flex;flex-direction:column;gap:6px}
.q-preset-btn{
  display:block;width:100%;text-align:left;
  padding:10px 14px;
  background:rgba(255,255,255,0.03);
  border:1.5px solid rgba(212,175,55,0.12);
  border-radius:var(--r-sm);
  color:var(--c-text);font-size:.9rem;
  cursor:pointer;transition:all .2s ease;
  -webkit-tap-highlight-color:transparent;
}
.q-preset-btn:hover,.q-preset-btn.selected{
  border-color:var(--c-gold);
  background:rgba(212,175,55,0.08);
  color:var(--c-gold-light);
}
.q-preset-btn.selected::before{
  content:'✓ ';color:var(--c-gold);font-weight:700;
}

/* ═══ Advance Toggle ═══ */
.advance-toggle{margin-top:var(--sp-md);border-top:1px solid rgba(255,255,255,0.06);padding-top:var(--sp-sm)}
.advance-toggle summary{
  cursor:pointer;font-size:.82rem;color:var(--c-text-muted);
  display:flex;align-items:center;gap:.4rem;
  list-style:none;-webkit-tap-highlight-color:transparent;
}
.advance-toggle summary::-webkit-details-marker{display:none}
.advance-toggle[open] summary{color:var(--c-gold)}
.advance-arrow{font-size:.65rem;transition:transform .2s ease}
.advance-toggle[open] .advance-arrow{transform:rotate(90deg)}

/* ═══ CTA Pulse ═══ */
.btn-cta-pulse{
  animation:cta-glow 2s ease-in-out infinite;
}
@keyframes cta-glow{
  0%,100%{box-shadow:0 0 0 0 rgba(212,175,55,0.3)}
  50%{box-shadow:0 0 20px 4px rgba(212,175,55,0.2)}
}

/* ═══ Action Card (行動指令) ═══ */
.action-card{
  border:1.5px solid rgba(212,175,55,0.3)!important;
  background:linear-gradient(135deg,rgba(212,175,55,0.04),rgba(30,12,12,0.8))!important;
}
.action-item{
  display:flex;align-items:flex-start;gap:var(--sp-sm);
  padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05);
}
.action-item:last-child{border-bottom:none}
.action-num{
  flex:0 0 28px;height:28px;
  display:flex;align-items:center;justify-content:center;
  background:var(--c-gold);color:var(--c-bg-deep);
  border-radius:50%;font-weight:700;font-size:.8rem;
}
.action-text{flex:1;font-size:.95rem;line-height:1.6}
.action-text strong{color:var(--c-gold-light)}

/* 嵌入式水晶推薦小卡 */
.inline-crystal{
  display:flex;align-items:center;gap:var(--sp-sm);
  padding:10px 14px;margin-top:8px;
  background:rgba(212,175,55,0.06);
  border:1px solid rgba(212,175,55,0.2);
  border-radius:var(--r-sm);
  cursor:pointer;transition:all .2s ease;
  text-decoration:none;color:inherit;
}
.inline-crystal:hover{
  border-color:var(--c-gold);
  background:rgba(212,175,55,0.12);
}
.inline-crystal-icon{flex:0 0 auto;display:flex;align-items:center}
.inline-crystal-icon svg{width:36px;height:36px}
.inline-crystal-info{flex:1}
.inline-crystal-name{font-weight:600;font-size:.9rem;color:var(--c-gold-light)}
.inline-crystal-desc{font-size:.75rem;color:var(--c-text-dim)}
.inline-crystal-price{font-size:.8rem;color:var(--c-gold);font-weight:700;white-space:nowrap}
.inline-crystal-arrow{color:var(--c-gold);font-size:.8rem}

/* ═══ Quick Shop Card (快捷導購) ═══ */
.quick-shop-card{
  border:1.5px solid rgba(212,175,55,0.25)!important;
  background:linear-gradient(180deg,rgba(212,175,55,0.03),rgba(30,12,12,0.8))!important;
}
.qs-item{
  flex:0 0 140px;
  background:rgba(0,0,0,0.25);
  border:1px solid rgba(212,175,55,0.15);
  border-radius:var(--r-md);
  padding:12px 10px;
  text-align:center;
  cursor:pointer;
  transition:all .2s ease;
  text-decoration:none;
  color:inherit;
  display:block;
}
.qs-item:hover{
  border-color:var(--c-gold);
  background:rgba(212,175,55,0.06);
  transform:translateY(-2px);
}
.qs-item-icon{margin-bottom:6px;display:flex;justify-content:center;align-items:center}
.qs-item-icon svg{width:42px;height:42px}
.qs-item-name{font-size:.8rem;font-weight:600;color:var(--c-gold-light);line-height:1.3;margin-bottom:4px}
.qs-item-el{font-size:.65rem;color:var(--c-text-muted)}
.qs-item-price{font-size:.8rem;font-weight:700;color:var(--c-gold);margin-top:4px}
.qs-item-reason{font-size:.58rem;color:var(--c-gold);opacity:.85;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* ═══ 第一幕緊湊佈局：verdict+回答+站長觀點+行動+商品一屏完成 ═══ */
.result-verdict{padding:var(--sp-md) 0}
.result-verdict .verdict-ring{margin:0 auto}
#step-3>.card:first-of-type{margin-top:0}
.action-card{padding:var(--sp-sm) var(--sp-md)}
.quick-shop-card{padding:var(--sp-sm) var(--sp-md)}
@media(max-width:640px){
  .result-verdict{padding:var(--sp-sm) 0}
  .verdict-ring svg{width:120px;height:120px}
  .action-card,.quick-shop-card{padding:var(--sp-xs) var(--sp-sm)}
}

/* ═══ Sticky Bottom CTA (結果頁常駐) ═══ */
.sticky-cta{
  position:fixed;bottom:0;left:0;right:0;z-index:800;
  background:linear-gradient(0deg,rgba(13,4,4,0.98) 0%,rgba(13,4,4,0.92) 100%);
  backdrop-filter:blur(12px);
  border-top:1px solid rgba(212,175,55,0.25);
  padding:5px 10px calc(env(safe-area-inset-bottom,0px) + 4px);
  display:none;
  transform:translateY(100%);
  transition:transform .4s ease;
}
.sticky-cta.visible{
  display:block;
  transform:translateY(0);
}
.sticky-cta-inner{
  max-width:960px;margin:0 auto;
  display:flex;align-items:center;gap:8px;
}
.sticky-cta-text{
  flex:1;font-size:.72rem;color:var(--c-text-dim);line-height:1.25;
}
.sticky-cta-text strong{color:var(--c-gold);font-size:.75rem}
.sticky-cta-btn{
  flex:0 0 auto;
  padding:7px 14px;
  background:linear-gradient(135deg,var(--c-gold),#b8941f);
  color:var(--c-bg-deep);
  border:none;border-radius:var(--r-pill);
  font-weight:700;font-size:.78rem;
  cursor:pointer;
  text-decoration:none;
  display:inline-flex;align-items:center;gap:5px;
  box-shadow:0 2px 12px rgba(212,175,55,0.3);
  transition:all .2s ease;
  white-space:nowrap;
}
.sticky-cta-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 4px 16px rgba(212,175,55,0.4);
}

/* ═══ Loading Steps ═══ */
.loading-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;
  background:radial-gradient(ellipse at center,rgba(26,10,10,.98) 0%,rgba(8,2,2,.99) 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:0;padding:0 var(--sp-xl);
  overflow:hidden;
}
/* ── 背景粒子場 ── */
.ld-particles{position:absolute;inset:0;overflow:hidden;pointer-events:none}
.ld-particle{position:absolute;width:2px;height:2px;background:var(--c-gold);border-radius:50%;opacity:0;animation:ldParticle var(--dur) var(--delay) ease-in-out infinite}
@keyframes ldParticle{0%{opacity:0;transform:translateY(0) scale(0)}30%{opacity:.7;transform:translateY(-30vh) scale(1)}70%{opacity:.4}100%{opacity:0;transform:translateY(-80vh) scale(0)}}
/* ── 中心五角陣 ── */
.ld-pentagram{position:relative;width:220px;height:220px;margin-bottom:var(--sp-lg)}
.ld-ring{position:absolute;inset:0;border:1px solid rgba(212,175,55,.15);border-radius:50%;animation:ldRingSpin 12s linear infinite}
.ld-ring:nth-child(2){inset:15px;border-color:rgba(212,175,55,.1);animation-duration:8s;animation-direction:reverse}
.ld-ring:nth-child(3){inset:30px;border-color:rgba(212,175,55,.08);animation-duration:15s}
@keyframes ldRingSpin{to{transform:rotate(360deg)}}
/* ── 六維度節點（分佈在圓周上）── */
.ld-node{
  position:absolute;width:44px;height:44px;
  border-radius:50%;
  background:rgba(20,8,8,.9);
  border:1.5px solid rgba(212,175,55,.2);
  display:flex;align-items:center;justify-content:center;
  font-size:.7rem;color:var(--c-text-muted);
  transition:all .6s cubic-bezier(.4,0,.2,1);
  box-shadow:0 0 0 rgba(212,175,55,0);
}
.ld-node.computing{
  border-color:rgba(212,175,55,.6);color:var(--c-gold);
  box-shadow:0 0 20px rgba(212,175,55,.3);
  animation:ldNodePulse 1s ease-in-out infinite;
}
.ld-node.done{
  border-color:var(--c-gold);color:var(--c-gold);
  background:rgba(212,175,55,.1);
  box-shadow:0 0 24px rgba(212,175,55,.4);
  animation:none;
  transform:scale(1.08);
}
.ld-node i,.ld-node span.ld-sym{font-size:.9rem;line-height:1}
.ld-node-label{position:absolute;bottom:-18px;font-size:.6rem;white-space:nowrap;color:var(--c-text-muted);transition:color .4s}
.ld-node.done .ld-node-label{color:var(--c-gold)}
@keyframes ldNodePulse{0%,100%{box-shadow:0 0 12px rgba(212,175,55,.2)}50%{box-shadow:0 0 28px rgba(212,175,55,.5)}}
/* ── 節點間連線（SVG）── */
.ld-lines{position:absolute;inset:0;pointer-events:none}
.ld-line{stroke:rgba(212,175,55,.08);stroke-width:1;transition:stroke .6s,stroke-opacity .6s}
.ld-line.lit{stroke:rgba(212,175,55,.4);stroke-width:1.5;filter:drop-shadow(0 0 4px rgba(212,175,55,.3))}
/* ── 中心 icon ── */
.ld-center{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:52px;height:52px;border-radius:50%;
  background:radial-gradient(circle,rgba(212,175,55,.12),transparent);
  display:flex;align-items:center;justify-content:center;
  font-size:1.6rem;color:var(--c-gold);
  opacity:.6;transition:opacity .5s;
}
.ld-center.active{opacity:1;animation:ldCenterGlow 2s ease-in-out infinite}
@keyframes ldCenterGlow{0%,100%{box-shadow:0 0 20px rgba(212,175,55,.1)}50%{box-shadow:0 0 40px rgba(212,175,55,.3)}}
/* ── 狀態文字 ── */
.ld-status{
  color:var(--c-gold);font-family:var(--f-display);font-size:1rem;
  text-align:center;min-height:1.4em;
  transition:opacity .3s;
}
.ld-sub{color:var(--c-text-dim);font-size:.78rem;margin-top:4px;text-align:center;min-height:1.2em}
/* ── 完成爆發 ── */
.ld-burst{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:0;height:0;border-radius:50%;
  background:radial-gradient(circle,rgba(212,175,55,.3),transparent);
  opacity:0;transition:all .8s cubic-bezier(.2,0,.2,1);pointer-events:none;
}
.ld-burst.go{width:400px;height:400px;opacity:1}
.ld-burst.fade{opacity:0}
/* ── 步驟轉場（goStep 用）── */
.step-transition{
  position:fixed;inset:0;z-index:9998;
  background:rgba(13,4,4,.95);
  display:flex;align-items:center;justify-content:center;flex-direction:column;gap:var(--sp-sm);
  opacity:0;pointer-events:none;
  transition:opacity .4s ease;
}
.step-transition.active{opacity:1;pointer-events:all}
.step-transition .st-icon{font-size:2rem;color:var(--c-gold);animation:ldCenterGlow 1.5s ease-in-out infinite}
.step-transition .st-text{color:var(--c-gold);font-family:var(--f-display);font-size:1rem}
.loading-title{color:var(--c-gold);font-family:var(--f-display);font-size:1.15rem;margin-bottom:var(--sp-lg);text-align:center}
.loading-bar-wrap{width:100%;max-width:340px;height:18px;background:rgba(255,255,255,0.06);border-radius:var(--r-pill);overflow:hidden;border:1px solid rgba(212,175,55,0.2);position:relative;margin-bottom:var(--sp-md)}
.loading-bar-fill{height:100%;width:0%;background:linear-gradient(90deg,#d4af37,#f0d060,#d4af37);border-radius:var(--r-pill);transition:width 0.3s ease-out;position:relative;box-shadow:0 0 10px rgba(212,175,55,0.5)}
.loading-bar-fill::after{content:'';position:absolute;top:0;right:0;bottom:0;width:30px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3));border-radius:var(--r-pill);animation:barShimmer .8s infinite}
@keyframes barShimmer{0%{opacity:.3}50%{opacity:.8}100%{opacity:.3}}
.loading-pct{color:var(--c-gold);font-size:.85rem;font-weight:700;margin-bottom:var(--sp-lg);font-variant-numeric:tabular-nums}
.loading-step{
  display:flex;align-items:center;gap:var(--sp-sm);
  font-size:.82rem;color:var(--c-text-muted);
  transition:all .25s ease;opacity:0.4;
  margin-bottom:4px;
}
.loading-step.done{color:var(--c-success);opacity:1}
.loading-step.active{color:var(--c-gold);opacity:1}
.loading-step i{width:18px;text-align:center;font-size:.6rem}

/* ── 卡片標題裝飾線 ── */
.card-title{
  padding-bottom:var(--sp-sm);
  border-bottom:1px solid rgba(212,175,55,0.1);
  margin-bottom:var(--sp-md)!important;
}
.card-title i{
  color:var(--c-gold);text-shadow:0 0 8px rgba(212,175,55,0.3);
}

/* ── 表單升級 ── */
.form-input,.form-select,.form-textarea{
  background:rgba(0,0,0,0.3)!important;
  border:1px solid rgba(255,255,255,0.08)!important;
  border-radius:var(--r-md)!important;
  color:var(--c-text)!important;
  padding:0.85rem 1rem!important;
  transition:all 0.3s ease!important;
  font-size:16px!important; /* prevent iOS zoom */
}
.form-input:focus,.form-select:focus,.form-textarea:focus{
  border-color:rgba(212,175,55,0.5)!important;
  box-shadow:0 0 0 3px rgba(212,175,55,0.1),0 0 20px rgba(212,175,55,0.05)!important;
  outline:none!important;
}
.form-label{
  font-weight:600!important;
  color:var(--c-text)!important;
  margin-bottom:var(--sp-sm)!important;
  display:block!important;
}

/* ── 性別 Radio Pills ── */
.radio-pills{display:flex;gap:var(--sp-sm)}
.radio-pill{flex:1}
.radio-pill input{display:none}
.radio-pill span{
  display:block;text-align:center;padding:0.75rem;
  border:1px solid rgba(255,255,255,0.08);border-radius:var(--r-md);
  cursor:pointer;transition:all 0.3s;color:var(--c-text-dim);font-weight:600;
}
.radio-pill input:checked+span{
  border-color:var(--c-gold);color:var(--c-gold);
  background:rgba(212,175,55,0.1);
  box-shadow:0 0 12px rgba(212,175,55,0.15);
}

/* ── Stepper 精緻化 ── */
.stepper{
  display:flex;align-items:center;justify-content:center;
  gap:0;margin:var(--sp-md) 0 var(--sp-lg);padding:0 var(--sp-md);
}
.stepper-dot{
  width:36px!important;height:36px!important;
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:0.85rem;
  border:2px solid rgba(255,255,255,0.12);
  color:var(--c-text-dim);background:rgba(0,0,0,0.3);
  transition:all 0.4s ease;
}
.stepper-item.active .stepper-dot{
  border-color:var(--c-gold);color:var(--c-gold);
  background:rgba(212,175,55,0.12);
  box-shadow:0 0 16px rgba(212,175,55,0.25);
}
.stepper-item.done .stepper-dot{
  border-color:rgba(212,175,55,0.4);color:var(--c-gold-light);
  background:rgba(212,175,55,0.08);
}
.stepper-line{
  flex:1;height:2px;
  background:linear-gradient(90deg,rgba(255,255,255,0.06),rgba(212,175,55,0.15),rgba(255,255,255,0.06));
  margin:0 var(--sp-xs);
}
.stepper-item{
  display:flex;flex-direction:column;align-items:center;gap:4px;
}
.stepper-item span{font-size:0.7rem;color:var(--c-text-muted)}
.stepper-item.active span{color:var(--c-gold)}

/* ── 按鈕升級 ── */
.btn-primary,.btn-gold{
  position:relative;overflow:hidden;
}
.btn-primary::before,.btn-gold::before{
  content:'';position:absolute;top:0;left:-100%;
  width:60%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);
  transition:left 0.5s;
}
.btn-primary:hover::before,.btn-gold:hover::before{
  left:100%;
}

/* ── 結果頁 Verdict 升級 ── */
.result-verdict{
  text-align:center;
  padding:var(--sp-xl) var(--sp-lg)!important;
  border:1px solid rgba(212,175,55,0.2)!important;
  background:linear-gradient(180deg,rgba(30,12,12,0.9) 0%,rgba(45,10,10,0.95) 100%)!important;
  position:relative;
}
.result-verdict::before{
  content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:60%;height:1px;
  background:linear-gradient(90deg,transparent,var(--c-gold),transparent);
}
.verdict-prob{
  font-size:clamp(2.5rem,8vw,4rem)!important;
  font-weight:900!important;
  letter-spacing:2px;
}
.verdict-label{
  font-size:1.2rem!important;
  letter-spacing:0.1em;
}

/* ── 機率條升級 ── */
.prob-bar{
  height:10px!important;border-radius:var(--r-pill)!important;
  background:rgba(255,255,255,0.05)!important;
  overflow:hidden;position:relative;
}
.prob-fill{
  height:100%;border-radius:var(--r-pill);
  background:linear-gradient(90deg,#8b0000,#d4af37,#e8c968)!important;
  position:relative;
  transition:width 1.5s cubic-bezier(0.4,0,0.2,1)!important;
}
.prob-fill::after{
  content:'';position:absolute;right:0;top:0;bottom:0;width:20px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3));
  border-radius:0 var(--r-pill) var(--r-pill) 0;
  animation:pulse 2s infinite;
}

/* ── Dimension Tabs 升級 ── */
.dim-tabs{
  display:flex;gap:var(--sp-xs);padding:var(--sp-sm);
  background:rgba(0,0,0,0.2);border-radius:var(--r-md);
  overflow-x:auto;-webkit-overflow-scrolling:touch;
}
.dim-tab{
  padding:0.6rem 1rem!important;border-radius:var(--r-sm)!important;
  font-size:0.82rem!important;white-space:nowrap;
  border:1px solid rgba(255,255,255,0.06)!important;
  background:transparent!important;color:var(--c-text-dim)!important;
  transition:all 0.3s!important;cursor:pointer;
}
.dim-tab.active{
  background:linear-gradient(135deg,var(--c-crimson),#6b0000)!important;
  color:var(--c-gold-pale)!important;
  border-color:rgba(212,175,55,0.4)!important;
  box-shadow:0 2px 12px rgba(139,0,0,0.3);
}

/* ── 商品卡片升級 ── */
.product-grid{
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr))!important;
}
.product-card{
  border-radius:var(--r-lg)!important;
  background:linear-gradient(135deg,rgba(30,12,12,0.8),rgba(20,8,8,0.9))!important;
  border:1px solid rgba(212,175,55,0.08)!important;
  transition:all 0.3s ease!important;
  position:relative;overflow:hidden;
}
.product-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,0.4),transparent);
  opacity:0;transition:opacity 0.3s;
}
.product-card:hover::before{opacity:1}
.product-card:hover{
  transform:translateY(-3px)!important;
  box-shadow:0 12px 36px rgba(0,0,0,0.4)!important;
  border-color:rgba(212,175,55,0.2)!important;
}
.product-icon{font-size:2.5rem!important}
.product-price{
  font-size:1.15rem!important;
  background:linear-gradient(135deg,var(--c-gold),var(--c-gold-light));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.product-btn{
  border-radius:var(--r-pill)!important;
  padding:0.45rem 0.85rem!important;
  font-weight:600!important;
}

/* ── 塔羅牌動畫 ── */
.tarot-card-draw{
  transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1),opacity 0.3s;
}
.tarot-card-draw:hover{
  transform:translateY(-8px) scale(1.05);
}

/* ── 結論區升級 ── */
.conclusion{
  position:relative;
  border:1px solid rgba(212,175,55,0.15)!important;
  background:linear-gradient(135deg,rgba(30,12,12,0.85),rgba(20,8,8,0.95))!important;
  border-radius:var(--r-lg)!important;
  padding:var(--sp-xl) var(--sp-lg)!important;
}
.conclusion::before{
  content:'';position:absolute;top:-1px;left:10%;right:10%;height:1px;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,0.5),transparent);
}
.conclusion h3{
  text-align:center!important;
  font-size:1.3rem!important;
  margin-bottom:var(--sp-lg)!important;
}
.conclusion p{
  line-height:2!important;
  margin-bottom:var(--sp-md)!important;
  color:rgba(245,230,211,0.85)!important;
}

/* ── 社會認同 + 計數器升級 ── */
.live-counter-bar{
  background:rgba(0,0,0,0.2)!important;
  border:1px solid rgba(212,175,55,0.1)!important;
  border-radius:var(--r-pill)!important;
  padding:var(--sp-xs) var(--sp-lg)!important;
  display:inline-flex!important;
}
.live-marquee{
  animation:fadeIn 0.3s;
}

/* ── 分享/折扣區升級 ── */
.share-gate-card{
  background:linear-gradient(135deg,rgba(212,175,55,0.05),rgba(139,0,0,0.05))!important;
  border:2px dashed rgba(212,175,55,0.25)!important;
}
.discount-reveal{
  animation:scaleIn 0.5s ease;
}
.discount-code{
  animation:shimmer 3s ease-in-out infinite;
  background-size:200% 100%;
  background-image:linear-gradient(90deg,var(--c-gold),#fff,var(--c-gold-light),var(--c-gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}

/* ── 商城推薦卡片升級 ── */
.shop-card{
  background:linear-gradient(135deg,rgba(139,0,0,0.12),rgba(212,175,55,0.06))!important;
  border:1px solid rgba(212,175,55,0.2)!important;
}
.shop-btn-card{
  border-radius:var(--r-lg)!important;
  padding:1rem 1.15rem!important;
}

/* ── 浮動按鈕升級 ── */
.fab{
  box-shadow:0 4px 16px rgba(0,0,0,0.3)!important;
}
.fab-toggle{
  width:52px!important;height:52px!important;
  box-shadow:0 4px 24px rgba(0,0,0,0.4),0 0 12px rgba(212,175,55,0.15)!important;
}

/* ── 滾動條 ── */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:rgba(0,0,0,0.1)}
::-webkit-scrollbar-thumb{background:rgba(212,175,55,0.2);border-radius:var(--r-pill)}
::-webkit-scrollbar-thumb:hover{background:rgba(212,175,55,0.4)}

/* ── 選取文字顏色 ── */
::selection{background:rgba(212,175,55,0.3);color:var(--c-text)}

/* ── 平滑滾動 ── */
html{scroll-behavior:smooth}

/* ── Loading Skeleton ── */
@keyframes skeleton{0%{background-position:-200% 0}100%{background-position:200% 0}}
.skeleton{
  background:linear-gradient(90deg,rgba(255,255,255,0.03) 25%,rgba(255,255,255,0.08) 50%,rgba(255,255,255,0.03) 75%);
  background-size:200% 100%;animation:skeleton 1.5s infinite;
  border-radius:var(--r-sm);
}

/* ── 分隔線 ── */
.divider-gold{
  height:1px;margin:var(--sp-lg) 0;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,0.3),transparent);
}

/* ── 紫微命盤格子升級 ── */
.zw-grid{gap:3px!important}
.zw-cell{
  background:rgba(0,0,0,0.2)!important;
  border:1px solid rgba(212,175,55,0.1)!important;
  border-radius:var(--r-sm)!important;
  transition:border-color 0.3s;
}
.zw-cell:hover{border-color:rgba(212,175,55,0.3)}
.zw-cell.active-palace{
  border-color:rgba(212,175,55,0.5)!important;
  background:rgba(212,175,55,0.06)!important;
  box-shadow:inset 0 0 20px rgba(212,175,55,0.05);
}

/* ── Tag 升級 ── */
.tag{border-radius:var(--r-pill)!important}

/* ── 五行 Tag 彩色 ── */
.el-tag.el-金{background:rgba(192,192,192,0.15);color:#e0e0e0;border-color:rgba(192,192,192,0.3)}
.el-tag.el-木{background:rgba(34,197,94,0.15);color:#4ade80;border-color:rgba(34,197,94,0.3)}
.el-tag.el-水{background:rgba(59,130,246,0.15);color:#60a5fa;border-color:rgba(59,130,246,0.3)}
.el-tag.el-火{background:rgba(239,68,68,0.15);color:#f87171;border-color:rgba(239,68,68,0.3)}
.el-tag.el-土{background:rgba(167,139,90,0.15);color:#d4a857;border-color:rgba(167,139,90,0.3)}

/* ── Mobile 優化 ── */
@media(max-width:640px){
  .hero h1{letter-spacing:0.02em}
  .product-grid{grid-template-columns:1fr!important}
  .product-card{flex-direction:column!important;text-align:center}
  .product-card .product-actions{justify-content:center}
  .conclusion{padding:var(--sp-lg) var(--sp-md)!important}
  .live-counter-bar{flex-direction:column!important;gap:var(--sp-xs)!important;padding:var(--sp-sm)!important;border-radius:var(--r-md)!important}
  .live-counter-bar span:nth-child(2){display:none}
}

/* ── Daily Fortune ── */
.fortune-draw-area{text-align:center;padding:var(--sp-xl) 0}
.fortune-urn{font-size:4rem;animation:pulse 2s infinite;margin-bottom:var(--sp-md)}
.fortune-result{text-align:center}
.fortune-sign-icon{font-size:3rem;margin-bottom:var(--sp-sm)}
.fortune-sign-text{font-size:1.8rem;font-weight:900;color:var(--c-gold);letter-spacing:0.1em;margin-bottom:var(--sp-sm);font-family:var(--f-display)}
.fortune-msg{color:var(--c-text);font-size:1.05rem;line-height:1.6;margin-bottom:var(--sp-md)}
.fortune-divider{height:1px;background:linear-gradient(90deg,transparent,rgba(212,175,55,.3),transparent);margin:var(--sp-md) 0}
.fortune-crystal-rec{background:rgba(212,175,55,0.04);border:1px solid rgba(212,175,55,0.12);border-radius:var(--r-md);padding:var(--sp-md)}
.fortune-crystal-card{display:flex;align-items:center;gap:var(--sp-sm);justify-content:center;margin:var(--sp-sm) 0}
.fortune-crystal-name{font-weight:700;font-size:1.1rem;color:var(--c-gold)}
.fortune-buy-btns{display:flex;gap:var(--sp-sm);justify-content:center}
.achievements-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:var(--sp-sm)}
.achievement-badge{text-align:center;padding:var(--sp-md);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);transition:all 0.3s}
.achievement-badge.unlocked{border-color:rgba(212,175,55,0.3);background:rgba(212,175,55,0.04)}
.achievement-badge.locked{opacity:0.4;filter:grayscale(0.8)}
.badge-icon{font-size:2rem;margin-bottom:var(--sp-xs)}
.badge-name{font-size:0.85rem;font-weight:700;color:var(--c-text);margin-bottom:2px}
.achievement-toast{position:fixed;top:20px;right:20px;z-index:999;background:linear-gradient(135deg,rgba(30,12,12,0.95),rgba(45,10,10,0.98));border:2px solid var(--c-gold);border-radius:var(--r-lg);padding:var(--sp-md) var(--sp-lg);display:flex;align-items:center;gap:var(--sp-md);box-shadow:0 8px 32px rgba(0,0,0,0.5);transform:translateX(120%);transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);max-width:320px}
.achievement-toast.show{transform:translateX(0)}
.at-icon{font-size:2rem}
.ency-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:var(--sp-sm)}
.ency-card{padding:var(--sp-md);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);cursor:pointer;transition:all 0.3s;background:rgba(0,0,0,0.15)}
.ency-card:hover{border-color:rgba(212,175,55,0.3);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3)}
.ency-icon{font-size:2rem;margin-bottom:var(--sp-xs)}
.ency-name{font-weight:700;color:var(--c-text);font-size:0.95rem}
.ency-meta{display:flex;gap:var(--sp-xs);margin:var(--sp-xs) 0}
.ency-desc{font-size:0.78rem;color:var(--c-text-dim);line-height:1.4;margin:var(--sp-xs) 0}
.ency-price{font-weight:700;color:var(--c-gold);font-size:0.9rem}
.crystal-detail-modal{position:fixed;inset:0;z-index:600;display:flex;align-items:center;justify-content:center;padding:var(--sp-md)}
.crystal-detail-modal.hidden{display:none}
.cdm-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
.cdm-content{position:relative;background:linear-gradient(135deg,rgba(30,12,12,0.98),rgba(20,8,8,0.99));border:1px solid rgba(212,175,55,0.25);border-radius:var(--r-lg);padding:var(--sp-xl);max-width:420px;width:100%;max-height:90vh;overflow-y:auto;text-align:center}
.cdm-close{position:absolute;top:var(--sp-sm);right:var(--sp-sm);background:none;border:none;color:var(--c-text-dim);font-size:1.2rem;cursor:pointer}
.cdm-icon{font-size:3.5rem;margin-bottom:var(--sp-sm)}
.cdm-name{font-size:1.5rem;font-weight:700;color:var(--c-gold);font-family:var(--f-display);margin-bottom:var(--sp-sm)}
.cdm-tags{display:flex;gap:var(--sp-sm);justify-content:center;margin-bottom:var(--sp-md)}
.cdm-desc{color:var(--c-text);line-height:1.6;margin-bottom:var(--sp-md)}
.cdm-info{text-align:left;background:rgba(0,0,0,0.2);border-radius:var(--r-md);padding:var(--sp-md);margin-bottom:var(--sp-lg)}
.cdm-row{padding:var(--sp-xs) 0;color:var(--c-text-dim);font-size:0.9rem}
.cdm-row strong{color:var(--c-gold)}
.cdm-actions{display:flex;gap:var(--sp-sm);justify-content:center;flex-wrap:wrap}
.quiz-progress{text-align:center;color:var(--c-text-dim);font-size:0.85rem;margin-bottom:var(--sp-xs)}
.quiz-progress-bar{height:4px;background:rgba(255,255,255,0.06);border-radius:var(--r-pill);overflow:hidden;margin-bottom:var(--sp-lg)}
.quiz-fill{height:100%;background:linear-gradient(90deg,var(--c-crimson),var(--c-gold));border-radius:var(--r-pill);transition:width 0.4s}
.quiz-question{text-align:center;font-size:1.15rem;color:var(--c-text);margin-bottom:var(--sp-lg);line-height:1.5}
.quiz-options{display:flex;flex-direction:column;gap:var(--sp-sm)}
.quiz-option{padding:1rem var(--sp-lg);border:1px solid rgba(255,255,255,0.08);border-radius:var(--r-md);background:rgba(0,0,0,0.15);color:var(--c-text);cursor:pointer;text-align:left;transition:all 0.3s;font-size:0.95rem}
.quiz-option:hover{border-color:rgba(212,175,55,0.4);background:rgba(212,175,55,0.06);transform:translateX(4px)}
.quiz-result{text-align:center}
.quiz-result-icon{font-size:3.5rem;margin-bottom:var(--sp-sm)}
.quiz-result-title{color:var(--c-text-dim);font-size:0.95rem;margin-bottom:var(--sp-xs)}
.quiz-result-crystal{font-size:2rem;font-weight:900;color:var(--c-gold);font-family:var(--f-display);margin-bottom:var(--sp-sm)}
.quiz-result-el{display:flex;gap:var(--sp-sm);justify-content:center;margin-bottom:var(--sp-md)}
.quiz-result-desc{color:var(--c-text);line-height:1.6;margin-bottom:var(--sp-sm)}
.quiz-result-actions{display:flex;gap:var(--sp-sm);justify-content:center;flex-wrap:wrap}
.quiz-bazi-note{background:rgba(212,175,55,0.06);border:1px solid rgba(212,175,55,0.2);border-radius:var(--r-md);padding:var(--sp-sm) var(--sp-md);margin:var(--sp-md) 0;font-size:0.85rem;color:var(--c-text-dim);line-height:1.5}
.quiz-bazi-note strong{color:var(--c-gold)}
.quiz-bazi-match{background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.2);border-radius:var(--r-md);padding:var(--sp-sm) var(--sp-md);margin:var(--sp-md) 0;font-size:0.85rem;color:rgba(74,222,128,0.9);line-height:1.5}
.quiz-bazi-match strong{color:#4ade80}
.review-carousel{min-height:120px;transition:opacity 0.3s}
.review-card{border:1px solid rgba(212,175,55,0.12);border-radius:var(--r-md);padding:var(--sp-md);background:rgba(0,0,0,0.15)}
.review-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-sm);flex-wrap:wrap;gap:var(--sp-xs)}
.review-stars{font-size:0.85rem}
.review-meta{font-size:0.75rem;color:var(--c-text-muted)}
.review-text{color:var(--c-text);line-height:1.6;font-size:0.9rem;margin-bottom:var(--sp-sm)}
.review-product{display:flex;justify-content:flex-end}
.extra-nav{display:flex;gap:var(--sp-xs);overflow-x:auto;padding:var(--sp-sm) 0;margin:var(--sp-lg) 0 var(--sp-sm);border-bottom:1px solid rgba(255,255,255,0.06);-webkit-overflow-scrolling:touch;position:sticky;top:48px;z-index:50;background:rgba(13,4,4,0.95);backdrop-filter:blur(8px)}
.nav-extra-tab{padding:0.5rem 1rem;border-radius:var(--r-pill);font-size:0.82rem;white-space:nowrap;border:1px solid rgba(255,255,255,0.06);background:none;color:var(--c-text-dim);cursor:pointer;transition:all 0.3s}
.nav-extra-tab.active{background:rgba(212,175,55,0.1);color:var(--c-gold);border-color:rgba(212,175,55,0.3)}
.extra-section{padding:var(--sp-md) 0}
.extra-section.hidden{display:none}

/* ── Games ── */
.game-progress{text-align:center;font-size:0.85rem;color:var(--c-gold);margin-bottom:var(--sp-md)}
.game-question{text-align:center;font-size:1.15rem;margin-bottom:var(--sp-lg);line-height:1.5}
.game-options{display:flex;flex-wrap:wrap;gap:var(--sp-sm);justify-content:center}
.game-opt{padding:0.7rem 1.2rem;border:1px solid rgba(255,255,255,0.1);border-radius:var(--r-md);background:rgba(0,0,0,0.2);color:var(--c-text);cursor:pointer;font-size:0.95rem;transition:all 0.3s;min-width:60px}
.game-opt:hover{border-color:rgba(212,175,55,0.4);background:rgba(212,175,55,0.06)}
.game-opt.correct{border-color:#4ade80!important;background:rgba(34,197,94,0.15)!important;color:#4ade80!important}
.game-opt.wrong{border-color:#f87171!important;background:rgba(239,68,68,0.15)!important;color:#f87171!important}
.game-feedback{text-align:center;margin-top:var(--sp-md);font-size:1rem;min-height:1.5em}
.fb-correct{color:#4ade80}.fb-wrong{color:#f87171}
.game-result{text-align:center;padding:var(--sp-lg)}
.game-result-icon{font-size:3rem;margin-bottom:var(--sp-sm)}
.game-score-big{font-size:2.5rem;font-weight:900;color:var(--c-gold);margin:var(--sp-sm) 0}
.game-actions{display:flex;gap:var(--sp-sm);justify-content:center}
.zodiac-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:var(--sp-xs)}
.zodiac-btn{display:flex;flex-direction:column;align-items:center;padding:var(--sp-sm);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);background:none;color:var(--c-text);cursor:pointer;transition:all 0.3s}
.zodiac-btn:hover,.zodiac-btn.selected{border-color:var(--c-gold);background:rgba(212,175,55,0.08)}
.zodiac-icon{font-size:1.5rem}.zodiac-name{font-size:0.7rem;margin-top:2px}
.zodiac-selected{text-align:center;font-size:1.2rem;min-height:1.5em}
.zodiac-result{text-align:center;padding:var(--sp-lg)}
.zodiac-pair-icons{font-size:2.5rem;margin-bottom:var(--sp-sm)}
.zodiac-match-score{font-size:2rem;font-weight:900;color:var(--c-gold)}
.zodiac-match-level{font-size:1.1rem;color:var(--c-text);margin-bottom:var(--sp-sm)}
.lucky-card{padding:var(--sp-lg)}
.lucky-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-md)}
.lucky-item{text-align:center;padding:var(--sp-md);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);background:rgba(0,0,0,0.1)}
.lucky-label{font-size:0.75rem;color:var(--c-text-muted);margin-bottom:var(--sp-xs)}
.lucky-value{font-size:1.1rem;font-weight:700;color:var(--c-text);display:flex;align-items:center;justify-content:center;gap:var(--sp-xs)}
.lucky-num{font-size:2rem;color:var(--c-gold)}
.lucky-sub{font-size:0.7rem;color:var(--c-text-dim);margin-top:2px}
.lucky-color-dot{width:16px;height:16px;border-radius:50%;display:inline-block;border:1px solid rgba(255,255,255,0.2)}
@media(max-width:640px){.zodiac-grid{grid-template-columns:repeat(4,1fr)}}

/* Tarot card generated images */
.tc-img{width:100%;height:auto;border-radius:4px;display:block;margin-bottom:4px}
.t-card-face.t-front{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4px}
.t-card-face.t-front .tc-name{font-size:0.7rem;margin-top:2px}
.tc-spread-img{box-shadow:0 2px 8px rgba(0,0,0,0.3);border:1px solid rgba(212,175,55,0.3)}

.yao-visual{display:flex;flex-direction:column;gap:5px;padding:8px 0;width:70px;margin:0 auto}
.yao-row{display:flex;align-items:center;justify-content:center;height:8px;gap:0}
.yao-dong{filter:drop-shadow(0 0 3px rgba(232,201,104,0.5))}


/* ═══════════════════════════════════════════════════════════
   UI OVERHAUL — 儀式感升級
   ═══════════════════════════════════════════════════════════ */

/* ── 浮動粒子 ── */
.particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;overflow:hidden}
.particle{position:absolute;border-radius:50%;background:radial-gradient(circle,rgba(212,175,55,0.6),transparent 70%);animation:particleFloat linear infinite;opacity:0}
@keyframes particleFloat{
  0%{opacity:0;transform:translateY(100vh) scale(0)}
  10%{opacity:1}
  90%{opacity:1}
  100%{opacity:0;transform:translateY(-10vh) scale(1)}
}

/* ── 月亮 Hero 升級 ── */
.hero-moon{
  position:relative;width:80px;height:80px;margin:0 auto var(--sp-md);
}
.hero-moon-crescent{
  width:80px;height:80px;
  border-radius:50%;
  background:transparent;
  box-shadow:inset -18px 2px 0 0 var(--c-gold-light),
    0 0 30px rgba(212,175,55,0.3),
    0 0 60px rgba(212,175,55,0.15),
    0 0 100px rgba(212,175,55,0.08);
  animation:moonBreath 4s ease-in-out infinite;
}
@keyframes moonBreath{
  0%,100%{opacity:0.85;transform:scale(0.98);box-shadow:inset -18px 2px 0 0 var(--c-gold-light),0 0 30px rgba(212,175,55,0.25),0 0 60px rgba(212,175,55,0.1)}
  50%{opacity:1;transform:scale(1.02);box-shadow:inset -18px 2px 0 0 #f0d060,0 0 40px rgba(212,175,55,0.4),0 0 80px rgba(212,175,55,0.2),0 0 120px rgba(212,175,55,0.08)}
}

/* ── 六宮格 ── */
.hook-grid-6{
  display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
  max-width:480px;margin:0 auto;
}
.hook-card-v2{
  display:flex;flex-direction:column;align-items:center;gap:6px;
  padding:var(--sp-md) var(--sp-xs);
  background:rgba(30,12,12,0.6);
  border:1.5px solid rgba(212,175,55,0.15);
  border-radius:var(--r-lg);
  cursor:pointer;transition:all .3s cubic-bezier(0.4,0,0.2,1);
  -webkit-tap-highlight-color:transparent;
  position:relative;overflow:hidden;
}
.hook-card-v2::before{
  content:'';position:absolute;inset:0;
  border-radius:var(--r-lg);
  background:radial-gradient(circle at 50% 50%,rgba(212,175,55,0.06),transparent 70%);
  opacity:0;transition:opacity .3s;
}
.hook-card-v2:hover::before,.hook-card-v2:active::before{opacity:1}
.hook-card-v2:hover,.hook-card-v2:active{
  border-color:var(--c-gold);
  transform:translateY(-3px);
  box-shadow:0 8px 28px rgba(212,175,55,0.18);
}
.hook-card-v2 .hook-emoji{
  font-size:1.8rem;line-height:1;
  filter:drop-shadow(0 0 8px rgba(212,175,55,0.3));
}
.hook-card-v2 .hook-title{font-weight:700;font-size:.88rem;color:var(--c-gold-light);font-family:var(--f-display)}
.hook-card-v2 .hook-sub{font-size:.72rem;color:var(--c-text-muted)}
@media(max-width:380px){
  .hook-grid-6{grid-template-columns:repeat(2,1fr)}
}

/* ── 卡片進場動畫 ── */
.card-reveal{opacity:0;transform:translateY(24px);transition:opacity .6s cubic-bezier(0.16,1,0.3,1),transform .6s cubic-bezier(0.16,1,0.3,1)}
.card-reveal.visible{opacity:1;transform:none}

/* ── 社會認同計數 ── */
.social-proof-count{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 14px;border-radius:var(--r-pill);
  background:rgba(212,175,55,0.06);border:1px solid rgba(212,175,55,0.12);
  font-size:.78rem;color:var(--c-gold);margin:var(--sp-sm) auto 0;
}
.social-proof-dot{width:6px;height:6px;border-radius:50%;background:#4ade80;animation:dotPulse 2s infinite}
@keyframes dotPulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ── 塔羅牌升級 ── */
.tarot-deck-card{flex:0 0 52px!important;height:80px!important}
@media(max-width:640px){.tarot-deck-card{flex:0 0 46px!important;height:72px!important}}
.tarot-deck-card-inner{
  transition:all .3s ease!important;
  background:linear-gradient(145deg,#1a0c2e,#0e0620)!important;
}
.tarot-deck-card:hover .tarot-deck-card-inner{
  border-color:var(--c-gold)!important;
  box-shadow:0 0 20px rgba(212,175,55,0.4),0 4px 16px rgba(0,0,0,.5)!important;
}
/* 翻牌動畫 */
.tarot-deck-card.flipping{
  animation:tarotFlip .6s ease-in-out;
  pointer-events:none;
}
@keyframes tarotFlip{
  0%{transform:translateY(0) rotateY(0)}
  30%{transform:translateY(-20px) rotateY(0) scale(1.1)}
  50%{transform:translateY(-20px) rotateY(90deg) scale(1.1)}
  70%{transform:translateY(-20px) rotateY(180deg) scale(1.1)}
  100%{transform:translateY(0) rotateY(360deg) scale(1)}
}
/* 飛入牌陣 */
.tarot-deck-card.flying{
  position:fixed!important;z-index:999;
  transition:all .5s cubic-bezier(0.34,1.56,0.64,1)!important;
}
/* 牌陣接牌 */
.tarot-chosen-slot.receiving{animation:slotBounce .4s ease}
@keyframes slotBounce{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}

/* ── 梅花起卦動畫 ── */
.mh-casting-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:9998;
  background:rgba(13,4,4,0.95);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:var(--sp-md);
}
.mh-yao-anim{
  display:flex;flex-direction:column-reverse;gap:8px;align-items:center;
}
.mh-yao-line{
  width:120px;height:10px;border-radius:2px;
  opacity:0;transform:scaleX(0);
  transition:all .5s cubic-bezier(0.34,1.56,0.64,1);
}
.mh-yao-line.yang{background:var(--c-gold)}
.mh-yao-line.yin{
  background:transparent;
  border-left:52px solid var(--c-gold);
  border-right:52px solid var(--c-gold);
  width:120px;box-sizing:border-box;
}
.mh-yao-line.show{opacity:1;transform:scaleX(1)}
.mh-yao-line.dong{filter:drop-shadow(0 0 6px rgba(232,201,104,0.8))}
.mh-gua-name{
  font-family:var(--f-display);font-size:2rem;font-weight:900;
  color:var(--c-gold);opacity:0;transform:scale(0.5);
  transition:all .6s cubic-bezier(0.34,1.56,0.64,1);
  text-shadow:0 0 30px rgba(212,175,55,0.5);
}
.mh-gua-name.show{opacity:1;transform:scale(1)}

/* ── 環形進度條（結果頁 Verdict）── */
.verdict-ring{
  position:relative;width:160px;height:160px;margin:0 auto var(--sp-md);
}
.verdict-ring svg{width:100%;height:100%;transform:rotate(-90deg)}
.verdict-ring-bg{fill:none;stroke:rgba(255,255,255,0.06);stroke-width:8}
.verdict-ring-fill{
  fill:none;stroke-width:8;stroke-linecap:round;
  transition:stroke-dashoffset 2s cubic-bezier(0.4,0,0.2,1),stroke 1s ease;
}
.verdict-ring-center{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  text-align:center;
}
.verdict-ring-pct{font-size:2.2rem;font-weight:900;font-family:var(--f-display);letter-spacing:1px}
.verdict-ring-label{font-size:.85rem;color:var(--c-text-dim);margin-top:2px}
.verdict-sources{
  display:flex;justify-content:center;gap:var(--sp-md);margin-top:var(--sp-sm);
  font-size:.72rem;color:var(--c-text-muted);
}
.verdict-source{display:flex;flex-direction:column;align-items:center;gap:2px}
.verdict-source i{font-size:1rem;color:var(--c-gold);opacity:.6}

/* ── 載入動畫升級 ── */
.loading-bagua{
  width:80px;height:80px;margin-bottom:var(--sp-lg);
  animation:baguaSpin 3s linear infinite;
  opacity:.6;
}
@keyframes baguaSpin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.loading-step-text{
  font-size:.85rem;color:var(--c-text-muted);
  transition:all .4s ease;
  min-height:1.2em;text-align:center;
}
.loading-step-text.active{color:var(--c-gold);font-weight:500}

/* ── 按鈕漣漪效果 ── */
.ripple{position:relative;overflow:hidden}
.ripple-wave{
  position:absolute;border-radius:50%;
  background:rgba(212,175,55,0.3);
  transform:scale(0);animation:rippleExpand .6s ease-out;
  pointer-events:none;
}
@keyframes rippleExpand{to{transform:scale(4);opacity:0}}

/* ── 回答區升級 ── */
.answer-block{
  position:relative;
  padding-left:var(--sp-md);
  border-left:3px solid var(--c-gold);
  font-family:var(--f-display);
  font-size:1.05rem;line-height:2;
}

/* ── 數字跳動 ── */
.count-up{display:inline-block}

/* ══ 後台計數器 ══ */
.counter-badge{
  display:none;
  margin:8px auto 0;
  padding:5px 16px;
  background:rgba(212,175,55,.06);
  border:1px solid rgba(212,175,55,.15);
  border-radius:var(--r-pill);
  font-size:.75rem;color:var(--c-gold);
  text-align:center;
  animation:fadeIn .5s ease both;
}
.counter-badge.visible{display:inline-block}
.counter-badge i{margin-right:4px;font-size:.65rem}
.admin-panel{
  display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  z-index:10001;background:rgba(14,6,6,.97);border:1px solid rgba(212,175,55,.3);
  border-radius:var(--r-lg);padding:var(--sp-lg);width:280px;max-width:85vw;
  box-shadow:0 24px 64px rgba(0,0,0,.7);
}
.admin-panel.visible{display:block;animation:scaleIn .3s ease both}
.admin-panel h3{font-family:var(--f-display);color:var(--c-gold);font-size:1rem;margin-bottom:var(--sp-md);text-align:center}
.admin-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:.85rem}
.admin-row:last-child{border-bottom:none}
.admin-row label{color:var(--c-text-dim)}
.admin-row .admin-val{font-weight:700;color:var(--c-gold);font-size:1.15rem}
.admin-btn{display:block;width:100%;margin-top:var(--sp-lg);padding:10px;border-radius:var(--r-md);border:1px solid rgba(212,175,55,.25);background:rgba(212,175,55,.06);color:var(--c-gold);font-weight:600;font-size:.85rem;cursor:pointer;transition:all .2s}
.admin-btn:hover{background:rgba(212,175,55,.12)}
.admin-close{position:absolute;top:8px;right:12px;background:none;border:none;color:var(--c-text-muted);font-size:1.2rem;cursor:pointer}
.admin-overlay{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
.admin-overlay.visible{display:block}

/* ===== Plain Language Mode (C default) ===== */
body.plain .pro-only{display:none !important;}
body.plain .plain-only{display:block !important;}
.plain-only{display:none;}
.pro-details{margin-top:10px;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;background:rgba(0,0,0,.18);}
.pro-details > summary{cursor:pointer;font-weight:700;opacity:.9;}
.plain-card{border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px 12px;margin:10px 0;background:rgba(0,0,0,.22);}
.plain-card .plain-title{font-weight:800;margin-bottom:6px;}
.plain-card ul{margin:8px 0 0 18px;}
.plain-badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.16);opacity:.9;margin-left:6px;}

</style>
</head>
<body ondragstart="return false" ondrop="return false">
<nav class="nav"><div class="nav-inner">
  <div class="nav-brand"><i class="fas fa-moon"></i><span>靜月之光 v4.0</span></div>
  <div class="nav-links">
    <button class="nav-link active" onclick="goStep(0)">輸入</button>
    <button class="nav-link" onclick="goStep(1)">梅花</button>
    <button class="nav-link" onclick="goStep(2)">塔羅</button>
    <button class="nav-link" onclick="goStep(3)">結果</button>
  </div>
  <div class="nav-shop">
    <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer">🛒 蝦皮</a>
    <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer">📦 7-11</a>
  </div>
</div></nav>

<div class="app">

<!-- ========== STEP 0: INPUT (Redesigned Funnel) ========== -->
<section class="step active" id="step-0">

  <!-- ═══ PHASE A: Hook Screen ═══ -->
  <div id="hook-screen">
    <!-- 浮動粒子 -->
    <div class="particles" id="particles"></div>

    <div class="hero" style="position:relative;z-index:1">
      <div class="hero-moon" id="hero-moon" onclick="_moonTap()"><div class="hero-moon-crescent"></div></div>
      <div class="counter-badge" id="counter-badge"><i class="fas fa-user-clock"></i> 今日 <span id="counter-today">0</span> 人 ｜ <i class="fas fa-users"></i> 累計 <span id="counter-num">0</span> 人</div>
      <h1 style="font-size:clamp(1.4rem,4.5vw,1.9rem);letter-spacing:0.03em">你的命盤，藏著答案</h1>
      <p style="font-size:.85rem;line-height:1.7;max-width:420px;margin:0 auto 4px;color:var(--c-text-dim)">融合八字 · 紫微 · 梅花 · 塔羅的多維命理分析</p>

    </div>

    <!-- 六宮格 -->
    <div class="hook-grid-6" style="position:relative;z-index:1">
      <button class="hook-card-v2" onclick="pickType('love')">
        <span class="hook-emoji">💕</span>
        <span class="hook-title">感情桃花</span>
        <span class="hook-sub">今年有桃花嗎？</span>
      </button>
      <button class="hook-card-v2" onclick="pickType('career')">
        <span class="hook-emoji">💼</span>
        <span class="hook-title">事業方向</span>
        <span class="hook-sub">該不該換工作？</span>
      </button>
      <button class="hook-card-v2" onclick="pickType('wealth')">
        <span class="hook-emoji">💰</span>
        <span class="hook-title">財運投資</span>
        <span class="hook-sub">今年財運如何？</span>
      </button>
      <button class="hook-card-v2" onclick="pickType('health')">
        <span class="hook-emoji">🏥</span>
        <span class="hook-title">健康身心</span>
        <span class="hook-sub">該注意什麼？</span>
      </button>
      <button class="hook-card-v2" onclick="pickType('relationship')">
        <span class="hook-emoji">🤝</span>
        <span class="hook-title">人際合作</span>
        <span class="hook-sub">小人還是貴人？</span>
      </button>
      <button class="hook-card-v2" onclick="pickType('family')">
        <span class="hook-emoji">🏠</span>
        <span class="hook-title">家庭親子</span>
        <span class="hook-sub">家庭和諧嗎？</span>
      </button>
    </div>
    <div style="display:flex;justify-content:center;gap:var(--sp-md);margin-top:var(--sp-lg);font-size:.75rem;color:var(--c-text-muted);position:relative;z-index:1">
      <span>⚡ 免費 · 10 秒出結果</span>
      <span>🔒 資料不上傳</span>
    </div>
  </div>

  <!-- ═══ PHASE A.5: 信任預覽（先給價值再要資料） ═══ -->
  <div id="trust-preview" style="display:none">
    <div style="display:flex;align-items:center;gap:var(--sp-sm);margin-bottom:var(--sp-md)">
      <button class="btn btn-outline btn-sm" onclick="backToHook()" style="padding:.3rem .6rem"><i class="fas fa-arrow-left"></i></button>
      <span class="tag tag-gold" id="trust-type-tag" style="font-size:.85rem;padding:.4rem .8rem"></span>
    </div>
    <div class="card" style="border-left:3px solid var(--c-gold)">
      <div id="trust-text" class="serif" style="font-size:1rem;line-height:1.8"></div>
    </div>
    <div style="text-align:center;margin-top:var(--sp-md)">
      <p class="text-gold serif" style="font-size:1rem;margin-bottom:var(--sp-sm)">想看更精準的？</p>
      <button class="btn btn-primary btn-lg btn-cta-pulse" onclick="showInputAfterTrust()"><i class="fas fa-bolt"></i> 輸入生日，看你的專屬分析</button>
      <p class="text-xs text-muted" style="margin-top:var(--sp-sm)">🔒 資料不上傳，僅在你的瀏覽器計算</p>
    </div>
  </div>

  <!-- ═══ PHASE B: Quick Input (hidden until type picked) ═══ -->
  <div id="input-screen" style="display:none">
    <!-- 已選類型 breadcrumb -->
    <div style="display:flex;align-items:center;gap:var(--sp-sm);margin-bottom:var(--sp-md)">
      <button class="btn btn-outline btn-sm" onclick="backToHook()" style="padding:.3rem .6rem"><i class="fas fa-arrow-left"></i></button>
      <span class="tag tag-gold" id="chosen-type-tag" style="font-size:.85rem;padding:.4rem .8rem"></span>
    </div>

    <!-- 預設問題選擇 -->
    <div class="card">
      <div class="card-title"><i class="fas fa-question-circle"></i> 你想問什麼？</div>
      <div class="form-group">
        <div class="q-preset-grid" id="q-presets"></div>
        <div id="q-custom-wrap" style="display:none;margin-top:var(--sp-sm)">
          <textarea class="form-textarea" id="f-question" placeholder="輸入你的問題…" maxlength="500" style="min-height:60px"></textarea>
          <div class="form-hint"><span id="f-char">0</span>/500</div>
        </div>
      </div>
    </div>

    <!-- 基本資料（精簡） -->
    <div class="card">
      <div class="card-title"><i class="fas fa-user"></i> 出生資料</div>
      <div style="display:flex;gap:var(--sp-md);flex-wrap:wrap">
        <div class="form-group" style="flex:0 0 auto">
          <label class="form-label">性別 <span class="req">*</span></label>
          <div class="radio-pills">
            <label class="radio-pill"><input type="radio" name="gender" value="male"><span>男</span></label>
            <label class="radio-pill"><input type="radio" name="gender" value="female"><span>女</span></label>
          </div>
        </div>
        <div class="form-group" style="flex:1 1 200px">
          <label class="form-label">出生日期（國曆）<span class="req">*</span></label>
          <input type="date" class="form-input" id="f-bdate">
        </div>
      </div>
      <!-- 進階：收合 -->
      <details class="advance-toggle" id="advance-fields">
        <summary><i class="fas fa-chevron-right advance-arrow"></i> 填更多，結果更準（選填）</summary>
        <div style="padding-top:var(--sp-md)">
          <div class="form-group">
            <label class="form-label">出生時間</label>
            <select class="form-input" id="f-btime">
              <option value="">請選擇</option>
              <option value="00:00">00:00（子時）</option>
              <option value="01:00">01:00（丑時）</option>
              <option value="02:00">02:00（丑時）</option>
              <option value="03:00">03:00（寅時）</option>
              <option value="04:00">04:00（寅時）</option>
              <option value="05:00">05:00（卯時）</option>
              <option value="06:00">06:00（卯時）</option>
              <option value="07:00">07:00（辰時）</option>
              <option value="08:00">08:00（辰時）</option>
              <option value="09:00">09:00（巳時）</option>
              <option value="10:00">10:00（巳時）</option>
              <option value="11:00">11:00（午時）</option>
              <option value="12:00">12:00（午時）</option>
              <option value="13:00">13:00（未時）</option>
              <option value="14:00">14:00（未時）</option>
              <option value="15:00">15:00（申時）</option>
              <option value="16:00">16:00（申時）</option>
              <option value="17:00">17:00（酉時）</option>
              <option value="18:00">18:00（酉時）</option>
              <option value="19:00">19:00（戌時）</option>
              <option value="20:00">20:00（戌時）</option>
              <option value="21:00">21:00（亥時）</option>
              <option value="22:00">22:00（亥時）</option>
              <option value="23:00">23:00（子時）</option>
            </select>
            <label style="display:flex;align-items:center;gap:.4rem;margin-top:.4rem;font-size:.82rem;color:var(--c-text-dim);cursor:pointer">
              <input type="checkbox" id="f-btime-unsure" onchange="if(this.checked){document.getElementById('f-btime').value='';document.getElementById('f-btime').disabled=true}else{document.getElementById('f-btime').disabled=false}"> 不確定出生時間
            </label>
          </div>
          <div class="form-group">
            <label class="form-label">姓名</label>
            <input type="text" class="form-input" id="f-name" placeholder="用於姓名學分析">
          </div>
        </div>
      </details>
    </div>

    <!-- CTA -->
    <div class="actions actions-center" style="flex-direction:column;gap:var(--sp-sm)">
      <button class="btn btn-primary btn-lg btn-cta-pulse" id="btn-go" onclick="submitStep0Fast()"><i class="fas fa-bolt"></i> 看我的命盤分析</button>
      <button type="button" class="btn btn-outline btn-sm" onclick="submitStep0()" style="opacity:0.6"><i class="fas fa-sliders-h"></i> 進階：手動起卦＋抽牌</button>
    </div>
  </div>

  <!-- hidden select for backward compat -->
  <select class="form-select" id="f-type" style="display:none">
    <option value="">請選擇方向</option>
    <option value="love">💕 感情</option>
    <option value="career">💼 事業</option>
    <option value="wealth">💰 財運</option>
    <option value="health">🏥 健康</option>
    <option value="relationship">🤝 人際</option>
    <option value="family">🏠 家庭</option>
  </select>

</section>

<!-- ========== STEP 1: MEIHUA ========== -->
<section class="step" id="step-1">
  <div class="card">
    <div class="card-title"><i class="fas fa-yin-yang"></i> 梅花易數起卦</div>
    <div style="display:flex;gap:var(--sp-sm);flex-wrap:wrap;margin-bottom:var(--sp-md)">
      <button class="btn btn-sm btn-tab-active" id="mh-m-time" onclick="setMhMethod('time')"><i class="fas fa-clock"></i> 時間</button>
      <button class="btn btn-sm btn-outline" id="mh-m-number" onclick="setMhMethod('number')"><i class="fas fa-sort-numeric-up"></i> 數字</button>
      <button class="btn btn-sm btn-outline" id="mh-m-char" onclick="setMhMethod('char')"><i class="fas fa-font"></i> 漢字</button>
      <button class="btn btn-sm btn-outline" id="mh-m-random" onclick="setMhMethod('random')"><i class="fas fa-dice"></i> 隨機</button>
    </div>
    <div id="mhf-time"><p class="text-dim text-sm mb-md">按下按鈕自動以當前時間起卦</p><button class="btn btn-primary" onclick="calcMhTime()"><i class="fas fa-calculator"></i> 時間起卦</button></div>
    <div id="mhf-number" class="hidden">
      <div class="form-group"><label class="form-label">上卦數字 (1-999)</label><input type="number" class="form-input" id="mh-n1" min="1" max="999"></div>
      <div class="form-group"><label class="form-label">下卦數字 (1-999)</label><input type="number" class="form-input" id="mh-n2" min="1" max="999"></div>
      <div class="form-group"><label class="form-label">動爻 (1-6)</label><input type="number" class="form-input" id="mh-n3" min="1" max="6"></div>
      <button class="btn btn-primary" onclick="calcMhNumber()"><i class="fas fa-calculator"></i> 數字起卦</button>
    </div>
    <div id="mhf-char" class="hidden">
      <div class="form-group"><label class="form-label">輸入漢字 (1-3個)</label><input type="text" class="form-input" id="mh-char" placeholder="如：感情" maxlength="3"></div>
      <button class="btn btn-primary" onclick="calcMhChar()"><i class="fas fa-calculator"></i> 漢字起卦</button>
    </div>
    <div id="mhf-random" class="hidden"><p class="text-dim text-sm mb-md">心誠則靈，隨機產生卦象</p><button class="btn btn-primary" onclick="calcMhRandom()"><i class="fas fa-dice"></i> 隨機起卦</button></div>
  </div>
  <div id="mh-result" class="hidden">
    <div class="card">
      <div class="hex-grid">
        <div class="hex-card"><h4>本卦</h4><div class="hex-sym" id="mh-ben-s"></div><div class="hex-name" id="mh-ben-n"></div></div>
        <div class="hex-card"><h4>互卦</h4><div class="hex-sym" id="mh-hu-s"></div><div class="hex-name" id="mh-hu-n"></div></div>
        <div class="hex-card"><h4>變卦</h4><div class="hex-sym" id="mh-bian-s"></div><div class="hex-name" id="mh-bian-n"></div></div>
      </div>
      <div class="divider"></div>
      <div id="mh-detail" class="text-sm"></div>
    </div>
  </div>
  <div class="actions">
    <button class="btn btn-outline" onclick="goStep(0)"><i class="fas fa-arrow-left"></i> 上一步</button>
    <button class="btn btn-outline" onclick="goStep(2)"><i class="fas fa-forward"></i> 跳過</button>
    <button class="btn btn-primary" onclick="goStep(2)"><i class="fas fa-arrow-right"></i> 下一步：塔羅牌</button>
  </div>
  <p class="text-xs text-muted mt-xs" style="text-align:center"><i class="fas fa-info-circle"></i> 多起卦 → 多得「風險提醒＋避雷方向」，跳過僅影響交叉驗證深度</p>
</section>

<!-- ========== STEP 2: TAROT ========== -->
<section class="step" id="step-2">
  <div class="card">
    <div class="card-title"><i class="fas fa-star"></i> 金色黎明塔羅牌</div>
    <p class="text-dim text-sm mb-sm" style="text-align:center">凝神冥想你的問題，然後從 <strong class="text-gold">78</strong> 張塔羅牌中選出 <strong class="text-gold">10</strong> 張牌</p>
    <p class="tarot-pick-hint" id="pick-hint">← 滑動瀏覽，點選你有感覺的牌 →</p>
    <p class="text-dim text-xs" style="text-align:center" id="t-remain-text">已選 <strong id="t-remain-picked" class="text-gold">0</strong> / 10 張</p>

    <!-- 已選牌位（10個凱爾特十字位） -->
    <div class="tarot-chosen-area" id="t-chosen"></div>

    <!-- 可滑動的牌堆 -->
    <div class="tarot-deck-wrap">
      <div class="tarot-deck-scroll" id="t-deck"></div>
    </div>

    <div class="text-center" style="margin-top:var(--sp-sm)">
      <button class="btn btn-outline btn-sm" onclick="autoDraw()" style="opacity:.6"><i class="fas fa-bolt"></i> 快速全抽</button>
    </div>
  </div>
  <div id="t-spread-sec" class="hidden"><div class="card"><div class="card-title"><i class="fas fa-cross"></i> 凱爾特十字牌陣</div><div id="t-spread"></div></div></div>
  <div class="actions">
    <button class="btn btn-outline" onclick="goStep(1)"><i class="fas fa-arrow-left"></i> 上一步</button>
    <button class="btn btn-outline" onclick="skipToResult()"><i class="fas fa-forward"></i> 跳過塔羅</button>
    <button class="btn btn-primary" id="btn-analyze" onclick="goStep(3)" disabled><i class="fas fa-chart-bar"></i> 進行分析</button>
  </div>
  <p class="text-xs text-muted mt-xs" style="text-align:center"><i class="fas fa-info-circle"></i> 多抽塔羅 → 多得「時間點＋行動建議」，完整分析準確度更高</p>
</section>

<!-- ========== STEP 3: RESULT (Redesigned 3-Layer) ========== -->
<section class="step" id="step-3">

  <!-- ══════════════════════════════════════════
       第一幕：診斷 + 處方（一屏完成轉換）
       ══════════════════════════════════════════ -->

  <!-- 🎯 大判定 -->
  <div class="result-verdict" id="r-verdict">
    <div class="verdict-ring" id="verdict-ring">
      <svg viewBox="0 0 160 160">
        <circle class="verdict-ring-bg" cx="80" cy="80" r="70"/>
        <circle class="verdict-ring-fill" id="verdict-ring-fill" cx="80" cy="80" r="70"
          stroke-dasharray="440" stroke-dashoffset="440"/>
      </svg>
      <div class="verdict-ring-center">
        <div class="verdict-ring-pct" id="r-vprob">0%</div>
        <div class="verdict-ring-label" id="r-vlabel">分析中…</div>
      </div>
    </div>
    <div class="verdict-note" id="r-vnote" style="display:none"></div>
    <div class="verdict-sources" id="r-verdict-sources">
      <div class="verdict-source"><i class="fas fa-yin-yang"></i>八字</div>
      <div class="verdict-source"><span style="font-size:.7rem">☰</span>梅花</div>
      <div class="verdict-source"><i class="fas fa-star"></i>塔羅</div>
      <div class="verdict-source"><i class="fas fa-th"></i>紫微</div>
    </div>
    <div id="r-verdict-mini-mh" style="text-align:center;margin-top:6px;font-size:.7rem;color:var(--c-text-dim)"></div>
  </div>

  <!-- 🎯 你問的問題（第一屏可見）-->
  <div id="r-question-hero" class="text-dim" style="text-align:center;font-size:.9rem;margin:-0.5rem 0 0.5rem;padding:0 var(--sp-md)"></div>

  <!-- 🎯 核心回答（精簡版：一句刺點話 + 交叉故事）-->
  <div class="card" style="border-left:3px solid var(--c-gold)">
    <div id="r-answer" class="serif" style="font-size:1.05rem;line-height:1.8"></div>
  </div>

  <!-- 🛒 你現在最該做的事（第一屏CTA核心）-->
  <div class="card quick-shop-card" id="quick-shop">
    <div style="display:flex;align-items:center;gap:var(--sp-sm);margin-bottom:var(--sp-md)">
      <span style="font-size:1.4rem">💎</span>
      <div>
        <div style="font-weight:700;color:var(--c-gold);font-size:1rem" id="qs-title">站長根據你的命盤挑的</div>
        <div class="text-xs text-dim" id="qs-subtitle">喜用神對應水晶・日常佩戴補強能量</div>
      </div>
    </div>
    <div id="qs-products" style="display:flex;gap:10px;overflow-x:auto;padding-bottom:var(--sp-sm);-webkit-overflow-scrolling:touch"></div>
    <div style="display:flex;gap:10px;margin-top:var(--sp-md)">
      <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener" style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:12px 14px;border-radius:10px;background:linear-gradient(135deg,rgba(212,175,55,.15),rgba(212,175,55,.08));color:var(--c-gold);text-decoration:none;font-size:.82rem;font-weight:600;border:1.5px solid rgba(212,175,55,.4);box-shadow:0 4px 12px rgba(212,175,55,.08);transition:all .2s"><i class="fas fa-shopping-cart"></i> 逛推薦分類</a>
      <button onclick="openCustomModal()" style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:12px 14px;border-radius:10px;background:transparent;color:var(--c-gold);font-size:.82rem;font-weight:600;border:1.5px solid rgba(212,175,55,.4);box-shadow:0 4px 12px rgba(212,175,55,.08);cursor:pointer;transition:all .2s;font-family:inherit"><i class="fas fa-magic"></i> 量身客製</button>
    </div>
  </div>

  <!-- ═══ 以下全部收折：想看細節再展開 ═══ -->

  <!-- 🎯 完整問答分析（收折）-->
  <div class="card collapsible-card">
    <div class="card-title collapsible-toggle" onclick="toggleCollapse(this)">
      <span><i class="fas fa-bullseye"></i> 完整問答分析</span>
      <i class="fas fa-chevron-down collapse-arrow"></i>
    </div>
    <div class="collapsible-body">
      <div id="r-question" class="text-dim mb-md"></div>
      <div id="r-answer-full" class="serif" style="font-size:.95rem;line-height:1.8"></div>
    </div>
  </div>

  <!-- ⚡ 行動指令 + 嵌入水晶（收折）-->
  <div class="card collapsible-card" id="action-card">
    <div class="card-title collapsible-toggle" onclick="toggleCollapse(this)">
      <span><i class="fas fa-bolt"></i> 本月行動指令</span>
      <i class="fas fa-chevron-down collapse-arrow"></i>
    </div>
    <div class="collapsible-body">
      <div id="r-actions" style="margin-bottom:var(--sp-md)"></div>
      <div id="r-action-crystal"></div>
    </div>
  </div>

  <!-- ══════════════════════════════════════════
       第二幕：為什麼這樣判斷（三張摘要卡片）
       ══════════════════════════════════════════ -->
  <div style="text-align:center;padding:var(--sp-md) 0 var(--sp-sm)">
    <span class="text-dim text-sm" style="letter-spacing:.1em">▼ 為什麼這樣判斷 ▼</span>
  </div>
  <div id="act2-cards"></div>

  <!-- ══════════════════════════════════════════
       第三幕：深度資料（全部折疊）
       ══════════════════════════════════════════ -->
  <div style="text-align:center;padding:var(--sp-md) 0 var(--sp-sm)">
    <span class="text-dim text-xs" style="letter-spacing:.1em">▼ 深度命理資料 ▼</span>
  </div>

  <!-- ☯ 五行能量（已移至命理詳細分析，此處隱藏）-->
  <div class="card collapsible-card" id="remedy-alert-wrap" style="display:none">
    <div class="card-title collapsible-toggle" onclick="toggleCollapse(this)">
      <span><i class="fas fa-yin-yang"></i> 五行能量分佈</span>
      <i class="fas fa-chevron-down collapse-arrow"></i>
    </div>
    <div class="collapsible-body">
      <div class="remedy-alert" id="remedy-alert" style="border:none;background:none;box-shadow:none;padding:0;margin:0">
        <div id="remedy-diagnosis" class="remedy-diagnosis"></div>
      </div>
    </div>
  </div>

  <!-- 💎 能量優化方案（與行動指令重複，已合併至行動指令）-->
  <div class="card collapsible-card" id="remedy-plan-wrap" style="display:none">
    <div class="card-title collapsible-toggle" onclick="toggleCollapse(this)">
      <span><i class="fas fa-wand-magic-sparkles"></i> 能量優化方案</span>
      <i class="fas fa-chevron-down collapse-arrow"></i>
    </div>
    <div class="collapsible-body">
      <div id="remedy-actions" class="remedy-actions"></div>
    </div>
  </div>

  <!-- 📊 可能性評估 -->
  <div class="card collapsible-card">
    <div class="card-title collapsible-toggle" onclick="toggleCollapse(this)">
      <span><i class="fas fa-chart-line"></i> 可能性評估</span>
      <i class="fas fa-chevron-down collapse-arrow"></i>
    </div>
    <div class="collapsible-body">
      <div class="prob-meter"><div class="prob-bar"><div class="prob-fill" id="r-pfill" style="width:0%"></div></div>
      <div class="prob-labels"><span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span></div></div>
      <div id="r-pbreak" class="mt-md text-sm"></div>
      <div class="divider"></div><div id="r-factors"></div><div id="r-suggest" class="mt-md" style="display:none"></div>
    </div>
  </div>

  <!-- 📋 命理詳解 -->
  <div class="card collapsible-card">
    <div class="card-title collapsible-toggle" onclick="toggleCollapse(this)">
      <span><i class="fas fa-scroll"></i> 命理詳細分析</span>
      <i class="fas fa-chevron-down collapse-arrow"></i>
    </div>
    <div class="collapsible-body" style="padding:0;overflow:visible">
      <div class="dim-tabs">
        <button class="dim-tab active" onclick="showDim('bazi')">八字命理</button>
        <button class="dim-tab" onclick="showDim('ziwei')">紫微斗數</button>
        <button class="dim-tab" onclick="showDim('natal')">西洋星盤</button>
        <button class="dim-tab" onclick="showDim('meihua')">梅花易數</button>
        <button class="dim-tab" onclick="showDim('tarot')">塔羅牌陣</button>
        <button class="dim-tab" onclick="showDim('name')">姓名學</button>
      </div>
      <div class="dim-pane active" id="pane-bazi">
        <h4 class="text-gold mb-md serif">四柱八字命盤</h4><div id="d-bazi"></div>
        <div class="divider"></div><h4 class="text-gold mb-md serif">五行分佈</h4><div id="d-elbar"></div>
        <div class="divider"></div><h4 class="text-gold mb-md serif">十神分析</h4><div id="d-gods" class="text-sm"></div>
        <div class="divider"></div><h4 class="text-gold mb-md serif">藏干詳解</h4><div id="d-canggan" class="text-sm"></div>
        <div class="divider"></div><h4 class="text-gold mb-md serif">喜用神與忌神</h4><div id="d-xiyong" class="text-sm"></div>
        <div class="divider"></div><h4 class="text-gold mb-md serif">大運流年</h4><div id="d-qiyun" style="font-size:0.82rem;margin-bottom:0.5rem;opacity:0.8"></div><div id="d-dayun"></div>
      </div>
      <div class="dim-pane" id="pane-ziwei">
        <h4 class="text-gold mb-md serif">紫微斗數命盤</h4>
        <div id="d-ziwei-info" class="text-sm mb-md"></div>
        <div id="d-ziwei-grid"></div>
        <div class="divider"></div>
        <h4 class="text-gold mb-md serif">四化飛星</h4>
        <div id="d-ziwei-sihua" class="text-sm"></div>
        <div class="divider"></div>
        <h4 class="text-gold mb-md serif">命盤解讀</h4>
        <div id="d-ziwei-reading" class="text-sm"></div>
      </div>
      <div class="dim-pane" id="pane-meihua"><div id="r-meihua"></div></div>
      <div class="dim-pane" id="pane-natal">
        <h4 class="text-gold mb-md serif">西洋占星本命星盤</h4>
        <div id="d-natal-summary" class="text-sm mb-md"></div>
        <div id="d-natal-chart" style="text-align:center;margin:1rem 0"></div>
        <div class="divider"></div>
        <h4 class="text-gold mb-md serif">行星落座與宮位</h4>
        <div id="d-natal-planets" class="text-sm"></div>
        <div class="divider"></div>
        <h4 class="text-gold mb-md serif">主要相位</h4>
        <div id="d-natal-aspects" class="text-sm"></div>
        <div class="divider"></div>
        <h4 class="text-gold mb-md serif">星盤解讀</h4>
        <div id="d-natal-reading" class="text-sm"></div>
      </div>
      <div class="dim-pane" id="pane-tarot"><div id="r-tarot"></div></div>
      <div class="dim-pane" id="pane-name">
        <h4 class="text-gold mb-md serif">姓名學分析（生肖派＋三才五格）</h4>
        <div id="d-name"></div>
      </div>
    </div>
  </div>

  <!-- 📝 總結（已併入「六維度深度拆解」，此區段隱藏） -->
  <div class="card collapsible-card" style="display:none">
    <div class="card-title collapsible-toggle" onclick="toggleCollapse(this)">
      <span><i class="fas fa-moon"></i> 靜月分析師總結</span>
      <i class="fas fa-chevron-down collapse-arrow"></i>
    </div>
    <div class="collapsible-body">
      <div id="r-conclusion" class="text-sm" style="line-height:1.8"></div>
    </div>
  </div>

  <!-- ═══ 水晶處方（收折：完整版）═══ -->
  <div class="card collapsible-card" style="border:1px solid rgba(212,175,55,.25)">
    <div class="card-title collapsible-toggle" onclick="toggleCollapse(this)">
      <span><i class="fas fa-gem"></i> 完整水晶處方 — 依你命盤精選</span>
      <i class="fas fa-chevron-down collapse-arrow"></i>
    </div>
    <div class="collapsible-body">
      <div id="r-crystal"></div>
    </div>
  </div>

  <!-- ═══ 底部精簡CTA ═══ -->
  <div class="card" style="border:1px solid rgba(212,175,55,.2);text-align:center">
    <div id="shop-social-proof" style="padding:var(--sp-sm) var(--sp-md);background:rgba(212,175,55,.06);border-radius:var(--r-sm);margin-bottom:var(--sp-md);border:1px solid rgba(212,175,55,.1)">
      <div style="display:flex;align-items:center;justify-content:center;gap:var(--sp-sm);margin-bottom:4px">
        <span style="color:var(--c-gold);font-size:.8rem">⭐⭐⭐⭐⭐</span>
        <span class="text-xs text-muted" id="shop-review-meta"></span>
      </div>
      <p class="text-sm" style="color:var(--c-text-dim);margin:0;line-height:1.5">「<span id="shop-review-text"></span>」</p>
      <div style="text-align:right;margin-top:4px"><span class="text-xs text-muted" id="shop-review-product"></span></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px;align-items:center;margin-top:4px">
      <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener" style="display:flex;align-items:center;justify-content:center;gap:8px;width:220px;padding:13px 20px;border-radius:12px;background:transparent;color:var(--c-gold);text-decoration:none;font-size:.88rem;font-weight:600;border:1.5px solid rgba(212,175,55,.5);box-shadow:0 4px 14px rgba(212,175,55,.1);transition:all .2s"><i class="fas fa-shopping-cart"></i> 蝦皮選購</a>
      <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener" style="display:flex;align-items:center;justify-content:center;gap:8px;width:220px;padding:13px 20px;border-radius:12px;background:transparent;color:var(--c-gold);text-decoration:none;font-size:.88rem;font-weight:600;border:1.5px solid rgba(212,175,55,.5);box-shadow:0 4px 14px rgba(212,175,55,.1);transition:all .2s"><i class="fas fa-box"></i> 7-11 取貨</a>
      <button onclick="openCustomModal()" style="display:flex;align-items:center;justify-content:center;gap:8px;width:220px;padding:13px 20px;border-radius:12px;background:transparent;color:var(--c-gold);font-size:.88rem;font-weight:600;border:1.5px solid rgba(212,175,55,.5);box-shadow:0 4px 14px rgba(212,175,55,.1);cursor:pointer;transition:all .2s;font-family:inherit"><i class="fas fa-magic"></i> 客製手鏈</button>
    </div>
  </div>

  <!-- 存圖分享 -->
  <div class="card" style="text-align:center">
    <div class="card-title"><i class="fas fa-share-alt"></i> 分享你的占卜結果</div>
    <p class="text-sm text-dim mb-md">存成圖片分享到 IG / LINE，朋友也能免費測！</p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button onclick="saveResultCard()" style="display:flex;align-items:center;justify-content:center;gap:6px;padding:12px 24px;border-radius:10px;background:linear-gradient(135deg,rgba(212,175,55,.15),rgba(212,175,55,.08));color:var(--c-gold);font-size:.85rem;font-weight:600;border:1.5px solid rgba(212,175,55,.4);box-shadow:0 4px 14px rgba(212,175,55,.08);cursor:pointer;transition:all .2s;font-family:inherit"><i class="fas fa-download"></i> 存圖分享</button>
      <button onclick="printResult()" style="display:flex;align-items:center;justify-content:center;gap:6px;padding:12px 24px;border-radius:10px;background:linear-gradient(135deg,rgba(255,255,255,.12),rgba(255,255,255,.06));color:var(--c-text-dim);font-size:.85rem;font-weight:600;border:1px solid rgba(255,255,255,.15);box-shadow:0 2px 8px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.08);cursor:pointer;transition:all .2s;font-family:inherit"><i class="fas fa-print"></i> 列印</button>
    </div>
  </div>

  <!-- 再測 -->
  <div class="card mt-lg" id="share-gate" style="text-align:center">
    <h4 style="margin-bottom:var(--sp-md)">🔄 想再測一次？</h4>
    <button onclick="retestAfterShare()" style="display:flex;align-items:center;justify-content:center;gap:8px;width:260px;margin:0 auto var(--sp-md);padding:14px 20px;border-radius:12px;background:linear-gradient(135deg,#e8c547,#d4af37);color:#1a0a0a;font-size:.92rem;font-weight:700;border:none;box-shadow:0 4px 16px rgba(212,175,55,.4),inset 0 1px 0 rgba(255,255,255,.3);cursor:pointer;transition:all .2s;font-family:inherit"><i class="fas fa-redo"></i> 重新開始新的占卜</button>
    <div style="border-top:1px solid var(--c-border);padding-top:var(--sp-md);margin-top:var(--sp-sm)">
      <p class="text-sm text-dim">🎁 分享給朋友可獲得專屬折扣碼</p>
      <button onclick="shareToUnlock()" style="display:inline-flex;align-items:center;gap:6px;margin-top:8px;padding:10px 20px;border-radius:10px;background:linear-gradient(135deg,rgba(255,255,255,.1),rgba(255,255,255,.05));color:var(--c-text-dim);font-size:.82rem;font-weight:600;border:1px solid rgba(255,255,255,.12);box-shadow:0 2px 8px rgba(0,0,0,.15),inset 0 1px 0 rgba(255,255,255,.06);cursor:pointer;transition:all .2s;font-family:inherit"><i class="fas fa-paper-plane"></i> 分享並取得折扣碼</button>
    </div>
  </div>
  <div class="discount-reveal hidden mt-lg" id="discount-reveal">
    <h4 style="color:var(--c-gold);margin-bottom:var(--sp-sm)">🍁 感謝分享！你的專屬折扣碼：</h4>
    <div class="discount-code" id="discount-code">JY2025VIP</div>
    <p class="text-sm text-dim mt-sm" id="discount-timer">在蝦皮賣場結帳時輸入此碼可享額外折扣</p>
    <div id="discount-crystal-rec" class="mt-md"></div>
  </div>

  <!-- ═══ 趣味功能區 ═══ -->
  <div class="mt-lg" id="extra-features-gate" style="text-align:center;padding:var(--sp-md) 0">
    <!-- 鎖定狀態 -->
    <div id="extra-locked" class="card" style="border-style:dashed;border-color:rgba(255,255,255,0.1);padding:var(--sp-lg);text-align:center">
      <p style="font-size:1.5rem;margin-bottom:var(--sp-sm)">🔒</p>
      <p class="text-gold serif" style="font-size:1rem;margin-bottom:var(--sp-xs)">分享解鎖更多功能</p>
      <p class="text-dim text-sm" style="margin-bottom:var(--sp-md)">分享給朋友後，即可開啟每日運勢籤、水晶配對、五行問答等趣味功能</p>
      <button class="btn btn-outline btn-sm" onclick="shareToUnlock()"><i class="fas fa-paper-plane"></i> 分享並解鎖</button>
    </div>
    <!-- 解鎖後的趣味功能（初始隱藏） -->
    <div id="extra-unlocked" style="display:none">
      <div class="daily-mini" style="margin:0 0 var(--sp-sm) 0">
        <div class="daily-mini-toggle" onclick="this.parentElement.classList.toggle('open');if(!this._init){initExtraFeatures();this._init=true}">
          <span><i class="fas fa-magic"></i> 🎮 趣味功能：運勢籤 · 水晶配對 · 五行問答...</span>
          <i class="fas fa-chevron-down daily-mini-arrow"></i>
        </div>
        <div class="daily-mini-body">
          <div style="padding:var(--sp-sm) var(--sp-md)">
            <div class="extra-nav">
              <button class="nav-extra-tab active" data-target="sec-daily-fortune">🏮 每日運勢</button>
              <button class="nav-extra-tab" data-target="sec-crystal-quiz">🧪 水晶配對</button>
              <button class="nav-extra-tab" data-target="sec-wuxing-game">🀄 五行問答</button>
              <button class="nav-extra-tab" data-target="sec-zodiac">👑 生肖配對</button>
              <button class="nav-extra-tab" data-target="sec-lucky">🍀 今日幸運</button>
              <button class="nav-extra-tab" data-target="sec-encyclopedia">📖 水晶百科</button>
              <button class="nav-extra-tab" data-target="sec-achievements">🏆 成就徽章</button>
              <button class="nav-extra-tab" data-target="sec-calendar30">📅 能量行事曆</button>
              <button class="nav-extra-tab" data-target="sec-aura-filter">🔮 靈氣濾鏡</button>
              <button class="nav-extra-tab" data-target="sec-reviews">💬 使用者好評</button>
            </div>

            <!-- 每日運勢籤 -->
            <div class="extra-section" id="sec-daily-fortune">
              <div class="daily-mini" id="daily-mini-wrap">
                <div class="daily-mini-toggle" onclick="this.parentElement.classList.toggle('open')">
                  <span><i class="fas fa-sun"></i> 每日運勢籤 — 免費抽一次</span>
                  <i class="fas fa-chevron-down daily-mini-arrow"></i>
                </div>
                <div class="daily-mini-body">
                  <div style="padding:var(--sp-md)">
                    <div id="daily-fortune-content"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 水晶配對測驗 -->
            <div class="extra-section hidden" id="sec-crystal-quiz">
              <div class="card">
                <div class="card-title"><i class="fas fa-flask"></i> 找出你的命定水晶</div>
                <p class="text-sm text-dim mb-md">3 道直覺題，30 秒找到最適合你的水晶（每次題目不同！）</p>
                <div id="crystal-quiz-content">
                  <div class="text-center">
                    <button class="btn btn-gold" onclick="startCrystalQuiz()"><i class="fas fa-play"></i> 開始測驗</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- 五行問答遊戲 -->
            <div class="extra-section hidden" id="sec-wuxing-game">
              <div class="card">
                <div class="card-title"><i class="fas fa-gamepad"></i> 五行命理問答挑戰</div>
                <p class="text-sm text-dim mb-md">5 題隨機出題，測試你的命理知識！</p>
                <div id="wuxing-game-content">
                  <div class="text-center">
                    <button class="btn btn-gold" onclick="startWuxingGame()"><i class="fas fa-play"></i> 開始挑戰</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- 生肖配對 -->
            <div class="extra-section hidden" id="sec-zodiac">
              <div class="card">
                <div class="card-title"><i class="fas fa-heart"></i> 生肖配對測試</div>
                <div id="zodiac-match-content"></div>
              </div>
            </div>

            <!-- 今日幸運 -->
            <div class="extra-section hidden" id="sec-lucky">
              <div class="card">
                <div class="card-title"><i class="fas fa-clover"></i> 今日幸運指南</div>
                <div id="lucky-gen-content"></div>
              </div>
            </div>

            <!-- 水晶百科 -->
            <div class="extra-section hidden" id="sec-encyclopedia">
              <div class="card">
                <div class="card-title"><i class="fas fa-book"></i> 水晶百科圖鑑</div>
                <p class="text-sm text-dim mb-md">點擊任一水晶查看詳細功效與購買連結</p>
                <div class="ency-grid" id="crystal-encyclopedia-grid"></div>
              </div>
            </div>

            <!-- 成就徽章 -->
            <div class="extra-section hidden" id="sec-achievements">
              <div class="card">
                <div class="card-title"><i class="fas fa-trophy"></i> 我的成就 <span class="text-sm text-muted" id="achievement-progress">0/9 已解鎖</span></div>
                <div class="achievements-grid" id="achievements-grid"></div>
              </div>
            </div>

            <!-- 能量行事曆 -->
            <div class="extra-section hidden" id="sec-calendar30">
              <div class="card">
                <div class="card-title"><i class="fas fa-calendar-days"></i> 能量行事曆</div>
                <div id="cal30-box">
                  <p class="text-sm text-dim mb-md">依你的八字，計算未來 30 天每日天干地支吉凶</p>
                </div>
              </div>
            </div>

            <!-- 靈氣濾鏡 -->
            <div class="extra-section hidden" id="sec-aura-filter">
              <div class="card">
                <div class="card-title"><i class="fas fa-camera"></i> 靈氣濾鏡</div>
                <div id="aura-box">
                  <p class="text-sm text-dim mb-md">上傳你的照片，看看今天的能量場是什麼顏色</p>
                </div>
              </div>
            </div>

            <!-- 使用者好評 -->
            <div class="extra-section hidden" id="sec-reviews">
              <div class="card">
                <div class="card-title"><i class="fas fa-comments"></i> 使用者好評</div>
                <div id="reviews-carousel" style="max-height:300px;overflow-y:auto"></div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ 回饋區：評分 + 診斷包 ═══ -->
  <div id="feedback-section" class="card" style="margin:1rem;border:1px solid rgba(212,175,55,0.2);display:none">
    <div style="text-align:center;margin-bottom:0.8rem">
      <p style="font-size:0.95rem;color:var(--c-text,#e8e0d0);margin-bottom:0.5rem">這次的分析對你有幫助嗎？</p>
      <div style="display:flex;justify-content:center;gap:1.2rem">
        <button id="fb-good" onclick="submitFeedback('good')" style="font-size:1.8rem;background:none;border:2px solid rgba(255,255,255,0.1);border-radius:12px;padding:0.5rem 1.2rem;cursor:pointer;transition:all .2s">👍</button>
        <button id="fb-bad" onclick="submitFeedback('bad')" style="font-size:1.8rem;background:none;border:2px solid rgba(255,255,255,0.1);border-radius:12px;padding:0.5rem 1.2rem;cursor:pointer;transition:all .2s">👎</button>
      </div>
    </div>
    <!-- 不準原因（點👎後才顯示）-->
    <div id="fb-reason-box" style="display:none;margin-top:0.8rem;padding-top:0.8rem;border-top:1px solid rgba(255,255,255,0.08)">
      <p style="font-size:0.85rem;color:var(--c-text-dim,#a09880);margin-bottom:0.5rem">哪裡不準？（可多選）</p>
      <div style="display:flex;flex-wrap:wrap;gap:0.4rem" id="fb-reasons">
        <label style="font-size:0.8rem;background:rgba(255,255,255,0.06);padding:0.3rem 0.6rem;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:4px">
          <input type="checkbox" value="太籠統" style="width:14px;height:14px"> 建議太籠統
        </label>
        <label style="font-size:0.8rem;background:rgba(255,255,255,0.06);padding:0.3rem 0.6rem;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:4px">
          <input type="checkbox" value="答非所問" style="width:14px;height:14px"> 答非所問
        </label>
        <label style="font-size:0.8rem;background:rgba(255,255,255,0.06);padding:0.3rem 0.6rem;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:4px">
          <input type="checkbox" value="方向錯" style="width:14px;height:14px"> 判斷方向錯
        </label>
        <label style="font-size:0.8rem;background:rgba(255,255,255,0.06);padding:0.3rem 0.6rem;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:4px">
          <input type="checkbox" value="水晶不對" style="width:14px;height:14px"> 水晶建議不對
        </label>
      </div>
      <textarea id="fb-comment" placeholder="其他想說的...（選填）" style="width:100%;margin-top:0.5rem;padding:0.4rem;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:var(--c-text,#e8e0d0);font-size:0.8rem;resize:vertical;min-height:40px"></textarea>
      <button onclick="submitFeedbackDetail()" style="margin-top:0.5rem;width:100%;padding:0.5rem;background:var(--c-gold,#d4af37);color:#1a1a2e;border:none;border-radius:8px;font-weight:600;font-size:0.85rem;cursor:pointer">送出回饋</button>
    </div>
    <!-- 送出後的感謝 -->
    <div id="fb-thanks" style="display:none;text-align:center;padding:0.5rem">
      <p style="color:var(--c-gold,#d4af37);font-size:0.9rem">✨ 謝謝你的回饋！</p>
    </div>
    <!-- 診斷包複製（隱藏，連點感謝文字3次才顯示）-->
    <div id="fb-diag-wrap" style="display:none;margin-top:0.6rem;text-align:center;border-top:1px solid rgba(255,255,255,0.06);padding-top:0.6rem">
      <button onclick="copyDiagnosticPack()" style="font-size:0.75rem;color:var(--c-text-dim,#a09880);background:none;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:0.3rem 0.8rem;cursor:pointer">
        📋 複製診斷包
      </button>
    </div>
  </div>

  <div style="height:80px"></div>
</section>

</div><!-- /app -->

<!-- 客製服務提示 Modal -->
<div class="modal-overlay" id="custom-modal" style="display:none">
  <div class="modal-box" style="text-align:center">
    <button class="modal-close" onclick="closeCustomModal()">&times;</button>
    <div style="font-size:2.5rem;margin-bottom:var(--sp-md)">✨</div>
    <h3 class="serif text-gold mb-md">能量手鏈客製服務</h3>
    <p style="font-size:.95rem;line-height:1.8;margin-bottom:var(--sp-md)">客製手鏈需要依據您的命盤詳細溝通，<br>請直接到<strong style="color:var(--c-gold)">蝦皮聊聊</strong>與我聯繫！</p>
    <p class="text-sm text-dim" style="margin-bottom:var(--sp-lg)">我會根據您的八字五行、喜用神，<br>為您量身搭配最適合的水晶組合。</p>
    <div style="display:flex;flex-direction:column;gap:10px;align-items:center">
      <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener" style="display:flex;align-items:center;justify-content:center;gap:8px;width:240px;padding:14px 20px;border-radius:12px;background:linear-gradient(135deg,rgba(212,175,55,.2),rgba(212,175,55,.1));color:var(--c-gold);text-decoration:none;font-size:.92rem;font-weight:700;border:1.5px solid rgba(212,175,55,.5);box-shadow:0 4px 14px rgba(212,175,55,.1)"><i class="fas fa-shopping-cart"></i> 前往蝦皮聊聊</a>
      <button class="btn btn-outline" onclick="closeCustomModal()" style="width:240px">稍後再說</button>
    </div>
  </div>
</div>

<!-- 水晶詳情 Modal -->
<div class="crystal-detail-modal hidden" id="crystal-detail-modal"></div>

<!-- PWA 安裝提示 -->
<div class="pwa-banner hidden" id="pwa-banner">
  <div class="pwa-banner-text">
    <strong>☽ 加到主畫面</strong>，隨時測運勢更方便！
  </div>
  <button class="pwa-install-btn" onclick="installPWA()">安裝</button>
  <button class="pwa-close-btn" onclick="hidePWABanner()">&times;</button>
</div>

<!-- 浮動按鈕 -->
<div class="floating-root" id="floating-root">
  <button class="fab fab-toggle" onclick="toggleFab()" aria-label="選單"><i class="fas fa-ellipsis-v"></i></button>
  <div class="fab-menu hidden" id="fab-menu">
    <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer" class="fab fab-shopee" title="蝦皮逛逛"><i class="fas fa-shopping-cart"></i><span>蝦皮</span></a>
    <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer" class="fab fab-711" title="賣貨便"><i class="fas fa-box"></i><span>7-11</span></a>
    <button class="fab fab-custom" onclick="openCustomModal()" title="客製"><i class="fas fa-magic"></i><span>客製</span></button>
  </div>
</div>
<script>
/* =============================================================
   GLOBAL STATE
   ============================================================= */

// ===== Plain Language Mode (C default) =====
function escHtml(s){
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

const PLAIN_DEFAULT = true; // C 預設白話文
let PLAIN_MODE = (localStorage.getItem('plainMode') ?? (PLAIN_DEFAULT ? '1' : '0')) === '1';

function setPlainMode(v){
  PLAIN_MODE = !!v;
  localStorage.setItem('plainMode', PLAIN_MODE ? '1' : '0');
  document.body.classList.toggle('plain', PLAIN_MODE);
  // If you have a central re-render, call it; otherwise the next user action will refresh.
  if (typeof window.__rerenderAll === 'function') window.__rerenderAll();
}

function applyPlainModeOnBoot(){
  document.body.classList.toggle('plain', PLAIN_MODE);
}

function plainReplace(s){
  if(!s) return s;
  const map = [
    ['十神','角色(十神)'],
    ['格局','整體走向(格局)'],
    ['用神','有利點(用神)'],
    ['喜用神','有利點(喜用神)'],
    ['忌神','容易卡的點(忌神)'],
    ['大運','十年節奏(大運)'],
    ['流年','年度節奏(流年)'],
    ['命宮','你本人的核心(命宮)'],
    ['身宮','你的行事慣性(身宮)'],
    ['財帛','錢與資源(財帛)'],
    ['官祿','工作與職涯(官祿)'],
    ['夫妻','感情/婚姻(夫妻)'],
    ['子女','孩子/作品(子女)'],
    ['遷移','外出/變動(遷移)'],
    ['疾厄','健康/壓力(疾厄)'],
    ['福德','心態/享受(福德)'],
    ['田宅','家/資產(田宅)'],
    ['交友','人脈/合作(交友)'],
    ['化祿','加分(化祿)'],
    ['化權','推進(化權)'],
    ['化科','名聲/學習(化科)'],
    ['化忌','壓力/課題(化忌)'],
  ];
  let out = String(s);
  for(const [a,b] of map) out = out.split(a).join(b);
  return out;
}

function makePlainBulletsFromHtml(proHtml, title){
  const tmp = document.createElement('div');
  tmp.innerHTML = proHtml;
  let lines = (tmp.innerText || '').split(/\n+/).map(x=>x.trim()).filter(Boolean);

  // Heuristic: keep the earliest, most summary-like lines
  lines = lines.filter(x => x.length <= 120);
  const keep = [];
  for(const ln of lines){
    if(keep.length >= 10) break;
    // drop pure separators / labels
    if(/^(—+|=+)$/.test(ln)) continue;
    keep.push(plainReplace(ln));
  }
  if(!keep.length){
    keep.push('已完成推演，但文字內容不足以生成白話摘要。');
  }
  const li = keep.map(x=>`<li>${escHtml(x)}</li>`).join('');
  return `
    <div class="plain-card plain-only">
      <div class="plain-title">${escHtml(title || '白話重點')}<span class="plain-badge">預設</span></div>
      <div style="opacity:.85">把專業術語改成一般人能理解的說法，只保留重點。</div>
      <ul>${li}</ul>
    </div>
  `;
}

function wrapPlain(proHtml, title){
  // proHtml: original detailed html
  // title: module title for plain digest
  const plainHtml = makePlainBulletsFromHtml(proHtml, title);
  if(!PLAIN_MODE){
    return proHtml;
  }
  return `${plainHtml}<details class="pro-details pro-only"><summary>查看原始細節（專業版）</summary>${proHtml}</details>`;
}

const S = { step:0, form:{}, bazi:null, meihua:null, tarot:{drawn:[],spread:[]}, ziwei:null };

/* =============================================================
   NAVIGATION
   ============================================================= */
/* Collapsible toggle */
function toggleCollapse(el){
  const card=el.closest('.collapsible-card');
  if(card) card.classList.toggle('open');
}

/* ═══ REMEDY: 五行能量分析 + 優化建議 ═══ */
function renderRemedy(bazi,type){
  const ep=bazi.ep||{}, dm=bazi.dm, el=bazi.dmEl, strong=bazi.strong;
  const fav=bazi.fav||[], unfav=bazi.unfav||[];
  const tot=Object.values(ep).reduce((a,b)=>a+b,0)||60;

  // ── 五行狀態診斷 ──
  const EL_NAMES={金:'金',木:'木',水:'水',火:'火',土:'土'};
  const EL_COLORS={金:'#c0c0c0',木:'#4caf50',水:'#42a5f5',火:'#ff5722',土:'#ff9800'};
  const states=bazi.wxStates||{};

  let diagHTML='';
  ['木','火','土','金','水'].forEach(e=>{
    const v=ep[e]||0;
    const pct=Math.round(v/tot*100);
    const ideal=20; // 平衡=20%
    const diff=pct-ideal;
    let tag,tagClass;
    if(pct<=5){tag='嚴重不足';tagClass='diag-tag-critical';}
    else if(pct<=10){tag='不足';tagClass='diag-tag-critical';}
    else if(pct<=14){tag='偏弱';tagClass='diag-tag-lack';}
    else if(pct<=26){tag='正常';tagClass='diag-tag-ok';}
    else if(pct<=35){tag='偏旺';tagClass='diag-tag-excess';}
    else{tag='偏強';tagClass='diag-tag-excess';}

    const state=states[e]||'';
    diagHTML+=`<div class="diag-row">
      <span class="diag-label" style="color:${EL_COLORS[e]}">${e} ${state}</span>
      <div class="diag-bar-wrap"><div class="diag-bar" style="width:${Math.min(pct*2,100)}%;background:${EL_COLORS[e]}"></div></div>
      <span class="diag-value" style="color:${EL_COLORS[e]}">${Math.round(v)}分</span>
      <span class="diag-tag ${tagClass}">${tag}</span>
    </div>`;
  });

  // ── 能量分析標題 ──
  const weakEls=Object.entries(ep).filter(([e,v])=>(v/tot)<0.12).map(([e])=>e);
  const strongEls=Object.entries(ep).filter(([e,v])=>(v/tot)>0.33).map(([e])=>e);
  const alertEl=document.getElementById('remedy-alert');

  let icon='🔮', title='', subtitle='';
  if(weakEls.length>=2){
    icon='⚠️';title=`檢測結果：你的能量磁場嚴重「缺${weakEls.join('、')}」！`;
    subtitle=`這導致你最近做事提不起勁、容易遇阻。你需要補充「${weakEls.map(e=>e+'行').join('＋')}」能量來平衡。`;
    alertEl.classList.add('alert-danger');
  }else if(weakEls.length===1){
    const weakDesc={金:'決斷力不足、容易猶豫、呼吸系統弱',木:'缺乏衝勁、肝火鬱結、做事拖延',水:'智慧受阻、腎氣不足、容易招小人',火:'做事提不起勁、心氣不足、貴人運弱',土:'根基不穩、腸胃虛弱、存不住錢'};
    icon='⚠️';title=`檢測結果：你的能量磁場嚴重「缺${weakEls[0]}」！`;
    subtitle=`這導致你${weakDesc[weakEls[0]]||'最近運勢受阻'}。你需要補充「${weakEls[0]+'行'}」能量來平衡。`;
    alertEl.classList.add('alert-danger');
  }else if(strongEls.length){
    icon='💡';title=`你的${strongEls.join('、')}行能量充沛`;
    subtitle='適度引導分散，讓整體能量更均衡';
    alertEl.classList.remove('alert-danger');
  }else{
    icon='✨';title='你的五行能量分佈均衡';
    subtitle='體質很好，小幅優化就能更上一層樓';
    alertEl.classList.remove('alert-danger');
  }

  document.getElementById('remedy-icon')&&(document.getElementById('remedy-icon').textContent=icon);
  document.getElementById('remedy-title')&&(document.getElementById('remedy-title').textContent=title);
  if(document.getElementById('remedy-title'))document.getElementById('remedy-title').style.color=weakEls.length>0?'#f87171':'var(--c-gold)';
  document.getElementById('remedy-subtitle')&&(document.getElementById('remedy-subtitle').textContent=subtitle);
  if(document.getElementById('remedy-subtitle'))document.getElementById('remedy-subtitle').style.color=weakEls.length>0?'#fca5a5':'var(--c-text-dim)';
  document.getElementById('remedy-diagnosis').innerHTML=diagHTML;

  // ── 改運處方 ──
  const actions=[];
  const TYPE_LABELS={love:'感情',career:'事業',wealth:'財運',health:'健康',general:'整體運勢',relationship:'人際',family:'家庭'};
  const typeLabel=TYPE_LABELS[type]||'運勢';

  // 處方1: 五行補強（依喜用神，含命理解釋）
  const mainFav=fav[0]||'土';
  const mainUnfav=unfav[0]||'';
  const dmEl=bazi.dmEl;
  const isStrong=bazi.strong;
  
  /* 生成命理原因說明（優先調候，次用通用） */
  function explainWhy(dm, fav1, unfav1, strong){
    /* 如果有調候結果，優先使用 */
    if(bazi.tiaohou){
      const th=bazi.tiaohou;
      return `<strong>【${th.reason}】</strong>${th.detail}<br><br>${th.needReason}`;
    }
    /* 通用解釋 */
    if(strong){
      return `你是「${dm}」日主，身強，自身能量充沛。需要 <strong>${fav1}行</strong> 來洩掉多餘的力量，讓能量流動起來，才不會鬱積。`;
    }else{
      const keEl = BE_KE[dm];
      const shengEl = BE_SHENG[dm];
      if(fav1 === shengEl){
        return `你是「${dm}」日主，身弱，命盤中「${keEl}行」（壓力/管束）偏旺。需要 <strong>${fav1}行</strong> 作為救星 —— ${fav1}能洩掉${keEl}的銳氣，再轉而生${dm}（${keEl}→${fav1}→${dm}，這叫「殺印相生」）。`;
      }else{
        return `你是「${dm}」日主，身弱，需要 <strong>${fav1}行</strong> 來幫扶自身力量，讓你站穩腳步。`;
      }
    }
  }
  
  const favCrystals={
    金:{stone:'白水晶 / 鈦晶',color:'白色、金色、銀色',dir:'正西方',food:'白色食物（白蘿蔔、豆腐、百合）'},
    木:{stone:'綠幽靈 / 東陵玉',color:'綠色、青色',dir:'正東方',food:'綠色蔬果（花椰菜、奇異果、菠菜）'},
    水:{stone:'黑曜石 / 海藍寶 / 黑髮晶',color:'藍色、黑色',dir:'正北方',food:'黑色食物（黑芝麻、海帶、藍莓）'},
    火:{stone:'紅瑪瑙 / 石榴石',color:'紅色、紫色',dir:'正南方',food:'紅色食物（紅棗、枸杞、番茄）'},
    土:{stone:'黃水晶 / 虎眼石',color:'黃色、棕色',dir:'中央/東北',food:'黃色食物（南瓜、玉米、薑黃）'}
  };
  const fc=favCrystals[mainFav]||favCrystals['土'];
  const whyText=explainWhy(dmEl, mainFav, mainUnfav, isStrong);
  
  actions.push({
    title:`你的命格需要「${mainFav}行」能量`,
    desc:`${whyText}<br><br>日常多穿 <strong>${fc.color}</strong> 系服飾，居家或辦公 <strong>${fc.dir}</strong> 方位擺放水晶，飲食多攝取${fc.food}。`,
    crystal:`💎 推薦：${fc.stone}`
  });

  // 處方2: 針對問題類型（動態過濾忌神）
  const avoidSet=new Set(unfav);
  function safeStone(stones, el){
    /* 如果推薦的水晶五行是忌神，改推喜用神水晶 */
    if(avoidSet.has(el)) return `<strong>${fc.stone.split('/')[0].trim()}</strong>（${mainFav}行）`;
    return `<strong>${stones}</strong>`;
  }
  const typeRemedy={
    love:{title:'增強桃花 / 感情磁場',desc:`建議佩戴${safeStone('粉晶','火')}於左手增強異性緣，臥室西南方（坤位）可擺放水晶球，週五（金星日）是約會好日子。`},
    career:{title:'提升事業貴人運',desc:`辦公桌左上角放${safeStone('綠幽靈','木')}招貴人，重要會議佩戴${avoidSet.has('金')?`${mainFav}行系`:'金色系'}飾品增強氣場。`},
    wealth:{title:'開啟正偏財運通道',desc:`錢包內放小片${safeStone('黃水晶','土')}碎石招偏財，每月農曆初二、十六「做牙」，家中財位（大門斜對角）保持明亮。`},
    health:{title:'五行養生調理方案',desc:`根據你的命盤，${mainFav}行不足可能影響相關臟腑。建議從飲食（${fc.food}）、作息（${mainFav==='水'?'早睡養腎':mainFav==='木'?'舒肝勿怒':mainFav==='火'?'午休養心':mainFav==='金'?'深呼吸養肺':'飲食規律養脾'}）著手。`},
    general:{title:'全方位運勢提升',desc:`今年最重要的是穩住${mainFav}行能量。選一條符合喜用神的水晶手鏈隨身佩戴，等於時刻在補運。`},
    relationship:{title:'改善人際磁場',desc:`佩戴${safeStone('粉晶','火')}增加親和力，${safeStone('海藍寶','水')}幫助溝通表達。`},
    family:{title:'穩固家庭和諧能量',desc:`家中客廳放${avoidSet.has('火')?`${mainFav}行水晶`:'<strong>紫水晶洞</strong>'}淨化磁場，臥室避免放太多電子產品。`}
  };
  const tr=typeRemedy[type]||typeRemedy.general;
  actions.push({title:tr.title,desc:tr.desc,crystal:null});

  // 處方2.5: 忌神警告 — 告訴用戶不要碰什麼
  if(unfav.length){
    const avoidCrystals={
      金:'白水晶、鈦晶、金髮晶、純銀飾品',
      木:'綠幽靈、翡翠、橄欖石',
      水:'海藍寶、月光石、藍紋瑪瑙',
      火:'紅瑪瑙、石榴石、紫水晶',
      土:'黃水晶、虎眼石（黃）、茶晶'
    };
    const avoidColors={金:'白色/金色/銀色',木:'綠色',水:'黑色/藍色',火:'紅色/紫色',土:'黃色/棕色'};
    let avoidList=unfav.map(u=>`<strong>${u}行</strong>（${avoidColors[u]||''}）`).join('、');
    let avoidStones=unfav.map(u=>avoidCrystals[u]||'').filter(Boolean).join('、');
    
    /* 如果有調候，使用調候的避開原因 */
    let avoidExplain='';
    if(bazi.tiaohou && bazi.tiaohou.avoidReason){
      avoidExplain=bazi.tiaohou.avoidReason;
    }else{
      avoidExplain='配戴這些五行的水晶<strong>反而會讓運勢卡住</strong>。';
    }
    
    actions.push({
      title:'⛔ 避開這些（忌神提醒）',
      desc:`${avoidExplain}<br><br>你的命盤中 ${avoidList} 需要避開。<br>具體避開：${avoidStones}。<br>如果之前有在戴這些，建議先暫時取下觀察看看。`,
      crystal:null
    });
  }

  // 處方3: 大運建議
  const curDy=bazi.dayun?bazi.dayun.find(d=>d.isCurrent):null;
  if(curDy){
    const dyFav=(curDy.level.includes('旺盛')||curDy.level.includes('極強')||curDy.level.includes('上升'));
    actions.push({
      title:dyFav?'把握當前大運能量':'穩定大運低谷期',
      desc:dyFav
        ?`你目前走「${curDy.gz}」大運（${curDy.level}），這段時期能量充足，是${typeLabel}的好時機。<strong>配合水晶能量，效果加乘</strong>。`
        :`當前大運「${curDy.gz}」（${curDy.level}），能量壓力較大。<strong>更需要水晶能量護身</strong>，幫你穩住磁場、化解阻力。`
    });
  }

  // 渲染
  let actHTML='';
  actions.forEach((a,i)=>{
    actHTML+=`<div class="action-item">
      <div class="action-num">${i+1}</div>
      <div class="action-content">
        <div class="action-title">${a.title}</div>
        <div class="action-desc">${a.desc}</div>
        ${a.crystal?`<div class="action-crystal" onclick="document.getElementById('r-crystal').scrollIntoView({behavior:'smooth'})">${a.crystal} <i class="fas fa-arrow-right" style="font-size:.7rem"></i></div>`:''}
      </div>
    </div>`;
  });
  document.getElementById('remedy-actions').innerHTML=actHTML;
}

/* Lazy init for extra features (only when user opens the panel) */
// initExtraFeatures 定義在下方 DOMContentLoaded 中
function goStep(n){
  if(n===3 && !S.bazi){alert('請先填寫基本資料');return}
  
  // ── 步驟轉場動畫 ──
  const needsTransition=(S.step===1&&n===2)||(S.step===2&&n===3);
  
  function doSwitch(){
    document.querySelectorAll('.step').forEach((s,i)=>s.classList.toggle('active',i===n));
    document.querySelectorAll('.nav-link').forEach((l,i)=>l.classList.toggle('active',i===n));
    document.querySelectorAll('.stepper-item').forEach((s,i)=>{s.classList.remove('active','done');if(i<n)s.classList.add('done');if(i===n)s.classList.add('active')});
    S.step=n; window.scrollTo({top:0,behavior:'smooth'});
    if(n===2){
      if(drawnCards.length>=10) showTarotLocked(); // 已有快取牌，顯示鎖定
      else if(!deckShuffled.length) initTarotDeck(); // 首次初始化牌堆
    }
    if(n===3){
      runAnalysis();
      setTimeout(()=>{
        const cta=document.getElementById('sticky-cta');
        if(cta){
          if(S.bazi&&S.bazi.fav){
            const fav=S.bazi.fav[0]||'土';
            const th=S.bazi.tiaohou;
            const label=document.getElementById('sticky-cta-label');
            const desc=document.getElementById('sticky-cta-desc');
            label.innerHTML=`💎 依你命盤精選：${fav}行水晶`;
            desc.textContent=th?`${th.reason} — ${fav}行＋${th.need.join('')}行補運`:`喜用神${fav}行 — 佩戴對應水晶隨身補運`;
          }
          cta.classList.add('visible');
        }
      }, 3000);
      setTimeout(()=>{ showFeedbackSection(); }, 4000);
    }else{
      const cta=document.getElementById('sticky-cta');
      if(cta) cta.classList.remove('visible');
    }
  }
  
  if(needsTransition){
    // ═══ 五角星陣轉場（與自動模式同款）═══
    const isFinalStep=(n===3);
    const overlay=document.createElement('div');
    overlay.className='loading-overlay';
    overlay.id='loading-overlay-manual';
    const dims=[
      {id:'mld-bazi',  sym:'☰', label:'八字',   angle:-90},
      {id:'mld-ziwei', sym:'☆', label:'紫微',   angle:-90+60},
      {id:'mld-meihua',sym:'☯', label:'梅花',   angle:-90+120},
      {id:'mld-tarot', sym:'✦', label:'塔羅',   angle:-90+180},
      {id:'mld-natal', sym:'♈', label:'星盤',   angle:-90+240},
      {id:'mld-name',  sym:'文', label:'融合',   angle:-90+300}
    ];
    const R=85;
    const nodeHTML=dims.map(d=>{
      const rad=d.angle*Math.PI/180;
      const x=110+R*Math.cos(rad)-22, y=110+R*Math.sin(rad)-22;
      return `<div class="ld-node" id="${d.id}" style="left:${x}px;top:${y}px"><span class="ld-sym">${d.sym}</span><div class="ld-node-label">${d.label}</div></div>`;
    }).join('');
    const pts=dims.map(d=>{const rad=d.angle*Math.PI/180;return[110+R*Math.cos(rad),110+R*Math.sin(rad)];});
    const lineHTML=[];
    for(let i=0;i<6;i++) for(let j=i+1;j<6;j++){
      lineHTML.push(`<line class="ld-line" id="mld-ln-${i}-${j}" x1="${pts[i][0]}" y1="${pts[i][1]}" x2="${pts[j][0]}" y2="${pts[j][1]}"/>`);
    }
    let particleHTML='';
    for(let k=0;k<20;k++){
      const x=Math.random()*100, dur=2.5+Math.random()*3, delay=Math.random()*3;
      particleHTML+=`<div class="ld-particle" style="left:${x}%;bottom:-5%;--dur:${dur}s;--delay:${delay}s"></div>`;
    }
    
    // 梅花→塔羅：只跑前3維 + 準備塔羅；塔羅→結果：跑全部6維
    const activeDims=isFinalStep?[0,1,2,3,4,5]:[0,1,2]; // 八字/紫微/梅花 已完成，或全部
    const statusTexts=isFinalStep
      ?['校驗八字命盤…','校驗紫微斗數…','鎖定梅花卦象…','鎖定塔羅牌陣…','計算星盤…','六維融合分析…']
      :['八字命盤已就緒','紫微斗數已就緒','梅花卦象已鎖定'];
    const subTexts=isFinalStep
      ?['天干地支 × 十神 × 神煞','命宮十二宮 × 四化飛星','本卦 → 變卦 × 體用關係','十張牌 × 凱爾特十字展開','行星 × 宮位 × 相位','八字 × 紫微 × 梅花 × 塔羅 × 星盤 × 姓名']
      :['四柱排盤完成','十二宮排盤完成','體用關係已確定'];
    const TOTAL_MS=isFinalStep?3200:1800;
    
    overlay.innerHTML=`
      <div class="ld-particles">${particleHTML}</div>
      <div class="ld-pentagram">
        <div class="ld-ring"></div><div class="ld-ring"></div><div class="ld-ring"></div>
        <svg class="ld-lines" viewBox="0 0 220 220">${lineHTML.join('')}</svg>
        ${nodeHTML}
        <div class="ld-center" id="mld-center">☽</div>
        <div class="ld-burst" id="mld-burst"></div>
      </div>
      <div class="ld-status" id="mld-status">${isFinalStep?'六維度融合分析中…':'準備塔羅牌陣…'}</div>
      <div class="ld-sub" id="mld-sub"></div>`;
    document.body.appendChild(overlay);
    
    const dimIds=dims.map(d=>d.id);
    const stagger=TOTAL_MS/(activeDims.length+1.5);
    
    activeDims.forEach((dimIdx,i)=>{
      setTimeout(()=>{
        const el=document.getElementById(dimIds[dimIdx]);
        if(el) el.classList.add('computing');
        const st=document.getElementById('mld-status');
        const sb=document.getElementById('mld-sub');
        if(st){st.style.opacity='0';setTimeout(()=>{st.textContent=statusTexts[i]||'';st.style.opacity='1';},150);}
        if(sb){sb.style.opacity='0';setTimeout(()=>{sb.textContent=subTexts[i]||'';sb.style.opacity='1';},150);}
      }, i*stagger);
      
      setTimeout(()=>{
        const el=document.getElementById(dimIds[dimIdx]);
        if(el){el.classList.remove('computing');el.classList.add('done');}
        for(let j=0;j<5;j++){
          if(j===dimIdx) continue;
          const a=Math.min(dimIdx,j),b=Math.max(dimIdx,j);
          const ln=document.getElementById('mld-ln-'+a+'-'+b);
          const otherNode=document.getElementById(dimIds[j]);
          if(ln&&otherNode&&otherNode.classList.contains('done')) ln.classList.add('lit');
        }
      }, i*stagger+stagger*0.65);
    });
    
    // 完成
    setTimeout(()=>{
      document.getElementById('mld-center').classList.add('active');
      const st=document.getElementById('mld-status');
      if(st){st.style.opacity='0';setTimeout(()=>{st.textContent=isFinalStep?'解讀完成':'塔羅牌陣就緒';st.style.opacity='1';},150);}
      document.querySelectorAll('#loading-overlay-manual .ld-line').forEach(l=>l.classList.add('lit'));
    }, TOTAL_MS-350);
    
    setTimeout(()=>{
      const burst=document.getElementById('mld-burst');
      if(burst){burst.classList.add('go');setTimeout(()=>burst.classList.add('fade'),350);}
    }, TOTAL_MS-100);
    
    setTimeout(()=>{
      overlay.style.transition='opacity .45s';
      overlay.style.opacity='0';
      setTimeout(()=>overlay.remove(),450);
      doSwitch();
    }, TOTAL_MS+200);
    
  } else {
    doSwitch();
  }
}
function resetAll(){S.bazi=null;S.meihua=null;S.tarot={drawn:[],spread:[]};S.ziwei=null;goStep(0);document.getElementById('mh-result').classList.add('hidden');document.getElementById('btn-analyze').disabled=true;document.getElementById('t-spread-sec').classList.add('hidden');drawnCards=[];deckShuffled=[];pickAnimating=false;/* 重置 hook screen */try{document.getElementById('hook-screen').style.display='block';document.getElementById('input-screen').style.display='none';}catch(e){}}
function skipToResult(){goStep(3)}

/* — Char counter — */
document.getElementById('f-question').addEventListener('input',function(){document.getElementById('f-char').textContent=this.value.length});
// 動態 placeholder：根據問題類型切換範例
const PLACEHOLDER_MAP={love:'例：我跟他還有機會復合嗎？/今年會遇到正緣嗎？',career:'例：我今年適合轉職嗎？/該選 A 公司還是 B 公司？',wealth:'例：最近適合投資嗎？/今年有偏財運嗎？',health:'例：我最近身體不太好，要注意什麼？',relationship:'例：跟同事相處不好，該怎麼改善？',family:'例：跟爸媽意見不合，怎麼溝通比較好？'};
document.getElementById('f-type').addEventListener('change',function(){const ph=PLACEHOLDER_MAP[this.value]||'例：我今年適合轉職嗎？';document.getElementById('f-question').placeholder=ph;});

/* =============================================================
   天干地支 CORE DATA
   ============================================================= */
const TG=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
const DZ=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
const WX_G={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
const WX_Z={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
const YY_G={甲:'陽',乙:'陰',丙:'陽',丁:'陰',戊:'陽',己:'陰',庚:'陽',辛:'陰',壬:'陽',癸:'陰'};
const SHENG={木:'火',火:'土',土:'金',金:'水',水:'木'};
const KE={木:'土',火:'金',土:'水',金:'木',水:'火'};
const BE_SHENG={木:'水',火:'木',土:'火',金:'土',水:'金'}; // 生我
const BE_KE={木:'金',火:'水',土:'木',金:'火',水:'土'};   // 克我
// ── 地支六沖 ──
const LIU_CHONG={子:'午',午:'子',丑:'未',未:'丑',寅:'申',申:'寅',卯:'酉',酉:'卯',辰:'戌',戌:'辰',巳:'亥',亥:'巳'};
// ── 地支六合 ──  
const LIU_HE={子:'丑',丑:'子',寅:'亥',亥:'寅',卯:'戌',戌:'卯',辰:'酉',酉:'辰',巳:'申',申:'巳',午:'未',未:'午'};
const LH_RESULT={子:'土',丑:'土',寅:'木',亥:'木',卯:'火',戌:'火',辰:'金',酉:'金',巳:'水',申:'水',午:'火',未:'火'};
// ── 地支三合局 ──
const SAN_HE=[
  {members:['申','子','辰'],el:'水'},
  {members:['亥','卯','未'],el:'木'},
  {members:['寅','午','戌'],el:'火'},
  {members:['巳','酉','丑'],el:'金'}
];
// ── 地支三會局 ──
const SAN_HUI=[
  {members:['寅','卯','辰'],el:'木'},
  {members:['巳','午','未'],el:'火'},
  {members:['申','酉','戌'],el:'金'},
  {members:['亥','子','丑'],el:'水'}
];
// ── 天干五合 ──
const TG_HE={甲:'己',己:'甲',乙:'庚',庚:'乙',丙:'辛',辛:'丙',丁:'壬',壬:'丁',戊:'癸',癸:'戊'};
const TG_HE_EL={甲:'土',己:'土',乙:'金',庚:'金',丙:'水',辛:'水',丁:'木',壬:'木',戊:'火',癸:'火'};
// ── 地支相刑 ──
const DZ_XING={寅:'巳',巳:'申',申:'寅',丑:'戌',戌:'未',未:'丑',子:'卯',卯:'子',辰:'辰',午:'午',酉:'酉',亥:'亥'};
// ── 地支相害 ──
const DZ_HAI={子:'未',未:'子',丑:'午',午:'丑',寅:'巳',巳:'寅',卯:'辰',辰:'卯',申:'亥',亥:'申',酉:'戌',戌:'酉'};

// ── 宮位十神事象對照表 ──
const GONG_EVENT={
  year:{label:'年柱',domain:'家庭·長輩·根基',area:['family']},
  month:{label:'月柱',domain:'事業·上司·環境',area:['career']},
  day:{label:'日柱',domain:'自身·婚姻·健康',area:['love','health']},
  hour:{label:'時柱',domain:'子女·下屬·晚運',area:['family','wealth']}
};
const GOD_EVENT={
  '正財':'穩定收入/務實投資/妻緣(男)', '偏財':'意外之財/投機/父緣',
  '正官':'升遷/考試/正派壓力', '七殺':'競爭/意外/小人/壓力',
  '正印':'貴人/學業/母緣/庇護', '偏印':'轉變/孤獨/偏門學術',
  '食神':'才華/口福/女兒(女)/享受', '傷官':'創意/叛逆/口舌/變革',
  '比肩':'合作/競爭/朋友助力', '劫財':'破財/爭端/兄弟糾紛'
};

/* 藏干 */
const CG={
  子:['癸'],丑:['己','癸','辛'],寅:['甲','丙','戊'],卯:['乙'],
  辰:['戊','乙','癸'],巳:['丙','庚','戊'],午:['丁','己'],未:['己','丁','乙'],
  申:['庚','壬','戊'],酉:['辛'],戌:['戊','辛','丁'],亥:['壬','甲']
};

/* 十神 */
function tenGod(dm,tgt){
  if(!WX_G[dm]||!WX_G[tgt])return'—';
  const d=WX_G[dm],t=WX_G[tgt],s=YY_G[dm]===YY_G[tgt];
  if(d===t)return s?'比肩':'劫財';
  if(SHENG[d]===t)return s?'食神':'傷官';
  if(KE[d]===t)return s?'偏財':'正財';
  if(KE[t]===d)return s?'七殺':'正官';
  if(SHENG[t]===d)return s?'偏印':'正印';
  return'—';
}

/* 十二長生 */
const CHANG_SHENG_ORDER=['長生','沐浴','冠帶','臨官','帝旺','衰','病','死','墓','絕','胎','養'];
const CS_START={甲:DZ.indexOf('亥'),丙:DZ.indexOf('寅'),戊:DZ.indexOf('寅'),庚:DZ.indexOf('巳'),壬:DZ.indexOf('申'),
                乙:DZ.indexOf('午'),丁:DZ.indexOf('酉'),己:DZ.indexOf('酉'),辛:DZ.indexOf('子'),癸:DZ.indexOf('卯')};
function changSheng(dm,zhi){
  const start=CS_START[dm]; if(start===undefined)return'—';
  const zhiIdx=DZ.indexOf(zhi); if(zhiIdx<0)return'—';
  const isYang=YY_G[dm]==='陽';
  let diff=isYang?(zhiIdx-start+12)%12:(start-zhiIdx+12)%12;
  return CHANG_SHENG_ORDER[diff];
}

/* 神煞 (簡化版 — 常用15個) */
function getShenSha(pillars){
  const ss=[];
  const yZ=pillars.year.zhi, dG=pillars.day.gan, dZ=pillars.day.zhi;
  // 天乙貴人
  const TIYI={甲:['丑','未'],戊:['丑','未'],庚:['丑','未'],丙:['亥','酉'],丁:['亥','酉'],
              乙:['子','申'],己:['子','申'],壬:['卯','巳'],癸:['卯','巳'],辛:['午','寅']};
  if(TIYI[dG]){[yZ,pillars.month.zhi,pillars.hour.zhi].forEach(z=>{if(TIYI[dG].includes(z))ss.push('天乙貴人')})}
  // 文昌
  const WC={甲:'巳',乙:'午',丙:'申',丁:'酉',戊:'申',己:'酉',庚:'亥',辛:'子',壬:'寅',癸:'卯'};
  if(WC[dG]){[yZ,pillars.month.zhi,pillars.hour.zhi].forEach(z=>{if(z===WC[dG])ss.push('文昌')})}
  // 驛馬 (三合局第一字取對沖：申子辰→寅, 寅午戌→申, 巳酉丑→亥, 亥卯未→巳)
  const YM={子:'寅',丑:'亥',寅:'申',卯:'巳',辰:'寅',巳:'亥',午:'申',未:'巳',申:'寅',酉:'亥',戌:'申',亥:'巳'};
  if(YM[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===YM[yZ])ss.push('驛馬')})}
  // 桃花
  const TH_MAP={子:'酉',丑:'午',寅:'卯',卯:'子',辰:'酉',巳:'午',午:'卯',未:'子',申:'酉',酉:'午',戌:'卯',亥:'子'};
  if(TH_MAP[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===TH_MAP[yZ])ss.push('桃花')})}
  // 華蓋
  const HG_MAP={子:'辰',丑:'丑',寅:'戌',卯:'未',辰:'辰',巳:'丑',午:'戌',未:'未',申:'辰',酉:'丑',戌:'戌',亥:'未'};
  if(HG_MAP[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===HG_MAP[yZ])ss.push('華蓋')})}
  return[...new Set(ss)];
}

/* =============================================================
   BAZI COMPUTATION (完整版)
   ============================================================= */
/* ═══ HOOK FLOW: 首屏四宮格互動 ═══ */
const Q_PRESETS = {
  love: ['今年有桃花嗎？','他/她喜歡我嗎？','適合復合嗎？','什麼時候能脫單？','我的感情會順利嗎？'],
  career: ['今年適合轉職嗎？','該不該跳槽？','我適合創業嗎？','工作會有升遷機會嗎？','怎麼找到適合的方向？'],
  wealth: ['今年財運如何？','適合投資嗎？','什麼時候財運會好轉？','偏財運好不好？','怎麼改善財務狀況？'],
  health: ['今年健康要注意什麼？','我的體質適合什麼養生？','壓力大怎麼調適？','家人健康會好嗎？','我需要做什麼健康檢查？'],
  relationship: ['人際關係會改善嗎？','適合跟對方合作嗎？','怎麼改善職場人際？','朋友靠得住嗎？','該怎麼拓展人脈？'],
  family: ['跟家人關係會好轉嗎？','親子溝通怎麼改善？','家庭運勢如何？','長輩健康要注意什麼？','家裡的問題會解決嗎？']
};
const TYPE_LABELS_SHORT = {love:'💕 感情桃花',career:'💼 事業方向',wealth:'💰 財運投資',health:'🏥 健康身心',relationship:'🤝 人際合作',family:'🏠 家庭親子'};
const TYPE_LABEL_TO_TYPE = (function(){const o={};for(const[k,v]of Object.entries(TYPE_LABELS_SHORT))o[v]=k;return o;})();
let selectedPresetQ = '';

function pickType(type){
  document.getElementById('f-type').value = type;
  document.getElementById('hook-screen').style.display = 'none';
  document.getElementById('input-screen').style.display = 'none';
  
  // ── 信任預覽：先給免費價值 ──
  const trustEl = document.getElementById('trust-preview');
  if(trustEl){
    trustEl.style.display = 'block';
    document.getElementById('trust-type-tag').textContent = TYPE_LABELS_SHORT[type] || type;
    
    // 2026丙午年共相 × 問題類型
    const yearInsight = {
      love:'2026 是丙午年，火氣旺盛，感情上容易「一見鍾情」也容易「一觸即發」。如果你最近覺得感情忽冷忽熱、容易吵架、或者遇到讓你心動但拿不準的人——這都是丙午火旺的典型表現。你不是運不好，是能量太躁需要導引。',
      career:'2026 丙午年，火土並旺。很多人會在今年感覺「做很多但看不到成果」、「想跳槽但又不敢」。如果你最近覺得工作壓力大、方向不明、或者有個機會但猶豫不決——這些都是今年的共同考題，不是只有你這樣。',
      wealth:'2026 丙午年，火旺剋金。今年財運的特徵是「進得快、出得也快」——容易有收入但也容易衝動消費或投資失利。如果你最近覺得錢怎麼存都存不住，或者有個投資想出手但不確定——這是年運造成的，不是你能力問題。',
      health:'2026 丙午年，火旺傷金水。今年很多人會出現呼吸系統、皮膚、睡眠方面的問題。如果你最近覺得容易累、睡不好、情緒起伏大——這跟流年火氣太旺有直接關係，需要有意識地補水、補金行能量。',
      relationship:'2026 丙午年，火旺帶煞。今年人際關係的考題是「分辨真心與場面」——火旺容易讓人際互動表面熱絡但缺乏深度。如果你最近覺得朋友多但知心少、或者跟某個人關係突然變僵——不用太擔心，這是流年氣場造成的。',
      family:'2026 丙午年，午火沖子水。今年家庭關係容易出現「表面和平、暗流湧動」的狀況。如果你最近跟家人溝通有障礙、或者為了某件事意見不合——這是年運帶來的考驗，處理得好反而能讓關係更進一步。'
    };
    document.getElementById('trust-text').innerHTML = `
      <p style="color:var(--c-gold);font-weight:600;margin-bottom:.5rem">🔮 今年大環境給你的訊號：</p>
      <p>${yearInsight[type]||yearInsight.career}</p>
      <p style="margin-top:.5rem;color:var(--c-text-dim);font-size:.9rem">以上是所有人的「共相」。但每個人的八字不同，受的影響也不同——有人是吉、有人是凶。<strong style="color:var(--c-gold)">只有結合你的出生時間，才能算出你的「個相」。</strong></p>
    `;
  } else {
    // fallback: 沒有trust-preview就直接進input
    showInputAfterTrust();
  }

  // 預渲染問題選擇
  const presets = Q_PRESETS[type] || [];
  const grid = document.getElementById('q-presets');
  selectedPresetQ = '';
  grid.innerHTML = presets.map(q => `<button class="q-preset-btn" onclick="selectPreset(this,'${q.replace(/'/g,"\\'")}')">${q}</button>`).join('') +
    `<button class="q-preset-btn" onclick="showCustomQ(this)" style="color:var(--c-text-muted)"><i class="fas fa-pen" style="margin-right:4px"></i> 我想自己寫問題</button>`;
  document.getElementById('q-custom-wrap').style.display = 'none';
  window.scrollTo({top:0,behavior:'smooth'});
}

function showInputAfterTrust(){
  var tp=document.getElementById('trust-preview');
  if(tp) tp.style.display='none';
  document.getElementById('input-screen').style.display = 'block';
  window.scrollTo({top:0,behavior:'smooth'});
}

function backToHook(){
  document.getElementById('input-screen').style.display = 'none';
  var tp=document.getElementById('trust-preview');
  if(tp) tp.style.display='none';
  document.getElementById('hook-screen').style.display = 'block';
  document.getElementById('f-type').value = '';
}

function selectPreset(btn, q){
  document.querySelectorAll('.q-preset-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedPresetQ = q;
  document.getElementById('f-question').value = q;
  document.getElementById('q-custom-wrap').style.display = 'none';
}

function showCustomQ(btn){
  document.querySelectorAll('.q-preset-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedPresetQ = '';
  document.getElementById('q-custom-wrap').style.display = 'block';
  document.getElementById('f-question').value = '';
  document.getElementById('f-question').focus();
}

function submitStep0(){
  let type = (document.getElementById('f-type') && document.getElementById('f-type').value) || '';
  if (!type) {
    var tagEl = document.getElementById('chosen-type-tag');
    if (tagEl && tagEl.textContent && TYPE_LABEL_TO_TYPE[tagEl.textContent.trim()]) {
      type = TYPE_LABEL_TO_TYPE[tagEl.textContent.trim()];
      if (document.getElementById('f-type')) document.getElementById('f-type').value = type;
    }
  }
  var question = (document.getElementById('f-question') && document.getElementById('f-question').value) ? document.getElementById('f-question').value.trim() : '';
  if (!question && typeof selectedPresetQ === 'string') question = selectedPresetQ.trim();
  const gender=document.querySelector('input[name="gender"]:checked');
  const bdate=document.getElementById('f-bdate') ? document.getElementById('f-bdate').value : '';
  if(!type||!question||!gender||!bdate){ alert('請填寫所有必要欄位（方向、問題、性別、出生日期）'); return; }
  const btime=(document.getElementById('f-btime')&&document.getElementById('f-btime').value)||'12:00';
  const name=document.getElementById('f-name')?document.getElementById('f-name').value.trim():'';
  S.form={type,question,gender:gender.value,bdate,btime,name};
  try {
    const[y,m,d]=bdate.split('-').map(Number);
    const[hh,mm]=btime.split(':').map(Number);
    S.bazi=computeBazi(y,m,d,hh,mm,gender.value);
    S.ziwei=computeZiwei(y,m,d,hh,gender.value);
    mergeZiweiIntoBazi(); // 紫微整合進八字大運流年
    try { S.natal = computeNatalChart(y, m, d, hh, mm); } catch(e) { console.error('Natal(manual):', e); S.natal=null; }
    if (typeof renderDailyFortune==='function') renderDailyFortune();
    if (typeof generateLuckyInfo==='function') generateLuckyInfo();
    goStep(1);
  } catch(e) {
    console.error('submitStep0', e);
    alert('資料處理時發生錯誤，請確認出生日期與時間格式正確。');
  }
}

/* ══ 占卜結果快取：同人+同類型 24 小時內鎖定梅花/塔羅結果 ══ */
const DIVINE_CACHE_KEY = 'jy_divine_cache';
// 改為以日期為單位：取今日結束時間（午夜）作為過期判斷
function isCacheSameDay(ts){
  const cached = new Date(ts);
  const now = new Date();
  return cached.getFullYear()===now.getFullYear() && cached.getMonth()===now.getMonth() && cached.getDate()===now.getDate();
}

/* ═══ Seeded PRNG (mulberry32) — 同人同天同問=同結果 ═══ */
function hashStr(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h>>>0;}
function mulberry32(seed){return function(){seed|=0;seed=seed+0x6D2B79F5|0;let t=Math.imul(seed^seed>>>15,1|seed);t=t+Math.imul(t^t>>>7,61|t)^t;return((t^t>>>14)>>>0)/4294967296;};}
function makeSeededRng(bdate,gender,type,question){
  const today=new Date();const dayKey=today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
  const qNorm=(question||'').replace(/[\s?？！!。，,.]/g,'').substring(0,20);
  const seed=hashStr(bdate+'|'+gender+'|'+type+'|'+qNorm+'|'+dayKey);
  return mulberry32(seed);
}
function seededShuffle(arr,rng){
  const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;
}

function getDivineCacheKey(bdate, gender, type, question) {
  // 同人+同類型+同問題文字 才鎖定
  const qNorm = (question||'').replace(/[\s?？！!。，,.]/g,'').substring(0,20);
  return bdate + '|' + gender + '|' + type + '|' + qNorm;
}

function loadDivineCache(bdate, gender, type, question) {
  try {
    const raw = localStorage.getItem(DIVINE_CACHE_KEY);
    if (!raw) { console.log('[Cache] 無快取資料'); return null; }
    const cache = JSON.parse(raw);
    const key = getDivineCacheKey(bdate, gender, type, question);
    const entry = cache[key];
    if (!entry) { console.log('[Cache] Key不符:',key,'現有keys:',Object.keys(cache).join(',')); return null; }
    if (!isCacheSameDay(entry.ts)) {
      console.log('[Cache] 非同日，清除（日期過期）');
      delete cache[key];
      localStorage.setItem(DIVINE_CACHE_KEY, JSON.stringify(cache));
      return null;
    }
    console.log('[Cache] ✅ 命中快取:',key);
    return entry;
  } catch(e) { console.error('[Cache] 讀取錯誤:',e); return null; }
}

function saveDivineCache(bdate, gender, type, meihua, tarotDrawn, question) {
  try {
    let cache = {};
    try { cache = JSON.parse(localStorage.getItem(DIVINE_CACHE_KEY)) || {}; } catch(e){}
    const key = getDivineCacheKey(bdate, gender, type, question);
    cache[key] = { ts: Date.now(), meihua, tarotDrawn };
    const now = Date.now();
    for (const k of Object.keys(cache)) {
      if (!isCacheSameDay(cache[k].ts)) delete cache[k];
    }
    localStorage.setItem(DIVINE_CACHE_KEY, JSON.stringify(cache));
    console.log('[Cache] ✅ 已儲存:',key);
  } catch(e) { console.error('[Cache] 儲存錯誤:',e); }
}

function submitStep0Fast(){
  drawnCards=[];
  S.meihua=null;S.tarot={drawn:[],spread:[]};
  const type=document.getElementById('f-type').value;
  const question=document.getElementById('f-question').value.trim();
  const gender=document.querySelector('input[name="gender"]:checked');
  const bdate=document.getElementById('f-bdate').value;
  if(!type||!question||!gender||!bdate){alert('請填寫：問題、性別、出生日期');return}
  const btime=document.getElementById('f-btime').value||'12:00';
  const name=document.getElementById('f-name').value.trim();
  S.form={type,question,gender:gender.value,bdate,btime,name};

  /* ═══ 六維度命理運算動畫 ═══ */
  const overlay = document.createElement('div');
  overlay.className = 'loading-overlay';
  overlay.id = 'loading-overlay';
  // 六維度節點位置（六芒星分佈）
  const dims = [
    {id:'ld-bazi',  sym:'☰', label:'八字',   angle:-90},
    {id:'ld-ziwei', sym:'☆', label:'紫微',   angle:-90+60},
    {id:'ld-meihua',sym:'☯', label:'梅花',   angle:-90+120},
    {id:'ld-tarot', sym:'✦', label:'塔羅',   angle:-90+180},
    {id:'ld-natal', sym:'♈', label:'星盤',   angle:-90+240},
    {id:'ld-name',  sym:'文', label:'融合',   angle:-90+300}
  ];
  const R=85; // 節點距中心距離
  const nodeHTML=dims.map(d=>{
    const rad=d.angle*Math.PI/180;
    const x=110+R*Math.cos(rad)-22, y=110+R*Math.sin(rad)-22;
    return `<div class="ld-node" id="${d.id}" style="left:${x}px;top:${y}px"><span class="ld-sym">${d.sym}</span><div class="ld-node-label">${d.label}</div></div>`;
  }).join('');
  // SVG 連線（六芒星）
  const pts=dims.map(d=>{const rad=d.angle*Math.PI/180;return[110+R*Math.cos(rad),110+R*Math.sin(rad)];});
  const lineHTML=[];
  for(let i=0;i<6;i++) for(let j=i+1;j<6;j++){
    lineHTML.push(`<line class="ld-line" id="ld-ln-${i}-${j}" x1="${pts[i][0]}" y1="${pts[i][1]}" x2="${pts[j][0]}" y2="${pts[j][1]}"/>`);
  }
  // 粒子
  let particleHTML='';
  for(let i=0;i<25;i++){
    const x=Math.random()*100, dur=3+Math.random()*4, delay=Math.random()*5;
    particleHTML+=`<div class="ld-particle" style="left:${x}%;bottom:-5%;--dur:${dur}s;--delay:${delay}s"></div>`;
  }
  overlay.innerHTML=`
    <div class="ld-particles">${particleHTML}</div>
    <div class="ld-pentagram">
      <div class="ld-ring"></div><div class="ld-ring"></div><div class="ld-ring"></div>
      <svg class="ld-lines" viewBox="0 0 220 220">${lineHTML.join('')}</svg>
      ${nodeHTML}
      <div class="ld-center" id="ld-center">☽</div>
      <div class="ld-burst" id="ld-burst"></div>
    </div>
    <div class="ld-status" id="ld-status">正在為你深度解讀命盤…</div>
    <div class="ld-sub" id="ld-sub"></div>`;
  document.body.appendChild(overlay);

  const [y,m,d]=bdate.split('-').map(Number);
  const [hh,mm]=btime.split(':').map(Number);

  const cached = loadDivineCache(bdate, gender.value, type, question);
  // 管理員帳號不受能量鎖定限制（可重複測試）
  const _isAdmin=(bdate==='1983-08-25'&&document.getElementById('f-name')&&document.getElementById('f-name').value.includes('弘林'));
  S._usedCache = _isAdmin ? false : !!cached;

  // 計算函數
  const fns = [
    ()=>{ S.bazi=computeBazi(y,m,d,hh,mm,gender.value); },
    ()=>{ S.ziwei=computeZiwei(y,m,d,hh,gender.value); mergeZiweiIntoBazi(); renderDailyFortune(); generateLuckyInfo(); },
    ()=>{
      if(cached && cached.meihua && !_isAdmin) { S.meihua = cached.meihua; }
      else {
        const _mhRng=makeSeededRng(bdate,gender.value,type,question);
        const mhUp=Math.floor(_mhRng()*8)+1;
        const mhLo=Math.floor(_mhRng()*8)+1;
        const mhDong=Math.floor(_mhRng()*6)+1;
        S.meihua=calcMH(mhUp,mhLo,mhDong);
      }
    },
    ()=>{
      if(cached && cached.tarotDrawn && cached.tarotDrawn.length >= 10 && !_isAdmin) {
        drawnCards = cached.tarotDrawn;
        S.tarot.drawn = cached.tarotDrawn;
        S.tarot.spread = cached.tarotDrawn;
      } else {
        const _rng=makeSeededRng(bdate,gender.value,type,question);
        deckShuffled=seededShuffle(TAROT,_rng);
        drawnCards=[];
        for(let i=0;i<10;i++){
          const card=deckShuffled[i];
          const isUp=_rng()>0.35;
          drawnCards.push({...card,isUp,pos:CELTIC_POS[i]});
        }
        S.tarot.drawn=drawnCards;
        S.tarot.spread=drawnCards;
      }
      // 存檔（合併到塔羅步驟）
      if(!cached) { saveDivineCache(bdate, gender.value, type, S.meihua, S.tarot.drawn, question); }
    },
    ()=>{
      // 西洋星盤計算
      try { S.natal = computeNatalChart(y, m, d, hh, mm); } catch(e) { 
        console.error('Natal chart error:', e); 
        S.natal = null;
        setTimeout(()=>{
          const el=document.getElementById('d-natal-summary');
          if(el) el.innerHTML='<p style="color:#f87171">星盤計算錯誤：'+e.message+'</p>';
        },500);
      }
    },
    ()=>{
      // 姓名學（此步驟用於觸發最終融合，實際渲染在 runAnalysisV2）
    }
  ];

  const statusTexts=['排八字四柱命盤…','排紫微斗數命盤…','梅花易數起卦…','凱爾特十字塔羅…','西洋占星星盤…','六維融合分析…'];
  const subTexts=['天干地支 × 十神 × 神煞','命宮十二宮 × 四化飛星','本卦 → 變卦 × 體用關係','十張牌 × 凱爾特十字展開','行星 × 宮位 × 相位','八字 × 紫微 × 梅花 × 塔羅 × 星盤 × 姓名'];
  const dimIds=['ld-bazi','ld-ziwei','ld-meihua','ld-tarot','ld-natal','ld-name'];
  const TOTAL_MS=3600;

  // 依序啟動每個維度
  const stagger=TOTAL_MS/6.5;
  dimIds.forEach((id,i)=>{
    // 開始運算
    setTimeout(()=>{
      const el=document.getElementById(id);
      if(el) el.classList.add('computing');
      const st=document.getElementById('ld-status');
      const sb=document.getElementById('ld-sub');
      if(st){st.style.opacity='0';setTimeout(()=>{st.textContent=statusTexts[i];st.style.opacity='1';},200);}
      if(sb){sb.style.opacity='0';setTimeout(()=>{sb.textContent=subTexts[i];sb.style.opacity='1';},200);}
    }, i*stagger);
    // 完成運算
    setTimeout(()=>{
      try { fns[i](); } catch(e) { console.error('Animation fn['+i+'] error:', e); }
      const el=document.getElementById(id);
      if(el){el.classList.remove('computing');el.classList.add('done');}
      // 點亮連到此節點的線
      for(let j=0;j<5;j++){
        if(j===i) continue;
        const a=Math.min(i,j),b=Math.max(i,j);
        const ln=document.getElementById('ld-ln-'+a+'-'+b);
        const otherNode=document.getElementById(dimIds[j]);
        if(ln&&otherNode&&otherNode.classList.contains('done')) ln.classList.add('lit');
      }
    }, i*stagger+stagger*0.7);
  });

  // 全部完成 → 爆發 → 跳轉
  setTimeout(()=>{
    document.getElementById('ld-center').classList.add('active');
    const st=document.getElementById('ld-status');
    if(st){st.style.opacity='0';setTimeout(()=>{st.textContent='解讀完成';st.style.opacity='1';},200);}
    const sb=document.getElementById('ld-sub');
    if(sb) sb.textContent='';
    // 所有線全亮
    document.querySelectorAll('.ld-line').forEach(l=>l.classList.add('lit'));
  }, TOTAL_MS-400);

  setTimeout(()=>{
    const burst=document.getElementById('ld-burst');
    if(burst){burst.classList.add('go');setTimeout(()=>burst.classList.add('fade'),400);}
  }, TOTAL_MS-100);

  setTimeout(()=>{
    const ol=document.getElementById('loading-overlay');
    if(ol){ol.style.transition='opacity .5s';ol.style.opacity='0';setTimeout(()=>ol.remove(),500);}
    goStep(3);
  }, TOTAL_MS+300);
}


// ══════════════════════════════════════════════════════
// 節氣精確時刻表 (1920-2050, 北京時間 UTC+8)
// 格式: JQ[年] = [小寒,立春,驚蟄,清明,立夏,芒種,小暑,立秋,白露,寒露,立冬,大雪]
// 每值 = 月*1000000 + 日*10000 + 時*100 + 分
// 用途: 精確判定月柱歸屬（取代粗略近似日）
// ══════════════════════════════════════════════════════
const JQ={1920:[1062239,2051026,3060451,4051013,5060407,6060843,7071910,8080450,9080720,10082224,11080100,12071726],1921:[1060430,2041617,3061042,4051604,5060957,6061433,7080100,8081040,9081310,10090414,11080652,12072318],1922:[1061022,2042209,3061633,4052155,5061548,6062024,7080650,8081630,9081901,10091005,11081243,12080510],1923:[1061614,2050400,3062224,4060346,5062138,6070214,7081241,8082221,9090051,10091556,11081834,12081101],1924:[1062206,2050952,3060416,4050937,5060329,6060804,7071831,8080411,9080642,10082147,11080026,12071653],1925:[1060357,2041543,3061007,4051527,5060919,6061354,7080020,8081001,9081232,10090338,11080616,12072244],1926:[1060948,2042134,3061557,4052117,5061509,6061943,7080609,8081550,9081821,10090927,11081206,12080434],1927:[1061538,2050324,3062147,4060307,5062058,6070132,7081158,8082138,9090009,10091516,11081755,12081023],1928:[1062128,2050914,3060336,4050855,5060246,6060719,7071745,8080325,9080557,10082104,11072344,12071612],1929:[1060316,2041502,3060924,4051443,5060833,6061306,7072332,8080912,9081144,10090251,11080531,12072200],1930:[1060904,2042050,3061512,4052030,5061419,6061852,7080518,8081458,9081730,10090838,11081119,12080347],1931:[1061452,2050238,3062059,4060217,5062005,6070038,7081103,8082044,9082316,10091425,11081706,12080935],1932:[1062039,2050825,3060246,4050803,5060151,6060624,7071649,8080229,9080502,10082011,11072252,12071522],1933:[1060227,2041412,3060833,4051349,5060737,6061209,7072234,8080815,9081048,10090158,11080439,12072109],1934:[1060814,2042000,3061420,4051936,5061324,6061756,7080420,8081401,9081635,10090745,11081027,12080257],1935:[1061402,2050148,3062008,4060124,5061911,6062342,7081007,8081948,9082222,10091332,11081615,12080846],1936:[1061951,2050736,3060156,4050712,5060059,6060530,7071554,8080136,9080410,10081921,11072204,12071435],1937:[1060141,2041326,3060745,4051301,5060647,6061118,7072142,8080724,9080959,10090110,11080354,12072025],1938:[1060731,2041916,3061335,4051850,5061236,6061707,7080331,8081313,9081548,10090700,11080944,12080216],1939:[1061322,2050107,3061926,4060041,5061826,6062257,7080921,8081903,9082139,10091251,11081535,12080807],1940:[1061913,2050658,3060117,4050631,5060017,6060447,7071511,8080053,9080329,10081841,11072127,12071359],1941:[1060105,2041250,3060709,4051223,5060608,6061037,7072101,8080644,9080920,10090033,11080318,12071950],1942:[1060657,2041842,3061300,4051814,5061158,6061628,7080252,8081234,9081510,10090624,11080909,12080142],1943:[1061249,2050033,3061852,4060005,5061749,6062218,7080842,8081824,9082101,10091214,11081500,12080733],1944:[1061840,2050624,3060042,4050555,5052339,6060407,7071431,8080013,9080250,10081804,11072051,12071324],1945:[1060030,2041215,3060633,4051145,5060528,6060956,7072020,8080602,9080839,10082353,11080240,12071914],1946:[1060620,2041805,3061222,4051734,5061116,6061544,7080208,8081150,9081427,10090542,11080829,12080103],1947:[1061210,2042354,3061811,4052322,5061704,6062132,7080755,8081737,9082015,10091130,11081417,12080651],1948:[1061758,2050542,3052359,4050509,5052251,6060318,7071341,8072323,9080201,10081717,11072005,12071239],1949:[1052346,2041130,3060546,4051056,5060437,6060904,7071927,8080509,9080748,10082303,11080152,12071826],1950:[1060533,2041717,3061133,4051643,5061023,6061450,7080112,8081055,9081334,10090450,11080739,12080014],1951:[1061121,2042304,3061720,4052229,5061609,6062035,7080658,8081641,9081920,10091036,11081326,12080601],1952:[1061708,2050452,3052307,4050416,5052156,6060221,7071244,8072227,9080106,10081623,11071913,12071148],1953:[1052256,2041039,3060454,4051003,5060342,6060808,7071830,8080413,9080653,10082210,11080101,12071737],1954:[1060444,2041628,3061042,4051550,5060929,6061355,7080017,8081000,9081240,10090358,11080649,12072325],1955:[1061033,2042217,3061631,4052139,5061517,6061942,7080604,8081548,9081828,10090947,11081238,12080515],1956:[1061623,2050406,3052221,4050328,5052106,6060131,7071153,8072137,9080017,10081537,11071828,12071105],1957:[1052214,2040957,3060411,4050918,5060256,6060720,7071742,8080326,9080607,10082127,11080019,12071656],1958:[1060405,2041548,3061002,4051508,5060846,6061310,7072332,8080916,9081157,10090317,11080610,12072248],1959:[1060956,2042139,3061553,4052059,5061437,6061900,7080522,8081506,9081748,10090908,11081201,12080439],1960:[1061548,2050331,3052145,4050251,5052027,6060051,7071113,8072057,9072339,10081500,11071753,12071031],1961:[1052140,2040923,3060336,4050842,5060218,6060641,7071703,8080247,9080529,10082050,11072344,12071623],1962:[1060331,2041514,3060927,4051432,5060808,6061231,7072252,8080837,9081119,10090241,11080535,12072214],1963:[1060922,2042105,3061518,4052022,5061358,6061820,7080442,8081426,9081709,10090830,11081125,12080404],1964:[1061513,2050256,3052108,4050212,5051947,6060009,7071030,8072014,9072257,10081419,11071714,12070954],1965:[1052103,2040845,3060257,4050801,5060135,6060557,7071618,8080202,9080445,10082008,11072303,12071542],1966:[1060251,2041434,3060845,4051348,5060723,6061144,7072204,8080749,9081032,10090155,11080451,12072130],1967:[1060840,2042022,3061433,4051936,5061309,6061730,7080350,8081335,9081619,10090742,11081038,12080318],1968:[1061427,2050209,3052020,4050122,5051855,6052316,7070936,8071921,9072205,10081329,11071625,12070905],1969:[1052015,2040757,3060207,4050709,5060041,6060502,7071522,8080106,9080351,10081915,11072212,12071453],1970:[1060202,2041344,3060754,4051255,5060628,6061047,7072107,8080652,9080937,10090101,11080359,12072040],1971:[1060750,2041931,3061341,4051842,5061214,6061633,7080253,8081238,9081523,10090648,11080946,12080228],1972:[1061338,2050119,3051929,4050029,5051801,6052220,7070840,8071825,9072110,10081236,11071534,12070816],1973:[1051926,2040708,3060117,4050617,5052348,6060407,7071427,8080012,9080258,10081824,11072123,12071405],1974:[1060115,2041257,3060706,4051206,5060537,6060955,7072015,8080600,9080846,10090013,11080312,12071955],1975:[1060705,2041847,3061256,4051755,5061126,6061544,7080204,8081149,9081436,10090603,11080903,12080146],1976:[1061256,2050038,3051846,4042346,5051715,6052134,7070753,8071739,9072026,10081153,11071454,12070737],1977:[1051848,2040629,3060038,4050536,5052306,6060324,7071343,8072329,9080216,10081744,11072045,12071328],1978:[1060039,2041221,3060629,4051127,5060457,6060914,7071933,8080519,9080807,10082335,11080236,12071920],1979:[1060631,2041813,3061220,4051719,5061047,6061505,7080124,8081110,9081357,10090526,11080828,12080112],1980:[1061223,2050004,3051812,4042310,5051638,6052055,7070714,8071700,9071948,10081117,11071419,12070703],1981:[1051814,2040555,3060003,4050500,5052228,6060244,7071303,8072249,9080138,10081707,11072009,12071254],1982:[1060005,2041146,3060553,4051050,5060417,6060833,7071852,8080438,9080727,10082257,11080159,12071844],1983:[1060555,2041736,3061143,4051639,5061006,6061422,7080040,8081026,9081315,10090445,11080748,12080033],1984:[1061145,2042325,3051732,4042228,5051554,6052009,7070627,8071614,9071903,10081033,11071336,12070622],1985:[1051733,2040514,3052320,4050415,5052141,6060156,7071214,8072200,9080049,10081620,11071924,12071210],1986:[1052321,2041102,3060507,4051002,5060327,6060742,7071800,8080346,9080636,10082207,11080111,12071757],1987:[1060509,2041649,3061054,4051549,5060914,6061328,7072345,8080932,9081222,10090354,11080658,12072344],1988:[1061056,2042236,3051641,4042135,5051500,6051913,7070531,8071517,9071808,10080940,11071245,12070531],1989:[1051643,2040423,3052228,4050322,5052046,6060059,7071116,8072103,9072354,10081527,11071832,12071119],1990:[1052231,2041011,3060415,4050909,5060232,6060645,7071703,8080249,9080540,10082114,11080020,12071707],1991:[1060419,2041559,3061003,4051456,5060819,6061232,7072249,8080836,9081128,10090301,11080608,12072256],1992:[1061008,2042148,3051552,4042044,5051407,6051820,7070437,8071424,9071716,10080850,11071157,12070445],1993:[1051558,2040338,3052141,4050233,5051956,6060008,7071025,8072012,9072305,10081439,11071747,12071035],1994:[1052148,2040928,3060331,4050823,5060145,6060557,7071614,8080202,9080454,10082029,11072337,12071626],1995:[1060339,2041519,3060922,4051414,5060735,6061147,7072204,8080752,9081044,10090220,11080528,12072217],1996:[1060930,2042110,3051513,4042004,5051326,6051737,7070354,8071342,9071635,10080811,11071120,12070409],1997:[1051522,2040302,3052105,4050156,5051917,6052328,7070944,8071932,9072226,10081402,11071711,12071001],1998:[1052114,2040854,3060256,4050747,5060107,6060518,7071535,8080123,9080416,10081953,11072302,12071552],1999:[1060306,2041445,3060848,4051338,5060658,6061108,7072125,8080712,9081006,10090143,11080453,12072143],2000:[1060857,2042036,3051438,4041928,5051247,6051658,7070314,8071302,9071556,10080733,11071043,12070334],2001:[1051447,2040227,3052028,4050117,5051837,6052246,7070902,8071850,9072145,10081322,11071633,12070924],2002:[1052037,2040816,3060218,4050706,5060025,6060434,7071450,8080038,9080333,10081911,11072222,12071513],2003:[1060226,2041405,3060806,4051254,5060613,6061021,7072037,8080625,9080920,10090058,11080410,12072101],2004:[1060815,2041954,3051354,4041842,5051159,6051608,7070223,8071211,9071506,10080645,11070957,12070249],2005:[1051402,2040141,3051941,4050029,5051746,6052154,7070809,8071757,9072053,10081232,11071544,12070836],2006:[1051950,2040729,3060128,4050615,5052332,6060340,7071355,8072343,9080239,10081818,11072131,12071423],2007:[1060137,2041316,3060715,4051202,5060518,6060925,7071940,8080528,9080825,10090005,11080318,12072010],2008:[1060725,2041903,3051302,4041748,5051104,6051511,7070126,8071114,9071411,10080552,11070905,12070158],2009:[1051312,2040051,3051850,4042335,5051651,6052058,7070712,8071701,9071958,10081139,11071453,12070746],2010:[1051901,2040639,3060038,4050523,5052238,6060245,7071259,8072248,9080145,10081727,11072041,12071335],2011:[1060050,2041228,3060627,4051112,5060426,6060832,7071847,8080436,9080734,10082316,11080231,12071925],2012:[1060640,2041818,3051217,4041701,5051015,6051421,7070036,8071025,9071323,10080506,11070821,12070115],2013:[1051231,2040009,3051807,4042251,5051605,6052011,7070625,8071614,9071913,10081056,11071412,12070706],2014:[1051822,2040600,3052358,4050442,5052155,6060201,7071215,8072204,9080103,10081647,11072003,12071258],2015:[1060013,2041152,3060549,4051033,5060346,6060751,7071805,8080355,9080654,10082238,11080154,12071850],2016:[1060605,2041743,3051141,4041624,5050937,6051341,7062355,8070945,9071244,10080429,11070746,12070041],2017:[1051157,2032335,3051732,4042215,5051527,6051932,7070546,8071535,9071835,10081019,11071337,12070633],2018:[1051748,2040526,3052323,4050405,5052117,6060122,7071135,8072125,9080025,10081610,11071927,12071224],2019:[1052339,2041117,3060514,4050956,5060307,6060711,7071724,8080314,9080614,10082159,11080117,12071814],2020:[1060530,2041707,3051104,4041545,5050856,6051259,7062312,8070902,9071202,10080348,11070706,12070003],2021:[1051119,2032257,3051653,4042133,5051444,6051847,7070500,8071450,9071750,10080936,11071255,12070552],2022:[1051708,2040445,3052241,4050321,5052031,6060034,7071047,8072036,9072337,10081524,11071843,12071140],2023:[1052256,2041033,3060429,4050908,5060218,6060620,7071633,8080223,9080523,10082110,11080030,12071727],2024:[1060444,2041621,3051016,4041455,5050804,6051206,7062218,8070808,9071109,10080257,11070617,12062315],2025:[1051031,2032208,3051603,4042042,5051350,6051751,7070404,8071354,9071655,10080843,11071204,12070502],2026:[1051618,2040355,3052150,4050228,5051936,6052337,7070949,8071940,9072241,10081430,11071751,12071049],2027:[1052206,2040943,3060337,4050815,5060122,6060523,7071535,8080126,9080428,10082017,11072338,12071637],2028:[1060354,2041531,3050925,4041402,5050709,6051110,7062122,8070712,9071015,10080204,11070526,12062226],2029:[1050943,2032119,3051513,4041950,5051257,6051657,7070309,8071300,9071603,10080753,11071115,12070415],2030:[1051532,2040309,3052102,4050139,5051845,6052245,7070857,8071848,9072151,10081342,11071705,12071005],2031:[1052122,2040859,3060252,4050729,5060035,6060434,7071446,8080037,9080341,10081932,11072255,12071555],2032:[1060313,2041450,3050843,4041319,5050625,6051024,7062036,8070627,9070931,10080122,11070446,12062147],2033:[1050905,2032041,3051434,4041910,5051215,6051614,7070226,8071217,9071521,10080713,11071037,12070338],2034:[1051456,2040233,3052025,4050101,5051806,6052205,7070816,8071808,9072112,10081304,11071629,12070930],2035:[1052048,2040825,3060217,4050652,5052357,6060355,7071406,8072358,9080303,10081855,11072220,12071522],2036:[1060240,2041416,3050808,4041243,5050547,6050945,7061956,8070548,9070853,10080046,11070411,12062113],2037:[1050831,2032007,3051359,4041833,5051137,6051535,7070146,8071137,9071443,10080636,11071001,12070303],2038:[1051422,2040158,3051949,4050023,5051726,6052124,7070735,8071726,9072032,10081225,11071551,12070853],2039:[1052012,2040748,3060139,4050612,5052315,6060312,7071322,8072314,9080220,10081813,11072140,12071442],2040:[1060201,2041337,3050727,4041200,5050503,6050859,7061910,8070501,9070807,10080001,11070328,12062031],2041:[1050750,2031925,3051315,4041748,5051050,6051446,7070056,8071048,9071354,10080548,11070915,12070219],2042:[1051337,2040113,3051903,4042335,5051636,6052032,7070642,8071634,9071940,10081135,11071503,12070806],2043:[1051925,2040700,3060050,4050522,5052222,6060218,7071227,8072219,9080126,10081721,11072049,12071353],2044:[1060112,2041248,3050637,4041108,5050408,6050803,7061813,8070405,9070712,10072308,11070236,12061940],2045:[1050700,2031835,3051224,4041655,5050954,6051349,7062359,8070951,9071258,10080454,11070823,12070128],2046:[1051247,2040023,3051811,4042242,5051541,6051935,7070545,8071537,9071845,10081042,11071411,12070716],2047:[1051836,2040611,3052359,4050429,5052128,6060122,7071132,8072124,9080032,10081630,11071959,12071305],2048:[1060025,2041200,3050548,4041018,5050316,6050710,7061719,8070312,9070620,10072218,11070149,12061854],2049:[1050614,2031749,3051137,4041607,5050905,6051259,7062308,8070900,9071209,10080408,11070739,12070045],2050:[1051205,2032340,3051728,4042157,5051454,6051848,7070457,8071450,9071759,10080958,11071329,12070636]};

// 節氣名稱對照
const JQ_NAMES=['小寒','立春','驚蟄','清明','立夏','芒種','小暑','立秋','白露','寒露','立冬','大雪'];
// 節氣對應的月支序號: 小寒→丑(1), 立春→寅(2), ..., 大雪→子(0)
const JQ_MZI=[1,2,3,4,5,6,7,8,9,10,11,0];
// 節氣對應的農曆月序: 小寒→12月, 立春→1月(正月), 驚蟄→2月, ..., 大雪→11月
const JQ_MI=[12,1,2,3,4,5,6,7,8,9,10,11];

// 精確查找出生時間落在哪個節氣區間
// 返回 {jieIdx, jieName, jieDate, nextJieName, nextJieDate, daysAfterJie, monthMi}
function findJieqiForBirth(year, month, day, hour, minute){
  const birthNum = month*1000000 + day*10000 + hour*100 + (minute||0);
  const t = JQ[year];
  const tPrev = JQ[year-1];
  if(!t) return null; // 超出表範圍，fallback

  // 從後往前找：出生時間 >= 哪個節氣
  let foundIdx = -1;
  for(let i = 11; i >= 0; i--){
    if(birthNum >= t[i]){ foundIdx = i; break; }
  }

  let jieIdx, jieNum, jieYear;
  if(foundIdx >= 0){
    jieIdx = foundIdx;
    jieNum = t[foundIdx];
    jieYear = year;
  } else {
    // 在本年小寒之前 → 用上一年的大雪
    if(!tPrev) return null;
    jieIdx = 11; // 大雪
    jieNum = tPrev[11];
    jieYear = year - 1;
  }

  // 解析節氣日期
  const jM = Math.floor(jieNum/1000000);
  const jD = Math.floor((jieNum%1000000)/10000);
  const jH = Math.floor((jieNum%10000)/100);
  const jMi = jieNum%100;

  // 計算距離節氣的天數
  const birthDate = new Date(year, month-1, day, hour, minute||0);
  const jieDate = new Date(jieYear, jM-1, jD, jH, jMi);
  const daysAfter = Math.floor((birthDate - jieDate) / 86400000);

  // 下一個節氣
  let nextIdx, nextNum;
  if(foundIdx >= 0 && foundIdx < 11){
    nextIdx = foundIdx + 1;
    nextNum = t[nextIdx];
  } else if(foundIdx === 11){
    // 大雪後 → 下一個是次年小寒
    nextIdx = 0;
    const tNext = JQ[year+1];
    nextNum = tNext ? tNext[0] : null;
  } else {
    // 上一年大雪後 → 下一個是本年小寒
    nextIdx = 0;
    nextNum = t[0];
  }

  const nM = nextNum ? Math.floor(nextNum/1000000) : 0;
  const nD = nextNum ? Math.floor((nextNum%1000000)/10000) : 0;
  const nH = nextNum ? Math.floor((nextNum%10000)/100) : 0;
  const nMi = nextNum ? nextNum%100 : 0;

  return {
    jieIdx: jieIdx,
    jieName: JQ_NAMES[jieIdx],
    jieMonth: jM, jieDay: jD, jieHour: jH, jieMinute: jMi,
    nextJieName: JQ_NAMES[nextIdx],
    nextJieMonth: nM, nextJieDay: nD, nextJieHour: nH, nextJieMinute: nMi,
    daysAfterJie: daysAfter,
    monthMi: JQ_MI[jieIdx],  // 農曆月序
    monthZhi: JQ_MZI[jieIdx] // 月支序號
  };
}

// ══════════════════════════════════════════════════════
// 人元司令（月令用事天干）
// 每月藏干按天數輪流用事，決定月令真正的主宰力量
// 格式: RENYUAN[地支] = [[天干, 用事天數], ...]
// ══════════════════════════════════════════════════════
const RENYUAN={
  子:[['壬',10],['癸',20]],
  丑:[['癸',9],['辛',3],['己',18]],
  寅:[['戊',7],['丙',7],['甲',16]],
  卯:[['甲',10],['乙',20]],
  辰:[['乙',9],['癸',3],['戊',18]],
  巳:[['戊',5],['庚',9],['丙',16]],
  午:[['丙',10],['己',9],['丁',11]],
  未:[['丁',9],['乙',3],['己',18]],
  申:[['戊',10],['壬',3],['庚',17]],
  酉:[['庚',10],['辛',20]],
  戌:[['辛',9],['丁',3],['戊',18]],
  亥:[['戊',7],['甲',5],['壬',18]]
};

// 計算人元司令：根據出生在節氣後的天數，判斷哪個藏干當令
// 返回 {gan:'庚', el:'金', name:'庚金用事', daysInTerm:6}
function getRenyuanSiling(monthZhi, daysAfterJie){
  const schedule = RENYUAN[monthZhi];
  if(!schedule) return null;
  let cumDays = 0;
  for(const [gan, days] of schedule){
    cumDays += days;
    if(daysAfterJie < cumDays){
      return {
        gan: gan,
        el: WX_G[gan],
        name: gan + WX_G[gan] + '用事',
        daysInTerm: daysAfterJie - (cumDays - days),
        totalDays: days
      };
    }
  }
  // 超出天數（接近下一個節氣），取最後一個
  const last = schedule[schedule.length - 1];
  return { gan: last[0], el: WX_G[last[0]], name: last[0] + WX_G[last[0]] + '用事', daysInTerm: daysAfterJie, totalDays: last[1] };
}


// ══════════════════════════════════════════════════════
// 空亡計算
// 以年柱和日柱為準，找出所在旬中未被配對的2個地支
// 空亡地支力量被削弱
// ══════════════════════════════════════════════════════
function getKongWang(ganIdx, zhiIdx){
  // 找60甲子序號
  let cycle = -1;
  for(let n=0; n<60; n++){
    if(n%10===ganIdx && n%12===zhiIdx){ cycle=n; break; }
  }
  if(cycle<0) return [];
  const xunStart = cycle - (cycle % 10);
  const xunZhi = xunStart % 12;
  return [DZ[(xunZhi+10)%12], DZ[(xunZhi+11)%12]];
}

// ══════════════════════════════════════════════════════
// 袁天罡稱骨術
// ══════════════════════════════════════════════════════
const CHENGGU_YEAR=[1.2,0.9,0.6,0.7,1.2,0.5,0.9,0.8,0.7,0.8,1.5,0.9,1.6,0.8,0.8,1.9,1.2,0.6,0.8,0.7,0.5,1.5,0.6,1.6,1.5,0.7,0.9,1.2,1.0,0.7,1.5,0.6,0.5,1.4,1.4,0.9,0.7,0.7,0.9,1.2,0.8,0.7,1.3,0.5,1.4,0.5,0.9,1.7,0.5,0.7,1.2,0.8,0.8,0.6,1.9,0.6,0.8,1.6,1.0,0.6];
const CHENGGU_MONTH=[0,0.6,0.7,1.8,0.9,0.5,1.6,0.9,1.5,1.8,0.8,0.9,0.5]; // idx 1-12 // idx 1-12
const CHENGGU_DAY=[0,0.5,1.0,0.8,1.5,1.6,1.5,0.8,1.6,0.8,1.6,0.9,1.7,0.8,1.7,1.0,0.8,0.9,1.8,0.5,1.5,1.0,0.9,0.8,0.9,1.5,1.8,0.7,0.8,1.6,0.6]; // idx 1-30 (袁天罡稱骨) // idx 1-30
const CHENGGU_HOUR=[1.6,0.6,0.7,1.0,0.9,1.6,1.0,0.8,0.8,0.9,0.6,0.6]; // 子丑寅...亥 idx 0 // 子丑寅...亥 idx 0-11

const CHENGGU_RESULT={
  '2.1':{level:'下下',poem:'短命非業謂大凶，平生災難事重重，凶禍頻臨限逆境，終世困苦事不成。'},
  '2.2':{level:'下下',poem:'身寒骨冷苦伶仃，此命推來行乞人，碌碌巴巴無度日，中年打拱過平生。'},
  '2.3':{level:'下下',poem:'此命推來骨輕輕，求謀做事事難成，妻兒兄弟應難許，別處他鄉作散人。'},
  '2.4':{level:'下下',poem:'此命推來福祿無，門庭困苦總難榮，六親骨肉皆無靠，流浪他鄉作老翁。'},
  '2.5':{level:'下',poem:'此命推來祖業微，門庭營度似稀奇，六親骨肉如冰炭，一世勤勞自把持。'},
  '2.6':{level:'下',poem:'平生衣祿苦中求，獨自營謀事不休，離祖出門宜早計，晚來衣祿自無憂。'},
  '2.7':{level:'下',poem:'一生作事少商量，難靠祖宗作主張，獨馬單槍空作去，早年晚歲總無長。'},
  '2.8':{level:'下',poem:'一生作事似飄蓬，祖宗產業在夢中，若不過房並改姓，也當移徙二三通。'},
  '2.9':{level:'下中',poem:'初年運限未曾亨，縱有功名在後成，須過四旬才可上，移居改姓使為良。'},
  '3.0':{level:'下中',poem:'勞勞碌碌苦中求，東走西奔何日休，若使終身勤與儉，老來稍可免憂愁。'},
  '3.1':{level:'下中',poem:'忙忙碌碌苦中求，何日雲開見日頭，難得祖基家可立，中年衣食漸無憂。'},
  '3.2':{level:'下中',poem:'初年運蹇事難謀，漸有財源如水流，到得中年衣食旺，那時名利一齊收。'},
  '3.3':{level:'中下',poem:'早年做事事難成，百年勤勞枉費心，半世自如流水去，後來運到始得金。'},
  '3.4':{level:'中下',poem:'此命福氣果如何，僧道門中衣祿多，離祖出家方為妙，朝晚拜佛念彌陀。'},
  '3.5':{level:'中',poem:'生平福量不周全，祖業根基覺少傳，營業生涯宜守舊，時來衣食勝從前。'},
  '3.6':{level:'中',poem:'不須勞碌過平生，獨自成家福不輕，早有福星常照命，任君行去百般成。'},
  '3.7':{level:'中',poem:'此命般般事不成，弟兄少力自孤行，雖然祖業須微有，來得明時去不明。'},
  '3.8':{level:'中',poem:'一生骨肉最清高，早入簧門姓氏標，待到年將三十六，藍衫脫去換紅袍。'},
  '3.9':{level:'中上',poem:'此命少年運不通，勞勞作事盡皆空，苦心竭力成家計，到得那時在夢中。'},
  '4.0':{level:'中上',poem:'平生衣祿是綿長，件件心中自主張，前面風霜多受過，後來必定享安康。'},
  '4.1':{level:'中上',poem:'此命推來事不同，為人能幹異凡庸，中年還有逍遙福，不比前年運未通。'},
  '4.2':{level:'中上',poem:'得寬懷處且寬懷，何用雙眉總不開，若使中年命運濟，那時名利一齊來。'},
  '4.3':{level:'上中',poem:'為人心性最聰明，作事軒昂近貴人，衣祿一生天數定，不須勞碌過平生。'},
  '4.4':{level:'上中',poem:'萬事由天莫苦求，須知福祿賴人修，當年財帛難如意，晚景欣然便不憂。'},
  '4.5':{level:'上中',poem:'名利推來竟若何，前番辛苦後奔波，命中難養男和女，骨肉扶持也不多。'},
  '4.6':{level:'上中',poem:'東西南北盡皆通，出姓移名更覺隆，衣祿無虧天數定，中年晚景一般同。'},
  '4.7':{level:'上',poem:'此命推來旺末年，妻榮子貴自怡然，平生原有滔滔福，可有財源如水泉。'},
  '4.8':{level:'上',poem:'初年運道未曾通，幾許蹉跎命亦窮，兄弟六親皆無靠，一身事業晚來隆。'},
  '4.9':{level:'上',poem:'此命推來福不輕，自成自立顯門庭，從來富貴人欽敬，使婢差奴過一生。'},
  '5.0':{level:'上上',poem:'為利為名終日勞，中年福祿也多遭，老來是有財星照，不比前番目下高。'},
  '5.1':{level:'上上',poem:'一世榮華事事通，不須勞碌自亨通，兄弟叔侄皆如意，家業成時福祿宏。'},
  '5.2':{level:'上上',poem:'一世亨通事事能，不須勞思自然寧，宗施欣然心皆好，家業豐亨自稱心。'},
  '5.3':{level:'上上',poem:'此格推來氣象真，興家發達在其中，一生福祿安排定，卻是人間一富翁。'},
  '5.4':{level:'上上',poem:'此命推來厚且清，詩書滿腹看功成，豐衣足食自然穩，正是人間有福人。'},
  '5.5':{level:'上上',poem:'走馬揚鞭爭利名，少年作事費推求，一朝福祿源源至，富貴榮華顯六親。'},
  '5.6':{level:'上上',poem:'此格推來禮義通，一生福祿用無窮，甜酸苦辣皆嘗過，財源滾滾穩且豐。'},
  '5.7':{level:'上上',poem:'福祿豐盈萬事全，一生榮耀顯雙親，名揚威振人欽敬，處世逢凶化吉祥。'},
  '5.8':{level:'上上',poem:'平生福祿自然來，名利兼全福壽偕，雁塔題名為貴客，紫袍金帶走金階。'},
  '5.9':{level:'上上',poem:'細推此格妙且清，必定才高禮義通，甲第之中應有分，揚鞭走馬顯威榮。'},
  '6.0':{level:'上上',poem:'一朝金榜快題名，顯祖榮宗立大功，衣食定然原裕足，田園財帛更豐盈。'},
  '6.1':{level:'上上',poem:'不作朝中金榜客，定為世上大財翁，聰明天賦經書熟，名顯高克自是榮。'},
  '6.2':{level:'上上',poem:'此命生來福不窮，讀書必定顯親宗，紫衣金帶為卿相，富貴榮華皆可同。'},
  '6.3':{level:'上上',poem:'命主福祿從天來，富貴榮華享自然，名利兼全福壽偕，雁塔題名狀元郎。'},
  '6.4':{level:'上上',poem:'此格權威不可當，紫袍金帶坐高堂，榮華富貴誰能及，積玉堆金滿儲倉。'},
  '6.5':{level:'上上',poem:'細推此命福不輕，富貴榮華孰與爭，定國安邦人極品，威聲顯赫震寰瀛。'},
  '6.6':{level:'上上',poem:'此格人間一福人，堆金積玉滿堂春，從來富貴由天定，正笏垂紳謁聖君。'},
  '6.7':{level:'上上',poem:'此命生來福自宏，田園家業最高隆，平生衣祿盈豐足，一世榮華萬事通。'},
  '6.8':{level:'上上',poem:'富貴由天莫苦求，萬金家計不須愁，十年不比前番事，祖業根基水上舟。'},
  '6.9':{level:'上上',poem:'君是人間衣祿星，一生富貴萬人欽，縱然福祿由天定，安享榮華過一生。'},
  '7.0':{level:'上上',poem:'此命推來福祿宏，不須愁慮苦勞心，一生天定衣與祿，富貴榮華過一生。'},
  '7.1':{level:'上上',poem:'此命生成大不同，公侯卿相在其中，一生自有逍遙福，富貴榮華極品隆。'},
  '7.2':{level:'上上',poem:'此格世界罕有生，十代積善產此人，天上紫微來照命，統治萬民樂太平。'}
};

// 計算稱骨：需要年柱60甲子序號、農曆月、農曆日、時辰序
function computeChengGu(yearCycle60, lunarMonth, lunarDay, hourZhi){
  if(!lunarMonth||!lunarDay) return null;
  const yW = CHENGGU_YEAR[yearCycle60] || 0;
  const mW = CHENGGU_MONTH[lunarMonth] || 0;
  const dW = CHENGGU_DAY[lunarDay] || 0;
  const hW = CHENGGU_HOUR[hourZhi] || 0;
  const total = Math.round((yW + mW + dW + hW) * 10) / 10;
  const key = total.toFixed(1);
  const result = CHENGGU_RESULT[key] || null;
  return {
    yearWeight: yW, monthWeight: mW, dayWeight: dW, hourWeight: hW,
    total: total, display: (function(){const CN='零一二三四五六七八九';return CN[Math.floor(total)]+'兩'+CN[Math.round((total%1)*10)]+'錢';})(),
    level: result ? result.level : '',
    poem: result ? result.poem : '骨重超出範圍'
  };
}

// ══════════════════════════════════════════════════════
// 星座 (西洋) + 二十八星宿
// ══════════════════════════════════════════════════════
function getZodiac(month, day){
  const signs=[
    {name:'摩羯座',sym:'♑',el:'土',start:[12,22],end:[1,19]},
    {name:'水瓶座',sym:'♒',el:'風',start:[1,20],end:[2,18]},
    {name:'雙魚座',sym:'♓',el:'水',start:[2,19],end:[3,20]},
    {name:'牡羊座',sym:'♈',el:'火',start:[3,21],end:[4,19]},
    {name:'金牛座',sym:'♉',el:'土',start:[4,20],end:[5,20]},
    {name:'雙子座',sym:'♊',el:'風',start:[5,21],end:[6,21]},
    {name:'巨蟹座',sym:'♋',el:'水',start:[6,22],end:[7,22]},
    {name:'獅子座',sym:'♌',el:'火',start:[7,23],end:[8,22]},
    {name:'處女座',sym:'♍',el:'土',start:[8,23],end:[9,22]},
    {name:'天秤座',sym:'♎',el:'風',start:[9,23],end:[10,23]},
    {name:'天蠍座',sym:'♏',el:'水',start:[10,24],end:[11,22]},
    {name:'射手座',sym:'♐',el:'火',start:[11,23],end:[12,21]}
  ];
  for(const s of signs){
    const [sm,sd]=s.start, [em,ed]=s.end;
    if(sm>em){ // 跨年(摩羯)
      if((month===sm&&day>=sd)||(month===em&&day<=ed)||(month>sm)||(month<em)) return s;
    } else {
      if((month===sm&&day>=sd)||(month===em&&day<=ed)||(month>sm&&month<em)) return s;
    }
  }
  return signs[0];
}

// 二十八星宿：以農曆日對應，每日一宿循環
// 宿名依序：角亢氐房心尾箕 斗牛女虛危室壁 奎婁胃昴畢觜參 井鬼柳星張翼軫
// 每宿配禽星（動物）和七政（日月五星）
const XINGXIU=[
  {name:'角',animal:'蛟',planet:'木',group:'東方青龍'},
  {name:'亢',animal:'龍',planet:'金',group:'東方青龍'},
  {name:'氐',animal:'貉',planet:'土',group:'東方青龍'},
  {name:'房',animal:'兔',planet:'日',group:'東方青龍'},
  {name:'心',animal:'狐',planet:'月',group:'東方青龍'},
  {name:'尾',animal:'虎',planet:'火',group:'東方青龍'},
  {name:'箕',animal:'豹',planet:'水',group:'東方青龍'},
  {name:'斗',animal:'獬',planet:'木',group:'北方玄武'},
  {name:'牛',animal:'牛',planet:'金',group:'北方玄武'},
  {name:'女',animal:'蝠',planet:'土',group:'北方玄武'},
  {name:'虛',animal:'鼠',planet:'日',group:'北方玄武'},
  {name:'危',animal:'燕',planet:'月',group:'北方玄武'},
  {name:'室',animal:'豬',planet:'火',group:'北方玄武'},
  {name:'壁',animal:'貐',planet:'水',group:'北方玄武'},
  {name:'奎',animal:'狼',planet:'木',group:'西方白虎'},
  {name:'婁',animal:'狗',planet:'金',group:'西方白虎'},
  {name:'胃',animal:'雉',planet:'土',group:'西方白虎'},
  {name:'昴',animal:'雞',planet:'日',group:'西方白虎'},
  {name:'畢',animal:'烏',planet:'月',group:'西方白虎'},
  {name:'觜',animal:'猴',planet:'火',group:'西方白虎'},
  {name:'參',animal:'猿',planet:'水',group:'西方白虎'},
  {name:'井',animal:'犴',planet:'木',group:'南方朱雀'},
  {name:'鬼',animal:'羊',planet:'金',group:'南方朱雀'},
  {name:'柳',animal:'獐',planet:'土',group:'南方朱雀'},
  {name:'星',animal:'馬',planet:'日',group:'南方朱雀'},
  {name:'張',animal:'鹿',planet:'月',group:'南方朱雀'},
  {name:'翼',animal:'蛇',planet:'火',group:'南方朱雀'},
  {name:'軫',animal:'蚓',planet:'水',group:'南方朱雀'}
];

function getXingXiu(solarYear, solarMonth, solarDay){
  // 以儒略日為基準計算星宿值日
  // 基準：1900年1月1日 = 虛宿(index 10)
  const base = new Date(1900, 0, 1);
  const tgt = new Date(solarYear, solarMonth-1, solarDay);
  const diff = Math.floor((tgt - base) / 86400000);
  const idx = ((diff % 28) + 10 + 2800) % 28; // 1900/1/1=虛宿(10)
  return XINGXIU[idx];
}

// ══════════════════════════════════════════════════════
// 西洋占星術 — 本命星盤引擎 (Tropical Geocentric Placidus)
// ══════════════════════════════════════════════════════
const _AD=Math.PI/180, _AR=180/Math.PI;
function _n360(a){return((a%360)+360)%360;}
function _n180(a){let v=_n360(a);return v>180?v-360:v;}
function _toJD(y,m,d,h,mi){let Y=y,M=m;if(M<=2){Y--;M+=12;}const A=Math.floor(Y/100),B=2-A+Math.floor(A/4);return Math.floor(365.25*(Y+4716))+Math.floor(30.6001*(M+1))+d+(h+(mi||0)/60)/24+B-1524.5;}

function _sunLon(T){const L=280.46646+36000.76983*T,M=357.52911+35999.05029*T,Mr=M*_AD;return _n360(L+(1.914602-0.004817*T)*Math.sin(Mr)+0.019993*Math.sin(2*Mr)+0.000289*Math.sin(3*Mr)-0.00569-0.00478*Math.sin((125.04-1934.136*T)*_AD));}

function _moonLon(T){const Lp=218.3165+481267.8813*T,D=297.8502+445267.1115*T,M=357.5291+35999.0503*T,Mp=134.9634+477198.8676*T,F=93.2720+483202.0175*T;return _n360(Lp+6.289*Math.sin(Mp*_AD)+1.274*Math.sin((2*D-Mp)*_AD)+0.658*Math.sin(2*D*_AD)+0.214*Math.sin(2*Mp*_AD)-0.186*Math.sin(M*_AD)-0.114*Math.sin(2*F*_AD)+0.059*Math.sin((2*D-2*Mp)*_AD)+0.057*Math.sin((2*D-M-Mp)*_AD)+0.053*Math.sin((2*D+Mp)*_AD)+0.046*Math.sin((2*D-M)*_AD)-0.041*Math.sin((Mp-M)*_AD)-0.035*Math.sin(D*_AD)-0.031*Math.sin((Mp+M)*_AD));}

const _PE={Mercury:[0.38709927,0.20563593,7.00497902,252.25032350,77.45779628,48.33076593,0.00000037,0.00001906,-0.00594749,149472.67411175,0.16047689,-0.12534081],Venus:[0.72333566,0.00677672,3.39467605,181.97909950,131.60246718,76.67984255,0.00000390,-0.00004107,-0.00078890,58517.81538729,0.00268329,-0.27769418],Earth:[1.00000261,0.01671123,-0.00001531,100.46457166,102.93768193,0,0.00000562,-0.00004392,-0.01294668,35999.37244981,0.32327364,0],Mars:[1.52371034,0.09339410,1.84969142,-4.55343205,-23.94362959,49.55953891,0.00001847,0.00007882,-0.00813131,19140.30268499,0.44441088,-0.29257343],Jupiter:[5.20288700,0.04838624,1.30439695,34.39644051,14.72847983,100.47390909,-0.00011607,-0.00013253,-0.00183714,3034.74612775,0.21252668,0.20469106],Saturn:[9.53667594,0.05386179,2.48599187,49.95424423,92.59887831,113.66242448,-0.00125060,-0.00050991,0.00193609,1222.49362201,-0.41897216,-0.28867794],Uranus:[19.18916464,0.04725744,0.77263783,313.23810451,170.95427630,74.01692503,-0.00196176,-0.00004397,-0.00242939,428.48202785,0.40805281,0.04240589],Neptune:[30.06992276,0.00859048,1.77004347,-55.12002969,44.96476227,131.78422574,0.00026291,0.00005105,0.00035372,218.45945325,-0.32241464,-0.00508664],Pluto:[39.48211675,0.24882730,17.14001206,238.92903833,224.06891629,110.30393684,-0.00031596,0.00005170,0.00004818,145.20780515,-0.04062942,0.01183482]};

function _planetHelio(name,T){const p=_PE[name];if(!p)return{x:0,y:0,z:0};const a=p[0]+p[6]*T,e=p[1]+p[7]*T,I=(p[2]+p[8]*T)*_AD,L=_n360(p[3]+p[9]*T)*_AD,wp=_n360(p[4]+p[10]*T)*_AD,Om=_n360(p[5]+p[11]*T)*_AD,M=L-wp;let E=M;for(let i=0;i<15;i++)E=E-(E-e*Math.sin(E)-M)/(1-e*Math.cos(E));const nu=2*Math.atan2(Math.sqrt(1+e)*Math.sin(E/2),Math.sqrt(1-e)*Math.cos(E/2)),r=a*(1-e*Math.cos(E)),w=wp-Om;return{x:r*(Math.cos(Om)*Math.cos(nu+w)-Math.sin(Om)*Math.sin(nu+w)*Math.cos(I)),y:r*(Math.sin(Om)*Math.cos(nu+w)+Math.cos(Om)*Math.sin(nu+w)*Math.cos(I)),z:r*Math.sin(nu+w)*Math.sin(I)};}

function _planetGeoLon(name,T){const ea=_planetHelio('Earth',T),pl=_planetHelio(name,T);return _n360(Math.atan2(pl.y-ea.y,pl.x-ea.x)*_AR);}

const ZODIAC_NAMES=['牡羊','金牛','雙子','巨蟹','獅子','處女','天秤','天蠍','射手','摩羯','水瓶','雙魚'];
const ZODIAC_SYMS=['♈','♉','♊','♋','♌','♍','♎','♏','♐','♑','♒','♓'];
const ZODIAC_ELS=['火','土','風','水','火','土','風','水','火','土','風','水'];
const ZODIAC_MODES=['本位','固定','變動','本位','固定','變動','本位','固定','變動','本位','固定','變動'];
function _getSign(lon){const i=Math.floor(lon/30)%12;return{idx:i,name:ZODIAC_NAMES[i],sym:ZODIAC_SYMS[i],el:ZODIAC_ELS[i],mode:ZODIAC_MODES[i],deg:lon%30};}

const NATAL_ASPECTS=[{name:'合',angle:0,orb:8,sym:'☌',good:true},{name:'六合',angle:60,orb:6,sym:'⚹',good:true},{name:'刑',angle:90,orb:7,sym:'□',good:false},{name:'三合',angle:120,orb:8,sym:'△',good:true},{name:'對沖',angle:180,orb:8,sym:'☍',good:false}];

function computeNatalChart(year,month,day,hour,minute,geoLon,geoLat){
  geoLon=geoLon||120.5; geoLat=geoLat||24.0;
  // UTC轉換 (GMT+8)
  let utH=hour-8, utD=day, utM=month, utY=year, utMi=minute||0;
  if(utH<0){utH+=24;utD--;}
  if(utD<1){utM--;if(utM<1){utM=12;utY--;}utD=new Date(utY,utM,0).getDate();}
  
  const jd=_toJD(utY,utM,utD,utH,utMi), T=(jd-2451545.0)/36525, obl=23.4393-0.013*T;
  
  // 行星
  const planets={};
  planets['太陽']={lon:_sunLon(T),sym:'☉',color:'#fbbf24'};
  planets['月亮']={lon:_moonLon(T),sym:'☽',color:'#94a3b8'};
  [['Mercury','水星','☿','#60a5fa'],['Venus','金星','♀','#4ade80'],['Mars','火星','♂','#f87171'],['Jupiter','木星','♃','#a78bfa'],['Saturn','土星','♄','#d4a017'],['Uranus','天王','♅','#38bdf8'],['Neptune','海王','♆','#818cf8'],['Pluto','冥王','♇','#f472b6']].forEach(([eng,chn,sym,col])=>{planets[chn]={lon:_planetGeoLon(eng,T),sym,color:col};});
  planets['北交']={lon:_n360(125.0446-1934.1363*T),sym:'☊',color:'#a3a3a3'};
  
  // 星座資訊
  for(const p of Object.values(planets)){const s=_getSign(p.lon);Object.assign(p,{sign:s.name,signIdx:s.idx,signDeg:s.deg,signSym:s.sym,el:s.el});}
  
  // RAMC / ASC / MC
  const gmst=_n360(280.46061837+360.98564736629*(jd-2451545.0)+0.000387933*T*T);
  const ramc=_n360(gmst+geoLon);
  const L=ramc*_AD, E=obl*_AD, phi=geoLat*_AD;
  const asc=_n360(Math.atan2(-Math.cos(L),Math.sin(L)*Math.cos(E)+Math.tan(phi)*Math.sin(E))*_AR+180);
  let mc=Math.atan(Math.tan(L)/Math.cos(E))*_AR; const ramcQ=Math.floor(ramc/90);
  if(ramcQ===1||ramcQ===2) mc+=180; mc=_n360(mc);
  
  // Placidus宮位（簡化三等分法）
  const houses=new Array(12);
  houses[0]=asc; houses[3]=_n360(mc+180); houses[6]=_n360(asc+180); houses[9]=mc;
  for(let q=0;q<4;q++){const s=houses[q*3],e=houses[((q+1)*3)%12];const span=_n360(e-s);houses[q*3+1]=_n360(s+span/3);houses[q*3+2]=_n360(s+2*span/3);}
  
  // 行星所在宮位
  for(const p of Object.values(planets)){
    let h=1;
    for(let i=0;i<12;i++){const s=houses[i],e=houses[(i+1)%12];let sp=_n360(e-s),lp=_n360(p.lon-s);if(lp<sp){h=i+1;break;}}
    p.house=h;
  }
  
  // 相位
  const aspects=[];
  const pKeys=Object.keys(planets);
  for(let i=0;i<pKeys.length;i++)for(let j=i+1;j<pKeys.length;j++){
    const d=Math.abs(_n180(planets[pKeys[i]].lon-planets[pKeys[j]].lon));
    for(const a of NATAL_ASPECTS)if(Math.abs(d-a.angle)<=a.orb){aspects.push({p1:pKeys[i],p2:pKeys[j],type:a.name,sym:a.sym,good:a.good,diff:Math.abs(d-a.angle)});break;}
  }
  
  const ascSign=_getSign(asc), mcSign=_getSign(mc);
  
  // 解讀摘要
  const sunSign=planets['太陽'].sign, moonSign=planets['月亮'].sign;
  const summary=`太陽${sunSign}・月亮${moonSign}・上升${ascSign.name}`;
  
  return{planets,houses,aspects,asc,ascSign,mc,mcSign,ramc,jd,T,obl,summary};
}

function computeBazi(year,month,day,hour,minute,gender){
  // ── 節氣精確查詢 ──
  const jqInfo = findJieqiForBirth(year, month, day, hour, minute||0);
  
  // ── 年柱（以立春為界）──
  let ly = year;
  if(jqInfo){
    // 精確：立春前屬上一年
    const lichunNum = JQ[year] ? JQ[year][1] : null; // 立春
    const birthNum = month*1000000 + day*10000 + hour*100 + (minute||0);
    if(lichunNum && birthNum < lichunNum) ly--;
  } else {
    // 無表fallback：粗略判斷
    if(month<2||(month===2&&day<4)) ly--;
  }
  const yGi=((ly-4)%10+10)%10;
  const yZi=((ly-4)%12+12)%12;
  const yG=TG[yGi], yZ=DZ[yZi];

  // ── 月柱（以節氣精確時刻為界）──
  let mi, mZi;
  if(jqInfo){
    mi = jqInfo.monthMi;           // 農曆月序 (1=正月, 2=二月, ..., 12=十二月)
    mZi = jqInfo.monthZhi;         // 月支序號 (寅=2, 卯=3, ..., 子=0, 丑=1)
  } else {
    // 無表fallback
    const JIE=[0,6,4,6,5,6,6,7,8,8,8,7,7];
    mi=month;
    if(day<(JIE[month]||6))mi=mi===1?12:mi-1;
    mZi=mi%12;
  }
  // 年上起月法：甲己起丙(2),乙庚起戊(4),丙辛起庚(6),丁壬起壬(8),戊癸起甲(0)
  const mGBase=((yGi%5)*2+2)%10;
  // 正月(mi=1)偏移=0, 二月(mi=2)偏移=1, ..., 十二月(mi=12)偏移=11
  const monthOffset = (mi - 1 + 12) % 12; // mi=1→0, mi=2→1, ..., mi=12→11
  const mGi = (mGBase + monthOffset) % 10;
  const mG=TG[mGi], mZ=DZ[mZi];

  // ── 人元司令（月令用事天干）──
  const renyuan = jqInfo ? getRenyuanSiling(mZ, jqInfo.daysAfterJie) : null;

  // ── 日柱（以1900-01-01甲戌日為基準，序號10） ──
  const base=new Date(1900,0,1);
  const tgt=new Date(year,month-1,day);
  const diff=Math.floor((tgt-base)/864e5);
  const dayCycle=((diff+10)%60+60)%60;
  const dGi=dayCycle%10;
  const dZi=dayCycle%12;
  const dG=TG[dGi], dZ=DZ[dZi];

  // ── 時柱 ──
  const shi=Math.floor(((hour+1)%24)/2);
  const hZi=shi%12;
  // 夜子時修正: 23:00-23:59 屬子時, 但時柱天干按"下一天"日干起算
  const isNightZi=(hour>=23);
  let hGBase;
  if(isNightZi){
    const nextDayCycle=((diff+1+10)%60+60)%60;
    hGBase=(nextDayCycle%10%5)*2;
  }else{
    hGBase=(dGi%5)*2;
  }
  const hGi=(hGBase+hZi)%10;
  const hG=TG[hGi], hZ=DZ[hZi];

  const pillars={year:{gan:yG,zhi:yZ},month:{gan:mG,zhi:mZ},day:{gan:dG,zhi:dZ},hour:{gan:hG,zhi:hZ}};
  const dm=dG, dmEl=WX_G[dm];

  // ── 空亡 ──
  const kongwang={
    year: getKongWang(yGi, yZi),   // 年柱空亡
    day: getKongWang(dGi, dZi)     // 日柱空亡
  };


  // ╔═══════════════════════════════════════════════════════════════════╗
  // ║  八字分析引擎 v3.0 — 純扶抑法（逆向8組實測命盤100%匹配）        ║
  // ║  權重：天干=0.5 本氣=0.6 中氣=0.3 餘氣=0.1 月令加成=+0.5       ║
  // ║  日干計入五行分數（不計入十神）· 身強弱門檻 >30                  ║
  // ╚═══════════════════════════════════════════════════════════════════╝

  // ── 五行力量計算（60分制，逆向比對8組實測案例）──
  const W_TG = 0.5;     // 天干權重
  const W_BEN = 0.6;    // 地支本氣權重
  const W_ZHONG = 0.3;  // 地支中氣權重
  const W_YU = 0.1;     // 地支餘氣權重
  const W_YUELING = 0.5;// 月支本氣額外加成

  const ec = {金:0, 木:0, 水:0, 火:0, 土:0};
  const allG = [yG, mG, dG, hG], allZ = [yZ, mZ, dZ, hZ];

  // 日干計入五行分數
  ec[WX_G[dm]] += W_TG;

  // 天干計分（日干不重複計，年干/月干/時干）
  [yG, mG, hG].forEach(g => {
    ec[WX_G[g]] += W_TG;
  });

  // 地支藏干計分
  allZ.forEach((z, i) => {
    const cg = CG[z] || [];
    cg.forEach((g, j) => {
      let w;
      if(j === 0) { // 本氣
        w = W_BEN + (i === 1 ? W_YUELING : 0); // 月支本氣額外加成
      } else if(j === 1) { // 中氣
        w = W_ZHONG;
      } else { // 餘氣
        w = W_YU;
      }
      ec[WX_G[g]] += w;
    });
  });

  // ── 歸一化到60分（floor + 殘差分配法）──
  const rawTot = Object.values(ec).reduce((a, b) => a + b, 0);
  const ecExact = {};
  const ecFloor = {};
  const ecRemainder = {};
  const WX_KEYS = ['金', '木', '水', '火', '土'];

  WX_KEYS.forEach(k => {
    ecExact[k] = rawTot > 0 ? (ec[k] / rawTot * 60) : 0;
    ecFloor[k] = Math.floor(ecExact[k]);
    ecRemainder[k] = ecExact[k] - ecFloor[k];
  });

  // 分配剩餘分數（殘差最大者優先+1）
  let deficit = 60 - WX_KEYS.reduce((s, k) => s + ecFloor[k], 0);
  const sortedByRemainder = [...WX_KEYS].sort((a, b) => ecRemainder[b] - ecRemainder[a]);
  for(let i = 0; i < deficit; i++) {
    ecFloor[sortedByRemainder[i]] += 1;
  }

  // 用歸一化後的60分覆蓋 ec
  WX_KEYS.forEach(k => { ec[k] = ecFloor[k]; });

  const tot = 60;
  const ep = {};
  WX_KEYS.forEach(k => { ep[k] = Math.round(ec[k] / 60 * 100); });

  // ── 十神子分統計（逐位計數法，日干不計）──
  const godCount = {}; // {十神名: 次數}
  const godBreakdown = {金:{}, 木:{}, 水:{}, 火:{}, 土:{}};
  
  // 天干（排除日干）
  [yG, mG, hG].forEach(g => {
    const god = tenGod(dm, g);
    if(god && god !== '—') {
      godCount[god] = (godCount[god] || 0) + 1;
      const el = WX_G[g];
      godBreakdown[el][god] = (godBreakdown[el][god] || 0) + 1;
    }
  });
  // 地支全部藏干
  allZ.forEach(z => {
    const cg = CG[z] || [];
    cg.forEach(g => {
      const god = tenGod(dm, g);
      if(god && god !== '—') {
        godCount[god] = (godCount[god] || 0) + 1;
        const el = WX_G[g];
        godBreakdown[el][god] = (godBreakdown[el][god] || 0) + 1;
      }
    });
  });

  // ── 月令旺衰狀態 ──
  const mzEl = WX_Z[mZ];
  function getMonthState(el){
    if(el === mzEl) return '旺';
    if(SHENG[mzEl] === el) return '相';  // 旺所生
    if(SHENG[el] === mzEl) return '休';  // 生旺者
    if(KE[el] === mzEl) return '囚';     // 剋旺者
    if(KE[mzEl] === el) return '死';     // 旺所剋
    return '休';
  }
  const dmMonthState = getMonthState(dmEl);

  // ── 身強弱判定（印比60分之和 > 30 = 身強）──
  const yinEl = BE_SHENG[dmEl]; // 印星五行（生我）
  const selfPts = (ec[dmEl] || 0) + (ec[yinEl] || 0); // 比劫 + 印
  const strong = selfPts > 30;
  const selfRatio = selfPts / tot;

  // 結構類型（保留舊欄位相容性）
  const structType = (strong ? '身強' : '身弱') + '(' + Math.round(selfPts) + ')';
  const capacity = Math.round(selfPts);
  const deLing = (dmMonthState === '旺' || dmMonthState === '相');
  // 得地（日支藏干有同我五行）
  const deDi = (CG[dZ] || []).some(g => WX_G[g] === dmEl);
  // 得勢（天干有生我/同我）
  let helpCount = 0;
  [yG, mG, hG].forEach(g => {
    if(WX_G[g] === dmEl || SHENG[WX_G[g]] === dmEl) helpCount++;
  });
  const deShi = helpCount >= 2;

  // 承載力（保留舊欄位，但用新邏輯的身強弱分數）
  const bearingCapacity = selfPts;

  // ── 用神忌神（純扶抑法，100%匹配APP邏輯）──
  let fav = [], unfav = [];

  const woSheng = SHENG[dmEl];      // 食傷（我生）
  const woKe = KE[dmEl];            // 財（我剋）
  const keWo = BE_KE[dmEl];         // 官殺（剋我）

  if(strong) {
    // ─── 身強：用神取洩耗（食傷+財+官殺中分數最低的前2個）───
    const candidates = [
      {el: woSheng, score: ec[woSheng] || 0},  // 食傷
      {el: woKe, score: ec[woKe] || 0},         // 財
      {el: keWo, score: ec[keWo] || 0}          // 官殺
    ].sort((a, b) => a.score - b.score);
    fav = candidates.slice(0, 2).map(c => c.el);

    // 忌神 = 印比（全列）
    unfav = [dmEl, yinEl];
  } else {
    // ─── 身弱：用神取印比（比劫排前、印排後）───
    // 特殊篩選：如果印星分數極高（>=19），不列入用神
    if((ec[yinEl] || 0) >= 19) {
      fav = [dmEl]; // 只列比劫
    } else {
      fav = [dmEl, yinEl]; // 比劫在前，印在後
    }

    // 忌神 = 食傷/財/官殺中60分 >= 14 的五行
    [woSheng, woKe, keWo].forEach(el => {
      if((ec[el] || 0) >= 14) {
        unfav.push(el);
      }
    });
    // 按分數高→低排序
    unfav.sort((a, b) => (ec[b] || 0) - (ec[a] || 0));
  }

  fav = [...new Set(fav)];
  unfav = [...new Set(unfav.filter(u => !fav.includes(u)))];

  // ── 能量流向（保留舊欄位相容性）──
  const weightedEC = {...ec}; // 用60分代替舊的權重分
  const flowOrder = ['水','木','火','土','金'];
  const sortedEls = Object.entries(ec).sort((a,b) => b[1] - a[1]);
  const mainFlow = sortedEls[0][0] + '→' + SHENG[sortedEls[0][0]] + '→' + SHENG[SHENG[sortedEls[0][0]]];
  const energyFlow = {
    mainFlow: mainFlow,
    breakPoint: '無明顯阻斷',
    maxNode: sortedEls[0][0],
    sortedPower: sortedEls.map(([el,v]) => el+'('+v+')').join(' > ')
  };

  // ── 反證驗證（保留舊欄位相容性）──
  const verification = {};
  const proximityNotes = [];

  // ── 調候提示（不影響用神判定，僅作參考提示）──
  let tiaohou = null;
  const firePct = ep['火'] || 0;
  const waterPct = ep['水'] || 0;
  (function checkTiaohou(){
    const _isWinter = ['亥','子','丑'].includes(mZ);
    const _isSummer = ['巳','午','未'].includes(mZ);
    if(dmEl === '木' && _isWinter && firePct < 15){
      tiaohou = {reason:'寒木向陽', detail: dm+'木冬生，宜有火暖局。', need:['火'], avoid:['水']};
    } else if(dmEl === '金' && _isWinter && firePct < 15){
      tiaohou = {reason:'金寒水冷', detail: dm+'金冬生，需火暖局。', need:['火'], avoid:[]};
    } else if(dmEl === '金' && _isSummer){
      tiaohou = {reason:'金燥需潤', detail: dm+'金夏生，需水淬鍊。', need:['水'], avoid:[]};
    } else if(dmEl === '火' && _isWinter){
      tiaohou = {reason:'冬火需木', detail: dm+'火冬生，需木助燃。', need:['木'], avoid:[]};
    } else if(dmEl === '水' && _isSummer){
      tiaohou = {reason:'夏水需源', detail: dm+'水夏生，需金生水。', need:['金'], avoid:[]};
    } else if(dmEl === '木' && _isSummer && firePct > 50){
      tiaohou = {reason:'木焚火燥', detail: dm+'木夏生，火旺木焚。', need:['水'], avoid:[]};
    }
  })();

  // ── 十神 ──
  const gods={};
  ['year','month','day','hour'].forEach(p=>{
    const g=pillars[p].gan, z=pillars[p].zhi;
    gods[p]={
      gan: p==='day'?'日主':tenGod(dm,g),
      zhi: CG[z]?CG[z].map(c=>tenGod(dm,c)):['—']
    };
  });

  // ── 十二長生 ──
  const cs={};
  ['year','month','day','hour'].forEach(p=>{
    cs[p]=changSheng(dm,pillars[p].zhi);
  });

  // ── 神煞 ──
  const shensha=getShenSha(pillars);

  // ── 納音（四柱 + 天運五行）──
  const nayin=getNaYin(yGi,yZi);  // 年柱納音（= 天運五行的來源）
  const nayinAll={
    year: getNaYin(yGi, yZi),
    month: getNaYin(mGi, mZi),
    day: getNaYin(dGi, dZi),
    hour: getNaYin(TG.indexOf(hG), DZ.indexOf(hZ))
  };
  // 天運五行 = 年柱納音的五行屬性
  const tianYunEl = nayin ? {'金':'金','木':'木','水':'水','火':'火','土':'土'}[
    nayin.includes('金')?'金':nayin.includes('木')?'木':nayin.includes('水')?'水':
    nayin.includes('火')?'火':nayin.includes('土')?'土':''
  ] : '';

  // ── 命宮 / 胎元 / 胎息 / 身宮 ──
  const hZiIdx = DZ.indexOf(hZ);
  const mingGong = getMingGong(yGi, mZi, hZiIdx, mi);
  const taiYuan = getTaiYuan(mGi, mZi);
  const taiXi = getTaiXi(dGi, dZi);
  const shenGong = getShenGong(yGi, mZi, hZiIdx, mi);

  // ── 大運 ──
  const isFwd=(gender==='male'&&YY_G[yG]==='陽')||(gender==='female'&&YY_G[yG]==='陰');
  const dir=isFwd?1:-1;
  const qiyun=computeStartAge(year,month,day,hour,minute,dir);
  const startAge = qiyun.startAge;
  const dayun=[];
  // App：起運前為「小運」（1～起運前一歲）
  if(startAge>1){
    const curAge=new Date().getFullYear()-year;
    dayun.push({
      gz:'小運',
      ageStart:1,
      ageEnd:startAge-1,
      level:'小運',
      score:0,
      god:'',
      zGod:'',
      notes:['起運前以小運論（參考）'],
      clash:[],he:[],xing:[],
      liuNian:[],
      ganScore:0,
      zhiScore:0,
      isCurrent:curAge>=1 && curAge<=startAge-1
    });
  }

  for(let i=0;i<10;i++){
    const gI=((TG.indexOf(mG)+(i+1)*dir)%10+10)%10;
    const zI=((DZ.indexOf(mZ)+(i+1)*dir)%12+12)%12;
    const as=startAge+i*10, ae=as+9;
    const curAge=new Date().getFullYear()-year;
    const isCur=curAge>=as&&curAge<=ae;
    const dyG=TG[gI],dyZ=DZ[zI],dyEl=WX_G[dyG],dyZEl=WX_Z[dyZ];
    /* ═══ 大運吉凶判定：四步分析法 ═══ */
    const dyGod=tenGod(dm,dyG);
    const dyZGod=tenGod(dm,CG[dyZ]?CG[dyZ][0]:dyG);
    let dyScore=0;
    let dyNotes=[];

    // [Step1] 喜忌判定 — 天干管前5年, 地支管後5年
    const dyGanScore=(fav.includes(dyEl)?3:unfav.includes(dyEl)?-3:0);
    const dyZhiScore=(fav.includes(dyZEl)?3:unfav.includes(dyZEl)?-3:0);
    dyScore+=dyGanScore+dyZhiScore;
    if(dyGanScore>0) dyNotes.push('天干'+dyG+'（'+dyEl+'行·喜用）前五年順');
    if(dyGanScore<0) dyNotes.push('天干'+dyG+'（'+dyEl+'行·忌神）前五年逆');
    if(dyZhiScore>0) dyNotes.push('地支'+dyZ+'（'+dyZEl+'行·喜用）後五年順');
    if(dyZhiScore<0) dyNotes.push('地支'+dyZ+'（'+dyZEl+'行·忌神）後五年逆');

    // [Step2] 大運與原局互動 — 刑沖合害
    const origZhi=[yZ,mZ,dZ,hZ];
    const origGan=[yG,mG,dG,hG];
    const gongKeys=['year','month','day','hour'];
    let dyClash=[], dyHe=[], dyXing=[];
    origZhi.forEach((oz,idx)=>{
      if(LIU_CHONG[dyZ]===oz){
        dyClash.push(gongKeys[idx]);
        const clashArea=GONG_EVENT[gongKeys[idx]].domain;
        dyNotes.push('大運'+dyZ+'沖原局'+gongKeys[idx]+'（'+oz+'）→ '+clashArea+'有變動');
        dyScore+=(unfav.includes(WX_Z[oz])?1.5:-1.5); // 沖掉忌神則吉，沖掉喜用則凶
      }
      if(LIU_HE[dyZ]===oz){
        dyHe.push(gongKeys[idx]);
        const heEl=LH_RESULT[dyZ];
        // 地支合化條件：月令為化神五行，或化神五行佔比>20%
        const canTransform=(mzEl===heEl)||(ep[heEl]&&ep[heEl]>20);
        if(canTransform){
          dyScore+=(fav.includes(heEl)?1:-0.5);
          dyNotes.push('大運'+dyZ+'合原局'+oz+'→化'+heEl+(fav.includes(heEl)?'（喜）':'（忌）'));
        } else {
          dyScore+=(fav.includes(heEl)?0.3:-0.2);
          dyNotes.push('大運'+dyZ+'合原局'+oz+'→合而不化（牽制）');
        }
      }
      if(DZ_XING[dyZ]===oz){
        dyXing.push(gongKeys[idx]);
        dyScore-=0.5;
        dyNotes.push('大運'+dyZ+'刑原局'+oz+'→ 注意'+GONG_EVENT[gongKeys[idx]].domain);
      }
    });
    // 天干合（含化神條件判斷）
    origGan.forEach((og,idx)=>{
      if(TG_HE[dyG]===og){
        const heEl=TG_HE_EL[dyG];
        // 合化成功條件：月令（月支五行）須為化神五行，或化神五行在命盤佔比>20%
        const canTransform=(mzEl===heEl)||(ep[heEl]&&ep[heEl]>20);
        if(canTransform){
          dyScore+=(fav.includes(heEl)?1.5:-1);
          dyNotes.push('大運'+dyG+'合原局'+og+'→化'+heEl+'（月令引化成功）');
        } else {
          // 合而不化：只是拉扯牽制，影響減半
          dyScore+=(fav.includes(heEl)?0.5:-0.3);
          dyNotes.push('大運'+dyG+'合原局'+og+'→合而不化（月令未引化）');
        }
      }
    });

    // [Step3] 十神配合度
    if(['正印','偏印'].includes(dyGod)&&!strong){dyScore+=1;dyNotes.push('身弱逢印（'+dyGod+'），得到庇護');}
    if(['正官'].includes(dyGod)&&strong){dyScore+=1;dyNotes.push('身強逢正官，有制衡助升遷');}
    if(['七殺'].includes(dyGod)&&!strong){dyScore-=1.5;dyNotes.push('身弱逢七殺，壓力倍增');}
    if(['食神','傷官'].includes(dyGod)&&strong){dyScore+=1;dyNotes.push('身強逢'+dyGod+'，才華得展');}
    if(['正財','偏財'].includes(dyGod)&&strong){dyScore+=1;dyNotes.push('身強逢'+dyGod+'，利財運');}
    if(['正財','偏財'].includes(dyGod)&&!strong){dyScore-=0.5;dyNotes.push('身弱逢'+dyGod+'，財多身弱');}

    // [Step4] 調候加成（金寒水冷 / 火旺土燥等極端格局，調候為第一優先）
    if(tiaohou){
      const thReason=tiaohou.reason||'';
      const isCold=thReason.includes('寒')||thReason.includes('冷')||thReason.includes('金水泛濫');
      const isHot=thReason.includes('火旺')||thReason.includes('燥')||thReason.includes('火炎');
      // 調候命盤：暖/潤局是核心需求，權重拉到最高
      if(isCold){
        if(dyEl==='火'||dyZEl==='火'){dyScore+=3;dyNotes.push('🔥 寒命逢火運，調候大利（暖局翻身）');}
        if(dyEl==='火'&&dyZEl==='火'){dyScore+=1.5;dyNotes.push('天干地支皆火，暖局效果極強');}
        if(dyEl==='木'||dyZEl==='木'){dyScore+=1;dyNotes.push('寒命逢木運，木能生火助暖');}
        if(dyEl==='水'||dyZEl==='水'){dyScore-=2.5;dyNotes.push('❄ 寒命再逢水運，雪上加霜');}
        if(dyEl==='水'&&dyZEl==='水'){dyScore-=1.5;dyNotes.push('天干地支皆水，寒氣加劇');}
        if(dyEl==='金'||dyZEl==='金'){dyScore-=2;dyNotes.push('寒命逢金運，金寒水冷加重');}
        if(dyEl==='金'&&dyZEl==='金'){dyScore-=1;dyNotes.push('天干地支皆金，金旺生水助寒');}
      }
      if(isHot){
        if(dyEl==='水'||dyZEl==='水'){dyScore+=3;dyNotes.push('💧 熱命逢水運，調候大利（潤局解渴）');}
        if(dyEl==='水'&&dyZEl==='水'){dyScore+=1.5;dyNotes.push('天干地支皆水，潤局效果極強');}
        if(dyEl==='金'||dyZEl==='金'){dyScore+=1;dyNotes.push('熱命逢金運，金能生水助潤');}
        if(dyEl==='火'||dyZEl==='火'){dyScore-=2.5;dyNotes.push('🔥 熱命再逢火運，火上澆油');}
        if(dyEl==='火'&&dyZEl==='火'){dyScore-=1.5;dyNotes.push('天干地支皆火，燥氣加劇');}
        if(dyEl==='木'||dyZEl==='木'){dyScore-=1.5;dyNotes.push('熱命逢木運，木助火勢');}
      }
      // 非極端格局的一般調候
      if(!isCold&&!isHot){
        if(thReason.includes('寒')&&(dyEl==='火'||dyZEl==='火')){dyScore+=2;dyNotes.push('寒命逢火運，調候有利');}
        if(thReason.includes('火旺')&&(dyEl==='水'||dyZEl==='水')){dyScore+=2;dyNotes.push('熱命逢水運，調候有利');}
      }
    }

    let lv='平穩';
    if(dyScore>=6) lv='能量極強';
    else if(dyScore>=3) lv='能量旺盛';
    else if(dyScore>=1) lv='能量上升';
    else if(dyScore>=-1) lv='平穩';
    else if(dyScore>=-3) lv='能量偏弱';
    else if(dyScore>=-6) lv='能量低迷';
    else lv='需要補運';

    // ── 流年精斷 ──
    const liuNian=[];
    for(let j=0;j<10;j++){
      const lnYear=year+as+j;
      const lnGI=((lnYear-4)%10+10)%10;
      const lnZI=((lnYear-4)%12+12)%12;
      const lnG=TG[lnGI],lnZ=DZ[lnZI],lnEl=WX_G[lnG],lnZEl=WX_Z[lnZ];
      const lnGod=tenGod(dm,lnG);
      let lnScore=0;
      let lnNotes=[];

      // [流年Step1] 喜忌 — 天干=外在表象, 地支=本質結果
      if(fav.includes(lnEl)){lnScore+=2;lnNotes.push('天干'+lnG+'（喜用·表象吉）');}
      else if(unfav.includes(lnEl)){lnScore-=2;lnNotes.push('天干'+lnG+'（忌神·表象凶）');}
      if(fav.includes(lnZEl)){lnScore+=2;lnNotes.push('地支'+lnZ+'（喜用·本質吉）');}
      else if(unfav.includes(lnZEl)){lnScore-=2;lnNotes.push('地支'+lnZ+'（忌神·本質凶）');}

      // [流年Step2] 三柱互動：流年→大運→原局
      // 流年與大運互動
      if(lnG===dyG&&lnZ===dyZ){lnScore+=Math.abs(lnScore)>0?lnScore:2;lnNotes.push('⚡ 歲運並臨（力量加倍）');}
      if(LIU_CHONG[lnZ]===dyZ){
        lnNotes.push('流年'+lnZ+'沖大運'+dyZ+'→ 運勢動盪');
        // 沖掉的是喜用還是忌神
        lnScore+=(unfav.includes(dyZEl)?1:-1.5);
      }
      if(TG_HE[lnG]===dyG){
        const heEl=TG_HE_EL[lnG];
        const canTransform=(mzEl===heEl)||(ep[heEl]&&ep[heEl]>20);
        if(canTransform){
          lnScore+=(fav.includes(heEl)?1:-0.5);
          lnNotes.push('流年'+lnG+'合大運'+dyG+'→化'+heEl);
        } else {
          lnScore+=(fav.includes(heEl)?0.3:-0.2);
          lnNotes.push('流年'+lnG+'合大運'+dyG+'→合而不化');
        }
      }
      if(LIU_HE[lnZ]===dyZ){
        const heEl=LH_RESULT[lnZ];
        const canTransform=(mzEl===heEl)||(ep[heEl]&&ep[heEl]>20);
        if(canTransform){
          lnScore+=(fav.includes(heEl)?1:-0.5);
          lnNotes.push('流年'+lnZ+'合大運'+dyZ+'→化'+heEl);
        } else {
          lnScore+=(fav.includes(heEl)?0.3:-0.2);
          lnNotes.push('流年'+lnZ+'合大運'+dyZ+'→合而不化');
        }
      }

      // 流年與原局互動（宮位觸發）
      let lnClash=[], lnAffect=[];
      origZhi.forEach((oz,idx)=>{
        if(LIU_CHONG[lnZ]===oz){
          lnClash.push(gongKeys[idx]);
          const area=GONG_EVENT[gongKeys[idx]];
          lnNotes.push('流年'+lnZ+'沖'+area.label+'（'+oz+'）→ '+area.domain+'有變動');
          lnScore+=(unfav.includes(WX_Z[oz])?1:-1);
          lnAffect.push(...area.area);
        }
      });

      // [流年Step3] 十神疊加 + 宮位 = 事象推導
      let lnEvents=[];
      if(GOD_EVENT[lnGod]) lnEvents.push(lnGod+'：'+GOD_EVENT[lnGod]);
      // 流年十神+被沖宮位=具體事象
      lnClash.forEach(gk=>{
        const gong=GONG_EVENT[gk];
        lnEvents.push(lnGod+'沖'+gong.label+'→ '+gong.domain+'領域出現'+GOD_EVENT[lnGod]);
      });

      // [流年Step4] 特殊組合
      // 三合局檢查（流年+大運+原局任一支組成三合）
      const allZhi=[lnZ,dyZ,...origZhi];
      SAN_HE.forEach(sh=>{
        const inSet=sh.members.filter(m=>allZhi.includes(m));
        if(inSet.length>=3&&inSet.includes(lnZ)){
          lnNotes.push('三合'+sh.el+'局（含'+inSet.join('')+'）');
          lnScore+=(fav.includes(sh.el)?2:-2);
        }
      });

      // 流年調候加成（與大運同步強化）
      if(tiaohou){
        const thR2=tiaohou.reason||'';
        const isCold2=thR2.includes('寒')||thR2.includes('冷')||thR2.includes('金水泛濫');
        const isHot2=thR2.includes('火旺')||thR2.includes('燥')||thR2.includes('火炎');
        if(isCold2){
          if(lnEl==='火'||lnZEl==='火'){lnScore+=2;lnNotes.push('🔥 寒命逢火年，暖局有利');}
          if(lnEl==='木'||lnZEl==='木'){lnScore+=0.5;lnNotes.push('木生火，間接助暖');}
          if(lnEl==='水'||lnZEl==='水'){lnScore-=1.5;lnNotes.push('❄ 寒命逢水年，加寒');}
          if(lnEl==='金'||lnZEl==='金'){lnScore-=1;lnNotes.push('金生水加寒');}
        }else if(isHot2){
          if(lnEl==='水'||lnZEl==='水'){lnScore+=2;lnNotes.push('💧 熱命逢水年，潤局有利');}
          if(lnEl==='金'||lnZEl==='金'){lnScore+=0.5;lnNotes.push('金生水，間接助潤');}
          if(lnEl==='火'||lnZEl==='火'){lnScore-=1.5;lnNotes.push('🔥 熱命逢火年，加燥');}
          if(lnEl==='木'||lnZEl==='木'){lnScore-=1;lnNotes.push('木生火加燥');}
        }else{
          if(thR2.includes('寒')&&(lnEl==='火'||lnZEl==='火')){lnScore+=1;lnNotes.push('寒命逢火年，暖局');}
          if(thR2.includes('寒')&&(lnEl==='水'||lnZEl==='水')){lnScore-=1;lnNotes.push('寒命逢水年，加寒');}
          if(thR2.includes('火旺')&&(lnEl==='水'||lnZEl==='水')){lnScore+=1;lnNotes.push('熱命逢水年，降溫');}
          if(thR2.includes('火旺')&&(lnEl==='火'||lnZEl==='火')){lnScore-=1;lnNotes.push('熱命逢火年，加熱');}
        }
      }

      let lnLv='平穩';
      if(lnScore>=5) lnLv='能量極強';
      else if(lnScore>=3) lnLv='能量旺盛';
      else if(lnScore>=1) lnLv='能量上升';
      else if(lnScore>=-1) lnLv='平穩';
      else if(lnScore>=-3) lnLv='能量偏弱';
      else if(lnScore>=-5) lnLv='能量低迷';
      else lnLv='需要補運';
      liuNian.push({year:lnYear,gz:lnG+lnZ,el:lnEl,zEl:lnZEl,level:lnLv,god:lnGod,score:lnScore,notes:lnNotes,events:lnEvents,clash:lnClash,affect:lnAffect});
    }
    dayun.push({gz:dyG+dyZ,el:dyEl,zEl:dyZEl,ageStart:as,ageEnd:ae,isCurrent:isCur,level:lv,score:dyScore,god:dyGod,zGod:dyZGod,notes:dyNotes,clash:dyClash,he:dyHe,xing:dyXing,liuNian,ganScore:dyGanScore,zhiScore:dyZhiScore});
  }

  // ── 袁天罡稱骨 ──
  let yearCycle60 = -1;
  for(let n=0;n<60;n++){if(n%10===yGi&&n%12===yZi){yearCycle60=n;break;}}
  const lunarDate = (typeof approxLunar==='function') ? approxLunar(year,month,day) : null;
  const hZiForCG = Math.floor(((hour+1)%24)/2) % 12;
  const chenggu = (yearCycle60>=0 && lunarDate) ? computeChengGu(yearCycle60, lunarDate.month, lunarDate.day, hZiForCG) : null;

  // ── 星座 + 二十八星宿 ──
  const zodiac = getZodiac(month, day);
  const xingxiu = getXingXiu(year, month, day);

  return{_birthYear:year,pillars,dm,dmEl,strong,structType,bearingCapacity,energyFlow,verification,weightedEC,capacity,proximityNotes,deLing,deDi,deShi,dmMonthState,selfRatio:Math.round(selfRatio*100),selfPts,ec,ep,fav,unfav,gods,cs,shensha,nayin,nayinAll,tianYunEl,dayun,qiyun,cangGan:{year:CG[yZ],month:CG[mZ],day:CG[dZ],hour:CG[hZ]},tiaohou:tiaohou,jqInfo:jqInfo,renyuan:renyuan,kongwang:kongwang,mingGong:mingGong,taiYuan:taiYuan,taiXi:taiXi,shenGong:shenGong,chenggu:chenggu,godBreakdown:godBreakdown,zodiac:zodiac,xingxiu:xingxiu};
}

function computeStartAge(y,m,d,hr,mi,dir){
  /* ═══ 起運歲數計算（精確版 — 使用 JQ 節氣表）═══
   * 計算公式（傳統命理）：
   *   - 順行：出生時間 → 下一個節的總分鐘數
   *   - 逆行：出生時間 → 上一個節的總分鐘數
   *   - 3天(4320分鐘) = 1歲，餘數：360分鐘 = 1個月
   */
  
  const jqInfo = findJieqiForBirth(y, m, d, hr||0, mi||0);
  if(!jqInfo){   const realAge = Math.max(1, age);
  const startAge = realAge + 2; // ✅App 顯示規則：起運歲數 = 實歲(age) + 2（含小運 1~(起運-1)）

  return {
    age: realAge,        // 實歲（整年）
    months: months,      // 追加月數（0~11）
    virtualAge: realAge + 1,  // 虛歲（參考）
    startAge: startAge,       // App 顯示「X歲起運」
    smallStart: 1,
    smallEnd: startAge - 1
  }; }
  
  const birthDate = new Date(y, m-1, d, hr||0, mi||0);
  
  // 當前節氣的精確時刻
  const jieDate = new Date(
    jqInfo.jieMonth <= 12 ? (jqInfo.jieIdx === 11 && m < 3 ? y-1 : y) : y,
    jqInfo.jieMonth - 1, jqInfo.jieDay, jqInfo.jieHour, jqInfo.jieMinute
  );
  // 修正年份：如果節氣是上一年的大雪
  if(jqInfo.jieIdx === 11 && jqInfo.jieMonth === 12 && m <= 2){
    jieDate.setFullYear(y - 1);
  }
  
  let diffMinutes;
  if(dir > 0){
    // 順行：找下一個節氣
    const t = JQ[y];
    const tNext = JQ[y+1];
    let nextJieNum;
    if(jqInfo.jieIdx < 11){
      nextJieNum = t ? t[jqInfo.jieIdx + 1] : null;
    } else {
      // 當前是大雪 → 下一個是次年小寒
      nextJieNum = tNext ? tNext[0] : null;
    }
    // 如果 jqInfo 是從上一年取的大雪，則下一個節是本年小寒
    if(!nextJieNum && jqInfo.jieIdx === 11){
      nextJieNum = t ? t[0] : null;
    }
    
    if(nextJieNum){
      const nM = Math.floor(nextJieNum/1000000);
      const nD = Math.floor((nextJieNum%1000000)/10000);
      const nH = Math.floor((nextJieNum%10000)/100);
      const nMi = nextJieNum%100;
      let nYear = y;
      if(jqInfo.jieIdx === 11 && nM === 1) nYear = y + 1;
      if(jqInfo.jieIdx === 11 && jqInfo.jieMonth === 12 && m <= 2) nYear = y;
      const nextDate = new Date(nYear, nM-1, nD, nH, nMi);
      diffMinutes = (nextDate - birthDate) / 60000;
    } else {
      diffMinutes = 15 * 4320; // fallback: 15歲
    }
  } else {
    // 逆行：距離當前（上一個）節氣
    diffMinutes = (birthDate - jieDate) / 60000;
  }
  
  diffMinutes = Math.abs(diffMinutes);
  const age = Math.floor(diffMinutes / 4320);
  const remainderMin = diffMinutes % 4320;
  const months = Math.floor(remainderMin / 360);
  
    const realAge = Math.max(1, age);
  const startAge = realAge + 2; // ✅App 顯示規則：起運歲數 = 實歲(age) + 2（含小運 1~(起運-1)）

  return {
    age: realAge,        // 實歲（整年）
    months: months,      // 追加月數（0~11）
    virtualAge: realAge + 1,  // 虛歲（參考）
    startAge: startAge,       // App 顯示「X歲起運」
    smallStart: 1,
    smallEnd: startAge - 1
  };
}

/* 納音 */
function getNaYin(gi,zi){
  const NY=['海中金','爐中火','大林木','路旁土','劍鋒金','山頭火','澗下水','城頭土','白蠟金','楊柳木',
            '泉中水','屋上土','霹靂火','松柏木','長流水','砂中金','山下火','平地木','壁上土','金箔金',
            '覆燈火','天河水','大驛土','釵釧金','桑柘木','大溪水','砂中土','天上火','石榴木','大海水'];
  let cycle=-1;
  for(let n=0;n<60;n++){if(n%10===gi&&n%12===zi){cycle=n;break;}}
  if(cycle<0)return'';
  return NY[Math.floor(cycle/2)]||'';
}

/* 命宮（三命通會標準算法）
   正月子時起寅，逆月順時
   公式：命宮地支 = (月序 + 1 - 時支序 + 12) % 12
         命宮天干按年起月法推算 */
function getMingGong(yGi, mZi, hZi, mi){
  const gongZi = (mi + 1 - hZi + 24) % 12;
  const mGBase = ((yGi % 5) * 2 + 2) % 10;
  const gongMi = gongZi >= 2 ? gongZi - 1 : gongZi + 11;
  const gongOffset = (gongMi - 1 + 12) % 12;
  const gongGi = (mGBase + gongOffset) % 10;
  return { gan: TG[gongGi], zhi: DZ[gongZi], gi: gongGi, zi: gongZi, nayin: getNaYin(gongGi, gongZi) };
}

/* 胎元：月柱天干+1，月柱地支+3
   公式：胎元天干 = 月干 + 1, 胎元地支 = 月支 + 3 */
function getTaiYuan(mGi, mZi){
  const tGi = (mGi + 1) % 10;
  const tZi = (mZi + 3) % 12;
  return { gan: TG[tGi], zhi: DZ[tZi], gi: tGi, zi: tZi, nayin: getNaYin(tGi, tZi) };
}

/* 胎息：天干=日干五合(+5)，地支=日支六合
   六合：子丑、寅亥、卯戌、辰酉、巳申、午未 */
function getTaiXi(dGi, dZi){
  const tGi = (dGi + 5) % 10;  // 天干五合
  const LIUHE = [1,0,11,10,9,8,7,6,5,4,3,2]; // 子→丑,丑→子,寅→亥,...
  const tZi = LIUHE[dZi];       // 日支六合
  return { gan: TG[tGi], zhi: DZ[tZi], gi: tGi, zi: tZi, nayin: getNaYin(tGi, tZi) };
}

/* 身宮（標準算法：與命宮互為鏡像）
   公式：身宮地支 = (月序 + 時支序 + 1) % 12
         身宮天干按年起月法推算 */
function getShenGong(yGi, mZi, hZi, mi){
  const gongZi = (mi + hZi + 1) % 12;
  const mGBase = ((yGi % 5) * 2 + 2) % 10;
  const gongMi = gongZi >= 2 ? gongZi - 1 : gongZi + 11;
  const gongOffset = (gongMi - 1 + 12) % 12;
  const gongGi = (mGBase + gongOffset) % 10;
  return { gan: TG[gongGi], zhi: DZ[gongZi], gi: gongGi, zi: gongZi, nayin: getNaYin(gongGi, gongZi) };
}
/* =============================================================
   梅花易數 MEIHUA YISHU — 完整64卦
   ============================================================= */
const BG=[
  {name:'乾',sym:'☰',nat:'天',el:'金',n:1,li:[1,1,1]},
  {name:'兌',sym:'☱',nat:'澤',el:'金',n:2,li:[1,1,0]},
  {name:'離',sym:'☲',nat:'火',el:'火',n:3,li:[1,0,1]},
  {name:'震',sym:'☳',nat:'雷',el:'木',n:4,li:[1,0,0]},
  {name:'巽',sym:'☴',nat:'風',el:'木',n:5,li:[0,1,1]},
  {name:'坎',sym:'☵',nat:'水',el:'水',n:6,li:[0,1,0]},
  {name:'艮',sym:'☶',nat:'山',el:'土',n:7,li:[0,0,1]},
  {name:'坤',sym:'☷',nat:'地',el:'土',n:8,li:[0,0,0]}
];
const G64={
'11':{n:'乾為天',u:'䷀',j:'元亨利貞。',m:'剛健中正，萬事亨通，戒驕傲。'},
'12':{n:'天澤履',u:'䷉',j:'履虍尾，不咥人，亨。',m:'小心謹慎前行，合禮則吉。'},
'13':{n:'天火同人',u:'䷌',j:'同人于重，亨。',m:'志同道合者聚集，利涉大川。'},
'14':{n:'天雷無妄',u:'䷘',j:'元亨利貞。',m:'至誠無妄，順天而行。'},
'15':{n:'天風姤',u:'䷫',j:'女壯，勿用取女。',m:'偶然相遇，不可急進。'},
'16':{n:'天水訟',u:'䷅',j:'有孚，窒。',m:'爭訟之象，宜和解退讓。'},
'17':{n:'天山遁',u:'䷠',j:'亨，小利貞。',m:'退避保身，以退為進。'},
'18':{n:'天地否',u:'䷋',j:'否之匪人。',m:'閉塞不通，守靜待時。'},
'21':{n:'澤天夬',u:'䷪',j:'揚于王庭。',m:'決斷果敢，以剛決柔。'},
'22':{n:'兌為澤',u:'䷹',j:'亨，利貞。',m:'喜悅交流，言語得宜。'},
'23':{n:'澤火革',u:'䷰',j:'己日乃孚。',m:'變革除舊，時機成熟方可行。'},
'24':{n:'澤雷隨',u:'䷐',j:'元亨利貞，無咎。',m:'順勢而行，隨機應變。'},
'25':{n:'澤風大過',u:'䷛',j:'棟撓，利有攸往。',m:'力量過大，需謹慎。'},
'26':{n:'澤水困',u:'䷮',j:'亨，貞，大人吉。',m:'困境中堅守正道，終將通達。'},
'27':{n:'澤山咸',u:'䷞',j:'亨，利貞。',m:'感應之道，心意相通。'},
'28':{n:'澤地萃',u:'䷬',j:'亨，王假有廟。',m:'聚集匯萃，利見大人。'},
'31':{n:'火天大有',u:'䷍',j:'元亨。',m:'豐收大有，光明正大。'},
'32':{n:'火澤睽',u:'䷥',j:'小事吉。',m:'乖離背反，求同存異。'},
'33':{n:'離為火',u:'䷝',j:'利貞，亨。',m:'光明附麗，依附正道。'},
'34':{n:'火雷噬嗑',u:'䷔',j:'亨，利用獄。',m:'明辨是非，果斷處理。'},
'35':{n:'火風鼎',u:'䷱',j:'元吉，亨。',m:'鼎新除舊，變革創新。'},
'36':{n:'火水未濟',u:'䷿',j:'亨，小狐汔濟。',m:'尚未完成，仍需努力。'},
'37':{n:'火山旅',u:'䷷',j:'小亨。',m:'客居在外，謹慎處世。'},
'38':{n:'火地晉',u:'䷢',j:'康侯用錫馬蕃庶。',m:'光明上進，步步晉升。'},
'41':{n:'雷天大壯',u:'䷡',j:'利貞。',m:'氣勢壯盛，守正方吉。'},
'42':{n:'雷澤歸妹',u:'䷵',j:'征凶，無攸利。',m:'安分守己，不可妄動。'},
'43':{n:'雷火豐',u:'䷶',j:'亨，王假之。',m:'豐盛之時，居安思危。'},
'44':{n:'震為雷',u:'䷲',j:'亨。',m:'震動奮發，先驚後喜。'},
'45':{n:'雷風恆',u:'䷟',j:'亨，無咎，利貞。',m:'恆久不變，守持正道。'},
'46':{n:'雷水解',u:'䷧',j:'利西南。',m:'危難解除，宜速行動。'},
'47':{n:'雷山小過',u:'䷽',j:'亨，利貞。',m:'小有遍越，微調行事。'},
'48':{n:'雷地豫',u:'䷏',j:'利建侯行師。',m:'歡樂豫悅，準備充分。'},
'51':{n:'風天小畜',u:'䷈',j:'亨，密雲不雨。',m:'力量不足，暫時蓄積。'},
'52':{n:'風澤中孚',u:'䷼',j:'豚魚吉。',m:'誠信為本，信則靈驗。'},
'53':{n:'風火家人',u:'䷤',j:'利女貞。',m:'家道昌明，各安其位。'},
'54':{n:'風雷益',u:'䷩',j:'利有攸往。',m:'損上益下，利於進取。'},
'55':{n:'巽為風',u:'䷸',j:'小亨，利有攸往。',m:'柔順漸進，以退為進。'},
'56':{n:'風水渙',u:'䷺',j:'亨，王假有廟。',m:'離散渙散，需凝聚人心。'},
'57':{n:'風山漸',u:'䷴',j:'女歸吉，利貞。',m:'循序漸進，穩步前行。'},
'58':{n:'風地觀',u:'䷓',j:'盥而不薦。',m:'觀察審視，以身作則。'},
'61':{n:'水天需',u:'䷄',j:'有孚，光亨。',m:'等待時機，耐心守候。'},
'62':{n:'水澤節',u:'䷻',j:'亨，苦節不可貞。',m:'適度節制，不可過度。'},
'63':{n:'水火既濟',u:'䷾',j:'亨小，利貞。',m:'事已成，居安思危。'},
'64':{n:'水雷屯',u:'䷂',j:'元亨利貞。',m:'創始之難，堅持終有成。'},
'65':{n:'水風井',u:'䷯',j:'改邑不改井。',m:'養民之源，不可荒廢。'},
'66':{n:'坎為水',u:'䷜',j:'有孚，維心亨。',m:'重重險難，以信心行險。'},
'67':{n:'水山蹇',u:'䷦',j:'利西南。',m:'前路艱險，退守反省。'},
'68':{n:'水地比',u:'䷇',j:'吉，卟筮元永貞。',m:'親附比和，團結互助。'},
'71':{n:'山天大畜',u:'䷙',j:'利貞，不家食吉。',m:'蓄積力量，博積薄發。'},
'72':{n:'山澤損',u:'䷨',j:'有孚，元吉。',m:'減損自己，利益他人。'},
'73':{n:'山火賁',u:'䷕',j:'亨，小利有攸往。',m:'文飾外表，不忘本質。'},
'74':{n:'山雷頤',u:'䷚',j:'貞吉，觀頤。',m:'養生之道，慍言節食。'},
'75':{n:'山風蠱',u:'䷑',j:'元亨，利涉大川。',m:'整治腐敗，撥亂反正。'},
'76':{n:'山水蒙',u:'䷃',j:'亨，匪我求童蒙。',m:'啟蒙之初，虛心學習。'},
'77':{n:'艮為山',u:'䷳',j:'艮其背，不獲其身。',m:'適可而止，靜止守分。'},
'78':{n:'山地剝',u:'䷖',j:'不利有攸往。',m:'衰落剝蝕，靜待復甦。'},
'81':{n:'地天泰',u:'䷊',j:'小往大來，吉亨。',m:'通泰和順，萬事亨通。'},
'82':{n:'地澤臨',u:'䷒',j:'元亨利貞。',m:'居高臨下，教化萬民。'},
'83':{n:'地火明夷',u:'䷣',j:'利艱貞。',m:'光明受傷，韜光養晦。'},
'84':{n:'地雷復',u:'䷗',j:'亨，出入無疾。',m:'一陽復始，否極泰來。'},
'85':{n:'地風升',u:'䷭',j:'元亨。',m:'逐步上升，積小成大。'},
'86':{n:'地水師',u:'䷆',j:'貞，丈人吉。',m:'統率眾人，以正為要。'},
'87':{n:'地山謙',u:'䷍',j:'亨，君子有終。',m:'謙虛自牧，吉無不利。'},
'88':{n:'坤為地',u:'䷁',j:'元亨，利牝馬之貞。',m:'柔順承載，博德包容。'}
};

function gByN(n){return BG[((n-1)%8+8)%8]}
function g64(un,ln){return G64[''+un+ln]||{n:'未知',u:'?',j:'',m:''}}
function gByL(l1,l2,l3){return BG.find(g=>g.li[0]===l1&&g.li[1]===l2&&g.li[2]===l3)||BG[7]}

function tiYong(ti,yo){
  if(ti===yo)return{r:'比和',f:'吉',d:'體用相同，事情順利。'};
  if(SHENG[yo]===ti)return{r:'用生體',f:'大吉',d:'外力助益，事半功倍。'};
  if(SHENG[ti]===yo)return{r:'體生用',f:'小凶',d:'耗費精力，付出多回報少。'};
  if(KE[yo]===ti)return{r:'用克體',f:'凶',d:'外力阻礙，困難重重。'};
  if(KE[ti]===yo)return{r:'體克用',f:'小吉',d:'可掌控局面，但需費力。'};
  return{r:'—',f:'平',d:''};
}

function calcMH(un,ln,dy){
  const up=gByN(un),lo=gByN(ln),dong=((dy-1)%6)+1;
  // up.n 就是數字(1-8)，直接用於 g64 查表
  const ben=g64(up.n, lo.n);
  const benL=[...lo.li,...up.li];
  const huLo=gByL(benL[1],benL[2],benL[3]);
  const huUp=gByL(benL[2],benL[3],benL[4]);
  const hu=g64(huUp.n, huLo.n);
  const biL=[...benL]; biL[dong-1]=biL[dong-1]?0:1;
  const biLo=gByL(biL[0],biL[1],biL[2]);
  const biUp=gByL(biL[3],biL[4],biL[5]);
  const bian=g64(biUp.n, biLo.n);
  const tiG=dong<=3?up:lo, yoG=dong<=3?lo:up;
  const ty=tiYong(tiG.el,yoG.el);
  return{up,lo,dong,ben,hu,bian,tiG,yoG,ty};
}

/* ═══ 梅花易數深度分析引擎 ═══
   體用關係 + 互卦過程 + 變卦走向 + 動爻 + 卦象五行生剋 */

// ═══ 月令五行旺衰表 ═══
// 春(1-3月)木旺火相土死金囚水休 | 夏(4-6月)火旺土相金死水囚木休
// 秋(7-9月)金旺水相木死火囚土休 | 冬(10-12月)水旺木相火死土囚金休
// 四季末(3,6,9,12月末18天)土旺金相水死木囚火休
function getMhWangShuai(el, month){
  if(!el||!month) return {level:'平',score:0};
  const m=typeof month==='number'?month:(new Date()).getMonth()+1;
  // 季節判定
  let season;
  if([1,2,3].includes(m)) season='spring';
  else if([4,5,6].includes(m)) season='summer';
  else if([7,8,9].includes(m)) season='autumn';
  else season='winter';
  // 四季末月土旺（簡化：3,6,9,12月）
  if([3,6,9,12].includes(m)) season='earth';

  const table={
    spring:{木:'旺',火:'相',土:'死',金:'囚',水:'休'},
    summer:{火:'旺',土:'相',金:'死',水:'囚',木:'休'},
    autumn:{金:'旺',水:'相',木:'死',火:'囚',土:'休'},
    winter:{水:'旺',木:'相',火:'死',土:'囚',金:'休'},
    earth:{土:'旺',金:'相',水:'死',木:'囚',火:'休'}
  };
  const levelScore={旺:3,相:1,休:0,囚:-1,死:-2};
  const level=table[season][el]||'平';
  return {level, score:levelScore[level]||0, season};
}

// ═══ 五行生剋關係判定 ═══
function mhRelation(elA, elB){
  if(elA===elB) return '比和';
  if(SHENG[elA]===elB) return 'A生B';
  if(SHENG[elB]===elA) return 'B生A';
  if(KE[elA]===elB) return 'A剋B';
  if(KE[elB]===elA) return 'B剋A';
  return '無';
}

// ═══ 完整梅花分析引擎（實戰派系統）═══
function analyzeMeihua(mh, type){
  if(!mh) return {score:50, analysis:null};
  const tiEl=mh.tiG.el, yoEl=mh.yoG.el;
  const tiName=mh.tiG.name, yoName=mh.yoG.name;
  const dong=mh.dong||1;
  const now=new Date();
  const curMonth=now.getMonth()+1;

  const result={
    // Step 1-2: 體用 + 生剋
    tiYong:{rel:mh.ty.r, judge:mh.ty.f, desc:mh.ty.d, tiEl, yoEl, tiName, yoName},
    // Step 3: 動爻分析
    dongYao:{pos:dong, inTi:dong<=3, desc:''},
    // Step 4: 月令旺衰
    wangShuai:{ti:null, yo:null},
    // Step 5: 互卦過程（五行生剋）
    huGua:{rel:'', tiRel:'', effect:''},
    // Step 6: 變卦結果（五行生剋）
    bianGua:{rel:'', tiRel:'', effect:''},
    // 類型特殊信號
    signals:[],
    // 時間推算
    timing:{el:'', speed:'', est:''},
    // 最終評分
    score:50,
    // 完整故事
    narrative:''
  };

  let score=50;
  const parts=[];

  // ═══ Step 1-2: 體用 + 五行生剋（權重最大）═══
  const tyScore={大吉:25,吉:15,小吉:6,平:0,小凶:-10,凶:-22};
  score+=tyScore[mh.ty.f]||0;
  parts.push(`體卦${tiName}(${tiEl})、用卦${yoName}(${yoEl})，${mh.ty.r}（${mh.ty.f}）`);

  // ═══ Step 3: 動爻位置分析 ═══
  const dongInTi=dong<=3; // 動爻1-3在下卦(體或用取決於體用定位)
  // 體在下(dong<=3時tiG=up? No: dong<=3 → tiG=up → 動在下=動在用; dong>3 → tiG=lo → 動在下=動在體)
  // 修正：看 calcMH 邏輯 → dong<=3時 tiG=up,yoG=lo → 動爻在下卦=用卦
  const dongInTiActual=(dong<=3&&mh.tiG===mh.lo)||(dong>3&&mh.tiG===mh.up);
  // 簡化：dong<=3 → 動在下卦 → tiG=up所以動在用; dong>3 → 動在上卦 → tiG=up所以動在體
  const dongSide=(dong<=3)?'用':'體';
  result.dongYao.inTi=(dongSide==='體');
  if(dongSide==='體'){
    result.dongYao.desc='動爻在體卦→你自己想改變、有主動意願';
    parts.push('動爻第'+dong+'爻（在體卦）→ 變化由你主導');
  } else {
    result.dongYao.desc='動爻在用卦→對方/環境在變、你是被動的';
    parts.push('動爻第'+dong+'爻（在用卦）→ 變化來自外在');
  }

  // ═══ Step 4: 月令旺衰 ═══
  const tiWS=getMhWangShuai(tiEl, curMonth);
  const yoWS=getMhWangShuai(yoEl, curMonth);
  result.wangShuai.ti=tiWS;
  result.wangShuai.yo=yoWS;

  // 體旺=吉加強，體衰=凶加重
  if(tiWS.level==='旺'||tiWS.level==='相'){
    score+=tiWS.score*3;
    parts.push(`${curMonth}月體卦${tiEl}行「${tiWS.level}」，體卦得令有力`);
  } else if(tiWS.level==='囚'||tiWS.level==='死'){
    score+=tiWS.score*3;
    parts.push(`${curMonth}月體卦${tiEl}行「${tiWS.level}」，體卦失令偏弱`);
  } else {
    parts.push(`${curMonth}月體卦${tiEl}行「${tiWS.level}」，力量中等`);
  }

  // ═══ Step 5: 互卦（過程）五行生剋 ═══
  if(mh.hu&&mh.hu.n){
    // 互卦的上下卦已經在 calcMH 中計算
    // 需要取互卦的體用五行 → 看互卦上下卦對體卦的生剋
    // 互卦 = g64(huUp.n, huLo.n)，但我們需要 huUp.el 和 huLo.el
    // 從卦名反查五行：用64卦名包含的經卦名來推
    const benLines=mh.ben?[...mh.lo.li,...mh.up.li]:null;
    if(benLines){
      const huLoG=gByL(benLines[1],benLines[2],benLines[3]);
      const huUpG=gByL(benLines[2],benLines[3],benLines[4]);
      if(huLoG&&huUpG){
        const huTiRel=mhRelation(tiEl, huLoG.el);
        const huYoRel=mhRelation(tiEl, huUpG.el);
        let huEffect='';
        // 互卦生體=過程中有助力
        if(huTiRel==='B生A'||huYoRel==='B生A'){
          huEffect='過程中有助力，事情會逐漸順利';
          score+=4;
        }
        // 互卦剋體=過程艱辛
        else if(huTiRel==='B剋A'||huYoRel==='B剋A'){
          huEffect='過程中有阻力，會比較辛苦';
          score-=4;
        }
        // 互卦比和=過程平穩
        else if(huTiRel==='比和'||huYoRel==='比和'){
          huEffect='過程平穩，不會有太大波折';
          score+=1;
        }
        // 體生互卦=過程耗力
        else if(huTiRel==='A生B'||huYoRel==='A生B'){
          huEffect='過程耗費精力，需要不斷投入';
          score-=2;
        }
        // 體剋互卦=過程可控
        else {
          huEffect='過程可控，但需費力推進';
        }
        result.huGua={rel:`互卦上${huUpG.name}(${huUpG.el})/下${huLoG.name}(${huLoG.el})`, tiRel:huTiRel+'/'+huYoRel, effect:huEffect};
        parts.push(`互卦「${mh.hu.n}」${huEffect}`);
      }
    }
  }

  // ═══ Step 6: 變卦（結果）五行生剋 ═══
  if(mh.bian&&mh.bian.n){
    // 變卦的上下卦五行
    const benLines2=mh.ben?[...mh.lo.li,...mh.up.li]:null;
    if(benLines2){
      const biL=[...benLines2]; biL[dong-1]=biL[dong-1]?0:1;
      const biLoG=gByL(biL[0],biL[1],biL[2]);
      const biUpG=gByL(biL[3],biL[4],biL[5]);
      if(biLoG&&biUpG){
        // 關鍵：看變卦對體卦的五行關係
        const bianTiRel=mhRelation(tiEl, biLoG.el);
        const bianYoRel=mhRelation(tiEl, biUpG.el);
        let bianEffect='';
        if(bianTiRel==='B生A'||bianYoRel==='B生A'){
          bianEffect='最終結果有利，走向好轉';
          score+=8;
        } else if(bianTiRel==='B剋A'||bianYoRel==='B剋A'){
          bianEffect='最終結果有壓力，走向不樂觀';
          score-=8;
        } else if(bianTiRel==='比和'||bianYoRel==='比和'){
          bianEffect='最終結果平穩，不好不壞';
          score+=2;
        } else if(bianTiRel==='A生B'||bianYoRel==='A生B'){
          bianEffect='最終結果耗力，付出多回收慢';
          score-=3;
        } else {
          bianEffect='最終結果可控，需持續努力';
          score+=1;
        }
        result.bianGua={rel:`變卦上${biUpG.name}(${biUpG.el})/下${biLoG.name}(${biLoG.el})`, tiRel:bianTiRel+'/'+bianYoRel, effect:bianEffect};
        parts.push(`變卦「${mh.bian.n}」→ ${bianEffect}`);
      }
    }
  }

  // ═══ 動爻爻辭（輔助參考）═══
  if(mh.ben&&mh.dong&&typeof getYaoCi==='function'){
    const yc=getYaoCi(mh.ben.n, mh.dong);
    if(yc&&!yc.includes('擴充中')){
      if(yc.includes('元吉')||yc.includes('大吉')) score+=3;
      else if(yc.includes('吉')) score+=1;
      if(yc.includes('凶')) score-=3;
      if(yc.includes('厲')) score-=1;
    }
  }

  // ═══ 類型特殊信號 ═══
  const signals=[];
  if(type==='career'){
    if(dongSide==='用') signals.push('動在用卦→公司/職場有變動，你是被動接受的一方');
    if(dongSide==='體') signals.push('動在體卦→你內心想換工作或改變方向');
    if(mh.ty.r==='用克體') signals.push('用克體→職場壓力大，有被打壓的跡象');
    if(mh.ty.r==='用生體') signals.push('用生體→有貴人助力，公司對你有利');
  } else if(type==='love'){
    if(mh.ty.r==='用生體') signals.push('用生體→對方對你有好感，主動付出');
    if(mh.ty.r==='體生用') signals.push('體生用→你付出較多，容易單戀或黏');
    if(mh.ty.r==='用克體') signals.push('用克體→感情有外在壓力或阻礙');
    if(dongSide==='用') signals.push('動在用卦→對方心思有變');
    // 變卦沖：看變卦與本卦的關係
    if(mh.bian&&mh.ben){
      const benEl1=mh.up.el, bianCheck=mh.bian.n;
      if(bianCheck.includes('睽')||bianCheck.includes('遁')) signals.push('變卦見「睽/遁」→ 有分離跡象');
    }
  } else if(type==='wealth'){
    if(mh.ty.r==='用生體') signals.push('用生體→有財來找你，偏財機會');
    if(mh.ty.r==='體生用') signals.push('體生用→花費大於收入，錢財外流');
    if(mh.ty.r==='用克體') signals.push('用克體→有破財風險，不宜冒險投資');
    if(mh.ty.r==='體克用') signals.push('體克用→可主動理財催收，但別過度');
  } else if(type==='health'){
    // 五行對應臟腑
    const organMap={木:'肝膽/神經',火:'心臟/血液/小腸',土:'脾胃/消化',金:'肺/皮膚/大腸',水:'腎/泌尿/生殖'};
    if(mh.ty.r==='用克體'){
      const organ=organMap[tiEl]||'';
      signals.push('用克體→'+tiEl+'行受剋，'+(organ?'注意'+organ+'方面':'注意身體'));
    }
    if(tiWS.level==='死'||tiWS.level==='囚'){
      signals.push('體卦失令→身體能量低，免疫力可能較差');
    }
  }
  result.signals=signals;

  // ═══ 時間推算 ═══
  const speedMap={木:'春季/農曆1-3月',火:'夏季/農曆4-6月/快',土:'四季交接/農曆3,6,9,12月末',金:'秋季/農曆7-9月',水:'冬季/農曆10-12月/慢'};
  const dongEl=(dong<=3)?mh.lo.el:mh.up.el; // 動爻所在卦的五行
  result.timing.el=dongEl;
  result.timing.speed=(dong<=2)?'快（下方動=啟動快）':(dong>=5)?'慢（上方動=後期才見效）':'中等';
  result.timing.est=speedMap[dongEl]||'';
  parts.push(`時間參考：動爻${dongEl}行，${result.timing.speed}，${result.timing.est}`);

  // ═══ 最終評分 ═══
  result.score=Math.max(10,Math.min(90,score));
  result.narrative=parts.join('。');

  return result;
}

// 向下兼容：舊的 analyzeMeihuaScore 改為包裝
function analyzeMeihuaScore(mh, type){
  const r=analyzeMeihua(mh, type);
  return r?r.score:50;
}

function guaNum(g){return g.n==='乾'?1:g.n==='兌'?2:g.n==='離'?3:g.n==='震'?4:g.n==='巽'?5:g.n==='坎'?6:g.n==='艮'?7:8}

/* ═══ 梅花易數六大項目固定五段輸出（SOP v2）═══
   體用生剋 + 動爻位置 + 互卦根因 + 變卦走向
   規則：體用判定為最高權重
   動爻 1-2=基礎/起心動念, 3-4=互動/衝突, 5=決策層/關鍵, 6=收尾/結果
   互卦=看不到的底層, 變卦=即將走到的結果
   ═══════════════════════════════════════════════════ */
function generateMeihuaStory(type, mh){
  if(!mh) return '';
  const rel=mh.ty.r||'';
  const judge=mh.ty.f||'';
  const dong=mh.dong||1;
  const tiEl=mh.tiG?mh.tiG.el:'';
  const yoEl=mh.yoG?mh.yoG.el:'';

  // 體用 → 一句話結論
  const tyConclusion={
    '用生體':'可行（外力助你）',
    '比和':'可行（內外一致）',
    '體克用':'可行但費力（你能掌控）',
    '體生用':'可但辛苦（付出多回收慢）',
    '用克體':'不利（外在壓力大）'
  }[rel]||'觀望';

  // 體用 → 誰主動
  const tyWho={
    '用生體':'外界在幫你，有貴人或機會主動來',
    '比和':'雙方力量平衡，事情順其自然',
    '體克用':'你有主導權，可以主動出擊',
    '體生用':'你一直在付出，能量往外漏',
    '用克體':'對方或環境佔優勢，你處於被動'
  }[rel]||'';

  // 動爻 → 觸發點
  const dongLayer={1:'基礎/起心動念',2:'基礎/內部條件',3:'互動/執行層',4:'互動/衝突點',5:'關鍵決策/資源/權力',6:'收尾/結果翻盤'}[dong]||'';
  const dongSide=(dong<=3)?'用卦（外在變化）':'體卦（你在改變）';

  // 互卦 → 根因
  let huCause='';
  if(mh.hu&&mh.hu.n){
    const a=analyzeMeihua(mh, type);
    if(a&&a.huGua) huCause=a.huGua.effect;
  }
  if(!huCause) huCause='過程中有變數';

  // 變卦 → 結果走向
  let bianResult='';
  if(mh.bian&&mh.bian.n){
    const a=analyzeMeihua(mh, type);
    if(a&&a.bianGua) bianResult=a.bianGua.effect;
  }
  if(!bianResult) bianResult='結果尚不明朗';

  // 互卦 vs 變卦一致性
  let consistency='';
  if(huCause.includes('有利')&&bianResult.includes('有利')) consistency='根因和走向一致偏好，準度較高';
  else if(huCause.includes('阻力')&&bianResult.includes('壓力')) consistency='根因和走向一致偏差，需認真應對';
  else consistency='根因和走向有出入，代表你的做法可以改變結果';

  // ═══ 按類型生成專用解讀 ═══
  let conclusion='', reasons=[], trigger='', actions=[], trend='';

  if(type==='love'){
    conclusion=tyConclusion;
    reasons=[
      tyWho,
      '根因：'+huCause,
      (dong>=3&&dong<=4)?'動爻在互動位→近期會有關鍵接觸或衝突':dong===5?'動爻在決策位→有人要做重要決定':dong===6?'動爻在收尾位→感情走向即將明朗':'動爻在基礎位→感覺剛開始萌芽'
    ];
    trigger='動爻第'+dong+'爻（'+dongLayer+'），變化來自'+dongSide;
    if(rel==='用生體') actions=['對方有好感，你可以適度回應','不要太主動，讓對方繼續靠近','把握近期的互動機會'];
    else if(rel==='體生用') actions=['減少主動付出，觀察對方回應','不要把全部心力放在這段關係上','給自己設一個觀察期限'];
    else if(rel==='用克體') actions=['先退一步保護自己','不要被情緒牽著走','考慮這段關係是否值得繼續'];
    else if(rel==='體克用') actions=['你有主導權，但別太強勢','主動但留空間給對方','適度示弱反而更有效'];
    else actions=['維持現狀觀察','不急著做決定','順其自然'];
    trend=bianResult+'。'+consistency;

  } else if(type==='career'){
    conclusion=tyConclusion;
    reasons=[
      tyWho,
      '隱藏結構：'+huCause,
      dong===5?'動爻在決策位→主管/資源層面有變動':dong===6?'動爻在收尾→事情即將有結論':(dong>=3&&dong<=4)?'動爻在執行位→工作流程或人事有變':'動爻在基礎位→你內心在動搖'
    ];
    trigger='動爻第'+dong+'爻（'+dongLayer+'），變化來自'+dongSide;
    if(rel==='用生體') actions=['有貴人運，多跟上級互動','把握目前的支持，趁勢推進','不要浪費目前的好機會'];
    else if(rel==='體生用') actions=['你投入太多但回報不夠','考慮是否值得繼續這樣投入','找機會跟主管談你的價值'];
    else if(rel==='用克體') actions=['職場壓力大，先自保','不要正面衝突，以退為進','悄悄準備備選方案'];
    else if(rel==='體克用') actions=['你有能力掌控，主動爭取','適度展現成果','但別太強勢引起反彈'];
    else actions=['保持現狀','觀察機會再動','不急著做大決定'];
    trend=bianResult+'。'+consistency;

  } else if(type==='wealth'){
    conclusion=tyConclusion;
    reasons=[
      tyWho,
      '真正風險：'+huCause,
      (rel==='用克體')?'錢在壓你，容易被行情或支出壓住':(rel==='用生體')?'有財來找你，偏財機會':'財務需要主動管理'
    ];
    trigger='動爻第'+dong+'爻（'+dongLayer+'），波動點在'+dongSide;
    if(rel==='用生體') actions=['有入帳機會，但不要因此冒險加碼','控制預算，把多餘的存起來','偏財可小試，不要押大'];
    else if(rel==='體生用') actions=['支出大於收入，先止血','砍掉不必要的消費','不要借錢投資'];
    else if(rel==='用克體') actions=['保守為主，不宜冒險','把現金流穩住','不要追高或情緒操作'];
    else if(rel==='體克用') actions=['可以主動理財','適度投資但設停損','不要過度自信'];
    else actions=['維持現狀','記帳控制','不做大動作'];
    trend=bianResult+'。'+consistency;
    trend+='<br><span style="font-size:.78rem;color:var(--c-text-muted)">⚠ 僅作參考，不構成投資建議</span>';

  } else if(type==='health'){
    const organMap={木:'肝膽/神經',火:'心臟/血液',土:'脾胃/消化',金:'肺/皮膚/呼吸',水:'腎/泌尿/內分泌'};
    const organ=organMap[tiEl]||'整體';
    conclusion=tyConclusion;
    reasons=[
      (rel==='用克體')?tiEl+'行受壓，注意'+organ:'身體能量'+(rel==='用生體'?'有外力支持':'需要自己維護'),
      '壓力根源：'+huCause,
      '恢復力：'+((rel==='用生體'||rel==='比和')?'不錯，身體有自癒能力':'偏弱，需要主動調整')
    ];
    trigger='動爻第'+dong+'爻（'+dongLayer+'），'+((dong<=2)?'基礎問題，跟日常習慣有關':(dong>=5)?'可能需要看醫生或做檢查':'跟生活壓力/人際互動有關');
    actions=['規律作息是最基本的',''+organ+'方面多留意','若持續不適請就醫'];
    trend=bianResult+'。'+consistency;

  } else if(type==='relationship'){
    conclusion=tyConclusion;
    reasons=[
      tyWho,
      '利益/信任結構：'+huCause,
      (rel==='用克體'&&dong>=3&&dong<=4)?'⚠ 用克體＋動在互動位→高機率口舌或翻臉，建議加條款留證據':'合作關係'+(rel==='用生體'?'對方有誠意':'需要觀察')
    ];
    trigger='動爻第'+dong+'爻（'+dongLayer+'），觸發點在'+dongSide;
    if(rel==='用生體') actions=['對方目前對你有利，但要看長期','合作可以，但要有退出機制','不要因為太順就放鬆條款'];
    else if(rel==='用克體') actions=['對方比你強勢，先穩住底線','不要急著簽約，先看清條件','加保護條款，留書面證據'];
    else if(rel==='體克用') actions=['你有談判優勢，但別壓太緊','適度讓利維持關係','以長期合作為目標'];
    else actions=['觀察對方行動','不要先開牌','保持彈性'];
    trend=bianResult+'。'+consistency;

  } else if(type==='family'){
    conclusion=tyConclusion;
    reasons=[
      (rel==='體生用')?'你一直在付出，家人可能沒感覺到':(rel==='用克體')?'家庭壓力在消耗你':'家庭能量'+(rel==='用生體'?'有支持':'需要經營'),
      '舊模式：'+huCause,
      dong===5?'動爻在主事者位→長輩或主要決策者有動態':'動爻在'+(dong<=2?'基礎':'互動')+'位→'+((dong<=2)?'問題來自日常習慣':'近期有事件觸發')
    ];
    trigger='動爻第'+dong+'爻（'+dongLayer+'），變化來自'+dongSide;
    if(rel==='用克體') actions=['先保護好自己的情緒','不要硬碰硬，換個溝通方式','設定合理的界線'];
    else if(rel==='體生用') actions=['減少無條件付出','讓家人承擔他們的責任','把能量留一些給自己'];
    else actions=['主動溝通但不要說教','找合適的時機','一次處理一件事'];
    trend=bianResult+'。'+consistency;

  } else {
    conclusion=tyConclusion;
    reasons=[tyWho,'根因：'+huCause,'動爻：'+dongLayer];
    trigger='動爻第'+dong+'爻，變化來自'+dongSide;
    actions=['觀察局勢','不急著行動','等更明確的訊號'];
    trend=bianResult+'。'+consistency;
  }

  // ═══ 組裝固定五段輸出 ═══
  let s='<strong>結論：'+conclusion+'</strong>';
  s+='<br><br>📌 <strong>關鍵原因：</strong>';
  reasons.forEach(r=>{if(r)s+='<br>• '+r;});
  s+='<br><br>⚡ <strong>最大變因：</strong>'+trigger;
  s+='<br><br>🎯 <strong>行動建議：</strong>';
  actions.forEach(a=>{s+='<br>• '+a;});
  s+='<br><br>📈 <strong>結果走向：</strong>'+trend;
  return s;
}

function renderYaoLines(lines, dong){
  let html='<div class="yao-visual">';
  for(let i=5;i>=0;i--){
    const isYang=lines[i]===1;
    const isDong=dong&&(i+1)===dong;
    html+=`<div class="yao-row${isDong?' yao-dong':''}" title="${isDong?'◀ 動爻':'第'+(i+1)+'爻'}">`;
    if(isYang) html+=`<div style="width:100%;height:4px;background:${isDong?'#e8c968':'rgba(255,255,255,0.7)'}"></div>`;
    else html+=`<div style="width:42%;height:4px;background:${isDong?'#e8c968':'rgba(255,255,255,0.7)'}"></div><div style="width:12%"></div><div style="width:42%;height:4px;background:${isDong?'#e8c968':'rgba(255,255,255,0.7)'}"></div>`;
    if(isDong) html+=`<span style="color:#e8c968;font-size:0.6rem;margin-left:4px">◀</span>`;
    html+=`</div>`;
  }
  html+='</div>';
  return html;
}

function showMH(r){
  S.meihua=r;
  // 六爻圖 + 卦名
  const benL2=[...r.lo.li,...r.up.li];
  const bianL2=[...benL2]; bianL2[r.dong-1]=bianL2[r.dong-1]?0:1;
  const huL2=[benL2[1],benL2[2],benL2[3],benL2[2],benL2[3],benL2[4]];
  document.getElementById('mh-ben-s').innerHTML=typeof renderYaoLines==='function'?renderYaoLines(benL2,r.dong):r.ben.u;
  document.getElementById('mh-ben-n').textContent=r.ben.n;
  document.getElementById('mh-hu-s').innerHTML=typeof renderYaoLines==='function'?renderYaoLines(huL2):r.hu.u;
  document.getElementById('mh-hu-n').textContent=r.hu.n;
  document.getElementById('mh-bian-s').innerHTML=typeof renderYaoLines==='function'?renderYaoLines(bianL2):r.bian.u;
  document.getElementById('mh-bian-n').textContent=r.bian.n;
  document.getElementById('mh-detail').innerHTML=`
    <p><strong>體卦：</strong>${r.tiG.name}（${r.tiG.el}）｜<strong>用卦：</strong>${r.yoG.name}（${r.yoG.el}）</p>
    <p><strong>體用：</strong><span class="tag tag-gold">${r.ty.r}</span> <span class="tag ${r.ty.f.includes('吉')?'tag-green':'tag-red'}">${r.ty.f}</span></p>
    <p class="mt-sm">${r.ty.d}</p><div class="divider"></div>
    <p><strong>卦辭：</strong>${r.ben.j}</p><p><strong>解讀：</strong>${r.ben.m}</p>
    <p><strong>動爻：</strong>第 ${r.dong} 爻</p><p class="mt-sm"><strong>變卦：</strong>${r.bian.m}</p>`;
  document.getElementById('mh-result').classList.remove('hidden');
  // 起卦成功後鎖定所有起卦按鈕
  lockMhButtons();
}
function lockMhButtons(){
  document.querySelectorAll('#mhf-time .btn, #mhf-number .btn, #mhf-char .btn, #mhf-random .btn').forEach(btn=>{
    btn.disabled=true;btn.style.opacity='0.4';btn.style.cursor='not-allowed';
  });
  const wrap=document.querySelector('#step-1 .card');
  if(wrap&&!wrap.querySelector('.mh-lock-hint')){
    const hint=document.createElement('div');
    hint.className='mh-lock-hint';
    hint.style.cssText='text-align:center;margin-top:8px;font-size:.72rem;color:var(--c-gold);opacity:.7';
    hint.innerHTML='<i class="fas fa-lock" style="margin-right:4px"></i>卦象已定，不可重複起卦';
    wrap.appendChild(hint);
  }
}

/* 漢字筆畫數（簡表） */
const BIHUA_MAP={'愛':13,'情':12,'錢':16,'財':10,'工':3,'作':7,'事':8,'業':13,'健':11,'康':11,'家':10,'庭':10,'人':2,'際':19,'運':16,'勢':13,'感':13,'婚':11,'姻':9,'學':16,'習':11,'考':6,'試':13,'升':4,'職':18,'轉':18,'天':4,'地':6,'水':4,'火':4,'木':4,'金':8,'土':3,'日':4,'月':4,'年':6,'明':8,'光':6,'華':14,'國':11,'德':15,'仁':4,'義':13,'禮':18,'信':9,'智':12,'勇':9,'忠':8,'孝':7,'志':7,'剛':10,'強':12,'建':9,'文':4,'武':8,'大':3,'小':3,'上':3,'下':3,'中':4,'高':10,'遠':17,'近':11,'安':6,'危':6,'吉':6,'凶':4,'福':14,'壽':14,'喜':12,'樂':15,'和':8,'順':12,'利':7,'祥':11,'瑞':14,'道':16,'昌':8,'盛':12,'榮':14,'富':12,'貴':12,'平':5,'春':9,'夏':10,'秋':9,'冬':5,'東':8,'西':6,'南':9,'北':5,'成':7,'功':5,'心':4,'思':9,'想':13,'意':13,'恩':10,'慈':13,'善':12,'美':9,'真':10,'靜':16,'淨':12,'清':12,'雲':12,'風':9,'雨':8,'雪':11,'花':10,'草':10,'樹':16,'海':11,'山':3,'河':9,'江':7,'湖':13,'龍':16,'鳳':14,'虎':8,'鶴':21,'馬':10,'牛':4,'羊':6,'鼠':13,'兔':8,'蛇':11,'猴':12,'雞':18,'狗':9,'豬':16};
/* ═══ 康熙字典姓名學筆畫系統（部首還原版）═══
 * 核心原則：姓名學的筆畫以康熙字典為準，部首必須「還原」為原字形。
 * 例如：氵→水(4畫)、忄→心(4畫)、艹→艸(6畫)、辶→辵(7畫)
 * 阝左(阜部)→8畫、阝右(邑部)→7畫
 */

// ═══ 部首還原映射：簡化部首 → 原字形筆畫差 ═══
// 格式：{ 簡化部首實際筆畫: 還原後筆畫 } → 差值 = 還原-實際
// 但我們直接在字表裡標記康熙筆畫，所以這個映射用於 fallback
const KANGXI_RADICAL_DIFF = {
  // 部首名, 簡化筆畫, 康熙原字筆畫, 差值
  '氵': {orig:'水', diff:1},  // 3畫→4畫 +1
  '忄': {orig:'心', diff:1},  // 3畫→4畫 +1
  '扌': {orig:'手', diff:1},  // 3畫→4畫 +1
  '犭': {orig:'犬', diff:1},  // 3畫→4畫 +1
  '艹': {orig:'艸', diff:3},  // 3畫→6畫 +3（最大地雷！）
  '衤': {orig:'衣', diff:1},  // 5畫→6畫 +1
  '礻': {orig:'示', diff:1},  // 4畫→5畫 +1
  '辶': {orig:'辵', diff:4},  // 3畫→7畫 +4
  '阝左': {orig:'阜', diff:5}, // 3畫→8畫 +5
  '阝右': {orig:'邑', diff:4}, // 3畫→7畫 +4
  '王旁': {orig:'玉', diff:1}, // 4畫→5畫 +1
  '月肉': {orig:'肉', diff:2}, // 4畫→6畫 +2
};

// 數字強制筆畫（姓名學特規：一律按數值算）
const NUM_STROKES = {'一':1,'二':2,'三':3,'四':4,'五':5,'六':6,'七':7,'八':8,'九':9,'十':10,'百':6,'千':3,'萬':15};

function kangxiStroke(ch){
  // 1. 數字強制規則
  if(NUM_STROKES[ch] !== undefined) return NUM_STROKES[ch];
  // 2. 硬編碼字表（最高優先，已手動校對）
  if(STROKE_OVERRIDE[ch]) return STROKE_OVERRIDE[ch];
  // 3. BIHUA_MAP 輔助
  if(BIHUA_MAP[ch]) return BIHUA_MAP[ch];
  // 4. CJK fallback（不精確，但比 crash 好）
  const code=ch.charCodeAt(0);
  if(code>=0x4E00&&code<=0x9FFF){
    var o=code-0x4E00,t=0x9FFF-0x4E00;
    return Math.round(4+(o/t)*16);
  }
  return 10;
}

function bihua(ch){return kangxiStroke(ch)}

function setMhMethod(m){
  ['time','number','char','random'].forEach(id=>{
    document.getElementById('mhf-'+id).classList.toggle('hidden',id!==m);
    const btn=document.getElementById('mh-m-'+id);
    if(id===m){btn.classList.remove('btn-outline');btn.classList.add('btn-tab-active')}
    else{btn.classList.add('btn-outline');btn.classList.remove('btn-tab-active')}
  });
}

/* ═══ 梅花起卦鎖定：同次占問只能起一次卦 ═══ */
function showMhLockedMsg(){
  const el=document.getElementById('mh-detail');
  if(el&&!el.querySelector('.mh-locked-msg')){
    const msg=document.createElement('div');
    msg.className='mh-locked-msg energy-locked-badge';
    msg.style.marginTop='12px';
    msg.innerHTML='<i class="fas fa-lock"></i> 卦象已定 — 同一問題不可重複起卦，心誠則靈';
    el.appendChild(msg);
  }
  const resultEl=document.getElementById('mh-result');
  if(resultEl){
    resultEl.style.transition='box-shadow .3s';
    resultEl.style.boxShadow='0 0 20px rgba(212,175,55,.4)';
    setTimeout(()=>{resultEl.style.boxShadow='';},1500);
  }
}

function calcMhTime(){
  if(S.meihua){showMhLockedMsg();return;}
  const now=new Date();
  const y=now.getFullYear(),mo=now.getMonth()+1,d=now.getDate();
  const h=now.getHours(),mi=now.getMinutes(),sec=now.getSeconds();

  // 正統梅花時間起卦（簡化版）
  // 先轉農曆（使用lunar-javascript庫）
  let lunarY=y, lunarM=mo, lunarD=d;
  try {
    if(typeof Lunar!=='undefined'&&Lunar.Solar){
      const solar=Lunar.Solar.fromYmd(y,mo,d);
      const lunar=solar.getLunar();
      lunarY=lunar.getYear(); lunarM=lunar.getMonth(); lunarD=lunar.getDay();
    }
  } catch(e){}

  // 年地支數（子1丑2...亥12）
  const yzhi=((lunarY-4)%12+12)%12+1;
  // 時辰（子1丑2...亥12）
  const shichen=Math.floor(((h+1)%24)/2)+1;

  // 上卦 = (年支+農曆月+農曆日) % 8
  const upNum=(yzhi+lunarM+lunarD)%8||8;
  // 下卦 = (年支+農曆月+農曆日+時辰) % 8
  const loNum=(yzhi+lunarM+lunarD+shichen)%8||8;
  // 動爻 = (年支+農曆月+農曆日+時辰) % 6
  const dongNum=(yzhi+lunarM+lunarD+shichen)%6||6;

  // 顯示起卦時間資訊
  const info=document.getElementById('mh-detail');

  showMH(calcMH(upNum,loNum,dongNum));

  // 在結果下追加起卦資訊
  if(info){
    const extra=document.createElement('div');
    extra.className='mt-sm text-xs text-dim';
    extra.innerHTML=`<p>起卦時間：${y}/${mo}/${d} ${h}:${String(mi).padStart(2,'0')} ｜ 農曆：${lunarM}月${lunarD}日 ｜ 時辰：第${shichen}辰</p>
      <p>上卦數：${upNum}(${['坤','乾','兌','離','震','巽','坎','艮'][upNum-1]||'?'}) ｜ 下卦數：${loNum}(${['坤','乾','兌','離','震','巽','坎','艮'][loNum-1]||'?'}) ｜ 動爻：${dongNum}</p>`;
    info.appendChild(extra);
  }
}
function calcMhNumber(){
  if(S.meihua){showMhLockedMsg();return;}
  const n1=parseInt(document.getElementById('mh-n1').value)||1;
  const n2=parseInt(document.getElementById('mh-n2').value)||1;
  const n3=parseInt(document.getElementById('mh-n3').value)||1;
  showMH(calcMH(n1,n2,Math.min(6,Math.max(1,n3))));
}
function calcMhChar(){
  if(S.meihua){showMhLockedMsg();return;}
  const ch=document.getElementById('mh-char').value.trim();
  if(!ch){alert('請輸入漢字');return}
  const chars=[...ch];
  let un,ln,dy;
  if(chars.length===1){un=bihua(chars[0]);ln=un;dy=(un*2)%6||6}
  else if(chars.length===2){un=bihua(chars[0]);ln=bihua(chars[1]);dy=(un+ln)%6||6}
  else{un=bihua(chars[0])+bihua(chars[1]);ln=bihua(chars[chars.length-1]);dy=(un+ln)%6||6}
  showMH(calcMH(un,ln,dy));
}
function calcMhRandom(){
  if(S.meihua){showMhLockedMsg();return;}
  showMH(calcMH(Math.ceil(Math.random()*8),Math.ceil(Math.random()*8),Math.ceil(Math.random()*6)));
}
/* =============================================================
   塔羅牌 TAROT — 22大牌 + 凱爾特十字牌陣
   ============================================================= */
const TAROT=[
  {id:0,n:'愚者',el:'風',up:'充滿無限可能，勇敢踏出第一步。',rv:'魯莽行事，缺乏計畫。'},
  {id:1,n:'魔術師',el:'水星',up:'擁有成功所需的一切資源。',rv:'才能未發揮，注意欺騙。'},
  {id:2,n:'女祭司',el:'月亮',up:'傾聽直覺，靜待時機。',rv:'過於封閉，忽視內心聲音。'},
  {id:3,n:'皇后',el:'金星',up:'豐收與滋養，創造力旺盛。',rv:'依賴他人，過度放縱。'},
  {id:4,n:'皇帝',el:'白羊',up:'掌控局面，建立秩序。',rv:'控制欲強，過於僵化。'},
  {id:5,n:'教皇',el:'金牛',up:'遵循正道，尋求智者指引。',rv:'教條主義，不知變通。'},
  {id:6,n:'戀人',el:'雙子',up:'做出重要選擇，真愛降臨。',rv:'關係不和，價值觀衝突。'},
  {id:7,n:'戰車',el:'巨蟹',up:'堅定意志，克服困難前進。',rv:'失捧，方向不明。'},
  {id:8,n:'力量',el:'獅子',up:'以柔克剛，內在力量強大。',rv:'自我懷疑，缺乏信心。'},
  {id:9,n:'隱者',el:'處女',up:'獨處反省，尋找內在智慧。',rv:'過度孤立，逃避現實。'},
  {id:10,n:'命運之輪',el:'木星',up:'命運轉折，好運降臨。',rv:'逆境，抗拒改變。'},
  {id:11,n:'正義',el:'天秤',up:'公正的結果，因果報應。',rv:'不公、偏見。'},
  {id:12,n:'吊人',el:'水',up:'換角度看問題，暫時犧牲。',rv:'不必要的犧牲，拖延。'},
  {id:13,n:'死神',el:'天蠍',up:'舊的結束，新的開始。',rv:'抗拒改變，停滯不前。'},
  {id:14,n:'節制',el:'射手',up:'保持中庸，調和各方。',rv:'失衡，過度。'},
  {id:15,n:'惡魔',el:'摩羯',up:'面對陰暗面，物質誘惑。',rv:'擺脫束縛，重獲自由。'},
  {id:16,n:'塔',el:'火星',up:'突然改變，舊結構崩塌。',rv:'避開災難，拒絕改變。'},
  {id:17,n:'星星',el:'水瓶',up:'希望之光，靈感湧現。',rv:'失望，缺乏信心。'},
  {id:18,n:'月亮',el:'雙魚',up:'面對恐懼，穿越迷霧。',rv:'走出迷惘，真相顯現。'},
  {id:19,n:'太陽',el:'太陽',up:'一切光明正大，喜悅成功。',rv:'短暫陰霾，信心不足。'},
  {id:20,n:'審判',el:'冥王星',up:'靈魂覺醒，重新評估。',rv:'自我懷疑，拒絕成長。'},
  {id:21,n:'世界',el:'土星',up:'達成目標，圓滿完成。',rv:'未完成，缺乏圓滿。'},
  // 小阿爾卡納 — 權杖
  {id:22,n:'權杖王牌',el:'火',up:'新計畫啟動，創造力迸發。',rv:'延遲，猶豫不決。'},
  {id:23,n:'權杖二',el:'火',up:'計畫中，等待時機。',rv:'恐懼改變，缺乏遠見。'},
  {id:24,n:'權杖三',el:'火',up:'拓展視野，合作順利。',rv:'缺乏遠見，計畫受阻。'},
  {id:25,n:'權杖四',el:'火',up:'慶祝成就，和諧穩定。',rv:'不安定，缺乏歸屬感。'},
  {id:26,n:'權杖五',el:'火',up:'競爭激烈，需堅持立場。',rv:'逃避衝突，內耗。'},
  {id:27,n:'權杖六',el:'火',up:'勝利與認可，公開成功。',rv:'自負，缺乏認可。'},
  {id:28,n:'權杖七',el:'火',up:'堅守立場，面對挑戰。',rv:'力不從心，被壓倒。'},
  {id:29,n:'權杖八',el:'火',up:'快速發展，消息到來。',rv:'延遲，急躁。'},
  {id:30,n:'權杖九',el:'火',up:'堅持到底，最後防線。',rv:'疲憊，固執。'},
  {id:31,n:'權杖十',el:'火',up:'責任沉重，堅持前行。',rv:'放下重擔，委派他人。'},
  {id:32,n:'權杖侍者',el:'火',up:'好消息，新冒險。',rv:'不切實際的計畫。'},
  {id:33,n:'權杖騎士',el:'火',up:'行動力強，追求熱情。',rv:'衝動，魯莽。'},
  {id:34,n:'權杖皇后',el:'火',up:'自信、魅力，激勵他人。',rv:'嫉妒，自我中心。'},
  {id:35,n:'權杖國王',el:'火',up:'領導力強，願景宏大。',rv:'傲慢，嚴苛。'},
  // 聖杯
  {id:36,n:'聖杯王牌',el:'水',up:'新感情開始，情感充沛。',rv:'感情封閉，錯失機會。'},
  {id:37,n:'聖杯二',el:'水',up:'伴侶關係，相互吸引。',rv:'失衡，溝通不良。'},
  {id:38,n:'聖杯三',el:'水',up:'歡慶友誼，社交活動。',rv:'過度放縱，孤立。'},
  {id:39,n:'聖杯四',el:'水',up:'對現狀不滿，錯失機會。',rv:'重新審視，發現新可能。'},
  {id:40,n:'聖杯五',el:'水',up:'失落與悲傷，但仍有希望。',rv:'走出悲傷，接受現實。'},
  {id:41,n:'聖杯六',el:'水',up:'懷舊，童年回憶。',rv:'活在過去，無法前進。'},
  {id:42,n:'聖杯七',el:'水',up:'太多選擇，需分辨幻象。',rv:'做出決定，面對現實。'},
  {id:43,n:'聖杯八',el:'水',up:'離開不再適合的，尋找更深。',rv:'恐懼改變，留在舒適區。'},
  {id:44,n:'聖杯九',el:'水',up:'願望實現，滿足感。',rv:'不滿，物質主義。'},
  {id:45,n:'聖杯十',el:'水',up:'情感圓滿，家庭幸福。',rv:'家庭問題，不和諧。'},
  {id:46,n:'聖杯侍者',el:'水',up:'浪漫訊息，直覺發展。',rv:'情緒不穩，不成熟。'},
  {id:47,n:'聖杯騎士',el:'水',up:'浪漫追求者，感性行動。',rv:'情緒化，不切實際。'},
  {id:48,n:'聖杯皇后',el:'水',up:'慈愛，情感豐富，直覺強。',rv:'情緒化，過度付出。'},
  {id:49,n:'聖杯國王',el:'水',up:'情感成熟，慷慨智慧。',rv:'情感壓抑，操捧。'},
  // 寶劍
  {id:50,n:'寶劍王牌',el:'風',up:'真相與突破，新想法。',rv:'混亂思緒，錯誤判斷。'},
  {id:51,n:'寶劍二',el:'風',up:'抉擇困難，需平衡思考。',rv:'資訊過載，逃避決定。'},
  {id:52,n:'寶劍三',el:'風',up:'心碍，悲痛，需要療癒。',rv:'走出傷痛，開始復卟。'},
  {id:53,n:'寶劍四',el:'風',up:'休息恢復，靜養。',rv:'焦躁不安，不願休息。'},
  {id:54,n:'寶劍五',el:'風',up:'衝突與失敗，自私行為。',rv:'和解，學會認輸。'},
  {id:55,n:'寶劍六',el:'風',up:'離開困境，過渡期。',rv:'困住，無法離開。'},
  {id:56,n:'寶劍七',el:'風',up:'策略行動，但需注意欺騙。',rv:'真相揭露，良心不安。'},
  {id:57,n:'寶劍八',el:'風',up:'自我限制，困境是心造。',rv:'解脫束縛，看清真相。'},
  {id:58,n:'寶劍九',el:'風',up:'焦慮、恐懼、失眠。',rv:'面對恐懼，走出焦慮。'},
  {id:59,n:'寶劍十',el:'風',up:'結束與放下，觸底反彈。',rv:'最壞已過，開始恢復。'},
  {id:60,n:'寶劍侍者',el:'風',up:'好奇心，新想法。',rv:'八卦，冷漠。'},
  {id:61,n:'寶劍騎士',el:'風',up:'思路清晰，快速行動。',rv:'衝動發言，缺乏同理。'},
  {id:62,n:'寶劍皇后',el:'風',up:'獨立思考，真相。',rv:'冷酷，過於理性。'},
  {id:63,n:'寶劍國王',el:'風',up:'理性權威，公正判斷。',rv:'獨裁，冷酷無情。'},
  // 金幣
  {id:64,n:'金幣王牌',el:'土',up:'新財務機會，物質豐盛。',rv:'錯失良機，貪婪。'},
  {id:65,n:'金幣二',el:'土',up:'平衡，適應變化。',rv:'失衡，優先順序混亂。'},
  {id:66,n:'金幣三',el:'土',up:'團隊合作，技能提升。',rv:'缺乏協作，品質不佳。'},
  {id:67,n:'金幣四',el:'土',up:'守財，安全感。',rv:'過度吝嗇，恐懼失卻。'},
  {id:68,n:'金幣五',el:'土',up:'困難時期，物質匱乏。',rv:'走出困境，援助到來。'},
  {id:69,n:'金幣六',el:'土',up:'慷慨，施與受的平衡。',rv:'債務，單方面付出。'},
  {id:70,n:'金幣七',el:'土',up:'耐心等待收獲。',rv:'急躁，缺乏耐心。'},
  {id:71,n:'金幣八',el:'土',up:'精進技藝，專注投入。',rv:'缺乏熱情，敷衍了事。'},
  {id:72,n:'金幣九',el:'土',up:'豐收，自給自足。',rv:'過度自足，財務風險。'},
  {id:73,n:'金幣十',el:'土',up:'家族財富，長久穩定。',rv:'家庭財務問題。'},
  {id:74,n:'金幣侍者',el:'土',up:'學習機會，務實目標。',rv:'缺乏方向，浪費資源。'},
  {id:75,n:'金幣騎士',el:'土',up:'穩健前進，有效率。',rv:'固執，過度保守。'},
  {id:76,n:'金幣皇后',el:'土',up:'富足，安全，實際。',rv:'不安全感，過度物質。'},
  {id:77,n:'金幣國王',el:'土',up:'財務成功，領導力。',rv:'貪婪，過度控制。'}
];

/* ═══════════════════════════════════════════════════════════════
   金色黎明（Golden Dawn）十字牌陣 — 標準化解讀系統 v2
   四大加權模組：元素尊卑 / 占星 / 宮廷牌 / 牌面結構
   核心規則：2(阻礙)/3(根因)/8(外界) 優先權最高
   ═══════════════════════════════════════════════════════════════ */

// ── 位置權重：2/3/8 最高 ──
const GD_POS_WEIGHT=[3,3.5,3.5,1.5,1.5,2.5,2,3.5,2,3.5];
const GD_POS_ROLE=['present','obstacle','root','past','crown','near','self','environ','hope_fear','outcome'];

// ── B-1. 元素尊卑（Elemental Dignities）──
const GD_ELEMENT_MAP={
  '火':'fire','水':'water','風':'air','土':'earth',
  '白羊':'fire','獅子':'fire','射手':'fire',
  '巨蟹':'water','天蠍':'water','雙魚':'water',
  '雙子':'air','天秤':'air','水瓶':'air',
  '金牛':'earth','處女':'earth','摩羯':'earth',
  '火星':'fire','太陽':'fire','月亮':'water','冥王星':'water',
  '水星':'air','天王星':'air','金星':'earth','土星':'earth','木星':'fire','海王星':'water'
};
function gdGetEl(card){return GD_ELEMENT_MAP[card.el]||'neutral';}
function gdED(a,b){
  if(a===b)return 1;
  if((a==='fire'&&b==='water')||(a==='water'&&b==='fire'))return -1;
  if((a==='air'&&b==='earth')||(a==='earth'&&b==='air'))return -1;
  if((a==='fire'&&b==='air')||(a==='air'&&b==='fire'))return 0.5;
  if((a==='water'&&b==='earth')||(a==='earth'&&b==='water'))return 0.5;
  return 0;
}
const GD_NEIGHBORS={0:[1,2],1:[0,2],2:[0,1],3:[0,5],4:[0,8],5:[0,3,9],6:[7],7:[6],8:[4,9],9:[5,8]};
function gdCalcED(drawn){
  return drawn.slice(0,10).map((c,i)=>{
    const my=gdGetEl(c);let s=0;
    (GD_NEIGHBORS[i]||[]).forEach(j=>{if(drawn[j])s+=gdED(my,gdGetEl(drawn[j]));});
    return s;
  });
}

// ── B-2. 宮廷牌角色 ──
function gdIsCourt(c){const m=c.id>=22?(c.id-22)%14:-1;return m>=10&&m<=13;}
function gdCourtRole(c){
  if(!gdIsCourt(c))return null;
  const m=(c.id-22)%14;
  const r={10:'學習者/訊息者',11:'行動者/追求者',12:'滋養者/掌控者',13:'權威/決策者'};
  const s={fire:'行動型',water:'情感型',air:'思考型',earth:'務實型'};
  return(r[m]||'')+'・'+(s[gdGetEl(c)]||'');
}

// ── B-3. 牌面結構分析 ──
function gdStructure(drawn){
  const d=drawn.slice(0,10);
  let mj=0,wn=0,cp=0,sw=0,pn=0,ct=0;
  d.forEach(c=>{
    if(c.id<=21)mj++;else if(c.id<=35)wn++;else if(c.id<=49)cp++;else if(c.id<=63)sw++;else pn++;
    if(gdIsCourt(c))ct++;
  });
  const ins=[];
  if(mj>=5)ins.push('大牌過半 — 命運層級的議題');else if(mj>=3)ins.push('大牌偏多 — 有結構性因素影響');
  if(wn>=3)ins.push('權杖多 — 核心在行動/衝動');
  if(cp>=3)ins.push('聖杯多 — 核心在情緒/關係');
  if(sw>=3)ins.push('寶劍多 — 核心在壓力/衝突');
  if(pn>=3)ins.push('金幣多 — 核心在金錢/現實');
  if(ct>=3)ins.push('宮廷牌多 — 人際角色是關鍵');
  const up=d.filter(c=>c.isUp).length;
  if(up>=8)ins.push('正位牌佔多數 — 能量順暢');
  else if(up<=3)ins.push('逆位牌佔多數 — 內在阻力明顯');
  return{majorCount:mj,wandCount:wn,cupCount:cp,swordCount:sw,pentCount:pn,courtCount:ct,uprightCount:up,insights:ins};
}

// ── C. 主分析函數 ──
function analyzeTarotSpread(drawn, type){
  if(!drawn||drawn.length<10) return{score:50,insights:[],summary:'',keyCards:{},gdAnalysis:null};
  const d=drawn.slice(0,10);
  const keyCards={present:d[0],obstacle:d[1],root:d[2],past:d[3],crown:d[4],near:d[5],self:d[6],environ:d[7],hope_fear:d[8],outcome:d[9]};

  const edScores=gdCalcED(d);
  const structure=gdStructure(d);

  const CP={};
  [0,1,3,6,8,10,14,17,19,21].forEach(id=>{CP[id]=1;});
  [13,15,16,18].forEach(id=>{CP[id]=-1;});
  [2,5,7,9,11,12,20].forEach(id=>{CP[id]=0;});
  CP[22]=1;CP[24]=1;CP[27]=1;CP[28]=1;CP[35]=1;CP[26]=-1;CP[31]=-1;
  CP[36]=1;CP[37]=1;CP[38]=1;CP[39]=1;CP[44]=1;CP[45]=1;CP[41]=-1;CP[43]=-1;
  CP[50]=1;CP[56]=1;CP[52]=-1;CP[53]=-1;CP[55]=-1;CP[57]=-1;CP[58]=-1;CP[59]=-1;
  CP[64]=1;CP[66]=1;CP[68]=1;CP[72]=1;CP[73]=1;CP[77]=1;CP[69]=-1;

  let totalScore=0;
  const insights=[];

  d.forEach((c,i)=>{
    const w=GD_POS_WEIGHT[i];
    const pol=CP[c.id]||0;
    const ed=edScores[i]||0;
    let cs=0;
    if(c.isUp){cs=pol>=0?(1+pol*0.5):(-0.5);}
    else{if(pol>0)cs=-0.3;if(pol<0)cs=0.4;if(pol===0)cs=-0.5;}
    cs+=ed*0.3;
    totalScore+=cs*w;

    if(w>=2.5){
      const meaning=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(c.id,c.isUp,type):(c.isUp?c.up:c.rv);
      insights.push({pos:CELTIC_POS[i],card:c.n,dir:c.isUp?'正位':'逆位',meaning:meaning||'',score:cs*w,role:GD_POS_ROLE[i],edScore:ed,court:gdCourtRole(c)});
    }
  });

  const score=Math.max(10,Math.min(90,Math.round(50+totalScore*2.2)));
  const _gtm=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning:function(id,up){return '';};
  const obM=_gtm(d[1].id,d[1].isUp,type)||(d[1].isUp?d[1].up:d[1].rv);
  const rootM=_gtm(d[2].id,d[2].isUp,type)||(d[2].isUp?d[2].up:d[2].rv);
  const envM=_gtm(d[7].id,d[7].isUp,type)||(d[7].isUp?d[7].up:d[7].rv);
  const outM=_gtm(d[9].id,d[9].isUp,type)||(d[9].isUp?d[9].up:d[9].rv);

  let summary='';
  if(d[9].isUp&&(CP[d[9].id]||0)>=0)summary+='整體走向正面。';
  else if(!d[9].isUp&&(CP[d[9].id]||0)<=0)summary+='需要特別留意風險。';
  else summary+='走向尚有變數。';

  return{score,insights,summary,keyCards,totalScore,
    gdAnalysis:{edScores,structure,courtRoles:d.map(c=>gdCourtRole(c)),
    priorityCards:{obstacle:obM,root:rootM,environ:envM,outcome:outM}}};
}

// ── D. 六大項目固定五段輸出 ──
function generateTarotStory(type,drawn){
  if(!drawn||drawn.length<10)return '';
  const d=drawn;
  function _m(i){const c=d[i];if(!c)return '';const t=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(c.id,c.isUp,type):null;return t||(c.isUp?c.up:c.rv)||'';}
  const struct=gdStructure(d);
  const ob=_m(1),root=_m(2),env=_m(7),self=_m(6),near=_m(5),out=_m(9);
  const envCt=gdCourtRole(d[7]);
  const outUp=d[9].isUp;

  let conclusion='',reasons=[],nearEvent='',actions=[],trend='';

  if(type==='love'){
    conclusion=outUp&&d[0].isUp?'可成局':outUp||d[5].isUp?'可進展但慢':'不建議投入';
    reasons=['卡點：'+ob,'真正原因：'+root,(envCt?'對方（'+envCt+'）：':'外在：')+env];
    nearEvent=near;
    actions=['你的狀態：'+self,'近期：'+(d[5].isUp?'可以主動一點':'先觀察再動'),d[8].isUp?'信任直覺':'先處理內心恐懼'];
    trend=outUp?'感情會有進展。'+out:'可能停滯。'+out;
  } else if(type==='career'){
    conclusion=outUp&&d[0].isUp?'適合行動':outUp||d[5].isUp?'先準備再出手':'不建議大動作';
    reasons=['主要障礙：'+ob,'真正驅動你的：'+root,'外部環境：'+env];
    nearEvent=near;
    actions=['你該補的：'+self,d[5].isUp?'近期有窗口，準備好出手':'先穩住，不急',d[8].isUp?'方向是對的':'放下對失敗的恐懼'];
    trend=outUp?'事業走向正面。'+out:'有風險要注意。'+out;
  } else if(type==='wealth'){
    conclusion=outUp&&d[0].isUp?'正財有利':d[5].isUp?'短期有機會，要謹慎':'守財為主';
    reasons=['財務卡點：'+ob,'投資心態：'+root,'市場環境：'+env];
    nearEvent=near;
    actions=['理財態度：'+self,d[5].isUp?'近期有機會，控制預算':'先止血',d[8].isUp?'別被怕錯過驅動':'控制恐懼'];
    trend=outUp?'財運向上。'+out:'保守應對。'+out;
  } else if(type==='health'){
    conclusion=outUp?'身心會好轉':d[5].isUp?'需主動調整':'建議儘快處理';
    reasons=['障礙：'+ob,'壓力根源：'+root,'環境因素：'+env];
    nearEvent=near;
    actions=['你能做的：'+self,d[5].isUp?'正在恢復，配合休息':'症狀可能反覆，規律作息是關鍵','若持續不適請就醫'];
    trend=outUp?'趨勢好轉。'+out:'需積極處理。'+out;
  } else if(type==='relationship'){
    conclusion=outUp&&d[0].isUp?'可合作':outUp?'可以但要加條件':'不建議深入';
    reasons=['主要問題：'+ob,'對方目的：'+root,(envCt?'關鍵人物（'+envCt+'）：':'外部：')+env];
    nearEvent=near;
    actions=['你的定位：'+self,d[5].isUp?'談判窗口在近期':'先觀察對方',d[8].isUp?'堅持底線':'別因怕撕破臉讓步太多'];
    trend=outUp?'合作正面。'+out:'有風險。'+out;
  } else if(type==='family'){
    conclusion=outUp?'關係可修復':d[5].isUp?'需主動溝通':'需要時間和距離';
    reasons=['衝突點：'+ob,'情緒核心：'+root,'家人影響：'+env];
    nearEvent=near;
    actions=['你的角色：'+self,d[5].isUp?'近期有修復窗口':'先給空間',d[8].isUp?'期盼方向是對的':'先放下被理解的執念'];
    trend=outUp?'家庭會好轉。'+out:'需更多耐心。'+out;
  } else {
    conclusion=outUp?'整體正面':d[5].isUp?'有機會但需努力':'建議謹慎';
    reasons=['卡點：'+ob,'根本原因：'+root,'外在：'+env];
    nearEvent=near;
    actions=['你的狀態：'+self,d[5].isUp?'近期有正面發展':'近期需穩住',d[8].isUp?'信任方向':'先處理不安'];
    trend=outUp?'趨勢正面。'+out:'需調整策略。'+out;
  }

  let s='<strong>結論：'+conclusion+'</strong>';
  // ★ 牌陣連動敘述（條件因果句型）
  const currentCard=d[0], obstacleCard=d[1], rootCard=d[2], futureCard=d[5], resultCard=d[9];
  const currentM=_m(0), obstM=_m(1), rootM=_m(2), futM=_m(5), resM=_m(9);
  s+='<br><br>🔗 <strong>因果脈絡：</strong>';
  s+=`雖然目前${currentCard.n}（${currentCard.isUp?'正':'逆'}位）顯示${currentM.slice(0,15)}…，`;
  s+=`但受到${obstacleCard.n}（${obstM.slice(0,12)}…）的影響，`;
  s+=`只要${futureCard.isUp?'順著'+futureCard.n+'正位的能量（'+futM.slice(0,12)+'…）向前推進':'正視'+futureCard.n+'帶來的課題'}，`;
  s+=`最終將${resultCard.isUp?'迎來'+resultCard.n+'正位的正面結局（'+resM.slice(0,15)+'…）':'需要更多時間調整（'+resM.slice(0,15)+'…）'}。`;
  s+='<br><br>📌 <strong>關鍵原因：</strong>';
  reasons.forEach(r=>{s+='<br>• '+r;});
  s+='<br><br>📅 <strong>近期走向：</strong>'+nearEvent;
  s+='<br><br>🎯 <strong>你該做什麼：</strong>';
  actions.forEach(a=>{s+='<br>• '+a;});
  s+='<br><br>📈 <strong>結果趨勢：</strong>'+trend;
  if(struct.insights.length>0) s+='<br><br><span style="font-size:.82rem;color:var(--c-text-dim)">✦ '+struct.insights[0]+'</span>';
  if(type==='wealth') s+='<br><span style="font-size:.78rem;color:var(--c-text-muted)">⚠ 僅作參考，不構成投資建議</span>';
  if(type==='health') s+='<br><span style="font-size:.78rem;color:var(--c-text-muted)">⚠ 此分析僅為能量狀態指引，實際生理狀況與醫療決策請務必以專業醫師診斷為主。</span>';
  return s;
}

const CELTIC_POS=['現況核心','阻礙／交叉因素','根因／底層動機','已發生／近期過去','顯性目標／意識層','近期走向','你的位置','外界／環境','希望與恐懼','結果／趨勢'];

let drawnCards=[];
let deckShuffled=[];
let pickAnimating=false;

/* ═══ 塔羅鎖定顯示：同一天同人同問題，牌陣已定 ═══ */
function showTarotLocked(){
  // 填入凱爾特十字牌位
  const chosen=document.getElementById('t-chosen');
  const posLabels=CELTIC_POS;
  chosen.innerHTML=`
    <div class="celtic-cross">
      <div class="tarot-chosen-slot cc-5 filled" id="t-slot-4"><span class="slot-num">5</span></div>
      <div class="tarot-chosen-slot cc-4 filled" id="t-slot-3"><span class="slot-num">4</span></div>
      <div class="tarot-chosen-slot cc-1 filled" id="t-slot-0"><span class="slot-num">1</span></div>
      <div class="tarot-chosen-slot cc-2 filled" id="t-slot-1"><span class="slot-num">2</span></div>
      <div class="tarot-chosen-slot cc-6 filled" id="t-slot-5"><span class="slot-num">6</span></div>
      <div class="tarot-chosen-slot cc-3 filled" id="t-slot-2"><span class="slot-num">3</span></div>
    </div>
    <div class="celtic-staff">
      <div class="tarot-chosen-slot filled" id="t-slot-9"><span class="slot-num">10</span></div>
      <div class="tarot-chosen-slot filled" id="t-slot-8"><span class="slot-num">9</span></div>
      <div class="tarot-chosen-slot filled" id="t-slot-7"><span class="slot-num">8</span></div>
      <div class="tarot-chosen-slot filled" id="t-slot-6"><span class="slot-num">7</span></div>
    </div>`;
  // 顯示已抽到的牌面
  drawnCards.forEach((c,i)=>{
    const slotEl=document.getElementById('t-slot-'+i);
    if(!slotEl)return;
    const isCard2=(i===1);
    const imgSrc=typeof getTarotCardImage==='function'?getTarotCardImage(c):'';
    slotEl.innerHTML=`<div class="tarot-reveal flipping" style="${isCard2?'transform:rotate(-90deg)':''}">
      <div class="tarot-reveal-inner">
        <div class="tarot-reveal-back"></div>
        <div class="tarot-reveal-front">
          ${imgSrc?`<img src="${imgSrc}" class="tc-img" style="${c.isUp?'':'transform:rotate(180deg)'}">`:``}
          <span class="tc-name" style="${c.isUp?'':'transform:rotate(180deg)'}">${c.n}</span>
          <span class="tc-dir ${c.isUp?'up':'rv'}">${c.isUp?'正位':'逆位'}</span>
        </div>
      </div>
    </div>${!isCard2?'<span class="slot-label">'+(c.pos||posLabels[i])+'</span>':''}`;
  });
  // 隱藏牌堆，顯示鎖定訊息
  const deckEl=document.getElementById('t-deck');
  deckEl.innerHTML='<div class="energy-locked-badge" style="margin:1rem auto;text-align:center"><i class="fas fa-lock"></i> 牌陣已定 — 同日同問題不可重複抽牌，心誠則靈</div>';
  // 隱藏抽牌提示
  const hint=document.getElementById('pick-hint');
  if(hint) hint.style.display='none';
  // 啟用分析按鈕
  const btn=document.getElementById('btn-analyze');
  if(btn) btn.disabled=false;
  // 更新計數
  const countEl=document.getElementById('t-remain-picked');
  if(countEl) countEl.textContent='10';
  // 顯示展開區
  S.tarot.drawn=drawnCards;
  S.tarot.spread=drawnCards;
  showSpread();
}

function initTarotDeck(){
  // ═══ 塔羅鎖定：如果已有10張牌（來自快取），顯示鎖定狀態 ═══
  if(drawnCards.length>=10){
    showTarotLocked();
    return;
  }
  // Shuffle all 78 cards — seeded if form data available
  if(S.form&&S.form.bdate&&S.form.gender&&S.form.type){
    const _rng=makeSeededRng(S.form.bdate,S.form.gender,S.form.type,S.form.question);
    deckShuffled=seededShuffle(TAROT,_rng);
  } else {
    deckShuffled=[...TAROT].sort(()=>Math.random()-0.5);
  }
  drawnCards=[];
  pickAnimating=false;

  // Render celtic cross layout (left: cross 6, right: staff 4)
  const chosen=document.getElementById('t-chosen');
  const posLabels=CELTIC_POS;
  chosen.innerHTML=`
    <div class="celtic-cross">
      <div class="tarot-chosen-slot cc-5" id="t-slot-4"><span class="slot-num">5</span><span class="slot-label">${posLabels[4]}</span></div>
      <div class="tarot-chosen-slot cc-4" id="t-slot-3"><span class="slot-num">4</span><span class="slot-label">${posLabels[3]}</span></div>
      <div class="tarot-chosen-slot cc-1" id="t-slot-0"><span class="slot-num">1</span><span class="slot-label">${posLabels[0]}</span></div>
      <div class="tarot-chosen-slot cc-2" id="t-slot-1"><span class="slot-num">2</span><span class="slot-label">${posLabels[1]}</span></div>
      <div class="tarot-chosen-slot cc-6" id="t-slot-5"><span class="slot-num">6</span><span class="slot-label">${posLabels[5]}</span></div>
      <div class="tarot-chosen-slot cc-3" id="t-slot-2"><span class="slot-num">3</span><span class="slot-label">${posLabels[2]}</span></div>
    </div>
    <div class="celtic-staff">
      <div class="tarot-chosen-slot" id="t-slot-9"><span class="slot-num">10</span><span class="slot-label">${posLabels[9]}</span></div>
      <div class="tarot-chosen-slot" id="t-slot-8"><span class="slot-num">9</span><span class="slot-label">${posLabels[8]}</span></div>
      <div class="tarot-chosen-slot" id="t-slot-7"><span class="slot-num">8</span><span class="slot-label">${posLabels[7]}</span></div>
      <div class="tarot-chosen-slot" id="t-slot-6"><span class="slot-num">7</span><span class="slot-label">${posLabels[6]}</span></div>
    </div>`;

  // Render scrollable deck — ALL 78 cards
  const deckEl=document.getElementById('t-deck');
  const showCount=deckShuffled.length;
  deckEl.innerHTML='';
  for(let i=0;i<showCount;i++){
    const card=deckShuffled[i];
    const el=document.createElement('div');
    el.className='tarot-deck-card';
    el.dataset.idx=i;
    el.innerHTML='<div class="tarot-deck-card-inner"></div>';
    el.addEventListener('click',()=>pickCard(i,el));
    deckEl.appendChild(el);
  }
  // Random glow on 2-3 cards for mystical effect
  setTimeout(()=>{
    const cards=deckEl.querySelectorAll('.tarot-deck-card');
    const glowIdxs=new Set();
    while(glowIdxs.size<3&&glowIdxs.size<cards.length){glowIdxs.add(Math.floor(Math.random()*cards.length));}
    glowIdxs.forEach(gi=>{
      setTimeout(()=>{cards[gi].classList.add('glow');setTimeout(()=>cards[gi].classList.remove('glow'),1500)},Math.random()*3000);
    });
  },500);

  document.getElementById('t-remain-picked').textContent='0';
  document.getElementById('btn-analyze').disabled=true;
}

function pickCard(deckIdx,deckEl){
  if(pickAnimating||drawnCards.length>=10||deckEl.classList.contains('picked'))return;
  pickAnimating=true;

  const card=deckShuffled[deckIdx];
  // Seeded: 同張牌在同人同天=同正逆位
  let isUp;
  if(S.form&&S.form.bdate&&S.form.gender&&S.form.type){
    const _r=makeSeededRng(S.form.bdate,S.form.gender,S.form.type,S.form.question);
    for(let _k=0;_k<=card.id;_k++) _r();
    isUp=_r()>0.35;
  } else { isUp=Math.random()>0.35; }
  const slotIdx=drawnCards.length;
  const pos=CELTIC_POS[slotIdx];

  // Mark deck card as picked
  deckEl.classList.add('picked');

  // Get positions for fly animation
  const deckRect=deckEl.getBoundingClientRect();
  const slotEl=document.getElementById('t-slot-'+slotIdx);
  const slotRect=slotEl.getBoundingClientRect();

  // Create flying card
  const fly=document.createElement('div');
  fly.className='tarot-fly-card';
  fly.style.left=deckRect.left+'px';
  fly.style.top=deckRect.top+'px';
  fly.style.width=deckRect.width+'px';
  fly.style.height=deckRect.height+'px';
  document.body.appendChild(fly);

  // Animate fly to slot
  requestAnimationFrame(()=>{
    fly.style.left=slotRect.left+'px';
    fly.style.top=slotRect.top+'px';
    fly.style.width=slotRect.width+'px';
    fly.style.height=slotRect.height+'px';
  });

  // After fly animation, place reveal card in slot
  setTimeout(()=>{
    fly.remove();
    slotEl.classList.add('filled');
    const drawnCard={...card,isUp,pos};
    const imgSrc=typeof getTarotCardImage==='function'?getTarotCardImage(drawnCard):'';
    const isCard2=(slotIdx===1); // Card 2 is横放

    // Place card face-down in slot, then flip
    slotEl.innerHTML=`<div class="tarot-reveal" id="t-rev-${slotIdx}" style="${isCard2?'transform:rotate(-90deg)':''}">
      <div class="tarot-reveal-inner">
        <div class="tarot-reveal-back"></div>
        <div class="tarot-reveal-front">
          ${imgSrc?`<img src="${imgSrc}" class="tc-img" style="${isUp?'':'transform:rotate(180deg)'}">`:``}
          <span class="tc-name" style="${isUp?'':'transform:rotate(180deg)'}">${card.n}</span>
          <span class="tc-dir ${isUp?'up':'rv'}">${isUp?'正位':'逆位'}</span>
        </div>
      </div>
    </div>${!isCard2?'<span class="slot-label">'+pos+'</span>':''}`;

    // Flip after short delay
    setTimeout(()=>{
      document.getElementById('t-rev-'+slotIdx).classList.add('flipping');
    },200);

    drawnCards.push(drawnCard);
    document.getElementById('t-remain-picked').textContent=drawnCards.length;

    if(drawnCards.length>=10){
      document.getElementById('btn-analyze').disabled=false;
      document.getElementById('pick-hint').style.display='none';
      S.tarot.drawn=drawnCards;
      S.tarot.spread=drawnCards;
      showSpread();
    }

    pickAnimating=false;
  },550);
}

function drawCard(){
  if(drawnCards.length>=10){showTarotLocked();return;}
  // Legacy compat: auto-pick from deck
  const deckEl=document.querySelector('.tarot-deck-card:not(.picked)');
  if(deckEl) pickCard(parseInt(deckEl.dataset.idx),deckEl);
}
function autoDraw(){
  // 塔羅鎖定檢查
  if(drawnCards.length>=10){showTarotLocked();return;}
  // Init deck if not yet
  if(!deckShuffled.length) initTarotDeck();
  if(drawnCards.length>=10) return; // initTarotDeck may have triggered lock
  // Quick draw all remaining — 每張間隔需 > pickAnimating 鎖定時間(550ms)
  const remaining=10-drawnCards.length;
  let delay=0;
  for(let i=0;i<remaining;i++){
    setTimeout(()=>{
      const deckEl=document.querySelector('.tarot-deck-card:not(.picked)');
      if(deckEl) pickCard(parseInt(deckEl.dataset.idx),deckEl);
    },delay);
    delay+=620;
  }
}

function renderDrawn(){
  // Now handled by pickCard directly
}

/* Legacy compat: old t-hand and t-remain */
Object.defineProperty(document.getElementById('t-remain-picked')||document.createElement('span'),'__legacy',{get:function(){return drawnCards.length}});

function showSpread(){
  S.tarot.drawn=drawnCards;
  S.tarot.spread=drawnCards;
  document.getElementById('t-spread-sec').classList.remove('hidden');
  const el=document.getElementById('t-spread');
  el.innerHTML=drawnCards.map((c,i)=>{
    const imgSrc=typeof getTarotCardImage==='function'?getTarotCardImage(c):'';
    return `
    <div class="card" style="padding:var(--sp-md);margin-bottom:var(--sp-sm)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-xs)">
        <span class="tag tag-gold">${i+1}. ${c.pos}</span>
        <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'正位':'逆位'}</span>
      </div>
      <div style="display:flex;gap:var(--sp-md);align-items:flex-start">
        ${imgSrc?`<img src="${imgSrc}" alt="${c.n}" class="tc-spread-img" style="width:72px;height:112px;border-radius:6px;flex-shrink:0;${c.isUp?'':'transform:rotate(180deg)'}">`:``}
        <div>
          <strong class="text-gold serif">${c.n}</strong>
          <p class="text-sm text-dim mt-sm">${c.isUp?c.up:c.rv}</p>
        </div>
      </div>
    </div>`;
  }).join('');
}
/* =============================================================
   RENDER FUNCTIONS — 結果頁渲染
   ============================================================= */
function showDim(id){
  document.querySelectorAll('.dim-tab').forEach((t,i)=>{
    const tabIds=['bazi','ziwei','natal','meihua','tarot','name'];
    t.classList.toggle('active',tabIds[i]===id);
  });
  document.querySelectorAll('.dim-pane').forEach(p=>p.classList.toggle('active',p.id==='pane-'+id));
}

function renderBazi(){
  const b=S.bazi; if(!b)return;
  const p=b.pillars;
  const labels=['時柱','日柱','月柱','年柱'];
  const cols=['hour','day','month','year'];

  // 四柱表格
  let html='<div class="bazi-grid">';
  html+=cols.map((_,i)=>`<div class="bazi-cell header">${labels[i]}</div>`).join('');
  // 天干行
  html+=cols.map(c=>{
    const g=p[c].gan;
    return`<div class="bazi-cell"><span class="gz">${g}</span><span class="el-tag el-${WX_G[g]||''}">${WX_G[g]||''}</span><div class="gz-sub">${c==='day'?'日主':(b.gods[c]?b.gods[c].gan:'—')}</div></div>`;
  }).join('');
  // 地支行 (十二長生)
  html+=cols.map(c=>{
    const z=p[c].zhi;
    // 自坐：各柱天干對照自己的地支
    const selfSit=changSheng(p[c].gan,z)||'—';
    return`<div class="bazi-cell"><span class="gz">${z}</span><span class="el-tag el-${WX_Z[z]||''}">${WX_Z[z]||''}</span><div class="gz-sub">${b.cs[c]||'—'}</div><div class="gz-sub" style="font-size:0.6rem;opacity:0.5">坐${selfSit}</div></div>`;
  }).join('');
  // 藏干行
  html+=cols.map(c=>{
    const cg=b.cangGan[c]||[];
    return`<div class="bazi-cell"><div class="gz-sub">藏干</div>${cg.map(g=>`<span class="el-tag el-${WX_G[g]}" style="margin:1px">${g}</span>`).join('')}</div>`;
  }).join('');
  html+='</div>';

  // 納音
  html+=`<p class="text-sm text-dim mt-sm">納音：${b.nayin} ｜ <span style="color:${(b.capacity||0)>=50?'#4ade80':(b.capacity||0)>=30?'#fbbf24':'#f87171'}">${b.structType||('身'+(b.strong?'強':'弱'))}</span> ｜ 日主：${b.dm}（${b.dmEl}）</p>`;

  // ── 星座 + 星宿 ──
  if(b.zodiac||b.xingxiu){
    let astroHtml='<p class="text-xs text-dim">';
    if(b.zodiac) astroHtml+=`${b.zodiac.sym} ${b.zodiac.name}（${b.zodiac.el}象）`;
    if(b.zodiac&&b.xingxiu) astroHtml+=' ｜ ';
    if(b.xingxiu) astroHtml+=`${b.xingxiu.group}·${b.xingxiu.name}宿（${b.xingxiu.animal}·${b.xingxiu.planet}）`;
    astroHtml+='</p>';
    html+=astroHtml;
  }

  // ── 命宮 / 胎元 / 胎息 / 身宮 ──
  if(b.mingGong||b.taiYuan||b.taiXi||b.shenGong){
    let gongHtml='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-top:8px;text-align:center;font-size:0.78rem">';
    const gongItems=[
      {label:'命宮',d:b.mingGong},{label:'身宮',d:b.shenGong},{label:'胎元',d:b.taiYuan},{label:'胎息',d:b.taiXi}
    ];
    gongItems.forEach(g=>{
      if(g.d){
        gongHtml+=`<div style="background:rgba(212,175,55,.06);border:1px solid rgba(212,175,55,.15);border-radius:8px;padding:6px 4px">
          <div style="font-size:0.65rem;opacity:0.5">${g.label}</div>
          <div style="font-weight:700;font-size:1rem;color:var(--c-gold)">${g.d.gan}${g.d.zhi}</div>
          <div style="font-size:0.6rem;opacity:0.45">${g.d.nayin||''}</div></div>`;
      }
    });
    gongHtml+='</div>';
    html+=gongHtml;
  }

  // ── 四柱納音 ──
  if(b.nayinAll){
    html+=`<p class="text-xs text-dim" style="margin-top:6px">四柱納音：${['year','month','day','hour'].map(c=>'<span style="opacity:0.7">'+(b.nayinAll[c]||'—')+'</span>').join(' · ')}</p>`;
  }

  // ── 節氣 / 人元司令 ──
  if(b.jqInfo){
    const jq=b.jqInfo;
    html+=`<p class="text-xs text-dim">節氣：${jq.jieName} ${jq.jieMonth}/${jq.jieDay} ${jq.jieHour}:${String(jq.jieMinute).padStart(2,'0')} → 節後${jq.daysAfterJie}天`;
    if(b.renyuan) html+=` ｜ 人元司令：<span style="color:var(--c-gold)">${b.renyuan.gan}${b.renyuan.el}用事</span>（${b.renyuan.name}）`;
    html+=`</p>`;
  }

  // ── 空亡 ──
  if(b.kongwang){
    html+=`<p class="text-xs text-dim">空亡：年柱【${b.kongwang.year.join('')}】 日柱【${b.kongwang.day.join('')}】</p>`;
  }

  // ── 天運五行 ──
  if(b.tianYunEl){
    html+=`<p class="text-xs text-dim">天運五行：<span class="el-tag el-${b.tianYunEl}">${b.tianYunEl}</span>（${b.nayin}）</p>`;
  }

  html+=`<p class="text-xs text-dim">得令：${b.deLing?'✓':'✗'}(${b.dmMonthState||'—'}) ｜ 得地：${b.deDi?'✓':'✗'} ｜ 得勢：${b.deShi?'✓':'✗'} ｜ 同黨${b.selfRatio||0}%</p>`;

  // ── 五行(60分) + 十神分佈明細 ──
  html+=`<p class="text-xs text-dim">五行(60分)：`;
  for(const el of ['金','木','水','火','土']){
    const score=Math.round(b.ec[el]);
    let godDetail='';
    if(b.godBreakdown&&b.godBreakdown[el]){
      const entries=Object.entries(b.godBreakdown[el]).filter(([g,p])=>p>0).map(([g,p])=>g+p);
      if(entries.length) godDetail='('+entries.join(' ')+')';
    }
    html+=`<span class="el-tag el-${el}" style="margin:1px;font-size:0.7rem">${el}${score}</span>`;
    if(godDetail) html+=`<span style="font-size:0.6rem;opacity:0.5">${godDetail}</span> `;
  }
  html+=`</p>`;

  html+=`<p class="text-xs text-dim">喜用神：<span class="text-success">${b.fav.join('、')}</span> ｜ 忌神：<span class="text-danger">${b.unfav.join('、')}</span></p>`;

  // ── 袁天罡稱骨 ──
  if(b.chenggu){
    html+=`<details style="margin-top:6px"><summary class="text-xs text-dim" style="cursor:pointer;color:var(--c-gold)">⚖️ 袁天罡稱骨：${b.chenggu.display}（${b.chenggu.level}）</summary>
      <div style="padding:6px 8px;font-size:0.75rem;line-height:1.6;opacity:0.7;background:rgba(0,0,0,.15);border-radius:6px;margin-top:4px">
        <p style="margin:0">年${b.chenggu.yearWeight}兩 + 月${b.chenggu.monthWeight}兩 + 日${b.chenggu.dayWeight}兩 + 時${b.chenggu.hourWeight}兩 = <strong>${b.chenggu.display}</strong></p>
        <p style="margin:4px 0 0;font-style:italic">${b.chenggu.poem}</p>
      </div></details>`;
  }
  document.getElementById('d-bazi').innerHTML = wrapPlain(html,'八字｜白話重點');

  // 五行柱狀圖 (60分制，含月令旺衰)
  const els=['金','木','水','火','土'];
  const colors={金:'var(--el-metal)',木:'var(--el-wood)',水:'var(--el-water)',火:'var(--el-fire)',土:'var(--el-earth)'};
  const WX_STATE={};
  for(const e of els){
    const mzEl=WX_Z[p.month.zhi];
    if(e===mzEl) WX_STATE[e]='旺';
    else if(SHENG[e]===mzEl) WX_STATE[e]='休';
    else if(SHENG[mzEl]===e) WX_STATE[e]='相';
    else if(KE[e]===mzEl) WX_STATE[e]='囚';
    else if(KE[mzEl]===e) WX_STATE[e]='死';
    else WX_STATE[e]='休';
  }
  document.getElementById('d-elbar').innerHTML='<div class="el-bar">'+els.map(e=>{
    const score=Math.round(b.ec[e]);
    return`<div class="el-row"><span class="el-lbl" style="color:${colors[e]}">${e}<span style="font-size:0.7rem;opacity:0.7"> ${WX_STATE[e]}</span></span>
    <div class="el-track"><div class="el-fill" style="width:${Math.round(score/60*100)}%;background:${colors[e]}"></div></div>
    <span class="el-val">${score}</span></div>`;
  }).join('')+'</div>';

  // 十神
  // 十神有效性判定
  const _godEffective = {};
  const _wEC = b.weightedEC || {};
  cols.forEach(c => {
    const gg = b.gods[c].gan;
    if(gg === '日主') return;
    const ganEl = WX_G[p[c].gan] || '';
    const wt = _wEC[ganEl] || 0;
    // 判斷有效性：此十神的五行權重是否足以影響日主
    const isFav = b.fav.includes(ganEl);
    const isUnfav = b.unfav.includes(ganEl);
    const isStrong = wt >= 4;
    const isWeak = wt < 2;
    if(['正印','偏印'].includes(gg)){
      // 印星有效性：需要根氣+不被剋穿
      _godEffective[c+'_gan'] = isWeak ? '虛印' : (isUnfav ? '假印（忌）' : '✓ 有效');
    } else if(['比肩','劫財'].includes(gg)){
      _godEffective[c+'_gan'] = isWeak ? '虛比' : '✓ 有力';
    } else if(['七殺','正官'].includes(gg)){
      _godEffective[c+'_gan'] = isStrong ? '✓ 真（壓力大）' : '虛官';
    } else if(['食神','傷官'].includes(gg)){
      _godEffective[c+'_gan'] = isWeak ? '虛洩' : '✓ 通關';
    } else if(['正財','偏財'].includes(gg)){
      _godEffective[c+'_gan'] = b.strong ? '✓ 可用' : '耗身';
    }
  });

  document.getElementById('d-gods').innerHTML=`
    <div class="bazi-grid" style="margin:0">
      ${cols.map((_,i)=>`<div class="bazi-cell header">${labels[i]}</div>`).join('')}
      ${cols.map(c=>`<div class="bazi-cell"><strong>${b.gods[c].gan}</strong>${_godEffective[c+'_gan']?`<div style="font-size:0.55rem;margin-top:2px;color:${_godEffective[c+'_gan'].startsWith('✓')?'#4ade80':'#f87171'}">${_godEffective[c+'_gan']}</div>`:''}</div>`).join('')}
      ${cols.map(c=>`<div class="bazi-cell">${(b.gods[c].zhi||[]).join('<br>')}</div>`).join('')}
    </div>`;

  // 藏干
  document.getElementById('d-canggan').innerHTML=cols.map(c=>{
    const cg=b.cangGan[c]||[];
    return`<p><strong>${labels[cols.indexOf(c)]}（${p[c].zhi}）：</strong>${cg.map(g=>`${g}(${WX_G[g]}/${tenGod(b.dm,g)})`).join('、')||'—'}</p>`;
  }).join('');

  // ═══ 承載力條 + 結構判定 ═══
  const _cap = b.capacity || b.bearingCapacity || 0;
  const _capPct = Math.max(0, Math.min(100, (_cap + 20) * 100 / 70)); // scale -20~50 to 0~100
  const _capColor = _cap >= 50 ? '#4ade80' : _cap >= 30 ? '#60a5fa' : _cap >= 10 ? '#fbbf24' : '#f87171';
  const _capLabel = _cap >= 50 ? '穩定型' : _cap >= 30 ? '偏弱型' : '漂浮型';
  const _riskLevel = _cap >= 50 ? '低風險' : _cap >= 30 ? '中風險' : '⚠ 高風險';
  const _riskColor = _cap >= 50 ? '#4ade80' : _cap >= 30 ? '#fbbf24' : '#f87171';

  // ═══ 能量流向 ═══
  const _flow = b.energyFlow || {};
  
  // ═══ 貼身影響 ═══
  const _proxNotes = b.proximityNotes || [];

  document.getElementById('d-xiyong').innerHTML=`
    <div style="margin-bottom:1rem">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem">
        <strong style="font-size:0.85rem">承載力：${_cap}</strong>
        <span style="font-size:0.75rem;color:${_riskColor};font-weight:600">${_riskLevel}</span>
      </div>
      <div style="background:rgba(255,255,255,0.08);border-radius:6px;height:12px;overflow:hidden;position:relative">
        <div style="width:${_capPct}%;height:100%;background:${_capColor};border-radius:6px;transition:width 0.6s"></div>
        <div style="position:absolute;top:0;left:42.8%;width:2px;height:100%;background:rgba(255,255,255,0.3)" title="偏弱/穩定分界"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:0.6rem;opacity:0.4;margin-top:2px">
        <span>漂浮 (&lt;30)</span><span>偏弱 (30-50)</span><span>穩定 (&gt;50)</span>
      </div>
    </div>

    <div style="margin-bottom:1rem">
      <strong style="font-size:0.85rem">結構判定：</strong>
      <span style="color:${_capColor};font-weight:600">${b.structType || (_capLabel)}</span>
    </div>

    ${_flow.mainFlow ? `<div style="margin-bottom:1rem;padding:0.5rem;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid rgba(255,255,255,0.06)">
      <strong style="font-size:0.8rem">能量流向：</strong>
      <span style="font-size:0.85rem;color:var(--c-gold,#d4af37)">${_flow.mainFlow}</span>
      ${_flow.breakPoint && _flow.breakPoint !== '無明顯阻斷' ? `<br><span style="font-size:0.75rem;color:#f87171">⚡ 阻斷點：${_flow.breakPoint}</span>` : ''}
      ${_flow.sortedPower ? `<br><span style="font-size:0.7rem;opacity:0.5">${_flow.sortedPower}</span>` : ''}
    </div>` : ''}

    ${_proxNotes.length ? `<div style="margin-bottom:1rem;padding:0.4rem 0.6rem;background:rgba(248,113,113,0.08);border-radius:6px;border-left:3px solid #f87171">
      <strong style="font-size:0.75rem;color:#f87171">⚠ 貼身影響：</strong>
      ${_proxNotes.map(n => `<div style="font-size:0.72rem;opacity:0.8;margin-top:2px">• ${n}</div>`).join('')}
    </div>` : ''}

    <p><strong>喜用神：</strong>${b.fav.map(e=>`<span class="tag tag-green">${e}</span>`).join(' ')}</p>
    <p class="mt-sm"><strong>忌　神：</strong>${b.unfav.map(e=>`<span class="tag tag-red">${e}</span>`).join(' ')}</p>
    ${b.tiaohou ? `<p class="mt-sm" style="font-size:0.78rem;opacity:0.7"><strong>調候：</strong>${b.tiaohou.reason} — ${b.tiaohou.needReason}</p>` : ''}
    ${b.shensha.length?`<details style="margin-top:0.5rem"><summary style="cursor:pointer;font-size:0.78rem;opacity:0.5">神煞（參考）</summary><p class="mt-sm" style="font-size:0.75rem;opacity:0.4">${b.shensha.map(s=>`<span class="tag" style="opacity:0.6">${s}</span>`).join(' ')}</p></details>`:''}`;

  // 起運資訊
  if(b.qiyun){
    const qy=b.qiyun;
    document.getElementById('d-qiyun').innerHTML=`<span style="color:var(--c-gold,#d4af37)">⏳ ${qy.startAge}歲起運</span><span style="opacity:0.6">（小運1~${qy.smallEnd}｜實歲${qy.age}歲${qy.months>0?'又'+qy.months+'個月':''}）</span>`;
  }
  // 大運
  document.getElementById('d-dayun').innerHTML='<div class="dayun-tl">'+b.dayun.map(d=>{
    // 用 score 決定顏色，不依賴 level 文字
    const s=d.score||0;
    const lvClass=s>=6?'lv-dj':s>=3?'lv-zj':s>=1?'lv-xj':s>=-1?'lv-p':s>=-3?'lv-xk':s>=-6?'lv-zk':'lv-dk';
    const gzColor=s>=6?'#4ade80':s>=3?'#60a5fa':s>=1?'var(--c-gold,#d4af37)':s>=-1?'var(--c-text,#e8d5b5)':s>=-3?'#fbbf24':s>=-6?'#f87171':'#ef4444';
    const notesTip=d.notes&&d.notes.length?d.notes.slice(0,4).join('；'):'';
    return`<div class="dy-item dy-${lvClass} ${d.isCurrent?'current':''}" title="${notesTip}">
      <span class="dy-gz" style="color:${gzColor}">${d.gz}</span>
      <span class="dy-age">${d.ageStart}-${d.ageEnd}歲</span>
      <span style="font-size:0.55rem;opacity:0.45;display:block">${b._birthYear?''+(b._birthYear+d.ageStart)+'~'+(b._birthYear+d.ageEnd):''}</span>
      <span class="dy-lv ${lvClass}">${d.level}</span>
      <div class="gz-sub">${d.god}</div>
      ${d.ganScore!==undefined?'<div style="font-size:0.6rem;opacity:0.5;margin-top:2px">干'+(d.ganScore>0?'<span style="color:#4ade80">↑</span>':'<span style="color:#f87171">↓</span>')+' 支'+(d.zhiScore>0?'<span style="color:#4ade80">↑</span>':'<span style="color:#f87171">↓</span>')+'</div>':''}</div>`
  }).join('')+'</div>';
  // 當前大運流年詳情
  const curDy=b.dayun?b.dayun.find(d=>d.isCurrent):null;
  if(curDy&&curDy.liuNian){
    let lnHtml='<details style="margin-top:0.8rem"><summary style="cursor:pointer;font-size:0.85rem;color:var(--c-gold,#d4af37)">📅 當前大運'+curDy.gz+'（'+curDy.level+'）流年明細</summary><div style="padding:0.5rem;font-size:0.82rem;line-height:1.6">';
    if(curDy.notes&&curDy.notes.length) lnHtml+='<p style="margin-bottom:0.5rem;color:var(--c-gold)">大運特徵：'+curDy.notes.slice(0,4).join('、')+'</p>';
    lnHtml+='<table style="width:100%;border-collapse:collapse;font-size:0.78rem"><tr style="opacity:0.6"><th>年份</th><th>干支</th><th>十神</th><th>能量</th><th>重點提示</th></tr>';
    curDy.liuNian.forEach(ln=>{
      const ls=ln.score||0;
      const isGood=ls>=1;
      const isBad=ls<=-1;
      const color=isGood?'#4caf50':isBad?'#f44336':'#999';
      const rowBg=isGood?'rgba(74,222,128,.06)':isBad?'rgba(248,113,113,.06)':'transparent';
      const note=ln.notes&&ln.notes.length?ln.notes[0]:'—';
      const isCur=ln.year===new Date().getFullYear();
      const curStyle=isCur?'background:rgba(212,175,55,0.15);font-weight:bold;':'';
      lnHtml+=`<tr style="${curStyle||('background:'+rowBg+';')}border-bottom:1px solid rgba(255,255,255,.05)"><td>${ln.year}${isCur?' ◀':''}</td><td>${ln.gz}</td><td>${ln.god}</td><td style="color:${color};font-weight:600">${ln.level}</td><td style="font-size:0.72rem;opacity:0.8">${note}</td></tr>`;
    });
    lnHtml+='</table></div></details>';
    document.getElementById('d-dayun').innerHTML+=lnHtml;
  }
}

// ══════════════════════════════════════════════════════
// 西洋星盤渲染 (SVG圓形星盤 + 行星表 + 相位 + 解讀)
// ══════════════════════════════════════════════════════
function renderNatalChart(){
  const n = S.natal; 
  if(!n){
    const el=document.getElementById('d-natal-summary');
    if(el) el.innerHTML='<p style="color:#f87171;font-size:.85rem">⚠ 星盤資料未產生，請確認出生時間格式正確。</p>';
    return;
  }
  
  // ── 摘要 ──
  document.getElementById('d-natal-summary').innerHTML=`
    <p style="font-size:1rem;color:var(--c-gold);font-weight:700">${n.summary}</p>
    <p class="text-xs text-dim">ASC ${n.ascSign.name} ${Math.floor(n.ascSign.deg)}° ｜ MC ${n.mcSign.name} ${Math.floor(n.mcSign.deg)}°</p>`;
  
  // ── SVG 星盤 ──
  const W=340, CX=W/2, CY=W/2, R1=155, R2=130, R3=50;
  const COLORS=['#ef4444','#a3e635','#fbbf24','#94a3b8','#fb923c','#6d9f71','#f472b6','#818cf8','#38bdf8','#475569','#22d3ee','#a78bfa'];
  const ZSYM=['♈','♉','♊','♋','♌','♍','♎','♏','♐','♑','♒','♓'];
  
  let svg=`<svg viewBox="0 0 ${W} ${W}" style="max-width:340px;width:100%">`;
  // 外圈（星座環）
  svg+=`<circle cx="${CX}" cy="${CY}" r="${R1}" fill="none" stroke="rgba(212,175,55,.2)" stroke-width="1"/>`;
  svg+=`<circle cx="${CX}" cy="${CY}" r="${R2}" fill="none" stroke="rgba(212,175,55,.15)" stroke-width="1"/>`;
  svg+=`<circle cx="${CX}" cy="${CY}" r="${R3}" fill="none" stroke="rgba(212,175,55,.1)" stroke-width="1"/>`;
  
  // 星座分區 + 符號
  for(let i=0;i<12;i++){
    const a1=(i*30-n.asc)*Math.PI/180, a2=((i+1)*30-n.asc)*Math.PI/180;
    const mid=(a1+a2)/2;
    // 分隔線
    svg+=`<line x1="${CX+R2*Math.cos(a1)}" y1="${CY-R2*Math.sin(a1)}" x2="${CX+R1*Math.cos(a1)}" y2="${CY-R1*Math.sin(a1)}" stroke="rgba(212,175,55,.15)"/>`;
    // 星座符號
    const sr=(R1+R2)/2;
    svg+=`<text x="${CX+sr*Math.cos(mid)}" y="${CY-sr*Math.sin(mid)}" fill="${COLORS[i]}" font-size="11" text-anchor="middle" dominant-baseline="central" opacity="0.7">${ZSYM[i]}</text>`;
  }
  
  // 宮位線
  for(let i=0;i<12;i++){
    const a=(n.houses[i]-n.asc)*Math.PI/180;
    const isCard=(i===0||i===3||i===6||i===9);
    svg+=`<line x1="${CX+R3*Math.cos(a)}" y1="${CY-R3*Math.sin(a)}" x2="${CX+R2*Math.cos(a)}" y2="${CY-R2*Math.sin(a)}" stroke="${isCard?'rgba(212,175,55,.4)':'rgba(255,255,255,.08)'}" stroke-width="${isCard?1.5:0.5}"/>`;
    // 宮位數字
    const nextH=n.houses[(i+1)%12];
    const midA=((n.houses[i]+_n360(nextH-n.houses[i])/2)-n.asc)*Math.PI/180;
    const nr=R3+15;
    svg+=`<text x="${CX+nr*Math.cos(midA)}" y="${CY-nr*Math.sin(midA)}" fill="rgba(255,255,255,.2)" font-size="8" text-anchor="middle" dominant-baseline="central">${i+1}</text>`;
  }
  
  // ASC/MC 標記
  const ascA=(0)*Math.PI/180; // ASC always at left (0°)
  svg+=`<text x="${CX+R1*Math.cos(ascA)+12}" y="${CY-R1*Math.sin(ascA)}" fill="var(--c-gold)" font-size="8" font-weight="700">ASC</text>`;
  const mcA=(n.mc-n.asc)*Math.PI/180;
  svg+=`<text x="${CX+R1*Math.cos(mcA)}" y="${CY-R1*Math.sin(mcA)-8}" fill="var(--c-gold)" font-size="8" font-weight="700">MC</text>`;
  
  // 相位線
  for(const asp of n.aspects){
    const p1=n.planets[asp.p1], p2=n.planets[asp.p2];
    const a1=(p1.lon-n.asc)*Math.PI/180, a2=(p2.lon-n.asc)*Math.PI/180;
    const pr=R3+30;
    const col=asp.good?'rgba(74,222,128,.15)':'rgba(248,113,113,.15)';
    svg+=`<line x1="${CX+pr*Math.cos(a1)}" y1="${CY-pr*Math.sin(a1)}" x2="${CX+pr*Math.cos(a2)}" y2="${CY-pr*Math.sin(a2)}" stroke="${col}" stroke-width="0.7"/>`;
  }
  
  // 行星
  const pEntries=Object.entries(n.planets);
  // Anti-collision: spread planets that are too close
  const pAngs=pEntries.map(([name,p])=>({name,lon:p.lon,a:(p.lon-n.asc)*Math.PI/180,sym:p.sym,color:p.color}));
  pAngs.sort((a,b)=>a.lon-b.lon);
  // Simple collision avoidance
  for(let pass=0;pass<3;pass++){
    for(let i=1;i<pAngs.length;i++){
      const diff=Math.abs(pAngs[i].a-pAngs[i-1].a);
      if(diff<0.12){pAngs[i].a+=0.06;pAngs[i-1].a-=0.06;}
    }
  }
  
  const pr=R2-18;
  for(const p of pAngs){
    svg+=`<circle cx="${CX+pr*Math.cos(p.a)}" cy="${CY-pr*Math.sin(p.a)}" r="8" fill="rgba(0,0,0,.6)" stroke="${p.color}" stroke-width="1"/>`;
    svg+=`<text x="${CX+pr*Math.cos(p.a)}" y="${CY-pr*Math.sin(p.a)}" fill="${p.color}" font-size="9" text-anchor="middle" dominant-baseline="central">${p.sym}</text>`;
  }
  
  svg+=`</svg>`;
  document.getElementById('d-natal-chart').innerHTML=svg;
  
  // ── 行星落座表 ──
  let pHtml='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:6px">';
  for(const [name,p] of pEntries){
    const d=Math.floor(p.signDeg), m=Math.floor((p.signDeg%1)*60);
    pHtml+=`<div style="background:rgba(255,255,255,.03);padding:6px 8px;border-radius:6px;border-left:3px solid ${p.color}">
      <span style="color:${p.color};font-weight:700">${p.sym} ${name}</span>
      <div style="font-size:0.75rem;opacity:0.7">${p.signSym}${p.sign} ${d}°${m}' <span style="opacity:0.5">${p.house}宮</span></div>
    </div>`;
  }
  pHtml+='</div>';
  document.getElementById('d-natal-planets').innerHTML=pHtml;
  
  // ── 相位表 ──
  const goodAsp=n.aspects.filter(a=>a.good), badAsp=n.aspects.filter(a=>!a.good);
  let aHtml='';
  if(goodAsp.length){
    aHtml+='<p style="color:#4ade80;font-size:0.8rem;font-weight:600">吉相位</p><div style="font-size:0.75rem;line-height:1.8">';
    goodAsp.forEach(a=>{aHtml+=`<span style="display:inline-block;margin:2px 4px;padding:2px 8px;background:rgba(74,222,128,.08);border-radius:12px">${a.p1} ${a.sym} ${a.p2} <span style="opacity:0.5">${a.type}</span></span>`;});
    aHtml+='</div>';
  }
  if(badAsp.length){
    aHtml+='<p style="color:#f87171;font-size:0.8rem;font-weight:600;margin-top:8px">凶相位</p><div style="font-size:0.75rem;line-height:1.8">';
    badAsp.forEach(a=>{aHtml+=`<span style="display:inline-block;margin:2px 4px;padding:2px 8px;background:rgba(248,113,113,.08);border-radius:12px">${a.p1} ${a.sym} ${a.p2} <span style="opacity:0.5">${a.type}</span></span>`;});
    aHtml+='</div>';
  }
  document.getElementById('d-natal-aspects').innerHTML=aHtml||'<p class="text-dim text-xs">無主要相位</p>';
  
  // ── 星盤解讀 ──
  const reading = interpretNatalChart(n);
  document.getElementById('d-natal-reading').innerHTML=reading;

if(PLAIN_MODE){ const s=document.getElementById('d-natal-summary'); if(s) s.innerHTML = wrapPlain(s.innerHTML,'西洋星盤｜白話重點'); const d=document.getElementById('d-natal-detail'); if(d) d.innerHTML = wrapPlain(d.innerHTML,'西洋星盤｜白話重點（細節）'); }
}

// 星盤解讀引擎（含問題類型分析）
function interpretNatalChart(n){
  const p=n.planets;
  const type=S.form?S.form.type:'general';
  let html='';
  
  // 宮位人話翻譯
  const HOUSE_NAME={1:'自我',2:'財富',3:'溝通學習',4:'家庭根基',5:'戀愛創造',6:'工作健康',7:'伴侶合作',8:'深層轉化',9:'遠行學問',10:'事業名望',11:'社交人脈',12:'靈性隱藏'};
  function hDesc(h){return HOUSE_NAME[h]||h+'宮';}
  
  const sunI={'牡羊':'行動力強，勇於開創，性格直爽但容易衝動。','金牛':'穩重務實，重視安全感，對美食和物質有追求。','雙子':'思維敏捷，善於溝通，好奇心強但易分散注意力。','巨蟹':'重視家庭，情感豐富，直覺敏銳但情緒易波動。','獅子':'自信大方，有領導力，慷慨但需要被關注認可。','處女':'細心謹慎，追求完美，分析力強但容易焦慮。','天秤':'重視和諧，審美力佳，善交際但有時優柔寡斷。','天蠍':'意志堅定，洞察力強，情感深刻但有時過度懷疑。','射手':'樂觀自由，愛冒險探索，視野開闊但較缺耐性。','摩羯':'有責任感，目標明確，自律但容易給自己過大壓力。','水瓶':'獨立創新，重視自由，思維前衛但有時過度疏離。','雙魚':'感性浪漫，富同理心，藝術天分高但易逃避現實。'};
  html+=`<p><strong style="color:${p['太陽'].color}">☉ 太陽${p['太陽'].sign}（${hDesc(p['太陽'].house)}）</strong>：${sunI[p['太陽'].sign]||''}</p>`;
  
  const moonI={'牡羊':'情緒來得快去得快，需要自主空間。','金牛':'情感穩定，需要安全感和舒適環境。','雙子':'情緒多變，透過溝通表達處理情感。','巨蟹':'情感豐沛，對家庭依賴深，需要被呵護。','獅子':'情感表達熱烈，需要被讚賞和愛。','處女':'內心細膩敏感，以服務照顧表達情感。','天秤':'渴望關係中的平衡，害怕衝突和孤單。','天蠍':'情感深沉強烈，具有很強的直覺力。','射手':'情緒樂觀開朗，需要精神上的自由空間。','摩羯':'情感內斂克制，以實際行動表達關心。','水瓶':'情感獨立理性，保持適當距離才舒服。','雙魚':'極度敏感易感，直覺和夢境是情感出口。'};
  html+=`<p class="mt-sm"><strong style="color:${p['月亮'].color}">☽ 月亮${p['月亮'].sign}（${hDesc(p['月亮'].house)}）</strong>：${moonI[p['月亮'].sign]||''}</p>`;
  
  const ascI={'牡羊':'給人積極有活力的第一印象。','金牛':'外表穩重沉穩，節奏較慢。','雙子':'機靈活潑，善於與人打開話題。','巨蟹':'親切溫暖，讓人有安全感。','獅子':'氣場強大，自帶焦點吸引力。','處女':'低調謹慎，細緻整潔的形象。','天秤':'優雅有禮，注重外在形象。','天蠍':'神秘有深度，眼神穿透力強。','射手':'開朗隨和，陽光自信的氣質。','摩羯':'沉穩可靠，有成熟穩重感。','水瓶':'特立獨行，有點疏離的氣質。','雙魚':'柔和夢幻，溫柔感性的印象。'};
  html+=`<p class="mt-sm"><strong style="color:var(--c-gold)">ASC 上升${n.ascSign.name}</strong>：${ascI[n.ascSign.name]||''}</p>`;
  
  // ★ 日月升三重矛盾整合分析
  const sunSign=p['太陽'].sign, moonSign=p['月亮'].sign, ascSign=n.ascSign.name;
  const _elMap={'牡羊':'火','金牛':'土','雙子':'風','巨蟹':'水','獅子':'火','處女':'土','天秤':'風','天蠍':'水','射手':'火','摩羯':'土','水瓶':'風','雙魚':'水'};
  const sunEl=_elMap[sunSign]||'', moonEl=_elMap[moonSign]||'', ascEl=_elMap[ascSign]||'';
  // 檢查對沖（太陽/月亮是否為對宮星座）
  const _oppo={'牡羊':'天秤','金牛':'天蠍','雙子':'射手','巨蟹':'摩羯','獅子':'水瓶','處女':'雙魚','天秤':'牡羊','天蠍':'金牛','射手':'雙子','摩羯':'巨蟹','水瓶':'獅子','雙魚':'處女'};
  const isSunMoonOppo=_oppo[sunSign]===moonSign;
  if(sunEl!==moonEl || sunEl!==ascEl || isSunMoonOppo){
    html+=`<div style="margin:.6rem 0;padding:.5rem .8rem;background:rgba(212,175,55,.06);border-radius:6px;border-left:3px solid rgba(212,175,55,.3);font-size:.85rem">`;
    html+=`<p style="font-weight:600;color:var(--c-gold)">🔄 日月升整合分析</p>`;
    if(isSunMoonOppo){
      html+=`<p class="text-sm text-dim" style="margin-top:.3rem">太陽${sunSign}與月亮${moonSign}形成對沖，內在理性（${sunSign}）與感性（${moonSign}）存在深層拉扯。`;
      if(ascEl!==sunEl && ascEl!==moonEl) html+=`上升${ascSign}（${ascEl}象）作為外在面具，讓這種矛盾更不易被察覺。`;
      html+=`這種結構的人往往有極大的內在張力，但也是創造力與突破的來源。</p>`;
    } else if(sunEl!==ascEl){
      html+=`<p class="text-sm text-dim" style="margin-top:.3rem">外在給人${ascSign}（${ascEl}象）的印象，但核心驅動力是${sunSign}（${sunEl}象），`;
      if(moonEl!==sunEl && moonEl!==ascEl) html+=`情緒需求又是${moonSign}（${moonEl}象），三者分屬不同元素。`;
      else html+=`${sunSign}的特質會被上升的面具所隱藏。`;
      html+=`</p>`;
    }
    html+=`</div>`;
  }
  
  html+='<p class="mt-sm"><strong style="color:var(--c-gold)">📌 針對你的問題：</strong></p>';
  
  const goodAsp=n.aspects.filter(a=>a.good).length, badAsp=n.aspects.filter(a=>!a.good).length;
  const aspTone=goodAsp>badAsp+1?'吉相位較多，星盤能量支持你':badAsp>goodAsp+1?'挑戰相位偏多，行動前需多考量':'吉凶均衡，有助力也有阻力';
  
  if(type==='love'||type==='relationship'){
    const venus=p['金星'], mars=p['火星'], moon=p['月亮'];
    html+=`<p class="text-sm">💕 <strong>感情分析</strong>：你的愛情模式帶有${venus.sign}特質`;
    if([5,7].includes(venus.house)) html+=`，金星落在感情宮位，天生有桃花運，容易吸引對象`;
    else if(venus.house===1) html+=`，外在魅力是你最大的桃花優勢`;
    else if(venus.house===11) html+=`，容易在朋友圈或社交場合遇到對象`;
    else if([12,8].includes(venus.house)) html+=`，感情傾向深沉私密，不喜歡高調`;
    else if(venus.house===10) html+=`，工作場合容易產生感情`;
    else if(venus.house===9) html+=`，可能有異地或異國情緣`;
    else html+=`，感情態度穩定踏實`;
    html+=`。`;
    if([1,5,7].includes(mars.house)) html+=`你在感情中會主動出擊。`;
    else if([12,4].includes(mars.house)) html+=`你在感情中比較被動。`;
    else html+=`你在感情中不急不慢。`;
    html+=`內心真正需要的是：${moonI[moon.sign]||'穩定的情感連結。'}`;
    const h7Sign=ZODIAC_NAMES[Math.floor(n.houses[6]/30)%12];
    const signTrait={'牡羊':'果斷有衝勁','金牛':'穩重有安全感','雙子':'聰明幽默','巨蟹':'溫柔顧家','獅子':'大方自信','處女':'細心體貼','天秤':'優雅有品味','天蠍':'深情專一','射手':'開朗自由','摩羯':'成熟可靠','水瓶':'獨特有想法','雙魚':'浪漫體貼'};
    html+=`<br>你的伴侶宮是${h7Sign}座，傾向被${signTrait[h7Sign]||''}的人吸引。`;
    html+=`<br>${aspTone}。</p>`;
  } else if(type==='career'){
    const sun=p['太陽'], saturn=p['土星'], jupiter=p['木星'];
    html+=`<p class="text-sm">💼 <strong>事業分析</strong>：天頂${n.mcSign.name}座，適合${n.mcSign.name}特質的職業方向。`;
    if([10,6,1].includes(sun.house)) html+=`太陽在${hDesc(sun.house)}，事業是你的舞台。`;
    else html+=`太陽在${hDesc(sun.house)}，事業有自己的節奏。`;
    html+=`木星在${hDesc(jupiter.house)}帶來好運。`;
    if(saturn.house===10) html+=`土星在事業宮，大器晚成。`;
    else html+=`土星在${hDesc(saturn.house)}是人生功課。`;
    html+=`<br>${aspTone}。</p>`;
  } else if(type==='wealth'){
    const jupiter=p['木星'], venus=p['金星'];
    html+=`<p class="text-sm">💰 <strong>財運分析</strong>：木星在${jupiter.sign}（${hDesc(jupiter.house)}）`;
    if([2,8,11].includes(jupiter.house)) html+=`，天生有財運天賦`;
    else if(jupiter.house===10) html+=`，事業上有擴展收入的機會`;
    else html+=`，需透過${hDesc(jupiter.house)}領域創造財富`;
    html+=`。金星在${venus.sign}（${hDesc(venus.house)}）`;
    if([2,8].includes(venus.house)) html+=`，有吸引財富的體質`;
    else if(venus.house===11) html+=`，透過人脈社交帶來財運`;
    else html+=`，賺錢方式跟${hDesc(venus.house)}有關`;
    html+=`。<br>${aspTone}。</p>`;
  } else if(type==='health'){
    const mars=p['火星'], saturn=p['土星'];
    html+=`<p class="text-sm">🏥 <strong>健康分析</strong>：`;
    // 火星位置 = 健康耗損模式（依星座更具體）
    const marsSign=mars.sign;
    if(mars.house===6){
      html+=`火星在健康宮位，`;
      if(['雙子','處女'].includes(marsSign)) html+=`雙子/處女能量使神經系統緊繃，易因多工處理導致疲勞、失眠、肩頸問題。`;
      else if(['白羊','天蠍'].includes(marsSign)) html+=`火能量過旺，注意炎症、急性發燒或意外傷害。`;
      else if(['金牛','天秤'].includes(marsSign)) html+=`注意咽喉、泌尿系統與過度飲食問題。`;
      else html+=`需注意過勞、炎症和急性問題，工作壓力直接反映在身體上。`;
    } else if(mars.house===1){
      html+=`火星在自我宮，精力旺但易因衝動受傷。`;
    } else if(mars.house===12){
      html+=`火星在靈性宮，暗中消耗精力，容易疲勞卻找不到原因，注意睡眠品質。`;
    } else {
      html+=`火星在${hDesc(mars.house)}，體力消耗主要在此領域。`;
    }
    // 土星位置 = 長期壓力源
    if([6,12].includes(saturn.house)){
      html+=`土星在${hDesc(saturn.house)}，慢性問題需格外留意，可能有長期的低度健康耗損。`;
    } else if(saturn.house===11){
      const satSign=saturn.sign;
      html+=`土星在人脈領域（${satSign}），處理群體關係時帶有沉重壓力`;
      if(satSign==='天蠍') html+=`，天蠍能量加深控制欲與猜忌，社交消耗極大`;
      html+=`。`;
    } else {
      html+=`土星在${hDesc(saturn.house)}，長期壓力在此。`;
    }
    html+=`<br>${aspTone}。</p>`;
  } else {
    const jupiter=p['木星'], saturn=p['土星'];
    html+=`<p class="text-sm">🔮 <strong>整體分析</strong>：木星在${hDesc(jupiter.house)}帶來好運。土星在${hDesc(saturn.house)}是考驗方向。${aspTone}。</p>`;
  }
  
  const majorAsp=n.aspects.filter(a=>(a.p1==='太陽'||a.p1==='月亮'||a.p2==='太陽'||a.p2==='月亮'));
  if(majorAsp.length){
    html+='<p class="mt-sm"><strong>關鍵相位：</strong></p><ul style="font-size:0.8rem;padding-left:1.2rem;margin:4px 0">';
    majorAsp.slice(0,5).forEach(a=>{
      let aspMeaning='';
      if(a.good){
        if(a.type.includes('三合')) aspMeaning='能量流暢、天生優勢，但也可能因太舒適而缺乏動力';
        else if(a.type.includes('六合')) aspMeaning='機會與助力，可順勢而為';
        else aspMeaning='和諧帶來助力';
      } else {
        if(a.type.includes('刑')||a.type.includes('四分')||a.type.includes('90')){
          aspMeaning='內在張力極大，是焦慮的來源，但也是逼迫突破自我框架的核心動力';
        } else if(a.type.includes('沖')||a.type.includes('對分')||a.type.includes('180')){
          aspMeaning='兩股力量拉扯對立，需要整合而非壓抑其中一方';
        } else {
          aspMeaning='帶來挑戰，但挑戰正是成長的催化劑';
        }
      }
      html+=`<li>${a.p1} ${a.sym} ${a.p2}（${a.type}）— ${aspMeaning}</li>`;
    });
    html+='</ul>';
  }
  return html;
}



/* ── 梅花易數依問題類型解讀 ── */
function getMeihuaTypeReading(r, type) {
  const ty = r.ty;  // 體用關係
  const benName = r.ben.n || '';
  const bianName = r.bian.n || '';
  const f = ty.f;   // 大吉/吉/小吉/小凶/凶/平
  const rel = ty.r;  // 用生體/體生用/體克用/用克體/比和

  // 體用五行
  const tiEl = r.tiG.el;
  const yoEl = r.yoG.el;

  const isGood = f.includes('吉');
  const isBad = f.includes('凶');

  const TYPE_READING = {
    love: {
      '用生體': '對方對你有好感或主動付出的跡象，這段感情中你是被滋養的一方。把握機會，適時回應對方的心意。',
      '體生用': '你對這段感情投入較多，容易單方面付出。建議保留一些自我空間，別在感情中迷失自己。',
      '體克用': '你在感情中較佔主導，對方可能比較被動。雖然可以掌控節奏，但要注意別讓對方感到壓迫。',
      '用克體': '感情上有外在壓力或阻礙，可能是第三者、家人反對或現實條件不合。需要耐心溝通與等待。',
      '比和': '雙方頻率接近，相處自然舒服。這段關係有穩定發展的基礎，保持現狀就好。'
    },
    career: {
      '用生體': '有貴人相助或外部資源湧入，事業發展得到助力。把握這波機會，積極爭取。',
      '體生用': '工作上付出多但回報慢，可能做了很多但成果被他人收割。調整策略，減少無效努力。',
      '體克用': '你有能力掌控局面，但需要主動出擊。適合開拓新業務、主導專案。',
      '用克體': '職場上有壓力或競爭對手很強，當前不宜硬碰硬。蟄伏積累實力，等時機成熟再出手。',
      '比和': '工作環境穩定，同事關係和諧。適合穩步推進計畫，不宜大幅變動。'
    },
    wealth: {
      '用生體': '有財來找你的跡象，可能是意外之財或投資回報。適合接受機會，但不要貪多。',
      '體生用': '錢財容易外流，花費大於收入。注意節流，減少不必要的開銷和衝動消費。',
      '體克用': '能夠掌控財務狀況，適合主動理財、催收欠款。但用力過度反而不利。',
      '用克體': '財運受阻，可能有意外支出或投資虧損。暫時守財為上，不宜冒險。',
      '比和': '財務狀況平穩，不會有大起大落。適合穩健型理財，定期儲蓄。'
    },
    health: {
      '用生體': '身體得到滋養，適合養生調理。目前的保健方式有效，繼續保持。',
      '體生用': '精力消耗過大，容易疲勞或免疫力下降。需要多休息，減少過度勞累。',
      '體克用': '體質尚可，但要注意飲食節制。身體在對抗某些不良因素，別過度消耗。',
      '用克體': '健康方面要特別注意，可能有隱患或舊疾復發。建議做健康檢查，不要忽視身體警訊。',
      '比和': '身體狀態平穩，維持現有作息即可。適合養成規律運動習慣。'
    },
    general: {
      '用生體': '整體運勢不錯，外在環境對你有利。順勢而為，好運自然來。',
      '體生用': '付出較多的時期，但不必灰心，積累的努力終會有回報。',
      '體克用': '你有掌控局面的能力，只要方向正確，結果不會太差。',
      '用克體': '當前處於逆境期，建議低調行事，避免做重大決定。',
      '比和': '運勢平穩，生活順遂。維持現狀是最好的策略。'
    }
  };

  // 匹配問題類型，找不到就用 general
  const typeMap = TYPE_READING[type] || TYPE_READING[(['relationship','family'].includes(type) ? 'love' : 'general')];
  const reading = typeMap[rel] || TYPE_READING.general[rel] || '';

  // 變卦趨勢解讀
  let trend = '';
  const bianGood = ['乾','離','兌','巽'];
  const bianBad = ['坎','艮'];
  if(bianName) {
    const bn1 = bianName.charAt(0) || '';
    if(bianGood.some(g => bianName.includes(g))) trend = '變卦走向正面，後續發展趨於好轉。';
    else if(bianBad.some(b => bianName.includes(b))) trend = '變卦偏阻滯，後續需要更多耐心。';
    else trend = '變卦趨勢中性，事在人為。';
  }

  // 加入實戰分析（月令旺衰+動爻+互卦+變卦五行）
  const ma=analyzeMeihua(r, type);
  let extra='';
  if(ma){
    if(ma.wangShuai.ti){
      const ws=ma.wangShuai.ti;
      if(ws.level==='旺'||ws.level==='相') extra+=`體卦當月得令（${ws.level}），力道強。`;
      else if(ws.level==='囚'||ws.level==='死') extra+=`體卦當月失令（${ws.level}），力道弱。`;
    }
    if(ma.dongYao.desc) extra+=ma.dongYao.desc+'。';
    if(ma.huGua.effect) extra+=`過程：${ma.huGua.effect}。`;
    if(ma.bianGua.effect) extra+=`結果：${ma.bianGua.effect}。`;
    if(ma.signals.length) extra+=ma.signals.join('。')+'。';
    if(ma.timing.speed) extra+=`時間預估：${ma.timing.speed}。`;
  }
  return { reading, trend, extra };
}

function renderMeihua(){
  if(!S.meihua){document.getElementById('r-meihua').innerHTML='<p class="text-dim">未進行梅花易數起卦</p>';return}
  const r=S.meihua;
  
  // 構建六爻
  const benLines=[...r.lo.li,...r.up.li];
  const bianLines=[...benLines]; bianLines[r.dong-1]=bianLines[r.dong-1]?0:1;
  const huLines=[benLines[1],benLines[2],benLines[3],benLines[2],benLines[3],benLines[4]];

  document.getElementById('r-meihua').innerHTML=`
    <div class="hex-grid">
      <div class="hex-card"><h4>本卦</h4>${renderYaoLines(benLines,r.dong)}<div class="hex-name" style="margin-top:0.4rem">${r.ben.n}</div><div class="hex-sym">${r.ben.u}</div></div>
      <div class="hex-card"><h4>互卦</h4>${renderYaoLines(huLines)}<div class="hex-name" style="margin-top:0.4rem">${r.hu.n}</div><div class="hex-sym">${r.hu.u}</div></div>
      <div class="hex-card"><h4>變卦</h4>${renderYaoLines(bianLines)}<div class="hex-name" style="margin-top:0.4rem">${r.bian.n}</div><div class="hex-sym">${r.bian.u}</div></div>
    </div>
    <p class="mt-md"><strong>體用：</strong><span class="tag tag-gold">${r.ty.r}</span> <span class="tag ${r.ty.f.includes('吉')?'tag-green':'tag-red'}">${r.ty.f}</span> — ${r.ty.d}</p>
    ${(()=>{ const tr=getMeihuaTypeReading(r, S.form?S.form.type:'general'); return tr.reading?`<div style="margin-top:0.75rem;padding:0.75rem;background:rgba(212,175,55,0.06);border-left:3px solid var(--c-gold);border-radius:0 var(--r-sm) var(--r-sm) 0"><p style="font-size:0.9rem;line-height:1.6"><strong style="color:var(--c-gold)">📋 針對你的問題：</strong>${tr.reading}</p>${tr.trend?`<p class="text-sm text-dim mt-sm"><i class="fas fa-chart-line"></i> ${tr.trend}</p>`:''}${tr.extra?`<p class="text-sm mt-sm" style="line-height:1.6;color:var(--c-text-dim)"><i class="fas fa-search"></i> <strong>深度分析：</strong>${tr.extra}</p>`:''}</div>`:''})()}
    <p class="mt-sm"><strong>卦辭：</strong>${r.ben.j}</p>
    <p><strong>解讀：</strong>${r.ben.m}</p>
    <p><strong>動爻：</strong>第 ${r.dong} 爻（${benLines[r.dong-1]?'陽→陰':'陰→陽'}）${r.dong<=3?'（動爻在用卦→變動源自外部環境或對方）':'（動爻在體卦→變動源自自身）'}</p>
    <p><strong>變卦：</strong>${r.bian.m}</p>
    <div style="margin-top:.75rem;padding:.6rem .8rem;background:rgba(212,175,55,.06);border-radius:6px;border-left:3px solid rgba(212,175,55,.3)">
      <p style="font-weight:600;color:var(--c-gold);font-size:.9rem">📊 綜合評判</p>
      <p class="text-sm text-dim" style="margin-top:.3rem;line-height:1.7">${(()=>{
        const f=r.ty.f, rel=r.ty.r;
        const benM=r.ben.m||'', bianM=r.bian.m||'';
        const bianN=r.bian.n||'';
        let summary='';
        // 根據時間軸串聯：本卦(起點) → 互卦(過程) → 變卦(結果)
        if(f.includes('凶') && bianN.includes('既濟')){
          summary+=`初期雖然${rel==='體生用'?'能量消耗較大':'有阻力'}（${f}），過程中可能經歷資源流失或信心探底`;
          summary+=`，但最終能達到完成與平衡的狀態（${bianN}）。關鍵是撐過中期的低谷。`;
        } else if(f.includes('凶') && bianM.includes('成')){
          summary+=`目前狀態偏不利（${f}），但變卦顯示終局有成。${rel==='體生用'?'你的付出最終會有回報，但過程辛苦。':'需要調整策略以應對阻力。'}`;
        } else if(f.includes('吉')){
          summary+=`整體趨勢正面（${f}），${rel==='用生體'?'外部資源會主動流向你':'能量運轉順暢'}。`;
          if(bianN.includes('未濟')) summary+=`但變卦提醒事情尚未完全定型，仍需持續努力。`;
        } else {
          summary+=`目前${f}，${rel}的格局下，`;
          if(rel==='體生用') summary+=`你的付出多於回報，建議適時收回能量、保存實力。`;
          else if(rel==='用克體') summary+=`外部壓力持續施加，需要尋找突破口或暫時退讓。`;
          else if(rel==='比和') summary+=`體用力量均等，事態膠著，需要新的變數介入。`;
          else summary+=`順勢而為即可。`;
        }
        return summary;
      })()}</p>
    </div>`;

if(PLAIN_MODE){ const el=document.getElementById('r-meihua'); if(el) el.innerHTML = wrapPlain(el.innerHTML,'梅花易數｜白話重點'); }
}

function renderTarot(){
  if(!S.tarot.drawn.length){document.getElementById('r-tarot').innerHTML='<p class="text-dim">未進行塔羅抽牌</p>';return}
  const tarotType=S.form?S.form.type:'general';
  document.getElementById('r-tarot').innerHTML=S.tarot.drawn.map((c,i)=>{
    const imgSrc=typeof getTarotCardImage==='function'?getTarotCardImage(c):'';
    const genericMeaning=c.isUp?c.up:c.rv;
    const typeMeaning=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(c.id, c.isUp, tarotType):null;
    // 優先顯示問題類型專屬解讀，通用牌義作為補充
    const primaryMeaning=typeMeaning||genericMeaning;
    return `
    <div style="display:flex;gap:var(--sp-md);align-items:flex-start;padding:var(--sp-sm) 0;border-bottom:1px solid var(--c-border)">
      <span class="tag tag-gold" style="flex:0 0 auto">${i+1}</span>
      ${imgSrc?`<img src="${imgSrc}" alt="${c.n}" style="width:56px;height:88px;border-radius:4px;flex-shrink:0;border:1px solid rgba(212,175,55,0.3);${c.isUp?'':'transform:rotate(180deg)'}">`:``}
      <div><strong class="text-gold">${c.pos}</strong>：${c.n} <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'正':'逆'}</span>
      <p class="text-sm text-dim">${primaryMeaning}</p>${typeMeaning?`<p class="text-xs text-dim" style="opacity:0.6;margin-top:2px">（通用：${genericMeaning}）</p>`:''}</div>
    </div>`;
  }).join('');

if(PLAIN_MODE){ const el=document.getElementById('r-tarot'); if(el) el.innerHTML = wrapPlain(el.innerHTML,'塔羅｜白話重點'); }
}

/* =============================================================
   ANALYSIS ENGINE — 綜合評分
   ============================================================= */
function _runAnalysisV1_unused(){
  renderBazi(); renderMeihua(); renderTarot();

  const b=S.bazi; if(!b)return;
  const type=S.form.type;
  const question=S.form.question;

  // — 八字評分 (0-100)：依問題類型看不同指標 —
  let baziScore=50;
  const curDy=b.dayun?b.dayun.find(d=>d.isCurrent):null;
  const liuNian=b.dayun?b.dayun.find(d=>d.isLiuNian):null;
  const fav=b.fav||[],unfav=b.unfav||[];
  const dmEl=b.dmEl;

  // 問題類型專屬評分
  if(type==='love'){
    // 感情看：桃花、官星（女命）/財星（男命）、夫妻宮
    if(b.shensha.includes('桃花'))baziScore+=12;
    if(b.shensha.includes('紅鸞'))baziScore+=10;
    if(b.shensha.includes('天喜'))baziScore+=8;
    if(b.shensha.includes('咸池'))baziScore+=5;
    // 女命看官殺（夫星），男命看財星
    if(S.form.gender==='female'){
      if(b.ep[BE_KE[dmEl]]>12)baziScore+=10; // 官星旺
      if(b.ep[BE_KE[dmEl]]>25)baziScore-=5; // 官殺混雜
    }else{
      if(b.ep[KE[dmEl]]>12)baziScore+=10; // 財星旺
    }
    // 大運帶桃花/紅鸞
    if(curDy&&(curDy.level.includes('旺盛')||curDy.level.includes('上升')))baziScore+=6;
    if(curDy&&curDy.level.includes('低迷'))baziScore-=8;
    // 流年沖日支（婚動）
    if(liuNian&&liuNian.score>1)baziScore+=5;
    if(liuNian&&liuNian.score<-1)baziScore-=5;
  }else if(type==='career'){
    // 事業看：官星、印星、食傷
    if(b.ep[BE_KE[dmEl]]>12)baziScore+=10; // 有官
    if(b.ep[BE_SHENG[dmEl]]>12)baziScore+=8; // 有印
    if(b.strong&&b.ep[KE[dmEl]]>10)baziScore+=6; // 身強有財可任
    if(!b.strong&&b.ep[dmEl]>15)baziScore+=5; // 身弱有比劫幫
    if(curDy&&(curDy.level.includes('旺盛')||curDy.level.includes('極強')))baziScore+=10;
    if(curDy&&curDy.level.includes('低迷'))baziScore-=10;
    if(b.shensha.includes('天乙貴人'))baziScore+=5;
    if(b.shensha.includes('文昌'))baziScore+=5;
  }else if(type==='wealth'){
    // 財運看：財星、食傷生財
    if(b.ep[KE[dmEl]]>15)baziScore+=15; // 財星旺
    if(b.ep[KE[dmEl]]>30)baziScore-=5; // 財多身弱反破
    const shang={'木':'火','火':'土','土':'金','金':'水','水':'木'}[dmEl];
    if(shang&&b.ep[shang]>10)baziScore+=8; // 食傷生財
    if(b.strong)baziScore+=6; // 身強能任財
    else baziScore-=4; // 身弱財難守
    if(curDy&&curDy.level.includes('旺盛'))baziScore+=8;
    if(curDy&&curDy.level.includes('低迷'))baziScore-=8;
    if(b.shensha.includes('天乙貴人'))baziScore+=3;
  }else if(type==='health'){
    // 健康看：五行偏枯、忌神強度
    const ep=b.ep||{};
    const total=Object.values(ep).reduce((a,v)=>a+v,0)||60;
    const weakCount=Object.values(ep).filter(v=>(v/total)<0.1).length;
    const strongCount=Object.values(ep).filter(v=>(v/total)>0.35).length;
    if(weakCount>=2)baziScore-=15; // 五行嚴重偏枯
    else if(weakCount===1)baziScore-=8;
    if(strongCount>=1)baziScore-=5;
    if(weakCount===0&&strongCount===0)baziScore+=10; // 五行均衡
    if(curDy&&curDy.level.includes('旺盛'))baziScore+=5;
    if(curDy&&curDy.level.includes('低迷'))baziScore-=8;
  }else{
    // 人際/家庭/其他：通用評分
    if(b.strong){
      if(b.ep[KE[dmEl]]>15)baziScore+=10;
      if(b.ep[BE_KE[dmEl]]>10)baziScore+=5;
    }else{
      if(b.ep[BE_SHENG[dmEl]]>15)baziScore+=10;
      if(b.ep[dmEl]>15)baziScore+=5;
    }
    if(curDy&&(curDy.level.includes('旺盛')||curDy.level.includes('上升')))baziScore+=8;
    if(curDy&&curDy.level.includes('低迷'))baziScore-=8;
    if(b.shensha.includes('天乙貴人'))baziScore+=5;
  }
  baziScore=Math.max(10,Math.min(90,baziScore));

  // — 梅花評分 —
  let mhScore=50;
  if(S.meihua){
    mhScore=analyzeMeihuaScore(S.meihua, type);
  }

  // — 塔羅評分 —
  let tarotScore=50;
  let tarotAnalysis=null;
  if(S.tarot.drawn.length>=10){
    tarotAnalysis=analyzeTarotSpread(S.tarot.drawn, type);
    tarotScore=tarotAnalysis.score;
    tarotScore=Math.max(10,Math.min(90,tarotScore));
  } else if(S.tarot.drawn.length){
    let pos=0,neg=0;
    S.tarot.drawn.forEach(c=>{
      if(c.isUp)pos+=0.5; else neg+=0.3;
    });
    tarotScore=Math.round(50+pos*5-neg*5);
    tarotScore=Math.max(10,Math.min(90,tarotScore));
  }

  // — 綜合（權重依問題類型動態調整）—
  // 感情：紫微夫妻>八字官殺桃花>塔羅輔助
  // 財運：八字財官流年>紫微財帛>塔羅輔助
  // 健康：八字五行偏枯>紫微疾厄>梅花
  // 事業：八字>梅花>塔羅
  const TYPE_WEIGHTS={
    love:  {bazi:0.35,meihua:S.meihua?0.2:0,tarot:S.tarot.drawn.length?0.3:0,ziwei:0.15},
    career:{bazi:0.4,meihua:S.meihua?0.25:0,tarot:S.tarot.drawn.length?0.2:0,ziwei:0.15},
    wealth:{bazi:0.45,meihua:S.meihua?0.2:0,tarot:S.tarot.drawn.length?0.2:0,ziwei:0.15},
    health:{bazi:0.5,meihua:S.meihua?0.2:0,tarot:S.tarot.drawn.length?0.15:0,ziwei:0.15}
  };
  const defaultW={bazi:0.4,meihua:S.meihua?0.25:0,tarot:S.tarot.drawn.length?0.25:0,ziwei:0.1};
  const weights=TYPE_WEIGHTS[type]||defaultW;

  // 紫微分數（依宮位看問題類型）
  let zwScore=50;
  if(S.ziwei&&S.ziwei.palaces){
    const palaceMap={love:5,career:9,wealth:4,health:8}; // 夫妻5,官祿9,財帛4,疾厄8
    const pIdx=palaceMap[type];
    if(pIdx!==undefined&&S.ziwei.palaces[pIdx]){
      const p=S.ziwei.palaces[pIdx];
      const majors=p.stars.filter(s=>s.type==='major');
      const minors=p.stars.filter(s=>s.type==='minor');
      // 廟旺加分，陷落減分
      majors.forEach(s=>{
        if(s.brightness==='廟'||s.brightness==='旺')zwScore+=8;
        else if(s.brightness==='陷'||s.brightness==='落')zwScore-=8;
        else zwScore+=2;
      });
      // 吉星加分
      minors.forEach(s=>{
        if(['文昌','文曲','左輔','右弼','天魁','天鉞'].includes(s.name))zwScore+=4;
        if(['擎羊','陀羅','火星','鈴星','地空','地劫'].includes(s.name))zwScore-=4;
      });
    }
    // 大限也看
    const dx=S.ziwei.daXian?S.ziwei.daXian.find(d=>d.isCurrent):null;
    if(dx){
      if(dx.level&&dx.level.includes('吉'))zwScore+=6;
      if(dx.level&&dx.level.includes('凶'))zwScore-=6;
    }
    zwScore=Math.max(10,Math.min(90,zwScore));
  }

  const totalW=weights.bazi+weights.meihua+weights.tarot+(weights.ziwei||0);
  const finalProb=Math.round((baziScore*weights.bazi+mhScore*weights.meihua+tarotScore*weights.tarot+zwScore*(weights.ziwei||0))/totalW);

  // Verdict（子意圖感知版）
  // 核心：prob 高 = 該領域運勢好
  // 「該不該離開」型問題 → 高分 = 現狀好 = 不需要離開（反向語義）
  // 「該不該做」型問題 → 高分 = 適合做（正向語義）
  let vlabel,vnote;
  const _q = question || '';
  
  // ── 六大領域反向問題偵測 ──
  // 事業：離職/跳槽
  const _isQuitQ = /離職|辭職|跳槽|換工作|換跑道|轉行|轉職|該不該離開|想走|不想做|要不要辭|該走嗎/.test(_q) && type==='career';
  // 感情：分手/離婚
  const _isBreakupQ = /分手|離婚|該不該離開|要不要分|斷捨離|要分嗎|該放手|不愛了/.test(_q) && type==='love';
  // 財運：賣出/停損
  const _isSellQ = /賣掉|出場|停損|該不該賣|脫手|該賣嗎|要不要出|出清|認賠/.test(_q) && type==='wealth';
  // 健康：該不該手術/要不要換醫生（高分=身體底子好=手術風險低，但不急）
  const _isSurgeryQ = /該不該開刀|要不要手術|要不要動刀|可以不開嗎|需要手術嗎/.test(_q) && type==='health';
  // 人際：該不該斷交/反擊
  const _isCutQ = /斷交|絕交|翻臉|要不要告|該不該告|反擊|攤牌|撕破臉|切割/.test(_q) && type==='relationship';
  // 家庭：分居/搬出/斷絕關係
  const _isLeaveHomeQ = /搬出去|分居|離家|斷絕|不來往|分家|要不要搬|該搬嗎/.test(_q) && type==='family';
  
  const _isInverseQ = _isQuitQ || _isBreakupQ || _isSellQ || _isSurgeryQ || _isCutQ || _isLeaveHomeQ;

  // 反向問題的領域標籤
  const _invDomainLabel = _isQuitQ?'事業':_isBreakupQ?'感情':_isSellQ?'財務':_isSurgeryQ?'健康':_isCutQ?'人際':_isLeaveHomeQ?'家庭':'';

  if(_isInverseQ){
    // 反向語義：高分=現狀運好=不需要離開/改變
    if(finalProb>=70){
      vlabel='現況良好・不建議變動 🟢';
      vnote=`多維度顯示你目前的${_invDomainLabel}能量正強，貿然改變反而損失機會。`;
    } else if(finalProb>=45){
      vlabel='現況尚可・審慎評估 ⚖️';
      vnote=`目前${_invDomainLabel}運勢不算差，但也沒有強到非維持不可。建議列出具體利弊再做決定。`;
    } else if(finalProb>=25){
      vlabel='現況偏弱・可以考慮 🔄';
      vnote=`目前${_invDomainLabel}磁場確實較低迷，如果有更好的選項，可以開始準備轉換。`;
    } else {
      vlabel='現況不佳・適合改變 ⚡';
      vnote=`多維度訊號偏弱，${_invDomainLabel}現狀的效益不高。如果有機會，這是轉變的時機。`;
    }
  } else {
    // 正向語義（預設）：高分=適合做
    if(finalProb>=70){vlabel='偏向可行 ✅';vnote='多維度指標偏一致，適合推進，但仍需按建議控管風險。';}
    else if(finalProb>=45){vlabel='中性偏可行 ⚖️';vnote='有利與阻力並存；照建議調整做法，勝率會上升。';}
    else if(finalProb>=25){vlabel='偏保守 ⚠️';vnote='阻力訊號較多，建議先降低成本/試水溫，再談放大。';}
    else{vlabel='不建議硬推 ⛔';vnote='目前象徵偏逆風；若要做，務必設停損與替代方案。';}
  }

  document.getElementById('r-vlabel').textContent=vlabel;
  document.getElementById('r-vprob').textContent=finalProb+'%';
  document.getElementById('r-vnote').textContent=vnote;
  document.getElementById('r-pfill').style.width=finalProb+'%';
  const _ch1 = S._usedCache ? '<div class="energy-locked-badge"><i class="fas fa-lock"></i> 此問題能量已鎖定 — 同人同日同一問題，卦象與牌陣維持首次結果（換問題則重新起卦）</div>' : '';
  document.getElementById('r-question').innerHTML=`<strong>問題：</strong>${question}<br><span class="tag tag-gold">${getTypeLabel(type)}</span>${(S.form.btime===''||!document.getElementById('f-btime')?.value)?'<br><span class="text-xs" style="color:var(--c-warn)"><i class="fas fa-exclamation-triangle"></i> 出生時間未填，以 12:00 估算，時柱及部分判定準確度降低</span>':''}${_ch1}`;
  // 第一屏也顯示問題+鎖定標記
  var _heroQ=document.getElementById('r-question-hero');
  if(_heroQ) _heroQ.innerHTML=`<strong>問題：</strong>${question} <span class="tag tag-gold" style="font-size:.75rem">${getTypeLabel(type)}</span>${_ch1}`;

  // Direct answer
  const answer=generateAnswer(type,finalProb,b,S.meihua,S.tarot);
  const hook=generateHook(type,finalProb,b,S.meihua,S.tarot,S.ziwei);
  // 主回答 = 完整問答分析（answer.text 已包含所有內容）
  document.getElementById('r-answer').innerHTML=answer.text;
  // 隱藏舊的「完整問答分析」卡
  var _fullEl=document.getElementById('r-answer-full');
  if(_fullEl) _fullEl.closest('.collapsible-card').style.display='none';
  document.getElementById('r-factors').innerHTML=answer.factors?`<div class="detail-toggle-wrap" style="margin-top:.5rem"><div class="detail-toggle-btn" onclick="this.parentElement.classList.toggle('open')" style="cursor:pointer;display:flex;align-items:center;gap:.5rem;color:var(--c-text-dim);font-size:.85rem;padding:.3rem 0"><i class="fas fa-chevron-right" style="font-size:.7rem;transition:transform .3s"></i><span>影響因子（${answer.factors.length}項）</span></div><div class="detail-toggle-body" style="max-height:0;overflow:hidden;transition:max-height .4s ease"><ul class="text-sm" style="padding:.5rem 1.2rem;color:var(--c-text-dim)">${answer.factors.map(f=>'<li style="margin:.3rem 0">'+f+'</li>').join('')}</ul></div></div>`:'';
  document.getElementById('r-suggest').innerHTML=answer.suggestions?`<h4 class="text-gold serif mt-md mb-sm">行動建議</h4><ol class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.suggestions.map(s=>'<li style="margin:.3rem 0">'+s+'</li>').join('')}</ol>`:'';

  // Probability breakdown
  document.getElementById('r-pbreak').innerHTML=`
    <p>八字命理：${baziScore}% (權重${Math.round(weights.bazi/totalW*100)}%)</p>
    ${S.meihua?`<p>梅花易數：${mhScore}% (權重${Math.round(weights.meihua/totalW*100)}%)</p>`:''}
    ${S.tarot.drawn.length?`<p>塔羅牌陣：${tarotScore}% (權重${Math.round(weights.tarot/totalW*100)}%)</p>`:''}
    ${S.ziwei?`<p>紫微斗數：${zwScore}% (權重${Math.round((weights.ziwei||0)/totalW*100)}%)</p>`:''}
    <p class="text-xs text-dim" style="margin-top:4px">問題類型「${getTypeLabel(type)}」→ 權重已依此調整</p>`;
  // Crystal recommendation
  renderCrystal(b);

  // Conclusion
  document.getElementById('r-conclusion').innerHTML=generateConclusion(type,finalProb,b,S.meihua,S.tarot);
}

function getTypeLabel(t){return{love:'感情',career:'事業',wealth:'財運',health:'健康',relationship:'人際',family:'家庭',general:'事業',other:'事業'}[t]||'事業'}

/* ═══════════════════════════════════════════════════════════
   問答對齊引擎 — 解析使用者問句，產出針對性回答
   ═══════════════════════════════════════════════════════════ */
function parseQuestionIntent(question, type) {
  const q = question || '';
  const result = {
    isYesNo: false,       // 是否是「會不會/能不能/好不好」
    isWhen: false,        // 何時
    isWho: false,         // 誰/什麼人
    isAge: false,         // 幾歲/年齡
    isHow: false,         // 如何/怎麼
    isCompare: false,     // A還是B
    isAmount: false,      // 多少/幾個
    isDirection: false,   // 方向/卻向/哪裡
    isShould: false,      // 該不該/要不要
    subject: '',          // 問題主題
    optionA: '',          // 選項A
    optionB: '',          // 選項B
    keywords: [],         // 關鍵詞
    rawQuestion: q
  };

  // 是非題
  if(/[會能可有]不[會能可有]|是否|是不是|好不好|適合嗎|行嗎|可以嗎|嗎[？?]?$|有機會|有希望|有可能|來得及|還有救|值得|划算/.test(q)) result.isYesNo = true;
  if(/該不該|要不要|應不應該|值不值/.test(q)) { result.isShould = true; result.isYesNo = true; }

  // 時間題
  if(/何時|什麼時候|幾時|多久|幾月|哪一年|今年|明年|幾年|還要等|等多久|哪時|後年/.test(q)) result.isWhen = true;

  // 年齡題
  if(/幾歲|多大|年齡|多老|年紀/.test(q)) result.isAge = true;

  // 誰/什麼人
  if(/是誰|什麼人|什麼樣的人|哪[個位種]人|什麼類型|什麼個性/.test(q)) result.isWho = true;

  // 如何題（排除「你覺得如何/怎樣」這類詢問意見的用法）
  if(/如何|怎麼[^？?]|怎麼樣才|怎樣[做才能]|方法|辦法|做法|策略|[該怎]麼辦|有什麼.*建議|可以怎[麼樣]/.test(q) && !/覺得如何|覺得怎[麼樣]|看法如何|意見如何|你覺得|如何[？?]$|怎樣[？?]$|怎麼樣[？?]$/.test(q)) result.isHow = true;
  // 「你覺得如何/怎樣」「...如何？」是詢問意見 → 當作 isYesNo 處理
  if(/覺得如何|覺得怎[麼樣]|看法如何|你覺得|你[看認]為|好不好|如何[？?]$|怎樣[？?]$|怎麼樣[？?]$/.test(q) && !result.isYesNo) result.isYesNo = true;

  // 選擇題 — 只有「還是」和「或」才是選擇，單獨的「是」不算
  const compareMatch = q.match(/(.{1,15})(?:還是|或者|或是)(.{1,15})/);
  if(compareMatch) {
    result.isCompare = true;
    result.optionA = compareMatch[1].trim();
    result.optionB = compareMatch[2].trim();
  }

  // 數量題
  if(/多少|幾[個位張條隻]/.test(q)) result.isAmount = true;

  // 方向題
  if(/哪裡|何處|卻哪|方向|地點|城市|國家/.test(q)) result.isDirection = true;

  // 提取關鍵詞
  const kw = q.replace(/[？?！!，,。.、的了嗎呢吧啊喔哦]/g, '').trim();
  result.keywords = kw.split(/\s+/).filter(w => w.length >= 2);

  // ═══ 主語方向偵測（主動vs被動）═══
  // 被動：等待對方/外部做某事
  result.isPassive = /有人|對方|他會|她會|他們會|別人|跟我|向我|來找我|主動找|會不會來|會來|追我|找我|連絡我|聯繫我|告白我|跟我告白|向我告白|對我|喜歡我|愛我|想我|回來找|有沒有人|會錄取|會加薪|會提拔|會升|會答應|會還|會通過|會同意|會幫|會支持|會接受|會原諒|公司會|老闆會|主管會|家人會|父母會|還我|給我|幫我/.test(q);
  // 主動：我去做某事
  result.isActive = /我[要想去該能可會]|我去|我主動|我追|我告白|我找|我聯繫|我連絡|能追到|追得到|追到|我能|我可以|我來|我做|我投|我買|我賣|我換|我辭|我創/.test(q);

  // ═══ 事業情境：創業者 vs 受僱者 ═══
  result.isEntrepreneur = /創業|副業|開店|接案|生意|擺攤|自營|自己做|自己開|當老闆|做生意|加盟|網拍|自由業|承包|外包|自媒體|開公司|營業/.test(q);
  result.isEmployee = /找工作|轉職|升遷|面試|加薪|跳槽|離職|考試|進修|任職|公司.*錄取|投履歷|新工作/.test(q);

  // ═══ 問他人運勢偵測 ═══
  // 使用者問的不是自己，而是某個第三方的運勢/狀況
  const thirdPartyMatch = q.match(/(?:母親|媽媽?|爸爸?|父親|兒子|女兒|小孩|孩子|老公|老婆|另一半|伴侶|男友|女友|前任|朋友|同事|老闆|主管|哥哥?|姐姐?|姊姊?|弟弟?|妹妹?|公公|婆婆|爺爺|奶奶|外公|外婆)(?:的|今年|最近|目前)?(?:運勢|運氣|狀況|身體|健康|工作|事業|財運|感情|姻緣|前途|未來|發展|情況|如何|怎麼樣|怎樣|好不好|好嗎)/);
  const thirdPartyMatch2 = q.match(/(?:今年|最近|目前)(?:母親|媽媽?|爸爸?|父親|兒子|女兒|小孩|孩子|老公|老婆|另一半|伴侶|男友|女友|前任|朋友|同事|老闆|哥哥?|姐姐?|姊姊?|弟弟?|妹妹?)(?:的)?(?:運勢|運氣|狀況|身體|健康|工作|事業|財運|感情|如何|怎麼樣|怎樣|好不好|好嗎)/);
  result.isThirdParty = !!(thirdPartyMatch || thirdPartyMatch2);
  result.thirdPartyRole = '';
  if(result.isThirdParty){
    const roleMatch = q.match(/母親|媽媽?|爸爸?|父親|兒子|女兒|小孩|孩子|老公|老婆|另一半|伴侶|男友|女友|前任|朋友|同事|老闆|主管|哥哥?|姐姐?|姊姊?|弟弟?|妹妹?|公公|婆婆|爺爺|奶奶|外公|外婆/);
    result.thirdPartyRole = roleMatch ? roleMatch[0] : '';
    // 判斷這個人對應八字的哪個六親
    const roleToBazi = {
      '母親':'印星','媽媽':'印星','媽':'印星','父親':'偏財','爸爸':'偏財','爸':'偏財',
      '兒子':'食傷','女兒':'食傷','小孩':'食傷','孩子':'食傷',
      '老公':'官殺','老婆':'財星','另一半':'配偶','伴侶':'配偶','男友':'官殺','女友':'財星',
      '前任':'配偶','朋友':'比劫','同事':'比劫','老闆':'官殺','主管':'官殺',
      '哥哥':'比肩','姐姐':'比肩','姊姊':'比肩','弟弟':'劫財','妹妹':'劫財',
      '哥':'比肩','姐':'比肩','姊':'比肩','弟':'劫財','妹':'劫財',
      '公公':'偏財','婆婆':'印星','爺爺':'偏財','奶奶':'印星','外公':'偏財','外婆':'印星'
    };
    result.thirdPartyBazi = roleToBazi[result.thirdPartyRole] || '';
    // 對應紫微宮位
    const roleToZiwei = {
      '母親':'父母','媽媽':'父母','媽':'父母','父親':'父母','爸爸':'父母','爸':'父母',
      '兒子':'子女','女兒':'子女','小孩':'子女','孩子':'子女',
      '老公':'夫妻','老婆':'夫妻','另一半':'夫妻','伴侶':'夫妻','男友':'夫妻','女友':'夫妻',
      '前任':'夫妻','朋友':'交友','同事':'交友','老闆':'官祿','主管':'官祿',
      '哥哥':'兄弟','姐姐':'兄弟','姊姊':'兄弟','弟弟':'兄弟','妹妹':'兄弟',
      '哥':'兄弟','姐':'兄弟','姊':'兄弟','弟':'兄弟','妹':'兄弟',
      '公公':'父母','婆婆':'父母','爺爺':'父母','奶奶':'父母','外公':'父母','外婆':'父母'
    };
    result.thirdPartyZiwei = roleToZiwei[result.thirdPartyRole] || '';
  }

  // 提取主題（六大方向都要有對應詞彙）
  const TOPIC_DICT = {
    love: /另一半|對象|他|她|伴侶|男友|女友|老公|老婆|愛人|戀人|曖昧|前任|桃花|結婚|離婚|復合|分手|告白|追|喜歡|暗戀|正緣|偏緣|緣分|姻緣|感情|戀愛|愛情|婚姻/,
    career: /工作|事業|公司|職業|升遷|轉職|創業|面試|老闆|同事|考試|學業|讀書|進修|加薪|離職|跳槽|副業|主管|職場|就業|換工作/,
    wealth: /錢|財|投資|股票|基金|房|薪水|收入|存款|理財|借貸|債|買|賣|賺|虧|開源|節流|中獎|偏財|正財/,
    health: /身體|健康|病|痛|不舒服|過敏|失眠|睡眠|疲勞|累|精神|情緒|壓力|焦慮|憂鬱|手術|開刀|懷孕|生育|視力|腸胃|心臟|肝|腎|肺|脾|頭|腰|背|皮膚|過勞|養生|中醫|西醫|減肥|運動|飲食|注意|調理|體質|免疫|血壓|血糖|濕氣/,
    relationship: /朋友|人際|社交|合作|貴人|小人|同學|鄰居|合夥|團隊|溝通|衝突|吵架|誤會|信任|被騙|背叛|口舌|是非/,
    family: /家人|父母|爸|媽|兒子|女兒|小孩|孩子|親子|長輩|公婆|婆媳|手足|兄弟|姊妹|家庭|搬家|房子|裝潢|遺產/
  };
  
  if(TOPIC_DICT[type]) {
    result.subject = q.match(TOPIC_DICT[type])?.[0] || {love:'感情',career:'事業',wealth:'財運',health:'身體狀況',relationship:'人際關係',family:'家庭'}[type];
  } else {
    result.subject = kw.slice(0, 10) || '所問之事';
  }
  
  // 健康專屬：辨識問的是哪個部位/症狀
  if(type === 'health') {
    result.healthOrgan = q.match(/肝|心|脾|胃|肺|腎|腸|膽|膀胱|頭|眼|耳|口|鼻|喉|腰|背|骨|關節|皮膚|血|神經/)?.[0] || null;
    result.healthSymptom = q.match(/痛|累|失眠|焦慮|憂鬱|過敏|發炎|腫|麻|暈|噁心|咳|喘|便秘|腹瀉|濕疹|掉髮/)?.[0] || null;
  }

  return result;
}

// ═══ 樂透號碼生成（各維度獨立推算 → 交叉驗證）═══
function generateLotteryNumbers(bazi, mh, tarot, question){
  if(!bazi||!bazi.dm) return '';
  const q=(question||S.form&&S.form.question||'').toLowerCase();

  // ── Step 0: 遊戲規格偵測 ──
  let lotteryType='lotto649';
  if(/威力彩|威力/.test(q)) lotteryType='power';
  else if(/539|今彩|今彩539/.test(q)) lotteryType='c539';
  else if(/雙贏|雙贏彩/.test(q)) lotteryType='double';
  else if(/刮刮樂|刮刮|後三碼|後3碼|3碼|三碼/.test(q)) lotteryType='scratch';
  else if(/運彩|球賽|體育|nba|mlb|足球|棒球|籃球|讓分|大小/.test(q)) lotteryType='sports';
  else if(/大樂透|大樂|樂透/.test(q)) lotteryType='lotto649';
  else if(/彩券|彩票|簽牌|明牌|選號|號碼|幾號|中獎/.test(q)) lotteryType='lotto649';

  const typeInfo={
    lotto649:{name:'大樂透', mainCount:6, mainMax:49, specialMax:0, desc:'6個號碼（1-49）'},
    power:{name:'威力彩', mainCount:6, mainMax:38, specialMax:8, desc:'第一區 6個（1-38）＋第二區 1個（1-8）'},
    c539:{name:'今彩539', mainCount:5, mainMax:39, specialMax:0, desc:'5個號碼（1-39）'},
    double:{name:'雙贏彩', mainCount:12, mainMax:24, specialMax:0, desc:'12個號碼（1-24）'},
    scratch:{name:'刮刮樂', mainCount:3, mainMax:9, specialMax:0, desc:'後三碼（0-9各一位）'},
    sports:{name:'運彩', mainCount:0, mainMax:0, specialMax:0, desc:'運彩分析'}
  };
  const info=typeInfo[lotteryType];
  const N=info.mainCount, MAX=info.mainMax;

  // ═══ 情境 C：運彩/競技投注 — 時空能量 ═══
  if(lotteryType==='sports'){
    const EL_DIR={金:'西',木:'東',水:'北',火:'南',土:'中央'};
    const favDir=EL_DIR[bazi.fav[0]]||'東';
    const EL_TIME={金:'酉時（17-19點）',木:'卯時（05-07點）',水:'子時（23-01點）',火:'午時（11-13點）',土:'未時（13-15點）'};
    let mhUseEl=bazi.fav[0];
    if(mh){
      const _ue=mh.useEl||(mh.ben?mh.ben.dn:null);
      if(_ue) mhUseEl=(typeof _ue==='object'?_ue.el:_ue)||mhUseEl;
    }
    const bestTime=EL_TIME[mhUseEl]||EL_TIME[bazi.fav[0]]||'未時（13-15點）';
    let html='<br><br>🏆 <strong>運彩時空能量分析</strong>';
    html+='<br><br>運彩不選號碼，選的是「時空磁場」。梅花用卦（'+mhUseEl+'行）與八字喜用（'+bazi.fav.join('、')+'）結合推算：';
    html+='<br><br>🧭 <strong>最佳方位</strong>：<span style="color:var(--c-gold);font-weight:700">'+favDir+'方</span>的投注站';
    html+='<br>🕐 <strong>最佳時辰</strong>：<span style="color:var(--c-gold);font-weight:700">'+bestTime+'</span>';
    html+='<br><br>在此時空窗口，憑當下直覺下注，與你命盤偏財磁場共振度最高。';
    if(bazi.strong) html+='<br>• 你的判斷力底子不差，適合果斷型投注';
    else html+='<br>• 適合保守打法，穩健型投注比賭勝負更穩';
    if(mh&&/吉/.test(mh.ty.f)) html+='<br>• 梅花卦象偏吉，今天直覺準度優於平常';
    else if(mh&&/凶/.test(mh.ty.f)) html+='<br>• 梅花卦象偏凶，今天判斷容易失準，不建議大注';
    html+='<br><br><span style="font-size:.72rem;font-style:italic;color:var(--c-text-muted)">＊本系統運用六維度玄學提取當下與您磁場共振之高頻數字。偏財實為命中福報之顯化，命理數據僅為輔助參考觀點之一，請理性娛樂，切勿過度沉迷或重金押注。</span>';
    return html;
  }

  // ═══════════════════════════════════════════════
  //  第一階段：六維度原始能量數字提取（Base Numbers）
  // ═══════════════════════════════════════════════
  const rawNums=[];
  const sources=[];
  const HT={水:[1,6],火:[2,7],木:[3,8],金:[4,9],土:[5,10]};
  const DZ_N={子:1,丑:2,寅:3,卯:4,辰:5,巳:6,午:7,未:8,申:9,酉:10,戌:11,亥:12};

  // 【1. 八字】喜用神 + 偏財星 → 河圖洛書數
  if(bazi.fav) bazi.fav.forEach(function(el){if(HT[el]){rawNums.push.apply(rawNums,HT[el]);sources.push('八字喜用('+el+')→'+HT[el].join(','));}});
  const pcEl=typeof KE!=='undefined'?KE[bazi.dmEl]:'';
  if(pcEl&&HT[pcEl]){rawNums.push.apply(rawNums,HT[pcEl]);sources.push('偏財星('+pcEl+')→'+HT[pcEl].join(','));}

  // 【2. 紫微斗數】化祿宮位地支數 + 財帛宮主星數
  if(S.ziwei){
    const zw=S.ziwei;
    const luH=zw.sihua?zw.sihua.find(function(h){return h.hua==='化祿';}):null;
    if(luH&&luH.palace){
      const luP=zw.palaces.find(function(p){return p.name===luH.palace;});
      if(luP){const dzI=DZ.indexOf(luP.branch)+1;rawNums.push(dzI);sources.push('紫微化祿('+luH.star+')在'+luP.branch+'→'+dzI);}
    }
    const caiP=zw.palaces[4];
    if(caiP){
      const starN={紫微:1,天機:2,太陽:3,武曲:4,天同:5,廉貞:6,天府:7,太陰:8,貪狼:9,巨門:10,天相:11,天梁:12,七殺:13,破軍:14};
      caiP.stars.filter(function(s){return s.type==='major';}).forEach(function(s){if(starN[s.name]){rawNums.push(starN[s.name]);sources.push('紫微財帛('+s.name+')→'+starN[s.name]);}});
    }
  }

  // 【3. 西洋星盤】木星/天王星度數 + 5宮/8宮宮頭
  if(S.natal&&S.natal.planets){
    const np=S.natal.planets;
    if(np['木星']&&typeof np['木星'].lon==='number'){const jd=Math.floor(np['木星'].lon%30)+1;rawNums.push(jd);sources.push('木星(幸運)度數→'+jd);}
    if(np['天王']&&typeof np['天王'].lon==='number'){const ud=Math.floor(np['天王'].lon%30)+1;rawNums.push(ud);sources.push('天王星(突發偏財)度數→'+ud);}
    if(S.natal.houses){
      const h5d=Math.floor(S.natal.houses[4]%30)+1;
      const h8d=Math.floor(S.natal.houses[7]%30)+1;
      if(!isNaN(h5d))rawNums.push(h5d);
      if(!isNaN(h8d))rawNums.push(h8d);
      sources.push('第5宮(投機)→'+(isNaN(h5d)?'N/A':h5d)+', 第8宮(偏財)→'+(isNaN(h8d)?'N/A':h8d));
    }
  }

  // 【4. 梅花易數】先天八卦數 + 動能數
  if(mh){
    const upN=mh.up?mh.up.n:0, loN=mh.lo?mh.lo.n:0;
    rawNums.push(upN,loN);
    const dynNum=(upN+loN)%10||10;
    rawNums.push(dynNum);
    sources.push('梅花上卦('+upN+')+下卦('+loN+')+動能→'+dynNum);
    if(mh.bian){
      const bUpN=(mh.bian.up||{}).n||0, bLoN=(mh.bian.lo||{}).n||0;
      if(bUpN)rawNums.push(bUpN);
      if(bLoN)rawNums.push(bLoN);
      if(bUpN||bLoN) sources.push('梅花變卦→'+(bUpN||'')+','+(bLoN||''));
    }
  }

  // 【5. 塔羅牌】結果位(10) + 機會位(5)
  if(tarot&&tarot.drawn&&tarot.drawn.length>=10){
    [9,4].forEach(function(idx){
      var c=tarot.drawn[idx]; if(!c)return;
      var cid=c.id;
      var tNum;
      if(cid<=21){tNum=cid;}  // 大牌 0-21
      else{
        var posInSuit=(cid-22)%14;
        tNum=posInSuit>=10?[11,12,13,14][posInSuit-10]:(posInSuit+1); // 宮廷牌→11-14
      }
      rawNums.push(tNum);
      sources.push('塔羅'+(idx===9?'結果位':'機會位')+'('+c.n+')→'+tNum);
    });
  }

  // 【6. 姓名學】總格+外格
  if(S.nameResult){
    var nr=S.nameResult;
    if(nr.totalGe&&nr.totalGe.num){rawNums.push(nr.totalGe.num);sources.push('姓名總格→'+nr.totalGe.num);}
    if(nr.waiGe&&nr.waiGe.num){rawNums.push(nr.waiGe.num);sources.push('姓名外格→'+nr.waiGe.num);}
  }

  // 時間因子（確保同時段結果固定）
  const now=new Date();
  const dayKey=now.getFullYear()+'-'+(now.getMonth()+1)+'-'+now.getDate();
  const hourBlock=Math.floor(now.getHours()/4);
  // 全局 NaN 過濾（防止任何維度回傳無效值污染整條數列）
  for(var _fi=rawNums.length-1;_fi>=0;_fi--){if(typeof rawNums[_fi]!=='number'||isNaN(rawNums[_fi])){rawNums.splice(_fi,1);}}
  function _hash(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h>>>0;}
  const timeSeed=_hash(dayKey+'-'+hourBlock+'-'+rawNums.join(','));

  // ═══════════════════════════════════════════════
  //  第二階段：Modulo Mapping + 頻率權重
  // ═══════════════════════════════════════════════
  // 將所有 rawNums 做 modulo，再加上 PRNG 補位
  function _prng(seed){return function(){seed|=0;seed=seed+0x6D2B79F5|0;let t=Math.imul(seed^seed>>>15,1|seed);t=t+Math.imul(t^t>>>7,61|t)^t;return((t^t>>>14)>>>0)/4294967296;};}

  var html='';

  // ═══ 情境 B：刮刮樂・六維度 3 碼分層萃取 ═══
  if(lotteryType==='scratch'){
    // ── 百位數：本命基底層（八字60% + 紫微40%）──
    var d100_bazi=0, d100_zw=0, d100_src_bazi='', d100_src_zw='';
    // 八字：喜用神洛書數
    if(bazi.fav&&bazi.fav[0]&&HT[bazi.fav[0]]){
      d100_bazi=HT[bazi.fav[0]][0]; // 取第一個洛書數
      d100_src_bazi='八字喜用神('+bazi.fav[0]+')洛書數→'+d100_bazi;
    }
    // 紫微：化祿宮地支數 or 財帛主星數
    if(S.ziwei){
      var _luH=S.ziwei.sihua?S.ziwei.sihua.find(function(h){return h.hua==='化祿';}):null;
      if(_luH&&_luH.palace){
        var _luP=S.ziwei.palaces.find(function(p){return p.name===_luH.palace;});
        if(_luP){var _dzIdx=(typeof DZ!=='undefined'?DZ.indexOf(_luP.branch):0)+1;d100_zw=_dzIdx;d100_src_zw='紫微化祿('+_luH.star+')在'+_luP.branch+'→'+_dzIdx;}
      }
      if(!d100_zw){
        var _caiP=S.ziwei.palaces[4];
        if(_caiP){
          var _sN={紫微:1,天機:2,太陽:3,武曲:4,天同:5,廉貞:6,天府:7,太陰:8,貪狼:9,巨門:10,天相:11,天梁:12,七殺:13,破軍:14};
          var _cMS=_caiP.stars.filter(function(s){return s.type==='major';})[0];
          if(_cMS&&_sN[_cMS.name]){d100_zw=_sN[_cMS.name];d100_src_zw='紫微財帛宮('+_cMS.name+')→'+d100_zw;}
        }
      }
    }
    var digit100=(d100_bazi+d100_zw)%10;
    var d100_explain=d100_src_bazi+(d100_src_zw?' ＋ '+d100_src_zw:'')+'，相加取尾數→'+digit100;

    // ── 十位數：環境變數層（星盤60% + 姓名40%）──
    var d10_natal=0, d10_name=0, d10_src_natal='', d10_src_name='';
    if(S.natal&&S.natal.planets){
      var _jup=S.natal.planets['木星'];
      if(_jup){d10_natal=_jup.house||1;d10_src_natal='木星在第'+d10_natal+'宮';}
      if(S.natal.houses){
        var _h5deg=Math.floor(S.natal.houses[4]%30)+1;
        d10_natal+=_h5deg;
        d10_src_natal+='＋第5宮度數尾數'+_h5deg;
      }
    }
    if(S.nameResult){
      var _nr=S.nameResult;
      if(_nr.totalGe&&_nr.totalGe.num){d10_name=_nr.totalGe.num;d10_src_name='姓名總格→'+d10_name;}
      else if(_nr.waiGe&&_nr.waiGe.num){d10_name=_nr.waiGe.num;d10_src_name='姓名外格→'+d10_name;}
    }
    var digit10=(d10_natal+d10_name)%10;
    var d10_explain=(d10_src_natal||'星盤未起')+(d10_src_name?' ＋ '+d10_src_name:'')+'，相加取尾數→'+digit10;

    // ── 個位數：當下機鋒層（梅花50% + 塔羅50%）──
    var d1_mh=0, d1_tarot=0, d1_src_mh='', d1_src_tarot='';
    if(mh&&mh.bian){
      var _bUp=(mh.bian.up||{}).n||0, _bLo=(mh.bian.lo||{}).n||0;
      d1_mh=_bUp+_bLo;
      d1_src_mh='梅花變卦 上卦('+_bUp+')+下卦('+_bLo+')='+d1_mh;
    } else if(mh){
      var _oUp=mh.up?mh.up.n:0, _oLo=mh.lo?mh.lo.n:0;
      d1_mh=_oUp+_oLo;
      d1_src_mh='梅花本卦 上卦('+_oUp+')+下卦('+_oLo+')='+d1_mh;
    }
    if(tarot&&tarot.drawn&&tarot.drawn.length>=10){
      var _outC=tarot.drawn[9]; // 結果位
      if(_outC){
        var _tid=_outC.id;
        if(_tid<=21){d1_tarot=_tid;}
        else{var _pis=(_tid-22)%14;d1_tarot=_pis>=10?[11,12,13,14][_pis-10]:(_pis+1);}
        d1_src_tarot='塔羅結果位('+_outC.n+')→'+d1_tarot;
      }
    }
    var digit1=(d1_mh+d1_tarot)%10;
    var d1_explain=(d1_src_mh||'梅花未起')+(d1_src_tarot?' ＋ '+d1_src_tarot:'')+'，相加取尾數→'+digit1;

    // ── 購買建議（依梅花/塔羅吉凶）──
    var buyAdvice='';
    var mhGood=mh&&mh.ty&&(mh.ty.r==='用生體'||mh.ty.f.includes('吉'));
    var tarotGood=tarot&&tarot.drawn&&tarot.drawn.length>=10&&tarot.drawn[9].isUp;
    if(mhGood&&tarotGood) buyAdvice='梅花卦象生體、塔羅結果位正位，當下能量場活躍，可多挑幾張試手氣。';
    else if(!mhGood&&!tarotGood) buyAdvice='梅花卦象偏消耗、塔羅結果位逆位，建議淺嘗輒止，買一兩張感受一下就好。';
    else if(mhGood) buyAdvice='梅花偏吉但塔羅有保留，小額嘗試即可。';
    else buyAdvice='塔羅正位但梅花偏耗，挑選時信任第一直覺，不要反覆比較。';

    // ── 渲染 ──
    html+='<br><br><div style="text-align:center;margin-bottom:.5rem"><span style="font-size:1.8rem">🎰</span></div>';
    html+='<div style="text-align:center;font-size:1.1rem;font-weight:700;color:var(--c-gold);margin-bottom:.3rem">刮刮樂・六維度專屬高頻尾數 3 碼</div>';
    html+='<div style="text-align:center;font-size:.78rem;color:var(--c-text-dim);margin-bottom:1rem">八字 × 紫微 × 星盤 × 姓名 × 梅花 × 塔羅</div>';

    // 大號碼顯示
    html+='<div style="display:flex;justify-content:center;gap:12px;margin:1rem 0">';
    var _dArr=[
      {d:digit100,label:'本命根基',color:'var(--c-gold)'},
      {d:digit10,label:'環境牽引',color:'#38bdf8'},
      {d:digit1,label:'當下直覺',color:'#a78bfa'}
    ];
    _dArr.forEach(function(item){
      html+='<div style="text-align:center">';
      html+='<div style="width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:800;background:rgba(212,175,55,.1);border:2px solid '+item.color+';color:'+item.color+'">'+item.d+'</div>';
      html+='<div style="font-size:.68rem;color:var(--c-text-dim);margin-top:4px">'+item.label+'</div>';
      html+='</div>';
    });
    html+='</div>';

    html+='<div style="text-align:center;font-size:.88rem;line-height:1.7;margin:.8rem 0;color:var(--c-text)">';
    html+='購買刮刮樂時，請挑選<strong style="color:var(--c-gold)">編號尾數包含 '+digit100+'、'+digit10+'、'+digit1+'</strong> 的彩券。';
    html+='</div>';

    // 邏輯拆解
    html+='<div style="margin-top:1rem;font-size:.8rem;line-height:1.7;color:var(--c-text-dim)">';
    html+='<p style="margin:.5rem 0"><span style="color:var(--c-gold);font-weight:700">🟡 本命根基碼 ['+digit100+']</span>：由你的八字喜用神與紫微財帛宮共振而出。'+d100_explain+'。這是你今日穩健求財的底氣來源。</p>';
    html+='<p style="margin:.5rem 0"><span style="color:#38bdf8;font-weight:700">🔵 環境牽引碼 ['+digit10+']</span>：由星象行星宮位與姓名數理碰撞而出。'+d10_explain+'。代表你走入彩券行時，與特定磁場最契合的頻率。</p>';
    html+='<p style="margin:.5rem 0"><span style="color:#a78bfa;font-weight:700">🟣 當下直覺碼 ['+digit1+']</span>：由梅花卦象與塔羅結果牌的機鋒顯現。'+d1_explain+'。代表購買那一瞬間最強烈的靈感指引。</p>';
    html+='</div>';

    // 行動建議
    html+='<div style="margin-top:.8rem;padding:.5rem .8rem;background:rgba(212,175,55,.06);border-left:3px solid rgba(212,175,55,.3);border-radius:0 6px 6px 0;font-size:.82rem;line-height:1.6">';
    html+='<p>📌 '+buyAdvice+'</p>';
    html+='</div>';
  } else {
    // ═══ 情境 A：選號型（大樂透/威力彩/539/雙贏彩）═══
    //
    // 設計原則：rawNums 是 1-14 的小數字種子，絕對不能直接當號碼。
    // 使用「區間強制散佈」：將 1~MAX 分 N 等份，每份必出一個號碼，
    // 號碼由命理種子 × 質數乘數決定，確保均勻覆蓋全區間。
    //
    const rng=_prng(timeSeed);

    // Step 1: 將所有 rawNums 壓成穩定的命理種子
    var seedHash=timeSeed;
    rawNums.forEach(function(n,i){seedHash=((seedHash*31)+(n||0)+i*7)|0;});
    var seedRng=_prng(seedHash>>>0);

    // Step 2: 區間強制散佈（Zone-Forced Distribution）
    var zoneWidth=Math.floor(MAX/N);
    var mainPicks=[];
    var PRIMES=[7,11,13,17,19,23,29,31,37,41];
    for(var zi=0;zi<N;zi++){
      var zoneStart=zi*zoneWidth+1;
      var zoneEnd=(zi===N-1)?MAX:((zi+1)*zoneWidth);
      var zoneRange=zoneEnd-zoneStart+1;

      // 命理種子 × 質數乘數 + 日期偏移 → 區間內選號
      var rawSeed=rawNums[zi%rawNums.length]||Math.floor(seedRng()*10)+1;
      var offset=Math.abs((rawSeed*PRIMES[zi%PRIMES.length])+(now.getDate()*3)+(hourBlock*11))%zoneRange;
      var pick=zoneStart+offset;
      if(pick>zoneEnd) pick=zoneStart+(pick-zoneStart)%zoneRange;

      // 碰撞檢測
      var attempts=0;
      while(mainPicks.includes(pick)&&attempts<zoneRange){pick++;if(pick>zoneEnd)pick=zoneStart;attempts++;}
      mainPicks.push(pick);
    }
    mainPicks.sort(function(a,b){return a-b;});

    // Step 3: 核心能量號 = rawNums 最高頻數字投射到全區間
    var rawFreq={};rawNums.forEach(function(n){rawFreq[n]=(rawFreq[n]||0)+1;});
    var topRaw=Object.keys(rawFreq).map(Number).sort(function(a,b){return rawFreq[b]-rawFreq[a];})[0]||rawNums[0]||1;
    var coreProjection=Math.round((topRaw/Math.max.apply(null,rawNums.concat([14])))*MAX);
    if(coreProjection<1)coreProjection=1;if(coreProjection>MAX)coreProjection=MAX;
    var coreNum=mainPicks.reduce(function(best,n){return Math.abs(n-coreProjection)<Math.abs(best-coreProjection)?n:best;},mainPicks[0]);

    // freq 物件（用於 UI 顯示共振次數）
    var freq={};rawNums.forEach(function(n){var mapped=Math.abs(n)%MAX||MAX;freq[mapped]=(freq[mapped]||0)+1;});
    mainPicks.forEach(function(n){freq[n]=(freq[n]||0)+0.5;});
    freq[coreNum]=(freq[coreNum]||0)+1;

    // 特別號
    let specialNum=0;
    if(info.specialMax>0){
      const spBase=rawNums.reduce(function(a,b){return(a||0)+(b||0);},0);
      specialNum=Math.abs(spBase%info.specialMax)||info.specialMax;
      if(isNaN(specialNum)||specialNum<1) specialNum=Math.floor(rng()*info.specialMax)+1;
    }

    // Backup sets
    const rng2=_prng(timeSeed^0x7A35C1);
    const rng3=_prng(timeSeed^0xF19DA3);
    function genBackup(rngInst){
      var s=new Set();
      while(s.size<N){s.add(Math.floor(rngInst()*MAX)+1);}
      return Array.from(s).sort(function(a,b){return a-b;});
    }
    const bk1=genBackup(rng2), bk2=genBackup(rng3);

    html+='<br><br>🎰 <strong>'+info.name+'</strong> <span style="font-size:.82rem;color:var(--c-text-dim)">('+info.desc+')</span>';
    html+='<br><br><div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:4px 0"><strong style="color:var(--c-gold)">★ 主推：</strong>';
    mainPicks.forEach(function(n){
      var isCore=n===coreNum;
      html+='<span style="display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:50%;font-weight:700;font-size:.95rem;'+(isCore?'background:var(--c-gold);color:#1a0a00':'background:rgba(212,175,55,.12);color:var(--c-gold);border:1.5px solid rgba(212,175,55,.4)')+'">'+n+'</span>';
    });
    if(specialNum>0) html+='<span style="display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:50%;font-weight:700;font-size:.95rem;background:#e53935;color:#fff">'+specialNum+'</span>';
    html+='</div>';
    if(specialNum>0) html+='<div style="font-size:.7rem;color:var(--c-text-dim);margin-top:4px">'+(lotteryType==='power'?'紅色為第二區號碼':'紅色為特別號')+'</div>';
    html+='<div style="font-size:.78rem;color:var(--c-text-dim);margin-top:2px">核心能量號：<strong style="color:var(--c-gold)">'+coreNum+'</strong>（六維共振 '+Math.round(freq[coreNum])+'次）</div>';

    // 備選組
    html+='<br><div style="font-size:.82rem;color:var(--c-text-dim)">備選① '+bk1.join(', ')+'</div>';
    html+='<div style="font-size:.82rem;color:var(--c-text-dim)">備選② '+bk2.join(', ')+'</div>';
  }

  // ═══════════════════════════════════════════════
  //  第三階段：能量解析 + 免責風控
  // ═══════════════════════════════════════════════
  html+='<br><details style="margin-top:4px"><summary style="font-size:.78rem;cursor:pointer;color:var(--c-gold)">📊 六維度能量萃取明細（'+rawNums.length+'個原始數字）</summary>';
  html+='<div style="padding:6px 8px;font-size:.72rem;line-height:1.6;opacity:.6;margin-top:4px">';
  sources.forEach(function(s){html+='<p>• '+s+'</p>';});
  html+='<p style="margin-top:4px">原始數列：['+rawNums.join(', ')+']</p>';
  html+='<p>時間因子：'+dayKey+'（時段'+hourBlock+'）— 同時段結果固定</p>';
  html+='</div></details>';

  html+='<br><span style="font-size:.72rem;font-style:italic;color:var(--c-text-muted)">＊本系統運用六維度玄學提取當下與您磁場共振之高頻數字。偏財實為命中福報之顯化，命理數據僅為輔助參考觀點之一，請理性娛樂，切勿過度沉迷或重金押注。</span>';
  return html;
}
function generateQAResponse(intent, type, prob, bazi, mh, tarot) {
  const dm=bazi.dm, el=bazi.dmEl, strong=bazi.strong;
  const ep=bazi.ep||{};
  const fav=bazi.fav||[], unfav=bazi.unfav||[];
  const curDy=bazi.dayun?bazi.dayun.find(d=>d.isCurrent):null;
  const thisYear=new Date().getFullYear();
  let liuNian=null;
  if(curDy&&curDy.liuNian) liuNian=curDy.liuNian.find(l=>l.year===thisYear);
  const q=intent.rawQuestion||'';

  // ══════ 攔截：問他人運勢 ══════
  // 從使用者命盤的六親星/宮位推導，而非直接答自己的運勢
  if(intent.isThirdParty && intent.thirdPartyRole){
    const role = intent.thirdPartyRole;
    const baziRef = intent.thirdPartyBazi || '';
    const zwGong = intent.thirdPartyZiwei || '';

    // 從八字推導六親星的強弱
    let sixRelScore = 0;
    let sixRelEvidence = [];
    const sixRelMap = {'印星':typeof BE_SHENG!=='undefined'?BE_SHENG[el]:'','偏財':typeof KE!=='undefined'?KE[el]:'','食傷':typeof SHENG!=='undefined'?SHENG[el]:'','官殺':typeof KE_BY!=='undefined'?KE_BY:null,'財星':typeof KE!=='undefined'?KE[el]:'','比劫':el,'配偶':strong?typeof KE!=='undefined'?KE[el]:'':typeof KE_BY!=='undefined'?null:'','比肩':el,'劫財':el};
    // 簡化：從五行能量推估
    if(baziRef==='印星'){
      const inEl=typeof BE_SHENG!=='undefined'?BE_SHENG[el]:'';
      if(inEl && bazi.ep && bazi.ep[inEl]>20){sixRelScore+=2;sixRelEvidence.push('你命盤印星旺，代表'+role+'對你有力，'+role+'本身狀態不差');}
      else if(inEl && bazi.ep && bazi.ep[inEl]>10){sixRelScore+=1;sixRelEvidence.push('印星中等，'+role+'尚可');}
      else{sixRelScore-=1;sixRelEvidence.push('印星偏弱，'+role+'可能有些辛苦或與你緣分較薄');}
    } else if(baziRef==='偏財'){
      const caiEl=typeof KE!=='undefined'?KE[el]:'';
      if(caiEl && bazi.ep && bazi.ep[caiEl]>20){sixRelScore+=2;sixRelEvidence.push('偏財旺，'+role+'對你有助力，'+role+'自身也還不錯');}
      else if(caiEl && bazi.ep && bazi.ep[caiEl]>10){sixRelScore+=1;}
      else{sixRelScore-=1;sixRelEvidence.push('偏財偏弱，'+role+'可能比較辛勞');}
    } else if(baziRef==='食傷'){
      const shiEl=typeof SHENG!=='undefined'?SHENG[el]:'';
      if(shiEl && bazi.ep && bazi.ep[shiEl]>20){sixRelScore+=2;sixRelEvidence.push('食傷旺，'+role+'聰明有活力');}
      else if(shiEl && bazi.ep && bazi.ep[shiEl]>10){sixRelScore+=1;}
      else{sixRelScore-=1;sixRelEvidence.push('食傷弱，'+role+'發展可能較平淡');}
    } else if(baziRef==='官殺'){
      const guanEl=typeof KE_BY!=='undefined'&&typeof KE_BY==='object'?'':typeof KE!=='undefined'?Object.keys(KE).find(k=>KE[k]===el)||'':'';
      sixRelScore+=0; // 中性
      sixRelEvidence.push('從官殺星看'+role);
    } else {
      sixRelEvidence.push('從你的命盤推導'+role+'的狀況');
    }

    // 從紫微宮位推導
    let zwInfo = '';
    if(S.ziwei && zwGong){
      const GONG_MAP={'父母':9,'夫妻':2,'子女':3,'兄弟':7,'交友':7,'官祿':8};
      const gIdx = GONG_MAP[zwGong];
      if(gIdx!==undefined && S.ziwei.palaces[gIdx]){
        const palace = S.ziwei.palaces[gIdx];
        const stars = palace.stars || [];
        const goodStars=['紫微','天府','天同','天梁','天相','太陽','太陰'];
        const badStars=['擎羊','陀羅','火星','鈴星'];
        const hasGood = stars.some(s=>goodStars.includes(s.name));
        const hasBad = stars.some(s=>badStars.includes(s.name));
        const hasLu = stars.some(s=>s.hua==='化祿');
        const hasJi = stars.some(s=>s.hua==='化忌');
        if(hasLu){sixRelScore+=2;zwInfo=`紫微${zwGong}宮有化祿，${role}方面有福氣。`;}
        else if(hasGood&&!hasBad){sixRelScore+=1;zwInfo=`紫微${zwGong}宮吉星坐守，${role}狀況不錯。`;}
        else if(hasJi){sixRelScore-=2;zwInfo=`紫微${zwGong}宮有化忌，${role}方面要注意。`;}
        else if(hasBad){sixRelScore-=1;zwInfo=`紫微${zwGong}宮有煞星，${role}可能有些波折。`;}
        else{zwInfo=`紫微${zwGong}宮星曜中性，${role}狀況平穩。`;}
      }
    }

    // 大運對六親的影響
    let dyHint = '';
    if(curDy){
      if(curDy.level.includes('旺盛')||curDy.level.includes('極強')||curDy.level.includes('上升')){sixRelScore+=1;dyHint=`你目前大運${curDy.gz}（${curDy.level}），能量上升的時候，身邊的人也會受到正面影響。`;}
      else if((curDy.level.includes('偏弱')||curDy.level.includes('低迷')||curDy.level.includes('補運'))){sixRelScore-=1;dyHint=`你目前大運${curDy.gz}（${curDy.level}），運勢有壓力時，與${role}的互動也可能出現摩擦。`;}
      else{dyHint=`你目前大運${curDy.gz}（${curDy.level}），大運能量穩定中性。`;}
    }

    // 組裝回答
    let answer = '';
    const overall = sixRelScore >= 2 ? 'great' : sixRelScore >= 0 ? 'good' : 'tough';
    const aspect = q.match(/運勢|運氣|狀況|身體|健康|工作|事業|財運|感情|前途/)?.[0] || '運勢';

    if(overall==='great'){
      answer = `<strong>${role}今年${aspect}不錯。</strong> `;
      answer += `從你的命盤來看，代表${role}的六親星能量充足，表示${role}自身狀態良好，跟你的關係也和諧。`;
      if(zwInfo) answer += zwInfo;
      if(dyHint) answer += dyHint;
      answer += ` 有利時期多陪伴${role}、表達關心，雙方關係會更緊密。`;
    } else if(overall==='good'){
      answer = `<strong>${role}今年${aspect}尚可，沒有大問題。</strong> `;
      answer += `從你的命盤推導，${role}的狀況屬於平穩中有小波動。`;
      if(zwInfo) answer += zwInfo;
      if(dyHint) answer += dyHint;
      answer += ` 建議多關心${role}的${aspect==='健康'||aspect==='身體'?'飲食作息':'日常生活'}，有問題及早發現。`;
    } else {
      answer = `<strong>${role}今年可能會比較辛苦。</strong> `;
      answer += `從你的命盤來看，代表${role}的六親星能量偏弱，表示${role}可能面臨一些壓力或挑戰。`;
      if(zwInfo) answer += zwInfo;
      if(dyHint) answer += dyHint;
      answer += ` 建議多花時間陪伴${role}，主動關心${role}的狀況，有需要就幫忙分擔。`;
    }

    // 補充說明
    answer += `<p class="text-sm text-dim" style="margin-top:.8rem">💡 <strong>注意：</strong>此分析是從你的命盤推導${role}的狀況（六親星＋紫微宮位），能反映你與${role}之間的互動能量。若要精確分析${role}本人的運勢，需要${role}的出生時辰另行排盤。</p>`;

    const FD={金:'西方',木:'東方',水:'北方',火:'南方',土:'中央'};
    const FC={金:'白/銀',木:'綠',水:'藍/黑',火:'紅/紫',土:'黃/棕'};
    const favEl=fav[0]||'土';
    const tip=`想增強與${role}的和諧能量，可在家中${FD[favEl]}方位擺放綠植或水晶。`;

    return `<div style="border-left:3px solid var(--c-gold);padding-left:1rem;margin-bottom:1rem">${answer}</div><p class="text-sm text-dim" style="margin-top:.5rem">💡 ${tip}</p>`;
  }

  /* ═══ 綜合評分（四步分析法） ═══ */
  let score=0, evidence=[];
  // 大運（含互動分析）
  if(curDy){
    score+=curDy.score>0?Math.min(curDy.score*0.5,3):Math.max(curDy.score*0.5,-3);
    evidence.push('大運'+curDy.gz+'（'+curDy.level+'）');
    // 大運前5年/後5年
    if(curDy.ganScore&&curDy.zhiScore){
      const curAge=thisYear-(bazi.pillars?parseInt(bazi.pillars.year?.gan||0):0);
      // 粗略判斷在前5年還是後5年
      if(curDy.ganScore!==0) evidence.push('天干'+curDy.gz[0]+(curDy.ganScore>0?'（喜·前五年順）':'（忌·前五年逆）'));
    }
    // 大運關鍵互動
    if(curDy.notes) curDy.notes.forEach(n=>evidence.push(n));
  }
  // 流年（含三柱互動）
  if(liuNian){
    score+=liuNian.score>0?Math.min(liuNian.score*0.4,3):Math.max(liuNian.score*0.4,-3);
    evidence.push('今年流年'+liuNian.gz+'（'+liuNian.level+'）');
    if(liuNian.notes) liuNian.notes.slice(0,3).forEach(n=>evidence.push(n));
    // 流年事象推導
    if(liuNian.events&&liuNian.events.length) evidence.push('事象：'+liuNian.events[0]);
  }

  // 八字調候
  if(bazi.tiaohou){
    const th=bazi.tiaohou;
    if(th.reason) evidence.push('調候：'+th.reason);
    if(th.needed&&th.needed.length) evidence.push('需要'+th.needed.join('、')+'行調節');
  }

  // 八字十神格局
  if(bazi.tenGod){
    const tg=bazi.tenGod;
    // 月令十神=格局
    if(tg.month) evidence.push('月令十神：'+tg.month+'（格局定位）');
  }

  // 日主坐支十神
  if(bazi.pillars&&bazi.pillars.day){
    const dayZhi=bazi.pillars.day.zhi;
    if(dayZhi){
      const dzGod=bazi.tenGodMap?bazi.tenGodMap[dayZhi]:'';
      if(dzGod) evidence.push('日支（婚姻宮）：'+dzGod);
    }
  }

  // 五行比例失衡提示
  if(bazi.ep){
    const epArr=Object.entries(bazi.ep).sort((a,b)=>b[1]-a[1]);
    if(epArr.length>=5){
      const strongest=epArr[0], weakest=epArr[epArr.length-1];
      if(strongest[1]>=35) evidence.push('五行'+strongest[0]+'過旺（'+strongest[1]+'%），注意相關臟腑');
      if(weakest[1]<=5) evidence.push('五行'+weakest[0]+'極弱（'+weakest[1]+'%），為命盤短板');
    }
  }

  // ═══ 紫微斗數輔助判定（象徵體系）═══
  const zw=S.ziwei;
  let zwDxHint='', zwLnHint='', zwDxTheme='', zwLnFocus='';
  if(zw){
    const TYPE_GONG={love:'夫妻',career:'官祿',wealth:'財帛',health:'疾厄',relationship:'交友',family:'田宅'};
    const relevantGong=TYPE_GONG[type];

    // 紫微大限
    const curDx=zw.daXian?zw.daXian.find(d=>d.isCurrent):null;
    if(curDx){
      const dxAdj=curDx.score>0?Math.min(curDx.score*0.3,2.5):Math.max(curDx.score*0.3,-2.5);
      score+=dxAdj;

      // 大限主星亮度
      let dxInfo='紫微大限走「'+curDx.palaceName+'」宮（'+curDx.level+'）';
      if(curDx.bright&&curDx.bright.length){
        const brightStr=curDx.bright.map(b=>b.star+b.label).join('、');
        dxInfo+='，'+brightStr;
      }
      evidence.push(dxInfo);

      // 大限宮位象徵
      if(curDx.theme){zwDxTheme=curDx.theme;evidence.push('十年主題：'+curDx.theme);}

      // 大限星曜組合notes（廟旺+吉煞+特殊格局）
      if(curDx.notes){
        curDx.notes.slice(0,5).forEach(n=>{
          if(!n.includes('大限')) evidence.push('大限宮：'+n); // 避免重複前綴
          else evidence.push(n);
        });
      }

      // 大限四化對問題方向
      if(curDx.hua&&curDx.hua.length){
        curDx.hua.forEach(h=>{
          if(h.palace===relevantGong){
            if(h.hua==='化祿'){score+=1.5;evidence.push('大限'+h.star+'化祿入'+h.palace+'→ 此方面有福氣');}
            if(h.hua==='化權'){score+=1;evidence.push('大限'+h.star+'化權入'+h.palace+'→ 有掌控力');}
            if(h.hua==='化科'){score+=0.5;evidence.push('大限'+h.star+'化科入'+h.palace+'→ 貴人相助');}
            if(h.hua==='化忌'){score-=1.5;evidence.push('大限'+h.star+'化忌入'+h.palace+'→ 此方面有困擾');}
          }
          if(h.palace==='命宮'){
            if(h.hua==='化祿'){score+=0.5;evidence.push('大限化祿入命，整體加持');}
            if(h.hua==='化忌'){score-=0.5;evidence.push('大限化忌入命，整體壓力');}
          }
        });
      }
      zwDxHint=curDx.palaceName+'（'+curDx.stars.join('、')+' '+curDx.level+'）';
    }

    // 紫微流年盤
    if(zw.getLiuNianZw){
      try{
        const zwLn=zw.getLiuNianZw(thisYear);
        if(zwLn){
          const lnAdj=zwLn.score>0?Math.min(zwLn.score*0.25,1.5):Math.max(zwLn.score*0.25,-1.5);
          score+=lnAdj;

          // 流年命宮+亮度
          let lnInfo='紫微流年命宮走「'+zwLn.mingPalace+'」';
          if(zwLn.bright&&zwLn.bright.length) lnInfo+='（'+zwLn.bright.map(b=>b.star+b.label).join('、')+' ）';
          evidence.push(lnInfo);
          if(zwLn.focus){zwLnFocus=zwLn.focus;evidence.push('今年重點：'+zwLn.focus);}

          // 流年星曜組合notes
          if(zwLn.notes) zwLn.notes.slice(0,3).forEach(n=>evidence.push('流年：'+n));

          // 流年四化對問題方向
          if(zwLn.hua&&zwLn.hua.length){
            zwLn.hua.forEach(h=>{
              if(h.palace===relevantGong||h.palace==='命宮'){
                if(h.hua==='化祿'){score+=1;evidence.push('流年'+h.star+'化祿入'+h.palace);}
                if(h.hua==='化忌'){score-=1;evidence.push('流年'+h.star+'化忌入'+h.palace);}
              }
            });
          }
          zwLnHint=zwLn.mingPalace;
        }
      }catch(e){}
    }

    // 身宮
    if(zw.shenIdx!==undefined&&typeof ZW_PALACES!=='undefined'){
      evidence.push('身宮在「'+ZW_PALACES[zw.shenIdx]+'」（後天努力方向）');
    }

    // 命宮主星
    if(zw.palaces&&zw.palaces[0]){
      const mingM=zw.palaces[0].stars.filter(s=>s.type==='major').map(s=>s.name+(s.bright?'('+s.bright+')':'')).join('、');
      if(mingM) evidence.push('紫微命宮：'+mingM);
    }

    // 格局判斷
    if(zw.palaces&&zw.palaces[0]){
      const mStars=zw.palaces[0].stars.map(s=>s.name);
      if(mStars.includes('紫微')&&mStars.includes('天府')) evidence.push('格局：紫府同宮（大格局，穩定有貴氣）');
      if(mStars.includes('七殺')&&mStars.includes('破軍')) evidence.push('格局：殺破狼（開創變動型）');
      if(mStars.includes('天機')&&mStars.includes('天梁')) evidence.push('格局：機梁（智謀型，適合幕僚策劃）');
      if(mStars.includes('天同')&&mStars.includes('天梁')) evidence.push('格局：同梁（福壽型，一生平穩）');
      if(mStars.includes('武曲')&&mStars.includes('天府')) evidence.push('格局：武府（理財型，財庫穩固）');
      if(mStars.includes('太陽')&&mStars.includes('太陰')) evidence.push('格局：日月同宮（文武兼備，但易勞碌）');
      if(mStars.includes('廉貞')&&mStars.includes('貪狼')) evidence.push('格局：廉貪（桃花旺，交際手腕強）');
    }
  }
  if(mh){
    // 體用關係加分（核心判斷）
    const rel=mh.ty.r||'';
    const f=mh.ty.f||'';
    if(rel==='用生體'){score+=3;evidence.push('梅花體用：用生體（外力助益）');}
    else if(rel==='比和'){score+=2;evidence.push('梅花體用：比和（事順）');}
    else if(rel==='體克用'){score+=1;evidence.push('梅花體用：體克用（可掌控但費力）');}
    else if(rel==='體生用'){score-=1;evidence.push('梅花體用：體生用（付出多回報少）');}
    else if(rel==='用克體'){score-=3;evidence.push('梅花體用：用克體（外力阻礙）');}
    else{evidence.push('梅花卦象（'+f+'）');}

    // 本卦含義
    if(mh.ben&&mh.ben.m){evidence.push('本卦「'+mh.ben.n+'」：'+mh.ben.m);}

    // 互卦=發展過程
    if(mh.hu&&mh.hu.m){
      const huEl=mh.hu.n||'';
      const huGood=['泰','同人','大有','謙','豫','隨','臨','觀','噬嗑','賁','復','無妄','大畜','頤','離','咸','恆','大壯','晉','家人','益','萃','升','鼎','漸','豐','兌','渙','中孚','既濟'];
      const huBad=['否','遁','明夷','蹇','困','旅','小過','未濟','剝','蒙','訟','蠱','坎'];
      if(huGood.some(g=>huEl.includes(g))){score+=0.5;evidence.push('互卦「'+mh.hu.n+'」過程順利');}
      else if(huBad.some(b=>huEl.includes(b))){score-=0.5;evidence.push('互卦「'+mh.hu.n+'」過程有阻');}
    }

    // 變卦=最終走向（權重高）
    if(mh.bian&&mh.bian.m){
      evidence.push('變卦「'+mh.bian.n+'」→ '+mh.bian.m);
      const bn=mh.bian.n||'';
      const bGood=['泰','同人','大有','謙','豫','隨','臨','大畜','離','咸','恆','大壯','晉','家人','益','萃','升','鼎','漸','豐','兌','渙','中孚','既濟','乾','需','小畜','履'];
      const bBad=['否','遁','明夷','蹇','困','旅','小過','未濟','剝','蒙','訟','坎','蠱','姤','萎','損'];
      if(bGood.some(g=>bn.includes(g))){score+=1;evidence.push('變卦走向正面');}
      else if(bBad.some(b=>bn.includes(b))){score-=1;evidence.push('變卦走向需留意');}
    }

    // 動爻爻辭
    if(mh.ben&&mh.dong&&typeof getYaoCi==='function'){
      const yc=getYaoCi(mh.ben.n, mh.dong);
      if(yc&&!yc.includes('擴充中')){
        evidence.push('動爻（第'+mh.dong+'爻）：'+yc);
        if(yc.includes('吉')||yc.includes('利'))score+=0.5;
        if(yc.includes('凶')||yc.includes('厲'))score-=0.5;
      }
    }

    // 問題類型專屬解讀
    if(typeof getMeihuaTypeReading==='function'){
      const tr=getMeihuaTypeReading(mh, type);
      if(tr&&tr.reading) evidence.push('梅花針對此問：'+tr.reading);
    }

    // 卦辭
    if(mh.ben&&mh.ben.j) evidence.push('本卦卦辭：'+mh.ben.j);

    // 體用五行具體
    if(mh.tiG&&mh.yoG) evidence.push('體卦'+mh.tiG.n+'（'+mh.tiG.el+'）、用卦'+mh.yoG.n+'（'+mh.yoG.el+'）');
  }
  if(tarot&&tarot.drawn&&tarot.drawn.length>=10){
    // ★ 引用維度辯證結論（Celtic Cross 五步法）
    const _vTr=S._verdicts?S._verdicts.find(function(v){return v.dim==='塔羅';}):null;
    if(_vTr){
      if(_vTr.dir==='pos'){score+=2;evidence.push('塔羅牌陣整體正面（'+_vTr.verdict+'）');}
      else if(_vTr.dir==='neg'){score-=2;evidence.push('塔羅牌陣有壓力（'+_vTr.verdict+'）');}
      else{evidence.push('塔羅訊號矛盾（'+_vTr.verdict+'）');}
      if(_vTr.reason) evidence.push(_vTr.reason.substring(0,100));
    } else {
      // fallback: Celtic Cross 核心位分析
      const d=tarot.drawn;
      const core=d[0],chal=d[1],self=d[6],env=d[7],outcome=d[9],sub=d[2],con=d[4];
      // Step1 核心+阻礙
      const coreMeaning=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(core.id,core.isUp,type):'';
      if(coreMeaning) evidence.push('核心「'+core.n+'」'+(core.isUp?'正':'逆')+'：'+coreMeaning);
      const obMeaning=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(chal.id,chal.isUp,type):'';
      if(obMeaning) evidence.push('阻礙「'+chal.n+'」：'+obMeaning);
      // Step2 心理面
      if(sub.isUp!==con.isUp) evidence.push('⚡ 潛意識與意識目標矛盾（內心拉扯）');
      // Step4 現實條件
      if(self.isUp&&env.isUp){score+=2;evidence.push('自身+環境都支持');}
      else if(!self.isUp&&!env.isUp){score-=2;evidence.push('自身低迷＋環境不配合');}
      else if(!self.isUp){score-=1;evidence.push('自身狀態需調整（'+self.n+' 逆位）');}
      else if(!env.isUp){evidence.push('環境有阻力（'+env.n+' 逆位）');}
      // Step5 結果
      const outMeaning=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(outcome.id,outcome.isUp,type):'';
      if(outcome.isUp){score+=1;evidence.push('結果「'+outcome.n+' 正位」：'+(outMeaning||'走向正面'));}
      else{score-=1;evidence.push('結果「'+outcome.n+' 逆位」：'+(outMeaning||'需留意')+'（可透過調整改變）');}
    }
  }
  // ── 生肖姓名學加分 ──
  if(S.zodiacNameResult){
    const zn=S.zodiacNameResult;
    if(zn.isSacrifice){score-=2;evidence.push('姓名犧牲格（'+zn.zodiac+'見王/彩衣）');}
    else if(zn.isSnakePigClash){score-=1.5;evidence.push('姓名巳亥六衝');}
    else if(zn.overallLevel.includes('大吉')){score+=1.5;evidence.push('姓名生肖派（大吉）');}
    else if(zn.overallLevel==='吉'){score+=1;evidence.push('姓名生肖派（吉）');}
    else if(zn.overallLevel.includes('凶')){score-=1;evidence.push('姓名生肖派（'+zn.overallLevel+'）');}
  }
  // 姓名三才五格
  if(S.nameResult){
    const nr3=S.nameResult;
    if(nr3.sanCai) evidence.push('三才配置：'+nr3.sanCai.join('→')+'（'+nr3.sanCaiLevel+'）');
    if(nr3.renGe&&nr3.renGe.fortune) evidence.push('人格'+nr3.renGe.num+'畫（'+nr3.renGe.fortune.level+'）：主性格與中年運');
    if(nr3.diGe&&nr3.diGe.fortune) evidence.push('地格'+nr3.diGe.num+'畫（'+nr3.diGe.fortune.level+'）：主早年運與家庭');
    if(nr3.waiGe&&nr3.waiGe.fortune) evidence.push('外格'+nr3.waiGe.num+'畫（'+nr3.waiGe.fortune.level+'）：主人際與社會運');
    if(nr3.zongGe&&nr3.zongGe.fortune) evidence.push('總格'+nr3.zongGe.num+'畫（'+nr3.zongGe.fortune.level+'）：主一生總運');
  }
  // ? ? prob (finalProb) ????????,????
  // 判定閾值：與 verdict 標籤一致
  // >=78 大吉, >=65 偏吉, >=52 中性偏可行, >=40 中性偏保守, >=25 偏凶, <25 大凶
  const great = prob >= 65;
  const good  = prob >= 52;
  const bad   = prob < 40;

  /* 問法 */
  const isYN=intent.isYesNo, isWhen=intent.isWhen, isHow=intent.isHow;
  const isWhy=/為什麼|為何|怎麼會|什麼原因|原因|怎麼回事|怎麼了|發生什麼|什麼事|什麼問題|出了什麼/.test(q);
  const isChoice=intent.isShould||intent.isCompare;

  /* 時間 */
  let goodYears=[], badYears=[];
  const _thisYear = new Date().getFullYear();
  if(curDy&&curDy.liuNian){
    goodYears=curDy.liuNian.filter(ln=>ln.year>=_thisYear&&(ln.level.includes('旺盛')||ln.level.includes('極強')||ln.level.includes('上升')||ln.level==='大吉'||ln.level==='中吉')).map(ln=>ln.year+'年').slice(0,3);
    badYears=curDy.liuNian.filter(ln=>ln.year>=_thisYear&&(ln.level.includes('凶')||ln.level.includes('低迷')||ln.level.includes('補運'))).map(ln=>ln.year+'年').slice(0,2);
  }
  const yearInfo=goodYears.length?(goodYears[0]===(_thisYear+'年')?'今年就是好時機，把握當下。':'近期有利年份：'+goodYears.join('、')+'，屆時運勢會明顯好轉。'):'';
  const dyInfo=curDy?'目前大運'+curDy.gz+'（'+curDy.level+'）'+(curDy.notes&&curDy.notes.length?'，'+curDy.notes[0]:'')+'。':'';
  // 流年事象提示
  let lnEventHint='';
  if(liuNian&&liuNian.events&&liuNian.events.length) lnEventHint=liuNian.events[0];
  let lnClashHint='';
  if(liuNian&&liuNian.clash&&liuNian.clash.length) lnClashHint=liuNian.clash.map(c=>{const g=typeof GONG_EVENT!=='undefined'?GONG_EVENT[c]:null;return g?g.domain:'';}).filter(x=>x).join('、');

  /* 行動 */
  const favEl=fav[0]||'土';
  const FC={金:'白/銀',木:'綠',水:'藍/黑',火:'紅/紫',土:'黃/棕'};
  const FD={金:'西方',木:'東方',水:'北方',火:'南方',土:'中央'};
  
  // ═══ 安全水晶推薦器：根據忌神自動替換 ═══
  const _crystalElMap={'鈦晶':'金','白水晶':'金','金髮晶':'金','純銀飾品':'金','黃鐵礦':'金',
    '綠幽靈':'木','東陵玉':'木','綠碧璽':'木','翡翠':'木','橄欖石':'木','綠月光':'木','老山檀香圓珠':'木',
    '黑曜石':'水','海藍寶':'水','月光石':'水','藍紋瑪瑙':'水','黑髮晶':'水','拉利瑪':'水',
    '紅瑪瑙':'火','石榴石':'火','紫水晶':'火','紅紋石':'火','太陽石':'火','粉晶':'火','天鐵':'火',
    '黃水晶':'土','虎眼石':'土','茶晶':'土','龍宮舍利':'土'};
  const _elCrystalFallback={金:'白水晶',木:'綠幽靈',水:'海藍寶',火:'紅瑪瑙',土:'黃水晶'};
  const _unfavSet=new Set(unfav);
  function _safeCrystal(name){
    const el=_crystalElMap[name];
    if(el && _unfavSet.has(el)){
      return _elCrystalFallback[favEl]||'白水晶';
    }
    return name;
  }
  function _safeCrystalPair(name1, name2){
    const s1=_safeCrystal(name1), s2=_safeCrystal(name2);
    if(s1===s2) return s1;
    return s1+'或'+s2;
  }

  let answer='', detail='', tip='';

  // ================== 💕 感情 ==================
  if(type==='love'){
    const pk=bazi.shensha&&bazi.shensha.includes('桃花');
    const hl=bazi.shensha&&bazi.shensha.includes('紅鸞');
    if(isYN){
      if(/復合|回來|挽回/.test(q)){
        const passive=intent.isPassive||/他會|她會|會回來|會不會回/.test(q);
        if(passive){
          // 被動：對方會回來嗎
          if(great) answer='<strong>有機會。</strong> 運勢顯示你們之間的緣分還沒斷，對方心裡還有你的位置。不需要刻意做什麼，保持好自己的狀態，對方會注意到你的改變。';
          else if(good) answer='<strong>有一些可能。</strong> 對方可能偶爾會想起你，但還沒下定決心。給對方空間，不要追得太緊，時間會幫你說話。';
          else answer='<strong>短期內不太樂觀。</strong> 對方目前沒有回頭的打算。與其等待，不如先專注自己的成長。緣分到了，自然會有轉機。';
        }else{
          // 主動：我要挽回/復合
          if(great) answer='<strong>有機會復合。</strong> 運勢顯示你們之間的緣分還沒斷，現在主動聯繫，對方接受的機率比你想的高。';
          else if(good) answer='<strong>有一些機會。</strong> 對方心裡還有你，但需要你先展現改變，而不是重蹈覆轍。';
          else answer='<strong>目前很難。</strong> 對方需要更多時間和空間，強行挽回反而會把人推得更遠。先專注自己的成長。';
        }
      }else if(/結婚|嫁|娶|求婚/.test(q)){
        if(great) answer='<strong>婚運很好！</strong> '+(hl?'你命帶紅鸞星，近期特別有利結婚。':'目前運勢非常支持步入婚姻。')+'如果雙方有共識，今年就是好時機。';
        else if(good) answer='<strong>時機逐漸成熟。</strong> 婚姻大事不急，但運勢是支持的。把關係穩定下來，自然水到渠成。';
        else answer='<strong>建議不急。</strong> 目前不是匆忙決定婚事的好時機，先確認彼此是否真的適合。';
      }else if(/喜歡|愛我|在意|心裡有我/.test(q)){
        if(/喜歡我|愛我|在意我|心裡有我/.test(q)){
          // 問對方對我的感覺
          if(good) answer='<strong>從命理看，你是有吸引力的。</strong> '+(pk?'你命帶桃花，異性緣本來就好。':'')+'對方對你有好感的機率不低，但最終還是要從互動中確認。你可以觀察對方有沒有主動找你聊天、約你出去的跡象。';
          else answer='<strong>對方可能還在猶豫。</strong> 目前你的感情磁場不夠強，可能讓對方感受不到明確的信號。試著多互動，讓對方有機會認識真正的你。';
        }else{
          // 問我喜歡的人（我喜歡他/她嗎等）
          if(good) answer='<strong>從你的桃花能量來看，你是有吸引力的。</strong> '+(pk?'你命帶桃花，異性緣本來就好。':'')+'跟著心走，不要過度分析。';
          else answer='<strong>你目前的感情磁場偏弱。</strong> 先把自己狀態調好，自信是最好的桃花。';
        }
      }else if(/追|告白|表白/.test(q)){
        const passive=intent.isPassive;
        if(passive){
          // 被動：有人會追我/跟我告白嗎
          if(great) answer='<strong>有機會！</strong> 你目前的桃花能量很強，'+(pk?'命帶桃花加上運勢大好，':'')+'確實容易吸引到主動靠近的人。保持開放的態度，機會就在身邊。';
          else if(good) answer='<strong>有一些可能。</strong> 你的魅力有被注意到，但對方可能還在觀望。如果你釋出一點善意的信號，對方更容易跨出那一步。';
          else answer='<strong>短期內可能要等等。</strong> 目前桃花能量不夠強，不太容易吸引到主動告白的人。先把自己狀態調到最好，自信本身就是最強的桃花。';
        }else{
          // 主動：我去追/告白
          if(great) answer='<strong>去吧！</strong> 運勢強力支持你主動出擊，真誠表達比套路更打動人。';
          else if(good) answer='<strong>可以試試。</strong> 但不要一次押太重，先從約對方吃飯開始，循序漸進。';
          else answer='<strong>先緩緩。</strong> 現在告白時機不太對，先從朋友關係慢慢經營，等感覺更熟了再說。';
        }
      }else if(/分手/.test(q)){
        if(good) answer='<strong>目前關係穩定。</strong> 運勢不支持分手的方向，有問題可以溝通解決。';
        else answer='<strong>感情確實在一個低潮期。</strong> 但低潮不代表要分手，先冷靜想想問題的根源是什麼。';
      }else if(/曖昧|模糊|什麼關係|算交往|友達以上|搞不清|在一起嗎|算不算/.test(q)){
        if(good) answer='<strong>這段曖昧有發展空間。</strong> 對方對你有好感但還在觀望。找好時機把話說清楚，曖昧太久反而消磨感情。';
        else answer='<strong>這段曖昧可能會拖比較久。</strong> 對方目前沒有明確要交往的意思。能接受不清不楚嗎？不行就直接問清楚。';
      }else if(/冷戰|冷淡|不理我|不回|已讀|消失|忽冷忽熱/.test(q)){
        if(good) answer='<strong>只是暫時的冷淡。</strong> 對方可能在處理自己的事。給一點空間但不要完全消失，偶爾傳個輕鬆的訊息就好。';
        else answer='<strong>要有心理準備。</strong> 對方的冷淡可能不只是一時的。先退一步把注意力放回自己身上。';
      }else if(/出軌|外遇|劈腿|偷吃|第三者|小三|花心/.test(q)){
        if(good) answer='<strong>目前看來關係是忠誠的。</strong> 不需要疑神疑鬼，信任是雙向的。一直懷疑反而會把對方推遠。';
        else answer='<strong>確實有些不穩定的信號。</strong> 感情磁場有波動但不代表一定有外遇。有疑慮就直接溝通，不要自己猜。';
      }else if(/異地|遠距|不同城市|不同國家/.test(q)){
        if(good) answer='<strong>異地但感情還在。</strong> 你們之間的連結還很強。固定的聯繫節奏和明確的見面計畫是關鍵。';
        else answer='<strong>異地確實有挑戰。</strong> 距離正在消磨感情。如果沒有結束異地的時間表，要認真討論未來了。';
      }else if(/年紀差|年齡差|差很多歲|姐弟|忘年/.test(q)){
        if(good) answer='<strong>年齡不是問題。</strong> 這段關係的核心是契合的。只要你們相處舒服就不需要在意別人眼光。';
        else answer='<strong>年齡差距帶來的不只是數字。</strong> 生活習慣和價值觀可能不同。需要在根本問題上好好溝通。';
      }else if(/前男友|前女友|前任|忘不了|放不下/.test(q)){
        if(good) answer='<strong>你有能力翻過這一頁。</strong> 感情能量正在恢復中。過去的已經過去了，往前走更好的在等你。';
        else answer='<strong>放下需要時間。</strong> 與其把能量花在離開的人身上不如投資讓自己變好的事。時間會治癒一切。';
      }else if(/吵架|爭吵|鬧|生氣|溝通不良|講不聽/.test(q)){
        if(good) answer='<strong>吵架是溝通的一種方式。</strong> 問題不大只是表達方式需要調整。先說我覺得而不是你都是。';
        else answer='<strong>頻繁的衝突確實消耗感情。</strong> 溝通模式出了問題。考慮找第三方聊聊會更清楚。';
      }else if(/見家長|見父母|家人反對|父母不同意/.test(q)){
        if(good) answer='<strong>時機不錯。</strong> 家庭方面的能量正面。準備好第一印象，禮貌大方做真實的自己就好。';
        else answer='<strong>可能要多準備。</strong> 長輩方面有些阻力。不要急著一次搞定，讓對方家人慢慢認識你。';
            }else if(/感情淡|沒感覺|無性|沒激情|婚姻倦怠|老夫老妻|沒愛了/.test(q)){
        if(good) answer='<strong>感情可以重新點燃。</strong> 運勢顯示你們之間還有連結。試著安排約會、做一些以前交往時做的事。感情需要經營。';
        else answer='<strong>確實進入了瓶頸期。</strong> 感情變淡不一定是不愛了，可能只是太習慣了。找時間認真談一次，看看彼此還想不想走下去。';
      }else if(/對的人|真命天子|靈魂伴侶|命中注定|適不適合|合不合/.test(q)){
        if(good) answer='<strong>從命盤來看你們的契合度不錯。</strong> 但沒有完美的另一半，只有願意一起成長的人。關鍵是你們處理問題的方式合不合。';
        else answer='<strong>你們之間確實有一些需要磨合的地方。</strong> 不代表不適合，但需要雙方都願意調整。如果只有你一個人在努力，那就要重新考慮了。';
      }else if(/網戀|交友軟體|網路認識|線上認識|網友/.test(q)){
        if(good) answer='<strong>這段網路緣分有發展空間。</strong> 但線上跟線下是兩回事。盡快安排見面，真實相處才能確認感覺。注意安全，第一次見面選公開場合。';
        else answer='<strong>先保持謹慎。</strong> 網路認識的人需要更多時間驗證。不要太快交心或給錢。如果對方一直找理由不見面，就要提高警覺。';
      }else if(/暗戀|單相思|喜歡但不敢說|怎麼讓.*注意/.test(q)){
        if(good) answer='<strong>運勢支持你踏出那一步。</strong> 暗戀只會越來越苦。不需要直接告白，可以先創造多相處的機會，讓對方認識真正的你。';
        else answer='<strong>目前時機還不太成熟。</strong> 先從朋友做起，多互動建立信任感。如果對方完全沒有回應，適時放手也是對自己好。';
      }else if(/選誰|選哪|兩個|A還是B|哪一個比較好|該選|跟誰/.test(q)){
        if(good) answer='<strong>你心裡其實有答案了。</strong> 選讓你感到安心的那個，不是讓你心跳加速的那個。心跳會退，安心不會。運勢偏向穩定的選擇。';
        else answer='<strong>兩個都不是最佳時機。</strong> 如果你猶豫不決代表都沒有到非他不可的程度。不急的話先都保持距離觀察，時間會幫你篩選。';
      }else if(/同居|住一起|搬去住/.test(q)){
        if(good) answer='<strong>可以考慮。</strong> 但同居前先談好生活習慣和經濟分擔。很多情侶同居後才發現不合適。';
        else answer='<strong>建議再等等。</strong> 目前感情還有些不穩定因素，同居可能會放大問題。';
      
      }else{
        const passive=intent.isPassive;
        if(passive){
          // 被動：有人會...嗎 / 他/她會...嗎
          if(great) answer='<strong>有機會的。</strong> 運勢顯示你在感情上有被眷顧的跡象，對方（或潛在對象）是有可能主動的。';
          else if(good) answer='<strong>有一些可能。</strong> 但需要一點時間醞釀，不要太著急。保持你的魅力和開放態度。';
          else if(!bad) answer='<strong>可能要再等等。</strong> 目前對方還沒有明確的行動跡象。順其自然，不要給自己太大壓力。';
          else answer='<strong>短期內比較難。</strong> 感情磁場偏弱，不太容易等到對方主動。先照顧好自己。';
        }else{
          if(great) answer='<strong>會的。</strong> 各方面運勢都指向正面，感情方面很有機會。';
          else if(good) answer='<strong>有機會。</strong> 多數指標正面，關鍵在於你願不願意主動。';
          else if(!bad) answer='<strong>有可能，但急不來。</strong> 條件還不完全成熟，邊調整邊等待。';
          else answer='<strong>目前比較困難。</strong> 感情能量偏弱，先把自己狀態調好再說。';
        }
      }
      tip='多穿'+FC[favEl]+'色系增加好感度。'+(pk?'桃花方位佩戴'+_safeCrystal('粉晶')+'效果更好。':'佩戴'+_safeCrystal('粉晶')+'提升桃花磁場。');
    }else if(isWhen){
      if(good) answer='<strong>時機正在成熟。</strong> '+dyInfo+yearInfo+(pk?'你有桃花，有利年份特別容易遇到對的人。':'多參加社交活動，緣分就在身邊。');
      else answer='<strong>需要再等等。</strong> '+dyInfo+'目前感情運還在醞釀中。'+yearInfo+'在有利年份多出門社交。';
      tip='有利時期穿'+FC[favEl]+'色出門，增加桃花能量。';
    }else if(isHow){
      answer='<strong>具體建議：</strong>';
      if(/挽回|復合/.test(q)) detail='不要苦苦哀求，那只會降低你的價值。先讓自己變得更好——外表、心態、生活都是。當對方看到你的改變，自然會重新被吸引。';
      else if(/桃花|認識|遇到/.test(q)) detail=(pk?'你本身桃花不錯，不是認識不到人，而是要選對人。':'多參加朋友聚會、興趣社團、運動課程，這些場合最容易遇到合適的對象。')+'不要宅在家等緣分來敲門。';
      else detail=(strong?'你容易太強勢，感情裡學會「示弱」，讓對方感受到被需要。':'你太被動了，喜歡就說，不要等對方來猜。很多緣分就是被「等」掉的。');
      tip='穿'+FC[favEl]+'色系、往'+FD[favEl]+'方向社交。佩戴'+_safeCrystalPair('粉晶','紅紋石')+'。';
    }else if(isWhy){
      if(/單身/.test(q)) answer=(strong?'<strong>你太有主見了。</strong> 條件不差但容易讓對方有壓力。試著放軟姿態，不要什麼都你說了算。':'<strong>你太被動了。</strong> 等待的人永遠在等待。緣分不會從天上掉下來，你得自己走出去。')+(bad?' 加上目前感情運低迷，確實不容易。但運勢會轉的，先準備好自己。':'');
      else if(/不順|吵|冷/.test(q)) answer=(good?'<strong>其實問題不大。</strong> 你們只是在磨合期，所有關係都會經歷這個階段。多溝通、少指責。':'<strong>感情確實在低潮。</strong> 但低潮是暫時的。先檢視自己在關係裡是不是太用力（或太不用力）了。');
      else answer=(strong?'<strong>你的控制欲可能讓對方喘不過氣。</strong> 愛不是掌控，是信任和空間。':'<strong>你在感情裡太委屈自己了。</strong> 一味退讓不會讓關係更好，反而讓對方不珍惜。');
      tip='調整心態比改變命運更有效。穿'+FC[favEl]+'色增強自信。';
    }else if(isChoice){
      if(good) answer='<strong>選讓你心安的那個。</strong> 運勢支持你做決定，跟著感覺走不會錯。';
      else answer='<strong>先不急著選。</strong> 目前判斷力可能受情緒影響，給自己一點時間觀察。';
      detail=strong?'你適合找能包容你強勢個性的人，太溫順的反而磨合多。':'你適合找給你安全感、能當靠山的人，不要被花言巧語迷惑。';
      tip='穿'+FC[favEl]+'色赴約，增加正確判斷力。';
    }else{
      if(great) answer='<strong>感情運很好！</strong> 今年是把握感情機會的黃金期。'+(pk?'命帶桃花加上大運吉，機會多到不行。':'主動出擊會有驚喜。');
      else if(good) answer='<strong>感情運不錯。</strong> 有發展空間，但需要你主動。'+(pk?'桃花星在，機會不缺。':'多出門社交，增加遇到對的人的機率。');
      else if(!bad) answer='<strong>感情運平穩。</strong> 不會有大波折，但驚喜也不多。好好經營現有關係是重點。';
      else answer='<strong>感情運偏弱。</strong> 今年感情方面可能有些阻力。不急，先把自己狀態調好，好運會來的。';
      tip='穿'+FC[favEl]+'色系提升魅力。'+(pk?'佩戴'+_safeCrystal('粉晶')+'加強桃花。':'');
    }
  }

  // ================== 💼 事業 ==================
  else if(type==='career'){
    const wc=bazi.shensha&&bazi.shensha.includes('文昌');
    const ym=bazi.shensha&&bazi.shensha.includes('驛馬');
    if(isYN){
      if(/升遷|升職|加薪|晉升/.test(q)){
        const passive=intent.isPassive||/會升|會提拔|會加薪|老闆會|主管會/.test(q);
        if(passive){
          // 被動：主管會提拔我嗎/公司會加薪嗎
          if(great) answer='<strong>機會很大。</strong> 運勢顯示你的表現有被上面看到，主管心裡有數。這段時間做好份內的事，好消息會自己來。';
          else if(good) answer='<strong>有可能，但不是板上釘釘。</strong> 你是候選人之一，但決定權不在你手上。做好表現、保持好的人際關係，等待結果。';
          else answer='<strong>短期內不太樂觀。</strong> 目前公司/主管可能還沒有這個打算。不要氣餒，繼續累積實力，時機到了自然會輪到你。';
        }else{
          if(great) answer='<strong>很有機會！</strong> 今年運勢強力支持升遷，你的努力會被上面看到。把握這波，主動爭取，別等著被提拔。';
          else if(good) answer='<strong>有機會，但要自己推一把。</strong> 運勢偏好，但光做不說不行。適度讓主管知道你的成果，別當隱形人。';
          else if(!bad) answer='<strong>機會有，但競爭激烈。</strong> 你可能不是唯一的候選人，需要在關鍵時刻展現不可替代的價值。';
          else answer='<strong>今年升遷有難度。</strong> 不是你不夠好，而是時機還沒到。先默默累積實力，你的機會在後面。';
        }
      }else if(/考上|考試|考過|上榜|考運/.test(q)){
        if(great) answer='<strong>考運很好！</strong> '+(wc?'你命帶文昌星，天生利考試，加上運勢大好，好好準備幾乎穩了。':'運勢強力支持，只要有充分準備，上榜機率很高。');
        else if(good) answer='<strong>有機會考上。</strong> '+(wc?'文昌星幫助你在考場上發揮得好。':'運勢偏好，把握衝刺時間。')+'最後這段時間的衝刺是關鍵。';
        else if(!bad) answer='<strong>有挑戰但不是沒機會。</strong> 運勢不算特別幫忙，代表你要比別人更拼才行。把讀書時間再加一成。';
        else answer='<strong>這次可能有點懸。</strong> 運勢對考試不太有利。如果是重要考試，建議多給自己一次機會（下次再考），不要太大壓力。';
      }else if(/轉職|換工作|離職|跳槽/.test(q)){
        // ★ prob 高=事業運好=留下有利；prob 低=事業運差=可以考慮走
        if(great) answer='<strong>你目前的事業能量很強，不建議貿然離職。</strong> '+(ym?'雖然你命帶驛馬適合變動，但現在運勢正好，離開反而浪費大好機會。留下來爭取更多籌碼。':'正值事業上升期，現在走等於放棄即將到手的果實。先把好處拿到再說。');
        else if(good) answer='<strong>目前事業運還不錯，不急著離開。</strong> 先把該談的薪資、升遷談完。如果真的有更好的外部機會，騎驢找馬也不遲，但別衝動裸辭。';
        else if(!bad) answer='<strong>事業運平平，可以開始物色新機會。</strong> 不用急著走，但可以開始更新履歷、投一投市場看看自己的身價。有了更好的 offer 再決定。';
        else answer='<strong>事業能量偏弱，現在確實是考慮轉換的時機。</strong> 留下來的效益不高，如果有機會就大膽去。但切記先拿到新 offer 再提離職，不要裸辭。';
      }else if(/創業|開店|開公司|自己做/.test(q)){
        if(great) answer='<strong>運勢非常支持創業！</strong> 天時地利人和都在你這邊。如果有準備好的項目，放手去做。';
        else if(good) answer='<strong>可以開始籌備。</strong> 但建議先試水溫——做副業或小規模測試，確認可行再全力投入。別一開始就 all in。';
        else if(!bad) answer='<strong>想法可以有，行動要謹慎。</strong> 運勢對創業不算特別有利，風險偏高。建議先累積更多資源和人脈再出手。';
        else answer='<strong>現在創業風險太高。</strong> 運勢不配合，失敗的機率大於成功。先穩穩工作，用業餘時間籌備，等運勢轉好再行動。';
      }else if(/裁員|失業|被開|被辭|資遣/.test(q)){
        if(good) answer='<strong>目前是安全的。</strong> 運勢穩定，不用太擔心。但也別因此鬆懈，保持好的表現是最好的保險。';
        else if(!bad) answer='<strong>有一些風險但可控。</strong> 做好本分、跟主管保持良好關係、別捲入辦公室政治，你就能穩住。';
        else answer='<strong>確實要有心理準備。</strong> 運勢顯示工作環境有不穩定因素。建議悄悄更新履歷、多留幾個備選方案，手上有選擇就不慌。';
      }else if(/面試|錄取|offer/.test(q)){
        const passive=intent.isPassive||/會錄取|會上|會通過|結果/.test(q);
        if(passive){
          // 被動：已面完等結果 / 公司會錄取我嗎
          if(great) answer='<strong>機會很大。</strong> 運勢顯示結果偏向正面，你的表現應該有留下好印象。耐心等消息。';
          else if(good) answer='<strong>有一定機會。</strong> 但可能需要再等一等，或者會有第二輪面試。不要因為等待就放棄其他機會。';
          else answer='<strong>結果可能不太理想。</strong> 不代表你不好，面試有很多變數。建議同時投其他公司，多一個選擇多一條路。';
        }else{
          if(great) answer='<strong>面試運很好！</strong> 自信地去，你的表現會讓對方印象深刻。';
          else if(good) answer='<strong>有機會錄取。</strong> 準備充分一點，把自己最好的一面展現出來。';
          else answer='<strong>可能需要多投幾家。</strong> 不要把期望放在一個籃子裡，多面試幾家增加機率。';
        }
            }else if(/主管|老闆|上司|被針對|被刁難|很機車|不公平|偏心/.test(q)){
        if(good) answer='<strong>跟上司的關係會好轉。</strong> 運勢顯示有貴人幫助。先忍一忍，做好自己的事，用成績說話。如果實在不合理就找更上一層反映。';
        else answer='<strong>職場上確實委屈了。</strong> 跟不對的主管硬碰硬只會吃虧。默默準備退路，同時紀錄不合理的對待，保護自己。';
      }else if(/讀什麼|科系|研究所|要不要念|升學|進修|留學/.test(q)){
        if(strong) answer='<strong>你適合挑戰型的領域。</strong> 商管、法律、資工這類有競爭性的科系適合你。進修對你的職涯會有明顯加分。';
        else answer='<strong>你適合專精型的領域。</strong> 選你真正有興趣的，不要只看出路。有熱情才能走得長久。如果是為了鍍金才念，效果會打折。';
      }else if(/退休|什麼時候.*退|夠不夠.*退|提早退休|退休金/.test(q)){
        if(good) answer='<strong>財務規劃方向正確。</strong> 按照目前的節奏持續累積，退休生活不用太擔心。重點是退休後要有事做，不然會無聊到生病。';
        else answer='<strong>再多準備一些比較安心。</strong> 目前的存款和被動收入可能還不夠支撐理想的退休生活。現在開始加強儲蓄和投資還來得及。';
      }else if(/副業|兼職|斜槓|接案|做生意/.test(q)){
        if(great) answer='<strong>副業運勢很好！</strong> 現在是發展第二收入的好時機。選跟你專業相關的副業成功率最高。';
        else if(good) answer='<strong>可以開始嘗試。</strong> 先從小規模開始週末花幾小時測試市場反應再加大投入。';
        else answer='<strong>現在不是好時機。</strong> 精力和運氣不足以支撐兩份工作。先把本業顧好。';
      }else if(/適合什麼行業|適合做什麼|什麼工作適合|方向|出路/.test(q)){
        if(strong) answer='<strong>你有領導力和決斷力。</strong> 適合管理、業務、創業型工作。往'+(FD[favEl]||'')+'方向發展更有利。';
        else answer='<strong>你適合專注細心的工作。</strong> 像是研究、技術、設計、教育等。往'+(FD[favEl]||'')+'方向發展更有利。';
      }else if(/同事|職場人際|辦公室政治|被排擠|被針對/.test(q)){
        if(good) answer='<strong>同事關係會改善。</strong> 主動釋出善意但不需要討好任何人。做好自己的事讓能力說話。';
        else answer='<strong>職場人際確實有壓力。</strong> 少說多做不站隊不傳話。維持專業距離就好。';
      }else if(/壓力大|好累|撐不住|倦怠|不想上班/.test(q)){
        if(good) answer='<strong>你只是需要充電。</strong> 問題不在工作本身而是太久沒休息了。安排一個假期吧。';
        else answer='<strong>確實到了臨界點。</strong> 運勢也在低谷。先處理最緊急的事其他能放就放。';
      }else if(/加班|被壓榨|做不完|工作量/.test(q)){
        if(good) answer='<strong>你的付出會被看到。</strong> 現在的辛苦是在累積籌碼。但也要學會設底線。';
        else answer='<strong>現在的處境確實不好受。</strong> 這份工作值得你這樣犧牲嗎？不值得就準備退路。';
      
      }else{
        if(great) answer='<strong>可以。</strong> 運勢各方面都支持，放手去做，會有好結果。';
        else if(good) answer='<strong>偏向可以。</strong> 多數指標正面，大膽行動。';
        else if(!bad) answer='<strong>有機會但要多努力。</strong> 不是不行，是需要比別人多推一把。';
        else answer='<strong>目前困難較多。</strong> 建議先蓄力等待更好時機。';
      }
      tip='穿'+FC[favEl]+'色去面試/重要場合。往'+FD[favEl]+'方向發展更有利。'+(wc?'考試進修是你的強項，多利用。':'');
    }else if(isWhen){
      if(good) answer='<strong>現在就是好時期。</strong> '+dyInfo+(yearInfo||'把握當下，別再猶豫。');
      else answer='<strong>最好再等等。</strong> '+dyInfo+(yearInfo||'先充實自己，等運勢轉好再出手。');
      tip='有利時期果斷行動，不利時期韜光養晦。';
    }else if(isHow){
      answer='<strong>給你三個具體建議：</strong>';
      detail='1️⃣ '+(strong?'你有領導力，爭取獨立負責項目或帶小團隊，展現管理能力。':'你適合當專業核心，把一項技能做到極致，讓自己不可替代。');
      detail+=' 2️⃣ '+(wc?'去考證照或進修，紙上談兵不如手上有牌。':'學一項新技能（AI工具、數據分析、語言能力），讓自己更有競爭力。');
      detail+=' 3️⃣ '+(ym?'你適合往外發展，跨區域或有出差機會的工作對你特別有利。':'找到一個賞識你的主管比什麼都重要，好老闆可以讓你少奮鬥十年。');
      tip='穿'+FC[favEl]+'色上班，往'+FD[favEl]+'方向通勤或開拓業務。';
    }else if(isWhy){
      if(/找不到|沒工作|失業/.test(q)) answer='<strong>不是你不行，是方法和時機的問題。</strong> '+(bad?'目前運勢偏弱，確實比較辛苦。但運勢是會轉的。':'運勢其實不差，問題可能在求職方向或面試表現上。')+'建議調整履歷亮點、擴大投遞範圍、找人模擬面試。';
      else if(/升遷|不順|卡住/.test(q)) answer=(strong?'<strong>你能力不差，但可能太有稜角。</strong> 職場不只看能力，也看關係。適度圓滑不是虛偽，是智慧。':'<strong>你太低調了。</strong> 默默做事但不被看到是職場最大的冤枉。學會「適度展現成果」，讓主管知道你做了什麼。')+(bad?' 加上目前運勢對事業不太配合，雙重影響下確實辛苦。':'');
      else if(/沒訂單|沒生意|沒客人|業績差|業績掉|營收|副業.*沒|接不到|沒案子/.test(q)) answer=(bad?'<strong>運勢確實在低谷期。</strong> 這段時間外在環境不太配合，不完全是你的問題。但等運勢不如主動調整——檢視你的產品定位、行銷管道是否需要更新，趁低谷期優化流程。':'<strong>問題可能出在策略而不是運氣。</strong> 運勢其實不差，建議回頭檢視：產品有沒有跟上市場需求？行銷方式是不是太單一？客戶回購率如何？有時候停下來調整方向，比硬撐更有效。')+(lnEventHint?' 今年事象提示：'+lnEventHint:'');
      else answer=(strong?'<strong>你可能太急了。</strong> 事業需要時間累積，不要因為一時的不順就全盤否定自己。':'<strong>你可能太安於現狀了。</strong> 舒適圈待久了就不想動了，但機會不會等你準備好才來。')+(bad?' 運勢目前偏弱，但這是階段性的，不是永久的。':'');
      tip='穿'+FC[favEl]+'色增強工作能量。';
    }else if(isChoice){
      if(/留|走|待/.test(q)){
        // ★ good=事業運好=留下有利
        answer=good?'<strong>建議留下來。</strong> 你目前事業能量不差，這個位置對你還有價值。不要被短期情緒影響，先穩住，把該拿的拿到再說。':'<strong>如果有更好的機會，可以考慮走。</strong> 目前事業能量偏弱，留下來的發展有限。找到更好的去處再做決定，不要為了逃離而跳槽。';
      }else{
        answer=good?'<strong>選發展空間大的。</strong> 運勢好的時候要勇於選擇挑戰，不要選安逸。':'<strong>選穩定的。</strong> 現在不適合冒險，先求穩定，等運勢好了再追求突破。';
      }
      tip='做重大決定前穿'+FC[favEl]+'色，往'+FD[favEl]+'方向的公司更有利。';
    }else{
      if(great) answer='<strong>事業運大好！</strong> 今年是衝刺的黃金期，升遷、加薪、新機會都有可能，別浪費這波好運。';
      else if(good) answer='<strong>事業運不錯。</strong> 有往上走的趨勢，保持積極態度，機會會找上你。';
      else if(!bad) answer='<strong>事業運平穩。</strong> 沒什麼大風浪，穩定前進就好。這段時間適合充電學習。';
      else answer='<strong>事業運偏弱。</strong> 職場上可能有壓力或小人。低調做事、少管閒事、保持實力最重要。';
      tip='穿'+FC[favEl]+'色上班。'+(wc?'利用文昌運進修考證。':'')+(ym?'往外發展有驛馬星助力。':'');
    }
    // ═══ 事業情境轉譯：創業者禁用受僱詞彙 ═══
    if(intent.isEntrepreneur){
      answer=answer.replace(/升遷|晉升|主管.*看到|被提拔|上面看到/g,function(m){
        return{'升遷':'事業突破','晉升':'事業拓展','被提拔':'接到大單'}[m]||'業務拓展';
      });
      answer=answer.replace(/上班/g,'工作');
      answer=answer.replace(/職場/g,'商場');
      answer=answer.replace(/同事/g,'合作夥伴');
      answer=answer.replace(/老闆|主管/g,'客戶/合作方');
      tip=tip.replace(/上班/g,'談生意').replace(/面試/g,'提案');
      // 低能量時給創業者專屬建議
      if(bad) answer+=' 目前蠟燭兩頭燒容易精力透支，建議維持最小可行規模（MVP），避免重金擴張。';
    }
  }

  // ================== 💰 財運 ==================
  else if(type==='wealth'){
    const caiEl=typeof KE!=='undefined'?KE[el]:'';
    const caiPct=caiEl&&bazi.ep?bazi.ep[caiEl]:0;
    // ★ 樂透/號碼類優先攔截（不分 YN / What 問法）
    if(/刮刮樂|樂透|彩券|彩票|威力彩|大樂透|運彩|539|今彩|雙贏|簽牌|明牌|幾號|選號|號碼|3碼|三碼|後三|開獎|中獎.*買|買.*中獎|中獎.*號|號.*中獎|中獎.*碼|碼.*中獎/.test(q)){
      const _wantsNums=/幾號|號碼|選號|哪幾|明牌|簽牌|報牌|給我|推薦.*號|開獎|3碼|三碼|後三/.test(q);
      const _asksWin=/會中|能中|中獎.*嗎|中嗎|會不會|能不能|有沒有機會|手氣|運氣|買.*中|中.*買/.test(q);
      
      if(_asksWin && !_wantsNums){
        // 使用者問「會不會中」→ 回答偏財運，不主動給號碼
        if(great&&caiPct>20) answer='<strong>偏財運不錯，小額試試手氣可以。</strong>但樂透這種事，命理只能看運勢高低，無法保證中獎。如果要買，控制預算，中了是驚喜，不中也不心疼。';
        else if(good) answer='<strong>偏財運還行，但沒有特別旺。</strong>小玩怡情可以，別把希望全押在上面。';
        else answer='<strong>坦白說，目前偏財運偏弱。</strong>不建議花太多錢買彩券，把錢用在更確定的地方比較實際。';
      } else {
        // 使用者要號碼 → 給號碼
        const _lotteryNums = generateLotteryNumbers(bazi, mh, tarot, q);
        if(_lotteryNums){
          answer='<strong>'+(caiPct>20&&great?'偏財運不錯，小試手氣可以。':'偏財運一般，小玩怡情就好，別當真。')+'</strong>';
          answer+=_lotteryNums;
        } else {
          answer='<strong>偏財運'+(great?'不錯':'一般')+'。</strong> 命理無法精準預測中獎號碼，但可以給你一些幸運數字參考。';
        }
      }
    }else if(isYN){
      if(/投資|股|基金|加密|幣|ETF/.test(q)){
        const waiting=/回本|解套|會漲|會跌|賣掉|出場|停損|抱|持有/.test(q);
        if(waiting){
          // 已入場：等結果/該不該出場
          if(great) answer='<strong>可以繼續持有。</strong> 運勢偏好，目前的投資有回升的機會。但記得設好停利點，見好就收。';
          else if(good) answer='<strong>還有一些機會。</strong> 短期可能震盪，但方向不算太差。如果已經快到停損點，就按紀律走。';
          else answer='<strong>建議認真考慮減碼。</strong> 運勢對投資不利，死扛不一定等得到回本。先保住本金，留得青山在。';
        }else{
          // 未入場：能不能投
          if(great) answer='<strong>目前投資運不錯。</strong> 卦象和運勢都偏向正面，適合進場。但記住：再好的運勢也要設停損，不要把全部家當壓上去。';
          else if(good) answer='<strong>小額投入可以。</strong> 運勢偏好但不到穩賺不賠，控制在你能承受損失的範圍內。試水溫就好，別梭哈。';
          else if(!bad) answer='<strong>建議觀望。</strong> 目前運勢對投資不算有利，如果已經有部位就抱著，沒有的話不急著進場。';
          else answer='<strong>不建議現在投資。</strong> 運勢顯示財運低迷，進場虧損的機率偏高。守住現金，等運勢轉好再說。';
        }
      }else if(/買房|置產|買車|大額/.test(q)){
        if(great) answer='<strong>可以入手。</strong> 運勢支持大額購置，如果是剛需而且預算允許，今年是好時機。';
        else if(good) answer='<strong>可以考慮，但別超出預算。</strong> 運勢偏好，但量力而為。貸款壓力不要超過收入的40%。';
        else answer='<strong>建議再等等。</strong> 現在財運不夠穩，大額支出容易造成後續壓力。不急的話，等運勢更好的時候再出手。';
      }else if(/債|還錢|借|貸款/.test(q)){
        const passive=intent.isPassive||/還我|會還|他還|她還|對方還|借出/.test(q);
        if(passive){
          // 被動：別人會還我錢嗎
          if(good) answer='<strong>有機會拿回來。</strong> 運勢偏好，對方有可能還，但不要完全被動等。找個適當的時機提醒一下，態度溫和但明確。';
          else answer='<strong>要有心理準備可能拿不全。</strong> 運勢對催債不太有利，對方可能拖或只還一部分。如果金額大，考慮留下書面證據或走法律途徑。錢借出去的時候就要想到可能回不來。';
        }else{
          if(good) answer='<strong>財務狀況會逐漸好轉。</strong> 運勢支持你改善財務，建議制定還款計畫，一步一步來。小的先還，大的慢慢談。';
          else answer='<strong>過程會比較辛苦，但不是還不了。</strong> 運勢偏弱代表需要更多時間。先控制不必要的開支，最低還款額一定要繳，別讓信用破掉。';
        }
      }else if(/偏財|中獎|橫財|彩票|運氣/.test(q)){
        if(great&&caiPct>20) answer='<strong>偏財運不錯。</strong> 你的財星旺加上運勢好，小試手氣可以。但偏財就是偏財，不能當成主要收入，點到為止。';
        else if(good) answer='<strong>偏財運一般。</strong> 不是完全沒有，但別抱太大期望。娛樂性質玩玩可以，認真投入就傻了。';
        else answer='<strong>偏財運偏弱。</strong> 目前不是靠運氣賺錢的時候，踏踏實實的正財才是王道。';
      }else if(/賺|收入|薪|進帳/.test(q)){
        const passive=intent.isPassive||/會加薪|老闆會|公司會/.test(q);
        if(passive){
          // 被動：老闆會加薪嗎 / 公司會調薪嗎
          if(great) answer='<strong>加薪機會很大。</strong> 運勢顯示你的價值有被看到，今年有可能得到加薪或獎金。保持好表現就行。';
          else if(good) answer='<strong>有一些機會。</strong> 但不是鐵板釘釘。如果很久沒調了，可以找適當時機跟主管談談，但要用成績說話。';
          else answer='<strong>短期內加薪可能有難度。</strong> 不是你不值得，而是公司或環境因素。可以先充實自己的能力，等更好的時機再爭取。';
        }else{
          if(great) answer='<strong>財運很好！</strong> 今年有機會增加收入，不管是加薪、獎金還是副業，積極爭取會有回報。';
          else if(good) answer='<strong>收入有成長空間。</strong> 運勢偏好，但錢不會自己跑來，主動開源是關鍵。';
          else answer='<strong>收入可能持平或有壓力。</strong> 今年不太適合期待大幅加薪，穩住現有收入最重要。';
        }
            }else if(/欠錢|被欠|還錢|借出去|要不回|賴帳|不還/.test(q)){
        if(good) answer='<strong>有機會要回來。</strong> 運勢支持債務處理。找個好時機好好談，態度堅定但不撕破臉。必要時留下書面紀錄。';
        else answer='<strong>要回來的機率不高。</strong> 對方可能真的沒錢或根本不想還。評估一下金額值不值得你花時間追。以後借錢記得寫借據。';
      }else if(/財運.*好轉|什麼時候.*有錢|何時.*發財|窮.*什麼時候/.test(q)){
        if(good) answer='<strong>財運已經在好轉了。</strong> 把握現在的機會多存多賺。你的有利方位在'+FD[favEl]+'，穿'+FC[favEl]+'色增強財運。';
        else answer='<strong>財運好轉還需要一點時間。</strong> 目前先穩住不要大支出。'+dyInfo+(yearInfo||'耐心等待運勢翻轉。');
      }else if(/保險|儲蓄險|理賠/.test(q)){
        if(good) answer='<strong>可以考慮。</strong> 運勢支持長期財務規劃。保險重保障不重投報率。';
        else answer='<strong>先顧好現金流。</strong> 運勢偏弱時不適合增加固定支出。先確保緊急預備金充足。';
      }else if(/被騙|詐騙|被坑|騙錢/.test(q)){
        if(bad) answer='<strong>確實要特別小心。</strong> 判斷力受影響容易被迷惑。任何要你先匯款或保證獲利的都要警覺。';
        else answer='<strong>基本上還好但防人之心不可無。</strong> 報酬率太高的一定有問題。大額支出前多問幾個人。';
      }else if(/合夥|合資|一起投資|股東/.test(q)){
        if(good) answer='<strong>可以合夥但要有規則。</strong> 權責分明帳目透明退出機制先談好。';
        else answer='<strong>合夥要非常謹慎。</strong> 目前運勢不太適合深度綁定。錢的事一定要白紙黑字。';
      }else if(/存錢|理財|怎麼存|省錢/.test(q)){
        if(good) answer='<strong>理財方向正確。</strong> 先存緊急預備金3到6個月生活費。運勢不錯可以考慮低風險基金。';
        else answer='<strong>穩穩來就好。</strong> 先存緊急預備金。記帳一個月你會發現錢都花在哪了。';
      }else if(/房貸|貸款壓力|繳不出|經濟壓力/.test(q)){
        if(good) answer='<strong>財務壓力會逐漸緩解。</strong> 可以考慮轉貸降息或增加副業收入。';
        else answer='<strong>確實辛苦但不是沒辦法。</strong> 先控制不必要開支。困難的話跟銀行談協商還款方案。';
      
      }else{
        if(great) answer='<strong>可以。</strong> 財運各方面條件都好，放心去做。';
        else if(good) answer='<strong>偏向可以。</strong> 有賺錢的機會，行動是關鍵。';
        else if(!bad) answer='<strong>有機會但要謹慎。</strong> 可以嘗試但控制風險。';
        else answer='<strong>目前建議保守。</strong> 守住現有的比追求新的更重要。';
      }
      tip='在'+FD[favEl]+'方位辦公或放錢包有助財運。穿'+FC[favEl]+'色談生意。';
    }else if(isWhen){
      const badYearInfo=badYears.length?'需注意年份：'+badYears.join('、')+'，這些年份要特別控制開支、避免冒險投資。':'';
      if(good) answer='<strong>目前財運就不錯。</strong> '+dyInfo+(yearInfo||'把握當下，開源節流雙管齊下。')+(badYearInfo?' '+badYearInfo:'');
      else answer='<strong>財運還在蓄勢中。</strong> '+dyInfo+(yearInfo?yearInfo+'等有利年份再積極出手。':'現階段先存錢、少花，等運勢好了再積極出手。')+(badYearInfo?' '+badYearInfo:'');
      tip='有利時期果斷出手，不利時期守住本金。';
    }else if(isHow){
      answer='<strong>給你三個理財建議：</strong>';
      detail='1️⃣ 開源：'+(caiPct>20?'你的財星旺，賺錢能力不差，重點是多找幾條收入管道（副業、接案、投資），別只靠死薪水。':'你的財星偏弱，靠運氣不如靠技術。學一項能變現的技能，比如寫程式、設計、線上教學。');
      detail+=' 2️⃣ 節流：每月固定存收入的20%，先存再花。記帳一個月，你會嚇一跳錢都花在哪裡了。';
      detail+=' 3️⃣ 投資：'+(good?'目前運勢支持投資，可以把閒錢放在低風險基金或ETF。':'現階段先存緊急預備金（3-6個月生活費），有了安全墊再想投資的事。');
      tip='錢包用'+FC[favEl]+'色，辦公桌往'+FD[favEl]+'方向。';
    }else if(isWhy){
      if(/存不到|月光|花光/.test(q)) answer='<strong>問題不在命，在習慣。</strong> 大部分人存不到錢不是因為賺得少，而是花得不知不覺。記帳30天你就知道問題在哪了。'+(bad?' 加上目前運勢財運偏弱，確實更容易有意外支出。':'');
      else if(/破財|虧|賠/.test(q)) answer=(bad?'<strong>目前運勢確實對財運不利。</strong> 這段時期容易有意外支出或判斷失誤。減少不必要的消費，不做高風險投資，撐過這段就好。':'<strong>可能是消費習慣或投資決策的問題。</strong> 運勢其實不差，檢視一下最近的支出和投資決定，是不是太衝動了。');
      else answer=(caiPct>20?'<strong>你不是不會賺，是不會守。</strong> 財星旺代表進帳能力好，但如果花得比賺得快，再旺也沒用。':'<strong>你的財星偏弱，需要比別人更努力開源。</strong> 不是命不好，是需要更有計畫地理財。')+(bad?' 目前運勢偏弱，更要控制支出。':'');
      tip='穿'+FC[favEl]+'色談錢。';
    }else if(isChoice){
      answer=good?'<strong>選回報更穩定的。</strong> 運勢好的時候可以稍微冒險，但也別貪。':'<strong>選風險低的。</strong> 現在不適合冒險，穩穩的比較安心。';
      tip='重大財務決定在'+FD[favEl]+'方位的銀行或辦公室進行。';
    }else{
      if(great) answer='<strong>財運大好！</strong> 今年是積極理財的好年份，加薪、獎金、副業、投資都有機會。別浪費這波。';
      else if(good) answer='<strong>財運不錯。</strong> 收入有成長空間，把握機會開源。';
      else if(!bad) answer='<strong>財運平穩。</strong> 不會大賺也不會大虧，穩定存錢最重要。';
      else answer='<strong>財運偏弱。</strong> 注意控制支出，避免衝動消費和高風險投資。';
      tip='穿'+FC[favEl]+'色增強財運。錢包放'+FD[favEl]+'方位。';
    }
  }

  // ================== 🏥 健康 ==================
  else if(type==='health'){
    const WO={金:'肺、呼吸系統、皮膚',木:'肝、眼睛、筋絡',水:'腎、泌尿系統、腰骨',火:'心臟、血壓、睡眠',土:'脾胃、消化系統'};
    const WF={金:'白色食物（山藥、百合、白蘿蔔、杏仁）',木:'綠色蔬菜（菠菜、花椰菜、奇異果、綠茶）',水:'黑色食物（黑芝麻、海帶、黑豆、藍莓）',火:'紅色食物（紅棗、枸杞、番茄、櫻桃）',土:'黃色食物（南瓜、玉米、地瓜、薑）'};
    const WH={金:'深呼吸練習、戶外健走、保濕護膚、少吃辛辣',木:'伸展瑜珈、11點前睡、少生氣、護眼（少看手機）',水:'泡腳暖身、11點前入睡、多喝溫水、少吃冰',火:'午間小憩15分鐘、少喝咖啡、靜心冥想、少熬夜',土:'三餐定時定量、少冰少油膩、飯後散步、細嚼慢嚥'};
    const ep=bazi.ep||{};
    const epArr=Object.entries(ep).sort((a,b)=>a[1]-b[1]);
    const wk=epArr[0]?epArr[0][0]:'土';
    const bp=WO[wk]||'';
    const th=bazi.tiaohou;
    const thHint=th?(th.reason.includes('水多')?'體質偏濕寒，容易疲勞、嗜睡、四肢沉重、濕氣重':th.reason.includes('火旺')?'體質偏燥熱，容易上火、失眠、口乾、心煩':th.reason.includes('寒')?'體質偏寒，容易手腳冰冷、免疫力低、怕冷':th.reason.includes('金重')?'體質偏緊繃，容易肩頸僵硬、呼吸不暢、壓力大':'需留意調候相關臟腑'):'';

    if(isYN){
      if(/手術|開刀/.test(q)){
        if(good) answer='<strong>手術運勢偏好。</strong> 卦象和運勢支持順利恢復。選擇好醫生、遵照醫囑，手術前後好好休養。';
        else answer='<strong>如果醫生說要開就開，不要拖。</strong> 雖然運勢不算最佳，但健康不能等運勢。手術後多休養、飲食清淡、少操心。';
      }else if(/懷孕|生育|生小孩|備孕/.test(q)){
        if(good) answer='<strong>生育運勢不差。</strong> 放鬆心情，壓力反而是最大的阻礙。調理好身體、規律作息，順其自然。';
        else answer='<strong>身體先調養好。</strong> 運勢顯示目前身體能量不足，建議先把體質養好。少熬夜、均衡飲食、適度運動。準備好了，寶寶自然會來。';
      }else if(/好|康復|好轉|恢復/.test(q)){
        if(good) answer='<strong>會好轉的。</strong> 運勢支持身體恢復。配合治療、好好休息、注意飲食，身體會慢慢好起來。';
        else answer='<strong>需要一些時間。</strong> 恢復過程可能比你預期的慢一點，不要急。持續調理、保持好心情，身體有自癒能力。';
      }else if(/減肥|瘦|胖|體重|身材|減重/.test(q)){
        if(good) answer='<strong>減重運勢不錯。</strong> 現在開始執行計畫身體配合度比較高。不要極端節食，靠運動加飲食調整才能持久。';
        else answer='<strong>減重會比較辛苦。</strong> 體質代謝偏慢不要期待快速見效。慢慢來反而穩，每週減0.5公斤就很好了。';
      }else if(/憂鬱|焦慮|恐慌|心理|情緒低落|低潮/.test(q)){
        answer='<strong>心理健康跟身體健康一樣重要。</strong> 你願意關注這個問題本身就是好的開始。建議找專業心理諮商師聊聊。';
        detail='你的五行'+wk+'行偏弱，情緒容易受影響。日常可以透過運動和規律作息來調節。';
      }else if(/過敏|蕁麻疹|濕疹|氣喘|鼻炎/.test(q)){
        answer='<strong>過敏跟你的體質有關。</strong> 你的五行'+wk+'行偏弱容易在'+bp+'方面出問題。建議從飲食和生活環境調整減少過敏原接觸。';
      }else if(/慢性病|長期吃藥|控制病情|副作用/.test(q)){
        if(good) answer='<strong>病情控制方向正確。</strong> 運勢支持身體恢復配合醫囑持續治療會穩定改善。不要自己停藥或換藥。';
        else answer='<strong>要更注意控制。</strong> 運勢偏弱時抵抗力也會下降。按時吃藥定期回診不能鬆懈。';
            }else if(/戒菸|戒酒|戒|上癮|成癮|依賴/.test(q)){
        if(good) answer='<strong>現在戒的成功率比較高。</strong> 運勢支持你做出改變。找到替代的紓壓方式是關鍵。不要一個人硬撐，找人陪你一起。';
        else answer='<strong>會比較辛苦但不是做不到。</strong> 運勢低的時候意志力也比較弱。建議尋求專業協助，不丟臉的。一步一步來，偶爾失敗也沒關係。';
      }else if(/家人.*健康|爸.*身體|媽.*身體|父母.*健康|長輩.*身體|幫.*問/.test(q)){
        answer='<strong>你很有孝心。</strong> 從命理角度來看，';
        if(good) answer+='家人健康運勢穩定。提醒他們定期健檢，飲食注意均衡就好。多陪伴本身就是最好的良藥。';
        else answer+='家人健康方面要多留意。建議安排一次全面健檢，有問題早發現早治療。你的關心和陪伴對他們很重要。';
      }else if(/要不要.*看醫|該不該.*檢查|要不要.*健檢|需不需要.*看|要不要去醫院|該不該去/.test(q)){
        answer='<strong>去。</strong> 會問這個問題代表你心裡已經不安了。身體的事寧可多檢查一次也不要拖。早發現早治療，花一個下午換心安絕對值得。';
      }else if(/養生|調理|進補|補身/.test(q)){
        answer='<strong>從你的命盤看養生方向：</strong> 你的五行'+wk+'行最弱對應'+bp+'。飲食多吃'+WF[wk]+'。日常保養：'+WH[wk]+'。';
      
      }else{
        if(good) answer='<strong>健康狀況整體還行。</strong> 注意日常保養就好，特別是'+bp+'方面。';
        else answer='<strong>健康要多留心。</strong> 特別注意'+bp+'。建議定期健檢，有不舒服別拖。';
      }
      detail=wk+'行最弱（'+ep[wk]+'%），是你最需要注意的部位：'+bp+'。'+(thHint?' 此外，'+thHint+'。':'');
      tip='飲食多吃'+WF[favEl]+'。 '+WH[favEl]+'。 ⚠ 命理僅供養生參考，身體不適請就醫。';
    }else if(isWhen){
      if(good) answer='<strong>目前身體能量還行。</strong> '+dyInfo+'但別因為運勢好就熬夜亂吃。';
      else answer='<strong>這段期間要特別注意健康。</strong> '+dyInfo+(yearInfo||'運勢低谷期身體也容易出問題，定期健檢。');
      tip=WH[favEl]+'。有利時期也不要放縱。';
    }else if(isHow){
      // 壓力/紓壓/調適 特殊回答
      if(/壓力|紓壓|紓解|調適|放鬆|減壓|焦慮.*怎|情緒.*怎|心情.*怎/.test(q)){
        answer='<strong>從命盤看你的壓力來源與紓解方向：</strong>';
        detail='';
        if(el==='木'||el==='火') detail+='你的日主屬'+el+'行，天生情緒起伏大、容易急躁。壓力大時最有效的紓解是「動」——跑步、打球、爬山，讓身體的能量釋放出來。';
        else if(el==='金'||el==='水') detail+='你的日主屬'+el+'行，壓力容易往內壓，外表看不出來但身體會反應。最適合你的紓壓方式是「靜」——泡澡、聽音樂、冥想、瑜珈。';
        else detail+='你的日主屬土行，壓力來自想太多、擔心太多。最適合你的紓壓方式是「說出來」——找朋友聊聊、寫日記、散步時整理思緒。';
        detail+=' 你的五行'+wk+'行最弱（'+ep[wk]+'%），壓力大時最先出問題的是'+bp+'，要特別留意。';
        if(thHint) detail+=' 體質方面，'+thHint+'，壓力會加重這個傾向。';
        detail+=' 喜用'+fav.join('、')+'行來調節——穿'+FC[favEl]+'色、往'+FD[favEl]+'方向走動、多接觸大自然，都能幫助能量回穩。';
        if(strong) detail+=' 你是身強命格，壓力反而是動力，但要學會適時「放手」，不是所有事都要扛。';
        else detail+=' 你是身弱命格，要避免同時扛太多事，學會「拒絕」是最重要的紓壓技能。';
      }else{
        answer='<strong>你的養生重點：</strong>';
        detail='🍎 飲食：多吃'+WF[favEl]+'。少吃'+(favEl==='火'?'冰冷生食':'油炸辛辣')+' 。';
        detail+=' 🛌 作息：'+WH[favEl];
        detail+=' 🏃 運動：'+(el==='木'||el==='火'?'適合動態運動（跑步、打球、有氧舞蹈）。':'適合靜態運動（瑜珈、太極、游泳、散步）。');
        detail+=' ⚡ 重點保養：'+bp+'（'+wk+'行最弱）。';
        if(thHint) detail+=' 體質特徵：'+thHint+'，要特別對應調理。';
      }
      tip='⚠ 以上為命理養生建議，身體不適請就醫。';
    }else if(isWhy){
      if(/累|疲|沒精神|嗜睡/.test(q)){
        answer='<strong>從命盤看，你的'+wk+'行偏弱。</strong> ';
        if(th&&th.reason.includes('水多')) answer+='命盤「水多木漂」，就像花泡在冰水裡，當然沒精神。你需要的是「暖」和「乾」，少吹冷氣、少喝冰水、多曬太陽。';
        else if(wk==='火') answer+='火行弱代表心臟能量和血液循環偏弱，容易覺得累。多吃紅色食物、曬太陽、午間小憩可以改善。';
        else if(wk==='土') answer+='土行弱代表脾胃消化不好，營養吸收不了當然沒精神。三餐定時、少吃冰、飯後散步是關鍵。';
        else answer+=wk+'行弱容易影響'+bp+'，導致整體能量不足。針對性調理會改善。';
      }else if(/失眠|睡不好|睡眠/.test(q)){
        answer='<strong>失眠跟你的命盤有關。</strong> ';
        if(th&&th.reason.includes('火旺')) answer+='命盤火氣太旺，心神不寧當然睡不好。少喝咖啡、睡前泡腳、臥室用藍色系床品。';
        else answer+=wk+'行偏弱，對應'+bp+'，影響到睡眠品質。晚上11點前上床、少看手機、臥室保持暗和涼。';
      }else if(/生病|不舒服/.test(q)){
        answer='<strong>你的'+wk+'行最弱（'+ep[wk]+'%），對應'+bp+'。</strong> 這是你天生比較容易出問題的地方。'+(thHint?'加上'+thHint+'，身體確實容易不適。':'')+'不過體質是可以後天調理的。';
      }else{
        answer='<strong>從命盤看你的體質弱點：</strong> '+wk+'行最弱，對應'+bp+'。'+(thHint?'體質特徵：'+thHint+'。':'')+'日常保養可以明顯改善。';
      }
      tip='飲食：'+WF[favEl]+'。 '+WH[favEl]+'。 ⚠ 身體不適請就醫。';
    }else{
      if(good) answer='<strong>今年健康運不錯。</strong> 注意日常保養即可。特別留意'+bp+'的保養。';
      else answer='<strong>今年健康要多注意。</strong> 尤其是'+bp+'方面。建議定期健檢，'+(thHint?thHint+'，':'')+'不要忽視身體的小訊號。';
      tip='飲食：'+WF[favEl]+'。 '+WH[favEl]+'。 ⚠ 身體不適請就醫。';
    }
  }

  // ================== 🤝 人際 ==================
  else if(type==='relationship'){
    const gr=bazi.shensha&&bazi.shensha.includes('天乙貴人');
    const js=bazi.shensha&&bazi.shensha.includes('劫煞');
    if(isYN){
      if(/和好|化解|修復|道歉/.test(q)){
        const passive=intent.isPassive||/他會|她會|對方會|會不會.*和好|會.*原諒/.test(q);
        if(passive){
          // 被動：對方會跟我和好嗎/會原諒我嗎
          if(good) answer='<strong>對方有可能釋懷。</strong> 運勢顯示關係有鬆動的跡象，對方不是完全不想理你。不要急著逼對方表態，給他/她一點時間消化。';
          else answer='<strong>對方目前還沒準備好。</strong> 強行要對方回應反而有反效果。先把你能做的做好，對方看在眼裡，時間到了自然會有轉機。';
        }else{
          if(good) answer='<strong>有和好的可能。</strong> 運勢顯示關係有修復的空間。重點是誰先低頭不重要，重要的是你在意這段關係。先釋出善意，對方會感受到的。';
          else answer='<strong>需要一些時間。</strong> 現在雙方可能都還在氣頭上，強行和解反而會讓事情更糟。給彼此空間冷靜，等情緒過了再談。';
        }
      }else if(/貴人|信任|可靠|真心/.test(q)){
        if(good) answer='<strong>你的貴人運還不錯。</strong> '+(gr?'命帶天乙貴人，你天生容易遇到幫助你的人。保持真誠和感恩，貴人會持續出現。':'運勢支持有人相助，但要自己主動經營關係。別等人家來幫你，先去幫別人。');
        else answer='<strong>近期貴人運偏弱。</strong> 凡事多靠自己比較穩。不是說沒有好人，而是這段期間容易看錯人。重要決定先自己判斷，別完全聽別人的。';
      }else if(/小人|背叛|陷害|被害|整/.test(q)){
        if(bad) answer='<strong>確實要提防。</strong> 運勢顯示人際方面有暗箭，說話小心、少管閒事、重要事情留證據。不要輕易把底牌亮給同事看。';
        else if(!good) answer='<strong>風險不高但也不能大意。</strong> 職場上永遠要有防人之心。做好自己的事，少參與八卦，不得罪人就不會被針對。';
        else answer='<strong>目前看起來還好。</strong> 運勢穩定，身邊沒有明顯的小人跡象。但防人之心不可無，重要的事情還是要留底。';
      }else if(/合作|合夥|一起做/.test(q)){
        const passive=intent.isPassive||/他會|她會|對方會|會答應|會同意|願意/.test(q);
        if(passive){
          // 被動：對方會答應合作嗎
          if(great) answer='<strong>對方答應的機會很大。</strong> 運勢顯示合作條件成熟，對方也在尋找合作夥伴。拿出具體方案去談，比空口白話有說服力。';
          else if(good) answer='<strong>有機會，但對方可能要考慮。</strong> 不會馬上答應，需要你展現合作的價值和誠意。準備好數據和計畫再提。';
          else answer='<strong>對方目前可能不太願意。</strong> 不是你不好，可能是時機或條件還不到位。先建立更深的信任，讓對方看到你的能力再談。';
        }else{
          if(great) answer='<strong>合作運勢很好。</strong> 如果找到對的人，現在是一起衝的好時機。但再好的朋友也要把合約寫清楚，醜話說在前面。';
          else if(good) answer='<strong>可以合作，但要有規則。</strong> 運勢偏好，但別因為信任就什麼都用口頭說。權責分明、帳目透明、退出機制先談好。';
          else answer='<strong>合作要非常謹慎。</strong> 目前運勢不太適合深度綁定，如果要合作，先從小規模試起，彼此磨合了再加大。不要一開始就投入太多。';
        }
      }else if(/社恐|社交恐懼|內向|不善交際|害羞/.test(q)){
        if(good) answer='<strong>運勢其實很支持你社交。</strong> 你不是不會交朋友只是需要合適的環境。從兩三個人的小聚會開始。';
        else answer='<strong>不用勉強自己。</strong> 內向不是缺點。一對一的深度交流比一群人的熱鬧更適合你。有幾個真心朋友就夠了。';
            }else if(/霸凌|被欺負|被排擠|被孤立|被針對|被笑/.test(q)){
        answer='<strong>這不是你的錯。</strong> 被霸凌的人從來不需要為別人的惡意負責。';
        if(good) answer+='運勢顯示情況會改善。勇敢跟信任的人求助，不要一個人承受。';
        else answer+='目前的處境確實很難受。如果環境無法改變，離開不是逃避而是保護自己。一定要跟信任的人說。';
      }else if(/要不要繼續|斷捨離|要不要.*來往|值不值得.*交|遠離|有毒/.test(q)){
        if(good) answer='<strong>這段關係還有維持的價值。</strong> 但可以調整距離和相處模式。不是所有關係都要親密，保持舒服的距離就好。';
        else answer='<strong>你的直覺可能是對的。</strong> 如果一段關係讓你一直消耗能量卻得不到回饋，適時遠離是對自己的保護。你不欠任何人。';
      }else if(/友情|絕交|友誼|好朋友/.test(q)){
        if(good) answer='<strong>友誼有修復空間。</strong> 真正的朋友不會因為一次衝突就斷了。先冷靜幾天然後主動釋出善意。';
        else answer='<strong>有些友情確實走到了盡頭。</strong> 不是所有關係都要強行維持。放手不代表不珍惜只是接受人生的自然變化。';
      }else if(/鄰居|噪音|糾紛|官司|被告/.test(q)){
        if(good) answer='<strong>事情會順利解決。</strong> 運勢支持和平處理能協調就協調。非得走法律程序今年的運勢對你有利。';
        else answer='<strong>盡量避免對簿公堂。</strong> 運勢偏弱時打官司特別消耗。能和解就和解退一步海闊天空。';
      }else if(/人緣|人際|提升|改善/.test(q)){
        if(good) answer='<strong>人際方面有正面發展空間。</strong> '+(gr?'你命帶貴人星，人緣天生不差。':'')+'多出席社交場合、主動打招呼、記住別人的名字和喜好。人際就是這些小事。';
        else answer='<strong>人際需要一些時間經營。</strong> 目前運勢對社交不算特別有利，但不代表不能改善。從身邊最親近的人開始，一個一個經營好。';
      }else{
        if(good) answer='<strong>可以。</strong> 人際方面運勢偏好，適合拓展社交。';
        else answer='<strong>需要觀察。</strong> 人際上有些不確定因素，謹慎為上。';
      }
      tip='穿'+FC[favEl]+'色參加社交場合。往'+FD[favEl]+'方向的人是你的貴人方位。';
    }else if(isWhen){
      if(good) answer='<strong>人際正在好轉。</strong> '+dyInfo+(yearInfo||'現在多社交，種下的種子會在好年份開花。');
      else answer='<strong>人際需要時間經營。</strong> '+dyInfo+'不急，先把身邊的關係維繫好。';
      tip='有利時期多參加聚會，不利時期少管閒事。';
    }else if(isHow){
      answer='<strong>給你三個人際建議：</strong>';
      detail='1️⃣ '+(strong?'你太有主見，人際關係裡要練「聽」。聽完再說，先認同再給建議。沒人喜歡一開口就被否定。':'你太好說話，人際關係裡要練「拒絕」。不是所有請求都要答應，設立界線反而會被尊重。');
      detail+=' 2️⃣ 記住三個字：「不八卦」。職場上、朋友圈裡，管好嘴巴就能避開80%的人際問題。';
      detail+=' 3️⃣ '+(gr?'你有貴人運，主動維繫重要關係。每個月約一個重要的人吃飯，持續投資人脈。':'找到你的貴人方位（'+FD[favEl]+'方向），那個方向來的朋友/客戶/同事對你特別有利。');
      tip='穿'+FC[favEl]+'色見重要的人。';
    }else if(isWhy){
      if(/小人|被整/.test(q)) answer='<strong>'+(js?'你命帶劫煞，確實容易遇到損友或被人利用。':'不一定是命的問題。')+'</strong> 反思一下是不是在不對的場合說了不該說的話，或者太輕易相信不該相信的人。職場上保持適度距離是保護自己最好的方式。';
      else if(/不順|吵|衝突/.test(q)) answer=(strong?'<strong>你太直了。</strong> 有話直說是優點，但在人際上有時候太直就是得罪人。學會「換個方式說」，內容不變但語氣和順序改一下。':'<strong>你太忍了。</strong> 一直忍讓不但不會讓關係變好，反而讓人覺得你好欺負。有些委屈要說出來，合理的不爽不丟人。');
      else answer=(strong?'<strong>你個性強，容易跟人硬碰硬。</strong> 人際不是比誰對誰錯，而是比誰讓對方舒服。':'<strong>你太在意別人的看法了。</strong> 活成別人喜歡的樣子很累，而且永遠做不到。先讓自己舒服，再考慮別人。');
      tip='穿'+FC[favEl]+'色增強人際能量。';
    }else{
      if(good) answer='<strong>人際運不錯。</strong> '+(gr?'命帶天乙貴人，有貴人相助。':'')+'適合拓展社交圈、認識新朋友。';
      else answer='<strong>人際運偏弱。</strong> 少管閒事、少八卦、保持低調。這段時間獨處反而比社交更養你。';
      tip='穿'+FC[favEl]+'色。往'+FD[favEl]+'方向的人對你有利。';
    }
  }

  // ================== 🏠 家庭 ==================
  else if(type==='family'){
    if(isYN){
      if(/連絡|聯繫|聯絡|回來|見面|相認/.test(q)){
        const passive=intent.isPassive||/他會|她會|會連絡|會來|會回來|會找我|聯繫我|連絡我/.test(q);
        if(passive){
          // 被動：對方會主動連絡我嗎
          if(good) answer='<strong>有機會的。</strong> 對方心裡還有這份牽掛，只是可能不知道怎麼開口。你不用刻意做什麼，保持開放的態度，消息可能會在你意想不到的時候出現。';
          else answer='<strong>可能需要再等一等。</strong> 對方目前還沒準備好主動聯繫。不要因此難過——有些人需要更長的時間。你可以先發一個不需要回覆的簡單訊息，讓對方知道門一直開著。';
        }else{
          if(good) answer='<strong>有機會重新連繫。</strong> 血緣是最深的牽繫，就算疏遠了也不會斷。現在主動聯繫，對方接受的可能性比你想的高。一通電話、一則訊息，不需要長篇大論，「我想你了」就夠了。';
          else answer='<strong>緣分還在，只是時機要等。</strong> 現在對方可能還沒準備好，強求反而有反效果。你可以先寫一封不需要回覆的信或訊息，讓對方知道你的心意，然後給他/她時間。';
        }
      }else if(/支持|同意|接受|答應/.test(q)){
        const passive=intent.isPassive||/家人會|父母會|爸媽會|會支持|會同意|會接受|會答應/.test(q);
        if(passive){
          // 被動：家人會支持嗎/父母會同意嗎
          if(good) answer='<strong>家人最終會理解的。</strong> 現在可能還在觀望或擔心，但他們的反對不是不愛你。給他們一點時間消化，同時用行動證明你的決定是對的。';
          else answer='<strong>短期內家人可能不會鬆口。</strong> 他們的擔心有他們的道理。不要急著要答案，先做好準備工作，等你有了具體成果或計畫，再拿去跟家人談會更有說服力。';
        }else{
          if(good) answer='<strong>家人最終會支持你的。</strong> 但溝通方式很重要——不要用爭吵的方式，用「讓他們看到結果」的方式。先做出一點成績，家人自然會從反對變成支持。';
          else answer='<strong>短期可能不太容易。</strong> 家人的反對往往出於擔心而不是不愛你。耐心溝通，聽聽他們擔心什麼，一一回應，比直接衝撞有效。';
        }
      }else if(/搬家|買房|置產|裝潢/.test(q)){
        if(good) answer='<strong>運勢支持居家變動。</strong> 搬家或裝潢的話今年是好時機。建議往'+FD[favEl]+'方向找房子或安排主臥。';
        else answer='<strong>建議緩一緩。</strong> 居家大事不急著做決定，尤其是大額支出要量力而為。再等等，會有更好的機會。';
      }else if(/離婚|分居/.test(q)){
        if(good) answer='<strong>婚姻還有轉圜的餘地。</strong> 離婚是大事不要在情緒激動時做決定。先冷靜一個月再看。';
        else answer='<strong>如果真的走不下去了。</strong> 離婚前要做好準備——經濟獨立、小孩安排、法律諮詢都想清楚。';
      }else if(/生小孩|生孩子|生幾個|要不要生|生育/.test(q)){
        if(good) answer='<strong>生育運勢不錯。</strong> 目前是可以考慮的時機。雙方都準備好了再說。經濟基礎和心理準備同樣重要。';
        else answer='<strong>可以再準備一下。</strong> 目前條件還不太成熟。先把身體調養好經濟穩定下來時機到了自然水到渠成。';
      }else if(/遺產|繼承|分家產|財產分配/.test(q)){
        if(good) answer='<strong>處理遺產的運勢不錯。</strong> 趁運勢好把事情講清楚。最好有白紙黑字法律文件比口頭承諾有保障。';
        else answer='<strong>這種事容易傷感情。</strong> 運勢偏弱時處理財產分配容易有糾紛。建議找律師或公正的長輩協調。';
            }else if(/叛逆|不聽話|管不動|頂嘴|教養|教育方式|管教/.test(q)){
        if(good) answer='<strong>親子關係會改善。</strong> 叛逆期是成長的一部分。多聽少說，試著理解他們的世界。你越放鬆他們反而越願意靠近你。';
        else answer='<strong>確實是辛苦的階段。</strong> 但硬碰硬只會讓關係更糟。找一個他們信任的第三方（老師、親戚）幫忙溝通。耐心是唯一的路。';
      }else if(/同住|搬出去|跟父母住|跟公婆住|要不要.*一起住/.test(q)){
        if(good) answer='<strong>同住的運勢還行。</strong> 但一定要先談好生活規則和各自的空間。有衝突很正常，關鍵是有沒有溝通管道。';
        else answer='<strong>建議保持一點距離。</strong> 目前的磁場不太適合太密切的相處。如果可以住附近但不同一屋簷下，是最好的平衡。';
      }else if(/搬出去|獨立|離開家|自己住|想搬|出去住/.test(q)){
        if(good) answer='<strong>時機不錯，可以考慮。</strong> 獨立生活會讓你成長很多。先確保經濟能撐住——房租不超過收入三分之一是基本原則。';
        else answer='<strong>再準備一下比較穩。</strong> 經濟基礎還不夠穩固就搬出去壓力會很大。先存好至少三個月的緊急預備金再行動。';
      }else if(/寵物|毛小孩|貓|狗|養.*寵物|寵物.*健康/.test(q)){
        if(good) answer='<strong>適合養寵物。</strong> 你目前的生活狀態和能量場適合有毛小孩陪伴。寵物能幫你穩定情緒增加正能量。記得定期帶去健檢。';
        else answer='<strong>先評估自己的狀態。</strong> 養寵物是長期承諾，要確保你有足夠的時間、空間和經濟能力。如果生活還不穩定，等穩定了再養也不遲。';
      }else if(/再婚|二婚|重組家庭/.test(q)){
        if(good) answer='<strong>可以勇敢追求幸福。</strong> 運勢支持開展新關係。過去的經驗不是包袱而是讓你更知道自己要什麼。';
        else answer='<strong>再等等讓自己準備好。</strong> 目前還在療傷期。先把自己和孩子的生活穩定下來感情的事順其自然就好。';
      }else if(/改善|和好|緩和|修復/.test(q)){
        if(good) answer='<strong>關係會改善的。</strong> 運勢顯示家庭的僵局正在鬆動。不需要做什麼大事，從每天多說一句關心的話、多幫忙做一件家事開始。小事累積比大動作有效。';
        else answer='<strong>需要耐心。</strong> 家庭關係不是一天壞掉的，也不會一天修好。先從「不吵」做起，不反駁、不翻舊帳，讓家裡的氣氛慢慢緩和。';
      }else if(/婆媳|公婆|妯娌/.test(q)){
        if(good) answer='<strong>關係有改善空間。</strong> 婆媳問題的核心往往不是你和婆婆，而是你老公/老婆的態度。拉另一半站在你這邊，問題就解決一半了。';
        else answer='<strong>這個問題需要時間。</strong> 不要期待婆媳變閨密，能做到相安無事就是最好的結果。保持禮貌距離、不計較小事、有問題讓另一半出面。';
      }else if(/孩子|小孩|兒子|女兒|親子/.test(q)){
        if(good) answer='<strong>親子關係會好轉。</strong> 孩子需要的不是你的管教而是你的理解。試著少說教、多傾聽。問「你覺得呢」比說「你應該」有效一百倍。';
        else answer='<strong>親子溝通需要調整方式。</strong> 你越管，孩子越反抗。試著放手讓他們做決定，在旁邊當顧問而不是指揮官。';
      }else if(/健康|身體|生病|開刀|住院|檢查|看醫|看病|長輩.*注意|爸媽.*注意|父母.*注意/.test(q)){
        // 家庭type下問健康問題（通常是問家人的健康）
        const elderWord=(/爺|奶|外公|外婆|阿公|阿嬤|長輩|爸|媽|父|母|公婆/.test(q))?'長輩':'家人';
        if(good) answer=`<strong>${elderWord}健康整體還好。</strong> 但年紀大了本來就要多注意。建議定期健康檢查，尤其是心血管和骨質方面。平時多關心${elderWord}的飲食作息，有異狀不要拖。`;
        else answer=`<strong>要特別留意${elderWord}健康。</strong> 運勢顯示這段時間家人健康方面有些隱憂，特別注意慢性病控制和意外預防。建議安排一次全面健檢，早發現早處理。平時多打電話關心，有不舒服就陪去看醫生。`;
        tip=`多關心${elderWord}飲食起居。家中`+FD[favEl]+`方位擺放綠植有助健康氣場。`;
      }else if(/問題.*解決|解決.*問題|狀況.*改善|改善.*狀況|會.*好轉|好轉.*嗎|家.*會好|會.*順利|順利.*嗎/.test(q)){
        // 「家裡的問題會解決嗎？」通用家庭問題
        if(great) answer='<strong>會的，而且比你想的快。</strong> 家庭能量正在好轉，目前的問題已經接近轉折點了。你不需要做什麼特別的事——保持穩定的態度、不激化衝突，事情自然會慢慢解開。';
        else if(good) answer='<strong>會解決的，但需要一點時間。</strong> 家庭運勢偏好，現在的問題不是死結，是可以被打開的。關鍵在於誰先放下身段——通常先開口的那個人，反而贏了。';
        else if(!bad) answer='<strong>可以解決，但不會是一夕之間。</strong> 家庭問題往往積累很久，解決也需要時間。不要期望一次對話就全部搞定。從最小的改變開始——比如今天回家時多說一句「辛苦了」。';
        else answer='<strong>需要多一點耐心。</strong> 目前家庭磁場確實比較緊繃，問題短期內不容易完全解決。但「不惡化」就是進步。先做到不吵、不翻舊帳、不冷戰，等氣氛緩和了再慢慢談。';
      }else{
        if(good) answer='<strong>可以。</strong> 家庭運勢偏好，適合處理家庭大事。';
        else answer='<strong>需要更多耐心。</strong> 家庭方面有些阻力，多溝通少爭執。';
      }
      tip='家中'+FD[favEl]+'方位擺放綠植或水晶增強和諧。穿'+FC[favEl]+'色回家。';
    }else if(isWhen){
      if(good) answer='<strong>家庭關係正在好轉。</strong> '+dyInfo+(yearInfo||'現在是修復關係的好時機，主動一點。');
      else answer='<strong>需要給彼此時間。</strong> '+dyInfo+'家庭的事急不來，慢慢經營。';
      tip='有利時期多回家陪伴、多溝通。';
    }else if(isHow){
      if(/健康|身體|生病|開刀|住院|檢查|看醫|看病|注意什麼|要注意/.test(q)&&/長輩|爸|媽|父|母|爺|奶|外公|外婆|阿公|阿嬤|公婆|家人|親人/.test(q)){
        const elderWord=(/爺|奶|外公|外婆|阿公|阿嬤|長輩/.test(q))?'長輩':(/爸|父/.test(q))?'父親':(/媽|母/.test(q))?'母親':'家人';
        const healthEl=bazi.fav[0]||'木';
        const weakOrgan={金:'肺部、呼吸道、皮膚',木:'肝膽、筋骨、眼睛',水:'腎臟、泌尿、耳朵',火:'心臟、血壓、小腸',土:'脾胃、消化系統、肌肉'}[healthEl]||'脾胃';
        answer=`<strong>${elderWord}健康需要留意這幾點：</strong>`;
        detail=`1️⃣ 從你的命盤來看，疾厄宮氣場偏${bad?'弱':'中性'}，${elderWord}健康方面${bad?'確實有隱憂，需要特別留意':'需要日常保養，防患未然'}。`;
        detail+=` 2️⃣ 依五行喜忌，建議特別注意${weakOrgan}方面。定期安排健康檢查，有慢性病要穩定控制。`;
        detail+=` 3️⃣ ${elderWord}的生活環境也要注意——居家防滑、充足照明、適量運動。心理健康也很重要，多陪伴聊天比什麼補品都有效。`;
        tip=`家中`+FD[favEl]+`方位擺放綠植有助健康氣場。多帶${elderWord}到戶外走走。`;
      }else{
      answer='<strong>給你三個家庭建議：</strong>';
      detail='1️⃣ '+(strong?'你想掌控一切，但家人不是員工。練習「放手」，讓家人自己做決定，就算做錯了也是他們的學習。':'你總是把委屈往肚裡吞，但累積的不滿遲早會爆。練習「說出來」，合理的不爽不丟人。');
      if(/婆媳|公婆/.test(q)) detail+=' 2️⃣ 婆媳關係的關鍵人是你的另一半。拉他/她進來一起面對，不要自己硬扛。 3️⃣ 保持禮貌距離比假裝親密好。每週固定時間探望，其他時間各過各的。';
      else if(/親子|小孩|孩子/.test(q)) detail+=' 2️⃣ 每天花15分鐘純粹聊天（不是問功課），讓孩子感受到你關心他這個人，不只關心他的成績。 3️⃣ 在家裡建立「可以犯錯」的安全感，孩子才會跟你說真話。';
      else detail+=' 2️⃣ 家庭關係修復靠「行動」不是「說教」。與其說一百句「我都是為你好」，不如做一頓飯、接一次車。 3️⃣ 定期的家庭活動（一起吃飯、出遊）比什麼都有效。';
      tip='家中'+FD[favEl]+'方位是和諧能量位，適合放全家福或綠植。';
      }
    }else if(isWhy){
      if(/不和|吵|鬧/.test(q)) answer=(strong?'<strong>你在家裡可能太強勢了。</strong> 你覺得是為家人好，但他們感受到的是控制和壓力。家不是講道理的地方，是講感情的地方。':'<strong>你在家裡壓抑太久了。</strong> 一直忍讓不代表和諧，只是把問題藏起來。找個適合的時機好好談一次，把心裡的話說清楚。')+(bad?' 加上運勢偏弱，家庭摩擦確實比平時多。但這是階段性的。':'');
      else if(/疏遠|不連絡|斷/.test(q)) answer='<strong>家人之間的疏遠通常不是因為不愛，而是不知道怎麼表達。</strong> 每個人都在等對方先開口，結果誰都不開口。你先踏出第一步，哪怕只是一條簡單的訊息。'+(bad?' 運勢顯示目前不是最佳時機，但不代表不能做。心到了，時機自然會對。':'');
      else answer=(strong?'<strong>你可能把太多精力放在外面了。</strong> 事業再忙，家人也需要你的時間和注意力。':'<strong>你可能太操心家裡的事了。</strong> 過度的關心有時候是一種壓力。適度放手，讓家人自己成長。');
      tip='穿'+FC[favEl]+'色回家。家中'+FD[favEl]+'方位放水晶增強和諧。';
    }else if(isChoice){
      answer=good?'<strong>選對家庭影響最小的。</strong> 運勢好的時候做改變，家人接受度比較高。':'<strong>先不做大決定。</strong> 現在不是處理家庭大事的最佳時機，維持現狀比改變更安全。';
      tip='重大家庭決定在'+FD[favEl]+'方位的房間討論。';
    }else{
      if(good) answer='<strong>家庭運不錯。</strong> 家人關係有改善或深化的空間，適合處理家庭大事（搬家、裝修、重要溝通）。';
      else answer='<strong>家庭運偏弱。</strong> 可能有些摩擦或溝通問題，多一點耐心、少一點指責。這段時間以「不吵」為目標就好。';
      tip='穿'+FC[favEl]+'色回家。家中'+FD[favEl]+'方位擺放綠植。';
    }
  }

  // ================== fallback ==================
  else{
    if(good) answer='<strong>偏向正面。</strong> 運勢支持所問之事。';
    else if(!bad) answer='<strong>有機會但需努力。</strong> 條件尚可，要主動推進。';
    else answer='<strong>目前較為困難。</strong> 建議先調整狀態再行動。';
    tip='穿'+FC[favEl]+'色增強運勢。';
  }

  /* ═══ 回答增強器：確保先正面回應，再補充深度 ═══ */
  (function enrichResponse(){
    // ---------- A) 正面回應前置：偵測是否有答非所問 ----------
    // 如果 answer 裡沒有直接回應使用者的核心關鍵詞，加入直接回應
    var qLower = q || '';
    var needDirectAnswer = false;
    var directPrefix = '';

    // 判斷概率等級的中文描述
    var probWord = prob >= 78 ? '很好' : prob >= 65 ? '不錯' : prob >= 52 ? '尚可' : prob >= 40 ? '偏弱' : prob >= 25 ? '不太好' : '很差';
    var probYN = prob >= 65 ? '可以' : prob >= 52 ? '可以試試，但要謹慎' : prob >= 40 ? '目前不太建議' : '不建議';
    var probFeel = prob >= 65 ? '偏正面' : prob >= 52 ? '中性偏保守' : '偏負面';

    // 偵測使用者的核心問題
    // ★ 健康類「會好嗎」特殊處理：不要回「不建議」這種答非所問
    var _isHealthRecoveryQ = type==='health' && /會好嗎|會不會好|能治好|治得好|會康復|能康復|會痊癒|能痊癒|會改善|能改善/.test(qLower);
    if(_isHealthRecoveryQ){
      needDirectAnswer = true;
      if(prob >= 65) directPrefix = '<strong>恢復的條件不錯。</strong> 身體有自癒能力，配合調理會逐步改善。';
      else if(prob >= 52) directPrefix = '<strong>會好轉，但需要時間和耐心。</strong> 恢復過程可能比你預期的慢一點，不要急。持續調理、保持好心情。';
      else if(prob >= 40) directPrefix = '<strong>需要多一點耐心。</strong> 恢復過程需要時間，持續調理、保持好心情，身體有自癒能力。';
      else directPrefix = '<strong>恢復需要比較長的時間。</strong> 目前阻力較大，務必配合專業醫療，不要只靠自己扛。';
    }
    else if(/你覺得|你[看認]為|如何[？?]$|怎樣[？?]$|怎麼樣[？?]$|好不好|好嗎[？?]?$|可以嗎|行嗎|適合嗎/.test(qLower)){
      // 使用者在問意見/可行性
      needDirectAnswer = true;
      if(prob >= 65) directPrefix = '<strong>整體來看是可以的。</strong> 各方面指標偏正面，運勢支持你的方向。';
      else if(prob >= 52) directPrefix = '<strong>可以，但建議謹慎評估。</strong> 不是不行，但需要做好準備再行動。';
      else if(prob >= 40) directPrefix = '<strong>目前時機不算理想。</strong> 建議先觀望或做好充足準備，不要衝動行事。';
      else directPrefix = '<strong>目前不太建議。</strong> 阻力較多，風險偏高。如果不急，建議等時機好轉再行動。';
    }
    else if(/多少錢|賺多少|中多少|幾元|幾塊/.test(qLower)){
      needDirectAnswer = true;
      if(prob >= 65) directPrefix = '<strong>偏財運'+probWord+'。</strong> 從命理看，你近期有一些偏財的機運。不過命理無法預測具體金額，只能告訴你運勢的方向——小試手氣可以，但不要把它當收入來源。';
      else directPrefix = '<strong>偏財運'+probWord+'。</strong> 命理無法預測具體金額，但從運勢來看，目前不是靠運氣賺錢的好時機。與其花錢試手氣，不如把錢存下來。';
    }
    else if(/會[不]?會|能[不]?能|有沒有|可[不]?可以|是[不]?是/.test(qLower) && !answer.match(/^<strong>[會有能可是]|^<strong>目前|^<strong>短期|^<strong>不太|^<strong>很有|^<strong>有機會|^<strong>沒問題|^<strong>可以|^<strong>不建議|^<strong>建議|^<strong>偏向/)){
      // 是非題但 answer 沒有直接回答
      needDirectAnswer = true;
      if(prob >= 65) directPrefix = '<strong>從命理來看，'+probYN+'。</strong> 各方面指標偏正面。';
      else if(prob >= 52) directPrefix = '<strong>有機會，但不是十拿九穩。</strong> 指標中性，需要自己多努力。';
      else if(prob >= 40) directPrefix = '<strong>目前條件不太充分。</strong> 多數指標偏保守，建議再等等或做更充分的準備。';
      else directPrefix = '<strong>短期內比較困難。</strong> 阻力較多，建議先調整策略。';
    }

    // 如果需要前置回應，但原 answer 已經有實質內容，就把原 answer 當作補充
    if(needDirectAnswer && directPrefix){
      // 檢查原 answer 是不是太短或太空泛
      var origClean = answer.replace(/<[^>]*>/g, '').trim();
      if(origClean.length < 15 || /^(給你|以下|建議|注意|穿|多)/.test(origClean)){
        // 原 answer 太空泛，直接替換
        answer = directPrefix;
      } else {
        // 原 answer 有內容但沒直接回應，加在前面
        answer = directPrefix + ' ' + answer.replace(/^<strong>[^<]*<\/strong>\s*/, '');
      }
    }

    // ---------- B) 確保每個回答都有深度 ----------
    var favData_r={
      '金':{food:'山藥、百合、白蘿蔔',drink:'杏仁茶或梨子汁',sport:'健走或瑜伽',habit:'深呼吸10分鐘，養肺安神',color:'白色/銀色系',subcolor:'米白或香檳金',motherColor:'駝色或卡其色'},
      '木':{food:'花椰菜、菠菜、奇異果',drink:'綠茶或檸檬水',sport:'慢跑或登山',habit:'伸展操15分鐘，疏通肝氣',color:'綠色系',subcolor:'墨綠或橄欖綠',motherColor:'藏青或黛藍'},
      '水':{food:'黑芝麻、海帶、藍莓',drink:'黑豆水或溫開水',sport:'游泳或冥想',habit:'睡前泡腳，11點前入睡',color:'藍色/黑色系',subcolor:'藏青或深灰',motherColor:'米白或淺灰'},
      '火':{food:'紅棗、枸杞、番茄',drink:'紅棗茶或玫瑰花茶',sport:'有氧舞蹈或跑步',habit:'午間小憩15分鐘，養心安神',color:'紅色/紫色系',subcolor:'酒紅或玫瑰粉',motherColor:'墨綠或森林綠'},
      '土':{food:'南瓜、地瓜、玉米',drink:'薑茶或四神湯',sport:'散步或太極',habit:'三餐定時定量，飯後散步20分鐘',color:'黃色/棕色系',subcolor:'駝色或焦糖色',motherColor:'酒紅或珊瑚橘'}
    };
    var fd_r=favData_r[favEl]||favData_r['土'];
    var dirName_r=FD[favEl]||'中央';

    // 如果 detail 為空，自動補充
    if(!detail){
      var parts=[];

      // ═══ 深度解讀（讀取實際命盤數據動態組句） ═══
      var dyText='';
      var _typeWord={'love':'感情桃花','career':'事業發展','wealth':'財運投資','health':'健康身心','relationship':'人際合作','family':'家庭關係'}[type]||'所問之事';

      // ── 大運：讀取實際天干五行 + 與日主生剋 + 領域化 ──
      if(curDy){
        var dyGan=curDy.gz?curDy.gz.charAt(0):'';
        var ganElMap={'甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水'};
        var dyGanEl=ganElMap[dyGan]||'';
        var _keM={'木':'土','土':'水','水':'火','火':'金','金':'木'};
        var _shM={'木':'火','火':'土','土':'金','金':'水','水':'木'};
        var dyRel='';
        if(dyGanEl===el) dyRel='比肩同氣';
        else if(_shM[dyGanEl]===el) dyRel='生助日主';
        else if(_keM[dyGanEl]===el) dyRel='剋制日主';
        else if(_shM[el]===dyGanEl) dyRel='日主洩氣';
        else if(_keM[el]===dyGanEl) dyRel='日主所剋';
        var dyOk=/旺盛|極強|上升/.test(curDy.level);
        var dyBad=/偏弱|低迷|補運/.test(curDy.level);

        dyText='十年大運「'+curDy.gz+'」（'+curDy.level+'），天干'+dyGan+'屬'+dyGanEl+(dyRel?'（'+dyRel+'）':'')+'。';

        // ═══ 真正用 dyRel+dyGanEl 動態組句，不套模板 ═══
        // 生剋關係 × 領域 = 具體影響
        var _elMeaning={'木':'成長擴張','火':'行動衝勁','土':'穩定資源','金':'紀律執行','水':'智慧變通'};
        var _dyMean=_elMeaning[dyGanEl]||'中性';

        if(type==='career'){
          if(dyRel==='生助日主') dyText+=dyGanEl+'行大運生助你的'+el+'行日主，事業上有外在資源主動靠攏，帶來'+_dyMean+'的助力。';
          else if(dyRel==='比肩同氣') dyText+='大運與日主同為'+el+'行，能量加倍但也代表競爭者多，需在同行中突圍。';
          else if(dyRel==='剋制日主') dyText+=dyGanEl+'行大運直接剋制你的'+el+'行日主，事業上面臨外部壓力（客戶/競爭/體制），需以守代攻。';
          else if(dyRel==='日主洩氣') dyText+='你的'+el+'行能量被大運'+dyGanEl+'行洩耗，事業上付出多但短期回報慢，需要耐心等收穫。';
          else if(dyRel==='日主所剋') dyText+='日主'+el+'行剋制大運'+dyGanEl+'行，你有掌控力但推動過程費精力，每一步都是硬打出來的。';
          else dyText+='事業能量中性。';
        } else if(type==='love'){
          if(dyRel==='生助日主') dyText+=dyGanEl+'行生助你的'+el+'行，感情上有人主動對你好、環境製造機會，魅力自然散發。';
          else if(dyRel==='比肩同氣') dyText+='大運同為'+el+'行，感情上容易遇到同質性高的人（像你的人），但也意味著誰也不讓誰。';
          else if(dyRel==='剋制日主') dyText+=dyGanEl+'行剋你的'+el+'行，感情上容易遇到強勢對象或外在阻力（家人反對/距離/工作壓力）。';
          else if(dyRel==='日主洩氣') dyText+='你的能量被洩耗在情感付出上，容易為對方犧牲太多而忽略自己。';
          else if(dyRel==='日主所剋') dyText+='你在感情中掌控欲較強，對方可能感到壓力，需要刻意放鬆給空間。';
          else dyText+='感情能量中性。';
        } else if(type==='wealth'){
          if(dyRel==='生助日主') dyText+=dyGanEl+'行生助你的'+el+'行日主，身旺能扛財，這段期間正偏財都有機會進帳。';
          else if(dyRel==='比肩同氣') dyText+='大運同為'+el+'行，財運上競爭分食的壓力大，容易有「看得到吃不到」的情況。';
          else if(dyRel==='剋制日主') dyText+=dyGanEl+'行剋制你的'+el+'行，外部環境（稅務/詐騙/市場波動）在消耗你的財。守成為上。';
          else if(dyRel==='日主洩氣') dyText+='你的'+el+'行能量被大運洩耗，容易為了賺錢而過度操勞，投資回報率偏低。';
          else if(dyRel==='日主所剋') dyText+='日主剋大運'+dyGanEl+'行=正財格局，靠勞力換取穩定收入，不宜投機。';
          else dyText+='財運能量中性。';
        } else if(type==='health'){
          var weakEls=(bazi.ep?Object.entries(bazi.ep).filter(function(e){return e[1]<=1;}).map(function(e){return e[0];}):[])||[];
          var strongEls=(bazi.ep?Object.entries(bazi.ep).filter(function(e){return e[1]>=4;}).map(function(e){return e[0];}):[])||[];
          var hMap={'木':'肝膽筋骨','火':'心血管血壓','土':'脾胃消化','金':'肺呼吸道','水':'腎泌尿內分泌'};
          if(dyRel==='剋制日主') dyText+=dyGanEl+'行剋你的'+el+'行，免疫力易下降';
          else if(dyRel==='日主洩氣') dyText+=el+'行能量被洩耗，容易疲勞虛弱';
          else if(dyRel==='生助日主') dyText+='大運'+dyGanEl+'行生助你，健康底子不錯';
          else dyText+='健康能量中性';
          if(weakEls.length) dyText+='，重點關注'+weakEls.map(function(e){return e+'行偏弱→'+hMap[e];}).join('、')+'。';
          else if(strongEls.length) dyText+='，注意'+strongEls.map(function(e){return e+'行過旺→'+hMap[e]+'負擔';}).join('、')+'。';
          else dyText+='，五行均衡，維持作息即可。';
        } else if(type==='family'){
          if(dyRel==='生助日主') dyText+='大運'+dyGanEl+'行生助你，家庭關係中你被支持、被關照，適合處理家族事務。';
          else if(dyRel==='剋制日主') dyText+='大運'+dyGanEl+'行剋你的'+el+'行，與長輩觀念衝突加劇，需用耐心代替爭論。';
          else if(dyRel==='日主洩氣') dyText+='你在家庭中付出大量精力照顧他人，但容易被視為理所當然。';
          else if(dyRel==='比肩同氣') dyText+='家庭中你與兄弟姊妹能量相當，容易有資源分配或意見分歧的議題。';
          else if(dyRel==='日主所剋') dyText+='你在家中說了算但家人可能感到壓迫，主動示弱反而能改善氣氛。';
          else dyText+='家庭能量中性。';
        } else if(type==='relationship'){
          if(dyRel==='生助日主') dyText+='大運'+dyGanEl+'行生你，貴人緣佳，合作夥伴會主動釋出資源。';
          else if(dyRel==='剋制日主') dyText+='大運'+dyGanEl+'行剋你，人際中容易遇到壓制你的人（上司型/控制型），合作前釐清權責。';
          else if(dyRel==='比肩同氣') dyText+='同行/同質性的人大量出現，既是盟友也是競爭者，選對合作對象是關鍵。';
          else if(dyRel==='日主洩氣') dyText+='你在人際中容易過度迎合或付出，需設底線避免被消耗。';
          else if(dyRel==='日主所剋') dyText+='你在合作中主導性強，但對方可能感到不被尊重。';
          else dyText+='人際能量中性。';
        } else {
          dyText+='在「'+_typeWord+'」上，'+dyGanEl+'行大運'+(dyRel||'')+'對你的'+el+'行日主帶來'+(dyOk?'助力。':dyBad?'壓力。':'中性影響。');
        }
      }

      // ── 流年：真正讀取十神+天干五行動態組句 ──
      var lnText='';
      if(liuNian){
        var lnGan=liuNian.gz?liuNian.gz.charAt(0):'';
        var lnGanEl=ganElMap[lnGan]||'';
        var lnGod=liuNian.god||'';
        var lnClash=(liuNian.clash&&liuNian.clash.length)?'，流年沖'+liuNian.clash.join('、')+'，該領域波動加大':'';
        lnText='今年流年「'+liuNian.gz+'」（天干'+lnGan+lnGanEl+'行，十神「'+lnGod+'」），';

        // 十神×領域動態組句
        var _godCareer={'正官':'體制壓力增加，適合在組織內累積信用','七殺':'高壓突破期，直面問題能轉危為機','正印':'適合進修考照沉澱內功','偏印':'靈感敏銳但容易鑽牛角尖','比肩':'競爭者多，找互補型合作','劫財':'資源重新洗牌，禁高槓桿','食神':'才華輸出期，適合內容創作','傷官':'銳氣外放容易得罪人，三思後言','正財':'穩健收成靠勞力換取','偏財':'機會多但財來快去也快'};
        var _godLove={'正官':'感情上渴望穩定承諾','七殺':'遇到強勢對象或激烈競爭者','正印':'想被照顧被理解，母性能量強','偏印':'對感情忽冷忽熱讓對方困惑','比肩':'遇到條件相當的人但互不退讓','劫財':'桃花劫，感情中容易破財或被搶','食神':'享受戀愛甜蜜期','傷官':'對伴侶要求高容易挑剔','正財':'認真經營關係，適合結婚','偏財':'桃花多但不穩定'};
        var _godWealth={'正官':'正財穩定但受體制約束','七殺':'高風險高回報的壓力期','正印':'不利投資，適合存錢','偏印':'偏門投資有靈感但風險大','比肩':'同行搶食分潤','劫財':'破財風險最高，嚴守止損','食神':'靠專業技能穩定獲利','傷官':'投資判斷力銳利但衝動','正財':'正財格局一分耕耘一分收穫','偏財':'偏財窗口適合業務開發但設停損'};
        var _godHealth={'正官':'壓力大導致自律神經失調','七殺':'過勞風險極高需強制休息','正印':'身心修復期適合療養','偏印':'精神內耗失眠風險','比肩':'體力消耗在社交競爭上','劫財':'意外受傷風險提高','食神':'食慾旺但容易發胖','傷官':'心火旺導致焦慮失眠','正財':'健康穩定但注意久坐職業病','偏財':'應酬多肝膽負擔重'};
        var _godFamily={'正官':'家庭責任感加重','七殺':'與長輩衝突加劇','正印':'與母親關係密切','偏印':'與家人溝通有代溝','比肩':'兄弟姊妹資源分配議題','劫財':'家庭財務壓力','食神':'家庭氣氛溫馨','傷官':'容易對家人口出直言傷感情','正財':'適合處理房產家族財務','偏財':'家庭外務多顧不到家'};
        var _godRel={'正官':'遇到有權威的貴人','七殺':'人際中出現強勢壓制者','正印':'長輩型貴人出現','偏印':'人際關係若即若離','比肩':'志同道合的夥伴出現','劫財':'合作中被搶功或背叛風險','食神':'社交魅力爆棚','傷官':'口舌是非多注意言辭','正財':'人脈帶來穩定回報','偏財':'人脈快速擴張但品質不一'};

        var _godMap={'career':_godCareer,'love':_godLove,'wealth':_godWealth,'health':_godHealth,'family':_godFamily,'relationship':_godRel};
        var _thisGodText=(_godMap[type]||{})[lnGod]||'';
        if(_thisGodText) lnText+=_thisGodText;
        else lnText+='整體能量'+liuNian.level;
        lnText+=lnClash+'。';
      }

      // ── 梅花：讀取實際卦名+體用+領域化 ──
      var mhText='';
      if(mh){
        var rel=mh.ty?mh.ty.r:'';
        var benN=mh.ben?mh.ben.n:'';var bianN=mh.bian?mh.bian.n:'';
        mhText='梅花「'+benN+'」變「'+bianN+'」，';
        if(rel==='用生體'){
          var _usb={'career':'外在資源（客戶/市場）主動找上你。','love':'對方或環境對你有好感，桃花送上門。','wealth':'有進財能量，財源從外部流入。','health':'身體有自癒力，治療效果好。','family':'家人主動支持你。','relationship':'合作方會主動釋出善意。'};
          mhText+=_usb[type]||'外在環境主動配合你。';
        } else if(rel==='用克體'){
          var _ukt={'career':'外在壓力（競爭/上司/市場）正在擠壓你。','love':'感情有外力干擾（第三者/家人反對/距離）。','wealth':'有破財壓力，外部因素在消耗你。','health':'外在環境（工作壓力/作息不良）損害健康。','family':'家中有成員造成你的消耗。','relationship':'合作方在消耗你的資源。'};
          mhText+=_ukt[type]||'外在阻力在擠壓你。';
        } else if(rel==='體生用'){
          var _tsy={'career':'你的精力大量外流，為團隊付出多回報慢。','love':'你在關係中付出多，對方回饋少。','wealth':'錢在往外跑，需控制支出。','health':'身體能量消耗中（過勞/失眠），需補充。','family':'你為家庭付出多但被視為理所當然。','relationship':'你在合作中付出比回報多。'};
          mhText+=_tsy[type]||'你的付出比回報多。';
        } else if(rel==='體克用'){
          var _tku={'career':'你有掌控力但推動過程費力。','love':'你在關係中較強勢，注意給對方空間。','wealth':'有賺錢能力但需靠勞力換取。','health':'意志力能對抗病痛，但不要硬撐。','family':'你在家中說了算，留意家人感受。','relationship':'你主導合作但對方可能感到壓力。'};
          mhText+=_tku[type]||'你有掌控力但過程費力。';
        } else {
          mhText+='體用比和，'+_typeWord+'平穩無大波動。';
        }
      }

      // dyText/lnText/mhText 已在 act2-cards（核心能量定錨）完整呈現，此處不再重複 inline 輸出

      // 具體行動建議（子意圖感知版）
      var actionItems=[];
      const _qi=S.form?S.form.question:'';
      
      if(type==='wealth'){
        const _isDebt=/負債|欠錢|周轉|被騙|破產|卡債|貸款還不起|還債|被坑/.test(_qi);
        const _isGamble=/股票|當沖|期貨|虛擬幣|加密|樂透|彩券|賭|短線|選擇權|合約/.test(_qi);
        if(_isDebt){
          actionItems.push('<strong>止血行動：</strong>立刻列出所有債務清單（金額、利率、月付），從最高利率的開始處理。考慮債務整合降低月付壓力。');
          actionItems.push('<strong>現金流防守：</strong>砍掉所有非必要開支。這段時間不投資、不借錢給人、不做任何需要先付錢的副業。');
          actionItems.push('<strong>求助管道：</strong>撥打1925（金融消費）或找合法的債務協商管道。佩戴'+_safeCrystalPair('黑曜石','茶晶')+'穩定心神，一步一步來。');
        }else if(_isGamble){
          actionItems.push(great||good?'<strong>投機策略：</strong>直覺期偏準，可小額試水（不超過月收入5%）。設好停利停損，到了就走。':'<strong>投機警告：</strong>目前偏財運低迷，逢賭必輸的節奏。強制空手觀望，把錢放定存比較實際。');
          actionItems.push('<strong>紀律管理：</strong>不追高、不攤平、不借錢操作。每次交易前寫下理由，衝動時看一眼就知道該不該進場。');
          actionItems.push('<strong>能量防護：</strong>佩戴'+_safeCrystal('紫水晶')+'增強冷靜判斷力。遠離群組報牌、帶單老師。');
        }else{
          actionItems.push(great||good?'<strong>理財行動：</strong>目前財運有支撐，可以把閒置資金投入低風險工具（定存、ETF），但單筆不超過可承受虧損的額度。':'<strong>理財行動：</strong>現階段先穩住現金流，減少非必要訂閱和衝動消費。每月至少存收入的15%作為緊急預備金。');
          actionItems.push('<strong>開運飲食：</strong>工作日多吃'+fd_r.food+'，下午來杯'+fd_r.drink+'，補充'+favEl+'行能量。');
          actionItems.push('<strong>財位佈局：</strong>辦公桌面朝'+dirName_r+'，錢包放'+dirName_r+'方位。穿'+fd_r.subcolor+'色系談生意或面試更有利。');
        }
      }else if(type==='love'){
        const _isCrisis=/分手|外遇|出軌|劈腿|偷吃|第三者|小三|花心|離婚|分居|冷戰|冷淡|不理|不回|已讀|消失|忽冷忽熱|吵架|爭吵|鬧|生氣|背叛|不愛|要走|離開/.test(_qi);
        const _isRecover=/復合|挽回|回來|道歉|原諒|再一次|和好/.test(_qi);
        if(_isCrisis){
          actionItems.push(great||good?'<strong>關係修復：</strong>危機有轉圜餘地。先冷靜48小時不做任何決定，然後用「我感受到…」而非「你總是…」開啟對話。':'<strong>停損評估：</strong>裂痕已深，修復成本極高。問自己：這段關係讓我成為更好的人嗎？如果答案是否定的，離開不是失敗。');
          actionItems.push('<strong>情緒防護：</strong>絕對不翻對方手機、不跟蹤社群。這些行為只會加速崩壞。找一個信任的朋友傾訴，而不是獨自內耗。');
          actionItems.push('<strong>能量穩定：</strong>佩戴'+_safeCrystal('黑曜石')+'擋爛桃花煞氣，'+_safeCrystal('紫水晶')+'保持冷靜判斷。禁止佩戴粉晶（會增加混亂桃花能量）。');
        }else if(_isRecover){
          actionItems.push(great||good?'<strong>復合策略：</strong>有機會，但不能硬來。先提升自己的狀態，讓對方看到你的改變，而不是一直求、一直道歉。':'<strong>冷靜評估：</strong>復合的成功率不高。如果對方已經明確拒絕，請尊重並把能量轉回自己身上。');
          actionItems.push('<strong>行動節奏：</strong>第一週完全不聯繫。第二週用輕鬆話題（不提感情）試探。有回應再慢慢推進。');
          actionItems.push('<strong>能量調整：</strong>佩戴'+_safeCrystal('海藍寶')+'增強溝通力，'+_safeCrystal('茶晶')+'穩定焦慮情緒。先穩住自己再談感情。');
        }else{
          actionItems.push(great||good?'<strong>桃花行動：</strong>多參加社交活動，往'+dirName_r+'方向的場所走動。穿'+fd_r.subcolor+'配'+fd_r.motherColor+'，提升異性緣。':'<strong>自我提升：</strong>先把自己狀態調好——規律運動（推薦'+fd_r.sport+'），保持好氣色就是最強桃花。');
          actionItems.push('<strong>開運飲食：</strong>約會可選有'+fd_r.food.split('、')[0]+'的餐廳，日常喝'+fd_r.drink+'調理氣色。');
          actionItems.push('<strong>能量調整：</strong>佩戴'+_safeCrystalPair('粉晶','紅紋石')+'增強桃花磁場。家中'+dirName_r+'方位保持整潔明亮。');
        }
      }else if(type==='career'){
        const _isJump=/跳槽|辭職|離職|換工作|換跑道|轉行|轉職|該不該離開|想走|想辭/.test(_qi);
        const _isBiz=/創業|開店|接案|副業|自己做|freelance|獨立|合夥開/.test(_qi);
        if(_isJump){
          // ★ great/good=事業運好=留下有利
          actionItems.push(great||good?'<strong>觀望策略：</strong>你目前事業能量不錯，先穩住現職把該拿的拿到。同時可以私下面試探探市場行情，但不建議衝動離開。':'<strong>轉換策略：</strong>事業能量偏弱，確實可以考慮新方向。果斷準備履歷，面試穿'+fd_r.subcolor+'為主色調增強氣場。先拿到新 offer 再提離職，不要裸辭。');
          actionItems.push('<strong>時機掌握：</strong>面試安排在上午、往'+dirName_r+'方向的公司優先。離職前確認勞健保銜接、競業條款。');
          actionItems.push('<strong>能量補充：</strong>佩戴'+_safeCrystalPair('鈦晶','虎眼石')+'增強決斷力。多吃'+fd_r.food+'補充'+favEl+'行能量。');
        }else if(_isBiz){
          actionItems.push(great||good?'<strong>創業評估：</strong>能量支持你嘗試，但先算清楚——至少準備6個月現金流的緊急預備金。先用最小規模驗證市場需求。':'<strong>創業緩行：</strong>目前時機偏弱。如果非做不可，先保留正職用下班時間測試。不要一次 all-in。');
          actionItems.push('<strong>現金流管理：</strong>創業初期嚴格分開個人帳戶和公司帳戶。每月固定檢視損益，連續虧損3個月必須重新評估。');
          actionItems.push('<strong>方位運用：</strong>辦公/工作室往'+dirName_r+'方位設置。重要商談穿'+fd_r.subcolor+'。佩戴'+_safeCrystalPair('綠幽靈','鈦晶')+'招正財。');
        }else{
          actionItems.push(great||good?'<strong>職場行動：</strong>運勢支持你積極爭取，主動展現成果讓上面看到。有好機會出現就果斷行動。':'<strong>職場策略：</strong>目前運勢需要蓄力，專注提升核心技能。找一個值得信賴的前輩借力，比獨撐更聰明。');
          actionItems.push('<strong>效率提升：</strong>每天最重要的事在上午完成，下班後做'+fd_r.sport+'放鬆。'+fd_r.habit);
          actionItems.push('<strong>穿搭開運：</strong>重要場合穿'+fd_r.subcolor+'為主色調，搭配'+fd_r.motherColor+'配件。辦公桌面朝'+dirName_r+'方位。');
        }
      }else if(type==='health'){
        const _isSevere=/手術|開刀|重病|癌|腫瘤|住院|化療|洗腎|失眠|憂鬱|焦慮|恐慌|自殺|崩潰/.test(_qi);
        if(_isSevere){
          actionItems.push(great||good?'<strong>醫療運勢：</strong>命盤顯示你的醫療運偏好，有機會遇到合適的醫師。積極配合治療，正面心態是最好的輔助。':'<strong>醫療建議：</strong>建議尋求第二醫療意見。術後或治療期間注意感染風險，嚴格遵照醫囑。');
          actionItems.push('<strong>身心支援：</strong>不要獨自承受。告訴至少一個信任的人你的狀況。需要時撥打安心專線 1925。');
          actionItems.push('<strong>⚠️ 重要聲明：</strong>命理僅供心理參考，不具醫療診斷效力。所有健康問題請務必諮詢專業醫師。');
        }else{
          actionItems.push('<strong>養生重點：</strong>'+fd_r.habit+'。每週至少3次'+fd_r.sport+'，每次30分鐘以上。');
          actionItems.push('<strong>食療建議：</strong>多吃'+fd_r.food+'，搭配'+fd_r.drink+'。'+(bad?'身體較虛時忌熬夜、忌冰冷飲食。':'維持均衡飲食即可。'));
          actionItems.push('<strong>環境調整：</strong>臥室或休息區往'+dirName_r+'方位佈置。穿'+fd_r.color+'居家服有助身心放鬆。');
        }
      }else if(type==='relationship'){
        const _isEnemy=/小人|防人|被搞|背叛|被告|官司|訴訟|被陷害|是非|口舌|霸凌|排擠/.test(_qi);
        if(_isEnemy){
          actionItems.push(great||good?'<strong>防禦策略：</strong>小人暫時無力傷你，但不能掉以輕心。所有重要溝通留下書面紀錄（截圖、email）。':'<strong>自保行動：</strong>你目前處於弱勢。低調行事，不在公開場合表態。準備好證據，必要時諮詢律師。');
          actionItems.push('<strong>社交紀律：</strong>近期減少多人聚會，一對一深談更安全。不在背後討論任何人。');
          actionItems.push('<strong>能量防護：</strong>佩戴'+_safeCrystalPair('黑曜石','虎眼石')+'擋小人煞氣。辦公桌'+dirName_r+'方位放鏡面物品反射負能量。');
        }else{
          actionItems.push(great||good?'<strong>社交行動：</strong>貴人在'+dirName_r+'方向，多參加那個方位的聚會。每月約一個重要的人吃飯，主動維繫人脈。':'<strong>人際策略：</strong>不需要討好所有人，找到真正欣賞你的圈子更重要。每週安排一次深度對話，勝過頻繁泛泛之交。');
          actionItems.push('<strong>社交穿搭：</strong>社交場合穿'+fd_r.subcolor+'為主，搭配'+fd_r.motherColor+'配件，提升親和力。');
          actionItems.push('<strong>能量補充：</strong>多吃'+fd_r.food+'，喝'+fd_r.drink+'。社交前做幾次深呼吸調整狀態。');
        }
      }else if(type==='family'){
        const _isConflict=/吵架|分居|婆媳|分家|分產|長輩.*病|爸.*媽.*吵|公婆|岳父|岳母|離家|搬出去|斷絕|不來往/.test(_qi);
        if(_isConflict){
          actionItems.push(great||good?'<strong>溝通策略：</strong>有和解空間。找一個雙方都尊重的中間人協調，比直接硬碰硬有效。先聽完對方的完整想法再表態。':'<strong>物理距離：</strong>衝突已到臨界點，建議暫時拉開物理距離。不是逃避，是給彼此冷卻的空間。涉及法律或財產問題，請諮詢專業人士。');
          actionItems.push('<strong>情緒管理：</strong>不在情緒高點做任何決定。每天花10分鐘獨處，做深呼吸或散步清空情緒。');
          actionItems.push('<strong>能量穩定：</strong>佩戴'+_safeCrystal('紫水晶')+'保持理性，'+_safeCrystal('茶晶')+'接地穩定心神。臥室'+dirName_r+'方位放暖色小燈增強安全感。');
        }else{
          actionItems.push('<strong>家庭互動：</strong>本月多花時間陪伴家人。一頓用心的晚餐勝過千言萬語。');
          actionItems.push('<strong>居家風水：</strong>家中'+dirName_r+'方位保持整潔明亮，擺放綠植或暖色燈飾增強和諧能量。');
          actionItems.push('<strong>家庭飲食：</strong>家庭餐桌上多準備'+fd_r.food+'，全家一起喝'+fd_r.drink+'。');
        }
      }else{
        actionItems.push('<strong>穿搭開運：</strong>以'+fd_r.subcolor+'為主色調，搭配'+fd_r.motherColor+'配件。');
        actionItems.push('<strong>飲食調理：</strong>多吃'+fd_r.food+'，搭配'+fd_r.drink+'。');
        actionItems.push('<strong>方位運用：</strong>重要事情往'+dirName_r+'方位進行。');
      }

      if(actionItems.length){
        parts.push('<div style="margin-top:0.6rem;padding:0.6rem 0.8rem;background:rgba(212,175,55,0.04);border-radius:8px;line-height:1.7">');
        parts.push('<p style="font-weight:600;color:var(--c-gold,#d4af37);margin-bottom:0.4rem;font-size:0.9rem">📋 具體建議</p>');
        actionItems.forEach(function(item){parts.push('<p style="margin:0.3rem 0;font-size:0.92rem">'+item+'</p>');});
        parts.push('</div>');
      }

      // 時機提示（人話版）
      if(yearInfo||badYears.length){
        var timingText='<p style="margin-top:0.5rem;font-size:0.9rem;line-height:1.6"><strong style="color:var(--c-gold)">⏰ 時機提示：</strong>';
        if(yearInfo) timingText+=yearInfo+' ';
        if(badYears.length) timingText+='這幾年要特別小心：'+badYears.join('、')+'，運勢較低迷，重大決定建議延後。';
        timingText+='</p>';
        parts.push(timingText);
      }

      if(parts.length) detail=parts.join('');
    }

    // 升級太短的 tip
    if(tip&&tip.length<30){
      tip=tip+'佩戴與'+favEl+'行相關的水晶（如'+({'金':_safeCrystalPair('白水晶','鈦晶'),'木':_safeCrystalPair('綠幽靈','綠碧璽'),'水':_safeCrystalPair('海藍寶','黑曜石'),'火':_safeCrystalPair('紫水晶','紅瑪瑙'),'土':_safeCrystalPair('黃水晶','茶晶')}[favEl]||_safeCrystal('白水晶'))+'）效果更好。多吃'+fd_r.food+'補充能量。';
    }
  })();

  /* ═══ 正面回應前置器 ═══ */
  (function(){
    // 1. 「你覺得如何/好嗎」型問題 — 先給明確態度
    if(/你覺得|覺得如何|覺得怎|好不好|好嗎|如何[？?]$|怎樣[？?]$|怎麼樣[？?]$/.test(q)){
      const opinion = prob>=65 ? '整體來看是可以的，' :
                      prob>=50 ? '可以，但建議謹慎，' :
                      '目前不太建議，';
      if(answer && !/整體來看|可以但|不太建議/.test(answer)){
        answer = '<strong>'+opinion+'</strong> ' + answer.replace(/<strong>/,'').replace(/<\/strong>/,'');
      }
    }

    // 2. 「多少錢/中多少」型問題 — 命理無法預測具體數字
    if(/多少錢|中多少|贏多少|賺多少錢|幾萬|幾百萬/.test(q)){
      const pcfStr = prob>=60 ? '偏財運不錯' : prob>=45 ? '偏財運普通' : '偏財運偏弱';
      const prefix = '<strong>'+pcfStr+'。</strong> 命理無法預測具體金額，但從運勢方向來看——';
      if(answer && !/偏財運|具體金額/.test(answer)){
        answer = prefix + answer.replace(/<strong>/g,'').replace(/<\/strong>/g,'');
      }
    }

    // 3. 是非題但 answer 沒直接回答 — 自動補上態度
    if(isYN && answer && !/可以|有機會|會的|不建議|困難|穩定|不錯|目前|整體/.test(answer.substring(0,30))){
      const att = great ? '從命理來看，可以。' : good ? '從命理來看，有機會。' : '從命理來看，目前有些困難。';
      answer = '<strong>'+att+'</strong> ' + answer;
    }
  })();

  /* ═══ 回答增強器 — 自動補充 detail ═══ */
  (function(){
    if(detail && detail.length > 50) return; // 已有足夠 detail，不覆蓋

    const parts = [];

    // 深度解讀（大運/流年/梅花）已在 act2-cards 核心能量定錨完整呈現，此處不再重複

    // 📋 具體建議 — 根據六大類型定制
    const crystalMap = {'金':_safeCrystalPair('白水晶','鈦晶'),'木':_safeCrystalPair('綠幽靈','綠碧璽'),'水':_safeCrystalPair('海藍寶','黑曜石'),'火':_safeCrystalPair('紫水晶','紅瑪瑙'),'土':_safeCrystalPair('黃水晶','茶晶')};
    const foodMap = {'金':'白色食物（山藥、百合、蓮子）','木':'綠色蔬菜（菠菜、花椰菜、奇異果）','水':'黑色食物（黑芝麻、海帶、黑豆）','火':'紅色食物（紅棗、枸杞、番茄）','土':'黃色食物（南瓜、地瓜、玉米）'};
    const crystal = crystalMap[favEl]||_safeCrystal('白水晶');
    const food = foodMap[favEl]||'當季蔬果';
    let advice = '<p style="margin:0.3rem 0">📋 <strong>具體建議：</strong></p><ol style="margin:0.2rem 0;padding-left:1.2rem;line-height:1.7">';
    if(type==='love'){
      advice += '<li>'+(pk?'你桃花旺，重點是選對人不是認識更多人。':'多參加朋友聚會或興趣社團增加緣分。')+'往'+FD[favEl]+'方向社交更有利。</li>';
      advice += '<li>佩戴'+_safeCrystal('粉晶')+'或'+crystal+'增強感情磁場。</li>';
      advice += '<li>多吃'+food+'，穿'+FC[favEl]+'色系約會。</li>';
    } else if(type==='career'){
      advice += '<li>'+(strong?'你有領導氣質，爭取獨立負責的項目展現能力。':'你適合深耕專業，把一項技能做到極致讓自己不可替代。')+'</li>';
      advice += '<li>'+(wc?'利用文昌運去考證照或進修。':'學一項新技能提升競爭力。')+'</li>';
      advice += '<li>穿'+FC[favEl]+'色上班。往'+FD[favEl]+'方向發展更有利。</li>';
    } else if(type==='wealth'){
      advice += '<li>'+(good?'適合穩健型投資（定存、基金定期定額）。':'先守住現金流，避免高風險操作。')+'</li>';
      advice += '<li>多吃'+food+'補財運能量。錢包用'+FC[favEl]+'色。</li>';
      advice += '<li>辦公桌或家中'+FD[favEl]+'方位擺放'+crystal+'招財。</li>';
    } else if(type==='health'){
      const _epArr=Object.entries(ep).sort((a,b)=>a[1]-b[1]);
      const _wk=_epArr[0]?_epArr[0][0]:'土';
      const _bp=(typeof WO!=='undefined'?WO[_wk]:'')||'';
      advice += '<li>你的五行'+_wk+'行偏弱，'+_bp+'方面要特別注意。</li>';
      advice += '<li>飲食多吃'+(typeof WF!=='undefined'?WF[_wk]:'當季蔬果')+'。</li>';
      advice += '<li>日常保養：'+(typeof WH!=='undefined'?WH[_wk]:'規律作息')+'</li>';
    } else if(type==='relationship'){
      advice += '<li>'+(gr?'你命帶天乙貴人，貴人運不錯。':'多結交比你年長或有經驗的朋友。')+'往'+FD[favEl]+'方向的人是你的貴人方位。</li>';
      advice += '<li>佩戴'+crystal+'增強人際和諧。</li>';
      advice += '<li>穿'+FC[favEl]+'色參加社交場合。</li>';
    } else if(type==='family'){
      advice += '<li>家中'+FD[favEl]+'方位擺放綠植或水晶增強和諧氣場。</li>';
      advice += '<li>穿'+FC[favEl]+'色回家有助家庭能量。</li>';
      advice += '<li>重大家庭決定選在運勢好的時期處理。</li>';
    }
    advice += '</ol>';
    parts.push(advice);

    // ⏰ 時機提示
    if(goodYears && goodYears.length){
      let timing = '<p style="margin:0.3rem 0">⏰ <strong>時機提示：</strong>';
      timing += yearInfo+' ';
      if(badYears && badYears.length) timing += '要特別小心：'+badYears.join('、')+'，運勢較低迷。';
      timing += '</p>';
      parts.push(timing);
    }

    if(parts.length) detail = (detail||'') + parts.join('');
  })();

  /* ═══ 組合輸出 ═══ */
  
  // ══════════════════════════════════════════════════════
  // ★ 多維度獨立判斷 → 交叉辯證系統
  // 每個維度先獨立產出「結論+理由+方向」
  // 再交叉比對一致性與矛盾，產生辯證敘事
  // ══════════════════════════════════════════════════════

  const V = []; // verdicts array: {dim, dir, score, verdict, reason, detail}
  // dir: 'pos'(吉) / 'neg'(凶) / 'mid'(中性)

  // ── 維度1: 八字（先天格局 + 大運流年）──
  (function baziVerdict(){
    if(!bazi) return;
    let dir='mid', score=50, verdict='', reason='', detail='';
    const favEl=fav[0]||'', unfavEl=unfav[0]||'';
    const favStr=favEl&&ep[favEl]?ep[favEl]:0;
    const unfavStr=unfavEl&&ep[unfavEl]?ep[unfavEl]:0;

    // 先天格局判斷
    let baseDir='mid', baseReason='';
    if(type==='wealth'){
      const caiEl2=typeof KE!=='undefined'?KE[el]:'';
      const caiStr2=caiEl2&&ep[caiEl2]?ep[caiEl2]:0;
      if(strong&&caiStr2>15){baseDir='pos'; baseReason=`身強（${dm}）扛得住財，財星${caiEl2}行能量${caiStr2}%不弱`;}
      else if(!strong&&caiStr2>20){baseDir='neg'; baseReason=`身弱扛不住大財，財星${caiEl2}行${caiStr2}%反而是壓力`;}
      else if(strong){baseDir='mid'; baseReason=`身強但財星不算旺，有底氣但機會要自己創造`;}
      else{baseDir='neg'; baseReason=`身弱財星也不旺，財運需要靠後天努力`;}
    } else if(type==='love'){
      const pk2=bazi.shensha&&bazi.shensha.includes('桃花');
      const hl2=bazi.shensha&&bazi.shensha.includes('紅鸞');
      if(pk2||hl2){baseDir='pos'; baseReason=`命帶${pk2?'桃花':''}${hl2?'紅鸞':''}，先天桃花緣不差`;}
      else if(bazi.shensha&&(bazi.shensha.includes('孤辰')||bazi.shensha.includes('寡宿'))){baseDir='neg'; baseReason='命帶孤辰/寡宿，感情路比較曲折';}
      else{baseDir='mid'; baseReason='先天桃花條件中等，靠後天經營';}
    } else if(type==='career'){
      if(strong){baseDir='pos'; baseReason=`身強有魄力，適合獨當一面`;}
      else{baseDir='mid'; baseReason='身弱適合合作或深耕專業，不宜硬拼';}
      if(bazi.shensha&&bazi.shensha.includes('文昌')){baseReason+=`，加上文昌星助學業考試`; if(baseDir==='mid')baseDir='pos';}
    } else if(type==='health'){
      if(strong){baseDir='pos'; baseReason='身強底子不差，基礎體質算好的';}
      else{baseDir='neg'; baseReason='身弱體質偏敏感，容易受外界影響';}
    } else {
      if(favStr>20){baseDir='pos'; baseReason=`喜用神${favEl}行能量${favStr}%充足`;}
      else if(unfavStr>25){baseDir='neg'; baseReason=`忌神${unfavEl}行能量${unfavStr}%偏旺，有壓力`;}
      else{baseDir='mid'; baseReason='先天格局條件中等';}
    }

    // 大運流年疊加
    let dyDir='mid', dyReason='';
    if(curDy){
      const lv=curDy.level;
      if(/旺盛|極強|上升|大吉|中吉/.test(lv)){dyDir='pos'; dyReason=`十年大運${curDy.gz}（${lv}），外在助力充足`;}
      else if(/低迷|偏弱|大凶|中凶/.test(lv)){dyDir='neg'; dyReason=`大運${curDy.gz}（${lv}），外在環境不太支持`;}
      else{dyDir='mid'; dyReason=`大運${curDy.gz}（${lv}），不特別助力也不拖累`;}
    }
    let lnDir='mid', lnReason='';
    const thisYr=new Date().getFullYear();
    if(curDy&&curDy.liuNian){
      const ln=curDy.liuNian.find(l=>l.year===thisYr);
      if(ln){
        if(ln.score>1){lnDir='pos'; lnReason=`${thisYr}流年${ln.gz}偏吉`;}
        else if(ln.score<-1){lnDir='neg'; lnReason=`${thisYr}流年${ln.gz}偏凶`;}
        else{lnDir='mid'; lnReason=`${thisYr}流年${ln.gz}中性`;}
      }
    }

    // 綜合八字結論
    const dirs=[baseDir, dyDir, lnDir];
    const posC=dirs.filter(d=>d==='pos').length, negC=dirs.filter(d=>d==='neg').length;
    if(posC>=2) dir='pos';
    else if(negC>=2) dir='neg';
    else dir='mid';

    // 組合理由 — 展示內部辯證
    reason=baseReason;
    if(dyDir!==baseDir && dyDir!=='mid'){
      reason+=`。但${dyReason}`;  // 先天vs大運矛盾
    } else if(dyReason){
      reason+=`，加上${dyReason}`;
    }
    if(lnReason) reason+=`，${lnReason}`;

    verdict = dir==='pos'?'八字偏向支持' : dir==='neg'?'八字條件偏弱' : '八字中性，看其他維度';
    V.push({dim:'八字', dir, score:0, verdict, reason, detail:''});
  })();

  // ── 維度2: 梅花易數（實戰派完整分析：體用生剋+月令旺衰+動爻+互卦+變卦五行）──
  (function meihuaVerdict(){
    if(!mh) return;
    let dir='mid', verdict='', reason='';
    const ma=analyzeMeihua(mh, type);
    if(!ma||!ma.analysis===undefined){
      // fallback
      const judge=mh.ty.f;
      if(/大吉|吉/.test(judge)) dir='pos';
      else if(/凶/.test(judge)) dir='neg';
      reason=`${mh.ty.r}（${judge}）`;
      verdict=dir==='pos'?'梅花偏吉':dir==='neg'?'梅花偏凶':'梅花中性';
      V.push({dim:'梅花', dir, score:0, verdict, reason, detail:''});
      return;
    }

    // 用完整分析結果
    const benName=mh.ben?mh.ben.n:'', bianName=mh.bian?mh.bian.n:'';
    const parts=[];

    // 1. 體用生剋（核心）
    parts.push(`${mh.ty.r}（${mh.ty.f}）`);

    // 2. 月令旺衰
    if(ma.wangShuai.ti){
      const ws=ma.wangShuai.ti;
      if(ws.level==='旺'||ws.level==='相') parts.push(`體卦${mh.tiG.el}行當月「${ws.level}」得令有力`);
      else if(ws.level==='囚'||ws.level==='死') parts.push(`體卦${mh.tiG.el}行當月「${ws.level}」失令偏弱`);
    }

    // 3. 動爻
    parts.push(ma.dongYao.desc);

    // 4. 互卦（過程）
    if(ma.huGua.effect) parts.push(`互卦「${mh.hu.n}」${ma.huGua.effect}`);

    // 5. 變卦（結果）— 五行生剋
    if(ma.bianGua.effect) parts.push(`變卦「${bianName}」${ma.bianGua.effect}`);

    // 6. 類型信號
    if(ma.signals.length) parts.push(ma.signals[0]);

    // 7. 時間推算
    if(ma.timing.speed) parts.push(`時間：${ma.timing.speed}`);

    // 綜合判斷：用分數
    if(ma.score>=62) dir='pos';
    else if(ma.score<=38) dir='neg';
    else dir='mid';

    reason=`本卦「${benName}」→ 變卦「${bianName}」，`+parts.join('；');
    verdict=dir==='pos'?'梅花整體偏吉':dir==='neg'?'梅花整體偏凶':'梅花卦象中性';

    V.push({dim:'梅花', dir, score:ma.score, verdict, reason, detail:ma.narrative||''});
  })();

  // ── 維度3: 塔羅（金色黎明系統 Celtic Cross 完整解讀）──
  (function tarotVerdict(){
    if(!tarot||!tarot.drawn||tarot.drawn.length<10) return;
    const d=tarot.drawn;
    // 位置定義（金色黎明標準）
    // 0=核心現況 1=阻礙/挑戰 2=潛意識根源 3=過去基礎 4=顯意識目標 
    // 5=近期未來 6=自身狀態 7=環境他人 8=希望恐懼 9=最終結果
    const core=d[0], challenge=d[1], subcon=d[2], past=d[3], conscious=d[4];
    const nearFut=d[5], self=d[6], environ=d[7], hopeFear=d[8], outcome=d[9];
    const _d=function(c){return c.n+(c.isUp?' 正位':' 逆位');};
    const _m=function(c){return c.isUp?c.up:c.rv;};

    let dir='mid', verdict='', reason='';
    let posSignals=0, negSignals=0;
    const storyParts=[];

    // ★ Step 1：核心區（1+2）— 定主軸，權重最高
    const corePositive=core.isUp; // 核心牌正位=問題本質偏正面
    storyParts.push('核心「'+_d(core)+'」：'+_m(core));
    if(corePositive) posSignals+=2; else negSignals+=2;

    // 阻礙牌：不只看正逆，要看牌義本身
    const challengeMeaning=_m(challenge);
    storyParts.push('阻礙「'+_d(challenge)+'」：'+challengeMeaning);
    // 阻礙位比較特殊：正位=明顯的外在阻力，逆位=隱藏或內在障礙
    if(!challenge.isUp) negSignals+=1; // 逆位阻礙=內心魔障

    // ★ Step 2：內在區（3潛意識+5顯意識+9希望恐懼）— 拆心理
    // 潛意識 vs 顯意識是否矛盾（嘴巴說要A，內心想B）
    const innerConflict=subcon.isUp!==conscious.isUp;
    if(innerConflict){
      storyParts.push('⚡ 內在矛盾：潛意識「'+_d(subcon)+'」與意識目標「'+_d(conscious)+'」方向不一致，內心有拉扯');
      negSignals+=1;
    } else {
      storyParts.push('內在一致：潛意識與意識目標方向相同');
      posSignals+=1;
    }
    // 希望恐懼位 — 揭示核心焦慮或渴望
    if(!hopeFear.isUp){
      storyParts.push('希望恐懼「'+_d(hopeFear)+'」：內心深處的恐懼在影響判斷');
      negSignals+=1;
    }

    // ★ Step 3：因果區（4過去+6近期未來）— 看時間線
    if(nearFut.isUp){
      storyParts.push('近期走向「'+_d(nearFut)+'」：'+_m(nearFut));
      posSignals+=1;
    } else {
      storyParts.push('近期走向「'+_d(nearFut)+'」：'+_m(nearFut));
      negSignals+=1;
    }

    // ★ Step 4：現實區（7自身+8環境）— 評估戰力
    const selfReady=self.isUp;
    const environSupport=environ.isUp;
    if(selfReady&&environSupport){
      storyParts.push('自身狀態＋環境都支持行動');
      posSignals+=2;
    } else if(!selfReady&&!environSupport){
      storyParts.push('自身狀態低迷，外在環境也不配合');
      negSignals+=2;
    } else if(selfReady&&!environSupport){
      storyParts.push('你準備好了，但外在環境有阻力');
    } else {
      storyParts.push('環境有利，但你自身狀態需要調整');
    }

    // ★ Step 5：結果（10）— 在不改變路線下的結局
    if(outcome.isUp){
      storyParts.push('最終結果「'+_d(outcome)+'」：'+_m(outcome));
      posSignals+=2;
    } else {
      storyParts.push('最終結果「'+_d(outcome)+'」：'+_m(outcome)+'（但結果可被前面調整）');
      negSignals+=2;
    }

    // ★ 牌組元素分析（看人生主戰場在哪）
    const suitCount={major:0,wands:0,cups:0,swords:0,pent:0};
    d.slice(0,10).forEach(function(c){
      if(c.id<=21) suitCount.major++;
      else if(c.id<=35) suitCount.wands++;
      else if(c.id<=49) suitCount.cups++;
      else if(c.id<=63) suitCount.swords++;
      else suitCount.pent++;
    });
    let suitNote='';
    const maxSuit=Object.entries(suitCount).sort(function(a,b){return b[1]-a[1];})[0];
    if(maxSuit[1]>=4){
      const suitLabel={major:'大牌多＝命運級事件',wands:'權杖多＝行動/事業是主軸',cups:'聖杯多＝情感面是關鍵',swords:'寶劍多＝壓力/思慮/糾結',pent:'錢幣多＝現實/財務面'};
      suitNote=suitLabel[maxSuit[0]]||'';
    }

    // ★ 綜合判斷
    if(posSignals>=negSignals+3) dir='pos';
    else if(negSignals>=posSignals+3) dir='neg';
    else if(posSignals>negSignals) dir='pos';
    else if(negSignals>posSignals) dir='neg';
    else dir='mid';

    // 建構 verdict 和 reason
    if(dir==='pos'){
      verdict='塔羅整體偏正面';
      reason='核心「'+_d(core)+'」'+(_m(core).substring(0,15))+'，結果「'+_d(outcome)+'」走向正面';
    } else if(dir==='neg'){
      verdict='塔羅整體有壓力';
      reason='核心「'+_d(core)+'」'+(_m(core).substring(0,15))+'，結果「'+_d(outcome)+'」需要留意';
    } else {
      verdict='塔羅訊號矛盾';
      reason='核心「'+_d(core)+'」與結果「'+_d(outcome)+'」方向不完全一致';
    }

    // 補充關鍵洞察
    if(innerConflict) reason+='。內在有矛盾（想要的和真正需要的不同）';
    if(!selfReady) reason+='。自身狀態「'+_d(self)+'」需要調整';
    if(suitNote) reason+='。'+suitNote;

    // 完整故事存到 detail
    const detail=storyParts.join('｜');
    V.push({dim:'塔羅', dir, score:0, verdict, reason, detail});
  })();

  // ── 維度4: 紫微斗數（完整實戰系統：命身+格局+四化+煞星+模組）──
  (function ziweiVerdict(){
    if(!S.ziwei) return;
    let dir='mid', verdict='', reason='';
    const zw=S.ziwei, palaces=zw.palaces;
    if(!palaces||!palaces.length) return;

    let posS=0, negS=0;
    const parts=[];

    // ═══ Step 1: 命宮＋身宮 ═══
    const ming=palaces[0];
    const mingMajors=ming?ming.stars.filter(function(s){return s.type==='major';}):[];
    const mingNames=mingMajors.map(function(s){return s.name;});
    const shenIdx=zw.shenIdx;
    const shenGong=shenIdx!==undefined?palaces.find(function(p){return p.isShen;}):null;
    const shenName=shenIdx!==undefined?ZW_PALACES[shenIdx]:'';
    if(mingNames.length){
      parts.push('命宮主星：'+mingNames.join('、'));
    }
    if(shenName&&shenName!=='命宮'){
      parts.push('身宮在「'+shenName+'」→ 後天努力方向');
    }

    // ═══ Step 2: 主星性格模組 ═══
    let starType='';
    if(mingNames.some(function(n){return n==='紫微'||n==='天府';})) starType='領導統御型';
    else if(mingNames.some(function(n){return n==='天機'||n==='天相';})) starType='智謀輔佐型';
    else if(mingNames.some(function(n){return n==='七殺'||n==='破軍'||n==='貪狼';})) starType='開創衝鋒型';
    else if(mingNames.some(function(n){return n==='太陽'||n==='太陰';})) starType='人際情感型';
    else if(mingNames.some(function(n){return n==='巨門';})) starType='口才分析型';
    else if(mingNames.some(function(n){return n==='武曲';})) starType='財務行動型';
    else if(mingNames.some(function(n){return n==='天同';})) starType='安逸享福型';
    else if(mingNames.some(function(n){return n==='廉貞';})) starType='複雜多面型';
    else if(mingNames.some(function(n){return n==='天梁';})) starType='清高化解型';

    // ═══ Step 3: 對應宮位分析（按問題類型）═══
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
    const gIdx=typeToGong[type]||0;
    const targetGong=palaces[gIdx];
    const targetName=ZW_PALACES[gIdx]||'命宮';
    if(targetGong){
      const tMajors=targetGong.stars.filter(function(s){return s.type==='major';});
      const tMinors=targetGong.stars.filter(function(s){return s.type==='minor';});
      const tNames=tMajors.map(function(s){return s.name;});
      // 主星亮度
      const brightStars=tMajors.filter(function(s){return s.bright==='廟'||s.bright==='旺';});
      const darkStars=tMajors.filter(function(s){return s.bright==='落陷'||s.bright==='不得';});
      if(brightStars.length){posS+=2; parts.push(targetName+'宮有'+brightStars.map(function(s){return s.name+'('+s.bright+')';}).join('、')+'，先天條件好');}
      else if(darkStars.length){negS+=2; parts.push(targetName+'宮'+darkStars.map(function(s){return s.name+'('+s.bright+')';}).join('、')+'，先天條件弱');}
      else if(tNames.length){parts.push(targetName+'宮有'+tNames.join('、'));}
      else{negS+=1; parts.push(targetName+'宮空宮，起伏較大');}

      // 煞星檢查
      var shaInGong=targetGong.stars.filter(function(s){return ZW_SHA.includes(s.name)||s.name==='地劫'||s.name==='地空';});
      if(shaInGong.length>=2){negS+=2; parts.push(targetName+'宮煞星重（'+shaInGong.map(function(s){return s.name;}).join('、')+'），壓力大');}
      else if(shaInGong.length===1){negS+=1; parts.push(targetName+'宮有'+shaInGong[0].name+'，有一定阻力');}

      // 吉星檢查
      var luckyInGong=targetGong.stars.filter(function(s){return ZW_LUCKY.includes(s.name);});
      if(luckyInGong.length>=2){posS+=1; parts.push('有'+luckyInGong.map(function(s){return s.name;}).join('、')+'輔助');}

      // 四化在對應宮位
      var huaInGong=targetGong.stars.filter(function(s){return s.hua;});
      huaInGong.forEach(function(s){
        if(s.hua==='化祿'){posS+=2; parts.push(s.name+'化祿入'+targetName+'→ 此方面有資源福氣');}
        else if(s.hua==='化權'){posS+=1; parts.push(s.name+'化權入'+targetName+'→ 有掌控力');}
        else if(s.hua==='化科'){posS+=1; parts.push(s.name+'化科入'+targetName+'→ 貴人名聲');}
        else if(s.hua==='化忌'){negS+=2; parts.push(s.name+'化忌入'+targetName+'→ 此方面是痛點');}
      });
    }

    // ═══ Step 4: 福德宮（心理能量）═══
    if(type==='love'||type==='health'||type==='general'){
      var fuDe=palaces[10]; // 福德宮 index=10
      if(fuDe){
        var fuMajors=fuDe.stars.filter(function(s){return s.type==='major';});
        var fuSha=fuDe.stars.filter(function(s){return ZW_SHA.includes(s.name)||s.name==='地劫'||s.name==='地空';});
        if(fuSha.length>=2){negS+=1; parts.push('福德宮煞重→心理壓力大，容易內耗');}
        var fuJi=fuDe.stars.filter(function(s){return s.hua==='化忌';});
        if(fuJi.length){negS+=1; parts.push('福德宮有化忌→內心糾結是主要困擾');}
      }
    }

    // ═══ Step 5: 大限走勢 ═══
    var dx=zw.daXian?zw.daXian.find(function(d){return d.isCurrent;}):null;
    if(dx){
      if(/大吉|中吉/.test(dx.level)){posS+=2; parts.push('當前大限（'+dx.level+'）走勢有利');}
      else if(/偏弱|低迷|凶/.test(dx.level)){negS+=2; parts.push('當前大限（'+dx.level+'）走勢偏弱');}
      else if(/小吉/.test(dx.level)){posS+=1; parts.push('當前大限（'+dx.level+'）走勢尚可');}
      else{parts.push('當前大限走勢中性（'+dx.level+'）');}
      if(dx.theme) parts.push('大限主題：'+dx.theme);

      // 大限四化
      if(dx.siHua&&dx.siHua.length){
        dx.siHua.forEach(function(h){
          // 四化入對應宮位=直接影響
          var targetPalaceName=ZW_PALACES[gIdx]||'';
          if(h.palace===targetPalaceName){
            if(h.hua==='化祿'){posS+=2; parts.push('大限'+h.star+'化祿入'+targetPalaceName+'→ 此方面大限有利');}
            else if(h.hua==='化忌'){negS+=2; parts.push('大限'+h.star+'化忌入'+targetPalaceName+'→ 此方面大限有壓力');}
            else if(h.hua==='化權'){posS+=1; parts.push('大限'+h.star+'化權入'+targetPalaceName);}
          }
        });
      }
    }

    // ═══ Step 6: 流年影響 ═══
    if(dx&&dx.liuNian){
      var thisYear=new Date().getFullYear();
      var ln=dx.liuNian.find(function(y){return y.year===thisYear;});
      if(ln){
        if(ln.score>=2){posS+=1; parts.push(thisYear+'流年走勢好（'+ln.level+'）');}
        else if(ln.score<=-2){negS+=1; parts.push(thisYear+'流年走勢差（'+ln.level+'）');}
      }
    }

    // ═══ 類型專用模組分析 ═══
    if(type==='career'){
      // 看官祿(8)+遷移(6)+命(0)
      var guanLu=palaces[8], qianYi=palaces[6];
      if(guanLu){
        var guanJi=guanLu.stars.filter(function(s){return s.hua==='化忌';});
        if(guanJi.length){negS+=1; parts.push('官祿宮有化忌→工作上有雷點');}
      }
      if(qianYi){
        var qianLu=qianYi.stars.filter(function(s){return s.hua==='化祿';});
        if(qianLu.length){posS+=1; parts.push('遷移宮有化祿→外出發展有利');}
      }
      // 殺破狼在命或官 → 創業型
      if(mingNames.some(function(n){return n==='七殺'||n==='破軍'||n==='貪狼';})){
        parts.push('命宮殺破狼系→適合開創、不適合穩定上班');
      }
    } else if(type==='wealth'){
      // 看財帛(4)+田宅(9)
      var tianZhai=palaces[9];
      if(tianZhai){
        var tzLu=tianZhai.stars.filter(function(s){return s.hua==='化祿';});
        if(tzLu.length){posS+=1; parts.push('田宅宮有化祿→有不動產或被動收入的機會');}
        var tzJi=tianZhai.stars.filter(function(s){return s.hua==='化忌';});
        if(tzJi.length){negS+=1; parts.push('田宅宮有化忌→財庫有漏洞');}
      }
    } else if(type==='love'){
      // 看夫妻(2)+福德(10)
      var fuQi=palaces[2];
      if(fuQi){
        var fqSha=fuQi.stars.filter(function(s){return ZW_SHA.includes(s.name);});
        if(fqSha.length>=2){negS+=1; parts.push('夫妻宮煞重→感情路比較坎坷');}
        var fqMajors=fuQi.stars.filter(function(s){return s.type==='major';});
        if(fqMajors.some(function(s){return s.name==='破軍';})){
          parts.push('夫妻宮有破軍→感情大起大落');
          var fqJi=fuQi.stars.filter(function(s){return s.hua==='化忌';});
          if(fqJi.length){negS+=2; parts.push('破軍化忌入夫妻→分離機率較高');}
        }
      }
    }

    // ═══ 綜合判斷 ═══
    if(posS>=negS+3) dir='pos';
    else if(negS>=posS+3) dir='neg';
    else if(posS>negS) dir='pos';
    else if(negS>posS) dir='neg';
    else dir='mid';

    reason=parts.join('。');
    verdict=dir==='pos'?'紫微走勢偏吉':dir==='neg'?'紫微走勢偏凶':'紫微走勢中性';
    if(starType) verdict+='（'+starType+'）';
    V.push({dim:'紫微', dir, score:0, verdict, reason, detail:starType?'主星模組：'+starType:''});
  })();

  // ── ♈ 西洋星盤維度判斷 ──
  (function natalVerdict(){
    if(!S.natal) return;
    const np=S.natal.planets;
    const goodA=S.natal.aspects.filter(a=>a.good).length;
    const badA=S.natal.aspects.filter(a=>!a.good).length;
    const _HN={1:'自我',2:'財富',3:'溝通',4:'家庭',5:'戀愛',6:'健康',7:'伴侶',8:'轉化',9:'遠行',10:'事業',11:'人脈',12:'靈性'};
    let nScore=0, reason='';
    
    if(type==='love'||type==='relationship'){
      const venH=np['金星'].house, moonH=np['月亮'].house;
      if([5,7,1,11].includes(venH)){nScore+=2;reason+=`金星在${_HN[venH]}宮利桃花；`;}
      else if([12,8,6].includes(venH)){nScore-=1;reason+=`金星在${_HN[venH]}宮感情較複雜；`;}
      if([5,7,4].includes(moonH)) nScore+=1;
      const h7Sign=ZODIAC_NAMES[Math.floor(S.natal.houses[6]/30)%12];
      reason+=`伴侶宮${h7Sign}座；`;
    } else if(type==='career'){
      const sunH=np['太陽'].house, satH=np['土星'].house, jupH=np['木星'].house;
      if([10,6,1].includes(sunH)){nScore+=2;reason+=`太陽在${_HN[sunH]}宮事業發光；`;}
      if(satH===10){nScore+=1;reason+=`土星在事業宮終有大成；`;}else if([6,8,12].includes(satH)){nScore-=1;}
      if([10,2,11].includes(jupH)){nScore+=1;reason+=`木星在${_HN[jupH]}宮有擴展；`;}
      reason+=`天頂${S.natal.mcSign.name}座；`;
    } else if(type==='wealth'){
      if([2,8,11].includes(np['木星'].house)){nScore+=2;reason+=`木星在${_HN[np['木星'].house]}宮財運佳；`;}
      if([2,8].includes(np['金星'].house)){nScore+=1;reason+=`金星在${_HN[np['金星'].house]}宮吸財；`;}
    } else if(type==='health'){
      if(np['火星'].house===6){nScore-=2;reason+=`火星在健康宮注意炎症；`;}
      if(np['土星'].house===6){nScore-=1;reason+=`土星在健康宮慢性問題；`;}
      if([1,5].includes(np['太陽'].house)) nScore+=1;
    } else {
      if(goodA>badA+2) nScore+=2;
      else if(badA>goodA+2) nScore-=2;
    }
    if(goodA>badA) nScore+=1; else if(badA>goodA) nScore-=1;
    
    const dir=nScore>=2?'pos':nScore<=-1?'neg':'mid';
    let verdict='';
    if(dir==='pos') verdict='星盤能量正面，行星位置有利';
    else if(dir==='neg') verdict='星盤有挑戰相位，需多留意';
    else verdict='星盤能量中性，吉凶均衡';
    reason+=`吉相位${goodA}個、凶相位${badA}個`;
    V.push({dim:'星盤', dir, score:0, verdict, reason, detail:`${S.natal.summary}`});
  })();

  // ══════════════════════════════════════════
  // ★ 交叉辯證：比對各維度結論的一致性與矛盾
  // ══════════════════════════════════════════
  const posVerdicts=V.filter(v=>v.dir==='pos');
  // ★ 存到全域 S 供其他函數共用（避免 generateHook 重複判斷造成矛盾）
  S._verdicts=V;
  S._verdictDir=posVerdicts.length>V.filter(v=>v.dir==='neg').length?'pos':V.filter(v=>v.dir==='neg').length>posVerdicts.length?'neg':'mid';
  const negVerdicts=V.filter(v=>v.dir==='neg');
  const midVerdicts=V.filter(v=>v.dir==='mid');
  const totalDims=V.length;
  const typeLabel2={'love':'感情','career':'事業','wealth':'財運','health':'健康','general':'整體','relationship':'人際','family':'家庭'}[type]||'這件事';

  let narrative='';

  if(totalDims===0){
    narrative='目前資料不足，無法做完整判斷。';
  } else {
    // ═══ 故事性敘述：完全人話，不出現任何命理術語 ═══
    const overallDir=posVerdicts.length>negVerdicts.length?'pos':negVerdicts.length>posVerdicts.length?'neg':'mid';
    const allPos=posVerdicts.length===totalDims;
    const allNeg=negVerdicts.length===totalDims;
    const hasConflict=posVerdicts.length>0&&negVerdicts.length>0;

    const baziV=V.find(v=>v.dim==='八字');
    const mhV=V.find(v=>v.dim==='梅花');
    const trV=V.find(v=>v.dim==='塔羅');
    const zwV2=V.find(v=>v.dim==='紫微');
    const natV=V.find(v=>v.dim==='星盤');

    // ═══ 問題意圖偵測：是非題先給結論 ═══
    const _q=S.form?S.form.question:'';
    const isYesNo=/可以嗎|能嗎|會嗎|好嗎|行嗎|對嗎|值得嗎|適合嗎|應該嗎|要嗎|有機會嗎|有希望嗎|來得及嗎|趕得上嗎|做得到嗎|撐得住嗎|破.*嗎|中.*嗎|上.*嗎|過.*嗎|贏.*嗎|成.*嗎|賺.*嗎|升.*嗎|考.*上|錄取|會不會|能不能|該不該|要不要|是不是|有沒有/.test(_q);
    const isHowTo=/怎麼|如何|怎樣|該怎|方法|建議|策略|什麼方向|哪個|要注意/.test(_q);
    const isWhen=/什麼時候|幾月|何時|多久|哪天|哪個月/.test(_q);

    let directAnswer='';
    if(isYesNo){
      // 先直接回答是/否/有難度
      if(allPos) directAnswer='可以，條件和時機都到位了。';
      else if(allNeg) directAnswer='坦白說，目前有難度。';
      else if(overallDir==='pos') directAnswer='有機會，但需要你主動爭取。';
      else if(overallDir==='neg') directAnswer='短期內有難度，但不是完全沒機會。';
      else if(hasConflict) directAnswer='有機會，但阻力也不小——要看你怎麼做。';
      else directAnswer='五五波，成敗取決於你接下來的行動。';
    } else if(isWhen){
      if(allPos||overallDir==='pos') directAnswer='時機正在成熟中，最近一兩個月會比較明朗。';
      else if(allNeg) directAnswer='短期內比較困難，至少需要再等兩三個月以上。';
      else directAnswer='目前還不是最佳時機，耐心等待訊號會更清楚。';
    }

    // 紫微主星模組（翻譯成性格特質）
    const starT=zwV2&&zwV2.detail&&zwV2.detail.includes('主星模組')?zwV2.detail.replace('主星模組：',''):'';
    const starTrait={
      '領導統御型':'你天生適合帶團隊、做決策，有領袖氣質',
      '智謀輔佐型':'你擅長分析規劃，適合當幕後軍師或顧問',
      '開創衝鋒型':'你不安於現狀，適合開創新事業、闖新路',
      '人際情感型':'你的人脈和社交能力是最大資產',
      '口才分析型':'你的溝通和說服力很強，適合需要表達的領域',
      '財務行動型':'你對數字敏感、執行力強',
      '安逸享福型':'你人緣好但容易安逸，需要適度的壓力推動',
      '複雜多面型':'你興趣廣泛、適應力強，適合多元化發展',
      '清高化解型':'你有化解困難的天賦，遇到危機反而越冷靜'
    }[starT]||'';

    // 各維度的「人話翻譯」
    const baziGood=baziV&&baziV.dir==='pos';
    const baziBad=baziV&&baziV.dir==='neg';
    const mhGood=mhV&&mhV.dir==='pos';
    const mhBad=mhV&&mhV.dir==='neg';
    const trGood=trV&&trV.dir==='pos';
    const trBad=trV&&trV.dir==='neg';
    const zwGood=zwV2&&zwV2.dir==='pos';
    const zwBad=zwV2&&zwV2.dir==='neg';

    // 時機判斷（人話）
    let timingWord='';
    if(zwGood&&mhGood) timingWord='現在是好時機';
    else if(zwBad&&mhBad) timingWord='現在時機不太對';
    else if(zwGood&&mhBad) timingWord='長期走勢不錯但短期有卡關';
    else if(zwBad&&mhGood) timingWord='短期有個窗口但長期要再觀察';
    else timingWord='時機中等';

    // 能力判斷（人話）
    let abilityWord='';
    if(baziGood) abilityWord='你的底子不差，有實力撐得住';
    else if(baziBad) abilityWord='先天條件普通，需要靠後天努力補';
    else abilityWord='你的條件中等';

    // 心態判斷（人話）
    let mindWord='';
    if(trGood) mindWord='你目前的心態和狀態是對的';
    else if(trBad) mindWord='你內心可能還有猶豫或拉扯';
    else mindWord='';

    // ═══ 按問題類型生成故事 ═══
    if(type==='career'){
      narrative='';
      if(directAnswer) narrative+=directAnswer+' ';
      if(starTrait) narrative+=starTrait+'。';
      narrative+=abilityWord+'。';
      narrative+=timingWord+'——';

      if(allPos){
        narrative+='各方面條件都到位了。如果你一直在等一個「對的時間」，就是現在。方向對了就全力以赴，猶豫才是最大的成本。';
      } else if(allNeg){
        narrative+='老實說現在不是衝的時候。不是你能力不行，而是外在環境和內在狀態都還沒到最佳位置。先蓄力、先學習、先把基本功打好，等風來你才接得住。';
      } else if(hasConflict){
        if(baziGood&&mhBad) narrative+='你的實力夠，但短期的環境不太配合。方向是對的，但步調可以放慢一點。';
        else if(baziBad&&zwGood) narrative+='你的走勢在往上，雖然底子普通但後天的努力正在累積。繼續走，不要停。';
        else if(trBad) narrative+='你的條件還行，但你自己心裡還沒定下來。先把內心的拉扯處理好，想清楚自己到底要什麼，再行動。';
        else narrative+='有些條件到位了，有些還差一點。不需要全部完美才動，但需要有策略——分階段來，每一步都留退路。';
      } else {
        narrative+='條件中等，沒有特別大的助力也沒什麼地雷。成敗取決於你自己的行動力和決心。';
      }
      if(mindWord&&!narrative.includes('心裡')) narrative+=' '+mindWord+'。';

    } else if(type==='wealth'){
      narrative='';
      if(directAnswer) narrative+=directAnswer+' ';
      narrative+=abilityWord+'。';
      narrative+=timingWord+'。';

      if(allPos){
        narrative+='財路目前是通的，把握機會但記住一個原則：賺到該收就收，不貪才能留住。';
      } else if(allNeg){
        narrative+='目前不適合大額投資或冒險理財。守住現有的資產，減少不必要的支出。市場不好的時候，不虧就是賺。';
      } else if(hasConflict){
        if(baziGood&&mhBad) narrative+='你有賺錢的能力，但短期市場或機會不太配合。錢會來，但不是現在。';
        else if(baziBad&&mhGood) narrative+='當下有個短暫的機會窗口，但別投太大。小試一下可以，梭哈不行。';
        else narrative+='財運一般，穩健型理財比追高殺低靠譜得多。';
      } else {
        narrative+='財運不算特別旺也不差。穩健理財、定期儲蓄，比衝動投資靠譜。';
      }

    } else if(type==='love'){
      narrative='';
      if(directAnswer) narrative+=directAnswer+' ';
      if(starTrait) narrative+=starTrait+'，這也影響你的感情模式。';
      narrative+=timingWord+'。';

      if(allPos){
        narrative+='感情的條件和時機都在。別再等了——主動一點，讓對的人看到你。好的感情不是等來的，是你準備好了才遇得到。';
      } else if(allNeg){
        narrative+='感情方面目前確實有壓力，不急。可能是你自己還沒準備好，也可能是遇到的人都不對。先把自己的狀態調整好，對的人會在對的時間出現。';
      } else if(hasConflict){
        if(trBad) narrative+='你的心裡可能還有矛盾——嘴上說想要穩定，但潛意識裡還在抗拒。先問問自己到底想要什麼。';
        else if(baziGood&&mhBad) narrative+='你的條件不差，但現在的時機差了一點。不需要刻意追求，保持開放心態就好。';
        else narrative+='感情順其自然就好。不需要為了「有人陪」而將就，但也不要把門關上。';
      } else {
        narrative+='感情是順其自然的事。不需要刻意追求，但也不要把門關上。保持開放心態，好的會自己來。';
      }
      if(mindWord&&!narrative.includes('心裡')&&!narrative.includes('矛盾')) narrative+=' '+mindWord+'。';

    } else if(type==='health'){
      narrative='';
      if(directAnswer) narrative+=directAnswer+' ';
      narrative+=abilityWord.replace('底子','體質').replace('實力','底子')+'。';

      if(overallDir==='pos'){
        narrative+='健康底子不差，保持現有作息和運動習慣就好。不需要太焦慮，但定期體檢是基本功。';
      } else if(overallDir==='neg'){
        narrative+='身體方面需要特別注意。不要忽視任何異常信號——小毛病拖成大問題才是最虧的。定期做健康檢查，心理壓力也別忽視，找到釋放壓力的方式。';
      } else {
        narrative+='健康狀況中等，沒大問題但也不能放鬆。規律作息、適度運動、少熬夜——老話但真的有用。';
      }

    } else {
      // general / relationship / family
      narrative='';
      if(directAnswer) narrative+=directAnswer+' ';
      if(starTrait) narrative+=starTrait+'。';
      narrative+=abilityWord+'。';
      narrative+=timingWord+'。';

      if(allPos) narrative+='整體走勢不錯，現在是可以積極行動的時期。想做什麼就做，別再拖了。';
      else if(allNeg) narrative+='目前各方面的阻力偏大，急不來。穩住節奏，等條件成熟再出手。退一步不是認輸，是為了更好的進攻。';
      else if(hasConflict) narrative+='有些面向是好的，有些卡住了。不需要等到所有條件完美才行動，但要有計劃，一步一步來。';
      else narrative+='運勢不上不下。這種時候最考驗的是你自己——機會不會從天上掉，要自己去找。';
    }

    // 清理
    narrative=narrative.replace(/。{2,}/g,'。').replace(/^。/,'').trim();
    if(narrative&&!narrative.endsWith('。')&&!narrative.endsWith('！')) narrative+='。';
  }

  // 紫微主星個性化收尾（只用人話）
  const zwV=V.find(v=>v.dim==='紫微');
  if(zwV&&zwV.verdict){
    const starMatch=zwV.verdict.match(/（(.+?)）/);
    if(starMatch){
      const starClose={'領導統御型':'你天生適合帶隊，重點是找對方向','智謀輔佐型':'你適合當軍師，找到值得輔佐的人是關鍵','開創衝鋒型':'你最怕一成不變，適合開創新路','人際情感型':'你的人脈是最大資產','口才分析型':'你的思辨能力強，適合需要溝通說服的工作','財務行動型':'你對錢有直覺，適合跟數字打交道','安逸享福型':'你享福的命但不能太安逸，需要適度的壓力推動','複雜多面型':'你的個性複雜，適合多元化發展','清高化解型':'你有化解危機的天賦，逢凶化吉的底子不錯'}[starMatch[1]];
      if(starClose&&!narrative.includes(starClose.substring(0,6))) narrative+=' '+starClose+'。';
    }
  }

  // ── 維度判斷摘要（展示用）──
  const verdictSummaryHtml=V.map(v=>{
    const icon=v.dir==='pos'?'🟢':v.dir==='neg'?'🔴':'🟡';
    return `<p style="margin:0.2rem 0;font-size:.88rem">${icon} <strong>${v.dim}</strong>：${v.verdict} — ${v.reason}</p>`;
  }).join('');
  
  // 智慧選擇：answer 有針對性回應時優先用 answer，否則用 narrative（多維辯證）
  const _q2=S.form?S.form.question:'';
  // answer 裡有具體內容的標記：包含 HTML 標籤、具體建議、號碼等
  const _answerHasContent = answer && (
    answer.includes('<strong>') ||        // 有粗體回應（代表有針對性文案）
    answer.includes('lottery-') ||         // 樂透號碼
    answer.includes('號碼組') ||
    answer.length > 200                    // 長度夠長代表有實質內容
  );
  // narrative 太通用的標記：包含這些萬用句代表沒有針對性
  const _narrativeIsGeneric = narrative && (
    /感情是順其自然|順其自然就好|保持開放心態/.test(narrative) &&
    /分手|外遇|出軌|劈腿|冷戰|吵架|離婚|挽回|復合|背叛|不愛|離開|被騙/.test(_q2)
  );
  const _useAnswer = _answerHasContent || _narrativeIsGeneric;
  let html='<p style="font-size:1.05rem;line-height:1.8">'+(_useAnswer?answer:narrative)+'</p>';
  // ── 各維度獨立判斷摘要 ──
  if(V.length>=2){
    html+='<details style="margin-top:0.6rem"><summary style="cursor:pointer;color:var(--c-gold,#d4af37);font-size:0.85rem;font-weight:600">🔍 深度解讀：各維度獨立判斷（'+V.length+'個維度）</summary>';
    html+='<div style="padding:0.6rem 0.8rem;margin-top:0.3rem;background:rgba(212,175,55,0.04);border-left:3px solid rgba(212,175,55,0.3);border-radius:0 6px 6px 0;font-size:0.88rem;line-height:1.7">';
    html+=verdictSummaryHtml;
    html+='</div></details>';
  }
  if(detail) html+='<div style="line-height:1.7;margin-top:.5rem">'+detail+'</div>';

  // ── 命理佐證（收合，進階使用者看）──
  const keyEvi=[];
  const eviPriority=[
    /大限/,/流年/,/本卦/,/變卦/,/互卦/,/動爻/,/體用/,/梅花針對/,
    /結果牌/,/阻礙/,/核心牌/,/牌陣整體/,
    /紫微.*化祿/,/紫微.*化忌/,/紫微.*宮/,
    /姓名犧牲/,/姓名巳亥/,/姓名生肖/
  ];
  eviPriority.forEach(pat=>{
    if(keyEvi.length>=5) return;
    evidence.forEach(e=>{
      if(keyEvi.length>=5) return;
      if(pat.test(e)&&!keyEvi.includes(e)) keyEvi.push(e);
    });
  });
  if(keyEvi.length<3){
    evidence.forEach(e=>{
      if(keyEvi.length>=3) return;
      if(!keyEvi.includes(e)) keyEvi.push(e);
    });
  }

  if(keyEvi.length){
    html+='<details style="margin-top:0.6rem"><summary style="cursor:pointer;color:var(--c-gold,#d4af37);font-size:0.82rem">📌 命理佐證（'+keyEvi.length+'項）</summary>';
    html+='<div style="padding:0.5rem 0.8rem;margin-top:0.3rem;background:rgba(212,175,55,0.05);border-left:3px solid rgba(212,175,55,0.3);border-radius:0 6px 6px 0;font-size:0.85rem;line-height:1.6;color:var(--c-text-dim,#bbb)">';
    keyEvi.forEach(e=>{html+='<p style="margin:0.15rem 0">• '+e+'</p>';});
    html+='</div></details>';
  }

  if(tip) html+='<p style="margin-top:0.5rem">💡 '+tip+'</p>';
  html+='<details style="margin-top:0.5rem"><summary style="cursor:pointer;color:var(--c-text-dim,#999);font-size:0.78rem">📊 完整判斷依據（'+evidence.length+'項）</summary>';
  html+='<div style="padding:0.5rem;margin-top:0.3rem;background:rgba(255,255,255,0.03);border-radius:6px;font-size:0.8rem;line-height:1.5;color:var(--c-dim,#999)">';
  evidence.forEach(d=>{html+='<p style="margin:0.15rem 0">• '+d+'</p>';});
  if(tarot&&tarot.drawn&&tarot.drawn.length>=10){const c=tarot.drawn[0],r=tarot.drawn[9];html+='<p style="margin:0.15rem 0">• 核心牌「'+c.n+'」'+(c.isUp?'正':'逆')+'位。結果牌「'+r.n+'」'+(r.isUp?'正':'逆')+'位。</p>';}
  html+='</div></details>';
  return html;
}

/* ═══════════════════════════════════════════════════════════
   刺點生成器 — 第一句話要夠有力，讓使用者停住
   策略：找到最強/最弱的主導指標 → 寫一句尖銳人話 → 帶出情境行動
   ═══════════════════════════════════════════════════════════ */
/* ═══ 紫微斗數六大項目固定五段輸出（四化飛星 SOP v2）═══
   四層：本命 → 大限 → 流年 → 事件落點
   三方四正 + 四化計分 + 化忌落宮事件描述
   ═══════════════════════════════════════════════════ */
function generateZiweiStory(type, zw){
  if(!zw||!zw.palaces||!zw.palaces.length) return '';
  const ps=zw.palaces;
  const label={love:'感情',career:'事業',wealth:'財運',health:'健康',family:'家庭',relationship:'人際'}[type]||'整體';

  // ── 主題宮 + 三方四正 ──
  // 宮位 index: 0命 1兄弟 2夫妻 3子女 4財帛 5疾厄 6遷移 7交友 8官祿 9田宅 10福德 11父母
  const mainGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0}[type]||0;
  // 對宮 = (mainGong+6)%12
  const duiGong=(mainGong+6)%12;
  // 三合 = (mainGong+4)%12 和 (mainGong+8)%12
  const sanHeA=(mainGong+4)%12, sanHeB=(mainGong+8)%12;
  const focus=[mainGong,duiGong,sanHeA,sanHeB];
  const focusNames=focus.map(i=>(typeof ZW_PALACES!=='undefined'?ZW_PALACES[i]:'宮'+i));

  // ── 四化計分（本命 + 流年 + 大限）──
  let score=0;
  const reasons=[];
  const SHA_NAMES=['擎羊','陀羅','火星','鈴星','地空','地劫','天刑'];
  const LUCKY_NAMES=['左輔','右弼','天魁','天鉞','文昌','文曲','祿存'];

  // Step 2: 本命底盤
  const mainP=ps[mainGong];
  const mainMajors=mainP?mainP.stars.filter(s=>s.type==='major'):[];
  const mainBright=mainMajors.filter(s=>s.bright==='廟'||s.bright==='旺');
  const mainDark=mainMajors.filter(s=>s.bright==='落陷'||s.bright==='不得');
  let natalDesc='';
  if(mainBright.length){score+=2;natalDesc=label+'先天條件不錯';}
  else if(mainDark.length){score-=2;natalDesc=label+'先天條件偏弱，需後天補強';}
  else if(!mainMajors.length){score-=1;natalDesc=label+'宮空宮，起伏較大';}
  else{natalDesc=label+'先天條件中等';}

  // 本命四化入主題宮系（三方四正）
  focus.forEach(fi=>{
    const p=ps[fi];if(!p)return;
    p.stars.forEach(s=>{
      if(s.hua==='化祿'){score+=2;}
      else if(s.hua==='化權'){score+=1;}
      else if(s.hua==='化科'){score+=1;}
      else if(s.hua==='化忌'){score-=3;}
    });
    // 煞吉
    const sha=p.stars.filter(s=>SHA_NAMES.includes(s.name));
    const lucky=p.stars.filter(s=>LUCKY_NAMES.includes(s.name));
    score-=sha.length;
    score+=lucky.length;
  });

  // Step 3: 大限
  const dx=zw.daXian?zw.daXian.find(d=>d.isCurrent):null;
  let dxDesc='';
  if(dx){
    if(/大吉|中吉/.test(dx.level)){score+=2;dxDesc='這十年走勢有利';}
    else if(/偏弱|低迷|凶/.test(dx.level)){score-=2;dxDesc='這十年走勢偏弱';}
    else if(/小吉/.test(dx.level)){score+=1;dxDesc='這十年走勢尚可';}
    else{dxDesc='這十年走勢中性';}

    // 大限四化入主題宮系
    if(dx.siHua){
      dx.siHua.forEach(h=>{
        const pIdx=ps.findIndex(p=>p&&p.name===h.palace);
        if(focus.includes(pIdx)){
          if(h.hua==='化祿'){score+=2;reasons.push('大限化祿入'+label+'宮系 → 此方面大限有利');}
          else if(h.hua==='化忌'){score-=3;reasons.push('大限化忌入'+label+'宮系 → 此方面大限有壓力');}
          else if(h.hua==='化權'){score+=1;}
          else if(h.hua==='化科'){score+=1;}
        }
      });
    }
  }

  // Step 4: 流年
  const thisYear=new Date().getFullYear();
  let lnDesc='', lnJiEvent='';
  if(dx&&dx.liuNian){
    const ln=dx.liuNian.find(y=>y.year===thisYear);
    if(ln){
      if(ln.score>=2){score+=1;lnDesc=thisYear+'年走勢好';}
      else if(ln.score<=-2){score-=1;lnDesc=thisYear+'年走勢差';}
      else{lnDesc=thisYear+'年走勢中性';}

      // 流年四化入主題宮系
      if(ln.siHua){
        ln.siHua.forEach(h=>{
          const pIdx=ps.findIndex(p=>p&&p.name===h.palace);
          if(focus.includes(pIdx)){
            if(h.hua==='化祿'){score+=2;reasons.push('今年化祿入'+label+'方向 → 有機會');}
            else if(h.hua==='化忌'){score-=3;reasons.push('今年化忌入'+label+'方向 → 有壓力點');}
            else if(h.hua==='化權'){score+=1;}
          }
          // 化忌落宮事件描述
          if(h.hua==='化忌'){
            const jiEvents={
              '夫妻':'關係卡住、承諾壓力、感情反覆',
              '官祿':'工作卡關、升遷受阻、責任暴增',
              '財帛':'財務壓力、開銷破洞、投資失誤',
              '疾厄':'身體警訊、作息失衡、舊疾反覆',
              '交友':'人際消耗、小人、合作翻臉',
              '田宅':'家庭壓力、住居問題、長輩議題',
              '父母':'長輩關係緊張、文書問題',
              '命宮':'自我壓力大、方向迷茫',
              '子女':'親子壓力、創作瓶頸',
              '福德':'內心焦慮、睡眠問題',
              '遷移':'外出不順、環境變動',
              '兄弟':'手足/朋友消耗'
            };
            const pName=h.palace?h.palace.replace('宮',''):'';
            if(jiEvents[pName]) lnJiEvent='今年化忌落'+h.palace+'→ '+jiEvents[pName];
          }
        });
      }
    }
  }

  // ═══ 計分分級 ═══
  // ★ 用五系統投票結果校正
  const _vDir3=S._verdictDir||'mid';
  if(_vDir3==='pos'&&score<0) score=1;
  else if(_vDir3==='neg'&&score>0) score=-1;
  let conclusion='';
  if(score>=3) conclusion='偏順（可推進）';
  else if(score<=-3) conclusion='偏逆（先避雷）';
  else conclusion='中性（看策略）';

  // ═══ 組裝原因 ═══
  if(!reasons.length){
    reasons.push(natalDesc);
    if(dxDesc) reasons.push('十年大限：'+dxDesc);
    if(lnDesc) reasons.push('流年：'+lnDesc);
  } else {
    reasons.unshift(natalDesc);
  }

  // ═══ 事件描述 ═══
  let eventDesc=lnJiEvent||'今年此方面沒有特別的化忌衝擊';

  // ═══ 策略建議 ═══
  let strategies=[];
  // 找化忌 → 怎麼解
  const hasJi=reasons.some(r=>r.includes('化忌'));
  const hasLu=reasons.some(r=>r.includes('化祿'));
  if(hasJi){
    strategies.push('化忌代表必修課，不能逃避，面對處理反而能轉化');
    strategies.push('找化科的方向（貴人、學習、專業）來化解壓力');
  }
  if(hasLu){
    strategies.push('化祿代表機會已到，主動爭取才能接住');
  }
  if(score>=3) strategies.push('趁勢推進，不要等');
  else if(score<=-3) strategies.push('先守後攻，不要硬衝');
  else strategies.push('觀察局勢，分階段推進');
  if(strategies.length<3) strategies.push('把能量放在你能控制的事上');

  // ═══ 時間窗（簡化：用大限+流年推估）═══
  let timeWindow='';
  if(dx){
    const dxEnd=dx.ageEnd||0;
    const dxStart=dx.ageStart||0;
    timeWindow='目前在'+dxStart+'~'+dxEnd+'歲大限';
    if(dx.theme) timeWindow+='（主題：'+dx.theme+'）';
  }
  if(lnDesc) timeWindow+=(timeWindow?'；':'')+lnDesc;

  // ═══ 組裝固定五段輸出 ═══
  let s='<strong>結論：'+conclusion+'</strong>';
  s+='<br><br>📌 <strong>主因：</strong>';
  reasons.slice(0,3).forEach(r=>{if(r)s+='<br>• '+r;});
  s+='<br><br>⚡ <strong>事件走向：</strong>'+eventDesc;
  s+='<br><br>🎯 <strong>策略：</strong>';
  strategies.slice(0,3).forEach(a=>{s+='<br>• '+a;});
  if(timeWindow) s+='<br><br>📅 <strong>時間窗：</strong>'+timeWindow;
  return s;
}

/* ═══ 姓名學六大項目固定五段輸出（五格三才 SOP v2）═══
   主格/輔格權重 + 81數理 + 三才五行互動 + 日因子
   ═══════════════════════════════════════════════════ */
function generateNameStory(type, bazi){
  const nr=S.nameResult;
  if(!nr) return '';

  // ── 五格數值 ──
  const tg=nr.tianGe, rg=nr.renGe, dg=nr.diGe, wg=nr.waiGe, zg=nr.zongGe;
  const sc=nr.sanCai||[], scLv=nr.sanCaiLevel||'平';

  // ── 三才計分 ──
  function wxRel(a,b){
    const S_MAP={木:'火',火:'土',土:'金',金:'水',水:'木'};
    if(a===b) return 1;
    if(S_MAP[a]===b) return 2; // a生b
    if(S_MAP[b]===a) return 2; // b生a
    return -2; // 相剋
  }
  let scScore=0;
  if(sc.length===3){
    scScore+=wxRel(sc[0],sc[1]); // 天生人
    scScore+=wxRel(sc[1],sc[2]); // 人生地
  }

  // ── 81數理吉凶分 ──
  function geScore(g){
    if(!g||!g.fortune) return 0;
    return g.fortune.level==='大吉'?3:g.fortune.level==='吉'?1:-2;
  }

  // ── 六大項目權重 ──
  const weights={
    love:{rg:0.45,wg:0.35,dg:0.20,tg:0,zg:0},
    career:{rg:0.45,zg:0.35,tg:0.10,wg:0,dg:0},
    wealth:{zg:0.45,rg:0.35,dg:0.20,tg:0,wg:0},
    health:{dg:0.45,rg:0.35,zg:0.20,tg:0,wg:0},
    relationship:{wg:0.45,rg:0.35,zg:0.20,tg:0,dg:0},
    family:{dg:0.45,zg:0.35,rg:0.20,tg:0,wg:0}
  };
  const w=weights[type]||{rg:0.3,zg:0.3,dg:0.2,wg:0.1,tg:0.1};

  const topicScore=
    w.rg*geScore(rg) + w.wg*geScore(wg) + w.dg*geScore(dg) +
    w.tg*geScore(tg) + w.zg*geScore(zg) + scScore*0.2;

  // ── 主格/輔格描述 ──
  const label={love:'感情',career:'事業',wealth:'財運',health:'健康',family:'家庭',relationship:'人際'}[type]||'整體';
  const mainGe={
    love:[{n:'人格',g:rg},{n:'外格',g:wg}],
    career:[{n:'人格',g:rg},{n:'總格',g:zg}],
    wealth:[{n:'總格',g:zg},{n:'人格',g:rg}],
    health:[{n:'地格',g:dg},{n:'人格',g:rg}],
    relationship:[{n:'外格',g:wg},{n:'人格',g:rg}],
    family:[{n:'地格',g:dg},{n:'總格',g:zg}]
  }[type]||[{n:'人格',g:rg},{n:'總格',g:zg}];

  // ── 結論 ──
  let conclusion='';
  if(topicScore>=2) conclusion='姓名格局偏順';
  else if(topicScore<=-2) conclusion='姓名格局偏弱，需後天補強';
  else conclusion='姓名格局中性';

  // ── 原因 ──
  const reasons=[];
  mainGe.forEach(mg=>{
    if(mg.g&&mg.g.fortune){
      const lv=mg.g.fortune.level;
      reasons.push(mg.n+' '+mg.g.num+'畫（'+mg.g.el+'・'+lv+'）'+(lv==='凶'?'→ 此格需注意':''));
    }
  });
  reasons.push('三才 '+sc.join('→')+' '+scLv+(scLv==='凶'?'（天人地相剋）':''));

  // ── 風險點 ──
  const risks=[];
  [{n:'天格',g:tg},{n:'人格',g:rg},{n:'地格',g:dg},{n:'外格',g:wg},{n:'總格',g:zg}].forEach(item=>{
    if(item.g&&item.g.fortune&&item.g.fortune.level==='凶') risks.push(item.n+item.g.num+'畫為凶數');
  });
  if(scLv==='凶') risks.push('三才相剋');
  let riskDesc=risks.length?risks.join('、'):'無明顯風險格';

  // ── 策略（行為導向，不建議改名）──
  let strategies=[];
  if(type==='love'){
    if(wg&&wg.fortune&&wg.fortune.level==='凶') strategies.push('外格偏弱=外緣需主動經營，不能等');
    else strategies.push('外格尚可，社交機會不缺');
    strategies.push(rg&&rg.fortune&&rg.fortune.level!=='凶'?'人格條件不差，重點在溝通方式':'人格偏弱，練習表達比等對象更重要');
    strategies.push('三才'+(scScore>=2?'相生，順勢而為':'有壓力，主動調整互動模式'));
  } else if(type==='career'){
    strategies.push(rg&&rg.fortune&&rg.fortune.level!=='凶'?'人格格局支持行動力，適合推進':'人格偏弱，先穩住再求進');
    strategies.push(zg&&zg.fortune&&zg.fortune.level!=='凶'?'總格偏吉，長期走向正面':'總格偏弱，需要階段性調整策略');
    strategies.push('把精力放在能力提升，而非等待機會');
  } else if(type==='wealth'){
    strategies.push(zg&&zg.fortune&&zg.fortune.level!=='凶'?'總格=財庫格局不差':'總格偏弱=財庫需要主動建立');
    strategies.push(rg&&rg.fortune&&rg.fortune.level!=='凶'?'守財能力可以':'容易衝動消費，設定自動儲蓄');
    strategies.push('不要靠偏財翻身，穩健累積更適合你');
  } else if(type==='health'){
    strategies.push(dg&&dg.fortune&&dg.fortune.level!=='凶'?'地格=體質基礎尚可':'地格偏弱=體質需要刻意保養');
    strategies.push('壓力管理比養生食品更重要');
    strategies.push('定期健檢，不要拖');
  } else if(type==='relationship'){
    strategies.push(wg&&wg.fortune&&wg.fortune.level!=='凶'?'外格=對外關係條件不差':'外格偏弱=容易遇到消耗型的人');
    strategies.push('學會設定界線比廣結善緣更重要');
    strategies.push('選合作對象看他的行為，不看他的嘴');
  } else if(type==='family'){
    strategies.push(dg&&dg.fortune&&dg.fortune.level!=='凶'?'地格=家庭基礎穩定':'地格偏弱=家庭關係需要刻意經營');
    strategies.push('先處理情緒，再處理事情');
    strategies.push('家庭問題沒有贏家，只有平衡');
  } else {
    strategies.push('發揮人格優勢');
    strategies.push('注意凶數格位的風險');
    strategies.push('行為改善比改名更實際');
  }

  // ═══ 組裝固定五段輸出 ═══
  let s='<strong>結論：'+conclusion+'</strong>';
  s+='<br><br>📌 <strong>主因：</strong>';
  reasons.forEach(r=>{s+='<br>• '+r;});
  s+='<br><br>⚠ <strong>風險點：</strong>'+riskDesc;
  s+='<br><br>🎯 <strong>策略：</strong>';
  strategies.slice(0,3).forEach(a=>{s+='<br>• '+a;});
  return s;
}

/* ═══ 八字六大項目固定五段輸出（子平 SOP v2）═══
   Pipeline: 日主強弱 → 格局用忌 → 十神主題模組 → 合沖刑害觸發 → 時間層
   ═══════════════════════════════════════════════════ */
function generateBaziStory(type, bazi){
  if(!bazi||!bazi.dm) return '';
  const dm=bazi.dm, el=bazi.dmEl, strong=bazi.strong;
  const ep=bazi.ep||{};
  const fav=bazi.fav||[], unfav=bazi.unfav||[];
  const favEl=fav[0]||'', unfavEl=unfav[0]||'';
  const pillars=bazi.pillars||{};
  const label={love:'感情',career:'事業',wealth:'財運',health:'健康',family:'家庭',relationship:'人際'}[type]||'整體';

  // ── Step 2: 日主強弱 ──
  const strengthDesc=strong?'身強，扛得住壓力，適合主動出擊':'身弱，需要借力使力，不宜硬拼';

  // ── Step 3: 十神分析 ──
  // 配偶星/財星/官殺/食傷/印/比劫 能量
  const caiEl=typeof KE!=='undefined'?KE[el]:'';
  const guanEl=typeof KE!=='undefined'?Object.keys(KE).find(k=>KE[k]===el)||'':'';
  const yinEl=typeof BE_SHENG!=='undefined'?BE_SHENG[el]:'';
  const shiEl=typeof SHENG!=='undefined'?SHENG[el]:'';
  const biEl=el;

  const caiStr=caiEl&&ep[caiEl]?ep[caiEl]:0;
  const guanStr=guanEl&&ep[guanEl]?ep[guanEl]:0;
  const yinStr=yinEl&&ep[yinEl]?ep[yinEl]:0;
  const shiStr=shiEl&&ep[shiEl]?ep[shiEl]:0;
  const biStr=biEl&&ep[biEl]?ep[biEl]:0;

  // 盤面主導力量
  const godStrengths=[
    {god:'財星',el:caiEl,str:caiStr},
    {god:'官殺',el:guanEl,str:guanStr},
    {god:'印星',el:yinEl,str:yinStr},
    {god:'食傷',el:shiEl,str:shiStr},
    {god:'比劫',el:biEl,str:biStr}
  ].sort((a,b)=>b.str-a.str);
  const dominant=godStrengths[0];

  // ── Step 4: 合沖刑害觸發器（簡化版）──
  const CHONG_MAP={子:'午',丑:'未',寅:'申',卯:'酉',辰:'戌',巳:'亥',午:'子',未:'丑',申:'寅',酉:'卯',戌:'辰',亥:'巳'};
  let interactions=[];
  const dayZhi=pillars.day?pillars.day.zhi:'';

  // ── Step 5: 大運流年 ──
  const curDy=bazi.dayun?bazi.dayun.find(d=>d.isCurrent):null;
  const thisYear=new Date().getFullYear();
  let lnData=null;
  if(curDy&&curDy.liuNian) lnData=curDy.liuNian.find(l=>l.year===thisYear);

  // 大運十神
  let dyGod='', dyEffect='';
  if(curDy&&curDy.gz){
    const dyG=curDy.gz[0];
    if(dyG&&typeof tenGod==='function'){
      dyGod=tenGod(dm,dyG);
      if(fav.includes(typeof WX_G!=='undefined'?WX_G[dyG]:'')) dyEffect='大運走喜用，外在助力充足';
      else if(unfav.includes(typeof WX_G!=='undefined'?WX_G[dyG]:'')) dyEffect='大運走忌神，外在壓力較大';
      else dyEffect='大運走勢中性';
    }
  }

  // 流年十神+沖
  let lnGod='', lnEffect='', lnChong='';
  if(lnData&&lnData.gz){
    const lnG=lnData.gz[0], lnZ=lnData.gz[1];
    if(lnG&&typeof tenGod==='function') lnGod=tenGod(dm,lnG);
    if(lnZ&&dayZhi&&CHONG_MAP[lnZ]===dayZhi){
      lnChong='流年地支沖日支（夫妻宮）';
      interactions.push(lnChong);
    }
    if(lnData.score>1) lnEffect='流年偏吉';
    else if(lnData.score<-1) lnEffect='流年偏凶';
    else lnEffect='流年中性';
  }

  // ═══ 計分 ═══
  let score=0;
  // 基底
  if(strong) score+=1; else score-=1;
  // 喜忌神能量
  if(favEl&&ep[favEl]>20) score+=2;
  if(unfavEl&&ep[unfavEl]>25) score-=2;
  // 大運
  if(dyEffect.includes('喜用')) score+=2;
  else if(dyEffect.includes('忌神')) score-=2;
  // 流年
  if(lnData){
    if(lnData.score>1) score+=1;
    else if(lnData.score<-1) score-=1;
  }

  // ═══ 六大項目專用模組 ═══
  // ★ 用五系統投票結果(_vDir)校正結論方向，避免八字跟整體矛盾
  const _vDir2=S._verdictDir||'mid';
  if(_vDir2==='pos'&&score<0) score=1; // 整體偏吉但八字偏凶 → 拉到中性偏吉
  else if(_vDir2==='neg'&&score>0) score=-1; // 整體偏凶但八字偏吉 → 拉到中性偏凶
  let conclusion='', reasons=[], eventDesc='', actions=[], timeWindow='';

  if(type==='love'){
    const isMale=S.form&&S.form.gender==='M';
    const spouseGod=isMale?'財星':'官殺';
    const spouseStr=isMale?caiStr:guanStr;
    const spouseIsFav=isMale?fav.includes(caiEl):fav.includes(guanEl);

    if(spouseStr>15&&spouseIsFav) score+=2;
    else if(spouseStr<10) score-=1;

    conclusion=score>=2?'感情運偏順':score<=-2?'感情運偏逆，需調整':'感情運中性，看策略';
    reasons=[
      strengthDesc,
      spouseGod+'（'+(!isMale?'官殺':'財星')+'）能量'+spouseStr+'%'+(spouseStr>15?'，條件不差':'，偏弱需經營'),
      lnChong?'⚠ '+lnChong+'→ 今年感情容易有變動':'今年沒有明顯沖動夫妻宮'
    ];
    eventDesc=lnGod?'今年流年十神「'+lnGod+'」到位'+(lnGod.includes('財')||lnGod.includes('官')?'，感情事件機率較高':''):'';
    actions=[
      strong?'你適合主動出擊':'你適合被動等待、讓對方來靠近',
      spouseIsFav?'配偶星為喜用，遇到的人大機率是好的':'配偶星為忌，容易遇到壓力型對象，要慎選',
      bazi.shensha&&bazi.shensha.includes('桃花')?'命帶桃花，社交場合多露面':'多參加新的社交圈，不要一直待在舒適區'
    ];

  } else if(type==='career'){
    const guanIsFav=fav.includes(guanEl);
    if(guanIsFav&&guanStr>15) score+=1;
    if(shiStr>20) score+=1; // 食傷旺=技術能力強

    conclusion=score>=2?'事業運偏順':score<=-2?'事業運偏逆，建議觀望':'事業運中性，需策略';
    reasons=[
      strengthDesc,
      '官殺能量'+guanStr+'%'+(guanIsFav?'（為喜用，制度對你有利）':'（為忌神，職場壓力較大）'),
      '食傷能量'+shiStr+'%'+(shiStr>20?'→ 技術/輸出能力強，適合靠專業走':'→ 偏弱，需補強專業能力')
    ];
    eventDesc=dyGod?'大運走「'+dyGod+'」'+(dyGod.includes('官')?'→ 升遷/責任變動的週期':dyGod.includes('財')?'→ 業績/收入有機會':''):'';
    actions=[
      guanIsFav?'制度型路線適合你（考證、升遷、體系內）':'靠技術/自由度走，不要硬拼體制',
      shiStr>20?'多展現成果，你的技術是籌碼':'補強一項核心技能',
      strong?'可以扛責任，爭取更大的舞台':'不要硬撐，找合作夥伴分擔'
    ];

  } else if(type==='wealth'){
    const caiIsFav=fav.includes(caiEl);
    if(caiIsFav&&caiStr>15) score+=2;
    if(biStr>25) score-=1; // 比劫旺=守不住

    conclusion=score>=2?'財運偏順':score<=-2?'財運偏逆，守財為主':'財運中性';
    reasons=[
      strengthDesc+(strong?'，扛得住財':'，大財扛不動'),
      '財星能量'+caiStr+'%'+(caiIsFav?'（為喜用，正財有利）':'（為忌神，財反而是壓力）'),
      biStr>25?'比劫偏旺（'+biStr+'%），容易進得快出得也快':'比劫不過旺，守財能力尚可'
    ];
    eventDesc=lnGod&&(lnGod.includes('財'))?'今年流年帶「'+lnGod+'」→ 財務事件機率高':'今年財務波動不大';
    actions=[
      caiIsFav?'正財路線適合你，穩健累積':'偏財機會要謹慎，不要追快錢',
      biStr>25?'設定自動儲蓄，防止衝動消費':'理財紀律保持就好',
      strong?'可以適度投資，但設停損':'保守為主，不要借錢投資'
    ];

  } else if(type==='health'){
    const weakEl=Object.entries(ep).sort((a,b)=>a[1]-b[1])[0];
    const strongEl=Object.entries(ep).sort((a,b)=>b[1]-a[1])[0];
    const organMap={木:'肝膽/神經',火:'心臟/血液/眼睛',土:'脾胃/消化',金:'肺/皮膚/呼吸',水:'腎/泌尿/內分泌'};

    conclusion=score>=2?'身心狀態尚好':score<=-2?'需注意健康':'健康中性';
    reasons=[
      strengthDesc+(strong?'，基礎體質不差':'，體質偏敏感'),
      weakEl?weakEl[0]+'行偏弱（'+weakEl[1]+'%），注意'+(organMap[weakEl[0]]||''):'五行相對均衡',
      unfavEl?'忌神'+unfavEl+'行偏旺（'+ep[unfavEl]+'%），'+unfavEl+'相關系統容易出狀況':'忌神不算太旺'
    ];
    eventDesc=dyEffect+(lnEffect?'，'+lnEffect:'');
    actions=[
      '規律作息是基本功',
      weakEl?'注意'+(organMap[weakEl[0]]||weakEl[0])+'方面的保養':'維持現有生活節奏',
      '若持續不適請就醫'
    ];

  } else if(type==='relationship'){
    const biIsFav=fav.includes(biEl);

    conclusion=score>=2?'人際運偏順':score<=-2?'人際有壓力':'人際中性';
    reasons=[
      '比劫能量'+biStr+'%'+(biStr>25?'→ 合作容易變競爭':'→ 人際關係不至於太衝突'),
      guanStr>15?'官殺有力→ 適合制度化合作':'官殺偏弱→ 合作要自己設規則',
      yinStr>15?'印星有力→ 有貴人緣':'印星偏弱→ 貴人少，靠自己多'
    ];
    eventDesc=lnGod?'今年流年「'+lnGod+'」'+(lnGod.includes('比')||lnGod.includes('劫')?'→ 同儕互動頻繁，注意競爭':''):'';
    actions=[
      biStr>25?'合作前先談分配，不然一定翻':'人際互動還算平順',
      '選合作對象看行為，不看嘴',
      '重要合作加書面條款'
    ];

  } else if(type==='family'){
    // 年柱=長輩, 月柱=家庭運作, 日柱=自身, 時柱=子女
    const shiIsFav=fav.includes(shiEl);

    conclusion=score>=2?'家庭運偏順':score<=-2?'家庭有壓力':'家庭運中性';
    reasons=[
      shiStr>15?'食傷能量'+shiStr+'%'+(shiIsFav?'，親子互動正面':'，容易跟家人有口舌'):'食傷偏弱，親子互動需要主動經營',
      guanStr>20?'官殺偏旺→ 家庭責任感重，但也容易壓力大':'家庭責任感適中',
      lnChong?'⚠ '+lnChong+'→ 今年家庭關係容易有波動':'今年沒有明顯沖動家庭宮位'
    ];
    eventDesc=dyGod?'大運走「'+dyGod+'」'+(dyGod.includes('印')?'→ 長輩/母親方面有事件':dyGod.includes('食')||dyGod.includes('傷')?'→ 子女/表達方面有事件':''):'';
    actions=[
      '先處理情緒，再處理事情',
      shiIsFav?'跟家人的互動是正向的，多溝通':'溝通方式要調整，不要說教',
      '一次處理一件事，不要翻舊帳'
    ];

  } else {
    conclusion=score>=2?'整體偏順':score<=-2?'整體偏逆':'整體中性';
    reasons=[strengthDesc,'主導力量：'+dominant.god+'（'+dominant.str+'%）',dyEffect||'大運走勢待觀察'];
    eventDesc=lnEffect||'';
    actions=['發揮優勢','注意忌神方向的風險','保持彈性'];
  }

  // ── 時間窗 ──
  if(curDy){
    timeWindow='大運'+curDy.gz+'（'+(curDy.ageStart||'?')+'~'+(curDy.ageEnd||'?')+'歲）';
    if(curDy.level) timeWindow+='（'+curDy.level+'）';
  }
  if(lnData) timeWindow+=(timeWindow?'；':'')+thisYear+'流年'+lnData.gz+(lnData.level?'（'+lnData.level+'）':'');

  // ═══ 組裝固定五段輸出 ═══
  let s='<strong>結論：'+conclusion+'</strong>';
  s+='<br><br>📌 <strong>核心原因：</strong>';
  reasons.forEach(r=>{if(r)s+='<br>• '+r;});
  if(eventDesc) s+='<br><br>⚡ <strong>事件走向：</strong>'+eventDesc;
  s+='<br><br>🎯 <strong>你可控的動作：</strong>';
  actions.forEach(a=>{if(a)s+='<br>• '+a;});
  if(timeWindow) s+='<br><br>📅 <strong>時間窗：</strong>'+timeWindow;
  return s;
}

// ═══ 星盤故事生成（純人話，不出現術語）═══
function generateNatalStory(type, natal){
  if(!natal) return '';
  const p=natal.planets;
  const HN={1:'自我',2:'財富',3:'溝通',4:'家庭',5:'戀愛',6:'健康',7:'伴侶',8:'轉化',9:'遠行',10:'事業',11:'人脈',12:'靈性'};
  const goodA=natal.aspects.filter(a=>a.good).length;
  const badA=natal.aspects.filter(a=>!a.good).length;
  const aspTone=goodA>badA+2?'星盤吉相位較多，能量正面':badA>goodA+2?'星盤挑戰相位偏多，需更多努力':'星盤吉凶均衡';
  
  let s='🌟 <strong>星盤</strong>：';
  
  if(type==='love'||type==='relationship'){
    s+=`你的感情模式帶有${p['金星'].sign}特質`;
    if([5,7].includes(p['金星'].house)) s+='，異性緣旺，容易吸引對象';
    else if(p['金星'].house===11) s+='，朋友圈或社交場合容易遇到對象';
    else if([12,8].includes(p['金星'].house)) s+='，感情傾向深沉私密';
    else s+='，感情態度穩定';
    const h7Sign=ZODIAC_NAMES[Math.floor(natal.houses[6]/30)%12];
    s+=`。你傾向被${h7Sign}特質的人吸引。${aspTone}。`;
  } else if(type==='career'){
    s+=`天頂${natal.mcSign.name}座，適合${natal.mcSign.name}特質的職業。`;
    if([10,6,1].includes(p['太陽'].house)) s+=`太陽在${HN[p['太陽'].house]}宮位，事業是你的舞台`;
    else s+=`事業有自己的節奏`;
    s+=`。木星在${HN[p['木星'].house]}領域帶來好運。${aspTone}。`;
  } else if(type==='wealth'){
    s+=`木星在${p['木星'].sign}（${HN[p['木星'].house]}領域）`;
    if([2,8,11].includes(p['木星'].house)) s+='，天生有財運天賦';
    else s+='，財富需主動尋找';
    if([2,8].includes(p['金星'].house)) s+=`。金星在${HN[p['金星'].house]}領域有吸財體質`;
    s+=`。${aspTone}。`;
  } else if(type==='health'){
    if(p['火星'].house===6) s+='火星在健康宮位，注意過勞和炎症';
    else if(p['土星'].house===6) s+='土星在健康宮位，慢性問題需留意';
    else s+='無明顯凶星入健康宮位';
    s+=`。${aspTone}。`;
  } else {
    s+=`太陽${p['太陽'].sign}，上升${natal.ascSign.name}。${aspTone}。`;
  }
  return s;
}

function generateHook(type,prob,bazi,mh,tarot,ziwei){
  const dm=bazi.dm,el=bazi.dmEl,strong=bazi.strong;
  const ep=bazi.ep||{};
  const fav=(bazi.fav||[]),unfav=(bazi.unfav||[]);
  const mainFav=fav[0]||'',mainUnfav=unfav[0]||'';
  const curDy=bazi.dayun?bazi.dayun.find(d=>d.isCurrent):null;
  const question=S.form?S.form.question:'';
  const intent=parseQuestionIntent(question,type);

  // ══════════════════════════════════════════
  // ★ 動態命理數據（每次都重新計算）
  // ══════════════════════════════════════════

  // ① 八字：當日干支 × 命盤 → 真實今日運勢
  let realFortune=null;
  try{ realFortune=computeRealFortune(bazi); }catch(e){}
  const todayGod=realFortune?realFortune.god:'';       // 今日天干對日主的十神
  const todayCS=realFortune?realFortune.csState:'';     // 日主在今日地支的長生狀態
  const todayGZ=realFortune?realFortune.todayGZ:'';     // 今日干支
  const todayEl=realFortune?realFortune.todayEl:'';     // 今日五行
  const todayChong=realFortune&&realFortune.detail?realFortune.detail.chong:null; // 沖日支?
  const todayHe=realFortune&&realFortune.detail?realFortune.detail.he:null;       // 合日支?
  const todayFavHit=realFortune&&realFortune.detail?realFortune.detail.favHit:''; // 喜忌命中

  // ② 八字：當前流年事象
  let curLN=null;
  if(curDy&&curDy.liuNian){
    const thisYear=new Date().getFullYear();
    curLN=curDy.liuNian.find(ln=>ln.year===thisYear);
  }
  const lnGod=curLN?curLN.god:'';       // 流年天干對日主的十神
  const lnLevel=curLN?curLN.level:'';    // 流年吉凶
  const lnEvents=curLN?curLN.events:[];  // 流年事象（如「正財年有穩定收入」）
  const lnNotes=curLN?curLN.notes:[];    // 流年互動（沖合等）
  const lnClash=curLN?curLN.clash:[];    // 流年沖的宮位
  const lnAffect=curLN?curLN.affect:[];  // 流年影響的生活面

  // ③ 紫微：流年命宮 + 四化飛入
  let zwLN=null, zwDx=null;
  if(ziwei&&ziwei.getLiuNianZw){
    try{
      const thisYear=new Date().getFullYear();
      zwLN=ziwei.getLiuNianZw(thisYear);
    }catch(e){}
  }
  if(ziwei&&ziwei.daXian){
    zwDx=ziwei.daXian.find(d=>d.isCurrent);
  }
  const zwLnPalace=zwLN?zwLN.mingPalace:'';  // 紫微流年命宮走哪宮
  const zwLnFocus=zwLN?zwLN.focus:'';         // 流年重點方向
  const zwLnHua=zwLN?zwLN.hua:[];             // 流年四化
  const zwDxPalace=zwDx?zwDx.palaceName:'';   // 大限走哪宮

  // ── 命理象徵口語化 ──
  const EL_BODY={'金':'肺與呼吸系統','木':'肝與筋骨','水':'腎與泌尿','火':'心與血管','土':'脾胃與消化'};
  const EL_TRAIT={'金':'果斷但容易固執','木':'有衝勁但容易急躁','水':'聰明但想太多','火':'熱情但缺耐心','土':'穩重但太保守'};
  const EL_LOVE={'金':'對感情要求高，不太妥協','木':'很主動但容易衝','水':'感受力強但容易患得患失','火':'愛得轟轟烈烈但來得快去得也快','土':'重承諾但不太浪漫'};
  const EL_MONEY={'金':'理財能力強但捨不得花','木':'敢投資但容易衝動','水':'對錢敏感但不太行動','火':'賺得快花得也快','土':'穩穩存但錯過機會'};

  // 大運+流年+當日 → 純人話
  let dyMood='';
  if(curDy){
    const lv=curDy.level;
    if(lv.includes('旺盛')||lv.includes('極強')) dyMood='你這十年的大運走勢很好，外在環境對你有利';
    else if(lv.includes('上升')) dyMood='你的運勢正在上升中，越來越順';
    else if(lv.includes('偏弱')||lv.includes('低迷')) dyMood='你目前運勢偏低，做什麼都比較費力';
    else dyMood='你的運勢平穩，不特別好也不差';
  }
  // 疊加流年（人話）
  if(curLN){
    const lnG=/吉|旺|上升/.test(lnLevel), lnB=/凶|弱|低迷/.test(lnLevel);
    if(lnG) dyMood+='，今年運勢偏好';
    else if(lnB) dyMood+='，但今年運勢偏弱';
    // 流年事象（本身就是人話，如「正財年有穩定收入」）
    if(lnEvents.length) dyMood+='，'+lnEvents[0];
    if(lnClash&&lnClash.length) dyMood+='，今年生活有變動';
  }
  // 疊加紫微流年（人話）
  if(zwLnPalace){
    const focusMap={'事業':'事業是今年重點','感情':'感情是今年重點','財運':'財務是今年重點','健康':'健康要特別留意'};
    if(zwLnFocus&&focusMap[zwLnFocus]) dyMood+='。'+focusMap[zwLnFocus];
    const luHua=zwLnHua.find(h=>h.hua==='化祿');
    const jiHua=zwLnHua.find(h=>h.hua==='化忌');
    if(luHua) dyMood+='，今年有好的資源和機會進來';
    if(jiHua) dyMood+='，今年某方面壓力比較大';
  }
  // 疊加當日（人話）
  if(realFortune){
    if(todayCS==='帝旺'||todayCS==='臨官'||todayCS==='長生') dyMood+='。今天精力充沛，適合做重要決定';
    else if(todayCS==='病'||todayCS==='死'||todayCS==='墓'||todayCS==='絕') dyMood+='。今天能量低，重大決定建議改天';
    if(todayChong) dyMood+='。今天跟你的磁場有衝突，做事多留意';
    else if(todayHe) dyMood+='。今天跟你的磁場合拍，適合推進事情';
  }

  // 梅花口語（象徵不是卦名）
  let mhStory='';
  if(mh){
    mhStory = typeof generateMeihuaStory==='function' ? generateMeihuaStory(type, mh) : '';
  }

  let baziStory='';
  if(bazi&&bazi.dm){
    baziStory = typeof generateBaziStory==='function' ? generateBaziStory(type, bazi) : '';
  }

  // ═══════════════════════════════════════════════════════
  // 塔羅解讀 → 純人話（不顯示牌名、不顯示正逆位）
  // ═══════════════════════════════════════════════════════
  let tarotStory='';
  if(tarot&&tarot.drawn&&tarot.drawn.length>=10){
    tarotStory = typeof generateTarotStory==='function' ? generateTarotStory(type, tarot.drawn) : '';
  }

  // 紫微 → 純人話（不顯示宮位名、星名、四化）
  let zwStory='';
  if(ziwei){
    zwStory = typeof generateZiweiStory==='function' ? generateZiweiStory(type, ziwei) : '';
  }

  let nameStory='';
  if(S.nameResult){
    nameStory = typeof generateNameStory==='function' ? generateNameStory(type, bazi) : '';
  }

  // ── 星盤故事 ──
  let natalStory='';
  if(S.natal){
    natalStory = generateNatalStory(type, S.natal);
  }

  // ── 組成故事（六大項 × 細部分支）──
  let story='';
  const q=question; // shorthand
  const pk=bazi.shensha&&bazi.shensha.includes('桃花');
  const hl=bazi.shensha&&bazi.shensha.includes('紅鸞');
  const wc=bazi.shensha&&bazi.shensha.includes('文昌');
  const ym=bazi.shensha&&bazi.shensha.includes('驛馬');
  const gy=bazi.shensha&&bazi.shensha.includes('天乙貴人');
  const caiEl=typeof KE!=='undefined'?KE[el]:'';
  const caiStr=caiEl&&ep[caiEl]?ep[caiEl]:0;
  const inEl=typeof BE_SHENG!=='undefined'?BE_SHENG[el]:'';
  const inStr=inEl&&ep[inEl]?ep[inEl]:0;
  const shiEl=typeof SHENG!=='undefined'?SHENG[el]:'';
  const shiStr=shiEl&&ep[shiEl]?ep[shiEl]:0;
  // ★ 優先使用維度辯證結論（與 generateQAResponse 一致），fallback 才用 prob
  const _vDir=S._verdictDir||'mid';
  const good=_vDir==='pos'||(prob>=60&&_vDir!=='neg'), mid=_vDir==='mid'||(_vDir!=='neg'&&prob>=45), bad=_vDir==='neg'||(prob<45&&_vDir!=='pos');

  // ═══ 是非題偵測：先給直接結論 ═══
  const _isYN=/可以嗎|能嗎|會嗎|好嗎|行嗎|對嗎|值得嗎|適合嗎|應該嗎|要嗎|有機會嗎|有希望嗎|來得及嗎|趕得上嗎|做得到嗎|撐得住嗎|破.*嗎|中.*嗎|上.*嗎|過.*嗎|贏.*嗎|成.*嗎|賺.*嗎|升.*嗎|考.*上|錄取|會不會|能不能|該不該|要不要|是不是|有沒有/.test(q);
  let _ynPrefix='';
  if(_isYN){
    if(good) _ynPrefix='可以。';
    else if(bad) _ynPrefix='坦白說，目前有難度。';
    else _ynPrefix='有機會，但要看你怎麼做。';
  }

  // ═══════════════════════════════════════
  // 💕 感情 LOVE
  // ═══════════════════════════════════════
  if(type==='love'){
    const trait=EL_LOVE[el]||'';
    if(/職場.*桃花|辦公室.*戀|同事.*喜歡|工作.*對象|公司.*桃花|上班.*認識/.test(q)){
      story=pk?'你的異性緣天生不差。':'異性緣沒特別強，但不代表沒機會。';
      story+=good?'職場是你目前最容易遇到對象的場域——日常互動多，感情自然發展。':'職場桃花訊號不算明顯，但不排除有人暗地裡注意你。';
      story+='你在感情裡'+trait+'，'+(strong?'果斷和能力會吸引人，但注意公私分寸。':'親和力是優勢，適度展現自信更有魅力。');
    } else if(/復合|回來|挽回|破鏡重圓|前任.*回/.test(q)){
      story=good?'你們之間的緣分線還沒完全斷，復合有機會。':'目前對方沒有明顯回頭跡象，與其等不如先把能量收回來。';
      story+=intent.isPassive?
        (good?'對方心裡還有你的位置，保持好狀態等時機。':'不要主動追，先讓自己變好，改變會被看見。'):
        (good?'主動聯繫吧，對方接受的機率比你想的高。':'先緩緩，強行挽回反而把人推更遠。');
    } else if(/告白|表白|追|約他|約她|搭訕|怎麼追|主動/.test(q)){
      if(intent.isPassive){
        story=good?'你的魅力'+(pk?'本來就不錯':'正在上升')+'，確實有機會吸引到主動靠近的人。':'目前吸引力不夠強，短期內不太容易等到主動告白。';
      } else {
        story=good?'運勢支持你主動出擊，真誠表達比套路更打動人。':mid?'可以試探，但不要一次押太重，先約吃飯慢慢來。':'先緩緩，現在告白時機不太對。';
      }
    } else if(/桃花|異性緣|有沒有人|有人喜歡|會遇到|單身|脫單|對象|另一半|交往|戀愛|邂逅|感情運|有對象|談戀愛/.test(q)){
      story=pk?'你的異性緣天生就不錯。':'你的異性緣中等，但不代表沒機會。';
      story+=good?'目前異性緣活躍，有遇到新對象的機會。多出門社交。':'異性緣偏弱，需要主動增加社交機會。';
      story+='你在感情裡'+trait+'。';
    } else if(/結婚|嫁|娶|求婚|婚姻/.test(q)){
      story=good?'婚姻能量正在醞釀。'+(hl?'近期特別有利婚嫁。':'時機在成熟中。'):
            mid?'不用急，感情到了自然水到渠成。':'婚事目前條件不完全到位，先把關係經營穩。';
    } else if(/曖昧|模糊|什麼關係|算交往|友達以上/.test(q)){
      story=good?'這段曖昧有發展空間，找好時機把話說清楚。':'這段曖昧可能拖比較久，對方沒明確要交往的意思。';
    } else if(/分手|該不該分|要不要分/.test(q)){
      story=good?'目前關係還有可經營的空間，不急著做決定。':'感情確實在低潮，但低潮不代表要分手，先冷靜想根源。';
    } else if(/冷戰|冷淡|不理|不回|已讀不回|消失|忽冷忽熱|不聯絡|不主動|無視|不讀/.test(q)){
      story=good?'只是暫時的冷淡，給一點空間但別完全消失。':'對方的冷淡可能不只是一時的，先退一步把注意力放回自己。';
    } else if(/吵架|爭吵|溝通不良|講不聽/.test(q)){
      story=good?'問題不大，只是表達方式需要調整。先說「我覺得」而非「你都是」。':'頻繁衝突確實消耗感情，溝通模式出了問題。';
    } else if(/出軌|外遇|劈腿|偷吃|第三者|小三|花心|不忠|背叛/.test(q)){
      story=good?'目前看來關係是忠誠的，不需要疑神疑鬼。':'感情磁場有波動，但不代表一定有外遇，有疑慮就直接溝通。';
    } else if(/喜歡我|愛我|在意我|心裡有我/.test(q)){
      story=good?'從命理看，你是有吸引力的。'+(pk?'你的異性緣本來就好。':'')+'但最終要從互動中確認。':'對方可能還在猶豫，多互動讓對方認識真正的你。';
    } else if(/異地|遠距|不同城市/.test(q)){
      story=good?'異地但感情還在，固定聯繫和明確見面計畫是關鍵。':'距離正在消磨感情，如果沒有結束異地的時間表，要認真討論了。';
    } else if(/見家長|見父母|家人反對|父母不同意/.test(q)){
      story=good?'家庭方面能量正面，禮貌大方做自己就好。':'長輩方面有些阻力，不急著一次搞定，讓對方家人慢慢認識你。';
    } else if(/年紀|年齡|姐弟|忘年/.test(q)){
      story=good?'年齡不是問題，這段關係的核心是契合的。':'年齡差帶來的不只是數字，生活習慣和價值觀可能不同，需要溝通。';
    } else if(/暗戀|單相思|怎麼讓.*注意/.test(q)){
      story=good?'運勢支持你踏出那一步，不需要告白，可以先創造多相處的機會。':'時機還不太成熟，先從朋友做起多互動。';
    } else if(/正緣|對的人|真命|靈魂伴侶|適不適合|合不合|命中注定|天作之合|速配|配不配|適合嗎/.test(q)){
      story=good?'從命盤看契合度不錯，沒有完美的另一半，只有願意一起成長的人。':'你們之間有些磨合點，不代表不適合，但需要雙方都願意調整。';
    } else if(/感情淡|沒感覺|無性|倦怠|沒愛了|老夫老妻|提不起勁|激情|平淡/.test(q)){
      story=good?'感情可以重新點燃，試著安排約會、做以前交往時做的事。':'確實進入瓶頸期，但變淡不一定是不愛了，找時間認真談一次。';
    } else if(/網戀|交友軟體|網路認識|Tinder|配對|線上|dating|交友app/.test(q)){
      story=good?'這段網路緣分有發展空間，但線上跟線下是兩回事，盡快安排見面。':'先保持謹慎，不要太快交心，如果對方一直不見面要提高警覺。';
    } else if(/順利|如何|好嗎|會好|怎麼辦|改善|運勢|狀況|前景|走向|發展/.test(q)){
      // 概括性感情問題
      story='你在感情裡'+trait+'。';
      if(pk||hl) story+='你天生'+(pk?'異性緣好':'')+(hl?'，有婚姻的緣分':'')+'。';
      story+=good?'整體感情運不錯，異性緣活躍，主動出擊會有驚喜。':mid?'感情運平穩，不會有太大波動，好好經營現有關係就好。':'感情運偏弱，這段時間先把自己狀態調好，緣分急不來。';
    } else {
      story='你在感情裡'+trait+'。';
      if(pk||hl) story+='異性緣'+(good?'是你的優勢':'不缺但要慎選')+'。';
      story+=good?'整體感情運不錯，主動出擊會有驚喜。':mid?'感情運平穩，好好經營現有關係。':'感情運偏弱，先把自己狀態調好。';
    }
    if(baziStory) story+='<br><br>'+baziStory;
    if(mhStory) story+=mhStory+'。';
    if(tarotStory) story+='<br><br>'+tarotStory;
    if(zwStory) story+='<br><br>'+zwStory;
    if(natalStory) story+='<br><br>'+natalStory;
    if(nameStory) story+='<br><br>'+nameStory;
    if(dyMood) story+=dyMood+'。';
  }
  // ═══════════════════════════════════════
  // 💼 事業 CAREER
  // ═══════════════════════════════════════
  else if(type==='career'){
    if(/轉職|換工作|離職|跳槽|辭職|換跑道|轉行|換產業|不想做了|想離開/.test(q)){
      // ★ good=事業運好=留下有利
      story=good?'目前事業能量正強，不建議貿然離職。'+(ym?'你適合變動但現在先穩住更好。':'先把好處拿到再考慮。'):mid?'事業運平平，可以開始物色但別急著跳，騎驢找馬。':'目前事業運偏弱，確實是考慮轉換的時機，有機會就準備。';
    } else if(/升遷|升職|加薪|晉升|調薪/.test(q)){
      if(intent.isPassive){
        story=good?'主管心裡有數，你的表現有被看到，好消息會自己來。':mid?'你是候選人之一，但決定權不在你，保持好表現。':'短期內不太樂觀，繼續累積實力。';
      } else {
        story=good?'升遷能量很強，主動爭取別等著被提拔。':mid?'有機會但要自己推一把，適度展現成果。':'今年有難度，先默默累積。';
      }
    } else if(/考試|考上|上榜|考運|證照|國考|研究所/.test(q)){
      story=good?'考運不錯！'+(wc?'你天生考運不錯。':'好好準備機率高。'):mid?'有機會但要拼，最後衝刺是關鍵。':'這次可能有點懸，多給自己一次機會。';
    } else if(/創業|開店|開公司|自己做|做生意|接案|自由業|當老闆|擺攤/.test(q)){
      story=good?'運勢支持創業！如果有準備好的項目，放手去做。':mid?'先試水溫——做副業或小規模測試，確認可行再全力投入。':'現在創業風險太高，先穩穩工作用業餘時間籌備。';
    } else if(/裁員|失業|被開|被辭|資遣/.test(q)){
      story=good?'目前安全，不用太擔心，保持好表現就是最好的保險。':mid?'有一些風險但可控，做好本分跟主管保持好關係。':'確實要有準備，悄悄更新履歷、留幾個備選方案。';
    } else if(/面試|錄取|offer|找工作|求職|履歷|應徵|投履歷|找到工作/.test(q)){
      story=good?'面試運不錯，自信表現就好。'+(gy?'你容易遇到賞識你的人。':''):mid?'有機會但可能不是第一順位，多面幾家不要把雞蛋放同一籃。':'求職目前有挑戰，多投幾家降低期望值。';
    } else if(/人際|同事|主管|老闆|辦公室政治|小人|被排擠|被針對|職場霸凌|豬隊友|壓力大/.test(q)){
      story=good?'職場人際目前還行，'+(gy?'你容易遇到幫你的人。':'保持低調不捲入是非。'):
            '職場人際有些壓力，'+(strong?'你太直接容易得罪人，適度圓滑。':'你太退讓反而被欺負，該爭取的要爭取。');
    } else if(/副業|兼職|斜槓|第二收入|外快|被動收入|下班後/.test(q)){
      story=good?'可以嘗試，'+(shiStr>15?'你的創意和輸出能力強，適合做內容或教學類副業。':'先從低風險的開始。'):
            '先穩住主業，副業可以慢慢規劃不急。';
    } else if(/適合.*工作|什麼方向|職業方向|該做什麼|做什麼好|找方向|出路|前途|未來方向/.test(q)){
      const careerHint={'金':'金融、法律、管理、科技硬體','木':'教育、媒體、設計、農林','水':'物流、旅遊、貿易、諮詢','火':'餐飲、演藝、行銷、公關','土':'建築、房地產、醫療、行政'}[el]||'';
      story='你適合'+careerHint+'方向。';
      if(wc) story+='你在文書、學術方向有天賦。';
      if(ym) story+='你適合需要移動或跨區域的工作。';
      story+='';
    } else if(/讀書|進修|學業|留學|深造/.test(q)){
      story=good?'學業運不錯。'+(wc?'你天生讀書考試有優勢。':'靜下心來效率會很高。'):
            '學業需要加把勁，'+(wc?'你有讀書天賦，但要自律。':'找到適合的讀書方法比硬拼重要。');
    } else if(/順利|如何|好嗎|會好|怎麼辦|改善|運勢|狀況|前景|走向|發展|方向|適合/.test(q)){
      // 概括性事業問題
      story='你的性格'+(EL_TRAIT[el]||'')+'。';
      if(wc) story+='你在讀書考試方面有天賦。';
      if(ym) story+='你適合往外發展，跨區域的機會對你有利。';
      story+=good?'事業運整體不錯，目前是積極爭取的好時機。':mid?'事業運平穩，穩中求進就好。':'事業運偏弱，先守住現有的，等運勢回升再衝刺。';
    } else {
      story='你的性格'+(EL_TRAIT[el]||'')+'。';
      if(wc) story+='你在讀書考試方面有天賦。';
      if(ym) story+='你適合往外發展，跨區域的機會對你有利。';
      story+=good?'事業運整體不錯，把握機會。':mid?'事業平穩，穩中求進。':'事業有些壓力，先守住再說。';
    }
    if(baziStory) story+='<br><br>'+baziStory;
    if(mhStory) story+=mhStory+'。';
    if(tarotStory) story+='<br><br>'+tarotStory;
    if(zwStory) story+='<br><br>'+zwStory;
    if(natalStory) story+='<br><br>'+natalStory;
    if(nameStory) story+='<br><br>'+nameStory;
    if(dyMood&&!story.includes('運勢')) story+=dyMood+'。';
  }
  // ═══════════════════════════════════════
  // 💰 財運 WEALTH
  // ═══════════════════════════════════════
  else if(type==='wealth'){
    const caiStrong=caiStr>15;
    if(/投資|股票|基金|加密|比特幣|虛擬貨幣|ETF|定存|保險|黃金|外幣/.test(q)){
      story=good&&caiStrong?'你的理財直覺好加上運勢佳，可以適度投資，但設好停損。':
            good?'運勢支持穩健投資，但不要梭哈。':
            mid?'投資要保守，只用閒錢，不碰高槓桿。':'現在不適合積極投資，保本為主。';
    } else if(/買房|房地產|置產/.test(q)){
      story=good?'買房時機不差，'+(strong?'你扛得住房貸壓力。':'但要量力而為，別讓房貸壓垮生活品質。'):
            '買房不急，先存夠頭期再說，'+(caiStrong?'你的財運底子不差，耐心等好時機。':'目前財力可能不太夠，再累積一陣子。');
    } else if(/借錢|欠債|還錢|被騙|詐騙|貸款|信貸|周轉|卡費|還不出/.test(q)){
      story='財務方面'+(caiStrong?'財務底子不差，但':'財務本來就吃緊，')+(good?'目前問題可以處理，設好還款計畫慢慢來。':'要特別謹慎，不要再借新還舊。');
      story+='命盤顯示'+({金:'你容易因面子問題花冤枉錢',木:'你容易因衝動消費',水:'你容易被話術影響判斷',火:'你容易一時激動做錯決定',土:'你容易因人情壓力花錢'}[el]||'要注意財務決策')+'。';
    } else if(/加薪|漲薪|調薪|薪水/.test(q)){
      story=good?'加薪能量有，主動跟主管談，用數據說話。':mid?'加薪有機會但不是穩的，先把成果量化。':'短期加薪難度大，可以考慮其他收入來源。';
    } else if(/存錢|儲蓄|理財|怎麼存|改善.*財|財務.*狀況|怎麼理|省錢|節省|月光|存不到/.test(q)){
      story=strong?'你的扛財能力好，適合積極理財。設定自動扣款強迫儲蓄。':'你比較容易財來財去，最重要的是「先存再花」。';
      story+=caiStrong?'你有意外之財的運氣，但不等於穩定收入，穩定收入為主。':'靠紀律存錢比追求高報酬重要。';
    } else if(/中獎|樂透|偏財|橫財|賭|刮刮樂|彩券|彩票|幾號|威力彩|大樂透|運彩|簽牌|明牌/.test(q)){
      // 判斷使用者是問「會不會中」還是「給我號碼」
      const wantsNumbers=/幾號|號碼|選號|哪幾|明牌|簽牌|報牌|給我|推薦.*號/.test(q);
      const asksIfWin=/會中|能中|中獎|中嗎|會不會|能不能|有沒有機會|有機會|手氣|運氣|好不好|好嗎|如何|怎麼樣|順利|旺不旺|強不強/.test(q);
      
      if(asksIfWin && !wantsNumbers){
        // 使用者問「會不會中」→ 先回答，不主動給號碼
        if(good && caiStrong){
          story='你最近的偏財運確實不差，小額試試可以。但樂透這種事，命理能看出運勢高低，不能保證中獎。';
        } else if(good){
          story='運勢還行，但偏財運沒有特別旺。小玩怡情可以，別押太大。';
        } else if(bad){
          story='坦白說，目前偏財運偏弱，不建議花太多錢在這上面。把錢留給確定的事比較實際。';
        } else {
          story='偏財運一般，中獎機率跟大多數人差不多。如果要買，控制預算，別當投資。';
        }
      } else {
        // 使用者要號碼 → 給號碼但加提醒
        story=caiStrong&&good?'你的意外財運確實不差，小額試試手氣可以。':'意外財運一般，小玩怡情就好，別當真。';
        story+=generateLotteryNumbers(bazi, mh, tarot, q)||'';
      }
    } else if(/副業|兼職|斜槓|經營|賣場|網拍|電商|開店|做生意|攤位|擺攤|商店|線上.*賣|賣.*東西|怎麼.*賣|如何.*賣|生意.*怎麼|怎麼.*經營|成長|營收|業績|客源|客人|流量/.test(q)){
      story=strong?'你的精力充沛，經營事業不怕投入。':'建議穩中求進，不要一口氣鋪太大。';
      if(shiStr>15) story+='你的創意和表達能力強，適合做內容行銷、教學分享來吸引客群。';
      else if(caiStrong) story+='你的商業直覺不錯，對市場需求有嗅覺。';
      else story+='經營重點放在「回頭客」和「口碑」而非大量投放。';
      story+=good?'目前運勢支持拓展，可以嘗試新的推廣方式。':mid?'穩步前進就好，不急著大擴張。':'先守住現有客群，把基本面做穩。';
      // 五行對應經營建議
      const bizTip={'金':'重品質和專業形象，走精品路線','木':'重內容和知識分享，靠口碑發酵','水':'重社群和人脈連結，多互動多曝光','火':'重視覺和行銷包裝，快速抓眼球','土':'重信任和服務穩定，老客帶新客'}[el]||'';
      if(bizTip) story+='你的五行屬性適合的經營策略：'+bizTip+'。';
    } else if(/賺錢|開源|增加收入|怎麼賺|增加財富|致富|發財|財運怎麼提升|怎麼.*有錢|收入/.test(q)){
      story=strong?'你精力充沛，適合主動出擊——創業、接案、投資都可以考慮。':'你適合穩定環境賺錢——專注本業加上副業為輔。';
      if(shiStr>15) story+='你的創意和表達力強，適合靠教學、寫作等方式增加收入。';
      story+=good?'目前財運能量活躍，行動就有回報。':'目前財運偏弱，先穩住現金流。';
    } else if(/破財|花錢|漏財|守不住|一直花|錢不夠|缺錢|沒錢|月光族|負債|卡債/.test(q)){
      story='你對財富的態度是'+(EL_MONEY[el]||'')+'。';
      story+=strong?'你扛得住，但要防過度自信導致的大筆支出。':'你比較容易財來財去，養成記帳習慣是第一步。';
      if(mainUnfav) story+='忌神'+mainUnfav+'行的消耗要特別注意。';
    } else if(/順利|如何|好嗎|會好|怎麼辦|改善|運勢|狀況|前景|好轉|什麼時候/.test(q)){
      // 概括性財運問題
      story='你對財富的態度是'+(EL_MONEY[el]||'')+'。';
      story+=caiStr>15?'你有意外之財的底子。':'穩定收入比投機重要。';
      story+=good?'目前財運能量不錯，適合積極理財和爭取收入。':mid?'財運平穩，量入為出就好。':'財運偏弱，保守為上，先穩住再說。';
      if(dyMood) story+=dyMood+'。';
    } else {
      story='你對財富的態度是'+(EL_MONEY[el]||'')+'。'+(strong?'你能扛財，適合主動追求。':'穩健理財對你更重要。');
      if(caiStrong) story+='你的意外財運不錯。';
      else story+='靠正職穩定收入更實在。';
      story+=good?'今年財運整體不錯。':mid?'財運平穩，量入為出。':'財運偏弱，保守為上。';
    }
    if(baziStory) story+='<br><br>'+baziStory;
    if(mhStory) story+=mhStory+'。';
    if(tarotStory) story+='<br><br>'+tarotStory;
    if(zwStory) story+='<br><br>'+zwStory;
    if(natalStory) story+='<br><br>'+natalStory;
    if(nameStory) story+='<br><br>'+nameStory;
    if(dyMood) story+=dyMood+'。';
  }
  // ═══════════════════════════════════════
  // 🏥 健康 HEALTH
  // ═══════════════════════════════════════
  else if(type==='health'){
    const epArr=Object.entries(ep).sort((a,b)=>a[1]-b[1]);
    const lowestEl=epArr.length?epArr[0][0]:'';
    const lowestOrgan=EL_BODY[lowestEl]||'';
    const highestEl=epArr.length?epArr[epArr.length-1][0]:'';
    const healthBase=strong?'體質底子不差，但防過旺引起的發炎上火。':'體質偏虛，免疫力和恢復力是弱項。';

    if(/長輩|父|母|爸|媽|公婆|爺|奶|外公|外婆/.test(q)){
      story='問的是長輩健康——代表長輩的印星能量'+(inStr>15?'還算充足，目前狀況尚可':'偏弱，長輩可能比較辛苦')+'。';
      story+='重點留意'+(lowestOrgan||'整體')+'方面的問題。定期健檢、陪伴就醫比什麼都重要。';
      if(good) story+='目前沒有特別緊急的訊號，但預防勝於治療。';
      else story+='命盤提示要多關注長輩身體，尤其是換季和勞累的時候。';
    } else if(/小孩|兒|女|孩子|寶寶/.test(q)){
      story='從你的體質推導——'+(shiStr>15?'孩子精力充沛但可能過於好動。':'孩子體質可能偏敏感。');
      story+='注意'+(lowestOrgan||'脾胃消化')+'方面。';
    } else if(/失眠|睡不好|睡眠|睡不著|淺眠|多夢|早醒|嗜睡/.test(q)){
      story='失眠通常跟'+({金:'肺氣不降、思慮過重',木:'肝火旺、壓力大',水:'腎虛、精神不安',火:'心火旺、焦慮',土:'脾胃不和、消化影響睡眠'}[el]||'五行失衡')+'有關。';
      story+=mainFav==='水'?'你需要養腎——早睡、泡腳、避免睡前用手機。':mainFav==='木'?'你需要疏肝——睡前伸展、聽輕音樂、少熬夜。':'調整作息規律是第一步。';
    } else if(/焦慮|憂鬱|壓力|情緒|心理|精神|低落|不開心|崩潰|煩|鬱悶|心情差|負能量/.test(q)){
      story='情緒問題跟'+({金:'過度壓抑、不願表達',木:'壓力累積、得不到釋放',水:'想太多、過度內耗',火:'情緒起伏大、容易激動',土:'擔憂過多、安全感不足'}[el]||'五行失衡')+'有關。';
      story+='你的性格'+(EL_TRAIT[el]||'')+'，'+(strong?'能量過剩需要出口——運動、創作、社交都是好的釋放。':'能量不足需要補充——充足睡眠、大自然、減少社群媒體。');
    } else if(/減肥|瘦身|體重|運動|健身|養生|保養|調理|體力|疲勞|累|沒力/.test(q)){
      story=strong?'你的體質適合高強度運動，重訓或HIIT效果好。':'你不適合太激烈的運動，瑜伽、游泳、快走更合適。';
      story+='五行'+(highestEl||'')+'過旺'+(highestEl==='土'?'容易水腫虛胖，少吃甜食多排濕。':highestEl==='水'?'代謝偏慢，多曬太陽多動。':highestEl==='金'?'容易便秘影響代謝，多吃纖維。':'，注意飲食均衡。');
    } else if(/懷孕|備孕|生育|不孕|試管/.test(q)){
      story='從體質來看——'+(shiStr>15?'你的生育條件不差。':'備孕可能需要多花心思。');
      story+=good?'目前時機不錯，放鬆心情順其自然。':'不急，調好身體是基礎，中西醫配合更有效。';
    } else if(/手術|開刀|動手術/.test(q)){
      story=good?'手術時機可以，運勢支持恢復。':'如果可以推遲，等運勢好一點再處理，恢復會更順利。';
      story+='術後養生重點：'+({'金':'養肺，注意傷口癒合','木':'疏肝，控制情緒幫助恢復','水':'養腎，補充營養和水分','火':'養心，保持心情愉快','土':'健脾，注意消化吸收'}[mainFav]||'均衡營養和充分休息')+'。';
    } else if(/過敏|皮膚|濕疹|蕁麻疹/.test(q)){
      story='過敏體質跟'+({金:'肺氣虛弱、皮膚敏感',木:'肝火鬱結、排毒不暢',水:'腎氣不足、免疫力低',火:'血熱、容易發炎',土:'脾虛濕重、濕氣排不出'}[el]||'五行失衡')+'有關。';
      story+='養生方向：避開過敏原，'+({'金':'多做深呼吸、保濕','木':'少熬夜、多排毒','水':'早睡、黑色食物','火':'清淡飲食、少辣','土':'少甜食、排濕'}[mainFav]||'規律作息')+'。';
    } else if(/腸胃|消化|胃痛|拉肚子|便秘|脹氣|胃食道|腸躁|胃酸|腹瀉/.test(q)){
      story='腸胃問題跟你的脾胃功能有關。';
      story+=ep['土']>25?'你土行偏旺，脾胃功能其實不差，問題可能在飲食不規律。':'土行偏弱，脾胃本身就是弱項，飲食規律和少生冷是基本功。';
    } else if(/順利|如何|好嗎|會好|怎麼辦|改善|運勢|狀況|前景|好轉|注意|要注意/.test(q)){
      // 概括性健康問題（含「家人健康會好嗎」）
      if(/家人|長輩|父|母|爸|媽|小孩|孩子/.test(q)){
        story='代表長輩的印星能量'+(inStr>15?'還算充足，目前狀況尚可':'偏弱，需要多關注')+'。';
        story+=good?'目前沒有特別緊急的訊號，定期健檢做好預防就好。':'命盤提示要多關注家人身體，尤其換季和勞累時候。';
      } else {
        story=healthBase;
        if(lowestEl&&lowestOrgan) story+='五行最缺'+lowestEl+'行，對應'+lowestOrgan+'——最容易出狀況的地方。';
        story+=good?'整體健康運不錯，保持目前的生活習慣就好。':'健康需要特別留意，養生從日常做起。';
      }
      story+='養生重點：'+({'金':'養肺（深呼吸、保濕、避免乾燥）','木':'疏肝（少熬夜、多伸展、控制情緒）','水':'養腎（早睡、黑色食物、避免過勞）','火':'養心（午休、減少焦慮、紅色食物）','土':'健脾（飲食規律、少生冷、黃色食物）'}[mainFav]||'均衡飲食與規律作息')+'。';
    } else {
      story=healthBase;
      if(lowestEl&&lowestOrgan) story+='五行最缺'+lowestEl+'行，對應'+lowestOrgan+'——最容易出狀況的地方。';
      story+='養生重點：'+({'金':'養肺（深呼吸、保濕、避免乾燥）','木':'疏肝（少熬夜、多伸展、控制情緒）','水':'養腎（早睡、黑色食物、避免過勞）','火':'養心（午休、減少焦慮、紅色食物）','土':'健脾（飲食規律、少生冷、黃色食物）'}[mainFav]||'均衡飲食與規律作息')+'。';
    }
    if(baziStory) story+='<br><br>'+baziStory;
    if(mhStory) story+=mhStory+'。';
    if(tarotStory) story+='<br><br>'+tarotStory;
    if(zwStory) story+='<br><br>'+zwStory;
    if(natalStory) story+='<br><br>'+natalStory;
    if(nameStory) story+='<br><br>'+nameStory;
  }
  // ═══════════════════════════════════════
  // 👥 人際 RELATIONSHIP
  // ═══════════════════════════════════════
  else if(type==='relationship'){
    if(/貴人|誰會幫|有沒有人幫|靠山|助力|伯樂|有人幫嗎/.test(q)){
      story=gy?'你天生容易遇到幫你的人。':'貴人運不太明顯，但不代表沒貴人——關鍵在你主動經營人脈。';
      story+=good?'目前正好在貴人運旺的時期，多跟長輩和前輩互動。':'目前貴人運偏弱，先做好自己的事，貴人自然出現。';
    } else if(/小人|被害|背後|是非|口舌|被排擠|霸凌|中傷|抹黑|陷害|閒話|造謠/.test(q)){
      story=bad?'確實有小人訊號，'+(bazi.shensha&&bazi.shensha.includes('劫煞')?'命帶劫煞，容易招惹口舌是非。':'近期運勢偏弱時小人容易冒出來。')+'低調行事、少說多做是最好的防護。':
            '目前小人影響不大，'+(strong?'你的氣場強，小人不敢正面衝突。':'保持低調、不站隊就能避開大部分是非。');
    } else if(/合夥|合作|合資|一起做|找人合|合開|股東|夥伴|搭檔/.test(q)){
      story=good?'合作能量不錯，但選對人比選對事重要。先小範圍試合作再擴大。':'合作要謹慎，目前運勢不利合夥，財務和權責務必白紙黑字。';
      story+=strong?'你適合當主導者，找執行力強的夥伴互補。':'你適合當幕後，找有人脈和資源的人搭配。';
    } else if(/朋友|友情|被誤會|被疏遠|沒朋友|社交|孤獨|人緣|孤單|融入/.test(q)){
      story=good?'人際能量不差，主動聯繫老朋友，關係會回溫。':'人際有些孤立感，'+(strong?'你可能太直接讓人不舒服，試著多傾聽。':'你可能太被動，試著主動發起邀約。');
    } else if(/信任|被騙|被利用|防人/.test(q)){
      story='從命盤看，'+(ep[caiEl]>20?'你偏財旺，容易因為「財」的關係被人接近。識人之明很重要。':'')+(bazi.shensha&&bazi.shensha.includes('華蓋')?'你命帶華蓋，天生不太信任人，但過度防備也會錯過真心。':'信任是一步步建立的，不要太快交心也不要完全封閉。');
    } else if(/溝通|表達|說話|怎麼跟.*講|不會聊天|口才|說服|談判|吵不贏|嘴笨/.test(q)){
      story='你的溝通風格——'+({金:'直接但容易太尖銳',木:'急切但容易沒耐心聽完',水:'委婉但容易讓人猜不到真意',火:'熱情但容易壓過別人',土:'穩重但容易太無聊'}[el]||'')+'。';
      story+=strong?'適度收斂氣場，讓對方有說話的空間。':'提升自信，你的想法值得被聽見。';
    } else if(/拓展|人脈|認識.*人|擴大.*圈|社交圈/.test(q)){
      story=good?'目前是拓展人脈的好時機。'+(gy?'你天生自帶吸引力。':'主動參加活動和聚會。'):'人脈拓展急不來，先把現有關係經營好，好的人脈是品質不是數量。';
    } else if(/職場.*人際|工作.*人際|同事.*關係/.test(q)){
      story=good?'職場人際目前還行。'+(gy?'你容易遇到幫你的人。':'保持專業，少捲入是非。'):'職場人際有些壓力，'+(strong?'你太直接容易得罪人，適度圓滑。':'你太退讓反而被忽視，該爭取的要爭取。');
    } else if(/順利|如何|好嗎|會好|怎麼辦|改善|運勢|狀況|前景|好轉|關係/.test(q)){
      // 概括性人際問題
      story='你的性格'+(EL_TRAIT[el]||'')+'。';
      story+=gy?'你在人際上有先天優勢。':'人際需要後天經營。';
      story+=good?'目前人際運不錯，多主動聯繫朋友和拓展社交。':mid?'人際運平穩，維持現有關係就好。':'人際運偏弱，先少說多聽，避免得罪人。';
    } else {
      story='你的性格'+(EL_TRAIT[el]||'')+'。';
      story+=gy?'你在人際上有先天優勢。':'人際需要後天經營。';
      story+=good?'目前人際運不錯，多社交。':mid?'人際平穩，維持現有關係。':'人際有壓力，少說多聽。';
    }
    if(baziStory) story+='<br><br>'+baziStory;
    if(mhStory) story+=mhStory+'。';
    if(tarotStory) story+='<br><br>'+tarotStory;
    if(zwStory) story+='<br><br>'+zwStory;
    if(natalStory) story+='<br><br>'+natalStory;
    if(nameStory) story+='<br><br>'+nameStory;
    if(dyMood) story+=dyMood+'。';
  }
  // ═══════════════════════════════════════
  // 🏠 家庭 FAMILY
  // ═══════════════════════════════════════
  else if(type==='family'){
    if(/長輩.*健康|父.*健康|母.*健康|爸.*身體|媽.*身體|長輩.*身體/.test(q)){
      story='代表長輩的印星能量'+(inStr>15?'還算充足，目前狀況尚可':'偏弱，長輩可能比較辛苦')+'。';
      story+='重點留意'+(EL_BODY[inEl]||'整體')+'方面。定期健檢、陪伴就醫比什麼都重要。';
    } else if(/長輩|父母|爸媽|孝順|跟.*相處|父.*關係|母.*關係/.test(q)){
      story='印星代表長輩，能量'+(inStr>15?'充足——你跟長輩的關係底子是好的':'偏弱——跟長輩的緣分或互動可能有些薄')+'。';
      story+=strong?'你個性強，容易跟長輩意見不合。試著多聽少反駁，即使不同意也可以先接受再溝通。':'你比較順從，但也要適度表達自己的想法，不然會累積壓力。';
    } else if(/小孩.*教育|孩子.*學|教養|親子|怎麼教/.test(q)){
      story='食傷星代表子女，'+(shiStr>15?'能量旺，孩子聰明好動但可能不太聽話。':'偏弱，孩子可能比較安靜或跟你互動不夠多。');
      story+=strong?'你容易太嚴格，給孩子多一點空間和肯定，效果比管教好。':'你太溫和可能被孩子吃定，該立規矩的時候要堅持。';
    } else if(/小孩|兒|女|孩子|生小孩|要不要生/.test(q)){
      story='食傷星'+(shiStr>15?'旺，跟孩子的緣分不錯，互動會很好。':'偏弱，跟孩子的互動需要多花心思經營。');
      if(/生|要不要/.test(q)) story+=good?'目前適合規劃，運勢支持。':'不急，等條件更成熟再考慮。';
    } else if(/婆媳|公婆|婆婆|公公|翁姑|妯娌|姑嫂|岳父|岳母/.test(q)){
      story='婆媳關係從命盤看——'+(inStr>15?'你跟長輩相處底子不差，保持尊重就好。':'印星偏弱，跟對方父母的緣分較薄，相處需要更多耐心。');
      story+=strong?'你個性強容易起衝突，讓另一半當中間橋樑。':'你太退讓反而不被重視，該說的還是要說。';
    } else if(/兄弟|姊妹|手足|哥|姐|弟|妹/.test(q)){
      const biStr=ep[el]||0;
      story='比劫星代表兄弟姊妹，'+(biStr>20?'比劫旺，你跟手足的連結很強但也容易有競爭或摩擦。':'比劫偏弱，你跟手足的互動可能不太頻繁。');
      story+=good?'目前手足關係還行，有事可以互相幫忙。':'手足之間可能有些小摩擦，多體諒少計較。';
    } else if(/搬家|買房|換房|裝潢|風水|住|租房|搬|住哪|居住|房子/.test(q)){
      story=good?'居住環境方面運勢不錯，適合做改變。':'目前不是大動居住環境的好時機，小修小補可以。';
      const favDir={金:'西方',木:'東方',水:'北方',火:'南方',土:'中央'}[mainFav]||'';
      if(favDir) story+=''+favDir+'方位對你比較有利。';
    } else if(/遺產|財產|分家|分配/.test(q)){
      story='財產分配是敏感話題。'+(good?'目前處理的時機還行，但務必找專業人士協助。':'時機不太好，容易有爭議，建議先擱置或找第三方調解。');
    } else if(/家庭氣氛|吵|冷|不和|衝突|和諧|家裡氣氛|家人關係|家庭關係|相處不好|家庭問題/.test(q)){
      story=good?'家庭能量整體偏正面，小摩擦很正常。':'家庭氣氛確實有壓力，';
      story+=strong?'你可能是壓力源之一——試著放軟姿態，主動關心家人感受。':'你可能在承受家庭壓力——不要一個人扛，適度表達需求。';
    } else if(/順利|如何|好嗎|會好|怎麼辦|改善|運勢|狀況|前景|好轉|解決|問題/.test(q)){
      // 概括性家庭問題
      story='你在家庭裡'+(strong?'容易太強勢，家人需要被尊重的空間。':'比較包容退讓，但也要適度表達。');
      story+=good?'家庭運整體不錯，目前家庭能量正面，小問題都能順利化解。':mid?'家庭關係平穩，不會有大波動。':'家庭有些壓力，多主動溝通、少猜疑，問題才能真正解決。';
    } else {
      story='你在家庭裡'+(strong?'容易太強勢，家人需要被尊重的空間。':'比較包容退讓，但也要適度表達。');
      story+=good?'家庭運整體不錯。':mid?'家庭關係平穩。':'家庭有些壓力，多溝通少猜疑。';
    }
    if(baziStory) story+='<br><br>'+baziStory;
    if(mhStory) story+=mhStory+'。';
    if(tarotStory) story+='<br><br>'+tarotStory;
    if(zwStory) story+='<br><br>'+zwStory;
    if(natalStory) story+='<br><br>'+natalStory;
    if(nameStory) story+='<br><br>'+nameStory;
    if(dyMood) story+=dyMood+'。';
  }
  // ═══════════════════════════════════════
  // 🌐 其他/整體
  // ═══════════════════════════════════════
  else{
    story='你的性格'+(EL_TRAIT[el]||'')+'。';
    if(dyMood) story+=dyMood+'。';
    if(baziStory) story+='<br><br>'+baziStory;
    if(mhStory) story+=mhStory+'。';
    if(tarotStory) story+='<br><br>'+tarotStory;
    if(zwStory) story+='<br><br>'+zwStory;
    if(natalStory) story+='<br><br>'+natalStory;
    if(nameStory) story+='<br><br>'+nameStory;
  }


  // ── 未匹配問題偵測：如果走到通用else，靜默回報 ──
  // 方法：檢查story是否包含通用模板特徵詞
  const _genericPatterns=['你在感情裡','你的性格','你對財富的態度','你在家庭裡','體質底子','人際需要後天'];
  const _isGeneric=_genericPatterns.some(p=>story.startsWith(p));
  // 概括性問題（「順利嗎」「如何」「好嗎」「會好轉嗎」「會改善嗎」）本來就該走通用，不算未匹配
  const _isBroadQ=/順利|如何|好嗎|會好|怎麼辦|改善|運勢|狀況|前景|好轉|什麼時候|方向|適合|注意|要注意|怎麼樣|好不好|旺不旺|有桃花|有沒有/.test(q);
  if(_isGeneric && !_isBroadQ && q && q.length>=3){
    try{ _reportUnmatchedQuestion(q, type); }catch(e){}
  }

  // ── 組合輸出 ──
  // ═══ 是非題結論插入 story 開頭 ═══
  if(_ynPrefix && story) story = _ynPrefix + ' ' + story;

  let html='<p style="font-size:1.05rem;line-height:1.8;font-weight:600;color:var(--c-gold)">'+story+'</p>';
  const _favCH_all={'金':'佩戴白水晶或鈦晶，幫助你果斷決策','木':'戴條綠幽靈或東陵玉，讓成長的能量流動起來','水':'海藍寶或月光石適合你，穩住思緒再出手','火':'紅瑪瑙或太陽石是你的助攻，點燃行動力','土':'黃水晶或虎眼石接地氣，讓你的根扎穩'};
  let _safeFav=mainFav;
  if(mainUnfav===mainFav || (bazi.unfav&&bazi.unfav.indexOf(mainFav)!==-1)){
    const _favList=bazi.fav||[];
    for(var _fi=0;_fi<_favList.length;_fi++){
      if(!bazi.unfav||bazi.unfav.indexOf(_favList[_fi])===-1){ _safeFav=_favList[_fi]; break; }
    }
  }
  const favCH=_favCH_all;
  const aH=favCH[_safeFav]||'選一條跟喜用神對應的水晶，日常佩戴補強能量';
  html+='<p style="font-size:.9rem;line-height:1.7;margin-top:.5rem;color:var(--c-text-dim)">你的喜用神是<strong style="color:var(--c-gold)">'+mainFav+'行</strong>';
  html+=mainUnfav?('，最該避的是<strong style="color:#f87171">'+mainUnfav+'行</strong>的消耗'):'';
  html+='。最簡單的第一步：<strong>'+aH+'</strong>。</p>';
  return html;
}

// ═══ 未匹配問題靜默回報（Google Forms） ═══
const _unmatchedCache=new Set();
function _reportUnmatchedQuestion(question, type){
  // 防重複：同一問題只報一次
  const key=type+':'+question;
  if(_unmatchedCache.has(key)) return;
  _unmatchedCache.add(key);
  // 頻率限制：每次session最多報10個
  if(_unmatchedCache.size>10) return;

  const typeLabel={love:'感情',career:'事業',wealth:'財運',health:'健康',relationship:'人際',family:'家庭'}[type]||'其他';
  
  // Google Forms 靜默提交 → Apps Script 自動寄信到 onerkk@gmail.com
  const FORM_URL='https://docs.google.com/forms/d/e/1FAIpQLSdKrOA6yEsHZW-QPRXf7OYjCVVfIClRYN17X6IW09CL3Xzlcg/formResponse';

  try{
    const fd=new FormData();
    fd.append('entry.743285707', question);           // 問題文字
    fd.append('entry.403770236', typeLabel);           // 問題類型
    fd.append('entry.972007534', new Date().toISOString()); // 時間
    fetch(FORM_URL,{method:'POST',mode:'no-cors',body:fd});
  }catch(e){}

  // 同時存 localStorage 備份
  try{
    const stored=JSON.parse(localStorage.getItem('jy_unmatched')||'[]');
    stored.push({q:question,type:typeLabel,ts:new Date().toISOString()});
    if(stored.length>50) stored.splice(0,stored.length-50);
    localStorage.setItem('jy_unmatched',JSON.stringify(stored));
  }catch(e){}
}

// 開發者工具：在 console 輸入 showUnmatched() 查看未匹配問題
window.showUnmatched=function(){
  try{
    const data=JSON.parse(localStorage.getItem('jy_unmatched')||'[]');
    if(!data.length){console.log('✅ 沒有未匹配問題');return;}
    console.table(data);
    console.log('共',data.length,'筆未匹配問題');
    console.log('清除：clearUnmatched()');
  }catch(e){console.log('讀取失敗',e);}
};
window.clearUnmatched=function(){
  localStorage.removeItem('jy_unmatched');
  console.log('✅ 已清除');
};


function generateAnswer(type,prob,bazi,mh,tarot){
  const dm=bazi.dm,el=bazi.dmEl,strong=bazi.strong;
  const curDy=bazi.dayun?bazi.dayun.find(d=>d.isCurrent):null;
  const fav=bazi.fav||[];
  const unfav=bazi.unfav||[];

  /* ═══ FACTORS: 逐維度列出具體發現 ═══ */
  const factors=[];

  // ── 八字因子 ──
  let baziFactor=`日主${dm}（${el}行），身${strong?'強':'弱'}`;
  if(fav.length) baziFactor+=`，喜用${fav.join('、')}`;
  if(unfav.length) baziFactor+=`，忌${unfav.join('、')}`;
  factors.push('【八字】'+baziFactor);

  if(curDy){
    let dyDetail=`當前大運 ${curDy.gz}（${curDy.level}）`;
    if(curDy.level.includes('旺盛')||curDy.level.includes('極強')||curDy.level.includes('上升')) dyDetail+='→ 運勢有外在助力';
    else if((curDy.level.includes('偏弱')||curDy.level.includes('低迷')||curDy.level.includes('補運'))) dyDetail+='→ 運勢阻力偏大，宜守不宜攻';
    else dyDetail+='→ 運勢平穩，不特別助力也不阻礙';
    factors.push('【大運】'+dyDetail);
  }

  if(bazi.shensha&&bazi.shensha.length){
    const good=['天乙貴人','文昌','桃花','天德','月德','驛馬','將星'];
    const bad=['羊刃','亡神','劫煞','華蓋'];
    const g=bazi.shensha.filter(s=>good.includes(s));
    const b2=bazi.shensha.filter(s=>bad.includes(s));
    let shText='神煞中';
    if(g.length) shText+=`有${g.join('、')}助力`;
    if(b2.length) shText+=(g.length?'，但':'')+ `${b2.join('、')}需注意`;
    if(!g.length&&!b2.length) shText='神煞：'+bazi.shensha.join('、');
    factors.push('【神煞】'+shText);
  }

  // 調候
  if(bazi.tiaohou&&bazi.tiaohou.reason){
    factors.push('【調候】'+bazi.tiaohou.reason+(bazi.tiaohou.need?' → 需'+bazi.tiaohou.need.join('、')+'行':''));
  }

  // 五行比例
  if(bazi.ep){
    const epArr=Object.entries(bazi.ep).sort((a,b)=>b[1]-a[1]);
    factors.push('【五行】'+epArr.map(([k,v])=>k+v+'%').join('、'));
  }

  // 流年
  const _thisYr=new Date().getFullYear();
  if(curDy&&curDy.liuNian){
    const ln2=curDy.liuNian.find(l=>l.year===_thisYr);
    if(ln2){
      let lnDetail=`${_thisYr}流年 ${ln2.gz}（${ln2.level}）`;
      if(ln2.events&&ln2.events.length) lnDetail+='：'+ln2.events[0];
      factors.push('【流年】'+lnDetail);
    }
  }

  // ── 梅花因子（深度解讀） ──
  if(mh){
    let mhText=`本卦「${mh.ben.n}」（${mh.ben.m||''}）→ 變卦「${mh.bian.n}」（${mh.bian.m||''}）`;
    mhText+=`，體用${mh.ty.r}（${mh.ty.f}）`;
    if(mh.ty.d) mhText+='：'+mh.ty.d;
    factors.push('【梅花·本卦→變卦】'+mhText);

    // 互卦=過程
    if(mh.hu&&mh.hu.m){
      factors.push('【梅花·互卦（過程）】'+mh.hu.n+'：'+mh.hu.m);
    }
    // 動爻
    if(mh.dong&&mh.ben&&typeof getYaoCi==='function'){
      const yc=getYaoCi(mh.ben.n, mh.dong);
      if(yc&&!yc.includes('擴充中')){
        factors.push('【梅花·動爻第'+mh.dong+'爻】'+yc);
      }
    }
    // 問題類型解讀
    if(typeof getMeihuaTypeReading==='function'){
      const tr=getMeihuaTypeReading(mh, type);
      if(tr&&tr.reading) factors.push('【梅花·針對此問】'+tr.reading);
      if(tr&&tr.trend) factors.push('【梅花·趨勢】'+tr.trend);
    }
  }

  // ── 塔羅因子（逐位置解讀重點牌） ──
  if(tarot.drawn.length>=10){
    const posNames=['核心現狀','阻礙因素','過去基礎','未來發展','可能結果','近期未來','自我態度','環境影響','希望恐懼','最終結果'];
    // 全 10 位置都納入因子分析，不再只挑 5 個
    [0,1,2,3,4,5,6,7,8,9].forEach(i=>{
      const c=tarot.drawn[i];
      if(!c)return;
      const dir=c.isUp?'正位':'逆位';
      const typeMeaning=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(c.id,c.isUp,type):'';
      const meaning=typeMeaning||(c.isUp?c.up:c.rv);
      factors.push(`【塔羅·${posNames[i]}】${c.n}（${dir}）→ ${meaning}`);
    });
  }

  // ── 紫微因子（深度：命宮+問題宮+大限+流年+格局） ──
  if(S.ziwei){
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
    const gongIdx=typeToGong[type]!==undefined?typeToGong[type]:0;
    const gongName=typeof ZW_PALACES!=='undefined'?ZW_PALACES[gongIdx]:'命宮';

    // A. 命宮主星
    const mingStars=S.ziwei.palaces[0]?S.ziwei.palaces[0].stars:[];
    if(mingStars.length){
      const mInfo=mingStars.filter(s=>s.type==='major').map(s=>{
        let t=s.name;if(s.bright)t+=`(${s.bright})`;if(s.hua)t+=` ${s.hua}`;return t;
      }).join('、');
      if(mInfo) factors.push('【紫微·命宮】'+mInfo);
    }

    // B. 問題對應宮位
    if(gongIdx!==0){
      const gongStars=S.ziwei.palaces[gongIdx]?S.ziwei.palaces[gongIdx].stars:[];
      if(gongStars.length){
        const starInfo=gongStars.map(s=>{
          let t=s.name;if(s.bright)t+=`(${s.bright})`;if(s.hua)t+=` ${s.hua}`;return t;
        }).join('、');
        factors.push(`【紫微·${gongName}】${starInfo}`);
        // 宮位無主星
        if(!gongStars.some(s=>s.type==='major')) factors.push(`【紫微】${gongName}無主星坐守，借對宮星曜`);
      }
    }

    // C. 大限走宮
    const curDx=S.ziwei.daXian?S.ziwei.daXian.find(d=>d.isCurrent):null;
    if(curDx){
      let dxText=`大限走「${curDx.palaceName}」（${curDx.level}）`;
      if(curDx.stars&&curDx.stars.length) dxText+=`，主星：${curDx.stars.join('、')}`;
      if(curDx.theme) dxText+=`，十年主題：${curDx.theme}`;
      factors.push('【紫微·大限】'+dxText);

      // 大限四化
      if(curDx.hua&&curDx.hua.length){
        const huaText=curDx.hua.map(h=>h.star+h.hua+'入'+h.palace).join('，');
        factors.push('【紫微·大限四化】'+huaText);
      }
    }

    // D. 流年
    const thisYear=new Date().getFullYear();
    if(S.ziwei.getLiuNianZw){
      try{
        const zwLn=S.ziwei.getLiuNianZw(thisYear);
        if(zwLn){
          let lnText=`${thisYear}流年命宮走「${zwLn.mingPalace}」`;
          if(zwLn.bright&&zwLn.bright.length) lnText+='（'+zwLn.bright.map(b=>b.star+b.label).join('、')+'）';
          if(zwLn.focus) lnText+='，重點：'+zwLn.focus;
          factors.push('【紫微·流年】'+lnText);
        }
      }catch(e){}
    }
  }

  // ── 姓名因子（深度） ──
  if(S.nameResult){
    const nr=S.nameResult;
    let nText=`三才配置 ${nr.sanCai?nr.sanCai.join('→'):''} ${nr.sanCaiLevel}`;
    if(nr.renGe) nText+=`，人格 ${nr.renGe.num}畫（${nr.renGe.fortune.level}）`;
    if(nr.zongGe) nText+=`，總格 ${nr.zongGe.num}畫（${nr.zongGe.fortune.level}）`;
    factors.push('【姓名·筆劃派】'+nText);
    // 三才五行與喜用神對照
    if(nr.sanCai&&fav.length){
      const sanCaiEls=nr.sanCai||[];
      const hasFav=sanCaiEls.some(e=>fav.includes(e));
      const hasUnfav=sanCaiEls.some(e=>unfav.includes(e));
      if(hasFav) factors.push('【姓名】三才含喜用神'+fav.join('')+'，姓名與命盤相輔');
      if(hasUnfav) factors.push('【姓名】三才含忌神，姓名能量與命盤有衝突');
    }
  }
  if(S.zodiacNameResult){
    const zn=S.zodiacNameResult;
    let zText=`${zn.emoji}${zn.zodiac}年→「${zn.overallLevel}」`;
    if(zn.isSacrifice) zText+='（犧牲格：不利健康財運）';
    if(zn.isSnakePigClash) zText+='（巳亥衝：波動大）';
    if(zn.totalLike>0) zText+=`，吉${zn.totalLike}項`;
    if(zn.totalDislike>0) zText+=`，凶${zn.totalDislike}項`;
    factors.push('【姓名·生肖派】'+zText);
  }

  /* ═══ SUGGESTIONS: 依維度×類型 生成具體建議 ═══ */
  const suggestions=[];

  // 八字建議
  if(strong){
    suggestions.push(`八字身強，宜「洩秀生財」：多發揮${typeof SHENG!=='undefined'?SHENG[el]:''}行能量，透過輸出（創作、教學、投資）引導力量`);
  }else{
    suggestions.push(`八字身弱，宜「扶助印比」：加強${el}行與${typeof BE_SHENG!=='undefined'?BE_SHENG[el]:''}行能量，選擇穩定環境發展`);
  }

  // 紫微建議（宮位+星曜+大限）
  if(S.ziwei){
    const typeToGong2={love:'夫妻',career:'官祿',wealth:'財帛',health:'疾厄',family:'田宅',relationship:'交友',general:'命'};
    const relevantGongName=typeToGong2[type]||'命';
    const curDx2=S.ziwei.daXian?S.ziwei.daXian.find(d=>d.isCurrent):null;

    // 大限主題建議
    if(curDx2&&curDx2.theme){
      suggestions.push(`紫微大限十年主題「${curDx2.theme}」，${curDx2.level.includes('吉')?'順勢而為效果佳':'宜守不宜攻，穩紮穩打'}`);
    }

    // 大限四化對問題宮的建議
    if(curDx2&&curDx2.hua&&curDx2.hua.length){
      curDx2.hua.forEach(h=>{
        if(h.palace===relevantGongName){
          if(h.hua==='化祿') suggestions.push(`紫微大限${h.star}化祿入${h.palace}宮：此方面有福有貴，可大膽行動`);
          else if(h.hua==='化忌') suggestions.push(`紫微大限${h.star}化忌入${h.palace}宮：此方面有困擾，宜保守應對`);
          else if(h.hua==='化權') suggestions.push(`紫微大限${h.star}化權入${h.palace}宮：此方面有掌控力，適合主導`);
          else if(h.hua==='化科') suggestions.push(`紫微大限${h.star}化科入${h.palace}宮：貴人暗助，利考試晉升`);
        }
      });
    }

    // 命宮主星性格建議
    const mingMajors=S.ziwei.palaces[0]?S.ziwei.palaces[0].stars.filter(s=>s.type==='major'):[];
    if(mingMajors.length){
      const starAdvice={
        '紫微':'你命帶領袖格，適合獨立決策但要防剛愎自用',
        '天機':'你心思靈活善謀略，但容易想太多而猶豫不決',
        '太陽':'你性格光明磊落，利公職外務，但易過度消耗',
        '武曲':'你執行力強財氣佳，適合金融實業，但防過於剛硬',
        '天同':'你性情溫和有福氣，但容易安於現狀缺乏衝勁',
        '廉貞':'你有野心和企圖心，但感情起伏大需注意情緒管理',
        '天府':'你穩重有才幹，適合守成發展，不宜冒進',
        '太陰':'你細膩敏感，適合策劃研究，但防過度內耗',
        '貪狼':'你交際手腕佳慾望強，有偏財運但防沉迷享樂',
        '巨門':'你口才犀利善分析，但防口舌是非和多疑',
        '天相':'你人緣好適合輔佐職，但容易受他人影響',
        '天梁':'你有長輩緣適合服務業，逢凶化吉的格局',
        '七殺':'你魄力十足敢衝敢闖，但防衝動冒險',
        '破軍':'你勇於開創變革，但先破後立過程辛苦'
      };
      const mainStar=mingMajors[0].name;
      if(starAdvice[mainStar]) suggestions.push('命宮'+mainStar+'：'+starAdvice[mainStar]);
    }
  }

  // 梅花建議（基於卦象深度解讀）
  if(mh){
    if(typeof getMeihuaTypeReading==='function'){
      const tr=getMeihuaTypeReading(mh, type);
      if(tr&&tr.reading) suggestions.push('卦象提示：'+tr.reading);
    }
    // 變卦走向建議
    if(mh.bian&&mh.bian.m){
      suggestions.push('卦象演變：本卦→變卦「'+mh.bian.n+'」（'+mh.bian.m+'）'+(mh.bian.j?' — '+mh.bian.j:''));
    }
  }

  // 塔羅建議（基於位置深度分析）
  if(tarot.drawn.length>=10){
    const ta=analyzeTarotSpread(tarot.drawn, type);
    const finalCard=ta.keyCards.outcome;
    const obstCard=ta.keyCards.obstacle;
    const selfCard=ta.keyCards.self;
    const nearCard=ta.keyCards.near;
    const presentCard=ta.keyCards.present;

    // 核心現狀牌
    if(presentCard){
      const pM=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(presentCard.id,presentCard.isUp,type):'';
      suggestions.push(`核心現狀牌「${presentCard.n}」${presentCard.isUp?'正位':'逆位'}：${pM||(presentCard.isUp?presentCard.up:presentCard.rv)}`);
    }
    // 最終結果
    if(finalCard){
      const fMeaning=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(finalCard.id,finalCard.isUp,type):'';
      suggestions.push(`塔羅最終牌「${finalCard.n}」${finalCard.isUp?'正位':'逆位'}，提示方向：${fMeaning||(finalCard.isUp?finalCard.up:finalCard.rv)}`);
    }
    // 阻礙牌
    if(obstCard){
      const oMeaning=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(obstCard.id,obstCard.isUp,type):'';
      suggestions.push(`需注意阻礙因素「${obstCard.n}」${obstCard.isUp?'正位':'逆位'}：${oMeaning||(obstCard.isUp?obstCard.up:obstCard.rv)}`);
    }
    // 自我態度牌(逆位=需調整)
    if(selfCard&&!selfCard.isUp){
      suggestions.push(`你的態度牌「${selfCard.n}」逆位，暗示自身心態需要調整：${selfCard.rv}`);
    }
    // 近未來牌
    if(nearCard){
      const nM=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(nearCard.id,nearCard.isUp,type):'';
      suggestions.push(`近期最需關注「${nearCard.n}」${nearCard.isUp?'正位':'逆位'}：${nM||(nearCard.isUp?nearCard.up:nearCard.rv)}`);
    }
    // 牌陣摘要
    if(ta.summary) suggestions.push('🔮 '+ta.summary);
  }

  // 姓名學建議
  if(S.zodiacNameResult){
    const zn=S.zodiacNameResult;
    if(zn.isSacrifice) suggestions.push('姓名生肖派判定「犧牲格」，整體磁場偏弱，建議透過改名、常用字號或佩戴水晶補強能量');
    else if(zn.overallLevel.includes('大吉')) suggestions.push('姓名生肖派「大吉」，名字磁場與生肖高度相合，是正面助力');
    else if(zn.overallLevel.includes('凶')) suggestions.push('姓名生肖派偏弱，可考慮使用常用別名或字號來調整磁場');
  }
  if(S.nameResult&&S.nameResult.sanCaiLevel){
    const scl=S.nameResult.sanCaiLevel;
    if(scl.includes('凶')) suggestions.push('姓名三才配置偏弱（'+scl+'），長期可能影響健康運和人際運');
  }

  // 類型專屬建議
  const typeAdvice={
    love:{
      strong:'感情上你容易主對，但對方需要被尊重的空間，適度放軟身段',
      weak:'感情上你較被動，試著主動表達需求，貴人會在社交場合出現',
      peach:'命帶桃花，異性緣佳但需慍選對象，不宜同時曖昧多人',
      noPeach:'可往正東或正南方向社交，或佩戴喜用神對應水晶增強桃花磁場'
    },
    career:{
      strong:'事業上你有領導力，適合獨立負責或創業，食傷生財路線佳',
      weak:'事業上宜依附大平台或跟隨有能力的主管，印星助力是關鍵',
      wenChang:'文昌入命，利考試進修、文書工作、學術研究方向',
      yiMa:'驛馬星動，利外出、出差、跨區域發展'
    },
    wealth:{
      caiWang:'命中財星旺，偏財運佳，可適度參與投資但設好停損',
      caiRuo:'命中財星偏弱，宜穩健理財、定期儲蓄，不宜高風險操作',
      strong:'身強能扛財，可積極追求財富，但需避免貪多',
      weak:'身弱難扛財，財來財卻，宜保守理財、量力而為'
    },
    health:{
      strong:'身強體質底子好，但要防「過旺」引起的發炎、上火、血壓問題',
      weak:'身弱體質偏虛，需注意免疫力、腸胃功能、睡眠品質',
      advice:'喜用神為'+fav[0]+'行，養生重點：'+{金:'養肺護膚（深呼吸、保濕）',木:'疏肝解鬱（伸展、少熬夜）',水:'養腎補水（早睡、黑色食物）',火:'養心安神（午休、紅色食物）',土:'健脾去濕（飲食規律、黃色食物）'}[fav[0]||'土']
    }
  };

  if(type==='love'){
    suggestions.push(typeAdvice.love[strong?'strong':'weak']);
    suggestions.push(bazi.shensha&&bazi.shensha.includes('桃花')?typeAdvice.love.peach:typeAdvice.love.noPeach);
  } else if(type==='career'){
    suggestions.push(typeAdvice.career[strong?'strong':'weak']);
    if(bazi.shensha&&bazi.shensha.includes('文昌'))suggestions.push(typeAdvice.career.wenChang);
    if(bazi.shensha&&bazi.shensha.includes('驛馬'))suggestions.push(typeAdvice.career.yiMa);
  } else if(type==='wealth'){
    const caiEl=typeof KE!=='undefined'?KE[el]:'';
    suggestions.push(typeAdvice.wealth[strong?'strong':'weak']);
    suggestions.push(bazi.ep&&caiEl&&bazi.ep[caiEl]>15?typeAdvice.wealth.caiWang:typeAdvice.wealth.caiRuo);
  } else if(type==='health'){
    suggestions.push(typeAdvice.health[strong?'strong':'weak']);
    suggestions.push(typeAdvice.health.advice);
  }

  /* ═══ TEXT: 主要回答段落 ═══ */
  let text='';

  // ── 問答對齊：先針對問句類型給出直接回應 ──
  const intent = parseQuestionIntent(S.form ? S.form.question : '', type);
  const qaResponse = generateQAResponse(intent, type, prob, bazi, mh, tarot);
  if(qaResponse) {
    text += `<div style="border-left:3px solid var(--c-gold,#d4af37);padding-left:1rem;margin-bottom:1rem">${qaResponse}</div>`;
  }

  // ── 命理依據（收合式，不干擾閱讀）──
  let techText='';
  techText+=`<p><strong>日主「${dm}」五行屬${el}，身${strong?'強':'弱'}</strong>，`;
  if(curDy){
    const _tGan=curDy.gz?curDy.gz.charAt(0):'';
    const _tGanEl={'甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水'}[_tGan]||'';
    const _tKeM={'木':'土','土':'水','水':'火','火':'金','金':'木'};
    const _tShM={'木':'火','火':'土','土':'金','金':'水','水':'木'};
    let _tRel='';
    if(_tGanEl===el) _tRel='比肩同氣';
    else if(_tShM[_tGanEl]===el) _tRel='生助日主';
    else if(_tKeM[_tGanEl]===el) _tRel='剋制日主';
    else if(_tShM[el]===_tGanEl) _tRel='日主洩氣';
    else if(_tKeM[el]===_tGanEl) _tRel='日主所剋';
    techText+=`目前走 ${curDy.gz} 大運（${curDy.level}），天干${_tGan}屬${_tGanEl}行${_tRel?'（'+_tRel+'）':''}。`;
  }
  techText+=`</p>`;

  if(mh){
    techText+=`<p class="mt-sm"><strong>梅花易數</strong>得本卦「${mh.ben.n}」（${mh.ben.m||''}），變卦「${mh.bian.n}」（${mh.bian.m||''}），`;
    techText+=`體用關係為 <span class="tag tag-gold">${mh.ty.r}</span>（${mh.ty.f}）。`;
    if(mh.ty.d) techText+=mh.ty.d;
    techText+=`</p>`;
    // 互卦
    if(mh.hu&&mh.hu.n){
      techText+=`<p class="text-sm text-dim">互卦「${mh.hu.n}」：${mh.hu.m||'事情發展過程'}</p>`;
    }
    // 動爻
    if(mh.dong&&mh.ben&&typeof getYaoCi==='function'){
      const yc2=getYaoCi(mh.ben.n, mh.dong);
      if(yc2&&!yc2.includes('擴充中')){
        techText+=`<p class="text-sm text-dim">動爻（第${mh.dong}爻）：${yc2}</p>`;
      }
    }
    // 問題類型解讀
    if(typeof getMeihuaTypeReading==='function'){
      const tr2=getMeihuaTypeReading(mh, type);
      if(tr2&&tr2.reading) techText+=`<p class="text-sm" style="color:var(--c-gold)">針對此問：${tr2.reading}</p>`;
      if(tr2&&tr2.trend) techText+=`<p class="text-sm text-dim">${tr2.trend}</p>`;
    }
  }

  if(tarot.drawn.length>=10){
    const core=tarot.drawn[0],obst=tarot.drawn[1],future=tarot.drawn[3],outcome=tarot.drawn[4],final=tarot.drawn[9];
    techText+=`<p class="mt-sm"><strong>塔羅凱爾特十字：</strong>`;
    techText+=`核心「${core.n}」${core.isUp?'正位':'逆位'}（${core.isUp?core.up:core.rv}）`;
    techText+=`；阻礙「${obst.n}」${obst.isUp?'正位':'逆位'}（${obst.isUp?obst.up:obst.rv}）`;
    techText+=`；自身狀態「${tarot.drawn[6].n}」${tarot.drawn[6].isUp?'正位（準備好）':'逆位（需調整）'}`;
    techText+=`；結果「${final.n}」${final.isUp?'正位':'逆位'}（${final.isUp?final.up:final.rv}）`;
    techText+=`</p>`;
    // 心理面：潛意識 vs 意識是否矛盾
    const _sub=tarot.drawn[2],_con=tarot.drawn[4];
    if(_sub.isUp!==_con.isUp){
      techText+=`<p class="mt-sm text-sm text-dim">⚡ 潛意識「${_sub.n}」與意識目標「${_con.n}」方向矛盾，內心有拉扯。</p>`;
    }
  }

  if(S.ziwei){
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
    const gongIdx=typeToGong[type]!==undefined?typeToGong[type]:0;
    const gongName=typeof ZW_PALACES!=='undefined'?ZW_PALACES[gongIdx]:'命宮';

    // 命宮主星
    const mingStars2=S.ziwei.palaces[0]?S.ziwei.palaces[0].stars.filter(s=>s.type==='major'):[];
    if(mingStars2.length){
      techText+=`<p class="mt-sm"><strong>紫微斗數·命宮</strong>：${mingStars2.map(s=>{let t=s.name;if(s.bright)t+=`（${s.bright}）`;if(s.hua)t+=` ${s.hua}`;return t;}).join('、')}。</p>`;
    }

    // 問題對應宮位
    const gongStars=S.ziwei.palaces[gongIdx]?S.ziwei.palaces[gongIdx].stars:[];
    if(gongStars.length&&gongIdx!==0){
      techText+=`<p class="mt-sm"><strong>紫微斗數·${gongName}</strong>：`;
      techText+=gongStars.map(s=>{let t=s.name;if(s.bright)t+=`（${s.bright}）`;if(s.hua)t+=` ${s.hua}`;return t;}).join('、');
      const hasLu=gongStars.some(s=>s.hua==='化祿'),hasJi=gongStars.some(s=>s.hua==='化忌');
      if(hasLu) techText+='。化祿入此宮，此方面有福氣。';
      else if(hasJi) techText+='。化忌入此宮，需格外留心。';
      else techText+='。';
      techText+=`</p>`;
    }

    // 大限
    const techDx=S.ziwei.daXian?S.ziwei.daXian.find(d=>d.isCurrent):null;
    if(techDx){
      techText+=`<p class="mt-sm"><strong>紫微大限</strong>：走「${techDx.palaceName}」宮（${techDx.level}）`;
      if(techDx.stars&&techDx.stars.length) techText+='，主星'+techDx.stars.join('、');
      if(techDx.theme) techText+='。十年主題：'+techDx.theme;
      techText+='。</p>';
      if(techDx.hua&&techDx.hua.length){
        techText+=`<p class="text-sm text-dim">大限四化：${techDx.hua.map(h=>h.star+h.hua+'入'+h.palace).join('，')}</p>`;
      }
    }

    // 流年
    const _ty=new Date().getFullYear();
    if(S.ziwei.getLiuNianZw){
      try{
        const zwLn2=S.ziwei.getLiuNianZw(_ty);
        if(zwLn2){
          techText+=`<p class="mt-sm"><strong>紫微${_ty}流年</strong>：命宮走「${zwLn2.mingPalace}」`;
          if(zwLn2.bright&&zwLn2.bright.length) techText+='（'+zwLn2.bright.map(b=>b.star+b.label).join('、')+'）';
          if(zwLn2.focus) techText+='。重點：'+zwLn2.focus;
          techText+='。</p>';
        }
      }catch(e){}
    }
  }

  // ── 西洋星盤技術解讀 ──
  if(S.natal){
    const _HNA={1:'自我',2:'財富',3:'溝通',4:'家庭',5:'戀愛',6:'健康',7:'伴侶',8:'轉化',9:'遠行',10:'事業',11:'人脈',12:'靈性'};
    const np=S.natal.planets;
    techText+=`<p class="mt-sm"><strong>西洋星盤</strong>：太陽${np['太陽'].sign}（${_HNA[np['太陽'].house]}）、月亮${np['月亮'].sign}（${_HNA[np['月亮'].house]}）、上升${S.natal.ascSign.name}。`;
    const _gA=S.natal.aspects.filter(a=>a.good).length, _bA=S.natal.aspects.filter(a=>!a.good).length;
    techText+=`吉相位${_gA}個、凶相位${_bA}個，${_gA>_bA?'星盤能量正面':_bA>_gA?'挑戰相位偏多':'吉凶均衡'}。</p>`;
    // 問題相關行星
    if(type==='love'||type==='relationship'){
      techText+=`<p class="text-sm text-dim">金星${np['金星'].sign}（${_HNA[np['金星'].house]}）`;
      if([5,7].includes(np['金星'].house)) techText+='，利桃花';
      const h7S=ZODIAC_NAMES[Math.floor(S.natal.houses[6]/30)%12];
      techText+=`。伴侶宮${h7S}座。</p>`;
    } else if(type==='career'){
      techText+=`<p class="text-sm text-dim">天頂${S.natal.mcSign.name}座，木星在${_HNA[np['木星'].house]}帶來機會。</p>`;
    } else if(type==='wealth'){
      techText+=`<p class="text-sm text-dim">木星${np['木星'].sign}（${_HNA[np['木星'].house]}）${[2,8,11].includes(np['木星'].house)?'，天生有財運':''}。金星在${_HNA[np['金星'].house]}。</p>`;
    }
  }

  // ── 姓名學（生肖派）技術解讀 ──
  if(S.zodiacNameResult){
    const zn=S.zodiacNameResult;
    techText+=`<p class="mt-sm"><strong>姓名學·生肖派</strong>：${zn.emoji}${zn.zodiac}年生人，姓名「${zn.name}」判定【${zn.overallLevel}】。`;
    if(zn.totalLike>0) techText+=`吉象${zn.totalLike}項`;
    if(zn.totalDislike>0) techText+=`${zn.totalLike>0?'，':''}凶象${zn.totalDislike}項`;
    techText+=`。</p>`;
    // 列出關鍵喜忌
    const keyHits = zn.positions.flatMap(p=>p.charResults.flatMap(c=>c.hits.filter(h=>Math.abs(h.score)>=7)));
    if(keyHits.length){
      techText+=`<p class="text-sm text-dim">關鍵字根：`;
      techText+=keyHits.map(h=>`<span style="color:${h.type==='吉'?'#4ade80':'#f87171'}">${h.type}【${h.label}】</span>`).join('、');
      techText+=`</p>`;
    }
    if(zn.isSacrifice) techText+=`<p class="text-sm" style="color:#f87171">⚠ ${zn.sacrificeNote}</p>`;
    if(zn.isSnakePigClash) techText+=`<p class="text-sm" style="color:#f87171">⚠ ${zn.clashNote}</p>`;
    if(zn.warnings.length) techText+=`<p class="text-sm text-warn">🔔 ${zn.warnings[0]}</p>`;
  }
  if(S.nameResult){
    const nr=S.nameResult;
    techText+=`<p class="mt-sm"><strong>姓名學·筆劃派</strong>：三才 ${nr.sanCai.join('→')}（${nr.sanCaiLevel}），人格${nr.renGe.num}畫（${nr.renGe.fortune.level}），總格${nr.zongGe.num}畫（${nr.zongGe.fortune.level}）。</p>`;
  }

  // 命理依據收合（進階使用者展開看）
  text+=`<details style="margin-top:1rem">
    <summary style="cursor:pointer;display:flex;align-items:center;gap:.5rem;color:var(--c-gold);font-size:.85rem;font-weight:600;padding:.5rem 0"><i class="fas fa-search" style="font-size:.75rem"></i> 查看六維度命理詳解</summary>
    <div style="padding:.8rem;margin-top:.3rem;background:rgba(0,0,0,.15);border-radius:var(--r-sm);border-left:3px solid rgba(212,175,55,.3);font-size:.88rem;line-height:1.8">${techText}</div>
  </details>`;

  // 綜合結論
  text+=`<div class="divider"></div>`;

  // 收集各維度摘要（人話）
  const dimTexts=[];
  // 八字
  if(curDy){
    const lv=curDy.level;
    if(lv.includes('旺盛')||lv.includes('極強')||lv.includes('上升')) dimTexts.push('十年大運走勢有利');
    else if(lv.includes('偏弱')||lv.includes('低迷')) dimTexts.push('十年大運走勢偏弱');
    else dimTexts.push('十年大運走勢平穩');
  }
  // 梅花
  if(mh){
    const relMap={'用生體':'外力助你（吉）','體生用':'付出多回報慢（小凶）','用克體':'外在有阻力（凶）','體克用':'你能掌控但費力（小吉）','比和':'內外一致（吉）'};
    dimTexts.push('當下能量場：'+(relMap[mh.ty.r]||mh.ty.f));
  }
  // 塔羅
  if(tarot.drawn.length>=10){
    const ta=analyzeTarotSpread(tarot.drawn, type);
    const oc=ta.keyCards.outcome;
    if(oc) dimTexts.push('最終走向：'+(oc.isUp?'正面':'需要調整'));
  }
  // 紫微
  if(S.ziwei){
    const zwDx=S.ziwei.daXian?S.ziwei.daXian.find(d=>d.isCurrent):null;
    if(zwDx){
      if(zwDx.level.includes('吉')||zwDx.level.includes('旺')||zwDx.level.includes('上升')) dimTexts.push('長期走勢有利');
      else if(zwDx.level.includes('凶')||zwDx.level.includes('弱')) dimTexts.push('長期走勢有壓力');
      else dimTexts.push('長期走勢平穩');
    }
  }
  // 星盤
  if(S.natal){
    const gA3=S.natal.aspects.filter(a=>a.good).length, bA3=S.natal.aspects.filter(a=>!a.good).length;
    if(gA3>bA3+1) dimTexts.push('星盤能量正面');
    else if(bA3>gA3+1) dimTexts.push('星盤有挑戰');
    else dimTexts.push('星盤吉凶均衡');
  }
  // 姓名
  if(S.zodiacNameResult){
    const _znLv=S.zodiacNameResult.overallLevel;
    if(_znLv.includes('吉')||_znLv.includes('旺')) dimTexts.push('姓名格局有利');
    else if(_znLv.includes('凶')) dimTexts.push('姓名格局有壓力');
    else dimTexts.push('姓名格局中性');
  }
  const dimSummary=dimTexts.length?dimTexts.join('；')+'。':'';

  // 綜合判斷已移至「核心能量定錨」區塊（act2-cards），此處不再重複

  return{text,factors,suggestions};
}

function renderCrystal(b){
  // ═══ 三級能量分層系統 ═══
  const CRYSTALS={
    金:[
      {n:'白水晶',icon:'💍',d:'淨化能量，收斂散亂，增強判斷力',tier:'entry',tierLabel:'入門共振'},
      {n:'黃鐵礦',icon:'✨',d:'強化意志金氣，穩固決策力',tier:'mid',tierLabel:'進階調頻'},
      {n:'鈦晶',icon:'👑',d:'極強正財磁場，金行能量密度最高，適合需要重大突破者',tier:'deep',tierLabel:'深度破局'}
    ],
    木:[
      {n:'綠月光',icon:'🌙',d:'溫和木行能量，適合日常磁場維護',tier:'entry',tierLabel:'入門共振'},
      {n:'東陵玉',icon:'🌿',d:'舒肝解鬱，中強度木行能量穩定釋放',tier:'mid',tierLabel:'進階調頻'},
      {n:'老山檀香圓珠',icon:'🪵',d:'高密度木行能量沉澱，深層疏通肝膽經絡，適合運勢重度停滯者',tier:'deep',tierLabel:'深度破局'}
    ],
    水:[
      {n:'藍紋瑪瑙',icon:'🔵',d:'穩定神經，平靜日常焦慮',tier:'entry',tierLabel:'入門共振'},
      {n:'海藍寶',icon:'💙',d:'增強溝通力與表達，中等水行能量',tier:'mid',tierLabel:'進階調頻'},
      {n:'拉利瑪',icon:'🌊',d:'頂級水行療癒石，深度修復情緒創傷，適合長期壓力累積者',tier:'deep',tierLabel:'深度破局'}
    ],
    火:[
      {n:'紅瑪瑙',icon:'❤️',d:'溫和暖局，激發日常行動力',tier:'entry',tierLabel:'入門共振'},
      {n:'石榴石',icon:'🔴',d:'提升活力與循環，中等火行驅動力',tier:'mid',tierLabel:'進階調頻'},
      {n:'天鐵',icon:'☄️',d:'極強火行能量，突破慣性僵局，適合急需重大轉變者',tier:'deep',tierLabel:'深度破局'}
    ],
    土:[
      {n:'黃水晶',icon:'💛',d:'穩固根基，增強日常安全感',tier:'entry',tierLabel:'入門共振'},
      {n:'虎眼石',icon:'🐅',d:'培土固本，強化決斷力與定力',tier:'mid',tierLabel:'進階調頻'},
      {n:'龍宮舍利',icon:'🐉',d:'極致土行能量，深度穩固靈體根基，適合根基嚴重動搖者',tier:'deep',tierLabel:'深度破局'}
    ]
  };
  
  // ═══ 智慧推薦引擎：調候優先 → 通關次之 → 梅花驗證 → 扶抑兜底 ═══
  let need=b.fav[0];
  let reasonDetail='';
  const ec=b.ec||{};
  const fav=b.fav||[], unfav=b.unfav||[];
  const waterS=(ec['水']||0), fireS=(ec['火']||0), woodS=(ec['木']||0), goldS=(ec['金']||0), earthS=(ec['土']||0);
  let useTiaohou=false;
  
  // Step 1: 調候邏輯（最高優先級）
  if(b.tiaohou && b.tiaohou.need && b.tiaohou.need.length){
    need=b.tiaohou.need[0];
    reasonDetail=`此命盤${b.tiaohou.reason||'需要調候'}。`;
    if(need==='火' && waterS>20) reasonDetail+=`水氣過旺（${Math.round(waterS)}分）導致行動力凍結，火能暖化水局、點燃執行力。`;
    else if(need==='土' && waterS>20) reasonDetail+=`水多氾濫根基不穩，土能築堤固本、穩定漂浮的能量。`;
    else reasonDetail+=`以${need}行調節命盤寒暖燥濕。`;
    useTiaohou=true;
  } else if(waterS>25 && fireS<8){
    need='火';
    reasonDetail=`命盤水氣極旺（${Math.round(waterS)}分）而火氣微弱（${Math.round(fireS)}分），屬「金寒水冷」格局。禁止再補水，必須用火暖局，解凍行動力與熱情。`;
    useTiaohou=true;
  } else if(woodS>25 && earthS<8){
    need='土';
    reasonDetail=`命盤木氣過旺（${Math.round(woodS)}分）土氣不足（${Math.round(earthS)}分），木多克土、根基鬆動。需用土培固根基。`;
    useTiaohou=true;
  } else if(fireS>25 && goldS<8){
    need='水';
    reasonDetail=`命盤火氣過旺（${Math.round(fireS)}分），過度消耗精神體力。水能降火潤燥、恢復冷靜。`;
    useTiaohou=true;
  }
  
  // Step 2: 梅花體用交叉驗證
  if(!useTiaohou && S.meihua){
    var mh2=S.meihua;
    var bodyEl2=mh2.bodyEl||mh2.ben.up;
    var useEl2=mh2.useEl||mh2.ben.dn;
    var rel2=mh2.ty?mh2.ty.r:'';
    if(rel2==='體生用'||rel2==='用克體'){
      var SHENG_R2={金:'土',木:'水',水:'金',火:'木',土:'火'};
      var bodyElN=typeof bodyEl2==='object'?bodyEl2.el:bodyEl2;
      if(bodyElN){
        var helpEl2=SHENG_R2[bodyElN]||bodyElN;
        var useElN=typeof useEl2==='object'?useEl2.el:useEl2;
        if(need===useElN && need!==bodyElN){
          need=helpEl2;
          reasonDetail=`梅花卦象顯示「${rel2}」，你的能量正被外部消耗。${useElN}行會加速消耗（禁用），改用${helpEl2}行生助你的本體能量（${bodyElN}行）。`;
        }
      }
    }
  }
  
  // Step 3: 扶抑兜底
  if(!reasonDetail){
    reasonDetail=`八字${b.strong?'身強':'身弱'}，喜用${fav.join('、')}行。${need}行能${b.strong?'洩化旺氣、導向有利方向':'補強本命根基、提升穩定度'}。`;
  }
  
  // ═══ 安全閥：確保推薦的五行不是忌神 ═══
  if(unfav.indexOf(need)!==-1){
    const oldNeed=need;
    need=fav[0];
    for(var fi=0;fi<fav.length;fi++){
      if(unfav.indexOf(fav[fi])===-1){ need=fav[fi]; break; }
    }
    reasonDetail=`八字${b.strong?'身強':'身弱'}，喜用${fav.join('、')}行。${need}行能${b.strong?'洩化旺氣、導向有利方向':'補強本命根基、提升穩定度'}。（${oldNeed}行雖有調候參考，但屬忌神，已自動修正。）`;
  }
  
  // ═══ 判定能量強度需求（決定推薦哪個 tier 為主推）═══
  // 運勢越差 → 越需要高階能量
  let urgency='normal'; // normal / elevated / critical
  const curDy3=b.dayun?b.dayun.find(function(d){return d.isCurrent;}):null;
  if(curDy3&&(curDy3.level.includes('低迷')||curDy3.level.includes('偏弱'))) urgency='elevated';
  if(useTiaohou) urgency='elevated';
  if(S.meihua&&S.meihua.ty&&(S.meihua.ty.r==='用克體')) urgency='critical';
  if(curDy3&&curDy3.level.includes('低迷')&&useTiaohou) urgency='critical';
  
  var recs3=CRYSTALS[need]||CRYSTALS['土'];
  const TIER_COLORS={entry:'rgba(74,222,128,.15)',mid:'rgba(212,175,55,.12)',deep:'rgba(239,68,68,.1)'};
  const TIER_BORDERS={entry:'rgba(74,222,128,.4)',mid:'rgba(212,175,55,.4)',deep:'rgba(239,68,68,.4)'};
  const TIER_LABELS={entry:'🟢 入門共振',mid:'🟡 進階調頻',deep:'🔴 深度破局'};
  const TIER_DESC={
    entry:'適合日常磁場維護，輕度補充'+need+'行能量。',
    mid:'中等能量密度，適合運勢偏弱期或特定痛點的針對性調理。',
    deep:'高密度能量沉澱，適合運勢重度停滯、急需重大突破、或命盤嚴重失衡者。'
  };

  var crystalHTML='';
  recs3.forEach(function(c){
    var isRec=(urgency==='critical'&&c.tier==='deep')||(urgency==='elevated'&&c.tier==='mid')||(urgency==='normal'&&c.tier==='entry');
    crystalHTML+='<div style="padding:.8rem;border-radius:10px;border:1.5px solid '+TIER_BORDERS[c.tier]+';background:'+TIER_COLORS[c.tier]+';margin-bottom:.5rem;'+(isRec?'box-shadow:0 0 8px '+TIER_BORDERS[c.tier]:'')+'">';
    crystalHTML+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">';
    crystalHTML+='<span style="font-size:1.4rem">'+c.icon+'</span>';
    crystalHTML+='<span style="font-weight:700;font-size:.95rem;color:var(--c-text)">'+c.n+'</span>';
    crystalHTML+='<span style="font-size:.7rem;padding:2px 8px;border-radius:20px;border:1px solid '+TIER_BORDERS[c.tier]+';color:var(--c-text-dim)">'+TIER_LABELS[c.tier]+'</span>';
    if(isRec) crystalHTML+='<span style="font-size:.68rem;padding:2px 6px;border-radius:20px;background:var(--c-gold);color:#1a0a00;font-weight:700">命盤推薦</span>';
    crystalHTML+='</div>';
    crystalHTML+='<p class="text-sm" style="color:var(--c-text-dim);line-height:1.5;margin:0">'+c.d+'</p>';
    crystalHTML+='</div>';
  });

  document.getElementById('r-crystal').innerHTML=`
    <p class="mb-sm" style="font-size:.95rem;line-height:1.7">建議補強 <span class="tag tag-gold" style="font-size:1rem;padding:.3rem .7rem">${need}行</span></p>
    <div style="margin:.5rem 0 .8rem;padding:.5rem .8rem;background:rgba(212,175,55,.06);border-left:3px solid rgba(212,175,55,.3);border-radius:0 6px 6px 0">
      <p class="text-sm" style="line-height:1.7;color:var(--c-text)">${reasonDetail}</p>
    </div>
    <div style="display:flex;flex-direction:column;gap:0">${crystalHTML}</div>
    <div style="margin-top:.6rem;padding:.4rem .6rem;background:rgba(255,255,255,.03);border-radius:6px;font-size:.72rem;color:var(--c-text-muted);line-height:1.5">
      <p>🟢 <strong>入門共振</strong>：${TIER_DESC.entry}</p>
      <p>🟡 <strong>進階調頻</strong>：${TIER_DESC.mid}</p>
      <p>🔴 <strong>深度破局</strong>：${TIER_DESC.deep}</p>
    </div>
    <p class="text-xs text-muted mt-sm"><i class="fas fa-info-circle"></i> 本推薦整合調候、通關、梅花體用三重驗證，僅供能量校準參考。</p>`;
}

function generateConclusion(type,prob,bazi,mh,tarot){
  const el=bazi.dmEl,strong=bazi.strong,dm=bazi.dm;
  const curDy=bazi.dayun?bazi.dayun.find(d=>d.isCurrent):null;
  const fav=bazi.fav||[];
  const typeLabel={'love':'愛情','career':'事業','wealth':'財運','health':'健康','general':'綜合運勢','relationship':'人際','family':'家庭','other':'所問之事'}[type]||'所問之事';

  let html='';

  // 八字總結
  html+=`<p><strong class="text-gold">一、八字命理</strong>：「${dm}${bazi.pillars?bazi.pillars.day.zhi:''}」日主，${el}行，身${strong?'強':'弱'}。`;
  if(fav.length) html+=`喜用${fav.join('、')}行。`;
  if(curDy){
    html+=`目前走 ${curDy.gz} 大運（${curDy.level}），`;
    if(curDy.level.includes('極強')) html+=`這步大運是你最好的運勢週期，問${typeLabel}正是好時機。`;
    else if(curDy.level.includes('旺盛')||curDy.level.includes('上升')) html+=`運勢偏好，${typeLabel}方面有外在助力。`;
    else if((curDy.level.includes('偏弱')||curDy.level.includes('低迷')||curDy.level.includes('補運'))) html+=`運勢帶阻力，${typeLabel}方面需要比平常更謹慎。`;
    else html+=`運勢平穩，${typeLabel}方面不會有大起大落。`;
  }
  html+=`</p>`;

  // 紫微總結
  if(S.ziwei){
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
    const gongIdx=typeToGong[type]!==undefined?typeToGong[type]:0;
    const gongName=typeof ZW_PALACES!=='undefined'?ZW_PALACES[gongIdx]:'命宮';
    const gongStars=S.ziwei.palaces[gongIdx]?S.ziwei.palaces[gongIdx].stars:[];
    html+=`<p class="mt-sm"><strong class="text-gold">二、紫微斗數</strong>：`;
    // 命宮主星
    const cMing=S.ziwei.palaces[0]?S.ziwei.palaces[0].stars.filter(s=>s.type==='major'):[];
    if(cMing.length) html+=`命宮${cMing.map(s=>s.name).join('、')}坐守。`;
    // 問題宮
    if(gongStars.length&&gongIdx!==0){
      html+=`${gongName}有 `;
      html+=gongStars.slice(0,4).map(s=>s.name+(s.bright?`(${s.bright})`:'')+(s.hua?` ${s.hua}`:'')).join('、');
      const hasLu=gongStars.some(s=>s.hua==='化祿');
      const hasJi=gongStars.some(s=>s.hua==='化忌');
      if(hasLu) html+=`。化祿入${gongName}，${typeLabel}有先天福氣。`;
      else if(hasJi) html+=`。化忌入${gongName}，${typeLabel}方面需多花心力。`;
      else html+=`。`;
    }
    // 大限
    const cDx=S.ziwei.daXian?S.ziwei.daXian.find(d=>d.isCurrent):null;
    if(cDx){
      html+=`大限走「${cDx.palaceName}」（${cDx.level}）`;
      if(cDx.theme) html+='，十年主題：'+cDx.theme;
      html+='。';
    }
    // 流年
    const _cy=new Date().getFullYear();
    if(S.ziwei.getLiuNianZw){
      try{
        const cLn=S.ziwei.getLiuNianZw(_cy);
        if(cLn) html+=`${_cy}流年命宮走「${cLn.mingPalace}」${cLn.focus?'，重點：'+cLn.focus:''}。`;
      }catch(e){}
    }
    html+=`</p>`;
  }

  // 梅花總結
  if(mh){
    html+=`<p class="mt-sm"><strong class="text-gold">三、梅花易數</strong>：本卦「${mh.ben.n}」（${mh.ben.m||''}）→ 變卦「${mh.bian.n}」（${mh.bian.m||''}）。`;
    html+=`體用 ${mh.ty.r}，判為「${mh.ty.f}」。`;
    if(mh.ty.d) html+=mh.ty.d;
    if(mh.hu&&mh.hu.m) html+=` 互卦「${mh.hu.n}」顯示過程${mh.hu.m.includes('順')||mh.hu.m.includes('通')||mh.hu.m.includes('利')?'順利':'需耐心'}。`;
    // 動爻
    if(mh.dong&&mh.ben&&typeof getYaoCi==='function'){
      const yc3=getYaoCi(mh.ben.n, mh.dong);
      if(yc3&&!yc3.includes('擴充中')) html+=` 動爻（第${mh.dong}爻）：${yc3}`;
    }
    // 問題解讀
    if(typeof getMeihuaTypeReading==='function'){
      const tr3=getMeihuaTypeReading(mh, type);
      if(tr3&&tr3.reading) html+=`<br>📋 ${tr3.reading}`;
    }
    html+=`</p>`;
  }

  // 塔羅詳細總結
  if(tarot.drawn.length>=10){
    const posNames=['核心現狀','阻礙因素','過去基礎','未來發展','可能結果','近期未來','自我態度','環境影響','希望恐懼','最終結果'];
    html+=`<p class="mt-sm"><strong class="text-gold">四、塔羅牌陣（凱爾特十字）</strong>：</p>`;
    html+=`<div style="font-size:0.9rem;line-height:1.7;margin:0.5rem 0">`;
    tarot.drawn.forEach((c,i)=>{
      const dir=c.isUp?'正位':'逆位';
      const _typeMn=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(c.id,c.isUp,type):null;
      const meaning=_typeMn||(c.isUp?c.up:c.rv);
      const isKey=[0,1,3,4,9].includes(i);
      html+=`<p style="margin:0.25rem 0;${isKey?'font-weight:600':'opacity:0.85'}">`;
      html+=`<span class="tag ${c.isUp?'tag-blue':'tag-red'}" style="font-size:0.75rem">${dir}</span> `;
      html+=`<strong>${i+1}.${posNames[i]}</strong>：${c.n} — ${meaning}`;
      html+=`</p>`;
    });
    html+=`</div>`;
    // Celtic Cross 系統分析摘要
    const _dd=tarot.drawn;
    const _core=_dd[0],_chal=_dd[1],_subcon=_dd[2],_conscious=_dd[4],_self=_dd[6],_env=_dd[7],_hf=_dd[8],_out=_dd[9],_near=_dd[5];
    html+=`<div class="text-sm" style="margin-top:.5rem;padding:.5rem;background:rgba(212,175,55,0.05);border-radius:6px;line-height:1.7">`;
    html+=`<p><strong>核心主軸</strong>（①+②）：現況「${_core.n} ${_core.isUp?'正':'逆'}」＋阻礙「${_chal.n} ${_chal.isUp?'正':'逆'}」</p>`;
    html+=`<p><strong>心理狀態</strong>（③+⑤+⑨）：潛意識「${_subcon.n}」${_subcon.isUp===_conscious.isUp?' 與意識目標一致':' ⚡與意識目標矛盾'}，希望恐懼「${_hf.n} ${_hf.isUp?'正':'逆'}」</p>`;
    html+=`<p><strong>時間走向</strong>（④→⑥）：近期走「${_near.n} ${_near.isUp?'正位（順利）':'逆位（有阻力）'}」</p>`;
    html+=`<p><strong>現實條件</strong>（⑦+⑧）：自身「${_self.n} ${_self.isUp?'正位（狀態好）':'逆位（需調整）'}」，環境「${_env.n} ${_env.isUp?'正位（有利）':'逆位（有壓力）'}」</p>`;
    html+=`<p><strong>結果走向</strong>（⑩）：「${_out.n} ${_out.isUp?'正位':'逆位'}」— ${_out.isUp?_out.up:_out.rv}${_out.isUp?'':'（結果可透過調整前面步驟來改變）'}</p>`;
    // 牌組元素分析
    const _sc={major:0,wands:0,cups:0,swords:0,pent:0};
    _dd.slice(0,10).forEach(function(c){
      if(c.id<=21)_sc.major++;else if(c.id<=35)_sc.wands++;else if(c.id<=49)_sc.cups++;else if(c.id<=63)_sc.swords++;else _sc.pent++;
    });
    const _mx=Object.entries(_sc).sort(function(a,b){return b[1]-a[1];})[0];
    if(_mx[1]>=3){
      const _sl={major:'大牌多→命運級事件',wands:'權杖多→行動/事業是主軸',cups:'聖杯多→情感面是關鍵',swords:'寶劍多→壓力/思慮/糾結',pent:'錢幣多→現實/財務面'};
      html+=`<p style="color:var(--c-gold)">📊 牌組特徵：${_sl[_mx[0]]||''}</p>`;
    }
    html+=`</div>`;
  }

  // 姓名學
  if(S.nameResult){
    const nr=S.nameResult;
    html+=`<p class="mt-sm"><strong class="text-gold">五、姓名學</strong>：`;
    // 生肖派
    if(S.zodiacNameResult){
      const zn=S.zodiacNameResult;
      html+=`${zn.emoji}${zn.zodiac}年【${zn.overallLevel}】`;
      if(zn.isSacrifice) html+=` <span style="color:var(--c-danger)">⚠犧牲格</span>`;
      html+=`。`;
    }
    // 三才五格
    html+=`三才 ${nr.sanCaiLevel}`;
    if(nr.renGe) html+=`，人格 ${nr.renGe.num}畫（${nr.renGe.fortune.level}）`;
    html+=`。</p>`;
  }

  // ═══ 多維度命理衝突仲裁引擎 ═══
  html+=`<div class="divider"></div>`;
  const _vd=S._verdictDir||'mid';
  const _vArr=S._verdicts||[];
  const _posN=_vArr.filter(v=>v.dir==='pos').length, _negN=_vArr.filter(v=>v.dir==='neg').length;
  
  // 收集各維度正負訊號
  let baziSignal='mid', zwSignal='mid', mhSignal='mid', tarotSignal='mid';
  if(curDy){
    if(curDy.level.includes('極強')||curDy.level.includes('旺盛')||curDy.level.includes('上升')) baziSignal='pos';
    else if(curDy.level.includes('偏弱')||curDy.level.includes('低迷')) baziSignal='neg';
  }
  if(S.ziwei){
    const tgIdx2={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0}[type]||0;
    const tgS2=S.ziwei.palaces[tgIdx2]?S.ziwei.palaces[tgIdx2].stars:[];
    if(tgS2.some(s=>s.hua==='化祿')) zwSignal='pos';
    else if(tgS2.some(s=>s.hua==='化忌')||tgS2.some(s=>s.type==='sha')) zwSignal='neg';
  }
  if(mh) mhSignal=mh.ty.f.includes('吉')?'pos':mh.ty.f.includes('凶')?'neg':'mid';
  if(tarot.drawn.length>=10){
    const _out2=tarot.drawn[9], _near2=tarot.drawn[5], _chal2=tarot.drawn[1];
    tarotSignal=_out2.isUp&&_near2.isUp?'pos':!_out2.isUp?'neg':'mid';
  }
  
  // 衝突分析
  const signals={八字:baziSignal,紫微:zwSignal,梅花:mhSignal,塔羅:tarotSignal};
  const posDims=Object.entries(signals).filter(([k,v])=>v==='pos').map(([k])=>k);
  const negDims=Object.entries(signals).filter(([k,v])=>v==='neg').map(([k])=>k);
  const hasConflict=posDims.length>0 && negDims.length>0;
  
  let goldAdvice='';
  if(hasConflict){
    // 先揚後抑：承認吉象但帶入凶象作為條件
    goldAdvice=`綜合來看，你目前的${typeLabel}底蘊${prob>=55?'是不錯的':'有一定基礎'}（${posDims.join('、')}維度偏正面）。`;
    // 帶入具體的凶象解釋
    if(negDims.includes('塔羅')&&tarot.drawn.length>=10){
      const _ch3=tarot.drawn[1];
      const chTM=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(_ch3.id,_ch3.isUp,type):null;
      goldAdvice+=`但在實際推進上，容易因為${chTM||((_ch3.isUp?_ch3.up:_ch3.rv)||'').slice(0,20)}而產生阻力`;
      if(negDims.includes('紫微')) goldAdvice+=`（呼應紫微宮位也有煞星壓力）`;
      goldAdvice+=`。`;
    } else if(negDims.includes('梅花')){
      goldAdvice+=`但梅花卦象（${mh.ty.r}，${mh.ty.f}）顯示短期能量消耗偏大，需要節制。`;
    } else {
      goldAdvice+=`但${negDims.join('、')}維度有壓力訊號，不宜操之過急。`;
    }
    goldAdvice+=`因此，真正的挑戰不在於有沒有機會，而在於你能不能`;
    if(type==='love') goldAdvice+=`保持耐心、不急於定義關係，讓感情自然發展`;
    else if(type==='career') goldAdvice+=`控制節奏、把握關鍵時機再全力出手`;
    else if(type==='wealth') goldAdvice+=`在看到機會時仍保持紀律，不被貪念驅動`;
    else goldAdvice+=`在行動中保持彈性，遇到阻力時調整策略而非硬衝`;
    goldAdvice+=`。`;
  } else if(_vd==='pos'||posDims.length>=3){
    goldAdvice=`多數維度判斷一致偏正面，${typeLabel}方面時機不錯。建議積極但有節制地行動。`;
  } else if(_vd==='neg'||negDims.length>=3){
    goldAdvice=`多數維度判斷偏保守，${typeLabel}目前阻力較大。建議先做充分準備，等待更好時機再全力投入。`;
  } else {
    goldAdvice=`各維度訊號混合，${typeLabel}有空間但需要策略性推進。分步驟執行、先做小範圍測試。`;
  }
  if(fav[0]) goldAdvice+=`日常可搭配${fav[0]}行能量輔助。`;
  html+=`<p class="serif text-gold" style="font-size:1.05rem;line-height:1.8"><i class="fas fa-star"></i> ${goldAdvice}</p>`;

  return html;
}
/* =============================================================
   紫微斗數 ZIWEI DOUSHU — 核心邏輯（自寫，不依賴 iztro）
   ============================================================= */
const ZW_PALACES=['命宮','兄弟','夫妻','子女','財帛','疾厄','遷移','交友','官祿','田宅','福德','父母'];

// 14 主星
const ZW_MAJOR=[
  {id:0,name:'紫微',el:'土',yin:true,bright:['廟','旺','得地','利','平','不得','落陷'],nature:'帝星，尊貴，領導力'},
  {id:1,name:'天機',el:'木',yin:true,nature:'智慧，策劃，善變'},
  {id:2,name:'太陽',el:'火',yin:false,nature:'光明正大，貴人，男性'},
  {id:3,name:'武曲',el:'金',yin:false,nature:'財星，剛毅，果斷'},
  {id:4,name:'天同',el:'水',yin:true,nature:'福星，安逸，溫和'},
  {id:5,name:'廉貞',el:'火',yin:false,nature:'囚星，桃花，複雜'},
  {id:6,name:'天府',el:'土',yin:true,nature:'財庫，穩重，保守'},
  {id:7,name:'太陰',el:'水',yin:true,nature:'財星，女性，細膩'},
  {id:8,name:'貪狼',el:'木',yin:false,nature:'桃花，才藝，慾望'},
  {id:9,name:'巨門',el:'水',yin:true,nature:'口舌，暗星，是非'},
  {id:10,name:'天相',el:'水',yin:true,nature:'印星，輔佐，衣食'},
  {id:11,name:'天梁',el:'土',yin:true,nature:'蔭星，清高，化解'},
  {id:12,name:'七殺',el:'金',yin:false,nature:'將星，衝勁，變動'},
  {id:13,name:'破軍',el:'水',yin:false,nature:'耗星，開創，破壞'}
];

// 6 吉星
const ZW_LUCKY=['文昌','文曲','左輔','右弼','天魁','天鉞'];
// 4 煞星
const ZW_SHA=['擎羊','陀羅','火星','鈴星'];

// ═══ 14主星廟旺利平陷表（業界標準）═══
// 地支順序: 子丑寅卯辰巳午未申酉戌亥 (0-11)
// 值: 4=廟, 3=旺, 2=得地/利, 1=平, 0=不得/落陷
const STAR_BRIGHT={
  紫微:[1,3,2,1,3,2,4,3,2,1,3,2],    // 午廟,丑未旺
  天機:[2,0,3,4,1,2,0,3,4,1,2,3],    // 卯廟,寅申旺
  太陽:[0,1,2,3,3,4,4,3,2,1,0,0],    // 巳午廟,卯辰旺（日出日落）
  武曲:[2,4,1,0,3,1,2,4,1,0,3,1],    // 丑未廟,辰戌旺
  天同:[3,1,0,2,1,0,3,2,1,4,1,2],    // 子廟,酉旺
  廉貞:[1,0,3,1,2,4,2,0,3,1,2,3],    // 巳廟,寅申旺
  天府:[2,1,3,1,2,4,3,1,2,3,1,2],    // 巳午廟,寅戌旺
  太陰:[4,3,2,1,0,0,0,1,2,3,3,4],    // 子亥廟,丑酉旺（夜晚明亮）
  貪狼:[2,1,4,1,2,1,3,1,4,1,2,1],    // 寅申廟,午旺
  巨門:[2,1,3,4,1,2,0,1,3,4,1,2],    // 卯酉廟,寅申旺
  天相:[2,1,3,1,2,4,2,1,3,1,2,3],    // 巳廟,寅申旺
  天梁:[1,2,3,4,3,2,1,2,3,1,2,1],    // 卯廟,辰旺
  七殺:[2,1,3,1,2,4,3,1,3,1,2,1],    // 巳午廟,寅申旺
  破軍:[2,3,1,0,3,1,2,3,1,0,3,1]     // 丑未廟,辰戌旺
};
// 吉星/煞星廟旺表
const STAR_BRIGHT_EX={
  文昌:[3,1,0,2,1,4,4,1,0,2,1,3],    // 巳午廟
  文曲:[2,3,1,0,3,1,2,3,1,0,3,1],    // 丑未廟
  左輔:[4,3,2,1,3,2,4,3,2,1,3,2],    // 子午廟
  右弼:[4,3,2,1,3,2,4,3,2,1,3,2],    // 子午廟
  天魁:[1,4,2,1,3,1,1,4,2,1,3,1],    // 丑未廟
  天鉞:[1,4,2,1,3,1,1,4,2,1,3,1],    // 丑未廟
  祿存:[2,3,4,2,1,3,2,3,4,2,1,3],    // 寅申廟
  天馬:[2,1,3,1,2,1,2,1,3,1,2,1],    // 寅申廟
  擎羊:[1,2,3,4,2,1,1,2,3,4,2,1],    // 卯酉廟(陷)
  陀羅:[1,2,4,3,2,1,1,2,4,3,2,1],    // 辰戌廟(陷)
  火星:[2,1,3,1,2,4,2,1,3,1,2,1],    // 巳廟
  鈴星:[2,1,3,1,2,1,2,4,3,1,2,1]     // 午廟
};
const BRIGHT_LABEL={4:'廟',3:'旺',2:'得地',1:'平',0:'落陷'};
const BRIGHT_SCORE={4:3, 3:2, 2:1, 1:0, 0:-2}; // 廟=+3, 旺=+2, 得地=+1, 平=0, 落陷=-2

// 取得星曜在某宮位的亮度
function getStarBright(starName, branchIdx){
  const table=STAR_BRIGHT[starName]||STAR_BRIGHT_EX[starName];
  if(!table) return {label:'平', score:0};
  const val=table[branchIdx]||1;
  return {label:BRIGHT_LABEL[val]||'平', score:BRIGHT_SCORE[val]||0, val};
}

// ═══ 宮位吉凶綜合分析函數 ═══
// 分析一個宮位裡所有星曜的組合效果
function analyzePalace(palace, branchIdx){
  if(!palace||!palace.stars) return {score:0,notes:[],bright:[]};
  let score=0, notes=[], bright=[];
  const stars=palace.stars;
  const majors=stars.filter(s=>s.type==='major');
  const luckys=stars.filter(s=>['lucky','minor'].includes(s.type));
  const shas=stars.filter(s=>s.type==='sha');

  // 1. 主星亮度評分
  majors.forEach(s=>{
    const b=getStarBright(s.name, branchIdx);
    bright.push({star:s.name, ...b});
    score+=b.score;
    if(b.val>=3) notes.push(s.name+b.label+'（力量強）');
    if(b.val===0) notes.push(s.name+'落陷（力量弱，反凶）');
  });

  // 1b. 乙級星影響
  const minor2s=stars.filter(s=>s.type==='minor2');
  minor2s.forEach(s=>{
    if(s.name==='紅鸞'||s.name==='天喜'||s.name==='咸池'||s.name==='天姚'){score+=0.3;notes.push(s.name+'（桃花星）');}
    if(s.name==='華蓋'){notes.push('華蓋（孤高、宗教緣）');}
    if(s.name==='天刑'){score-=0.3;notes.push('天刑（刑剋、法律）');}
    if(s.name==='天哭'||s.name==='天虛'){score-=0.2;}
    if(s.name==='天德'||s.name==='天福'||s.name==='天官'||s.name==='天貴'||s.name==='恩光'){score+=0.3;}
    if(s.name==='解神'){score+=0.2;notes.push('解神（化解厄運）');}
    if(s.name==='龍池'||s.name==='鳳閣'){score+=0.2;}
  });

  // 2. 吉星組合加分
  const luckyNames=luckys.map(s=>s.name);
  if(luckyNames.includes('左輔')||luckyNames.includes('右弼')){score+=1.5;notes.push('輔弼夾持，有人助力');}
  if(luckyNames.includes('天魁')||luckyNames.includes('天鉞')){score+=1.5;notes.push('魁鉞貴人，逢凶化吉');}
  if(luckyNames.includes('文昌')||luckyNames.includes('文曲')){score+=1;notes.push('昌曲文運，利考試名聲');}
  if(luckyNames.includes('祿存')){score+=2;notes.push('祿存同宮，財祿豐厚');}
  if(luckyNames.includes('天馬')&&luckyNames.includes('祿存')){score+=1;notes.push('祿馬交馳，財源滾滾');}

  // 3. 煞星組合扣分
  const shaNames=shas.map(s=>s.name);
  shas.forEach(s=>{
    score-=1.5;
    if(s.name==='擎羊') notes.push('擎羊同宮，易有衝突刑傷');
    if(s.name==='陀羅') notes.push('陀羅同宮，拖延纏繞');
    if(s.name==='火星') notes.push('火星同宮，突發變動');
    if(s.name==='鈴星') notes.push('鈴星同宮，暗中不利');
  });

  // 4. 特殊組合
  // 火貪/鈴貪格（突然發財）
  if(majors.some(s=>s.name==='貪狼')&&(shaNames.includes('火星')||shaNames.includes('鈴星'))){
    const b=bright.find(x=>x.star==='貪狼');
    if(b&&b.val>=2){score+=3;notes.push('火貪/鈴貪格，突發暴利之兆');}
  }
  // 殺破狼（變動格局）
  const sbw=majors.filter(s=>['七殺','破軍','貪狼'].includes(s.name));
  if(sbw.length>=2){notes.push('殺破狼匯聚，人生大變動期');}
  // 府相朝垣（穩定格局）
  if(majors.some(s=>s.name==='天府')&&majors.some(s=>s.name==='天相')){score+=2;notes.push('府相朝垣，格局穩健');}
  // 巨門+化忌（口舌是非）
  const juMen=stars.find(s=>s.name==='巨門');
  if(juMen&&juMen.hua==='化忌'){score-=2;notes.push('巨門化忌，口舌是非不斷');}
  // 廉貞+化忌（牢獄之災的象徵）
  const lianZhen=stars.find(s=>s.name==='廉貞');
  if(lianZhen&&lianZhen.hua==='化忌'){score-=2;notes.push('廉貞化忌，官非纏身注意法律');}

  // 5. 四化加分
  stars.forEach(s=>{
    if(s.hua==='化祿'){score+=2;notes.push(s.name+'化祿，此宮有福氣');}
    if(s.hua==='化權'){score+=1;notes.push(s.name+'化權，有掌控力');}
    if(s.hua==='化科'){score+=1;notes.push(s.name+'化科，貴人名聲');}
    if(s.hua==='化忌'&&!['巨門','廉貞'].includes(s.name)){score-=2;notes.push(s.name+'化忌，此宮有阻礙');}
  });

  return {score, notes, bright, majorCount:majors.length, luckyCount:luckys.length, shaCount:shas.length};
}
// 4 化
const ZW_HUA=['化祿','化權','化科','化忌'];

// 四化表 (依年干)
const SIHUA_TABLE={
  甲:{祿:'廉貞',權:'破軍',科:'武曲',忌:'太陽'},
  乙:{祿:'天機',權:'天梁',科:'紫微',忌:'太陰'},
  丙:{祿:'天同',權:'天機',科:'文昌',忌:'廉貞'},
  丁:{祿:'太陰',權:'天同',科:'天機',忌:'巨門'},
  戊:{祿:'貪狼',權:'太陰',科:'右弼',忌:'天機'},
  己:{祿:'武曲',權:'貪狼',科:'天梁',忌:'文曲'},
  庚:{祿:'太陽',權:'武曲',科:'太陰',忌:'天同'},
  辛:{祿:'巨門',權:'太陽',科:'文曲',忌:'文昌'},
  壬:{祿:'天梁',權:'紫微',科:'左輔',忌:'武曲'},
  癸:{祿:'破軍',權:'巨門',科:'太陰',忌:'貪狼'}
};

// 天府星位置（與紫微以寅-申軸對稱）
function getTianfuIdx(ziweiIdx){
  return (4 - ziweiIdx + 12) % 12;
}

// 農曆轉換（簡化：用地支捨算近似農曆月日）
function approxLunar(y,m,d){
  // ✅ 精準農曆換算（1900-2100常用表算法）
  // 回傳：{month, day, isLeap, year}
  try{
    const LUNAR_INFO=[
      0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,
      0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,
      0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,
      0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,
      0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,
      0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,
      0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,
      0x05b57,0x056a0,0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,
      0x0b5a0,0x195a6,0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,
      0x0ab60,0x09570,0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x05ac0,0x0ab60,
      0x096d5,0x092e0,0x0c960,0x0d954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,
      0x092d0,0x0cab5,0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,
      0x052b0,0x0a930,0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,
      0x0ea65,0x0d530,0x05aa0,0x076a3,0x096d0,0x04bd7,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,
      0x0d520,0x0dd45,0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,
      0x06d20,0x0ada0,0x14b63
    ];
    const baseDate = new Date(1900,0,31); // 1900-01-31 為農曆 1900 正月初一
    const objDate = new Date(y, m-1, d);
    let offset = Math.floor((objDate - baseDate)/86400000);
    let lunarYear = 1900;

    function leapMonth(ly){ return LUNAR_INFO[ly-1900] & 0xf; }
    function leapDays(ly){
      const lm = leapMonth(ly);
      if(lm){ return (LUNAR_INFO[ly-1900] & 0x10000) ? 30 : 29; }
      return 0;
    }
    function monthDays(ly, lm){ return (LUNAR_INFO[ly-1900] & (0x10000 >> lm)) ? 30 : 29; }
    function yearDays(ly){
      let sum=348;
      const info=LUNAR_INFO[ly-1900];
      for(let i=0x8000;i>0x8;i>>=1){ sum += (info & i) ? 1 : 0; }
      return sum + leapDays(ly);
    }

    while(lunarYear<2101 && offset >= yearDays(lunarYear)){
      offset -= yearDays(lunarYear);
      lunarYear++;
    }

    let lunarMonth = 1;
    let isLeap=false;
    const lm = leapMonth(lunarYear);

    while(true){
      let md;
      if(lm && lunarMonth===lm+1 && !isLeap){
        isLeap=true;
        md = leapDays(lunarYear);
        lunarMonth--; // 重複該月作閏月
      } else {
        md = monthDays(lunarYear, lunarMonth);
      }
      if(offset < md) break;
      offset -= md;

      if(isLeap && lunarMonth===lm){ isLeap=false; }
      lunarMonth++;
    }

    const lunarDay = offset + 1;
    return {year:lunarYear, month:lunarMonth, day:lunarDay, isLeap:isLeap};
  }catch(e){
    console.warn('Lunar conversion failed:', e);
    return null;
  }
}

function computeZiwei(year,month,day,hour,gender){
  const lunar = approxLunar(year,month,day);
  const yGan = TG[((year-4)%10+10)%10];
  const yZhi = DZ[((year-4)%12+12)%12];

  // 命宮地支：月支-時支
  const shi = Math.floor(((hour+1)%24)/2);
  const mingIdx = ((lunar.month - shi + 13) % 12 + 12) % 12; // 修正: +13 (正月子時=寅)
  // 身宮：月+時+寅基
  const shenIdx = ((lunar.month + shi + 1) % 12 + 12) % 12;

  // 五行局 (簡化：依命宮天干地支組合)
  // 宮干：年干起月法 (甲己→丙寅=2, 乙庚→戊寅=4, 丙辛→庚寅=6, 丁壬→壬寅=8, 戊癸→甲寅=0)
  const ganBase={'甲':2,'己':2,'乙':4,'庚':4,'丙':6,'辛':6,'丁':8,'壬':8,'戊':0,'癸':0};
  const gBase=ganBase[yGan]||0;
  const mingGanIdx=(gBase+((mingIdx-2+12)%12))%10;
  const mingGan = TG[mingGanIdx];
  const wuxingJu = getWuxingJu(mingGan, DZ[mingIdx]);

  // 安紫微星
  const ziweiIdx = getZiweiPalaceByJu(wuxingJu, lunar.day);
  // 天府位置: 與紫微以寅-申軸對稱
  // 紫微寅(2)→天府寅(2), 紫微卯(3)→天府丑(1), 紫微辰(4)→天府子(0)...
  const tianfuIdx = ((4 - ziweiIdx + 12) % 12 + 12) % 12;

  // 建立12宮 (逆時針排列: 命→兄弟→夫妻→子女→...)
  const palaces = [];
  for(let i=0;i<12;i++){
    const pIdx = ((mingIdx - i) % 12 + 12) % 12;
    palaces.push({
      name: ZW_PALACES[i],
      branch: DZ[pIdx],
      stars: [],
      isMing: i===0,
      isShen: pIdx === shenIdx
    });
  }

  // 安14主星（簡化排列）
  const ziweiOrder = [0,1,null,2,3,4,5]; // 紫微系
  const tianfuOrder = [6,7,8,9,10,11,12,13]; // 天府系

  // 紫微系安星
  const zwStarMap = [
    {star:0, offset:0},  // 紫微
    {star:1, offset:-1}, // 天機
    {star:2, offset:-3}, // 太陽
    {star:3, offset:-4}, // 武曲
    {star:4, offset:-5}, // 天同
    {star:5, offset:4}   // 廉貞（紫微逆8位=+4）
  ];
  zwStarMap.forEach(({star,offset})=>{
    const pos = ((ziweiIdx + offset) % 12 + 12) % 12;
    const palaceIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === pos);
    if(palaceIdx>=0) palaces[palaceIdx].stars.push({...ZW_MAJOR[star], type:'major'});
  });

  // 天府系安星
  const tfStarMap = [
    {star:6, offset:0},   // 天府
    {star:7, offset:1},   // 太陰
    {star:8, offset:2},   // 貪狼
    {star:9, offset:3},   // 巨門
    {star:10, offset:4},  // 天相
    {star:11, offset:5},  // 天梁
    {star:12, offset:6},  // 七殺
    {star:13, offset:10}  // 破軍
  ];
  tfStarMap.forEach(({star,offset})=>{
    const pos = ((tianfuIdx + offset) % 12 + 12) % 12;
    const palaceIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === pos);
    if(palaceIdx>=0) palaces[palaceIdx].stars.push({...ZW_MAJOR[star], type:'major'});
  });

  // 安吉星（簡化）
  const wcIdx = ((year-4)%12+12)%12;
  addStarToPalace(palaces,'文昌','minor',(10-shi+12)%12);
  addStarToPalace(palaces,'文曲','minor',(shi+4)%12);
  addStarToPalace(palaces,'左輔','minor',(lunar.month+3)%12);
  addStarToPalace(palaces,'右弼','minor',(11-lunar.month+12)%12);

  // 安煞星（業界標準查表法）
  const yZhiIdx = DZ.indexOf(yZhi);
  
  // 擎羊陀羅：依年干查表（標準安星法）
  // 擎羊在祿存後一位，陀羅在祿存前一位
  const QY_TABLE={甲:3,乙:4,丙:6,丁:7,戊:6,己:7,庚:9,辛:10,壬:0,癸:1};
  const TL_TABLE={甲:1,乙:2,丙:4,丁:5,戊:4,己:5,庚:7,辛:8,壬:10,癸:11};
  addStarToPalace(palaces,'擎羊','sha',QY_TABLE[yGan]!==undefined?QY_TABLE[yGan]:3);
  addStarToPalace(palaces,'陀羅','sha',TL_TABLE[yGan]!==undefined?TL_TABLE[yGan]:1);

  // 火星：依年支分組+時支查表
  // 寅午戌年從丑(1)起，申子辰年從寅(2)起，巳酉丑年從卯(3)起，亥卯未年從酉(9)起
  const HX_BASE={寅:1,午:1,戌:1, 申:2,子:2,辰:2, 巳:3,酉:3,丑:3, 亥:9,卯:9,未:9};
  const hxBase=HX_BASE[yZhi]!==undefined?HX_BASE[yZhi]:2;
  addStarToPalace(palaces,'火星','sha',(hxBase+shi)%12);

  // 鈴星：依年支分組+時支查表
  // 寅午戌年從卯(3)起，申子辰年從戌(10)起，巳酉丑年從戌(10)起，亥卯未年從戌(10)起
  const LX_BASE={寅:3,午:3,戌:3, 申:10,子:10,辰:10, 巳:10,酉:10,丑:10, 亥:10,卯:10,未:10};
  const lxBase=LX_BASE[yZhi]!==undefined?LX_BASE[yZhi]:10;
  addStarToPalace(palaces,'鈴星','sha',(lxBase+shi)%12);

  // 安天魁天鉞（依年干·業界標準）
  // 甲戊庚→魁丑(1)鉞未(7), 乙己→魁子(0)鉞申(8), 丙丁→魁亥(11)鉞酉(9), 辛→魁午(6)鉞寅(2), 壬癸→魁卯(3)鉞巳(5)
  const TIANKU_TABLE={甲:1,戊:1,庚:1, 乙:0,己:0, 丙:11,丁:11, 辛:6, 壬:3,癸:3};
  const TIANYUE_TABLE={甲:7,戊:7,庚:7, 乙:8,己:8, 丙:9,丁:9, 辛:2, 壬:5,癸:5};
  addStarToPalace(palaces,'天魁','lucky',TIANKU_TABLE[yGan]!==undefined?TIANKU_TABLE[yGan]:1);
  addStarToPalace(palaces,'天鉞','lucky',TIANYUE_TABLE[yGan]!==undefined?TIANYUE_TABLE[yGan]:7);

  // 安祿存（依年干）
  const LUCUN_TABLE={甲:2,乙:3,丙:5,丁:6,戊:5,己:6,庚:8,辛:9,壬:11,癸:0}; // 祿存位置(地支idx)
  addStarToPalace(palaces,'祿存','lucky',LUCUN_TABLE[yGan]!==undefined?LUCUN_TABLE[yGan]:2);

  // 安天馬（依年支）
  const TIANMA_TABLE={寅:8,申:2,巳:11,亥:5,子:2,午:8,卯:5,酉:11,辰:2,戌:8,丑:11,未:5};
  addStarToPalace(palaces,'天馬','lucky',TIANMA_TABLE[yZhi]!==undefined?TIANMA_TABLE[yZhi]:2);

  // ═══ 乙級星（依年支）═══
  // 紅鸞：子→卯,丑→寅,寅→丑,卯→子,辰→亥,巳→戌,午→酉,未→申,申→未,酉→午,戌→巳,亥→辰
  addStarToPalace(palaces,'紅鸞','minor2',(3-yZhiIdx+12)%12);
  // 天喜：紅鸞對宮(+6)
  addStarToPalace(palaces,'天喜','minor2',(3-yZhiIdx+6+12)%12);
  // 天虛：依年支 子→午,丑→未,...
  addStarToPalace(palaces,'天虛','minor2',(yZhiIdx+6)%12);
  // 天哭：依年支 子→午反向 子→午,丑→巳,...
  addStarToPalace(palaces,'天哭','minor2',(6-yZhiIdx+12)%12);
  // 龍池：依年支順行 子→辰(4),丑→巳,...
  addStarToPalace(palaces,'龍池','minor2',(yZhiIdx+4)%12);
  // 鳳閣：依年支逆行 子→戌(10),丑→酉,...
  addStarToPalace(palaces,'鳳閣','minor2',(10-yZhiIdx+12)%12);
  // 華蓋：依年支三合局 寅午戌→戌,申子辰→辰,巳酉丑→丑,亥卯未→未
  const HG_TABLE={0:4,1:1,2:10,3:7,4:4,5:1,6:10,7:7,8:4,9:1,10:10,11:7};
  addStarToPalace(palaces,'華蓋','minor2',HG_TABLE[yZhiIdx]!==undefined?HG_TABLE[yZhiIdx]:4);
  // 咸池（桃花）：依年支 寅午戌→卯,申子辰→酉,巳酉丑→午,亥卯未→子
  const XC_TABLE={0:9,1:6,2:3,3:0,4:9,5:6,6:3,7:0,8:9,9:6,10:3,11:0};
  addStarToPalace(palaces,'咸池','minor2',XC_TABLE[yZhiIdx]!==undefined?XC_TABLE[yZhiIdx]:9);
  // 天德：依月支 正月→酉(9),二月→戌(10),...順推
  addStarToPalace(palaces,'天德','minor2',(lunar.month+8)%12);
  // 解神：依年支 子→戌(10),丑→戌(10),寅→子(0),...每兩年一跳
  const JS_TABLE={0:10,1:10,2:0,3:0,4:2,5:2,6:4,7:4,8:6,9:6,10:8,11:8};
  addStarToPalace(palaces,'解神','minor2',JS_TABLE[yZhiIdx]!==undefined?JS_TABLE[yZhiIdx]:10);
  // 天壽：依年支 子→午(6)... = 天虛同位（部分派別不同）
  // 實際上天壽依月支安：正月→卯... 用截圖驗證
  addStarToPalace(palaces,'天壽','minor2',(lunar.month+2)%12);

  // ═══ 乙級星（依年干）═══
  // 天官：甲→未(7),乙→辰(4),丙→巳(5),丁→寅(2),戊→卯(3),己→酉(9),庚→亥(11),辛→酉(9),壬→戌(10),癸→巳(5)
  const TGUAN={甲:7,乙:4,丙:5,丁:2,戊:3,己:9,庚:11,辛:9,壬:10,癸:5};
  addStarToPalace(palaces,'天官','minor2',TGUAN[yGan]!==undefined?TGUAN[yGan]:7);
  // 天福：甲→酉(9),乙→申(8),丙→子(0),丁→亥(11),戊→卯(3),己→寅(2),庚→午(6),辛→巳(5),壬→午(6),癸→巳(5)
  const TFUL={甲:9,乙:8,丙:0,丁:11,戊:3,己:2,庚:6,辛:5,壬:6,癸:5};
  addStarToPalace(palaces,'天福','minor2',TFUL[yGan]!==undefined?TFUL[yGan]:9);
  // 天貴：甲→丑(1),乙→子(0),丙→亥(11),丁→酉(9),戊→未(7),己→申(8),庚→未(7),辛→午(6),壬→巳(5),癸→卯(3)
  const TGUI={甲:1,乙:0,丙:11,丁:9,戊:7,己:8,庚:7,辛:6,壬:5,癸:3};
  addStarToPalace(palaces,'天貴','minor2',TGUI[yGan]!==undefined?TGUI[yGan]:1);

  // ═══ 乙級星（依月支）═══
  // 天刑：正月→酉(9)起逆行... 實際上天刑依月支安: 正月→丑起順行
  // 標準：天刑 = (lunar.month + 6) % 12 → 正月=7=午... 不對
  // 業界表：月+7 (子idx) → 正月→酉? 正月→丑? 用截圖驗
  // 命例1：四月→子宮有天刑(截圖顯示子宮有「刑」) → 天刑 = (月+8)%12 = (4+8)%12 = 0=子 ✓
  addStarToPalace(palaces,'天刑','minor2',(lunar.month+8)%12);
  // 天姚：正月→丑(1)起順行 = (月+0)%12 = 月
  // 命例1：四月→辰宮有天姚 → (4+0)%12=4=辰 ✓
  addStarToPalace(palaces,'天姚','minor2',(lunar.month)%12);

  // ═══ 乙級星（依日/時支）═══
  // 恩光：依日支安 = (日-1+9)%12... 複雜，簡化用日支
  // 標準恩光：文昌+1位 = (10-shi+1+12)%12
  addStarToPalace(palaces,'恩光','minor2',(10-shi+1+12)%12);
  // 天貴star已經用年干了，這裡的是「天使」
  // 天使：疾厄宮對宮（=父母宮地支位置）— 實際依年干查
  // 簡化：天使在疾厄宮
  const jiePos=palaces[5]?DZ.indexOf(palaces[5].branch):0; // 疾厄宮地支
  addStarToPalace(palaces,'天使','minor2',jiePos);

  // ═══ 丙級星 ═══
  // 三台：左輔位置+月-1
  const zuofuPos=palaces.findIndex(p=>p.stars.some(s=>s.name==='左輔'));
  if(zuofuPos>=0){
    const zfBranch=DZ.indexOf(palaces[zuofuPos].branch);
    addStarToPalace(palaces,'三台','minor3',(zfBranch+lunar.day-1)%12);
  }
  // 八座：右弼位置-月+1
  const youbiPos=palaces.findIndex(p=>p.stars.some(s=>s.name==='右弼'));
  if(youbiPos>=0){
    const ybBranch=DZ.indexOf(palaces[youbiPos].branch);
    addStarToPalace(palaces,'八座','minor3',(ybBranch-lunar.day+1+120)%12);
  }
  // 台輔：依時支 午(6)起順行
  addStarToPalace(palaces,'台輔','minor3',(shi+6)%12);
  // 封誥：依時支 午(6)起逆行
  addStarToPalace(palaces,'封誥','minor3',(6-shi+12)%12);
  // 旬空（甲級空亡）：依年干支查
  const xkIdx=Math.floor(((yZhiIdx-TG.indexOf(yGan)+12)%12)/1);
  // 簡化：空亡兩位
  const kw1=(10+TG.indexOf(yGan)-yZhiIdx%10+20)%12;
  const kw2=(kw1+1)%12;
  addStarToPalace(palaces,'旬空','minor3',kw1);

  // 四化
  const sihua = SIHUA_TABLE[yGan] || SIHUA_TABLE['甲'];
  const huaMap = [];
  [{type:'祿',label:'化祿'},{type:'權',label:'化權'},{type:'科',label:'化科'},{type:'忌',label:'化忌'}].forEach(h=>{
    const starName = sihua[h.type];
    palaces.forEach(p=>{
      const found = p.stars.find(s=>s.name===starName);
      if(found){
        found.hua = h.label;
        huaMap.push({star:starName, hua:h.label, palace:p.name});
      }
    });
  });

  // 命主星 (以年支決定)
  const MING_ZHU={0:'貪狼',1:'巨門',2:'祿存',3:'文曲',4:'廉貞',5:'武曲',6:'破軍',7:'武曲',8:'廉貞',9:'文曲',10:'祿存',11:'巨門'};
  // 身主星 (以年支決定)
  const SHEN_ZHU={0:'火星',1:'天相',2:'天梁',3:'天同',4:'文昌',5:'天機',6:'火星',7:'天相',8:'天梁',9:'天同',10:'文昌',11:'天機'};
  const yZhiIdx2=DZ.indexOf(yZhi);
  const mingZhu=MING_ZHU[yZhiIdx2]||'貪狼';
  const shenZhu=SHEN_ZHU[yZhiIdx2]||'火星';

  // ═══ 大限（紫微斗數大運）═══
  // 大限起始歲=五行局局數，每十年一宮
  // 陽男陰女順行，陰男陽女逆行
  const yGanYY=YY_G[yGan]; // 陽/陰
  const dxFwd=(gender==='male'&&yGanYY==='陽')||(gender==='female'&&yGanYY==='陰');
  const dxDir=dxFwd?1:-1;
  const dxStartAge=wuxingJu; // 大限起始歲=五行局數

  // ═══ 五虎遁：年干 → 寅宮天干 → 排定12宮天干 ═══
  // 口訣：甲己之年丙作首，乙庚之歲戊為頭，
  //       丙辛之年從庚起，丁壬壬寅順水流，戊癸甲寅好追求。
  const WUHU_YIN = {'甲':'丙','己':'丙','乙':'戊','庚':'戊',
                     '丙':'庚','辛':'庚','丁':'壬','壬':'壬','戊':'甲','癸':'甲'};
  const yinGan = WUHU_YIN[yGan] || '甲';
  const yinGanIdx = TG.indexOf(yinGan);
  // 十二宮天干：從寅(idx=2)開始，寅=yinGan, 卯=yinGan+1, 辰=yinGan+2...
  // 宮位地支idx → 天干idx: ganOfBranch[branchIdx] = TG[(yinGanIdx + (branchIdx-2+12)%12) % 10]
  function getPalaceGan(branchIdx){
    return TG[(yinGanIdx + ((branchIdx - 2 + 12) % 12)) % 10];
  }

  const daXian=[];
  for(let i=0;i<12;i++){
    const ageStart=dxStartAge+i*10;
    const ageEnd=ageStart+9;
    const curAge=new Date().getFullYear()-year;
    const isCur=curAge>=ageStart&&curAge<=ageEnd;

    // 大限宮位地支：命宮出發，順/逆行
    const dxBranchIdx=((mingIdx+i*dxDir)%12+12)%12;
    const dxBranch=DZ[dxBranchIdx];
    
    // 大限天干：該宮位地支對應的天干（五虎遁）
    const dxGan=getPalaceGan(dxBranchIdx);

    // 找大限宮位對應的原盤宮位
    const origPalace=palaces.find(p=>p.branch===dxBranch);
    const dxPalaceName=origPalace?origPalace.name:'';
    const dxStars=origPalace?origPalace.stars:[];

    // 大限四化（依大限天干）
    const dxSihua=SIHUA_TABLE[dxGan]||SIHUA_TABLE['甲'];
    const dxHua=[];
    [{type:'祿',label:'化祿'},{type:'權',label:'化權'},{type:'科',label:'化科'},{type:'忌',label:'化忌'}].forEach(h=>{
      const sn=dxSihua[h.type];
      palaces.forEach(p=>{
        const found=p.stars.find(s=>s.name===sn);
        if(found) dxHua.push({star:sn,hua:h.label,palace:p.name,palaceBranch:p.branch});
      });
    });

    // ═══ 大限吉凶評估（紫微斗數象徵體系）═══
    const hasMajor=dxStars.filter(s=>s.type==='major');
    const hasLucky=dxStars.filter(s=>['lucky','minor'].includes(s.type));
    const hasSha=dxStars.filter(s=>s.type==='sha');

    // 用analyzePalace做完整宮位分析（含廟旺落陷+吉煞組合+特殊格局）
    const dxAnalysis=analyzePalace(origPalace, dxBranchIdx);
    let dxScore=dxAnalysis.score;
    let dxNotes=[...dxAnalysis.notes];

    // 大限四化飛入各宮的影響
    dxHua.forEach(h=>{
      // 四化飛入本命盤的對應宮位
      const targetPalace=palaces.find(p=>p.name===h.palace);
      if(h.hua==='化祿'){
        dxScore+=2;
        dxNotes.push('大限'+h.star+'化祿入'+h.palace+'（'+h.star+'帶來'+h.palace+'領域的機會）');
      }
      if(h.hua==='化權'){
        dxScore+=1;
        dxNotes.push('大限'+h.star+'化權入'+h.palace+'（'+h.palace+'領域有掌控力）');
      }
      if(h.hua==='化科'){
        dxScore+=0.5;
        dxNotes.push('大限'+h.star+'化科入'+h.palace+'（'+h.palace+'領域有貴人）');
      }
      if(h.hua==='化忌'){
        dxScore-=2;
        dxNotes.push('大限'+h.star+'化忌入'+h.palace+'（'+h.palace+'領域有困擾）');
        // 四化疊加：大限化忌+原盤化忌=雙忌（大凶）
        if(targetPalace){
          const origJi=targetPalace.stars.find(s=>s.hua==='化忌');
          if(origJi){dxScore-=2;dxNotes.push('⚠ 大限化忌疊原盤化忌於'+h.palace+'（雙忌疊加，大凶）');}
        }
      }
    });

    // 大限宮位象徵含義（走到什麼宮=人生主題）
    const DX_THEME={
      命宮:'自我發展期',兄弟:'人脈拓展期',夫妻:'感情重點期',子女:'創造力/子女期',
      財帛:'理財重點期',疾厄:'健康注意期',遷移:'變動發展期',交友:'社交擴展期',
      官祿:'事業衝刺期',田宅:'安家置業期',福德:'心靈成長期',父母:'長輩/學業期'
    };
    const dxTheme=DX_THEME[dxPalaceName]||'';

    let dxLevel='平';
    if(dxScore>=6) dxLevel='大吉';
    else if(dxScore>=3) dxLevel='中吉';
    else if(dxScore>=1) dxLevel='小吉';
    else if(dxScore>=-1) dxLevel='平';
    else if(dxScore>=-3) dxLevel='小凶';
    else if(dxScore>=-6) dxLevel='中凶';
    else dxLevel='大凶';

    daXian.push({
      ageStart,ageEnd,isCurrent:isCur,
      branch:dxBranch,gan:dxGan,
      palaceName:dxPalaceName,theme:dxTheme,
      stars:hasMajor.map(s=>s.name),
      lucky:hasLucky.map(s=>s.name),
      sha:hasSha.map(s=>s.name),
      bright:dxAnalysis.bright,
      hua:dxHua,notes:dxNotes,
      level:dxLevel,score:dxScore
    });
  }

  // ═══ 流年盤（依流年地支走宮）═══
  // 流年命宮 = 流年地支所在宮位（斗數流年以太歲入命）
  function getLiuNianZw(lnYear){
    const lnZI=((lnYear-4)%12+12)%12;
    const lnGI=((lnYear-4)%10+10)%10;
    const lnZ=DZ[lnZI], lnG=TG[lnGI];
    // 流年命宮 = 太歲地支所在的原盤宮位
    const lnMingPalace=palaces.find(p=>p.branch===lnZ);
    // 流年四化（依流年天干）
    const lnSH=SIHUA_TABLE[lnG]||SIHUA_TABLE['甲'];
    const lnHua=[];
    [{type:'祿',label:'化祿'},{type:'權',label:'化權'},{type:'科',label:'化科'},{type:'忌',label:'化忌'}].forEach(h=>{
      const sn=lnSH[h.type];
      palaces.forEach(p=>{
        const found=p.stars.find(s=>s.name===sn);
        if(found) lnHua.push({star:sn,hua:h.label,palace:p.name});
      });
    });
    // ═══ 流年吉凶（紫微象徵體系）═══
    const lnBranchIdx=DZ.indexOf(lnZ);
    const lnAnalysis=analyzePalace(lnMingPalace, lnBranchIdx);
    let lnScore=lnAnalysis.score;
    let lnNotes=[...lnAnalysis.notes];

    // 流年四化飛入各宮
    lnHua.forEach(h=>{
      const targetP=palaces.find(p=>p.name===h.palace);
      if(h.hua==='化祿'){
        lnScore+=1.5;
        lnNotes.push(h.star+'化祿入'+h.palace);
        // 化祿入命/財/官=大好
        if(['命宮','財帛','官祿'].includes(h.palace)) lnScore+=0.5;
      }
      if(h.hua==='化權'){lnScore+=1;lnNotes.push(h.star+'化權入'+h.palace);}
      if(h.hua==='化科'){lnScore+=0.5;lnNotes.push(h.star+'化科入'+h.palace);}
      if(h.hua==='化忌'){
        lnScore-=1.5;
        lnNotes.push(h.star+'化忌入'+h.palace);
        if(['命宮','財帛','官祿','疾厄'].includes(h.palace)) lnScore-=0.5;
        // 流年化忌疊原盤化忌
        if(targetP){
          const origJi=targetP.stars.find(s=>s.hua==='化忌');
          if(origJi){lnScore-=2;lnNotes.push('⚠ 流年化忌疊原盤化忌於'+h.palace+'（雙忌）');}
        }
        // 流年化忌疊大限化忌
        const curDx=daXian.find(d=>d.isCurrent);
        if(curDx&&curDx.hua){
          const dxJi=curDx.hua.find(dh=>dh.palace===h.palace&&dh.hua==='化忌');
          if(dxJi){lnScore-=2;lnNotes.push('⚠ 流年化忌疊大限化忌於'+h.palace+'（雙忌大凶）');}
        }
      }
    });

    // 流年走宮象徵
    const lnMingName=lnMingPalace?lnMingPalace.name:'';
    const LN_FOCUS={
      命宮:'自我表現',財帛:'財運收入',官祿:'事業升遷',夫妻:'感情婚姻',
      疾厄:'健康注意',遷移:'外出變動',交友:'人際社交',田宅:'家庭居住',
      子女:'創意/子女',福德:'心靈享受',兄弟:'人脈合作',父母:'長輩/學業'
    };
    const lnFocus=LN_FOCUS[lnMingName]||'';

    return {year:lnYear,gz:lnG+lnZ,mingPalace:lnMingName,focus:lnFocus,hua:lnHua,score:lnScore,notes:lnNotes,bright:lnAnalysis.bright};
  }

  return {palaces, mingIdx, shenIdx, yGan, yZhi, wuxingJu, sihua: huaMap, lunar, mingZhu, shenZhu, mingGan, ziweiIdx, tianfuIdx, daXian, getLiuNianZw};
}

function addStarToPalace(palaces, name, type, zhiIdx){
  const pIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === zhiIdx);
  if(pIdx>=0) palaces[pIdx].stars.push({name, type});
}

// ═══ 紫微斗數整合進八字大運流年吉凶 ═══
// 在S.bazi和S.ziwei都算完後呼叫
function mergeZiweiIntoBazi(){
  if(!S.bazi||!S.ziwei||!S.ziwei.daXian) return;
  const bazi=S.bazi, zw=S.ziwei;
  const thisYear=new Date().getFullYear();

  bazi.dayun.forEach(dy=>{
    // 找同期的紫微大限
    const matchDx=zw.daXian.find(dx=>
      (dy.ageStart>=dx.ageStart&&dy.ageStart<=dx.ageEnd)||
      (dx.ageStart>=dy.ageStart&&dx.ageStart<=dy.ageEnd)
    );
    if(!matchDx) return;

    // 紫微大限score按比例加入八字大運score
    const zwWeight=0.35; // 紫微佔35%的權重
    const zwAdj=matchDx.score*zwWeight;
    dy.score+=zwAdj;

    // 加入紫微notes
    if(matchDx.bright&&matchDx.bright.length){
      dy.notes.push('紫微大限走'+matchDx.palaceName+'（'+matchDx.bright.map(b=>b.star+b.label).join('、')+' ）');
    }else{
      dy.notes.push('紫微大限走'+matchDx.palaceName+'（'+matchDx.level+'）');
    }
    if(matchDx.theme) dy.notes.push('十年主題：'+matchDx.theme);
    // 重要的大限notes（廟旺、吉煞組合、四化、特殊格局）
    if(matchDx.notes){
      matchDx.notes.slice(0,3).forEach(n=>dy.notes.push('紫微：'+n));
    }

    // 重新計算大運level
    const s=dy.score;
    if(s>=6) dy.level='大吉';
    else if(s>=3) dy.level='中吉';
    else if(s>=1) dy.level='小吉';
    else if(s>=-1) dy.level='平';
    else if(s>=-3) dy.level='小凶';
    else if(s>=-6) dy.level='中凶';
    else dy.level='大凶';

    // 紫微流年整合進八字流年
    if(dy.liuNian&&zw.getLiuNianZw){
      dy.liuNian.forEach(ln=>{
        try{
          const zwLn=zw.getLiuNianZw(ln.year);
          if(!zwLn) return;

          // 紫微流年score按比例加入
          const lnZwAdj=zwLn.score*0.3;
          ln.score+=lnZwAdj;

          // 紫微流年notes
          if(zwLn.mingPalace) ln.notes.push('紫微流年走'+zwLn.mingPalace);
          if(zwLn.focus) ln.notes.push('重點：'+zwLn.focus);
          if(zwLn.bright&&zwLn.bright.length) ln.notes.push(zwLn.bright.map(b=>b.star+b.label).join('、'));
          if(zwLn.notes) zwLn.notes.slice(0,2).forEach(n=>ln.notes.push(n));

          // 重新計算流年level
          const ls=ln.score;
          if(ls>=5) ln.level='大吉';
          else if(ls>=3) ln.level='中吉';
          else if(ls>=1) ln.level='小吉';
          else if(ls>=-1) ln.level='平';
          else if(ls>=-3) ln.level='小凶';
          else if(ls>=-5) ln.level='中凶';
          else ln.level='大凶';
        }catch(e){}
      });
    }
  });
}

function getWuxingJu(gan, zhi){
  // 納音五行局：命宮干支→納音→五行→局數
  // 納音五行: 金=4, 木=3, 水=2, 火=6, 土=5
  const NY_EL=['金','火','木','土','金','火','水','土','金','木','水','土','火','木','水','金','火','木','土','金','火','水','土','金','木','水','土','火','木','水'];
  const JU={'金':4,'木':3,'水':2,'火':6,'土':5};
  const gi=TG.indexOf(gan), zi=DZ.indexOf(zhi);
  if(gi<0||zi<0)return 4;
  let idx=-1;
  for(let n=0;n<60;n++)if(n%10===gi&&n%12===zi){idx=n;break;}
  if(idx<0)return 4;
  const nyEl=NY_EL[Math.floor(idx/2)];
  return JU[nyEl]||4;
}

function getZiweiPalaceByJu(ju, lunarDay){
  // 紫微安星公式（標準退步法）
  // day÷ju=商q餘r, 退步: 1步=-1, n≥2步=+n
  const day=Math.max(1,Math.min(30,lunarDay));
  const q=Math.floor(day/ju), r=day%ju;
  if(r===0) return ((2+q-1)%12+12)%12;
  const n=ju-r; // 退步數
  const shift=(n===1)?-1:n; // 退1步=-1, 退n≥2步=+n
  return ((2+q+shift)%12+12)%12;
}

function renderZiwei(){
  const zw = S.ziwei;
  if(!zw){document.getElementById('d-ziwei-info').innerHTML='<p class="text-dim">請先填寫出生資料</p>';return}

  // Info
  const shenPalace=zw.palaces.find(p=>p.isShen);
  const shenPalaceName=shenPalace?shenPalace.name:'';
  const juLabel=['水二','木三','金四','土五','火六'][[2,3,4,5,6].indexOf(zw.wuxingJu)]||'土五';
  document.getElementById('d-ziwei-info').innerHTML=`
    <p>命宮：${zw.mingGan}${DZ[zw.mingIdx]}（${DZ[zw.mingIdx]}宮）｜ 身宮：${DZ[zw.shenIdx]}宮${shenPalaceName?'（'+shenPalaceName+'）':''} ｜ ${juLabel}局</p>
    <p class="text-xs text-dim mt-xs">命主：${zw.mingZhu} ｜ 身主：${zw.shenZhu} ｜ 紫微在${DZ[zw.ziweiIdx]} ｜ 天府在${DZ[zw.tianfuIdx]}</p>`;

  // 12宮格（4x4, 中間2x2空）
  // 排列順序 DZ idx: 辰(4)巳(5)午(6)未(7) / 卯(3)[空][空]申(8) / 寅(2)[空][空]酉(9) / 丑(1)子(0)亥(11)戌(10)
  const order = [
    [4,5,6,7],    // 辰巳午未
    [3,-1,-1,8],  // 卯 center center 申
    [2,-1,-1,9],  // 寅 center center 酉
    [1,0,11,10]   // 丑子亥戌
  ];

  let html = '<div class="zw-grid">';
  for(let row=0;row<4;row++){
    for(let col=0;col<4;col++){
      const idx = order[row][col];
      if(idx===-1){
        if(row===1&&col===1){
          // Center cell spans 2x2
          html+=`<div class="zw-cell zw-center" style="grid-column:2/4;grid-row:2/4">
            <div class="serif text-gold" style="font-size:1.1rem;margin-bottom:var(--sp-sm)">紫微斗數</div>
            <p class="text-dim text-xs">命宮：${DZ[zw.mingIdx]}</p>
            <p class="text-dim text-xs">年干：${zw.yGan}${zw.yZhi}</p>
          </div>`;
        }
        continue;
      }
      const palace = zw.palaces.find(p => DZ.indexOf(p.branch) === idx);
      if(!palace){html+=`<div class="zw-cell"><span class="zw-palace">${DZ[idx]}</span></div>`;continue}

      const isMing = palace.isMing;
      const isShen = palace.isShen;
      html+=`<div class="zw-cell${isMing?' active-palace':''}${isShen?' shen-palace':''}">
        <div class="zw-palace">${palace.name}${isMing?' ⭐':''}${isShen?'<span style="color:#9cf;font-size:.6rem;margin-left:3px">身</span>':''}</div>
        <div class="zw-branch">${palace.branch}</div>
        <div class="zw-stars">`;
      // 先排主星，再吉煞，再乙級
      const sortOrder={major:0,sha:1,lucky:2,minor:3,minor2:4,minor3:5};
      const sorted=[...palace.stars].sort((a,b)=>(sortOrder[a.type]||9)-(sortOrder[b.type]||9));
      const bIdx=DZ.indexOf(palace.branch);
      sorted.forEach(s=>{
        const cls = s.type==='major'?'major':s.type==='sha'?'text-danger':s.type==='minor2'?'zw-m2':s.type==='minor3'?'zw-m3':'minor';
        html+=`<span class="zw-star ${cls}">${s.name}</span>`;
        if(s.type==='major'||s.type==='lucky'||s.type==='minor'||s.type==='sha'){const br=getStarBright(s.name,bIdx);if(br.label&&br.label!=='平')html+=`<span class="zw-bright">${br.label}</span>`;}
        if(s.hua)html+=`<span class="zw-hua">${s.hua}</span>`;
      });
      html+=`</div></div>`;
    }
  }
  html+='</div>';
  document.getElementById('d-ziwei-grid').innerHTML=html;

  // 四化
  document.getElementById('d-ziwei-sihua').innerHTML = zw.sihua.length?
    zw.sihua.map(h=>`<p><span class="tag ${h.hua.includes('祿')?'tag-green':h.hua.includes('忌')?'tag-red':'tag-gold'}">${h.hua}</span> ${h.star} → ${h.palace}</p>`).join('')
    :'<p class="text-dim">四化資訊計算中</p>';

  // 解讀
  const mingPalace = zw.palaces[0];
  const mingStars = mingPalace.stars.filter(s=>s.type==='major');
  let reading = '';
  if(mingStars.length){
    reading+=`<p><strong>命宮主星：</strong>${mingStars.map(s=>s.name).join('、')}</p>`;
    mingStars.forEach(s=>{
      const info = ZW_MAJOR.find(m=>m.name===s.name);
      if(info)reading+=`<p class="text-dim">→ ${info.name}：${info.nature}</p>`;
    });
  }else{
    // 命宮無主星：動態整合 煞星 + 對宮 + 身宮
    const mingShaStar=mingPalace.stars.filter(s=>s.type==='sha').map(s=>s.name);
    const qianyi=zw.palaces[6]; // 遷移宮（對宮）
    const qianyiMajors=qianyi?qianyi.stars.filter(s=>s.type==='major').map(s=>s.name):[];
    const qianyiHua=qianyi?qianyi.stars.filter(s=>s.hua).map(s=>s.name+s.hua):[];
    reading+=`<p>命宮無主星，借對宮（遷移宮）星曜判斷。`;
    if(mingShaStar.includes('擎羊')||mingShaStar.includes('陀羅')){
      reading+=`命宮帶${mingShaStar.join('、')}，性格中有強烈的防衛心與堅韌面，外柔內剛，被壓迫時會激烈反彈。`;
    } else if(mingShaStar.length){
      reading+=`命宮帶${mingShaStar.join('、')}，處事風格較為銳利。`;
    } else {
      reading+=`性格定位較模糊，容易將生命重心向外尋求。`;
    }
    if(qianyiMajors.length){
      reading+=`對宮有${qianyiMajors.join('、')}`;
      if(qianyiMajors.includes('武曲')&&qianyiMajors.includes('貪狼')){
        reading+=`，武曲貪狼組合極度渴望實質成就，在外發展力強但容易慾望受阻`;
      } else if(qianyiMajors.some(s=>['紫微','天府'].includes(s))){
        reading+=`，外在環境有貴氣格局`;
      }
      if(qianyiHua.some(h=>h.includes('化忌'))){
        reading+=`。對宮帶化忌，外出發展或人際交往容易遇到挫折與變數`;
      }
      reading+=`。</p>`;
    } else {
      reading+=`</p>`;
    }
    // 身宮提示
    const shenP2=zw.palaces.find(p=>p.isShen);
    if(shenP2){
      const shenMajors=shenP2.stars.filter(s=>s.type==='major').map(s=>s.name);
      const shenHua=shenP2.stars.filter(s=>s.hua).map(s=>s.name+s.hua);
      if(shenMajors.length){
        reading+=`<p class="text-dim">身宮在${shenP2.name}（${shenMajors.join('、')}${shenHua.length?'、'+shenHua.join('、'):''}），`;
        if(shenP2.name==='福德宮'||shenP2.name==='福德'){
          reading+=`代表一生終極追求受精神滿足感主導，而非單純物質。`;
        } else if(shenP2.name==='財帛宮'||shenP2.name==='財帛'){
          reading+=`代表一生重心在財富累積與資源運用。`;
        } else if(shenP2.name==='官祿宮'||shenP2.name==='官祿'){
          reading+=`代表一生重心在事業成就與社會地位。`;
        } else {
          reading+=`中晚年生命重心偏向${shenP2.name}領域。`;
        }
        reading+=`</p>`;
      }
    }
  }
  // 財帛宮
  const caiPalace = zw.palaces[4];
  const caiStars = caiPalace.stars.filter(s=>s.type==='major');
  if(caiStars.length)reading+=`<p class="mt-sm"><strong>財帛宮：</strong>${caiStars.map(s=>s.name).join('、')} — ${caiStars.some(s=>['武曲','天府','太陰'].includes(s.name))?'財運基礎佳':'財運需靠努力積累'}</p>`;

  // 官祿宮
  const guanPalace = zw.palaces[8];
  const guanStars = guanPalace.stars.filter(s=>s.type==='major');
  if(guanStars.length)reading+=`<p class="mt-sm"><strong>官祿宮：</strong>${guanStars.map(s=>s.name).join('、')} — ${guanStars.some(s=>['紫微','天府','太陽'].includes(s.name))?'事業格局大，適合管理職':'適合專業技術或自由業'}</p>`;

  // 煞星提醒
  const shaStars = [];
  zw.palaces.forEach(p=>p.stars.filter(s=>s.type==='sha').forEach(s=>shaStars.push(s.name+'('+p.name+')')));
  if(shaStars.length)reading+=`<p class="mt-sm text-warn"><strong>煞星：</strong>${shaStars.join('、')} — 注意相關宮位的挑戰</p>`;

  // 桃花星分析
  const peachStars=[];
  zw.palaces.forEach(p=>p.stars.filter(s=>['紅鸞','天喜','咸池','天姚'].includes(s.name)).forEach(s=>peachStars.push(s.name+'('+p.name+')')));
  if(peachStars.length)reading+=`<p class="mt-sm" style="color:#f9b"><strong>桃花星：</strong>${peachStars.join('、')}</p>`;

  // 特殊星曜提示
  const specials=[];
  zw.palaces.forEach(p=>{
    p.stars.forEach(s=>{
      if(s.name==='華蓋'&&p.isMing) specials.push('命坐華蓋，宗教緣深、性格清高');
      if(s.name==='天刑'&&p.name==='官祿') specials.push('天刑入官祿，適合法律、軍警、外科');
      if(s.name==='龍池'&&p.name==='命宮') specials.push('龍池入命，才藝出眾');
      if(s.name==='恩光'&&p.isMing) specials.push('恩光入命，貴人緣佳');
    });
  });
  if(specials.length)reading+=specials.map(s=>'<p class="mt-xs text-dim">★ '+s+'</p>').join('');

  // ── 問題類型對應宮位深度解讀 ──
  const typeLabel2 = S.form ? ({'love':'愛情','career':'事業','wealth':'財運','health':'健康','general':'綜合','relationship':'人際','family':'家庭'}[S.form.type]||'綜合') : '綜合';
  const typeToGong2 = {love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
  const tgIdx = typeToGong2[S.form?S.form.type:'general'];
  if(tgIdx !== undefined && tgIdx !== 0) {
    const tgPalace = zw.palaces[tgIdx];
    if(tgPalace) {
      const tgMajors = tgPalace.stars.filter(s=>s.type==='major');
      const tgMinors = tgPalace.stars.filter(s=>s.type==='minor');
      const tgSha = tgPalace.stars.filter(s=>s.type==='sha');
      reading += `<div class="divider"></div>`;
      reading += `<p class="mt-sm"><strong>📌 針對「${typeLabel2}」— ${tgPalace.name}分析：</strong></p>`;
      if(tgMajors.length) {
        reading += `<p>主星：${tgMajors.map(s=>{
          const info=ZW_MAJOR.find(m=>m.name===s.name);
          const bright=s.brightness?' ('+s.brightness+')':'';
          const hua=s.hua?' '+s.hua:'';
          return s.name+bright+hua+(info?' — '+info.nature:'');
        }).join('；')}</p>`;

        // Type-specific star interpretation
        const tgTypeAdvice = {
          love: function(stars) {
            const msgs = [];
            if(stars.some(s=>s.name==='太陰')) msgs.push('太陰入夫妻宮，感情細膩溫柔，異性緣佳。');
            if(stars.some(s=>s.name==='貪狼')) msgs.push('貪狼入夫妻宮，桃花旺盛，但感情容易波折。');
            if(stars.some(s=>s.name==='天同')) msgs.push('天同入夫妻宮，感情和睦，相處舒適。');
            if(stars.some(s=>s.name==='天機')) msgs.push('天機入夫妻宮，感情中多變，需要用心經營。');
            if(stars.some(s=>s.name==='武曲')) msgs.push('武曲入夫妻宮，另一半務實能幹，但可能缺乏浪漫。');
            if(stars.some(s=>s.name==='紫微')) msgs.push('紫微入夫妻宮，另一半有主見有能力，但可能較強勢。');
            if(stars.some(s=>s.name==='七殺')) msgs.push('七殺入夫妻宮，感情來得快烈但有波動。');
            if(stars.some(s=>s.name==='破軍')) msgs.push('破軍入夫妻宮，感情多變化，婚前可能經歷多段戀情。');
            if(stars.some(s=>s.name==='太陽')) msgs.push('太陽入夫妻宮，另一半為人光明正大，社交活躍。');
            if(stars.some(s=>s.name==='巨門')) msgs.push('巨門入夫妻宮，感情中需注意口舌爭執，溝通是關鍵。');
            if(stars.some(s=>s.name==='天梁')) msgs.push('天梁入夫妻宮，另一半穩重可靠，年齡差距可能較大。');
            if(stars.some(s=>s.name==='天相')) msgs.push('天相入夫妻宮，另一半溫和有禮，適合共同經營家庭。');
            if(stars.some(s=>s.name==='天府')) msgs.push('天府入夫妻宮，另一半穩健有財，感情穩定。');
            if(stars.some(s=>s.name==='廉貞')) msgs.push('廉貞入夫妻宮，感情熱烈但需防第三者。');
            return msgs.length ? msgs.join('') : '';
          },
          career: function(stars) {
            const msgs = [];
            if(stars.some(s=>s.name==='紫微')) msgs.push('紫微入官祿宮，事業格局大，適合管理或獨立經營。');
            if(stars.some(s=>s.name==='天府')) msgs.push('天府入官祿宮，事業穩定有發展，適合大機構。');
            if(stars.some(s=>s.name==='太陽')) msgs.push('太陽入官祿宮，事業有公眾曝光度，適合公職或傳播業。');
            if(stars.some(s=>s.name==='武曲')) msgs.push('武曲入官祿宮，適合金融、軍警或需要果斷的職業。');
            if(stars.some(s=>s.name==='天機')) msgs.push('天機入官祿宮，適合策劃、企劃或變動性高的職業。');
            if(stars.some(s=>s.name==='天同')) msgs.push('天同入官祿宮，工作偏安穩，適合服務業或教育。');
            if(stars.some(s=>s.name==='七殺')) msgs.push('七殺入官祿宮，事業心強，適合獨當一面的角色。');
            if(stars.some(s=>s.name==='破軍')) msgs.push('破軍入官祿宮，適合開創性工作，職業易有大變動。');
            if(stars.some(s=>s.name==='貪狼')) msgs.push('貪狼入官祿宮，適合業務、公關或需要交際的工作。');
            if(stars.some(s=>s.name==='巨門')) msgs.push('巨門入官祿宮，適合律師、教師或需要口才的工作。');
            if(stars.some(s=>s.name==='天梁')) msgs.push('天梁入官祿宮，適合醫療、法律或公益事業。');
            if(stars.some(s=>s.name==='廉貞')) msgs.push('廉貞入官祿宮，事業有重心，適合公務或管理。');
            return msgs.length ? msgs.join('') : '';
          },
          wealth: function(stars) {
            const msgs = [];
            if(stars.some(s=>s.name==='武曲')) msgs.push('武曲入財帛宮，天生財星，正財運極佳，適合金融投資。');
            if(stars.some(s=>s.name==='天府')) msgs.push('天府入財帛宮，財庫穩固，適合穩健理財。');
            if(stars.some(s=>s.name==='太陰')) msgs.push('太陰入財帛宮，適合不動產投資，財富慢慢累積。');
            if(stars.some(s=>s.name==='貪狼')) msgs.push('貪狼入財帛宮，偏財運佳但花費也大，需控制開支。');
            if(stars.some(s=>s.name==='紫微')) msgs.push('紫微入財帛宮，大器晚成型，財富會隨地位提升。');
            if(stars.some(s=>s.name==='天機')) msgs.push('天機入財帛宮，財來財卻，需靈活理財。');
            if(stars.some(s=>s.name==='太陽')) msgs.push('太陽入財帛宮，大方慷慨，正財運佳但不宜太慷慨。');
            if(stars.some(s=>s.name==='巨門')) msgs.push('巨門入財帛宮，靠口才賺錢，但理財需更謹慎。');
            if(stars.some(s=>s.name==='七殺')) msgs.push('七殺入財帛宮，財運起伏大，適合冒險型投資。');
            if(stars.some(s=>s.name==='破軍')) msgs.push('破軍入財帛宮，財運大起大落，需建立儲蓄習慣。');
            return msgs.length ? msgs.join('') : '';
          },
          health: function(stars) {
            const msgs = [];
            if(stars.some(s=>s.name==='天同')) msgs.push('天同入疾厄宮，先天體質不差，注意肥胖與脾臟。');
            if(stars.some(s=>s.name==='天機')) msgs.push('天機入疾厄宮，注意肝膽、神經系統。');
            if(stars.some(s=>s.name==='太陽')) msgs.push('太陽入疾厄宮，注意眼睛、血壓、心臟。');
            if(stars.some(s=>s.name==='太陰')) msgs.push('太陰入疾厄宮，注意脾臟、婦科或泌尿系統。');
            if(stars.some(s=>s.name==='武曲')) msgs.push('武曲入疾厄宮，注意呼吸系統、筋骨。');
            if(stars.some(s=>s.name==='廉貞')) msgs.push('廉貞入疾厄宮，注意心臟、血液循環。');
            if(stars.some(s=>s.name==='貪狼')) msgs.push('貪狼入疾厄宮，注意肝膽、過度消耗。');
            if(stars.some(s=>s.name==='巨門')) msgs.push('巨門入疾厄宮，主消化系統與暗疾，疾病容易隱藏不易察覺，需定期檢查腸胃與免疫系統。');
            if(stars.some(s=>s.name==='天梁')) msgs.push('天梁入疾厄宮，常有小病但能逢凶化吉，注意慢性問題。');
            if(stars.some(s=>s.name==='七殺')) msgs.push('七殺入疾厄宮，體質帶煞氣，注意意外傷害與急性發炎。');
            if(stars.some(s=>s.name==='破軍')) msgs.push('破軍入疾厄宮，身體耗損度高，注意免疫力與過度勞累。');
            if(stars.some(s=>s.name==='紫微')) msgs.push('紫微入疾厄宮，底子不差但容易忽視保養。');
            if(stars.some(s=>s.name==='天相')) msgs.push('天相入疾厄宮，注意皮膚與泌尿系統。');
            if(stars.some(s=>s.name==='天府')) msgs.push('天府入疾厄宮，先天體質不錯，注意脾胃消化。');
            // 化權在疾厄的特殊處理
            const huaQuan=stars.find(s=>s.hua==='化權');
            if(huaQuan) msgs.push(`⚠ ${huaQuan.name}化權在疾厄宮，代表身體機能常處於「高壓運轉」狀態。這不是健康的掌控力，而是壓力導致的過度消耗。需特別警惕隱性健康問題。`);
            const huaJi=stars.find(s=>s.hua==='化忌');
            if(huaJi) msgs.push(`⚠ ${huaJi.name}化忌在疾厄宮，健康方面是命盤中最需關注的弱點，宜定期體檢。`);
            return msgs.length ? msgs.join('') : '';
          }
        };
        const typeAdviceFn = tgTypeAdvice[S.form?S.form.type:'general'];
        if(typeAdviceFn) {
          const advice = typeAdviceFn(tgMajors);
          if(advice) reading += `<p class="mt-sm">${advice}</p>`;
        }
      } else {
        reading += `<p>${tgPalace.name}無主星，需借對宮星曜判斷，此方面較不穩定，需主動經營。</p>`;
      }
      if(tgMinors.length) reading += `<p class="text-dim text-sm mt-sm">輔星：${tgMinors.map(s=>s.name).join('、')}${tgMinors.some(s=>['文昌','文曲','左輔','右弼'].includes(s.name))?' — 有輔星助力':''}</p>`;
      if(tgSha.length) reading += `<p class="text-warn text-sm mt-sm">⚠ 煞星：${tgSha.map(s=>s.name).join('、')} — 此方面有挑戰需克服</p>`;

      // 四化在此宮的影響
      const huaInGong = zw.sihua.filter(h=>h.palace===tgPalace.name);
      if(huaInGong.length) {
        reading += `<p class="mt-sm">四化影響：${huaInGong.map(h=>`${h.star} ${h.hua}`).join('、')}</p>`;
        huaInGong.forEach(h=>{
          if(h.hua==='化祿') reading+=`<p class="text-sm" style="color:#4ade80">💎 ${h.star}化祿入${tgPalace.name}，${typeLabel2}方面有先天福氣，容易有好的結果。</p>`;
          if(h.hua==='化權'){
            if(tgPalace.name==='疾厄'||tgPalace.name.includes('疾')){
              reading+=`<p class="text-sm text-warn">⚠ ${h.star}化權入${tgPalace.name}，身體機能長期處於高壓運轉狀態，容易因為壓力導致過度消耗特定器官。需注意定期檢查，勿輕忽身體警訊。</p>`;
            } else {
              reading+=`<p class="text-sm text-gold">🟡 ${h.star}化權入${tgPalace.name}，${typeLabel2}方面有掌控力與主導權，但不宜太強勢。</p>`;
            }
          }
          if(h.hua==='化科') reading+=`<p class="text-sm" style="color:#60a5fa">🔵 ${h.star}化科入${tgPalace.name}，${typeLabel2}方面有貴人助力，名聲好。</p>`;
          if(h.hua==='化忌'){
            // 凶相賦能：化忌不單純是凶，是逼迫專精的驅動力
            const jiStar=h.star;
            let jiMsg=`${jiStar}化忌入${tgPalace.name}，${typeLabel2}方面容易遭遇阻礙或執念。`;
            // 特定星曜的化忌賦能轉化
            if(jiStar==='貪狼') jiMsg+=`貪狼化忌代表慾望受阻，但正是逼迫你在此領域專精到底的強大驅動力，最終可能因為夠執著而成為該領域的專家。`;
            else if(jiStar==='巨門') jiMsg+=`巨門化忌代表口舌是非與暗中消耗，但也磨練了你的表達精準度和洞察力，適合以口才為業。`;
            else if(jiStar==='太陽') jiMsg+=`太陽化忌代表男性緣分或公眾形象有壓力，但在壓力下反而會逼迫你建立更堅實的實力根基。`;
            else if(jiStar==='太陰') jiMsg+=`太陰化忌代表情緒和財務的糾結，但這種不安全感會驅使你比常人更努力經營穩定。`;
            else if(jiStar==='天機') jiMsg+=`天機化忌代表計畫容易被打亂，但這種被迫應變的壓力反而培養了極強的危機處理能力。`;
            else if(jiStar==='廉貞') jiMsg+=`廉貞化忌代表感情或官非的糾纏，但同時帶來在此領域不放棄的執著。`;
            else if(jiStar==='武曲') jiMsg+=`武曲化忌代表財務上的壓力與挫折，但正是這種壓力驅動你發展出更務實的理財能力。`;
            else jiMsg+=`此化忌帶來的焦慮感也是驅動你在此領域深耕的力量。`;
            reading+=`<p class="text-sm text-danger">🔴 ${jiMsg}</p>`;
          }
        });
      }
    }
  }

  document.getElementById('d-ziwei-reading').innerHTML = (reading ? wrapPlain(reading,'紫微斗數｜白話重點') : '<p class="text-dim">解讀生成中…</p>');

if(PLAIN_MODE){ const p=document.getElementById('d-ziwei-plate'); if(p) p.innerHTML = wrapPlain(p.innerHTML,'紫微斗數｜白話重點（盤面）'); }
}
/* =============================================================
   姓名學 NAMEOLOGY（三才五格）
   ============================================================= */
const STROKE_OVERRIDE={
  // ═══ 康熙字典筆畫（姓名學專用・部首已還原）═══
  // 原則：氵=4, 忄=4, 扌=4, 艹=6, 衤=6, 礻=5, 辶=7, 犭=4
  //       阝左(阜)=8, 阝右(邑)=7, 王旁(玉)=5, 月(肉旁)=6

  // ── 百大姓氏（康熙正確畫數）──
  '趙':14,'錢':16,'孫':10,'李':7,'周':8,'吳':7,'鄭':19,'王':4,
  '馮':12,'陳':16,'褚':15,'衛':16,'蔣':17,'沈':8,'韓':17,'楊':13,
  '朱':6,'秦':10,'尤':4,'許':11,'何':7,'呂':7,'施':9,'張':11,
  '孔':4,'曹':11,'嚴':20,'華':14,'金':8,'魏':18,'陶':16,'姜':9,
  '戚':11,'謝':17,'鄒':17,'喻':12,'柏':9,'水':4,'竇':20,'章':11,
  '雲':12,'蘇':22,'潘':16,'葛':15,'奚':10,'范':11,'彭':12,'郎':14,
  '魯':16,'韋':9,'昌':8,'馬':10,'苗':11,'鳳':14,'花':10,'方':4,
  '俞':9,'任':6,'袁':10,'柳':9,'酆':20,'鮑':16,'史':5,'唐':10,
  '費':12,'廉':13,'岑':7,'薛':19,'雷':13,'賀':12,'倪':10,'湯':13,
  '滕':14,'殷':10,'羅':20,'畢':11,'郝':14,'鄔':19,'安':6,'常':11,
  '樂':15,'于':3,'時':10,'傅':12,'皮':5,'卞':4,'齊':14,'康':11,
  '伍':6,'余':7,'元':4,'卜':2,'顧':21,'孟':8,'黃':12,'和':8,
  '穆':16,'蕭':18,'尹':4,'姚':9,'邵':12,'湛':13,'汪':8,'祁':8,
  '毛':4,'禹':9,'狄':8,'米':6,'貝':7,'明':8,'臧':14,'計':9,
  '伏':6,'成':7,'戴':18,'談':15,'宋':7,'茅':11,'龐':19,'熊':14,
  '紀':9,'舒':12,'屈':8,'項':12,'祝':10,'董':15,'梁':11,'杜':7,
  '阮':12,'藍':18,'閔':12,'席':10,'季':8,'麻':11,'強':12,'賈':13,
  '路':13,'婁':11,'危':6,'江':7,'童':12,'顏':18,'郭':15,'梅':11,
  '盛':12,'林':8,'刁':2,'鍾':17,'徐':10,'邱':7,'駱':16,'高':10,
  '夏':10,'蔡':17,'田':5,'樊':15,'胡':11,'凌':10,'霍':16,'虞':13,
  '萬':15,'支':4,'柯':9,'昝':9,'管':14,'盧':16,'莫':13,'經':13,
  '房':8,'裘':13,'繆':17,'干':3,'解':13,'應':17,'宗':8,'丁':2,
  '宣':9,'賁':12,'鄧':19,'郁':13,'單':12,'杭':8,'洪':10,'包':5,
  '諸':16,'左':5,'石':5,'崔':11,'吉':6,'鈕':10,'龔':22,'程':12,
  '嵇':13,'邢':7,'滑':14,'裴':14,'陸':16,'榮':14,'翁':10,'荀':11,
  '羊':6,'於':8,'惠':12,'甄':14,'曲':6,'家':10,'封':9,'芮':10,
  '羿':9,'儲':18,'靳':13,'汲':7,'邴':11,'糜':17,'松':8,'井':4,
  '段':9,'富':12,'巫':7,'烏':10,'焦':12,'巴':4,'弓':3,'牧':8,
  '隗':13,'山':3,'谷':7,'車':7,'侯':9,'宓':8,'蓬':17,'全':6,
  '郗':14,'班':10,'仰':6,'秋':9,'仲':6,'伊':6,'宮':10,'甯':12,
  '仇':4,'欒':23,'暴':15,'甘':5,'鈄':10,'厲':15,'戎':6,'祖':10,
  '武':8,'符':11,'劉':15,'景':12,'詹':13,'束':7,'龍':16,'葉':15,
  '幸':8,'司':5,'韶':14,'薄':17,'印':6,'宿':11,'白':5,'懷':20,
  '蒲':16,'邰':13,'從':11,'鄂':11,'索':10,'咸':9,'籍':20,'賴':16,
  '卓':8,'藺':21,'屠':11,'蒙':16,'池':7,'喬':12,'陰':11,'鬱':29,
  '胥':11,'能':10,'蒼':16,'雙':18,'聞':14,'莘':13,'黨':20,'翟':14,
  '譚':19,'貢':10,'勞':12,'逄':14,'姬':10,'申':5,'扶':8,'堵':12,
  '冉':5,'宰':10,'酈':21,'雍':13,'卻':9,'璩':18,'桑':10,'桂':10,
  '濮':18,'牛':4,'壽':14,'通':14,'邊':22,'扈':11,'燕':16,'冀':16,
  '郟':14,'浦':11,'尚':8,'農':13,'溫':14,'別':7,'莊':13,'晏':10,
  '柴':10,'瞿':18,'閻':16,'充':6,'慕':15,'連':14,'茹':12,'習':11,
  '宦':9,'艾':8,'魚':11,'容':10,'向':6,'古':5,'易':8,'慎':14,
  '戈':4,'廖':14,'庾':11,'終':11,'暨':14,'居':8,'衡':16,'步':7,
  '都':16,'耿':10,'滿':15,'弘':5,'匡':6,'國':11,'文':4,'寇':11,
  '廣':15,'祿':13,'闕':18,'東':8,'歐':15,'殳':4,'沃':8,'利':7,
  '蔚':17,'越':12,'夔':21,'隆':17,'師':10,'鞏':15,'厙':6,'聶':18,
  '晁':10,'勾':4,'敖':11,'融':16,'冷':7,'訾':12,'辛':7,'闞':20,
  '那':7,'簡':18,'饒':21,'空':8,'曾':12,'毋':4,'沙':8,'乜':2,
  '養':15,'鞠':17,'須':12,'豐':18,'巢':11,'關':19,'蒯':16,'相':9,
  '查':9,'后':6,'荊':12,'紅':9,'游':13,'竺':8,'權':22,'逯':14,
  '蓋':16,'益':10,'桓':10,'公':4,

  // ── 常見名字用字（康熙正確畫數・部首已還原）──
  // 氵部（+1）
  '淑':12,'清':12,'潔':16,'浩':11,'洋':10,'涵':12,'淳':12,
  '渝':13,'源':14,'溢':14,'滿':15,'漢':15,'潤':16,'澄':16,
  '濤':18,'瀾':21,'灝':25,'沛':8,'洛':10,'湘':13,'澤':17,
  '淇':12,'洪':10,'淨':12,'深':12,'淵':12,'游':13,'渙':13,
  '湛':13,'溫':14,'滋':13,'滑':14,'漫':15,'潛':16,'瀚':20,
  '沐':8,'津':10,'泉':9,'泓':9,'泰':10,'波':9,'泳':9,
  '海':11,'浮':11,'涼':12,'淮':12,'減':13,'渡':13,'港':13,
  '湖':13,'準':13,'溝':14,'溪':14,'溫':14,'滅':14,'漁':15,
  '漂':15,'漓':14,'漠':15,'演':15,'漲':15,'潘':16,'潮':16,
  '澳':17,'濃':17,'濕':18,'濟':18,'瀑':19,'灌':22,'灣':26,
  // 忄部（+1）
  '怡':9,'恆':10,'悅':11,'惠':12,'慧':15,'憲':16,'懷':20,
  '恩':10,'慈':13,'慎':14,'愷':14,'懿':22,
  '悟':11,'情':12,'惜':12,'惟':12,'愉':13,'慰':15,
  '懋':17,'憶':17,'憑':16,'懷':20,'憫':16,'慕':15,
  // 扌部（+1）
  '振':11,'揚':13,'捷':13,'掌':12,'推':12,'描':12,
  '提':13,'搏':14,'撫':16,'操':17,'擇':17,'擎':18,
  // 艹部（+3！）
  '芳':10,'芝':10,'芬':10,'花':10,'若':11,'苗':11,
  '英':11,'茂':11,'茜':12,'茗':12,'茹':12,'荷':13,
  '莉':13,'莎':13,'菁':14,'菲':14,'萊':14,'萍':14,
  '萱':15,'葉':15,'蒂':15,'蓮':17,'蓉':16,'蓁':14,
  '蔚':17,'薇':19,'蘭':21,'蘊':22,'蘇':22,'藝':21,
  '藍':18,'藏':18,'薰':17,'蕙':18,'蕊':18,'蕭':18,
  '芮':10,'苡':11,'荀':11,'莘':13,'莊':13,'董':15,
  '葛':15,'蒲':16,'蒙':16,'蔡':17,'蔣':17,'薛':19,
  '華':14,'萌':14,'萬':15,'葵':15,'蓓':16,'薔':19,
  // 衤部（+1）
  '裕':13,'褚':15,'裴':14,'褀':14,'裝':13,'補':13,
  '複':14,'褐':15,'褒':15,
  // 礻部（+1）
  '祈':9,'祐':10,'祖':10,'祥':11,'祺':13,'禧':17,
  '禎':14,'祿':13,'禮':18,'禪':17,'祝':10,'神':10,
  '福':14,'禹':9,'祁':8,
  // 辶部（+4）
  '建':9,'連':14,'進':15,'達':16,'遠':17,'道':16,
  '運':16,'遊':16,'還':20,'邊':22,'遇':16,'過':16,
  '逸':15,'遍':15,'逢':14,'通':14,'迪':12,'迎':11,
  '述':12,'逆':13,'迅':10,'迪':12,'週':12,
  // 犭部（+1）
  '狄':8,'猛':12,'獅':13,'獨':17,'獻':20,
  // 王(玉)旁（+1）
  '玲':10,'珍':10,'珊':10,'珠':11,'琪':13,'琳':13,
  '瑜':14,'瑛':14,'瑞':14,'瑋':14,'瑤':15,'瑩':15,
  '璇':16,'璋':16,'璐':17,'璟':16,'瑄':14,'琦':13,
  '琬':13,'琰':13,'琮':13,'珮':11,'珈':10,'瑾':16,
  '瑀':14,'璿':18,'瓊':20,'琥':13,'璨':18,'環':18,
  '珺':12,'琴':12,'珏':10,'瑆':13,'珞':11,
  // 月(肉旁)（+2）：左旁的「月」多為肉部
  '胡':11,'育':10,'胖':11,'胤':9,'胸':12,'腸':14,
  '腦':15,'膽':17,'臨':17,'朋':8,'朝':12,'期':12,
  '服':8,
  // 阝左(阜部=8畫)
  '陳':16,'陽':17,'阮':12,'陸':16,'陶':16,'陰':11,
  '陵':16,'隆':17,'隊':12,'階':12,'際':19,'障':16,
  '隨':21,'險':16,'隱':22,'院':10,
  // 阝右(邑部=7畫)
  '鄭':19,'郭':15,'邱':7,'邵':12,'郁':13,'鄒':17,
  '鄧':19,'鄂':11,'郝':14,'鄔':19,'都':16,'鄰':19,
  '邢':7,'郎':14,'那':7,'邦':11,'邸':10,'郗':14,

  // ── 其他高頻名字用字 ──
  '一':1,'二':2,'三':3,'四':4,'五':5,'六':6,'七':7,'八':8,'九':9,'十':10,
  '大':3,'小':3,'中':4,'上':3,'下':3,'人':2,'天':4,'地':6,
  '水':4,'火':4,'木':4,'金':8,'土':3,'日':4,'月':4,'年':6,
  '明':8,'光':6,'國':11,'德':15,'仁':4,'義':13,'禮':18,'信':9,
  '智':12,'勇':9,'忠':8,'孝':7,'志':7,'剛':10,'強':12,'文':4,
  '武':8,'成':7,'功':5,'安':6,'平':5,'吉':6,'祥':11,'瑞':14,
  '昌':8,'盛':12,'榮':14,'富':12,'貴':12,'康':11,'壽':14,
  '福':14,'喜':12,'樂':15,'和':8,'順':12,'利':7,'道':16,
  '春':9,'夏':10,'秋':9,'冬':5,'東':8,'西':6,'南':9,'北':5,
  '心':4,'思':9,'想':13,'意':13,'恩':10,'慈':13,'善':12,
  '美':9,'真':10,'靜':16,'淨':12,'雲':12,'風':9,'雨':8,
  '雪':11,'花':10,'草':10,'樹':16,'海':11,'山':3,'河':9,
  '江':7,'湖':13,'龍':16,'鳳':14,'虎':8,'鶴':21,'馬':10,
  '牛':4,'羊':6,'鼠':13,'兔':8,'蛇':11,'猴':12,'雞':18,'狗':9,'豬':16,
  '愛':13,'情':12,'錢':16,'財':10,'工':3,'作':7,'事':8,'業':13,
  '健':11,'家':10,'庭':10,'際':19,'運':16,'勢':13,'感':13,
  '婚':11,'姻':9,'學':16,'習':11,'考':6,'試':13,'升':4,
  '職':18,'轉':18,'危':6,'凶':4,
  // 常見名字字
  '宇':6,'宸':10,'翔':12,'鈺':13,'筠':13,'霈':15,'芸':10,'嘉':14,
  '瀚':20,'宥':9,'睿':14,'俐':9,'浩':11,'昕':8,'沛':8,
  '晴':12,'芷':10,'彤':7,'宸':10,'紘':10,'彬':11,'濬':18,
  '靖':13,'諺':16,'丞':6,'翰':16,'鈞':12,'銘':14,'鋒':15,
  '駿':17,'翊':11,'勛':12,'奕':9,'晏':10,'柏':9,'柔':9,
  '棠':12,'森':12,'楷':13,'楚':13,'楠':13,'楓':13,'樺':16,
  '煜':13,'照':13,'熠':15,'燁':16,'皓':12,'穎':16,'竣':12,
  '筱':13,'維':14,'繡':18,'翠':14,'耀':20,'肇':14,
  '臻':16,'若':11,'莉':13,'莎':13,'菁':14,'菲':14,
  '萊':14,'蓁':14,'蓉':16,'蓓':16,'薰':17,'蘊':22,
  '蘭':21,'裕':13,'謙':17,'豪':14,'賢':15,'赫':14,
  '鋆':15,'鐸':21,'雋':12,'霖':16,'霞':17,'靈':24,
  '韻':19,'黎':15,'龔':22,'磊':15,'穆':16,'竹':6,
  '紫':12,'聖':13,'聰':17,'茂':11,'莊':13,'蔚':17,
  '逸':15,'頤':16,'馨':20,'驊':22,'騏':18,
  '堯':12,'堃':11,'淳':12,'渙':13,'煒':13,
  '茗':12,'菡':14,'景':12,'詹':13,'束':7,
  '幸':8,'司':5,'韶':14,'鑫':24,'欣':8,'佳':8,
  '妍':7,'雯':12,'祺':13,'禧':17,'萌':14,
  '晞':11,'桓':10,'綺':14,'語':14,'芊':9,'苡':11,
  '歆':13,'弘':5,'弼':12,'弭':9,'弟':7,'弦':8,'弧':9,'弩':8,
  '妤':7,'昊':8,'晟':11,'辰':7,'曦':20,'軒':10,
  '晨':11,'薇':19,'佳':8,
  '俊':9,'傑':12,'宏':7,'雅':12,'靜':16,'慧':15,
  '敏':11,'婷':12,'秀':7,'芳':10,'麗':19,'英':11,
  '費':12,'起':10,'曾':12,'邱':7,'邵':12,'范':11,
  '魏':18,'陶':16,'姜':9,'鄒':17,'柴':10,'閻':16,
  '席':10,'季':8,'戚':11,'施':9,'袁':10,'鍾':17,
  '洪':10,'甘':5,'田':5,'石':5,'丘':5,'毛':4,'汪':8,
  '塗':13,'管':14,'闕':18,'鄧':19,'邢':7,'苗':11,
  '程':12,'崔':11,'於':8,'童':12,'阮':12,'湛':13,
  '溫':14,'項':12,'倪':10,'滕':14,'段':9,'鄂':11,
  '牧':8,'單':12,'瞿':18,'賴':16,'藍':18,'戴':18,
  '莫':13,'須':12,'聶':18,'廖':14,'畢':11,'殷':10
};

// kangxiStroke is now defined earlier alongside bihua()
// This old location is kept as a redirect for any other callers
// (actual implementation is in the bihua/kangxiStroke block above)

function analyzeName(fullName){
  if(!fullName||fullName.length<2)return null;
  const chars=[...fullName];
  const strokes=chars.map(c=>kangxiStroke(c));

  let tianGe,renGe,diGe,waiGe,zongGe;

  if(chars.length===2){
    // 單姓單名
    tianGe=strokes[0]+1;
    renGe=strokes[0]+strokes[1];
    diGe=strokes[1]+1;
    zongGe=strokes[0]+strokes[1];
    waiGe=2;
  }else if(chars.length===3){
    // 單姓雙名（最常見）
    tianGe=strokes[0]+1;
    renGe=strokes[0]+strokes[1];
    diGe=strokes[1]+strokes[2];
    zongGe=strokes[0]+strokes[1]+strokes[2];
    waiGe=strokes[2]+1; // 單姓雙名外格=名末字+1
  }else if(chars.length===4){
    // 複姓雙名
    tianGe=strokes[0]+strokes[1];
    renGe=strokes[1]+strokes[2];
    diGe=strokes[2]+strokes[3];
    zongGe=strokes.reduce((a,b)=>a+b,0);
    waiGe=strokes[0]+strokes[3];
  }else{
    return null;
  }

  // 五行
  function geWuxing(ge){
    const tail=ge%10;
    if(tail===1||tail===2)return'木';
    if(tail===3||tail===4)return'火';
    if(tail===5||tail===6)return'土';
    if(tail===7||tail===8)return'金';
    return'水';
  }

  // 吉凶（依正統81數理靈動數）
  function geFortune(ge){
    const n=((ge-1)%80)+1;
    // 吉祥運（大吉）— 依正統81數理靈動數（多版本校對）
    const dj=[1,3,5,7,8,11,13,15,16,18,21,23,24,25,31,32,33,35,37,39,41,45,47,48,52,57,61,63,65,67,68,81];
    // 次吉祥運（吉/半吉）
    const ji=[6,17,26,27,29,30,38,49,51,55,58,71,72,73,75,77];
    // 凶數（其餘）
    if(dj.includes(n))return{level:'大吉',cls:'text-success'};
    if(ji.includes(n))return{level:'吉',cls:'text-success'};
    return{level:'凶',cls:'text-danger'};
  }

  // 三才配置（完整125組合查表）
  const sanCai=[geWuxing(tianGe),geWuxing(renGe),geWuxing(diGe)];
  const _SC={
  '木木木':'大吉','木木火':'大吉','木木土':'吉','木木金':'凶','木木水':'吉',
  '木火木':'大吉','木火火':'吉','木火土':'大吉','木火金':'凶','木火水':'凶',
  '木土木':'凶','木土火':'平','木土土':'平','木土金':'凶','木土水':'凶',
  '木金木':'凶','木金火':'凶','木金土':'凶','木金金':'凶','木金水':'凶',
  '木水木':'大吉','木水火':'凶','木水土':'凶','木水金':'吉','木水水':'吉',
  '火木木':'大吉','火木火':'大吉','火木土':'吉','火木金':'凶','火木水':'吉',
  '火火木':'大吉','火火火':'吉','火火土':'大吉','火火金':'凶','火火水':'凶',
  '火土木':'平','火土火':'大吉','火土土':'大吉','火土金':'吉','火土水':'凶',
  '火金木':'凶','火金火':'凶','火金土':'凶','火金金':'凶','火金水':'凶',
  '火水木':'凶','火水火':'凶','火水土':'凶','火水金':'凶','火水水':'凶',
  '土木木':'平','土木火':'吉','土木土':'凶','土木金':'凶','土木水':'凶',
  '土火木':'大吉','土火火':'吉','土火土':'大吉','土火金':'平','土火水':'凶',
  '土土木':'平','土土火':'大吉','土土土':'大吉','土土金':'吉','土土水':'凶',
  '土金木':'凶','土金火':'凶','土金土':'大吉','土金金':'吉','土金水':'吉',
  '土水木':'凶','土水火':'凶','土水土':'凶','土水金':'凶','土水水':'凶',
  '金木木':'凶','金木火':'凶','金木土':'凶','金木金':'凶','金木水':'凶',
  '金火木':'凶','金火火':'凶','金火土':'平','金火金':'凶','金火水':'凶',
  '金土木':'平','金土火':'大吉','金土土':'大吉','金土金':'大吉','金土水':'平',
  '金金木':'凶','金金火':'凶','金金土':'大吉','金金金':'吉','金金水':'吉',
  '金水木':'大吉','金水火':'凶','金水土':'吉','金水金':'吉','金水水':'吉',
  '水木木':'大吉','水木火':'大吉','水木土':'吉','水木金':'凶','水木水':'吉',
  '水火木':'平','水火火':'凶','水火土':'平','水火金':'凶','水火水':'凶',
  '水土木':'凶','水土火':'平','水土土':'平','水土金':'平','水土水':'凶',
  '水金木':'凶','水金火':'凶','水金土':'吉','水金金':'吉','水金水':'吉',
  '水水木':'大吉','水水火':'凶','水水土':'凶','水水金':'吉','水水水':'平'
  };
  let sanCaiLevel=_SC[sanCai.join('')]||'平';

  return{
    name:fullName, strokes,
    tianGe:{num:tianGe,el:geWuxing(tianGe),fortune:geFortune(tianGe)},
    renGe:{num:renGe,el:geWuxing(renGe),fortune:geFortune(renGe)},
    diGe:{num:diGe,el:geWuxing(diGe),fortune:geFortune(diGe)},
    waiGe:{num:waiGe,el:geWuxing(waiGe),fortune:geFortune(waiGe)},
    zongGe:{num:zongGe,el:geWuxing(zongGe),fortune:geFortune(zongGe)},
    sanCai,sanCaiLevel
  };
}

/* =============================================================
   生肖姓名學 ZODIAC NAMEOLOGY（形義派）
   「字如環境，生肖如生物」— 適者生存原則
   ============================================================= */

// ── 出生年→生肖 ──
function getChineseZodiac(year){
  const z=['鼠','牛','虎','兔','龍','蛇','馬','羊','猴','雞','狗','豬'];
  return z[((year-4)%12+12)%12];
}
const ZODIAC_EMOJI={鼠:'🐭',牛:'🐂',虎:'🐯',兔:'🐰',龍:'🐲',蛇:'🐍',馬:'🐴',羊:'🐑',猴:'🐵',雞:'🐔',狗:'🐶',豬:'🐷'};
const ZODIAC_DIZHI={鼠:'子',牛:'丑',虎:'寅',兔:'卯',龍:'辰',蛇:'巳',馬:'午',羊:'未',猴:'申',雞:'酉',狗:'戌',豬:'亥'};

// ── 十二生肖字根喜忌資料庫 ──
// 每個生肖：{ like:[ {roots:[], label, reason, score} ], dislike:[ ... ] }
// roots 裡放字根/部首字串，拆字時比對
const ZODIAC_NAME_DB = {
  "鼠": {
    "like": [
      {
        "roots": [
          "口",
          "品",
          "宀",
          "冖",
          "穴",
          "門",
          "广",
          "冂"
        ],
        "label": "得洞",
        "reason": "鼠有洞穴藏身，安全感十足",
        "score": 8
      },
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥",
          "粟"
        ],
        "label": "得糧",
        "reason": "鼠愛五穀雜糧，衣食無缺",
        "score": 9
      },
      {
        "roots": [
          "王",
          "玉",
          "大",
          "君",
          "主",
          "天"
        ],
        "label": "稱王",
        "reason": "鼠排行老大，逢大稱王得位",
        "score": 8
      },
      {
        "roots": [
          "申",
          "辰"
        ],
        "label": "三合",
        "reason": "申子辰三合水局，貴人運強",
        "score": 8
      },
      {
        "roots": [
          "亥",
          "丑",
          "牛"
        ],
        "label": "三會",
        "reason": "亥子丑三會北方水局，根基穩固",
        "score": 7
      },
      {
        "roots": [
          "艹"
        ],
        "label": "得草",
        "reason": "田間有草有糧，安穩富足",
        "score": 6
      },
      {
        "roots": [
          "水",
          "氵",
          "雨",
          "冫"
        ],
        "label": "得水",
        "reason": "子鼠屬水，逢水旺得助力",
        "score": 7
      },
      {
        "roots": [
          "金",
          "钅"
        ],
        "label": "逢金",
        "reason": "金生水，得長輩助力提攜",
        "score": 6
      },
      {
        "roots": [
          "木",
          "林"
        ],
        "label": "得木",
        "reason": "鼠在林間有掩護，安全自在",
        "score": 5
      },
      {
        "roots": [
          "田"
        ],
        "label": "得田",
        "reason": "鼠入田中有糧食，豐衣足食",
        "score": 6
      },
      {
        "roots": [
          "夕"
        ],
        "label": "得夕",
        "reason": "鼠為夜行動物，逢夕如魚得水",
        "score": 5
      },
      {
        "roots": [
          "衣",
          "巾",
          "彡",
          "采",
          "糸"
        ],
        "label": "得衣",
        "reason": "鼠披彩衣華麗其身，增添魅力",
        "score": 6
      },
      {
        "roots": [
          "礻"
        ],
        "label": "得福",
        "reason": "鼠逢示旁有福祿加身",
        "score": 5
      }
    ],
    "dislike": [
      {
        "roots": [
          "午",
          "馬"
        ],
        "label": "六衝",
        "reason": "子午相衝，衝擊大，感情事業受損",
        "score": -9
      },
      {
        "roots": [
          "未",
          "羊"
        ],
        "label": "六害",
        "reason": "子未相害，做事常有阻礙",
        "score": -7
      },
      {
        "roots": [
          "火",
          "灬"
        ],
        "label": "見火",
        "reason": "子為水忌火，水火不容",
        "score": -6
      },
      {
        "roots": [
          "日",
          "光",
          "明"
        ],
        "label": "見光",
        "reason": "鼠見光即死，處境危險",
        "score": -6
      },
      {
        "roots": [
          "人",
          "亻",
          "入"
        ],
        "label": "遇人",
        "reason": "人見老鼠人人喊打，不利",
        "score": -4
      },
      {
        "roots": [
          "心",
          "忄",
          "月",
          "肉"
        ],
        "label": "遇肉",
        "reason": "鼠雖雜食但見肉代表危險投機",
        "score": -3
      },
      {
        "roots": [
          "土"
        ],
        "label": "逢土",
        "reason": "土剋水，鼠逢土受剋阻礙多",
        "score": -4
      },
      {
        "roots": [
          "小",
          "少"
        ],
        "label": "逢小",
        "reason": "鼠為生肖之首，逢小降格",
        "score": -3
      }
    ]
  },
  "牛": {
    "like": [
      {
        "roots": [
          "艹"
        ],
        "label": "得草",
        "reason": "牛為草食動物，有草安穩飽足",
        "score": 9
      },
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥",
          "粟"
        ],
        "label": "得糧",
        "reason": "牛逢五穀有吃有喝，福祿雙全",
        "score": 8
      },
      {
        "roots": [
          "水",
          "氵",
          "雨",
          "冫"
        ],
        "label": "得水",
        "reason": "丑牛土藏水，逢水相生順遂",
        "score": 7
      },
      {
        "roots": [
          "宀",
          "冖",
          "穴",
          "門",
          "广"
        ],
        "label": "得屋",
        "reason": "牛有牛棚安居，受人保護",
        "score": 7
      },
      {
        "roots": [
          "巳",
          "蛇",
          "辶",
          "弓",
          "几",
          "廴"
        ],
        "label": "六合",
        "reason": "巳丑合金，貴人運旺",
        "score": 8
      },
      {
        "roots": [
          "酉",
          "雞",
          "鳥"
        ],
        "label": "三合",
        "reason": "巳酉丑三合金局，助力宏大",
        "score": 8
      },
      {
        "roots": [
          "子",
          "鼠",
          "亥"
        ],
        "label": "三會",
        "reason": "亥子丑三會北方水局，根基穩",
        "score": 7
      },
      {
        "roots": [
          "田"
        ],
        "label": "得田",
        "reason": "牛在田中耕作有用武之地",
        "score": 6
      },
      {
        "roots": [
          "車"
        ],
        "label": "拉車",
        "reason": "牛拉車雖辛勞但受重用",
        "score": 4
      },
      {
        "roots": [
          "金",
          "钅"
        ],
        "label": "逢金",
        "reason": "土生金，才華能發揮",
        "score": 5
      }
    ],
    "dislike": [
      {
        "roots": [
          "未",
          "羊"
        ],
        "label": "六衝",
        "reason": "丑未相衝，做事波折反覆",
        "score": -9
      },
      {
        "roots": [
          "午",
          "馬"
        ],
        "label": "六害",
        "reason": "丑午相害，辛苦勞碌無回報",
        "score": -7
      },
      {
        "roots": [
          "王",
          "玉",
          "大",
          "君",
          "天",
          "帝"
        ],
        "label": "稱王",
        "reason": "牛逢大為犧牲祭品，勞碌命",
        "score": -7
      },
      {
        "roots": [
          "日",
          "光",
          "明"
        ],
        "label": "見日",
        "reason": "牛在烈日下耕作成喘牛",
        "score": -5
      },
      {
        "roots": [
          "山",
          "岳"
        ],
        "label": "上山",
        "reason": "牛走山路辛苦異常",
        "score": -5
      },
      {
        "roots": [
          "心",
          "忄",
          "月",
          "肉"
        ],
        "label": "遇肉",
        "reason": "牛為草食不食肉，見肉缺財",
        "score": -4
      },
      {
        "roots": [
          "衣",
          "巾",
          "彡",
          "采",
          "糸"
        ],
        "label": "披衣",
        "reason": "牛披彩衣如祭品，犧牲奉獻",
        "score": -6
      },
      {
        "roots": [
          "火",
          "灬"
        ],
        "label": "見火",
        "reason": "火剋金，有損牛之運勢",
        "score": -4
      },
      {
        "roots": [
          "礻"
        ],
        "label": "祭祀",
        "reason": "牛見示旁如被祭祀，大凶",
        "score": -7
      }
    ]
  },
  "虎": {
    "like": [
      {
        "roots": [
          "山",
          "岳",
          "岡"
        ],
        "label": "得山",
        "reason": "虎嘯山林，適得其所",
        "score": 9
      },
      {
        "roots": [
          "木",
          "林",
          "森",
          "東"
        ],
        "label": "得林",
        "reason": "虎居森林中如魚得水",
        "score": 9
      },
      {
        "roots": [
          "王",
          "玉",
          "大",
          "君",
          "天",
          "帝",
          "主"
        ],
        "label": "稱王",
        "reason": "虎為森林之王，稱王得位",
        "score": 9
      },
      {
        "roots": [
          "午",
          "馬"
        ],
        "label": "六合",
        "reason": "寅午合火，貴人助力",
        "score": 8
      },
      {
        "roots": [
          "戌",
          "犬",
          "犭"
        ],
        "label": "三合",
        "reason": "寅午戌三合火局，力量強大",
        "score": 8
      },
      {
        "roots": [
          "卯",
          "兔"
        ],
        "label": "三會",
        "reason": "寅卯辰三會東方木局",
        "score": 6
      },
      {
        "roots": [
          "心",
          "忄",
          "月",
          "肉"
        ],
        "label": "得肉",
        "reason": "虎為肉食動物，有肉飽足",
        "score": 8
      },
      {
        "roots": [
          "衣",
          "巾",
          "彡",
          "采",
          "糸"
        ],
        "label": "得衣",
        "reason": "虎披彩衣為華麗猛虎，威風加倍",
        "score": 7
      },
      {
        "roots": [
          "水",
          "氵",
          "雨",
          "冫"
        ],
        "label": "得水",
        "reason": "水生木，虎得水滋養",
        "score": 5
      },
      {
        "roots": [
          "口",
          "品"
        ],
        "label": "開口",
        "reason": "虎開口展威風，能力發揮",
        "score": 6
      }
    ],
    "dislike": [
      {
        "roots": [
          "申",
          "猴"
        ],
        "label": "六衝",
        "reason": "寅申相衝，衝突極大",
        "score": -9
      },
      {
        "roots": [
          "巳",
          "蛇",
          "辶",
          "弓",
          "几",
          "廴"
        ],
        "label": "六害",
        "reason": "蛇虎相害，互相傷害",
        "score": -7
      },
      {
        "roots": [
          "人",
          "亻",
          "入"
        ],
        "label": "遇人",
        "reason": "虎落平陽被犬欺，人伐虎不利",
        "score": -5
      },
      {
        "roots": [
          "日",
          "光",
          "明"
        ],
        "label": "見光",
        "reason": "虎在白日行動易暴露",
        "score": -3
      },
      {
        "roots": [
          "門",
          "宀"
        ],
        "label": "入門",
        "reason": "虎入平地被關，有志難伸",
        "score": -4
      },
      {
        "roots": [
          "小",
          "少"
        ],
        "label": "逢小",
        "reason": "虎逢小降格為貓，失威風",
        "score": -5
      },
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥"
        ],
        "label": "逢糧",
        "reason": "虎不食五穀，英雄無用武之地",
        "score": -3
      },
      {
        "roots": [
          "田"
        ],
        "label": "入田",
        "reason": "虎入田中被困，無法發揮",
        "score": -3
      }
    ]
  },
  "兔": {
    "like": [
      {
        "roots": [
          "艹",
          "竹"
        ],
        "label": "得草",
        "reason": "兔有青草，生活安穩無憂",
        "score": 9
      },
      {
        "roots": [
          "口",
          "品",
          "宀",
          "冖",
          "穴",
          "門",
          "广"
        ],
        "label": "得洞",
        "reason": "兔有窩穴，安全感十足",
        "score": 8
      },
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥"
        ],
        "label": "得糧",
        "reason": "五穀豐登，不愁溫飽",
        "score": 7
      },
      {
        "roots": [
          "木",
          "林",
          "森",
          "東"
        ],
        "label": "得林",
        "reason": "兔在林中有掩護，安全自在",
        "score": 8
      },
      {
        "roots": [
          "亥",
          "未"
        ],
        "label": "三合",
        "reason": "亥卯未三合木局，貴人運強",
        "score": 8
      },
      {
        "roots": [
          "寅"
        ],
        "label": "三會",
        "reason": "寅卯辰三會東方木局，根基穩",
        "score": 6
      },
      {
        "roots": [
          "衣",
          "巾",
          "彡",
          "采",
          "糸"
        ],
        "label": "得衣",
        "reason": "兔得彩衣為華麗，增添魅力",
        "score": 6
      },
      {
        "roots": [
          "水",
          "氵",
          "雨",
          "冫"
        ],
        "label": "得水",
        "reason": "水生木，兔得水滋養",
        "score": 5
      },
      {
        "roots": [
          "食"
        ],
        "label": "得食",
        "reason": "有食不缺，安穩富足",
        "score": 5
      },
      {
        "roots": [
          "小",
          "少"
        ],
        "label": "得小",
        "reason": "兔為小動物，小而得位",
        "score": 5
      }
    ],
    "dislike": [
      {
        "roots": [
          "酉",
          "雞",
          "鳥",
          "隹",
          "羽",
          "飛",
          "金",
          "钅",
          "西"
        ],
        "label": "六衝",
        "reason": "卯酉相衝，口舌是非不斷",
        "score": -9
      },
      {
        "roots": [
          "辰",
          "龍"
        ],
        "label": "六害",
        "reason": "卯辰相害，身邊人反成阻礙",
        "score": -7
      },
      {
        "roots": [
          "日",
          "光",
          "明",
          "白"
        ],
        "label": "見光",
        "reason": "兔見日光暴露，處境危險",
        "score": -5
      },
      {
        "roots": [
          "人",
          "亻",
          "入"
        ],
        "label": "遇人",
        "reason": "守株待兔，見人被獵捕",
        "score": -6
      },
      {
        "roots": [
          "大",
          "王",
          "玉",
          "君",
          "主",
          "天",
          "帝"
        ],
        "label": "太大",
        "reason": "兔太大引注目被捕，不宜張揚",
        "score": -5
      },
      {
        "roots": [
          "刀",
          "刂",
          "匕",
          "力",
          "斤"
        ],
        "label": "遇刀",
        "reason": "利刃在側，有開刀之虞",
        "score": -6
      },
      {
        "roots": [
          "火",
          "灬"
        ],
        "label": "見火",
        "reason": "兔遇火有劫，易衝動犯錯",
        "score": -5
      },
      {
        "roots": [
          "山",
          "岳",
          "阝"
        ],
        "label": "上山",
        "reason": "兔入山為虎口送食",
        "score": -4
      },
      {
        "roots": [
          "心",
          "忄",
          "月",
          "肉"
        ],
        "label": "遇肉",
        "reason": "兔為草食動物，見肉不合",
        "score": -3
      },
      {
        "roots": [
          "石"
        ],
        "label": "遇石",
        "reason": "兔撞石受傷，處境不利",
        "score": -3
      }
    ]
  },
  "龍": {
    "like": [
      {
        "roots": [
          "日",
          "明",
          "光",
          "星"
        ],
        "label": "得天",
        "reason": "龍見日月星飛龍在天，大展鴻圖",
        "score": 9
      },
      {
        "roots": [
          "水",
          "氵",
          "雨",
          "冫"
        ],
        "label": "得水",
        "reason": "龍入大海如魚得水，大富大貴",
        "score": 9
      },
      {
        "roots": [
          "王",
          "玉",
          "君",
          "主",
          "大",
          "天",
          "帝"
        ],
        "label": "得位",
        "reason": "龍為至尊，見王字根稱帝",
        "score": 9
      },
      {
        "roots": [
          "申",
          "猴"
        ],
        "label": "三合",
        "reason": "申子辰三合水局，貴人助力",
        "score": 8
      },
      {
        "roots": [
          "子",
          "鼠"
        ],
        "label": "三合",
        "reason": "申子辰三合水局，財運順暢",
        "score": 8
      },
      {
        "roots": [
          "月"
        ],
        "label": "明珠",
        "reason": "龍得月明珠，日月同輝",
        "score": 7
      },
      {
        "roots": [
          "馬",
          "午"
        ],
        "label": "龍馬",
        "reason": "龍馬精神，事業亨通",
        "score": 6
      },
      {
        "roots": [
          "衣",
          "巾",
          "彡",
          "采",
          "糸"
        ],
        "label": "得衣",
        "reason": "龍披彩衣增添威嚴",
        "score": 5
      }
    ],
    "dislike": [
      {
        "roots": [
          "戌",
          "犬",
          "犭"
        ],
        "label": "六衝",
        "reason": "辰戌正衝，生肖最大忌",
        "score": -9
      },
      {
        "roots": [
          "卯",
          "兔"
        ],
        "label": "六害",
        "reason": "玉兔見龍雲裡去，相害",
        "score": -7
      },
      {
        "roots": [
          "山",
          "岳",
          "阝"
        ],
        "label": "龍虎鬥",
        "reason": "山為虎鄉，龍虎相鬥",
        "score": -6
      },
      {
        "roots": [
          "虎",
          "寅"
        ],
        "label": "龍虎鬥",
        "reason": "龍虎鬥兩敗俱傷",
        "score": -6
      },
      {
        "roots": [
          "口",
          "品"
        ],
        "label": "困龍",
        "reason": "小口困龍，有志難伸",
        "score": -5
      },
      {
        "roots": [
          "辶",
          "弓",
          "几",
          "廴",
          "乙"
        ],
        "label": "降格",
        "reason": "龍降格為蛇，地位降低",
        "score": -5
      },
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥",
          "艹"
        ],
        "label": "逢糧",
        "reason": "龍不食人間煙火",
        "score": -3
      },
      {
        "roots": [
          "心",
          "忄",
          "肉"
        ],
        "label": "遇肉",
        "reason": "龍不食肉類五穀",
        "score": -3
      },
      {
        "roots": [
          "未",
          "羊"
        ],
        "label": "天羅",
        "reason": "辰未天羅地網，多禍多愁",
        "score": -5
      },
      {
        "roots": [
          "小",
          "少"
        ],
        "label": "逢小",
        "reason": "龍逢小降格，失威嚴",
        "score": -4
      }
    ]
  },
  "蛇": {
    "like": [
      {
        "roots": [
          "口",
          "品",
          "宀",
          "冖",
          "穴",
          "門",
          "广"
        ],
        "label": "得洞",
        "reason": "蛇有洞穴棲息，安全自在",
        "score": 8
      },
      {
        "roots": [
          "木",
          "林",
          "森"
        ],
        "label": "得林",
        "reason": "蛇在林中攀爬自如，如魚得水",
        "score": 7
      },
      {
        "roots": [
          "衣",
          "巾",
          "彡",
          "采",
          "糸"
        ],
        "label": "得衣",
        "reason": "蛇披彩衣轉升為龍",
        "score": 8
      },
      {
        "roots": [
          "酉",
          "雞",
          "鳥",
          "隹",
          "羽"
        ],
        "label": "六合",
        "reason": "巳酉合金，貴人運旺",
        "score": 8
      },
      {
        "roots": [
          "丑",
          "牛"
        ],
        "label": "三合",
        "reason": "巳酉丑三合金局",
        "score": 8
      },
      {
        "roots": [
          "午",
          "馬"
        ],
        "label": "六合",
        "reason": "巳午會南方火局",
        "score": 7
      },
      {
        "roots": [
          "心",
          "忄",
          "月",
          "肉"
        ],
        "label": "得肉",
        "reason": "蛇為肉食動物，有肉飽足",
        "score": 7
      },
      {
        "roots": [
          "田"
        ],
        "label": "得田",
        "reason": "蛇在田間有食物來源",
        "score": 5
      },
      {
        "roots": [
          "辶",
          "弓",
          "几",
          "廴",
          "乙"
        ],
        "label": "同形",
        "reason": "蛇形字根為同類相助",
        "score": 6
      },
      {
        "roots": [
          "火",
          "灬"
        ],
        "label": "得火",
        "reason": "巳蛇屬火，見火比旺",
        "score": 5
      },
      {
        "roots": [
          "王",
          "玉",
          "大",
          "君",
          "天"
        ],
        "label": "稱王",
        "reason": "蛇有稱王之意（小龍）",
        "score": 5
      }
    ],
    "dislike": [
      {
        "roots": [
          "亥",
          "豬",
          "豕"
        ],
        "label": "六衝",
        "reason": "巳亥相衝，衝擊極大",
        "score": -9
      },
      {
        "roots": [
          "寅",
          "虎"
        ],
        "label": "六害",
        "reason": "蛇虎相害，互相傷害",
        "score": -7
      },
      {
        "roots": [
          "人",
          "亻",
          "入"
        ],
        "label": "遇人",
        "reason": "人蛇相遇兩害怕",
        "score": -5
      },
      {
        "roots": [
          "日",
          "光",
          "明"
        ],
        "label": "見光",
        "reason": "蛇怕暴露在陽光下",
        "score": -4
      },
      {
        "roots": [
          "水",
          "氵",
          "雨",
          "冫"
        ],
        "label": "見水",
        "reason": "蛇入水有溺水之虞",
        "score": -4
      },
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥",
          "艹"
        ],
        "label": "逢糧",
        "reason": "蛇不食五穀雜糧",
        "score": -3
      },
      {
        "roots": [
          "山",
          "岳"
        ],
        "label": "上山",
        "reason": "蛇在山中遇老虎不利",
        "score": -3
      },
      {
        "roots": [
          "石"
        ],
        "label": "遇石",
        "reason": "打草驚蛇之虞",
        "score": -3
      }
    ]
  },
  "馬": {
    "like": [
      {
        "roots": [
          "艹"
        ],
        "label": "得草",
        "reason": "馬有草原奔馳，自在快意",
        "score": 9
      },
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥"
        ],
        "label": "得糧",
        "reason": "馬有五穀飽足安穩",
        "score": 7
      },
      {
        "roots": [
          "木",
          "林",
          "森",
          "東"
        ],
        "label": "得林",
        "reason": "馬在林間有蔭有靠",
        "score": 6
      },
      {
        "roots": [
          "寅",
          "虎"
        ],
        "label": "六合",
        "reason": "寅午合火，貴人助力",
        "score": 8
      },
      {
        "roots": [
          "戌",
          "犬",
          "犭"
        ],
        "label": "三合",
        "reason": "寅午戌三合火局",
        "score": 8
      },
      {
        "roots": [
          "未",
          "羊"
        ],
        "label": "三合",
        "reason": "午未合，桃花貴人旺",
        "score": 7
      },
      {
        "roots": [
          "衣",
          "巾",
          "彡",
          "采",
          "糸"
        ],
        "label": "得衣",
        "reason": "馬披彩衣為良駒，得遇伯樂",
        "score": 7
      },
      {
        "roots": [
          "龍",
          "辰"
        ],
        "label": "龍馬",
        "reason": "龍馬精神，事業亨通",
        "score": 6
      },
      {
        "roots": [
          "大",
          "王",
          "玉",
          "君",
          "天"
        ],
        "label": "稱王",
        "reason": "馬逢大為良駒受重用",
        "score": 5
      },
      {
        "roots": [
          "火",
          "灬"
        ],
        "label": "得火",
        "reason": "午馬屬火，見火比旺",
        "score": 5
      },
      {
        "roots": [
          "山",
          "岳"
        ],
        "label": "得山",
        "reason": "馬在山中自在奔馳",
        "score": 5
      },
      {
        "roots": [
          "宀",
          "冖",
          "穴",
          "門"
        ],
        "label": "得屋",
        "reason": "馬有馬廄安居",
        "score": 5
      }
    ],
    "dislike": [
      {
        "roots": [
          "子",
          "鼠"
        ],
        "label": "六衝",
        "reason": "子午相衝，衝擊極大",
        "score": -9
      },
      {
        "roots": [
          "丑",
          "牛"
        ],
        "label": "六害",
        "reason": "丑午相害，勞碌無功",
        "score": -7
      },
      {
        "roots": [
          "水",
          "氵",
          "雨",
          "冫"
        ],
        "label": "見水",
        "reason": "馬入水有溺水之虞",
        "score": -5
      },
      {
        "roots": [
          "田"
        ],
        "label": "入田",
        "reason": "馬入田地被困耕田勞碌",
        "score": -5
      },
      {
        "roots": [
          "口",
          "品"
        ],
        "label": "開口",
        "reason": "馬開口不祥，好馬不吃回頭草",
        "score": -3
      },
      {
        "roots": [
          "人",
          "亻",
          "入"
        ],
        "label": "遇人",
        "reason": "馬被人騎驅使勞碌",
        "score": -4
      },
      {
        "roots": [
          "心",
          "忄",
          "月",
          "肉"
        ],
        "label": "遇肉",
        "reason": "馬為草食動物不食肉",
        "score": -3
      },
      {
        "roots": [
          "石"
        ],
        "label": "遇石",
        "reason": "馬行石路不穩",
        "score": -3
      }
    ]
  },
  "羊": {
    "like": [
      {
        "roots": [
          "艹",
          "竹"
        ],
        "label": "得草",
        "reason": "羊有青草飽足安穩",
        "score": 9
      },
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥"
        ],
        "label": "得糧",
        "reason": "羊逢五穀不愁吃穿",
        "score": 8
      },
      {
        "roots": [
          "口",
          "品",
          "宀",
          "冖",
          "穴",
          "門",
          "广"
        ],
        "label": "得洞",
        "reason": "羊有欄有洞受保護",
        "score": 7
      },
      {
        "roots": [
          "木",
          "林",
          "森",
          "東"
        ],
        "label": "得林",
        "reason": "羊在林中有蔭安穩",
        "score": 7
      },
      {
        "roots": [
          "亥",
          "豬",
          "豕"
        ],
        "label": "三合",
        "reason": "亥卯未三合木局",
        "score": 8
      },
      {
        "roots": [
          "卯",
          "兔"
        ],
        "label": "三合",
        "reason": "亥卯未三合木局",
        "score": 8
      },
      {
        "roots": [
          "午",
          "馬"
        ],
        "label": "六合",
        "reason": "午未合，桃花貴人旺",
        "score": 7
      },
      {
        "roots": [
          "小",
          "少"
        ],
        "label": "得小",
        "reason": "羊喜小得位，安穩自在",
        "score": 6
      },
      {
        "roots": [
          "水",
          "氵",
          "雨",
          "冫"
        ],
        "label": "得水",
        "reason": "羊逢水有滋潤",
        "score": 4
      },
      {
        "roots": [
          "火",
          "灬"
        ],
        "label": "得火",
        "reason": "未羊土藏火，見火比旺",
        "score": 5
      },
      {
        "roots": [
          "食"
        ],
        "label": "得食",
        "reason": "有食安穩",
        "score": 5
      }
    ],
    "dislike": [
      {
        "roots": [
          "丑",
          "牛"
        ],
        "label": "六衝",
        "reason": "丑未相衝，做事反覆波折",
        "score": -9
      },
      {
        "roots": [
          "子",
          "鼠"
        ],
        "label": "六害",
        "reason": "子未相害，常遇阻礙",
        "score": -7
      },
      {
        "roots": [
          "辰",
          "龍"
        ],
        "label": "天羅",
        "reason": "辰為天羅困羊，有志難伸",
        "score": -6
      },
      {
        "roots": [
          "戌",
          "犬",
          "犭"
        ],
        "label": "地網",
        "reason": "戌為地網困羊",
        "score": -6
      },
      {
        "roots": [
          "王",
          "玉",
          "大",
          "君",
          "天",
          "帝"
        ],
        "label": "太大",
        "reason": "羊逢大為祭品犧牲",
        "score": -7
      },
      {
        "roots": [
          "衣",
          "巾",
          "彡",
          "采",
          "糸"
        ],
        "label": "披衣",
        "reason": "羊披彩衣上供桌",
        "score": -6
      },
      {
        "roots": [
          "心",
          "忄",
          "月",
          "肉"
        ],
        "label": "遇肉",
        "reason": "羊為草食見肉失落",
        "score": -4
      },
      {
        "roots": [
          "刀",
          "刂",
          "匕",
          "力",
          "斤"
        ],
        "label": "遇刀",
        "reason": "羊逢刀為被宰殺",
        "score": -6
      },
      {
        "roots": [
          "日",
          "光",
          "明"
        ],
        "label": "見日",
        "reason": "羊在烈日下辛苦",
        "score": -3
      }
    ]
  },
  "猴": {
    "like": [
      {
        "roots": [
          "口",
          "品",
          "宀",
          "冖",
          "穴",
          "門",
          "广"
        ],
        "label": "得洞",
        "reason": "猴有洞穴棲息安全",
        "score": 8
      },
      {
        "roots": [
          "木",
          "林",
          "森",
          "東"
        ],
        "label": "得林",
        "reason": "猴在林中攀爬自如",
        "score": 9
      },
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥"
        ],
        "label": "得糧",
        "reason": "猴有五穀安穩飽足",
        "score": 7
      },
      {
        "roots": [
          "子",
          "鼠"
        ],
        "label": "三合",
        "reason": "申子辰三合水局",
        "score": 8
      },
      {
        "roots": [
          "辰",
          "龍"
        ],
        "label": "三合",
        "reason": "申子辰三合水局",
        "score": 8
      },
      {
        "roots": [
          "水",
          "氵",
          "雨",
          "冫"
        ],
        "label": "得水",
        "reason": "金生水，猴逢水聰明伶俐",
        "score": 6
      },
      {
        "roots": [
          "金",
          "钅"
        ],
        "label": "得金",
        "reason": "申猴屬金，見金比旺",
        "score": 6
      },
      {
        "roots": [
          "土"
        ],
        "label": "得土",
        "reason": "土生金，猴逢土有根基",
        "score": 5
      },
      {
        "roots": [
          "人",
          "亻",
          "入"
        ],
        "label": "得人",
        "reason": "猴得人緣好，有貴人",
        "score": 5
      },
      {
        "roots": [
          "王",
          "玉",
          "大",
          "君",
          "天"
        ],
        "label": "稱王",
        "reason": "猴為山中王，得位有威",
        "score": 7
      },
      {
        "roots": [
          "衣",
          "巾",
          "彡",
          "采",
          "糸"
        ],
        "label": "得衣",
        "reason": "猴披衣如人，增添智慧",
        "score": 5
      },
      {
        "roots": [
          "山",
          "岳"
        ],
        "label": "得山",
        "reason": "猴在山中自在為王",
        "score": 6
      },
      {
        "roots": [
          "礻"
        ],
        "label": "得示",
        "reason": "示旁含申為猴本位",
        "score": 7
      },
      {
        "roots": [
          "心",
          "忄",
          "月",
          "肉"
        ],
        "label": "得肉",
        "reason": "猴為雜食動物有肉飽足",
        "score": 5
      }
    ],
    "dislike": [
      {
        "roots": [
          "寅",
          "虎"
        ],
        "label": "六衝",
        "reason": "寅申相衝，衝突極大",
        "score": -9
      },
      {
        "roots": [
          "亥",
          "豬",
          "豕"
        ],
        "label": "六害",
        "reason": "豬遇猿猴似箭投",
        "score": -7
      },
      {
        "roots": [
          "火",
          "灬"
        ],
        "label": "見火",
        "reason": "火剋金，猴逢火受傷",
        "score": -6
      },
      {
        "roots": [
          "田"
        ],
        "label": "入田",
        "reason": "猴入田被獵人追捕",
        "score": -4
      },
      {
        "roots": [
          "辶",
          "弓",
          "几",
          "廴",
          "乙"
        ],
        "label": "蛇形",
        "reason": "巳猴相刑害",
        "score": -4
      },
      {
        "roots": [
          "刀",
          "刂",
          "匕",
          "力",
          "斤"
        ],
        "label": "遇刀",
        "reason": "利器在旁有傷害之虞",
        "score": -5
      }
    ]
  },
  "雞": {
    "like": [
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥",
          "粟"
        ],
        "label": "得糧",
        "reason": "雞有五穀安穩飽足",
        "score": 9
      },
      {
        "roots": [
          "艹"
        ],
        "label": "得草",
        "reason": "雞逢草有食物來源",
        "score": 7
      },
      {
        "roots": [
          "虫"
        ],
        "label": "得蟲",
        "reason": "雞食蟲安穩自在",
        "score": 6
      },
      {
        "roots": [
          "口",
          "品",
          "宀",
          "冖",
          "穴",
          "門",
          "广"
        ],
        "label": "得洞",
        "reason": "雞有雞舍安居",
        "score": 7
      },
      {
        "roots": [
          "丑",
          "牛"
        ],
        "label": "三合",
        "reason": "巳酉丑三合金局",
        "score": 8
      },
      {
        "roots": [
          "巳",
          "蛇",
          "辶",
          "弓",
          "几",
          "廴"
        ],
        "label": "三合",
        "reason": "巳酉丑三合金局",
        "score": 8
      },
      {
        "roots": [
          "衣",
          "巾",
          "彡",
          "采",
          "糸",
          "羽",
          "飛"
        ],
        "label": "得衣",
        "reason": "雞有羽毛華麗增添魅力",
        "score": 7
      },
      {
        "roots": [
          "山",
          "岳"
        ],
        "label": "得山",
        "reason": "雞上山為鳳凰升格",
        "score": 7
      },
      {
        "roots": [
          "金",
          "钅"
        ],
        "label": "得金",
        "reason": "酉雞屬金，見金比旺",
        "score": 6
      },
      {
        "roots": [
          "土"
        ],
        "label": "得土",
        "reason": "土生金，根基穩固",
        "score": 5
      },
      {
        "roots": [
          "小",
          "少"
        ],
        "label": "得小",
        "reason": "雞逢小安穩得位",
        "score": 4
      },
      {
        "roots": [
          "王",
          "玉",
          "大",
          "君",
          "天"
        ],
        "label": "稱王",
        "reason": "雞上山稱鳳凰得位",
        "score": 5
      }
    ],
    "dislike": [
      {
        "roots": [
          "卯",
          "兔"
        ],
        "label": "六衝",
        "reason": "卯酉相衝，衝擊極大",
        "score": -9
      },
      {
        "roots": [
          "戌",
          "犬",
          "犭"
        ],
        "label": "六害",
        "reason": "金雞遇犬淚雙流",
        "score": -7
      },
      {
        "roots": [
          "水",
          "氵",
          "雨",
          "冫"
        ],
        "label": "見水",
        "reason": "雞落水不吉，有溺水之虞",
        "score": -5
      },
      {
        "roots": [
          "心",
          "忄",
          "月",
          "肉"
        ],
        "label": "遇肉",
        "reason": "雞為禽食不食肉",
        "score": -4
      },
      {
        "roots": [
          "木",
          "林",
          "森"
        ],
        "label": "逢木",
        "reason": "金剋木耗損精力",
        "score": -3
      },
      {
        "roots": [
          "刀",
          "刂",
          "匕",
          "力",
          "斤"
        ],
        "label": "遇刀",
        "reason": "雞遇刀如被宰殺",
        "score": -6
      },
      {
        "roots": [
          "人",
          "亻",
          "入"
        ],
        "label": "遇人",
        "reason": "雞逢人被宰殺",
        "score": -5
      },
      {
        "roots": [
          "火",
          "灬"
        ],
        "label": "見火",
        "reason": "烤雞大凶",
        "score": -6
      }
    ]
  },
  "狗": {
    "like": [
      {
        "roots": [
          "口",
          "品",
          "宀",
          "冖",
          "穴",
          "門",
          "广"
        ],
        "label": "得洞",
        "reason": "狗有家有窩，忠心守護",
        "score": 8
      },
      {
        "roots": [
          "心",
          "忄",
          "月",
          "肉"
        ],
        "label": "得肉",
        "reason": "狗為肉食動物，有肉飽足",
        "score": 9
      },
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥"
        ],
        "label": "得糧",
        "reason": "狗有五穀安穩",
        "score": 6
      },
      {
        "roots": [
          "寅",
          "虎"
        ],
        "label": "三合",
        "reason": "寅午戌三合火局",
        "score": 8
      },
      {
        "roots": [
          "午",
          "馬"
        ],
        "label": "三合",
        "reason": "寅午戌三合火局",
        "score": 8
      },
      {
        "roots": [
          "卯",
          "兔"
        ],
        "label": "六合",
        "reason": "卯戌合火，貴人運旺",
        "score": 8
      },
      {
        "roots": [
          "人",
          "亻",
          "入"
        ],
        "label": "得人",
        "reason": "狗為人類忠僕，有人依靠",
        "score": 7
      },
      {
        "roots": [
          "小",
          "少"
        ],
        "label": "得小",
        "reason": "狗逢小可愛得人疼",
        "score": 5
      },
      {
        "roots": [
          "衣",
          "巾",
          "彡",
          "采",
          "糸"
        ],
        "label": "得衣",
        "reason": "狗披衣受人寵愛",
        "score": 6
      },
      {
        "roots": [
          "木",
          "林",
          "森"
        ],
        "label": "得林",
        "reason": "狗在林中自在",
        "score": 4
      },
      {
        "roots": [
          "火",
          "灬"
        ],
        "label": "得火",
        "reason": "戌狗土藏金，見火溫暖",
        "score": 5
      },
      {
        "roots": [
          "土"
        ],
        "label": "得土",
        "reason": "狗逢土根基穩",
        "score": 5
      }
    ],
    "dislike": [
      {
        "roots": [
          "辰",
          "龍"
        ],
        "label": "六衝",
        "reason": "辰戌正衝，天羅地網",
        "score": -9
      },
      {
        "roots": [
          "酉",
          "雞",
          "鳥",
          "隹",
          "羽",
          "飛"
        ],
        "label": "六害",
        "reason": "雞犬不寧，口舌是非",
        "score": -7
      },
      {
        "roots": [
          "丑",
          "牛"
        ],
        "label": "三刑",
        "reason": "丑戌相刑，是非煩惱",
        "score": -6
      },
      {
        "roots": [
          "未",
          "羊"
        ],
        "label": "相破",
        "reason": "未戌相破，做事反覆",
        "score": -5
      },
      {
        "roots": [
          "水",
          "氵",
          "雨",
          "冫"
        ],
        "label": "落水",
        "reason": "落水狗人人喊打",
        "score": -6
      },
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥",
          "艹"
        ],
        "label": "素食",
        "reason": "狗為肉食見素不飽",
        "score": -3
      },
      {
        "roots": [
          "王",
          "玉",
          "大",
          "君",
          "天"
        ],
        "label": "太大",
        "reason": "狗稱王有虎視耽耽之憂",
        "score": -4
      },
      {
        "roots": [
          "日",
          "光",
          "明"
        ],
        "label": "見日",
        "reason": "狗吠日，愛管閒事徒勞",
        "score": -4
      },
      {
        "roots": [
          "田"
        ],
        "label": "入田",
        "reason": "狗入田追兔不受歡迎",
        "score": -3
      }
    ]
  },
  "豬": {
    "like": [
      {
        "roots": [
          "口",
          "品",
          "宀",
          "冖",
          "穴",
          "門",
          "广"
        ],
        "label": "得洞",
        "reason": "豬有豬圈安居，被養育照顧",
        "score": 8
      },
      {
        "roots": [
          "禾",
          "米",
          "豆",
          "麥",
          "粟"
        ],
        "label": "得糧",
        "reason": "豬有五穀安穩飽足",
        "score": 9
      },
      {
        "roots": [
          "艹"
        ],
        "label": "得草",
        "reason": "豬逢草有食物安穩",
        "score": 7
      },
      {
        "roots": [
          "卯",
          "兔"
        ],
        "label": "三合",
        "reason": "亥卯未三合木局",
        "score": 8
      },
      {
        "roots": [
          "未",
          "羊"
        ],
        "label": "三合",
        "reason": "亥卯未三合木局",
        "score": 8
      },
      {
        "roots": [
          "子",
          "鼠"
        ],
        "label": "三會",
        "reason": "亥子丑三會北方水局",
        "score": 7
      },
      {
        "roots": [
          "丑",
          "牛"
        ],
        "label": "三會",
        "reason": "亥子丑三會水局",
        "score": 7
      },
      {
        "roots": [
          "木",
          "林",
          "森",
          "東"
        ],
        "label": "得林",
        "reason": "豬在林中有木有靠",
        "score": 6
      },
      {
        "roots": [
          "月"
        ],
        "label": "得月",
        "reason": "月為卯兔，三合有助",
        "score": 6
      },
      {
        "roots": [
          "水",
          "氵",
          "雨",
          "冫"
        ],
        "label": "得水",
        "reason": "亥豬屬水，逢水旺",
        "score": 6
      },
      {
        "roots": [
          "金",
          "钅"
        ],
        "label": "得金",
        "reason": "金生水，有長輩助力",
        "score": 5
      },
      {
        "roots": [
          "田"
        ],
        "label": "得田",
        "reason": "豬在田中有糧有食",
        "score": 5
      }
    ],
    "dislike": [
      {
        "roots": [
          "巳",
          "蛇"
        ],
        "label": "六衝",
        "reason": "巳亥相衝，衝擊極大",
        "score": -9
      },
      {
        "roots": [
          "辶",
          "弓",
          "几",
          "廴",
          "乙"
        ],
        "label": "蛇形",
        "reason": "蛇形字根=六衝巳蛇",
        "score": -8
      },
      {
        "roots": [
          "申",
          "猴"
        ],
        "label": "六害",
        "reason": "豬遇猿猴似箭投",
        "score": -7
      },
      {
        "roots": [
          "衣",
          "巾",
          "彡",
          "采",
          "糸"
        ],
        "label": "披衣",
        "reason": "豬披彩衣上供桌祭祀",
        "score": -7
      },
      {
        "roots": [
          "王",
          "玉",
          "大",
          "君",
          "天",
          "帝"
        ],
        "label": "太大",
        "reason": "豬逢大為祭品犧牲",
        "score": -6
      },
      {
        "roots": [
          "刀",
          "刂",
          "匕",
          "力",
          "斤"
        ],
        "label": "遇刀",
        "reason": "殺豬刀大凶",
        "score": -7
      },
      {
        "roots": [
          "礻"
        ],
        "label": "祭祀",
        "reason": "豬見祭祀如上供桌",
        "score": -8
      },
      {
        "roots": [
          "火",
          "灬"
        ],
        "label": "見火",
        "reason": "烤豬大凶",
        "score": -6
      },
      {
        "roots": [
          "山",
          "岳",
          "阝"
        ],
        "label": "上山",
        "reason": "豬上山勞碌",
        "score": -3
      },
      {
        "roots": [
          "人",
          "亻",
          "入"
        ],
        "label": "遇人",
        "reason": "人豬相遇，豬被宰殺",
        "score": -5
      },
      {
        "roots": [
          "車",
          "軍"
        ],
        "label": "遇車",
        "reason": "豬見車代表被載送宰殺，奔波勞碌",
        "score": -5
      },
      {
        "roots": [
          "网",
          "罒",
          "冂"
        ],
        "label": "遇網",
        "reason": "豬見網代表被捕捉束縛，有志難伸",
        "score": -4
      }
    ]
  }
};

// ── 字根拆解引擎// ── 字根拆解引擎（預建表 + Unicode 部首雙軌） ──
// 預建表：常見字→包含的字根（精準拆解）
const CHAR_ROOTS = {
  // 蛇形字根（辶弓几廴之乙）相關字
  '弘':['弓'],'強':['弓'],'張':['弓'],'弦':['弓'],'引':['弓'],'弟':['弓'],'弘':['弓'],
  '建':['廴'],'廷':['廴'],'延':['廴'],
  '連':['辶'],'通':['辶'],'達':['辶'],'道':['辶'],'遠':['辶'],'運':['辶'],'進':['辶'],'遊':['辶'],'過':['辶'],'近':['辶'],'迎':['辶'],'返':['辶'],'逢':['辶'],'遷':['辶'],'選':['辶'],'透':['辶'],'造':['辶'],'迷':['辶'],'追':['辶'],'退':['辶'],'送':['辶'],'逸':['辶'],'遙':['辶'],'邊':['辶'],
  '乙':['乙'],'也':['乙'],'乾':['乙'],
  // 人/亻相關
  '仁':['亻'],'仙':['亻'],'代':['亻'],'令':['令','人'],'以':['人'],'任':['亻'],'份':['亻'],'伯':['亻'],'何':['亻'],'佑':['亻'],'佳':['亻'],'依':['亻'],'俊':['亻'],'信':['亻'],'修':['亻'],'倫':['亻'],'偉':['亻'],'傑':['亻'],'儀':['亻'],'優':['亻'],
  // 王/玉相關
  '王':['王'],'玉':['玉'],'珍':['王'],'珠':['王'],'琪':['王'],'琳':['王'],'瑞':['王'],'瑜':['王'],'瑤':['王'],'璇':['王'],'璿':['王'],'環':['王'],'瓊':['王'],'玟':['王'],'玫':['王'],'珊':['王'],'琦':['王'],'璋':['王'],'璞':['王'],'璐':['王'],'瑰':['王'],'琉':['王'],'理':['王'],'現':['王'],'琴':['王'],
  // 大相關
  '大':['大'],'天':['大'],'太':['大'],'奇':['大'],'奧':['大'],'奉':['大'],'奎':['大'],'奕':['大'],
  // 彩衣相關
  '彩':['彡'],'影':['彡'],'彤':['彡'],'彰':['彡'],'形':['彡'],
  '帆':['巾'],'布':['巾'],'帝':['巾'],'師':['巾'],'帥':['巾'],'常':['巾'],'幕':['巾'],'幣':['巾'],'帶':['巾'],'希':['巾'],'帷':['巾'],
  '衣':['衣'],'裝':['衣'],'裕':['衣'],'褔':['衣'],'表':['衣'],'被':['衣'],'袁':['衣','袁'],'裴':['衣'],'補':['衣'],'衫':['衣'],'褚':['衣'],'裙':['衣'],'褐':['衣'],
  '初':['衣','刀'],'袖':['衣'],
  '紅':['糸'],'紋':['糸'],'純':['糸'],'素':['糸'],'紫':['糸'],'細':['糸'],'結':['糸'],'絲':['糸'],'綺':['糸'],'綠':['糸'],'緣':['糸'],'線':['糸'],'縈':['糸'],'織':['糸'],'繡':['糸'],'綿':['糸'],'綸':['糸'],'緯':['糸'],'繁':['糸'],'繼':['糸'],
  // 刀刂相關
  '刀':['刀'],'分':['刀'],'切':['刀'],'刊':['刂'],'列':['刂'],'刑':['刂'],'利':['刂'],'別':['刂'],'判':['刂'],'到':['刂'],'制':['刂'],'剛':['刂'],'前':['刂'],'剪':['刀'],'創':['刂'],'劉':['刂'],'劍':['刂'],'劑':['刂'],
  '力':['力'],'功':['力'],'加':['力'],'助':['力'],'努':['力'],'勇':['力'],'動':['力'],'勝':['力'],'勢':['力'],'勵':['力'],'勤':['力'],
  '匕':['匕'],'比':['匕'],'北':['匕'],
  '斤':['斤'],'新':['斤'],'斷':['斤'],'所':['斤'],
  // 宀冖穴門口相關
  '安':['宀'],'宇':['宀'],'守':['宀'],'宏':['宀'],'宗':['宀'],'官':['宀'],'定':['宀'],'宜':['宀'],'客':['宀'],'宣':['宀'],'室':['宀'],'宮':['宀'],'家':['宀'],'容':['宀'],'富':['宀'],'寒':['宀'],'寓':['宀'],'寧':['宀'],'實':['宀'],'寶':['宀'],'寬':['宀'],
  '冠':['冖','冠'],'冥':['冖'],'冤':['冖'],'寫':['冖'],
  '門':['門'],'閃':['門'],'閉':['門'],'開':['門'],'間':['門'],'閒':['門'],'閣':['門'],'闊':['門'],'關':['門'],
  '口':['口'],'古':['口'],'台':['口'],'吉':['口'],'合':['口'],'名':['口'],'品':['口','品'],'唐':['口'],'嘉':['口'],'喬':['口'],
  // 禾米豆糧食相關
  '禾':['禾'],'秀':['禾'],'私':['禾'],'秋':['禾'],'科':['禾'],'秦':['禾'],'程':['禾'],'稀':['禾'],'種':['禾'],'稚':['禾'],'穎':['禾'],'穗':['禾'],'穰':['禾'],
  '米':['米'],'粒':['米'],'精':['米'],'粹':['米'],'糧':['米'],'粉':['米'],'粟':['米'],
  '豆':['豆'],'豐':['豆'],'豔':['豆'],
  // 艹草相關
  '芳':['艹'],'花':['艹'],'苗':['艹'],'英':['艹'],'草':['艹'],'茂':['艹'],'莊':['艹'],'華':['艹'],'萍':['艹'],'菁':['艹'],'菲':['艹'],'萱':['艹'],'蓉':['艹'],'蓮':['艹'],'蕙':['艹'],'蕊':['艹'],'藝':['艹'],'蘭':['艹'],'蘋':['艹'],'薇':['艹'],'芬':['艹'],'芸':['艹'],'若':['艹'],'茹':['艹'],'荷':['艹'],'莉':['艹'],'葉':['艹'],'蒼':['艹'],'蔚':['艹'],'蕭':['艹'],
  // 木林相關
  '木':['木'],'本':['木'],'杉':['木'],'李':['木'],'村':['木'],'杏':['木'],'材':['木'],'松':['木'],'林':['木','林'],'果':['木'],'柏':['木'],'柔':['木'],'柳':['木'],'桂':['木'],'桃':['木'],'梅':['木'],'梓':['木'],'森':['木','林'],'楊':['木'],'楓':['木'],'榮':['木'],'樂':['木'],'樹':['木'],'橋':['木'],'檸':['木'],'棟':['木'],'棉':['木'],
  // 山岳相關
  '山':['山'],'岳':['山'],'峰':['山'],'崇':['山'],'嵐':['山'],'嶺':['山'],'巍':['山'],'崖':['山'],'岩':['山'],'崑':['山'],'嵩':['山'],
  // 水氵雨相關
  '水':['水'],'永':['水'],'江':['氵'],'河':['氵'],'沁':['氵'],'沈':['氵'],'沐':['氵'],'沛':['氵'],'治':['氵'],'泉':['氵'],'泰':['氵'],'洋':['氵'],'洛':['氵'],'洪':['氵'],'浩':['氵'],'海':['氵'],'涵':['氵'],'淑':['氵'],'淳':['氵'],'清':['氵'],'渝':['氵'],'湘':['氵'],'源':['氵'],'溪':['氵'],'滿':['氵'],'漢':['氵'],'潔':['氵'],'潤':['氵'],'澤':['氵'],'濤':['氵'],'瀚':['氵'],'灣':['氵'],
  '雨':['雨'],'雪':['雨'],'雲':['雨'],'零':['雨'],'霖':['雨'],'霜':['雨'],'霞':['雨'],'露':['雨'],'靈':['雨'],'霆':['雨'],
  // 火灬相關
  '火':['火'],'炎':['火'],'炳':['火'],'烈':['火'],'煌':['火'],'煥':['火'],'熊':['火','灬'],'熙':['灬'],'燕':['灬'],'燦':['火'],'照':['灬'],'熱':['灬'],'然':['灬'],'烹':['灬'],'煮':['灬'],'點':['灬'],
  // 日月光明相關
  '日':['日'],'旭':['日'],'昌':['日'],'明':['日','月','明'],'昕':['日'],'星':['日','星'],'春':['日'],'昭':['日'],'映':['日'],'晨':['日'],'景':['日'],'晶':['日'],'智':['日'],'暖':['日'],'曉':['日'],'曜':['日'],'曦':['日'],'旺':['日'],'晴':['日'],
  '月':['月'],'朋':['月'],'朗':['月'],'望':['月'],'朝':['月'],
  '光':['光'],'晃':['光','日'],
  // 田甫相關
  '田':['田'],'由':['田'],'甲':['田'],'申':['田','申'],'男':['田'],'界':['田'],'畫':['田'],'當':['田'],'疆':['田'],'留':['田'],'略':['田'],'畢':['田'],
  // 心忄月肉相關
  '心':['心'],'必':['心'],'志':['心','志'],'忠':['心'],'忻':['心'],'念':['心'],'思':['心'],'恩':['心'],'恭':['心'],'悅':['心'],'慈':['心'],'慧':['心'],'慶':['心'],'憲':['心'],'懷':['心'],'戀':['心'],'愛':['心'],'意':['心'],'感':['心'],'德':['心'],
  '忍':['心','刀'],'忙':['忄'],'快':['忄'],'怡':['忄'],'性':['忄'],'恆':['忄'],'悟':['忄'],'惠':['忄'],'情':['忄'],'惟':['忄'],'慎':['忄'],'憶':['忄'],
  // 肉（月旁在左為肉）
  '肯':['月','肉'],'胡':['月','肉'],'能':['月','肉'],'腰':['月','肉'],'臉':['月','肉'],
  // 地支相關字
  '子':['子'],'丑':['丑'],'寅':['寅'],'卯':['卯'],'辰':['辰'],'巳':['巳'],'午':['午'],'未':['未'],'酉':['酉'],'戌':['戌'],'亥':['亥'],
  // 其他常用字
  '文':['文'],'武':['武'],'成':['成'],'國':['口','王'],'民':['民'],'正':['正'],'平':['平'],
  '東':['木','東'],'西':['西'],'南':['南'],'北':['匕','北'],
  '中':['口','中'],'上':['上'],'下':['下'],
  '人':['人'],'入':['入'],'土':['土'],'士':['士'],'夕':['夕'],'夜':['夕','夜'],
  '龍':['龍'],'鳳':['鳥'],'馬':['馬'],'虎':['虎'],'犬':['犬'],'猴':['猴'],'雞':['雞','鳥'],'蛇':['蛇','巳'],'鼠':['鼠'],'兔':['兔'],'羊':['羊'],'豬':['豬','豕'],
  '穴':['穴'],'空':['穴'],'窗':['穴'],'窮':['穴'],'究':['穴'],
  '采':['采'],'釆':['采'],'番':['采'],
  '豕':['豕'],'象':['豕'],'豪':['豕'],
  '廣':['廣'],'庭':['廣'],'廉':['廣'],'應':['廣'],
  // 十二生肖直接字
  '鼠':['鼠','子'],'牛':['牛','丑'],'虎':['虎','寅'],'兔':['兔','卯'],
  '龍':['龍','辰'],'蛇':['蛇','巳'],'馬':['馬','午'],'羊':['羊','未'],
  '猴':['猴','申'],'雞':['雞','酉'],'狗':['狗','犬','戌'],'豬':['豬','豕','亥'],
  // ═══ 擴充：常用名字用字（500+） ═══
  // 含「羽」的字（羽=鳥/雞相關）
  '羽':['羽'],'翔':['羽'],'翊':['羽'],'翎':['羽'],'翠':['羽'],'翰':['羽'],'翼':['羽'],'翹':['羽'],'羿':['羽'],
  '飛':['飛'],
  // 含「函」「凡」「凌」等（冫/冖/凵）
  '函':['水','氵'],'凡':['几'],'凌':['冫','氵'],'冰':['冫','氵'],'冷':['冫','氵'],'凜':['冫','氵'],'凝':['冫','氵'],'准':['冫','氵'],'凍':['冫','氵'],'涼':['氵'],'淩':['氵'],
  // 含「宸」「辰」等
  '宸':['宀','辰'],'辰':['辰'],'晨':['日','辰'],'振':['辰'],
  // 含「彥」「顏」等
  '彥':['彡','文'],'顏':['彡','頁'],
  // 含「瑋」「瑄」等（王旁）
  '瑋':['王'],'瑄':['王'],'瑾':['王'],'璽':['王'],'琬':['王'],'琇':['王'],'琪':['王'],'琳':['王'],'瑩':['王'],'瑞':['王'],'瑜':['王'],'瑤':['王'],'珩':['王'],'珮':['王'],'琰':['王'],'瑗':['王'],'璟':['王'],'璇':['王'],'璿':['王'],'瓏':['王'],'玥':['王'],'珺':['王'],'瑆':['王'],'璐':['王'],'瑢':['王'],'琍':['王'],'璦':['王'],'琅':['王'],'珂':['王'],'琮':['王'],'璘':['王'],'瑒':['王'],'珈':['王'],'珧':['王'],'珣':['王'],'琯':['王'],'琸':['王'],'琤':['王'],'瑁':['王'],'瑀':['王'],'瑂':['王'],'瑝':['王'],
  // 含「恩」「惠」「慈」等（心/忄）
  '恩':['心'],'惠':['心'],'慈':['心'],'悅':['忄'],'愷':['心'],'憲':['心'],'懿':['心'],'怡':['忄'],'恬':['忄'],'恆':['忄'],'惟':['忄'],'愉':['忄'],'慎':['忄'],'憶':['忄'],'懷':['心'],'恕':['心'],'悠':['心'],'惇':['忄'],'慧':['心'],'懋':['心'],'愫':['心'],'懿':['心'],
  // 含「祐」「祥」等（示/礻）
  '祐':['礻'],'祥':['礻'],'祺':['礻'],'禎':['礻'],'禧':['礻'],'福':['礻'],'祿':['礻'],'神':['礻'],'祈':['礻'],'祝':['礻'],'祖':['礻'],'禪':['礻'],'禮':['礻'],
  // 含「軒」「輝」等（車）
  '軒':['車'],'輝':['車','光'],'輔':['車'],'轉':['車'],'軾':['車'],
  // 含「鈞」「銘」等（金/钅）
  '鈞':['金'],'銘':['金'],'鋒':['金'],'鑫':['金'],'鐘':['金'],'錦':['金'],'鍾':['金'],'鑰':['金'],'銓':['金'],'鎧':['金'],'鑠':['金'],'釗':['金'],'鈺':['金'],'鈿':['金'],'鉉':['金'],
  // 含「睿」「睦」等（目）
  '睿':['目'],'睦':['目'],'睛':['目'],'瞳':['目'],'瞻':['目'],'矚':['目'],'盼':['目'],'眉':['目'],'眸':['目'],'瞬':['目'],
  // 含「皓」「皎」等（白）
  '皓':['白','日'],'皎':['白'],'皙':['白'],
  // 含「語」「詩」等（言）
  '語':['言'],'詩':['言'],'諾':['言'],'誠':['言'],'謙':['言'],'詠':['言'],'諭':['言'],'詮':['言'],'誼':['言'],'諦':['言'],'謝':['言'],'論':['言'],'詹':['言'],'諳':['言'],'讓':['言'],
  // 含「豪」「家」等
  '豪':['豕'],'家':['宀','豕'],
  // 含「霖」「霈」「霓」等（雨）
  '霖':['雨','林','木'],'霈':['雨'],'霓':['雨'],'靖':['立'],'霏':['雨'],'霆':['雨'],'靈':['雨'],'霞':['雨'],'霜':['雨'],'露':['雨'],
  // 含「逸」「遙」等（辶）
  '逸':['辶','兔'],'遙':['辶'],'逍':['辶'],'遠':['辶'],'邁':['辶'],
  // 含「陽」「隆」等（阜/阝）
  '陽':['阝','日'],'隆':['阝'],'陵':['阝'],'陸':['阝'],'院':['阝'],'隱':['阝'],'階':['阝'],'陳':['阝'],
  // 含「雅」「雄」等（隹）
  '雅':['隹'],'雄':['隹'],'雋':['隹'],'集':['隹','木'],'雍':['隹'],'雯':['雨','文'],'雲':['雨'],
  // 含「韻」「音」等
  '韻':['音'],'韋':['韋'],'音':['音'],
  // 含「駿」「驊」等（馬）
  '駿':['馬'],'驊':['馬'],'騏':['馬'],'驍':['馬'],'驥':['馬'],'騰':['馬'],
  // 含「嘉」「喬」「善」等（口/吉）
  '嘉':['口'],'喬':['口'],'善':['口','羊'],'喜':['口'],'嘯':['口'],'嗣':['口'],
  // 含「鵬」「鴻」等（鳥）
  '鵬':['鳥'],'鴻':['鳥','氵'],'鳳':['鳥'],'鶴':['鳥'],'鷹':['鳥'],'鸞':['鳥'],
  // 含「哲」「啟」等
  '哲':['口'],'啟':['口'],'呈':['口'],'君':['口'],'吟':['口'],'周':['口'],
  // 含「俞」「愈」等
  '俞':['亻','月'],'愈':['心','月'],'瑜':['王','月'],
  // 含「亭」「亮」「京」（高/亠）
  '亭':['亠','口'],'亮':['亠','口'],'京':['亠','口'],'亦':['亠'],
  // 含「冠」（冖）
  '冠':['冖'],'軍':['冖','車'],
  // 含「仲」「俊」「傑」等（亻）
  '仲':['亻'],'俊':['亻'],'傑':['亻'],'偉':['亻'],'倫':['亻'],'儀':['亻'],'佩':['亻'],'佑':['亻'],'伶':['亻'],'侑':['亻'],'佰':['亻'],'佐':['亻'],'修':['亻'],'信':['亻'],'儒':['亻'],'優':['亻'],'億':['亻'],
  // 含「銀」「鑫」等已在金
  // 含「竹」「筠」等
  '竹':['竹'],'筠':['竹'],'笙':['竹'],'箏':['竹'],'簫':['竹'],'策':['竹'],'筱':['竹'],'篤':['竹'],
  // 含「虹」「蝶」等（虫）
  '虹':['虫'],'蝶':['虫'],'蜻':['虫'],'螢':['虫'],'蟬':['虫'],
  // 含「豐」「豔」等
  '豐':['豆','豐'],'豔':['豆'],
  // 含「堅」「城」「培」等（土）
  '堅':['土'],'城':['土'],'培':['土'],'基':['土'],'塘':['土'],'境':['土'],'墨':['土'],'壁':['土'],'壇':['土'],'坤':['土'],'堃':['土'],'堯':['土'],'垣':['土'],'均':['土'],'坊':['土'],'圻':['土'],'埸':['土'],'域':['土'],
  // 含「柏」「楷」等（已在木）
  // 含「尚」
  '尚':['口'],'堂':['土','口'],'當':['田','口'],
  // 含「頤」「碩」等
  '頤':['頁'],'碩':['石','頁'],'頌':['頁'],
  // 含「貝」
  '貞':['貝'],'財':['貝'],'賢':['貝'],'貴':['貝'],'賓':['貝'],'賜':['貝'],'資':['貝'],
  // 含「辛」
  '辛':['辛'],'辜':['辛'],'辟':['辛'],
  // 含「石」
  '石':['石'],'岩':['山','石'],'碧':['石','王'],'磊':['石'],'研':['石'],'確':['石'],
  // 含「立」
  '立':['立'],'端':['立'],'竣':['立'],'站':['立'],'章':['立'],'童':['立'],
  // 含「厂」「广」
  '廣':['广'],'庭':['广'],'廉':['广'],'廷':['廴'],'康':['广'],'庸':['广'],'庫':['广'],'序':['广'],'廈':['广'],'度':['广'],
  // 數字常用
  '一':['一'],'二':['二'],'三':['三'],'四':['口'],'五':['五'],'六':['六'],'七':['七'],'八':['八'],'九':['九'],'十':['十'],'百':['白'],'千':['千'],'萬':['艹'],
  // 顏色常用
  '白':['白'],'黑':['黑'],'赤':['赤'],'青':['青'],'黃':['黃','田'],'紅':['糸'],
  // 含「長」「永」「恆」
  '長':['長'],'永':['水'],'恆':['忄'],'恒':['忄'],
  // 含「少」「小」
  '少':['小'],'小':['小'],'尖':['小','大'],
  // 含「妍」「娟」「婷」等（女）
  '妍':['女'],'娟':['女'],'婷':['女'],'婉':['女'],'姍':['女'],'妮':['女'],'姿':['女'],'媛':['女'],'嫻':['女'],'妤':['女'],'姝':['女'],'娜':['女'],'婕':['女'],'媚':['女'],'嫣':['女'],'嬌':['女'],'姞':['女'],'姵':['女'],'婧':['女'],'嫦':['女'],'娉':['女'],'婓':['女'],'姮':['女'],
  // 含「豕」相關
  '豕':['豕'],'象':['豕'],'豪':['豕'],'豫':['豕'],'豹':['豕'],
  // 含「穴」相關
  '穴':['穴'],'空':['穴'],'窗':['穴'],'窮':['穴'],'究':['穴'],'穎':['禾','穴'],
  // 含「采」
  '采':['采'],'釆':['采'],'番':['采','田'],'彩':['彡','采'],'釋':['采'],

  // ═══ 補充：常見名字用字字根（高頻缺漏修補）═══
  // 攵/攴部
  '政':['正','攵'],'敏':['每','攵'],'敬':['苟','攵'],'教':['孝','攵'],'敦':['享','攵'],
  '效':['交','攵'],'敘':['余','攵'],'數':['米','攵'],'敵':['啇','攵'],'整':['正','攵','束'],
  '散':['月','攵'],'啟':['戶','口','攵'],'救':['求','攵'],'故':['古','攵'],
  // 文部
  '斌':['文','武'],'斐':['非','文'],'斑':['文','王'],
  // 方部
  '放':['方'],'旁':['方'],'旋':['方'],'族':['方','矢'],'旗':['方','其'],
  // 欠部
  '欣':['斤','欠'],'歡':['雚','欠'],'欽':['金','欠'],'款':['士','欠'],'歌':['哥','欠'],
  // 止部
  '正':['正','一','止'],'步':['止'],'歲':['止','戈'],'歷':['厂','止'],'此':['止'],
  '武':['止','戈'],
  // 戈部
  '戎':['戈'],'成':['戈'],'或':['口','戈'],'戰':['單','戈'],'我':['戈'],
  '威':['女','戈'],'戴':['異','戈'],'截':['隹','戈'],
  // 力部
  '功':['工','力'],'加':['口','力'],'助':['且','力'],'努':['女','又','力'],
  '勁':['巠','力'],'勇':['甬','力'],'動':['重','力'],'勤':['堇','力'],
  '勝':['月','力'],'勵':['厲','力'],'勢':['埶','力'],
  // 又/寸部
  '友':['又'],'及':['又'],'叔':['又'],'取':['耳','又'],'受':['又','爪'],
  '反':['又'],'發':['弓','又'],'對':['寸'],'封':['圭','寸'],'射':['身','寸'],
  '尊':['酋','寸'],'將':['爿','寸'],'導':['道','寸'],'尋':['寸'],
  // 宀/冖部（補充）
  '宇':['宀'],'宋':['宀','木'],'宗':['宀','示'],'宜':['宀'],'客':['宀','各'],
  '宣':['宀'],'宮':['宀'],'容':['宀','谷'],'家':['宀','豕'],'富':['宀','口','田'],
  '實':['宀'],'寧':['宀','心'],'寶':['宀','玉','貝'],'寬':['宀'],
  '密':['宀'],'察':['宀'],'寒':['宀'],'審':['宀'],'寫':['宀'],
  // 心/忄部（補充）
  '心':['心'],'必':['心'],'志':['心','士'],'忍':['心','刃'],'忠':['心','中'],
  '念':['心','今'],'怒':['心','女','又'],'思':['心','田'],'急':['心'],
  '恩':['心','大','口','因'],'悲':['心','非'],'惜':['心','昔'],'惟':['心','隹'],
  '愛':['心','爪','冖'],'慶':['心','广'],'憲':['心','目','宀'],
  // 口部（補充）
  '台':['口'],'史':['口'],'召':['口','刀'],'吉':['口','士'],'呈':['口','王'],
  '品':['口'],'哲':['口','折'],'員':['口','貝'],'商':['口'],
  '嘉':['口','加','豆'],'嘯':['口'],'器':['口','犬'],
  // 日部（補充）  
  '旭':['日','九'],'昇':['日','升'],'昌':['日'],'昕':['日','斤'],
  '昊':['日','天'],'昱':['日','立'],'晉':['日'],'晨':['日','辰'],
  '景':['日','京'],'暉':['日','軍'],'曜':['日','翟'],
  // 月部（補充）
  '朋':['月'],'朗':['月','良'],'望':['月','王','亡'],'朝':['月','十','日'],
  '期':['月','其'],
  // 木部（補充）
  '本':['木'],'朱':['木'],'杰':['木'],'松':['木','公'],'柏':['木','白'],
  '梓':['木','辛'],'棟':['木','東'],'楓':['木','風'],'樂':['木','白','幺'],
  '機':['木','幾'],'權':['木','雚'],
  // 水/氵部（補充）
  '永':['水'],'泉':['水','白'],'洋':['水','羊'],'津':['水','聿'],
  '浩':['水','告'],'涵':['水','函'],'淳':['水','享'],'清':['水','青'],
  '湘':['水','相'],'源':['水','原'],'溪':['水','奚'],'澤':['水','睪'],
  // 火/灬部（補充）
  '炎':['火'],'烈':['火','列'],'焜':['火','昆'],'煜':['火','昱'],
  '照':['火','日','刀'],'熙':['火','巳'],'燕':['火','口','北','廿'],
  // 土部（補充）
  '坤':['土','申'],'城':['土','成'],'培':['土','咅'],'堅':['土','臣'],
  '堯':['土','堯'],'基':['土','其'],'堂':['土','尚'],'塔':['土','荅'],
  '境':['土','竟'],'墨':['土','黑'],'壁':['土','辟'],
  // 金/釒部（補充）
  '鈺':['金'],'銘':['金','名'],'鋒':['金','丰'],'鑫':['金'],
  '鈞':['金','匀'],'鑠':['金'],
  // 糸/纟部（補充）
  '紘':['糸','厷'],'紫':['糸','此'],'絲':['糸'],'綺':['糸','奇'],
  '維':['糸','隹'],'緯':['糸','韋'],'緣':['糸','彖'],'縈':['糸','火'],
  // 車部
  '軒':['車','干'],'軍':['車','冖'],'輝':['車','光'],'輪':['車'],
  '轉':['車','專'],'載':['車','戈'],
  // 馬部
  '馳':['馬'],'駿':['馬','夋'],'騏':['馬','其'],'驊':['馬','華'],
  // 示/礻部（補充）
  '祖':['示'],'祐':['示','右'],'祥':['示','羊'],'福':['示','畐'],
  '禎':['示','貞'],'禮':['示','豊'],
  // 言/訁部（補充）
  '詩':['言','寺'],'語':['言','吾'],'諺':['言','彥'],'謙':['言','兼'],
  // 頁/首部
  '頤':['頁','臣'],'頂':['頁','丁'],'預':['頁','予'],'願':['頁','原'],
  // 其他常見
  '冠':['冖','寸','元'],'函':['冂','了','水'],'凱':['几','豈'],
  '克':['十','兄','克'],'兆':['儿'],'先':['儿'],'允':['儿','厶'],
  '其':['八','一','甘'],'典':['八','曲'],'冊':['冂'],'再':['一','冂'],
  '辰':['辰'],'辛':['辛','立','十']
};

// Unicode 部首推斷（fallback）
// ═══ 康熙 214 部首 → 生肖字根映射 ═══
// ═══ 偏旁→字 完整映射表（4300+ 常用字，71 部首組） ═══
const RADICAL_DB=[{c:"仁仃仇仍仕他付代令以仙仗仞仟仡仫份仰仲件任仿伉伊伍伎伏伐休伙伯估伴伶伸伺似佃但位低住佐佑何佗佚佛作佞佩佬佯佰佳併來侃侈例侍供依侖侗侘侚侮侯侵便俁係促俄俊俎俐俑俗俚俞俟信修俯俱俳俸俺俾倆倉個倌倍倏們倒倔倖倘候倚倜借倡倦倫倭假偃偉偏偕偶偷偵偽傀傅傍傑傘備催傭傲傳傷傻傾僅僑僕僖僚價僧僭僮僵儀億儂儉儐儒儘儲儷儸儺",r:['人','亻']},{c:"汁汀汃汋汍汎汏汐汕汗汙汛汝汞江池汨汪汰汲汴決沁沂沃沅沈沉沌沐沒沓沖沙沛沫沮沱河沸油沺治沼沾況泄泅泉泊泌泓法泗泛泡波泣泥注泫泮泯泰泱洄洋洌洎洗洛洞津洧洩洪洮洲洵洶活洽派流浙浚浣浤浦浩浪浮浴海浸涉涊涎涓涔涕涮涯液涵涸涼淇淋淌淏淑淒淕淘淙淚淝淞淡淥淦淨淩淪淫淬淮深淳淵混淹添淼清渙渝渟渠渡渣渤渥溈温渲渴游湃湊湍湖湘湛湜湞湟湧湮湯源準溝溟溢溥溧溪溫溯溶溺滂滄滅滇滋滌滑滓滔滕滘滙滬滯滲滴滷滸滾滿漁漂漆漏漓漠漢漣漩漪漫漬漯漲漳漸漾潁潑潔潘潛潞潤潭潮澄澈澎澤澧澱激濃濕濘濛濟濤濫濬濮濱濺濾瀅瀉瀋瀑瀕瀘瀚瀛瀝瀟瀦瀧灌灑灘灝灣",r:['水','氵']},{c:"口古句另叨叩只叫召叭叮可台史右叶號司叻吁吃各吆合吉吊同名后吏吐向吒君吟吠否吧吩含吭吮吳吵吶吸吹吻吾呀呂呃呆呈告呎呢呤周咀呱呵呻呼命咖咦咧咨咩咪咫咬咯品咳咸哀哄哆哇哈哉員哥哦哨哩哭哮哲哺唁唄唇唉唐唑唧唬售唯唱唸商啃啄啊問啓啜啞啡啣啤啥啦啪啬啵喂善喃喇喉喊喋喘喚喜喝喧嗅嗆嗎嗑嗔嗚嗜嗡嗣嗤嗦嗨嗬嗯嗲嘀嘆嘈嘉嘍嘎嘔嘗嘛嘩嘮嘯嘲嘴嘶噁噎噓噗噙噠噢噤器噩噪噬噱噴噶噸嚀嚇嚎嚐嚕嚙嚨嚮嚴嚷嚼囂囉囊囑囔",r:['口']},{c:"宀它宅宇守安宋完宏宓宕宗官宙定宛宜客宣室宥宦宧宮宰宴家宸容宿寂寄寅密寇富寐寒寓寔察寡寢寤實寧審寫寬寮寰寱寶",r:['宀']},{c:"心必忌忍忖志忘忙忡快忱忻念忽忿怎怒怔怕怖思怡急性怨怪恃恆恍恐恕恙恢恣恤恥恨恩恪恫恬恭息恰悄悉悔悖悚悟悠患悲悶悸悻悼情惆惇惋惑惕惘惚惜惟惠惡惦惰惱惲惶惹愁愆愈愉愍愎意愕愚愛感愧愴愷慄慈態慌慎慕慘慚慟慣慧慨慫慮慰慳慵慶慷慾憂憊憋憎憐憑憔憚憤憧憨憩憫憬憲憶憾懂懇懈應懊懋懌懍懦懲懵懶懷懸懺懼懾戀",r:['心','忄']},{c:"木未末本札朮朱朵杆杉李杏材村杓杖杜杞束杯杰東杲杳杵杷松板枉析枋枕林枚果枝枯架枷柄柏某柑柒染柔柘柚柜柝柞柢查柩柬柮柯柱柳柴柵柿栓栖栗校栩株核根格栽桀桂桃桅桉案桌桎桐桑桓桔桕桶梁梅梆梏梓梗梢梧梨梭梯械梱梳梵梶棄棉棋棍棒棕棗棘棚棟棠棣棧森棲棵棻椅椎植椒椿楊楓楔楗楚楞楠楣楫業楷楹榆榔榕榛榜榨榭榮榱榴槁構槍槐槓槤槳樁樂樊樑標樓樞模樣樵樸樹樺橄橋橘機橡橫檀檄檎檐檔檜檢檬檳櫃櫓櫚櫛櫥櫸櫻權欄",r:['木']},{c:"水永氾汁汀江汝汗汙汛池汪沁沃沈沉沐沒沖沙沛河油治沼泉泊泌法泡波泣泥注泰洋洗洛洞津洪浙浩浪浮浴海涉涵淇淑淚清淵減渡港湖源準溪溫滅滑滿漁漂演漫潔潛潮澤濃瀑灌灣",r:['水','氵']},{c:"日旦旨早旬旭旱昂昃昆昇昉昊昌明昏昕星映春昧昨昭昱昶昻是時晃晉晏晒晗晚晝晞晟晤晦晨晰晳晴晶智暄暇暈暉暌暐暑暖暗暘暝暢暨暫暮暱暴曄曆曉曖曙曚曛曜曝曦曩曬曰曳曷書曹曼曾會朋朔朗朝期朦朧",r:['日']},{c:"月有朋服朔朗望朝期朦朧肉肋肌肖肘肚肛肝股肢肥肩肪肯育肴胃背胎胖胚胡胤胥胸能脂脅脈脊脖脣脩脫脯脹腆腈腋腎腐腔腕腥腦腫腰腳腸腹腺腿膀膂膈膊膏膚膛膜膝膠膨膩膳膺膽膾臀臂臆臉臍臟臠",r:['月','肉']},{c:"艾芊芋芍芎芙芝芡芥芬芭芮芯花芳芸芹芻芽苑苒苓苔苗苛苜苞苟苡苣苦苧苫英苳苹茁茂范茄茅茉茗茜茨茫茭茯茱茲茴茵茶茹荀荃荊荏草荒荔荖荷荸荻莊莉莎莒莓莖莘莛莞莠莢莧莩莪莫莽菁菅菇菊菌菏菓菜菠菡菩菪菱菲菴菸菽萃萄萊萌萍萎萬萱萸萼落葉葑著葛葡葦葩葫葬葭葳葵葷蒂蒐蒔蒙蒜蒞蒟蒡蒨蒲蒸蒺蒼蒿蓀蓁蓄蓉蓋蓑蓓蓬蓮蔑蔓蔔蔗蔚蔡蔣蔥蔬蔭蕃蕈蕉蕊蕙蕨蕩蕪蕭蕾薄薇薈薊薏薑薔薛薦薩薪薫薰藉藍藏藐藝藤藥藩藻蘆蘇蘊蘋蘑蘚蘭蘿董華虎",r:['艹']},{c:"女奴奶她好妁妃妄妊妍妒妓妖妙妝妞妣妤妥妨妮妯妲妳妹妻妾姆姊始姐姑姒姓委姚姜姝姞姣姥姦姨姪姬姮姵姶姻姿威娃娉娑娘娛娜娟娠娣娥娩娶婁婆婉婊婕婚婦婧婪婷婺媒媚媛媧媲媳媽嫁嫂嫉嫌嫖嫘嫚嫡嫣嫦嫩嫻嬈嬉嬌嬋嬖嬛嬤嬪嬰嬴嬸嬿孀孃",r:['女']},{c:"王玉玎玓玖玗玘玟玠玡玢玥玦玧玩玫玬環玲玳玷玹玻珀珂珅珈珉珊珍珏珒珖珙珞珠珣珥珧珩班珮珺珽琄琇琉琊琍琎琛琝琢琤琥琦琨琪琮琯琲琳琴琵琶琺琿瑁瑂瑄瑆瑋瑕瑗瑙瑚瑛瑜瑝瑞瑟瑠瑢瑤瑧瑩瑪瑭瑮瑯瑰瑱瑳瑶瑾璀璁璃璇璈璉璋璐璘璜璞璟璠璣璥璦璧璨璩璪璫璬璮璲璵璸璹璽璿瓊瓏瓔瓘瓚瓛理現",r:['王','玉']},{c:"系紀紂約紅紆紉紊紋納紐紓純紗紘紙級紛紜素紡索紫紮累細紳紹紺終組絃結絕給絡絢統絲絨經綁綏綑綜綠綢綣綬維綱網綴綸綺綻綽綾緊緋緒緘線緜緝緞締緣編緩緬緯練緻縈縊縛縝縞縣縫縮縱總績繁繃繆繇繋織繕繖繚繞繡繩繪繫繭繰繳繹繼繽纂纈纏纓纖纜",r:['糸']},{c:"言訂訃計訊訌討訐訓訕託記訛訝訟訣訥訪設許訴訶診註詆詈詉詐詒詔評詘詛詞詠詡詢詣試詩詫詬詭詮詰話該詳詹詼誅誇誌認誓誕誘語誠誡誣誤誥誦誨說誰課誹誼調諄談請諍諏諒論諗諜諞諠諡諢諧諫諭諮諱諳諶諷諸諺諻諼諾謀謁謂謄謇謊謎謐謔謗謙謚講謝謠謡謨謫謬謳謹謾譁證譊譎譏譖識譙譚譜譫譬譯議譴護譽讀讒讓讖讚讜",r:['言']},{c:"金釗釘針釣釦釧釩釵鈀鈉鈍鈎鈐鈔鈕鈞鈣鈦鈪鈴鈺鈿鉀鉅鉉鉋鉍鉑鉚鉛鉤鉦鉸銀銃銅銑銓銖銘銜銠銦銨銩銬銭銮銳銷鋁鋅鋇鋌鋏鋒鋤鋪鋰鋸鋼錄錐錘錚錛錠錢錦錨錫錮錯錳錶鍊鍋鍍鍔鍛鍥鍬鍰鍵鍺鍾鎂鎊鎔鎖鎗鎚鎛鎢鎧鎬鎮鎳鏃鏈鏊鏐鏑鏗鏘鏜鏝鏞鏡鏢鏤鏨鐃鐓鐔鐘鐙鐡鐫鐬鐮鐲鐳鐵鐶鐸鐺鐿鑄鑊鑌鑑鑒鑠鑣鑫鑰鑲鑷鑼鑽鑾鑿",r:['金']},{c:"辶迂迄迅迎近返迢迤迥迦迪迫迭述迴迷迸追退送逃逅逆逋逍透逐逑途逕逖逗這通逛逝速造逢連逮週進逵逶逸逹逼遂遇遊運遍過遏遐遑遒道達違遘遙遜遞遠遣遨適遭遮遵遷選遺遼避邀邁還邇邈邊邏",r:['辶']},{c:"田由甲申男甸町畋界畏畔留畜略畝番畢畦畫當畸畹畿疆疇",r:['田']},{c:"山屹岌岐岑岔岡岢岣岩岫岬岱岳岷峇峋峒峙峨峪峭峯峰峴峻崁崆崇崎崑崔崖崗崙崛崢崤崧崩嵇嵌嵐嵩嵬嵯嶄嶇嶋嶒嶔嶙嶝嶠嶢嶧嶮嶰嶴嶺嶼巍巒巔",r:['山']},{c:"火灰灸灼災炅炆炊炎炒炕炙炤炫炬炭炮炯炰炱炳炷炸烈烊烋烏烘烙烜烝烤烯烴烹烽焉焊焙焚焜焠焦焯焰焱然煉煊煌煎煒煕煖煗煙煜煞煤煥照煩煮煲煸熄熊熏熔熙熛熟熠熨熬熱熹熾燁燃燈燉燊燎營燒燔燕燙燜燠燥燦燧燬燭燮燴燹燻燼燿爆爍爐爛爨爪爬爭爯爲爵爸爹爺爻爽爿",r:['火','灬']},{c:"禾禿秀私秉秋科秒秕秘租秣秤秦秧秩移稀稅程稍稔稗稚稜稞稟稠種稱稻稼稽稿穀穂穆穌積穎穗穡穢穩穫穰穴",r:['禾']},{c:"米籽粉粒粕粗粘粟粢粥粧粱粲粳粵粹粽精粿糊糕糖糗糙糜糞糟糠糢糧糨糯糰糲糸",r:['米']},{c:"竹竺竿笄笆笈笊笏笑笙笛笞笠笥符笨笩第笭笮笱笳笵笸筅筆筇筊筋筌等筍筏筐筑筒答策筠筥筧筬筮筱筲筵筷箄箇箋箍箏箒箔箕算箝管箬箭箱箴箸節篁範篆篇篋篌篙篝篠篤篩篪篲篳篷篾簀簇簍簑簒簙簞簡簣簧簪簫簷簸簽簾簿籃籌籍籐籙籟籠籤籥籩籬籮籲",r:['竹']},{c:"衣表衫衩衰衲衷衹衽衾袁袂袈袋袍袒袖袗袞袤袪被袱裁裂裊裎裏裔裕裘裙補裝裟裡裨裳裴裸裹裼製褂複褊褐褒褓褔褚褟褥褪褫褰褲褶褸褻襁襄襌襖襝襟襠襤襦襪襬襯襲襴襾",r:['衣']},{c:"刀刁刃分切刈刊刎刑列初判別利刪到制刷刺刻剃則削前剋剌剎剔剖剛剝剩剪副割創剷剽剿劃劈劉劊劍劑劚力功加劣助努劫劬勁勃勇勉勐勒動勘務勛勝勞勢勤勦勰勳勵勸勻勾匀勿包匆匈匍匏匐匕化北匙匝匠匡匣匪匯匱匹匾",r:['刀','刂']},{c:"巾市布帆帋帑帔帕帖帗帘帙帚帛帝帟帢帥師席帳帶帷常帽幃幄幅幌幔幕幗幘幛幟幡幢幣幫幬幭干平年幷幸幹幻幼幽幾庁",r:['巾']},{c:"彡形彣彤彥彧彩彪彫彬彭彰影彲彳彷役彼往征待徇很徉徊律後徐徑徒得徘徙從御徧復循微徵德徹徽",r:['彡']},{c:"弓弔引弗弘弛弟弢弦弧弩弭弱張強弼彀彈彊彎",r:['弓']},{c:"門閂閃閉開閎閏閑閒間閔閘閡閣閤閥閨閩閫閬閭閱閲閹閻閼閽闆闇闈闊闋闌闍闐闑闓闔闕闖關闘闚闛闞闡闢",r:['門']},{c:"隹隻隼雀雁雄雅集雇雉雋雌雍雎雒雕雖雙雛雜雞離難",r:['隹']},{c:"雨雩雪雫雯雱雲零雷雹電需霄霆震霈霉霍霎霏霑霓霖霜霞霧霪霰露霸霹靂靄靈靖靚靛靜",r:['雨']},{c:"羽羿翁翅翊翌翎翏習翔翕翛翟翠翡翦翩翫翮翰翱翳翹翻翼耀",r:['羽']},{c:"豕豚象豢豨豪豬豫豸豹豺貂貉貊貌貍貓貔",r:['豕']},{c:"犬犯狀狂狄狎狐狒狗狙狠狡狩狸狹狻狼猙猛猜猝猥猩猴猶猷猾獄獅獎獗獠獨獰獲獵獷獸獺獻",r:['犬','犭']},{c:"馬馭馮馱馳馴馹駁駃駈駐駑駒駔駕駘駙駛駝駟駢駭駰駱駿騁騂騅騎騏騖騙騤騫騭騮騰騶騷騸驀驁驂驃驄驅驊驌驍驎驏驕驗驘驚驛驟驢驤驥驦驪驫",r:['馬']},{c:"鳥鳩鳳鳴鳶鴉鴕鴛鴝鴞鴟鴣鴦鴨鴻鴿鵑鵓鵜鵝鵠鵡鵪鵬鵯鵲鵺鶇鶉鶊鶖鶘鶚鶡鶩鶯鶴鶹鶺鶻鷂鷄鷓鷗鷙鷚鷥鷦鷯鷲鷸鷹鷺鸚鸛鸞鸝",r:['鳥']},{c:"龍龎龐龔龕龜",r:['龍']},{c:"虎虐虔處虛虜號虞虧虩虫虯虱虹虺蛀蛄蛆蛇蛉蛋蛎蛐蛑蛙蛛蛞蛟蛤蛭蛯蛹蛻蜀蜂蜃蜆蜈蜊蜍蜒蜓蜘蜚蜜蜞蜡蜢蜥蜩蜮蜱蜴蜷蜻蜾蝌蝎蝓蝕蝗蝙蝟蝠蝦蝨蝮蝰蝴蝶蝸蝻螂螃螄螈螉螋融螐螗螘螞螟螢螣螨螫螭螯螳螵螺螻蟀蟄蟆蟈蟋蟎蟑蟒蟜蟠蟬蟯蟲蟳蟹蟻蟾蠅蠍蠔蠕蠖蠛蠟蠡蠢蠣蠱蠶蠹蠻",r:['虎']},{c:"貝貞負財貢貧貨販貪貫責貯貰貲貳貴貶買貸費貼貽貿賀賁賂賃賄賅資賈賊賑賒賓賕賚賜賞賠賡賢賣賤賦質賫賬賭賰賴賵賺賻購賽贄贅贈贊贋贍贏贓贖贗贛",r:['貝']},{c:"石砂砌砍砒研砝砟砢砥砦砧砩砭砰砲砷砸砼硃硅硎硏硒硝硤硨硫硬硯硼碇碉碌碎碑碗碘碚碞碟碣碧碩碰碳碴碼碾磁磅磊磋磐磚磨磬磯磲磷磺礁礅礎礙礦礪礫礬礱",r:['石']},{c:"穴究空穹穿突窄窈窒窕窖窗窘窟窠窣窩窪窮窯窰窳窺窿竄竅竇竊竈",r:['穴']},{c:"邑邢那邦邪邯邱邲邳邵邸邽邾郁郅郇郊郎郗郛部郝郡郢郤郭都鄂鄉鄒鄔鄗鄘鄙鄞鄢鄧鄭鄰鄱鄴鄺阡阮阪阬阱防阻阿陀附陂陋陌降限陔陘陛陜陝陞陟院陣除陪陬陰陲陳陵陶陷陸隄隅隆隈隊隋隍階隔隕際障隧隨險隱隴隸隹",r:['阝']},{c:"目盯盲直盼盾相眇眈眉眊看眙眛眞真眠眥眦眨眩眭眯眴眶眷眸眺眼着睛睜睞睡睢督睥睦睨睪睫睬睹睽睾睿瞄瞅瞇瞋瞌瞎瞑瞞瞟瞠瞥瞧瞪瞬瞭瞰瞳瞻瞼瞿矇矍矓矗",r:['目']},{c:"酉酊酋酌配酎酐酒酗酡酢酣酥酩酪酬酮酯酲酳酴酵酷酸醃醇醉醋醍醐醒醜醞醢醣醪醫醬醮醯醱醴醵醺釀",r:['酉']},{c:"示社祀祁祂祇祈祉祊祋祐祓祕祖祗祚祛祜祝神祟祠祢祥票祧祭祺祼祿禁禂禄禊禍禎福禑禓禔禕禖禘禛禝禞禟禡禢禤禥禧禨禪禫禬禮禰禱禳禴禸禹禺禽禾",r:['礻']},{c:"白百皂的皆皇皈皋皎皓皖皙皚皛皜皝皞皮",r:['白']},{c:"立站竑竟章竣童竭端競竹",r:['立']},{c:"小少尖尚尞尢尤尨尪尬就尷尸尹尺尻尼尾局屁屆屈屉届屋屌屍屎屏屐屑展屠屢屣層履屬屯",r:['小','少']},{c:"大天太夫央失夷夸夾奄奇奈奉奎奏契奔奕奘套奚奠奢奧奪奮奰",r:['大']},{c:"子孑孔孕孖字存孛孜孝孟季孤孥孩孫孰孱孳孵學孺孻孼孽",r:['子']},{c:"牛牝牟牡牢牣牤牧物牲牴特牽犀犁犂犄犇犉犋犍犏犒犖犛犢犧犬",r:['牛']},{c:"食飢飯飲飴飼飽飾餃餅餉養餌餐餒餓餕餘餛餞餡館餮餵餾饅饈饉饊饋饌饑饒饕饗饞饢",r:['食']},{c:"魚魛魟魣魨魩魬魯魴魷魺鮀鮁鮃鮊鮋鮍鮎鮑鮒鮓鮗鮚鮜鮝鮞鮠鮡鮣鮦鮨鮪鮫鮭鮮鮰鮲鮳鯀鯁鯉鯊鯒鯔鯖鯗鯛鯝鯡鯤鯧鯨鯪鯰鯷鯽鰈鰉鰍鰓鰜鰟鰣鰥鰭鰱鰲鰳鰷鰹鰻鰼鰾鱅鱈鱉鱒鱔鱖鱗鱘鱚鱝鱟鱠鱣鱧鱨鱭鱮鱲鱷鱸鱺",r:['魚']},{c:"羊羌美羔羚羞羡羣群義羲羶羹羺羼羽",r:['羊']},{c:"豆豇豈豉豊豌豎豐豔豗",r:['豆']},{c:"采釉釋番悉",r:['采']},{c:"飛飜飝",r:['飛']},{c:"鼠鼡鼢鼩鼫鼬鼯鼱鼴鼷鼹鼻",r:['鼠']},{c:"麥麩麪麫麯麰麴麵麸",r:['麥']},{c:"黃黈黌黎黏",r:['黃','田']},{c:"冗冘冠冢冤冥冪冬冰冱冲冶冷冽凄凅准凇凈凊凋凌凍凜凝凞几凡凰凱凳凶凸凹",r:['冖']},{c:"廴廷建廻延廿",r:['廴']},{c:"广庁序庄底庇店庚府庠度座庫庭庵庶庸康庾廁廂廈廉廊廓廖廚廛廝廟廠廡廢廣廨廩廬廰廱廳",r:['广']},{c:"文斌斐斑斕斗料斛斜斝斞斟斡斤斥斧斫斬新斲斷斸",r:['文']},{c:"几凡凰凱凳凶凸凹",r:['几']},{c:"車軋軌軍軒軔軛軟軸軹軺軻軼軾較輅輈載輊輒輓輔輕輛輜輝輞輟輦輩輪輬輮輯輳輶輸輻輾輿轂轅轆轉轊轍轎轔轗轘轙轟轡轢轤",r:['車']},{c:"夕外多夜夢夥夠夤",r:['夕']},{c:"乙乞也乳乾亂事云互五井亙亞亟亡亢交亦亨享京亭亮亳亶亹",r:['乙']},{c:"匕化北匙匜匝匠匡匣匪匯匱匹匾",r:['匕']},{c:"力功加劣助努劫劬勁勃勇勉勐勒動勘務勛勝勞勢勤勦勰勳勵勸勻勾勿包匆匈匍匏匐",r:['力']},{c:"辰辱農辸辳",r:['辰']},{c:"斤斥斧斫斬斯新斲斷",r:['斤']}];

function guessRoots(ch){
  // 層 1: 精確預建表（最高優先）
  if(CHAR_ROOTS[ch]) return CHAR_ROOTS[ch];
  
  // 層 2: RADICAL_DB 完整偏旁映射（覆蓋 4300+ 常用字）
  for(let i=0; i<RADICAL_DB.length; i++){
    if(RADICAL_DB[i].c.includes(ch)) return RADICAL_DB[i].r;
  }
  
  // 層 3: 硬性結構拆解（絕不回傳空陣列）
  // 原則：拆解「陽邊（左/上）」與「陰邊（右/下）」
  // 使用 CJK Ideographic Description Sequences 或常見偏旁模式
  const roots = [];
  const code = ch.charCodeAt(0);
  
  // 常見偏旁 Unicode 範圍檢測（CJK Radicals Supplement + Kangxi Radicals）
  // 2F00-2FDF: 康熙部首, 2E80-2EFF: CJK部首補充
  
  // 嘗試用已知偏旁字形匹配
  const COMMON_LEFT = [
    {pattern:/[氵]/, roots:['氵','水']},
    {pattern:/[忄]/, roots:['忄','心']},
    {pattern:/[扌]/, roots:['扌','手']},
    {pattern:/[犭]/, roots:['犭','犬']},
    {pattern:/[礻]/, roots:['礻','示']},
    {pattern:/[衤]/, roots:['衤','衣']},
    {pattern:/[飠]/, roots:['飠','食']},
    {pattern:/[纟]/, roots:['纟','糸']},
    {pattern:/[钅]/, roots:['钅','金']},
  ];

  // 嘗試從字的視覺結構推測
  // 左右結構常見模式：取字的第一個筆畫區域
  const strCh = ch;
  
  // 策略A：檢查是否包含已知的子字形
  const SUB_CHARS = {
    '口':['口'],'日':['日'],'月':['月'],'木':['木'],'火':['火'],
    '水':['水'],'金':['金'],'土':['土'],'心':['心'],'田':['田'],
    '山':['山'],'石':['石'],'示':['示'],'禾':['禾'],'竹':['竹'],
    '米':['米'],'糸':['糸'],'言':['言'],'車':['車'],'馬':['馬'],
    '王':['王'],'玉':['玉'],'人':['人'],'大':['大'],'小':['小'],
    '女':['女'],'子':['子'],'手':['手'],'力':['力'],'刀':['刀'],
    '弓':['弓'],'戈':['戈'],'門':['門'],'宀':['宀'],'穴':['穴'],
    '艹':['艹'],'辶':['辶'],'阝':['阝'],'犬':['犬'],
  };
  
  // 策略B：用已知字的組合推測
  // 例：左右結構=左偏旁+右偏旁, 上下結構=上部+下部
  // 嘗試將字拆為兩部分
  const KNOWN_COMBOS = {
    // 左右結構
    '洋':['氵','羊'],'汪':['氵','王'],'池':['氵','也'],
    '怡':['忄','台'],'悟':['忄','吾'],'惟':['忄','隹'],
    '提':['扌','是'],'搏':['扌','尃'],'振':['扌','辰'],
    '琪':['王','其'],'瑤':['王','搖'],'珮':['王','佩'],
    '祈':['礻','斤'],'祺':['礻','其'],'福':['礻','畐'],
    // 上下結構
    '宇':['宀','于'],'安':['宀','女'],'室':['宀','至'],
    '芳':['艹','方'],'英':['艹','央'],'華':['艹','化'],
    '思':['田','心'],'意':['音','心'],'慧':['彗','心'],
    '景':['日','京'],'晨':['日','辰'],'暉':['日','軍'],
  };
  if(KNOWN_COMBOS[ch]) return KNOWN_COMBOS[ch];

  // 策略C：強制從 Unicode 碼位估算部首分類
  // CJK 統一漢字按部首排列，可粗略推測
  if(code >= 0x4E00 && code <= 0x9FFF){
    // 根據 Unicode 碼位分段推測部首（粗略但不留空白）
    const offset = code - 0x4E00;
    const totalRange = 0x9FFF - 0x4E00;
    // Unicode CJK 大致按部首筆畫排列
    // 前段偏向一~人~口~土等少畫部首
    // 後段偏向金~雨~風~馬~魚~鳥等多畫部首
    const ratio = offset / totalRange;
    if(ratio < 0.05) roots.push('一','丨');
    else if(ratio < 0.1) roots.push('人','亻');
    else if(ratio < 0.15) roots.push('刀','力');
    else if(ratio < 0.2) roots.push('口');
    else if(ratio < 0.25) roots.push('土');
    else if(ratio < 0.3) roots.push('大','女');
    else if(ratio < 0.35) roots.push('宀','小');
    else if(ratio < 0.4) roots.push('心','忄');
    else if(ratio < 0.45) roots.push('手','扌');
    else if(ratio < 0.5) roots.push('日','木');
    else if(ratio < 0.55) roots.push('水','氵');
    else if(ratio < 0.6) roots.push('火');
    else if(ratio < 0.65) roots.push('田','目');
    else if(ratio < 0.7) roots.push('禾','竹');
    else if(ratio < 0.75) roots.push('糸');
    else if(ratio < 0.8) roots.push('言');
    else if(ratio < 0.85) roots.push('車','金');
    else if(ratio < 0.9) roots.push('門','阝');
    else if(ratio < 0.95) roots.push('雨','馬');
    else roots.push('魚','鳥');
  }
  
  // 如果還是空的（非CJK字元），至少標記字本身
  if(roots.length === 0) roots.push(ch);
  
  return roots;
}

// ── 漢字結構拆解引擎（陽邊/陰邊）──
// 原則：嚴格拆解每個字的「陽邊（左/上）」與「陰邊（右/下）」
// 絕不回傳空結果，即使罕見字也必須硬性拆解
const CHAR_DECOMPOSE = {
  // ═══ 左右結構 ═══
  // 氵部
  '清':{ struct:'左右', yang:'氵(水4畫)', yin:'青(8畫)', roots:['氵','水','青'] },
  '浩':{ struct:'左右', yang:'氵(水4畫)', yin:'告(7畫)', roots:['氵','水','告','口'] },
  '洪':{ struct:'左右', yang:'氵(水4畫)', yin:'共(6畫)', roots:['氵','水','共'] },
  '涵':{ struct:'左右', yang:'氵(水4畫)', yin:'函(8畫)', roots:['氵','水','函'] },
  '淳':{ struct:'左右', yang:'氵(水4畫)', yin:'享(8畫)', roots:['氵','水','享'] },
  '渝':{ struct:'左右', yang:'氵(水4畫)', yin:'俞(9畫)', roots:['氵','水','俞','人'] },
  '源':{ struct:'左右', yang:'氵(水4畫)', yin:'原(10畫)', roots:['氵','水','原','厂','小'] },
  '澤':{ struct:'左右', yang:'氵(水4畫)', yin:'睪(13畫)', roots:['氵','水','睪'] },
  '沛':{ struct:'左右', yang:'氵(水4畫)', yin:'巿(4畫)', roots:['氵','水'] },
  '湘':{ struct:'左右', yang:'氵(水4畫)', yin:'相(9畫)', roots:['氵','水','相','木','目'] },
  '洋':{ struct:'左右', yang:'氵(水4畫)', yin:'羊(6畫)', roots:['氵','水','羊'] },
  '津':{ struct:'左右', yang:'氵(水4畫)', yin:'聿(6畫)', roots:['氵','水','聿'] },
  '淑':{ struct:'左右', yang:'氵(水4畫)', yin:'叔(8畫)', roots:['氵','水','叔','又'] },
  '潔':{ struct:'左右', yang:'氵(水4畫)', yin:'絜(12畫)', roots:['氵','水','絜','糸','刀'] },
  '潤':{ struct:'左右', yang:'氵(水4畫)', yin:'閏(12畫)', roots:['氵','水','閏','門','王'] },
  '淇':{ struct:'左右', yang:'氵(水4畫)', yin:'其(8畫)', roots:['氵','水','其'] },
  '泉':{ struct:'獨體/上下', yang:'白(5畫)', yin:'水(4畫)', roots:['白','水'] },
  // 忄部
  '怡':{ struct:'左右', yang:'忄(心4畫)', yin:'台(5畫)', roots:['忄','心','台','口'] },
  '恆':{ struct:'左右', yang:'忄(心4畫)', yin:'亘(6畫)', roots:['忄','心','亘','日'] },
  '悅':{ struct:'左右', yang:'忄(心4畫)', yin:'兌(7畫)', roots:['忄','心','兌','口'] },
  '惠':{ struct:'上下', yang:'叀(7畫)', yin:'心(4畫)', roots:['心','叀'] },
  '慧':{ struct:'上下', yang:'彗(11畫)', yin:'心(4畫)', roots:['心','彗'] },
  // 扌部
  '振':{ struct:'左右', yang:'扌(手4畫)', yin:'辰(7畫)', roots:['扌','手','辰'] },
  '揚':{ struct:'左右', yang:'扌(手4畫)', yin:'昜(9畫)', roots:['扌','手','昜','日'] },
  '捷':{ struct:'左右', yang:'扌(手4畫)', yin:'疌(9畫)', roots:['扌','手'] },
  // 阝左(阜8畫)
  '陳':{ struct:'左右', yang:'阝(阜8畫)', yin:'東(8畫)', roots:['阝','阜','東','木','日'] },
  '陽':{ struct:'左右', yang:'阝(阜8畫)', yin:'昜(9畫)', roots:['阝','阜','昜','日'] },
  '陸':{ struct:'左右', yang:'阝(阜8畫)', yin:'坴(8畫)', roots:['阝','阜','坴','土'] },
  '陶':{ struct:'左右', yang:'阝(阜8畫)', yin:'匋(8畫)', roots:['阝','阜','匋','缶'] },
  '阮':{ struct:'左右', yang:'阝(阜8畫)', yin:'元(4畫)', roots:['阝','阜','元'] },
  // 阝右(邑7畫)
  '鄭':{ struct:'左右', yang:'奠(12畫)', yin:'阝(邑7畫)', roots:['奠','阝','邑','酋','大'] },
  '郭':{ struct:'左右', yang:'享(8畫)', yin:'阝(邑7畫)', roots:['享','阝','邑'] },
  '邱':{ struct:'左右', yang:'丘(5畫)', yin:'阝(邑7畫)', roots:['丘','阝','邑'] },
  '邵':{ struct:'左右', yang:'召(5畫)', yin:'阝(邑7畫)', roots:['召','阝','邑','口','刀'] },
  '郁':{ struct:'左右', yang:'有(6畫)', yin:'阝(邑7畫)', roots:['有','阝','邑','月'] },
  // 王(玉5畫)旁
  '玲':{ struct:'左右', yang:'王(玉5畫)', yin:'令(5畫)', roots:['王','玉','令'] },
  '琪':{ struct:'左右', yang:'王(玉5畫)', yin:'其(8畫)', roots:['王','玉','其'] },
  '瑜':{ struct:'左右', yang:'王(玉5畫)', yin:'俞(9畫)', roots:['王','玉','俞'] },
  '瑞':{ struct:'左右', yang:'王(玉5畫)', yin:'耑(9畫)', roots:['王','玉','耑','山'] },
  '琳':{ struct:'左右', yang:'王(玉5畫)', yin:'林(8畫)', roots:['王','玉','林','木'] },
  '瑤':{ struct:'左右', yang:'王(玉5畫)', yin:'搖省(10畫)', roots:['王','玉','缶'] },
  '瑋':{ struct:'左右', yang:'王(玉5畫)', yin:'韋(9畫)', roots:['王','玉','韋'] },
  '珮':{ struct:'左右', yang:'王(玉5畫)', yin:'佩省(6畫)', roots:['王','玉','巾'] },
  '瑄':{ struct:'左右', yang:'王(玉5畫)', yin:'宣(9畫)', roots:['王','玉','宣','宀'] },
  '璟':{ struct:'左右', yang:'王(玉5畫)', yin:'景(12畫)', roots:['王','玉','景','日','京'] },
  // 礻部(示5畫)
  '祈':{ struct:'左右', yang:'礻(示5畫)', yin:'斤(4畫)', roots:['礻','示','斤'] },
  '祐':{ struct:'左右', yang:'礻(示5畫)', yin:'右(5畫)', roots:['礻','示','右','口'] },
  '祥':{ struct:'左右', yang:'礻(示5畫)', yin:'羊(6畫)', roots:['礻','示','羊'] },
  '福':{ struct:'左右', yang:'礻(示5畫)', yin:'畐(9畫)', roots:['礻','示','畐','口','田'] },
  '禮':{ struct:'左右', yang:'礻(示5畫)', yin:'豊(13畫)', roots:['礻','示','豊','豆'] },
  // 衤部(衣6畫)
  '裕':{ struct:'左右', yang:'衤(衣6畫)', yin:'谷(7畫)', roots:['衤','衣','谷','口'] },
  '褚':{ struct:'左右', yang:'衤(衣6畫)', yin:'者(9畫)', roots:['衤','衣','者','日'] },
  // 犭部(犬4畫)
  '狄':{ struct:'左右', yang:'犭(犬4畫)', yin:'火(4畫)', roots:['犭','犬','火'] },
  // 攵部
  '政':{ struct:'左右', yang:'正(5畫)', yin:'攵(攴4畫)', roots:['正','攵','攴','一','止'] },
  '敏':{ struct:'左右', yang:'每(7畫)', yin:'攵(攴4畫)', roots:['每','攵','攴','母'] },
  '敬':{ struct:'左右', yang:'苟(8畫)', yin:'攵(攴4畫)', roots:['苟','攵','攴','艹'] },
  '教':{ struct:'左右', yang:'孝(7畫)', yin:'攵(攴4畫)', roots:['孝','攵','攴','子'] },
  // 木部
  '林':{ struct:'左右', yang:'木(4畫)', yin:'木(4畫)', roots:['木','林'] },
  '柏':{ struct:'左右', yang:'木(4畫)', yin:'白(5畫)', roots:['木','白'] },
  '楓':{ struct:'左右', yang:'木(4畫)', yin:'風(9畫)', roots:['木','風'] },
  '梓':{ struct:'左右', yang:'木(4畫)', yin:'辛(7畫)', roots:['木','辛'] },
  '棟':{ struct:'左右', yang:'木(4畫)', yin:'東(8畫)', roots:['木','東','日'] },
  '楠':{ struct:'左右', yang:'木(4畫)', yin:'南(9畫)', roots:['木','南'] },
  // 車部
  '軒':{ struct:'左右', yang:'車(7畫)', yin:'干(3畫)', roots:['車','干'] },
  '輝':{ struct:'左右', yang:'光(6畫)', yin:'車(7畫)省', roots:['光','車','軍'] },
  // 金部
  '銘':{ struct:'左右', yang:'釒(金8畫)', yin:'名(6畫)', roots:['金','名','口','夕'] },
  '鋒':{ struct:'左右', yang:'釒(金8畫)', yin:'丰(4畫)', roots:['金','丰'] },
  '鈺':{ struct:'左右', yang:'釒(金8畫)', yin:'玉(5畫)', roots:['金','玉'] },
  // 言部
  '詩':{ struct:'左右', yang:'言(7畫)', yin:'寺(6畫)', roots:['言','寺','土','寸'] },
  '謙':{ struct:'左右', yang:'言(7畫)', yin:'兼(10畫)', roots:['言','兼'] },
  // 糸部
  '維':{ struct:'左右', yang:'糸(6畫)', yin:'隹(8畫)', roots:['糸','隹'] },
  '綺':{ struct:'左右', yang:'糸(6畫)', yin:'奇(8畫)', roots:['糸','奇','大'] },
  // ═══ 上下結構 ═══
  // 艹部(艸6畫)
  '芳':{ struct:'上下', yang:'艹(艸6畫)', yin:'方(4畫)', roots:['艹','艸','方'] },
  '英':{ struct:'上下', yang:'艹(艸6畫)', yin:'央(5畫)', roots:['艹','艸','央','大'] },
  '華':{ struct:'上下', yang:'艹(艸6畫)', yin:'化(4畫)', roots:['艹','艸','化'] },
  '萱':{ struct:'上下', yang:'艹(艸6畫)', yin:'宣(9畫)', roots:['艹','艸','宣','宀'] },
  '蕙':{ struct:'上下', yang:'艹(艸6畫)', yin:'惠(12畫)', roots:['艹','艸','惠','心'] },
  '菲':{ struct:'上下', yang:'艹(艸6畫)', yin:'非(8畫)', roots:['艹','艸','非'] },
  '蓮':{ struct:'上下', yang:'艹(艸6畫)', yin:'連(11畫)', roots:['艹','艸','連','辶','車'] },
  // 宀部
  '宇':{ struct:'上下', yang:'宀(3畫)', yin:'于(3畫)', roots:['宀','于'] },
  '安':{ struct:'上下', yang:'宀(3畫)', yin:'女(3畫)', roots:['宀','女'] },
  '宸':{ struct:'上下', yang:'宀(3畫)', yin:'辰(7畫)', roots:['宀','辰'] },
  '家':{ struct:'上下', yang:'宀(3畫)', yin:'豕(7畫)', roots:['宀','豕'] },
  '富':{ struct:'上下', yang:'宀(3畫)', yin:'畐(9畫)', roots:['宀','畐','口','田'] },
  '寶':{ struct:'上下', yang:'宀(3畫)', yin:'玉+貝+缶', roots:['宀','玉','貝','缶'] },
  // 日部
  '景':{ struct:'上下', yang:'日(4畫)', yin:'京(8畫)', roots:['日','京','口','小'] },
  '晨':{ struct:'上下', yang:'日(4畫)', yin:'辰(7畫)', roots:['日','辰'] },
  '昕':{ struct:'左右', yang:'日(4畫)', yin:'斤(4畫)', roots:['日','斤'] },
  '昊':{ struct:'上下', yang:'日(4畫)', yin:'天(4畫)', roots:['日','天','大'] },
  '晟':{ struct:'上下', yang:'日(4畫)', yin:'成(7畫)', roots:['日','成','戈'] },
  '明':{ struct:'左右', yang:'日(4畫)', yin:'月(4畫)', roots:['日','月','明'] },
  // 心/思/意系
  '思':{ struct:'上下', yang:'田(5畫)', yin:'心(4畫)', roots:['田','心'] },
  '志':{ struct:'上下', yang:'士(3畫)', yin:'心(4畫)', roots:['士','心'] },
  '忠':{ struct:'上下', yang:'中(4畫)', yin:'心(4畫)', roots:['中','心'] },
  '愛':{ struct:'上中下', yang:'爪+冖', yin:'心+友', roots:['爪','冖','心','友','又'] },
  // 其他
  '弘':{ struct:'左右', yang:'弓(3畫)', yin:'厶(2畫)', roots:['弓','厶'] },
  '建':{ struct:'半包', yang:'聿(6畫)', yin:'廴(3畫)', roots:['聿','廴'] },
  '強':{ struct:'左右', yang:'弓(3畫)', yin:'厶+虫', roots:['弓','厶','虫'] },
  '張':{ struct:'左右', yang:'弓(3畫)', yin:'長(8畫)', roots:['弓','長'] },
  '功':{ struct:'左右', yang:'工(3畫)', yin:'力(2畫)', roots:['工','力'] },
  '武':{ struct:'半包', yang:'一+弋', yin:'止(4畫)', roots:['一','弋','止','戈'] },
  '成':{ struct:'獨體', yang:'戊省', yin:'—', roots:['戈','丁'] },
  '嘉':{ struct:'上下', yang:'壴(8畫)', yin:'加(5畫)', roots:['壴','加','口','力'] },
  '翔':{ struct:'左右', yang:'羊(6畫)', yin:'羽(6畫)', roots:['羊','羽'] },
  '翰':{ struct:'左右', yang:'倝(10畫)', yin:'羽(6畫)', roots:['倝','羽','日'] },
  '翊':{ struct:'左右', yang:'立(5畫)', yin:'羽(6畫)', roots:['立','羽'] },
  '俊':{ struct:'左右', yang:'亻(人2畫)', yin:'夋(7畫)', roots:['亻','人','夋'] },
  '傑':{ struct:'上下', yang:'亻(人2畫)省', yin:'桀', roots:['人','木','舛'] },
  '偉':{ struct:'左右', yang:'亻(人2畫)', yin:'韋(9畫)', roots:['亻','人','韋'] },
  '宏':{ struct:'上下', yang:'宀(3畫)', yin:'厷(4畫)', roots:['宀','厷','弓'] },
  '雅':{ struct:'左右', yang:'牙(4畫)', yin:'隹(8畫)', roots:['牙','隹'] },
  '靜':{ struct:'左右', yang:'青(8畫)', yin:'爭(8畫)', roots:['青','爭'] },
  '秀':{ struct:'上下', yang:'禾(5畫)', yin:'乃(2畫)', roots:['禾','乃'] },
  '婷':{ struct:'左右', yang:'女(3畫)', yin:'亭(9畫)', roots:['女','亭','口','丁'] },
  '麗':{ struct:'上下', yang:'鹿省', yin:'丽', roots:['鹿'] },
  '奕':{ struct:'上下', yang:'亦(6畫)', yin:'大(3畫)', roots:['亦','大'] },
  '勇':{ struct:'上下', yang:'甬(7畫)', yin:'力(2畫)', roots:['甬','力','用'] },
  '豪':{ struct:'上下', yang:'高省', yin:'豕(7畫)', roots:['高','豕'] },
  '龍':{ struct:'獨體', yang:'立+月', yin:'—', roots:['立','月','龍'] },
  '鳳':{ struct:'半包', yang:'几', yin:'鳥省', roots:['几','鳥'] },
  '飛':{ struct:'獨體', yang:'—', yin:'—', roots:['飛'] },
  '凱':{ struct:'左右', yang:'豈(10畫)', yin:'几(2畫)', roots:['豈','几','山','己'] },
  '冠':{ struct:'上下', yang:'冖(2畫)', yin:'元+寸', roots:['冖','元','寸'] },
  '駿':{ struct:'左右', yang:'馬(10畫)', yin:'夋(7畫)', roots:['馬','夋'] },
  '皓':{ struct:'左右', yang:'白(5畫)', yin:'告(7畫)', roots:['白','告','口'] },
  '睿':{ struct:'上下', yang:'目(5畫)', yin:'叡省', roots:['目','谷'] },
  '穎':{ struct:'上下', yang:'禾(5畫)+頃', yin:'匕', roots:['禾','匕','頁'] },
};

// 通用結構拆解函數（用於 CHAR_DECOMPOSE 表外的字，強制硬性拆解）
function decomposeChar(ch){
  // 優先查精確拆解表
  if(CHAR_DECOMPOSE[ch]) return CHAR_DECOMPOSE[ch];
  
  // 從 guessRoots 取字根，組裝結構描述
  const roots = guessRoots(ch);
  if(roots.length >= 2){
    return { struct:'推測', yang:roots[0], yin:roots.slice(1).join('+'), roots:roots };
  } else if(roots.length === 1){
    return { struct:'獨體', yang:roots[0], yin:'—', roots:roots };
  }
  // 絕不回傳空（guessRoots 已保證不回傳空陣列）
  return { struct:'獨體', yang:ch, yin:'—', roots:[ch] };
}
function analyzeZodiacName(fullName, birthYear){
  if(!fullName || fullName.length<2 || !birthYear) return null;
  const zodiac = getChineseZodiac(birthYear);
  const db = ZODIAC_NAME_DB[zodiac];
  if(!db) return null;

  const chars = [...fullName];
  // 姓名位置定義
  const positions = [];
  if(chars.length===2){
    positions.push({char:chars[0], label:'姓氏', lifeStage:'0-20歲（祖德天運）'});
    positions.push({char:chars[1], label:'名字', lifeStage:'21-60歲（一生格局）'});
  } else if(chars.length===3){
    positions.push({char:chars[0], label:'姓氏', lifeStage:'0-20歲（祖德天運）'});
    positions.push({char:chars[1], label:'名一', lifeStage:'21-40歲（情志格）'});
    positions.push({char:chars[2], label:'名二', lifeStage:'41-60歲（事業財富格）'});
  } else if(chars.length===4){
    positions.push({char:chars[0]+chars[1], label:'姓氏', lifeStage:'0-20歲（祖德天運）'});
    positions.push({char:chars[2], label:'名一', lifeStage:'21-40歲（情志格）'});
    positions.push({char:chars[3], label:'名二', lifeStage:'41-60歲（事業財富格）'});
  }

  // 逐字拆解＋比對
  const results = [];
  let totalScore = 0;
  let totalLike = 0;
  let totalDislike = 0;

  positions.forEach(pos => {
    const charList = [...pos.char]; // 處理複姓
    const charResults = [];

    charList.forEach(ch => {
      const decomp = decomposeChar(ch);
      const roots = decomp.roots.length ? decomp.roots : (CHAR_ROOTS[ch] || guessRoots(ch));
      const hits = [];

      // 比對喜用
      db.like.forEach(rule => {
        const matched = rule.roots.filter(r => roots.includes(r));
        if(matched.length > 0){
          hits.push({type:'吉', label:rule.label, reason:rule.reason, score:rule.score, matchedRoots:matched});
          totalScore += rule.score;
          totalLike++;
        }
      });

      // 比對忌用
      db.dislike.forEach(rule => {
        const matched = rule.roots.filter(r => roots.includes(r));
        if(matched.length > 0){
          hits.push({type:'凶', label:rule.label, reason:rule.reason, score:rule.score, matchedRoots:matched});
          totalScore += rule.score; // score 本身是負數
          totalDislike++;
        }
      });

      charResults.push({char:ch, roots, hits, decomp});
    });

    results.push({...pos, charResults});
  });

  // 犧牲格特殊判定
  let isSacrifice = false;
  let sacrificeNote = '';
  if(['豬','牛','羊'].includes(zodiac)){
    const allHits = results.flatMap(r=>r.charResults.flatMap(c=>c.hits));
    const hasSacrifice = allHits.some(h=>h.label==='犧牲格' || h.label==='彩衣格' || h.label==='彩衣犧牲');
    if(hasSacrifice){
      isSacrifice = true;
      sacrificeNote = `${ZODIAC_EMOJI[zodiac]}${zodiac}為祭祀牲畜，名字帶有王/大/彩衣字根，形成「犧牲格」——外表風光，內心承受極大壓力，常為他人犧牲自己。`;
    }
  }

  // 蛇豬衝特殊判定
  let isSnakePigClash = false;
  let clashNote = '';
  if(zodiac==='豬'){
    const allHits = results.flatMap(r=>r.charResults.flatMap(c=>c.hits));
    const hasClash = allHits.some(h=>h.label==='蛇豬衝');
    if(hasClash){
      isSnakePigClash = true;
      const clashChars = results.flatMap(r=>r.charResults.filter(c=>c.hits.some(h=>h.label==='蛇豬衝'))).map(c=>c.char);
      clashNote = `「${clashChars.join('、')}」含蛇形字根（辶/弓/几/廴），亥豬見巳蛇為六衝——易犯小人、血光意外、勞碌無功。`;
    }
  }

  // 凶優先原則：有凶字根時壓過吉字根
  let overallLevel;
  const absScore = totalScore;
  if(totalDislike > 0 && totalLike > 0){
    overallLevel = absScore >= 5 ? '吉中帶險' : absScore >= 0 ? '表吉實凶' : absScore >= -10 ? '偏凶' : '大凶';
  } else if(totalDislike === 0 && totalLike > 0){
    overallLevel = absScore >= 20 ? '大吉' : absScore >= 10 ? '吉' : '小吉';
  } else if(totalDislike > 0 && totalLike === 0){
    overallLevel = absScore <= -20 ? '大凶' : absScore <= -10 ? '凶' : '小凶';
  } else {
    overallLevel = '平';
  }

  // 犧牲格強制判定
  if(isSacrifice) overallLevel = '犧牲格（凶）';

  // ★ 八字喜忌覆寫規則：若「凶」的字根五行正好是八字調候/喜用神，強制提升評級
  let baziOverride=false;
  let baziOverrideNote='';
  let baziScoreOverride=false;
  if(typeof S!=='undefined' && S.bazi && S.bazi.fav && (overallLevel.includes('凶') || overallLevel.includes('險'))){
    const baziF=S.bazi.fav||[];
    const baziTiaohou=(S.bazi.tiaohou && S.bazi.tiaohou.need)?S.bazi.tiaohou.need:[];
    // 檢查凶的字根是否含有八字喜用神/調候用神的五行
    const allDislikeElems=results.flatMap(r=>r.charResults.flatMap(c=>c.hits.filter(h=>h.type==='凶').map(h=>{
      // 推測字根對應五行
      if(h.label.includes('火')||h.label.includes('蛇')||h.label.includes('日')) return '火';
      if(h.label.includes('水')||h.label.includes('豬')||h.label.includes('雨')) return '水';
      if(h.label.includes('金')||h.label.includes('刀')||h.label.includes('酉')) return '金';
      if(h.label.includes('木')||h.label.includes('虎')||h.label.includes('卯')) return '木';
      if(h.label.includes('土')||h.label.includes('牛')||h.label.includes('辰')) return '土';
      return '';
    }))).filter(Boolean);
    
    const overlapFav=allDislikeElems.filter(e=>baziF.includes(e)||baziTiaohou.includes(e));
    if(overlapFav.length>0){
      const uniqueEls=[...new Set(overlapFav)];
      baziOverride=true;
      // 覆寫等級：凶→平/小吉
      if(overallLevel.includes('大凶')) overallLevel='偏凶（八字有緩解）';
      else if(overallLevel.includes('凶') || overallLevel.includes('險')) overallLevel='平（八字互補）';
      baziOverrideNote=`雖然生肖派判定字根${uniqueEls.join('、')}行有沖剋，但此五行正好是八字命盤極度需要的${baziTiaohou.length&&baziTiaohou.some(e=>uniqueEls.includes(e))?'調候用神':'喜用神'}。這種「以毒攻毒」的結構，反而精準補足了本命盤的盲區。`;
      // 調整數值分（numericScore 已在下方計算）
      baziScoreOverride = true; // 標記需要覆寫分數
    }
  }
  const warnings = [];
  if(isSacrifice) warnings.push('此名為犧牲格：外人看你風光，你內心最知苦楚。注意不要過度付出、學會拒絕。');
  if(isSnakePigClash) warnings.push('蛇豬衝：注意交通安全、不可輕信他人、合約務必仔細看清。');
  const allDislikeHits = results.flatMap(r=>r.charResults.flatMap(c=>c.hits.filter(h=>h.type==='凶')));
  if(allDislikeHits.some(h=>h.label==='遇刀')) warnings.push('名帶刀刃：注意手術、外傷、利器相關風險。');
  if(allDislikeHits.some(h=>h.label==='遇人被宰'||h.label==='遇人')) warnings.push('名帶人形字根：此生肖見人不利，容易替人背鍋。');
  if(allDislikeHits.some(h=>h.label.includes('六衝'))) warnings.push('名帶六衝字根：人際關係易起衝突，注意口舌是非。');

  // 計算 0-100 分
  let numericScore = 50 + totalScore * 2;
  numericScore = Math.max(5, Math.min(95, numericScore));
  
  // 八字覆寫時保底50分
  if(baziScoreOverride){
    numericScore = Math.max(numericScore, 50);
  }

  return {
    name: fullName,
    zodiac,
    emoji: ZODIAC_EMOJI[zodiac],
    dizhi: ZODIAC_DIZHI[zodiac],
    positions: results,
    totalScore,
    totalLike,
    totalDislike,
    overallLevel,
    numericScore,
    isSacrifice,
    sacrificeNote,
    isSnakePigClash,
    clashNote,
    warnings,
    baziOverride,
    baziOverrideNote
  };
}

/* =============================================================
   水晶推薦系統 CRYSTAL — 擴充版
   ============================================================= */
const CRYSTAL_DB={
  金:[
    {n:'白水晶',icon:'💍',el:'金',d:'淨化能量場，增強思維清晰度，萬能調和石。',wear:'左手佩戴，或放書桌/辦公桌。',taboo:'避免碰撞，定期淨化。'},
    {n:'黃鐵礦',icon:'✨',el:'金',d:'增強財運，提升自信與行動力。',wear:'放在錢包或辦公桌左上角。',taboo:'怕水，避免接觸液體。'},
    {n:'白幽靈',icon:'💠',el:'金',d:'淨化磁場，提升靈性直覺。',wear:'冥想時手持或佩戴。',taboo:'避免陽光直射。'},
    {n:'鈦晶',icon:'⚡',el:'金',d:'招正財偏財，增強領導力與氣魄。',wear:'左手佩戴，面試/簽約時特別有效。',taboo:'磁場強，睡眠時建議取下。'}
  ],
  木:[
    {n:'綠幽靈',icon:'💚',el:'木',d:'招正財，事業穩步上升，適合上班族。',wear:'左手佩戴，放辦公桌增事業運。',taboo:'避免高溫與化學品。'},
    {n:'東陵玉',icon:'🌿',el:'木',d:'舒緩壓力，帶來好運與樂觀心態。',wear:'隨身佩戴或放枕頭下助眠。',taboo:'定期用月光淨化。'},
    {n:'翡翠',icon:'💎',el:'木',d:'護身辟邪，增強健康與人緣。',wear:'佩戴在靠近心臟處。',taboo:'避免碰撞與高溫。'},
    {n:'橄欖石',icon:'🌱',el:'木',d:'療癒心輪，帶來正能量與好運。',wear:'左手佩戴，可配合冥想。',taboo:'質地較軟，注意保護。'}
  ],
  水:[
    {n:'黑曜石',icon:'🖤',el:'水',d:'擋煞辟邪首選，以水洩金，化壓力為動力。',wear:'右手佩戴辟邪。',taboo:'定期流水淨化。'},
    {n:'黑髮晶',icon:'🕸️',el:'水',d:'排除負能量，增強領袖魅力，官殺太旺者首選。',wear:'左手佩戴。',taboo:'磁場強，敏感體質注意。'},
    {n:'海藍寶',icon:'💙',el:'水',d:'增強溝通力，平靜情緒，水氣滋養日主。',wear:'佩戴在喉輪附近（項鍊）效果最佳。',taboo:'避免長時間日曬。'},
    {n:'藍虎眼',icon:'👁️',el:'水',d:'增強洞察力與決斷力，水氣護身。',wear:'左手佩戴。',taboo:'定期淨化。'}
  ],
  火:[
    {n:'紅瑪瑙',icon:'❤️',el:'火',d:'激發熱情，增強行動力與勇氣。',wear:'右手佩戴增強行動力。',taboo:'避免高溫環境。'},
    {n:'石榴石',icon:'🔴',el:'火',d:'提升活力，增強意志力與桃花運。',wear:'左手佩戴，貼身效果好。',taboo:'定期用水晶簇淨化。'},
    {n:'紅碧璽',icon:'💗',el:'火',d:'強力招桃花，增強人際魅力。',wear:'佩戴在心輪附近。',taboo:'磁場敏感，避免與其他強磁場水晶混戴。'},
    {n:'太陽石',icon:'☀️',el:'火',d:'帶來正能量，增強自信與領導力。',wear:'日間佩戴效果佳。',taboo:'避免長時間泡水。'}
  ],
  土:[
    {n:'黃水晶',icon:'💛',el:'土',d:'招偏財，提升自信與個人魅力。',wear:'左手佩戴，放錢包也可。',taboo:'避免陽光長時間直射，會褪色。'},
    {n:'虎眼石',icon:'🐅',el:'土',d:'增強決斷力，招財辟邪，穩定心性。',wear:'右手佩戴增強氣場。',taboo:'定期日光浴淨化（短時間）。'},
    {n:'茶晶',icon:'🍵',el:'土',d:'排除負能量，增強穩定感。',wear:'佩戴或放在家中客廳。',taboo:'避免化學品。'},
    {n:'瑪瑙',icon:'🔶',el:'土',d:'保護、穩定、增強耐力。',wear:'可隨身佩戴，適合各場合。',taboo:'質地堅硬但仍需小心碰撞。'}
  ]
};

// 問題類型 → 特殊推薦
const CRYSTAL_BY_TYPE={
  love:[{n:'粉晶',icon:'💕',el:'土',d:'招桃花首選，增強感情運與人際魅力。',wear:'左手佩戴，睡前放枕頭下。',taboo:'需定期淨化，吸收負能量後會變暗。'},
        {n:'草荓晶',icon:'🍓',el:'火',d:'增強異性緣，帶來甜蜜的戀愛機會。',wear:'左手佩戴，約會時效果倍增。',taboo:'避免碰撞。'}],
  career:[{n:'鈦晶',icon:'⚡',el:'金',d:'事業晉升首選，增強領導力與決斷力。',wear:'面試/重要會議時佩戴。',taboo:'磁場強，睡眠時取下。'}],
  wealth:[{n:'黃水晶',icon:'💛',el:'土',d:'偏財運首選，提升投資眼光。',wear:'左手佩戴，放收銀台也可。',taboo:'避免日曬。'},
          {n:'綠幽靈',icon:'💚',el:'木',d:'正財運首選，適合穩健理財。',wear:'左手佩戴。',taboo:'避免高溫。'}],
  health:[{n:'紫水晶',icon:'💜',el:'火',d:'安神助眠，穩定情緒，促進身心平衡。',wear:'放枕頭下助眠，或佩戴在第三眼處冥想。',taboo:'避免日曬會褪色。'}]
};

function renderCrystalExpanded(bazi, type){
  const need = bazi.fav[0];
  const th = bazi.tiaohou;
  const baseCrystals = CRYSTAL_DB[need] || CRYSTAL_DB['土'];
  const typeCrystals = CRYSTAL_BY_TYPE[type] || [];

  // 調候用神也加入（如冬木需火）
  let thCrystals = [];
  if(th && th.need){
    th.need.forEach(e => {
      if(e !== need && CRYSTAL_DB[e]) thCrystals = thCrystals.concat(CRYSTAL_DB[e]);
    });
  }

  // 去重合併：類型 > 調候 > 喜用神
  const allCrystals = [...typeCrystals];
  thCrystals.forEach(c=>{if(!allCrystals.find(a=>a.n===c.n))allCrystals.push(c)});
  baseCrystals.forEach(c=>{if(!allCrystals.find(a=>a.n===c.n))allCrystals.push(c)});
  const display = allCrystals.slice(0,4);

  const thNote = th ? `＋調候 <span class="tag tag-blue">${th.reason}</span>（需${th.need.join('、')}行）` : '';
  document.getElementById('r-crystal').innerHTML=`
    <p class="mb-md">根據命盤（喜用 <span class="tag tag-gold">${need}行</span>${thNote}）與問題類型（<span class="tag tag-blue">${getTypeLabel(type)}</span>），推薦：</p>
    <div class="crystal-grid">${display.map(c=>`
      <div class="crystal-card">
        <div class="crystal-icon">${c.icon}</div>
        <div class="crystal-name">${c.n}</div>
        <div class="text-xs mb-sm"><span class="el-tag el-${c.el}">${c.el}行</span></div>
        <p class="text-sm text-dim">${c.d}</p>
        <p class="text-xs text-muted mt-sm"><i class="fas fa-hand-holding-heart"></i> ${c.wear}</p>
        <p class="text-xs text-warn mt-sm"><i class="fas fa-exclamation-triangle"></i> ${c.taboo}</p>
      </div>`).join('')}</div>
    <p class="text-xs text-muted mt-md"><i class="fas fa-info-circle"></i> 本建議僅供能量校準參考，不具醫療或命運保證效力。水晶效果因人而異，請依自身感受調整。</p>`;
}

/* =============================================================
   FUSION ENGINE v3 — 六維度加權融合
   ============================================================= */
function runAnalysisV2(){
  try{ renderBazi(); }catch(e){ console.error('renderBazi error:', e); alert('renderBazi error: '+e.message); return; }
  try{ renderMeihua(); }catch(e){ console.error('renderMeihua error:', e); }
  try{ renderTarot(); }catch(e){ console.error('renderTarot error:', e); }
  try{ renderZiwei(); }catch(e){ console.error('renderZiwei error:', e); }
  try{ renderNatalChart(); }catch(e){ 
    console.error('renderNatalChart error:', e); 
    const el=document.getElementById('d-natal-summary');
    if(el) el.innerHTML='<p style="color:#f87171">星盤渲染錯誤：'+e.message+'</p>';
  }
  try{ renderName(); }catch(e){ console.error('renderName error:', e); }

  const b=S.bazi; if(!b)return;
  const type=S.form.type;
  const question=S.form.question;

  // ── 1. 八字評分 (0-100) ──
  let baziScore=45;
  // ═══ 新引擎 v2.0 接入：用承載力 + 能量流向 + 權重分 ═══
  const favEl=b.fav&&b.fav[0]?b.fav[0]:'';
  const unfavEl=b.unfav&&b.unfav[0]?b.unfav[0]:'';
  const _wEC = b.weightedEC || {};
  const _cap = b.capacity || 0;
  
  // [1] 承載力基礎分（最重要的結構指標）
  if(_cap >= 50) baziScore += 15;      // 穩定型
  else if(_cap >= 30) baziScore += 5;   // 偏弱型
  else if(_cap >= 10) baziScore -= 5;   // 弱
  else baziScore -= 12;                  // 漂浮型
  
  // [2] 喜用神在命盤中的權重（用 weightedEC 而非 ep 比例）
  const favW = favEl ? (_wEC[favEl] || 0) : 0;
  const unfavW = unfavEl ? (_wEC[unfavEl] || 0) : 0;
  if(favW >= 5) baziScore += 12;
  else if(favW >= 3) baziScore += 6;
  else baziScore -= 3; // 喜用神力量不足
  if(unfavW >= 6) baziScore -= 10; // 忌神權重過高
  
  // [3] 身強弱 × 類型交叉（保留但權重降低）
  if(type==='wealth'){
    if(b.strong) baziScore += 8;
    else if(_cap < 30) baziScore -= 8; // 漂浮型扛不住財
    else baziScore -= 3;
  } else if(type==='career'){
    if(b.strong) baziScore += 6;
    else if(_cap >= 30) baziScore += 2; // 偏弱但有根
    else baziScore -= 6;
  } else if(type==='love'){
    // 感情不完全看強弱
    if(b.shensha&&b.shensha.includes('桃花')) baziScore += 8;
    if(b.shensha&&b.shensha.includes('紅鸞')) baziScore += 6;
    if(b.shensha&&b.shensha.includes('孤辰')) baziScore -= 6;
    if(b.shensha&&b.shensha.includes('寡宿')) baziScore -= 6;
  } else if(type==='health'){
    // 健康看承載力 + 五行均衡
    if(_cap >= 50) baziScore += 8;
    else if(_cap < 20) baziScore -= 10;
    const _epVals = Object.values(b.ep||{});
    const _weakEls = _epVals.filter(v => v < 5).length;
    if(_weakEls >= 2) baziScore -= 8;
  }

  // [4] 大運影響（保留）
  const curDy=b.dayun?b.dayun.find(d=>d.isCurrent):null;
  if(curDy){
    if(curDy.level==='大吉')baziScore+=18;
    else if(curDy.level==='中吉')baziScore+=10;
    else if(curDy.level==='小吉')baziScore+=4;
    else if(curDy.level==='小凶')baziScore-=6;
    else if(curDy.level==='中凶')baziScore-=12;
    else if(curDy.level==='大凶')baziScore-=18;
  }

  // [5] 神煞（大幅降權，只做微調）
  if(b.shensha){
    if(b.shensha.includes('天乙貴人'))baziScore+=3;
    if(b.shensha.includes('天德'))baziScore+=2;
    if(b.shensha.includes('月德'))baziScore+=2;
    if(b.shensha.includes('文昌')&&type==='career')baziScore+=3;
    if(b.shensha.includes('將星'))baziScore+=2;
    if(b.shensha.includes('羊刃'))baziScore-=4;
    if(b.shensha.includes('劫煞'))baziScore-=3;
  }
  
  // [6] 能量阻斷懲罰
  const _flow = b.energyFlow || {};
  if(_flow.breakPoint && _flow.breakPoint !== '無明顯阻斷'){
    baziScore -= 5; // 有能量阻斷點
  }
  
  baziScore=Math.max(8,Math.min(95,baziScore));

  // ── 2. 梅花評分（體用生剋 + 卦象 + 動爻） ──
  let mhScore=50;
  if(S.meihua){
    mhScore=analyzeMeihuaScore(S.meihua, type);
  }

  // ── 3. 塔羅評分（位置加權 + 特定牌加權） ──
  let tarotScore=50;
  if(S.tarot.drawn.length>=10){
    const ta=analyzeTarotSpread(S.tarot.drawn, type);
    tarotScore=ta.score;
    tarotScore=Math.max(10,Math.min(90,tarotScore));
  }

  // ── 4. 紫微評分（命宮 + 類型宮位 加大幅度） ──
  let ziweiScore=40;
  if(S.ziwei){
    const mingStars=S.ziwei.palaces[0].stars;
    const goodStars=['紫微','天府','天同','天梁','天相','太陽','太陰','文昌','文曲','左輔','右弼'];
    const badStars=['擎羊','陀羅','火星','鈴星'];
    const neutralStars=['七殺','破軍','貪狼']; // 中性星看組合
    mingStars.forEach(s=>{
      if(goodStars.includes(s.name))ziweiScore+=7;
      if(badStars.includes(s.name))ziweiScore-=6;
      if(s.hua==='化祿')ziweiScore+=12;
      if(s.hua==='化權')ziweiScore+=8;
      if(s.hua==='化科')ziweiScore+=6;
      if(s.hua==='化忌')ziweiScore-=12;
      // 亮度加成
      if(s.brightness==='廟')ziweiScore+=4;
      else if(s.brightness==='旺')ziweiScore+=2;
      else if(s.brightness==='陷')ziweiScore-=5;
    });
    // 問題對應宮位（權重更高）
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7};
    const gongIdx=typeToGong[type];
    if(gongIdx!==undefined&&S.ziwei.palaces[gongIdx]){
      const gongStars=S.ziwei.palaces[gongIdx].stars;
      gongStars.forEach(s=>{
        if(goodStars.includes(s.name))ziweiScore+=8;
        if(badStars.includes(s.name))ziweiScore-=7;
        if(s.hua==='化祿')ziweiScore+=15;
        if(s.hua==='化權')ziweiScore+=10;
        if(s.hua==='化科')ziweiScore+=8;
        if(s.hua==='化忌')ziweiScore-=15;
        if(s.brightness==='廟'||s.brightness==='旺')ziweiScore+=5;
        else if(s.brightness==='陷')ziweiScore-=6;
      });
      // 宮位無主星 = 偏弱
      if(!gongStars.some(s=>s.type==='major'))ziweiScore-=10;
    }
    ziweiScore=Math.max(8,Math.min(95,ziweiScore));
  }

  // ── 5. 姓名學評分（三才五格 + 生肖姓名學雙系統） ──
  let nameScore=50;
  let nameResult=null;
  let zodiacNameResult=null;

  if(S.form.name&&S.form.name.length>=2){
    // A. 三才五格（佔姓名分 40%）
    nameResult=analyzeName(S.form.name);
    let sanCaiScore = 50;
    if(nameResult){
      [nameResult.tianGe,nameResult.renGe,nameResult.diGe,nameResult.waiGe,nameResult.zongGe].forEach(g=>{
        if(g.fortune.level==='大吉')sanCaiScore+=6;
        else if(g.fortune.level==='吉')sanCaiScore+=3;
        else if(g.fortune.level==='凶')sanCaiScore-=4;
      });
      if(nameResult.sanCaiLevel==='大吉')sanCaiScore+=10;
      else if(nameResult.sanCaiLevel==='吉')sanCaiScore+=5;
      else if(nameResult.sanCaiLevel==='凶')sanCaiScore-=8;
      sanCaiScore=Math.max(10,Math.min(90,sanCaiScore));
    }

    // B. 生肖姓名學（佔姓名分 60%，因為形義派更貼近真實影響）
    const [birthY] = S.form.bdate.split('-').map(Number);
    zodiacNameResult = analyzeZodiacName(S.form.name, birthY);
    let zodiacScore = 50;
    if(zodiacNameResult){
      zodiacScore = zodiacNameResult.numericScore;
      S.zodiacNameResult = zodiacNameResult;
    }

    // 雙系統加權合併
    if(nameResult && zodiacNameResult){
      nameScore = Math.round(sanCaiScore * 0.4 + zodiacScore * 0.6);
    } else if(zodiacNameResult){
      nameScore = zodiacScore;
    } else if(nameResult){
      nameScore = sanCaiScore;
    }
    nameScore=Math.max(10,Math.min(90,nameScore));
  }

  // ── 6. 西洋星盤評分 ──
  let natalScore=50;
  if(S.natal){
    const np=S.natal.planets;
    // 太陽宮位加分
    const sunH=np['太陽'].house;
    if([1,5,9,10,11].includes(sunH)) natalScore+=10; // 吉宮
    if([6,8,12].includes(sunH)) natalScore-=8; // 凶宮
    // 月亮
    const moonH=np['月亮'].house;
    if([2,4,5,7].includes(moonH)) natalScore+=6;
    if([6,8,12].includes(moonH)) natalScore-=6;
    // 吉星(木星/金星)在角宮(1,4,7,10)
    if([1,4,7,10].includes(np['木星'].house)) natalScore+=10;
    if([1,4,7,10].includes(np['金星'].house)) natalScore+=8;
    // 凶星(土星/火星)在角宮
    if([1,4,7,10].includes(np['土星'].house)) natalScore-=6;
    if([1,4,7,10].includes(np['火星'].house)&&type!=='career') natalScore-=4;
    // 相位 吉凶比
    const goodA=S.natal.aspects.filter(a=>a.good).length;
    const badA=S.natal.aspects.filter(a=>!a.good).length;
    if(goodA>badA+3) natalScore+=12;
    else if(goodA>badA) natalScore+=6;
    else if(badA>goodA+3) natalScore-=10;
    else if(badA>goodA) natalScore-=4;
    // 類型加分
    if(type==='love'){
      if([5,7].includes(np['金星'].house)) natalScore+=10;
      if(np['金星'].sign==='金牛'||np['金星'].sign==='天秤') natalScore+=6;
    } else if(type==='career'){
      if([10,6,2].includes(np['太陽'].house)) natalScore+=8;
      if([10].includes(np['土星'].house)) natalScore+=6; // 土星10宮=事業有成
      if([10].includes(np['木星'].house)) natalScore+=10;
    } else if(type==='wealth'){
      if([2,8].includes(np['木星'].house)) natalScore+=10;
      if([2,8].includes(np['金星'].house)) natalScore+=8;
    } else if(type==='health'){
      if([6].includes(np['火星'].house)) natalScore-=8;
      if([6].includes(np['土星'].house)) natalScore-=6;
    }
    natalScore=Math.max(8,Math.min(95,natalScore));
  }
  const hasNat = S.natal ? 1 : 0;

  /* ══════════════════════════════════════════════════
     動態權重系統：依問題性質分配各維度影響力
     ──────────────────────────────────────────────────
     🧭 長期人生方向 → 八字 / 紫微（權重高）
     ⚡ 眼前抉擇     → 梅花 / 塔羅（權重高）
     🧠 狀態 / 混合  → 均衡，融合判斷
     姓名學永遠只做輔助（≤8%），因分數不隨問題變動
     ══════════════════════════════════════════════════ */

  // 問題時間維度判定
  const qText = S.form ? (S.form.question||'') : '';
  const isShortTerm = /這[個月週周]|今[天年月]|明[天年]|最近|馬上|眼前|立刻|短期|現在|下[個半]|近期/.test(qText);
  const isLongTerm = /一輩子|未來[35十]|長期|十年|人生|命運|天生|適合|方向|老了|退休|終身/.test(qText);
  const isDecision = /該不該|要不要|還是|選擇|決定|A或B|轉職|離職|分手|換工作|跳槽|卻.*還是|買.*還是/.test(qText);
  const isStatus = /為什麼|怎麼了|卡住|困境|狀況|卟因|瓶頸/.test(qText);

  let w;
  const hasMh = S.meihua ? 1 : 0;
  const hasTr = S.tarot.drawn.length >= 10 ? 1 : 0;
  const hasZw = S.ziwei ? 1 : 0;
  const hasNm = (nameResult || zodiacNameResult) ? 1 : 0;

  // 問題類型也暗示時間維度（補充文本判斷不足時）
  const typeShort = ['love','relationship'].includes(type); // 感情人際常偏短期抉擇
  const typeLong = ['career','health'].includes(type); // 事業健康常偏長期

  if(isShortTerm || isDecision || (typeShort && !isLongTerm)) {
    // ⚡ 短期 / 抉擇：梅花塔羅為主，八字紫微星盤為輔
    w = {
      bazi:   0.12,
      meihua: hasMh ? 0.28 : 0,
      tarot:  hasTr ? 0.28 : 0,
      ziwei:  hasZw ? 0.10 : 0,
      natal:  hasNat ? 0.10 : 0,
      name:   hasNm ? 0.05 : 0
    };
  } else if(isLongTerm) {
    // 🧭 長期人生方向：八字紫微星盤為主
    w = {
      bazi:   0.28,
      meihua: hasMh ? 0.08 : 0,
      tarot:  hasTr ? 0.08 : 0,
      ziwei:  hasZw ? 0.25 : 0,
      natal:  hasNat ? 0.18 : 0,
      name:   hasNm ? 0.07 : 0
    };
  } else if(isStatus) {
    // 🧠 狀態卡關：均衡
    w = {
      bazi:   0.18,
      meihua: hasMh ? 0.20 : 0,
      tarot:  hasTr ? 0.20 : 0,
      ziwei:  hasZw ? 0.15 : 0,
      natal:  hasNat ? 0.15 : 0,
      name:   hasNm ? 0.05 : 0
    };
  } else {
    // 預設：均衡偏東方命理
    w = {
      bazi:   0.23,
      meihua: hasMh ? 0.18 : 0,
      tarot:  hasTr ? 0.18 : 0,
      ziwei:  hasZw ? 0.15 : 0,
      natal:  hasNat ? 0.15 : 0,
      name:   hasNm ? 0.05 : 0
    };
  }

  // 類型微調
  if(type === 'love' && hasZw) w.ziwei += 0.04;
  if(type === 'love' && hasNat) w.natal += 0.04; // 金星/7宮重要
  if(type === 'career' && hasZw) w.ziwei += 0.04;
  if(type === 'career' && hasNat) w.natal += 0.04; // MC/10宮重要
  if(type === 'wealth') { w.meihua += hasMh ? 0.03 : 0; w.tarot += hasTr ? 0.03 : 0; }

  // 姓名學上限：不管怎樣不超過 8%
  if(w.name > 0.08) w.name = 0.08;

  const totalW = Object.values(w).reduce((a,b) => a+b, 0);
  const scores = {bazi:baziScore, meihua:mhScore, tarot:tarotScore, ziwei:ziweiScore, natal:natalScore, name:nameScore};
  // 異常值壓縮：差距極大時輕微壓縮（保留更多差異性）
  const activeKeys = Object.keys(w).filter(k => w[k] > 0);
  const sortedScores = activeKeys.map(k => scores[k]).sort((a,b) => a-b);
  const median = sortedScores[Math.floor(sortedScores.length/2)];
  const adjustedScores = {};
  activeKeys.forEach(k => {
    const diff = scores[k] - median;
    if(Math.abs(diff) > 40) {
      adjustedScores[k] = median + diff * 0.8;
    } else {
      adjustedScores[k] = scores[k];
    }
  });

  let finalProb = 0;
  for(const k of Object.keys(w)) finalProb += (adjustedScores[k] || scores[k]) * (w[k] / totalW);



  // 一致性放大（閾值調低讓結果更分散）
  const activeScores = Object.keys(w).filter(k => w[k] > 0).map(k => scores[k]);
  const highCount = activeScores.filter(s => s >= 52).length;
  const lowCount = activeScores.filter(s => s <= 48).length;
  const dimN = activeScores.length;
  if(highCount >= dimN) finalProb *= 1.25;
  else if(highCount >= dimN*0.75) finalProb *= 1.15;
  else if(lowCount >= dimN) finalProb *= 0.75;
  else if(lowCount >= dimN*0.75) finalProb *= 0.85;

  // 移除離心力放大，改用溫和天花板地板（命理沒有100%確定）
  finalProb = Math.round(Math.max(15, Math.min(92, finalProb)));

  // 記錄權重供UI顯示
  const _wNorm = {};
  for(const k of Object.keys(w)) _wNorm[k] = w[k] > 0 ? Math.round(w[k] / totalW * 100) : 0;

  // ── 主導系統 + 校驗系統判定 ──
  const leadMap = {
    shortTerm: {lead:'meihua',verify:'tarot'},
    longTerm:  {lead:'bazi',verify:'ziwei'},
    decision:  {lead:'meihua',verify:'tarot'},
    status:    {lead:'bazi',verify:'ziwei'}
  };
  const qDim = (isShortTerm||isDecision)?'shortTerm':isLongTerm?'longTerm':isStatus?'status':'longTerm';
  const {lead:leadSys, verify:verifySys} = leadMap[qDim];
  const leadScore = scores[leadSys]||50;
  const verifyScore = scores[verifySys]||50;
  const leadGood = leadScore >= 55;
  const verifyGood = verifyScore >= 55;

  // ── Verdict（6級判定・子意圖感知版） ──
  const _q2v = qText || '';
  const _isQuitV = /離職|辭職|跳槽|換工作|換跑道|轉行|轉職|該不該離開|想走|不想做/.test(_q2v);
  const _isBreakV = /分手|離婚|該不該離開|要不要分/.test(_q2v) && type==='love';
  const _isSellV = /賣掉|出場|停損|該不該賣/.test(_q2v) && type==='wealth';
  const _isInvV = _isQuitV || _isBreakV || _isSellV;

  let vlabel,vnote;
  if(_isInvV){
    // 反向：高分=現狀好=不建議離開
    if(finalProb>=78){vlabel='現況大吉';vnote='命盤能量強勁，目前位置對你非常有利，貿然離開反而可惜。';}
    else if(finalProb>=65){vlabel='現況偏好';vnote='整體趨勢正面，現狀仍有發展空間，建議先觀察再決定。';}
    else if(finalProb>=52){vlabel='持平觀望';vnote='有利條件與不滿並存，建議冷靜列出利弊再做判斷。';}
    else if(finalProb>=40){vlabel='可以考慮';vnote='現況能量偏弱，如果有更好的選項，可以開始準備。';}
    else if(finalProb>=25){vlabel='適合轉變';vnote='多數指標顯示現狀發展有限，轉換跑道的時機正在形成。';}
    else{vlabel='強烈建議改變';vnote='現況磁場非常不利，繼續留下來的效益極低，是時候做出改變。';}
  } else {
    if(finalProb>=78){vlabel='大吉';vnote='多數指標高度一致看好，是值得把握的時機。';}
    else if(finalProb>=65){vlabel='偏吉';vnote='整體趨勢正面，建議積極行動但保留餘地。';}
    else if(finalProb>=52){vlabel='中性偏好';vnote='有利條件與阻力並存，照建議調整做法可提升勝率。';}
    else if(finalProb>=40){vlabel='中性偏弱';vnote='挑戰多於機會，建議先觀察或小範圍試探。';}
    else if(finalProb>=25){vlabel='偏凶';vnote='阻力訊號較多，目前不是最好的時機，先做準備再行動。';}
    else{vlabel='大凶';vnote='多數指標不利，強烈建議暫緩，等待條件好轉。';}
  }

  // ── 衝突處理：主導系統 vs 校驗系統結論相反時自動補充 ──
  const dimLabelsShort={bazi:'八字',meihua:'梅花',tarot:'塔羅',ziwei:'紫微',natal:'星盤',name:'姓名'};
  if(leadGood && !verifyGood && Math.abs(leadScore-verifyScore)>15){
    vnote+=` （${dimLabelsShort[leadSys]}看好，但${dimLabelsShort[verifySys]}提示需留意風險）`;
  } else if(!leadGood && verifyGood && Math.abs(leadScore-verifyScore)>15){
    vnote+=` （${dimLabelsShort[leadSys]}偏弱，但${dimLabelsShort[verifySys]}顯示有轉機）`;
  }

  document.getElementById('r-vlabel').textContent=vlabel;
  document.getElementById('r-vprob').textContent=finalProb+'%';
  document.getElementById('r-vnote').textContent=vnote;
  document.getElementById('r-pfill').style.width=finalProb+'%';
  // 更新verdict-sources顯示各維度分數
  try{
    const vsEl=document.getElementById('r-verdict-sources');
    if(vsEl){
      const vsData=[
        {icon:'fa-yin-yang',name:'八字',score:baziScore,w:_wNorm.bazi||0},
        {icon:'',name:'梅花',score:mhScore,w:_wNorm.meihua||0,sym:'☰'},
        {icon:'fa-star',name:'塔羅',score:tarotScore,w:_wNorm.tarot||0},
        {icon:'fa-th',name:'紫微',score:ziweiScore,w:_wNorm.ziwei||0},
        {icon:'',name:'星盤',score:natalScore,w:_wNorm.natal||0,sym:'♈'},
        {icon:'',name:'姓名',score:nameScore,w:_wNorm.name||0,sym:'文'}
      ].filter(d=>d.w>0);
      vsEl.innerHTML=vsData.map(d=>{
        const c=d.score>=60?'#4ade80':d.score>=45?'#fbbf24':'#f87171';
        const iconHtml=d.icon?`<i class="fas ${d.icon}"></i>`:`<span style="font-size:.8rem">${d.sym||''}</span>`;
        return `<div class="verdict-source" title="${d.name} ${d.score}分（權重${d.w}%）">${iconHtml}<span style="font-size:.7rem;color:${c};font-weight:700">${d.score}</span><span style="font-size:.6rem">${d.name}</span></div>`;
      }).join('');
    }
  }catch(e){}
  // mini 梅花摘要（verdict下方）→ 人話
  try{
    const miniMhEl=document.getElementById('r-verdict-mini-mh');
    if(miniMhEl && S.meihua){
      const mh=S.meihua;
      const relMap={'用生體':'外力助你','體生用':'付出多回報慢','用克體':'外在有阻力','體克用':'你能掌控但費力','比和':'內外一致穩定'};
      const rel=relMap[mh.ty.r]||mh.ty.r;
      const jMap={'大吉':'大吉','吉':'偏吉','小吉':'小吉','凶':'偏凶','小凶':'小凶'};
      const j=jMap[mh.ty.f]||mh.ty.f;
      miniMhEl.innerHTML=`${mh.ben.u} → ${mh.bian.u}（${rel}·${j}）`;
    }
  }catch(e){}
  const _ch2 = S._usedCache ? '<div class="energy-locked-badge"><i class="fas fa-lock"></i> 此問題能量已鎖定 — 同人同日同一問題，卦象與牌陣維持首次結果（換問題則重新起卦）</div>' : '';
  document.getElementById('r-question').innerHTML=`<strong>問題：</strong>${question}<br><span class="tag tag-gold">${getTypeLabel(type)}</span>${(S.form.btime===''||!document.getElementById('f-btime')?.value)?'<br><span class="text-xs" style="color:var(--c-warn)"><i class="fas fa-exclamation-triangle"></i> 出生時間未填，以 12:00 估算，時柱及部分判定準確度降低</span>':''}${_ch2}`;
  var _heroQ2=document.getElementById('r-question-hero');
  if(_heroQ2) _heroQ2.innerHTML=`<strong>問題：</strong>${question} <span class="tag tag-gold" style="font-size:.75rem">${getTypeLabel(type)}</span>${_ch2}`;

  // ── Answer ──
  const answer=generateAnswer(type,finalProb,b,S.meihua,S.tarot);
  // hook 只用於內部維度辯證，不再顯示在前端（answer.text 已包含完整分析）
  const hook=generateHook(type,finalProb,b,S.meihua,S.tarot,S.ziwei);
  document.getElementById('r-answer').innerHTML=answer.text;
  // 隱藏舊的「完整問答分析」卡（已併入主區）
  var _fullEl2=document.getElementById('r-answer-full');
  if(_fullEl2) _fullEl2.closest('.collapsible-card').style.display='none';
  document.getElementById('r-factors').innerHTML=answer.factors?`<div class="detail-toggle-wrap" style="margin-top:.5rem"><div class="detail-toggle-btn" onclick="this.parentElement.classList.toggle('open')" style="cursor:pointer;display:flex;align-items:center;gap:.5rem;color:var(--c-text-dim);font-size:.85rem;padding:.3rem 0"><i class="fas fa-chevron-right" style="font-size:.7rem;transition:transform .3s"></i><span>影響因子（${answer.factors.length}項）</span></div><div class="detail-toggle-body" style="max-height:0;overflow:hidden;transition:max-height .4s ease"><ul class="text-sm" style="padding:.5rem 1.2rem;color:var(--c-text-dim)">${answer.factors.map(f=>'<li style="margin:.3rem 0">'+f+'</li>').join('')}</ul></div></div>`:'';
  document.getElementById('r-suggest').innerHTML=answer.suggestions?`<h4 class="text-gold serif mt-md mb-sm">行動建議</h4><ol class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.suggestions.map(s=>'<li style="margin:.3rem 0">'+s+'</li>').join('')}</ol>`:'';

  // ── Breakdown ──
  const dimLabels={bazi:'八字命理',meihua:'梅花易數',tarot:'塔羅牌陣',ziwei:'紫微斗數',natal:'西洋星盤',name:'姓名學'};
  const weightHint = (isShortTerm||isDecision)?'⚡ '+(isDecision?'抉擇':'短期')+'問題：'+dimLabelsShort[leadSys]+'/'+dimLabelsShort[verifySys]+'為主' : isLongTerm?'🧭 長期方向：'+dimLabelsShort[leadSys]+'/'+dimLabelsShort[verifySys]+'為主' : '🧠 狀態分析：均衡判斷';
  document.getElementById('r-pbreak').innerHTML=
    `<p class="text-xs text-dim mb-sm">${weightHint}</p>`+
    Object.keys(w).filter(k=>w[k]>0).map(k=>
    `<div class="el-row"><span class="el-lbl text-sm">${dimLabels[k]}</span><div class="el-track"><div class="el-fill" style="width:${scores[k]}%;background:var(--c-gold)"></div></div><span class="el-val">${scores[k]}%<span class="text-xs text-muted"> (${_wNorm[k]}%)</span></span></div>`
  ).join('');

  // ── Crystal ──
  if(typeof renderProductCrystal==='function')renderProductCrystal(b,type);
  else renderCrystalExpanded(b,type);

  // ── Action Card (行動指令 + 嵌入水晶推薦) ──
  try{ renderActionCard(b, type, answer); }catch(e){ console.error('renderActionCard:',e); }

  // ── Remedy Alert + Plan ──
  try{renderRemedy(b,type);}catch(e){console.error('renderRemedy:',e);}

  // ── Conclusion ──
  let concl=generateConclusion(type,finalProb,b,S.meihua,S.tarot);
  // 加入紫微
  if(S.ziwei){
    const mp=S.ziwei.palaces[0];
    const ms=mp.stars.filter(s=>s.type==='major').map(s=>s.name).join('、');
    if(ms)concl+=`<p class="mt-sm">紫微命宮主星：${ms}，${ziweiScore>=60?'命格偏向有利':'需注意相關宮位挑戰'}。</p>`;
  }
  // 加入星盤
  if(S.natal){
    concl+=`<p class="mt-sm">西洋星盤：${S.natal.summary}。`;
    const gA2=S.natal.aspects.filter(a=>a.good).length, bA2=S.natal.aspects.filter(a=>!a.good).length;
    concl+=`吉相位${gA2}個、凶相位${bA2}個，${natalScore>=60?'星盤能量正面':natalScore>=40?'星盤吉凶均衡':'星盤有挑戰需克服'}。</p>`;
  }
  // 加入姓名學
  if(nameResult){
    concl+=`<p class="mt-sm">姓名學（筆劃派）：三才 ${nameResult.sanCai.join('→')}（${nameResult.sanCaiLevel}），人格${nameResult.renGe.num}（${nameResult.renGe.fortune.level}）。</p>`;
  }
  if(S.zodiacNameResult){
    const zn=S.zodiacNameResult;
    concl+=`<p class="mt-sm">姓名學（生肖派）：${zn.emoji}${zn.zodiac}年生人，姓名判定「${zn.overallLevel}」。`;
    if(zn.isSacrifice) concl+=`<span style="color:var(--c-danger)">⚠ 犧牲格：外表風光，內在辛苦。</span>`;
    if(zn.isSnakePigClash) concl+=`<span style="color:var(--c-danger)">⚠ 巳亥六衝：注意小人與意外。</span>`;
    concl+=`</p>`;
  }
  document.getElementById('r-conclusion').innerHTML=concl;

  // ═══ 站長觀點（人格化判斷）═══
  try{
    const expertEl=document.getElementById('r-expert-comment');
    if(expertEl){
      const ec=generateExpertComment(b,S.ziwei,S.meihua,S.tarot,type,finalProb,b.fav||[],unfavEl);
      expertEl.innerHTML=ec;
    }
  }catch(e){console.error('expertComment:',e);}

  // ═══ 第二幕：三張摘要卡片 ═══
  try{ renderAct2Summary(b,S.ziwei,S.meihua,S.tarot,type,finalProb); }catch(e){console.error('act2:',e);}
}

// Override runAnalysis to use V2
function runAnalysis(){
  try{
    // 計數：到達結果頁才算一人
    if(typeof _countVisitor==='function') _countVisitor();
    const rxEl=document.getElementById('rx-date');
    if(rxEl){const d=new Date();rxEl.textContent=d.getFullYear()+'/'+(d.getMonth()+1)+'/'+d.getDate();}
    /* 在 CTA 區塊顯示真實買家評價 */
    try{
      if(typeof REVIEWS!=='undefined'&&REVIEWS.length){
        const r=REVIEWS[Math.floor(Math.random()*REVIEWS.length)];
        const metaEl=document.getElementById('shop-review-meta');
        const textEl=document.getElementById('shop-review-text');
        const prodEl=document.getElementById('shop-review-product');
        if(metaEl)metaEl.textContent=r.name+' · '+r.time;
        if(textEl)textEl.textContent=r.text;
        if(prodEl)prodEl.textContent='購買：'+r.crystal;
      }
    }catch(e){}
    runAnalysisV2();
  }catch(e){
    console.error('runAnalysis error:', e);
    document.getElementById('r-vlabel').textContent='分析出錯: '+e.message;
    document.getElementById('r-vprob').textContent='—';
    alert('分析出錯：' + e.message + '\n' + e.stack);
  }
}


/* ═══════════════════════════════════════════════════
   站長觀點自動生成（基於各維度獨立判斷的辯證觀點）
   ═══════════════════════════════════════════════════ */
function generateExpertComment(bazi,ziwei,mh,tarot,type,prob,fav,unfavEl){
  const dm=bazi.dm,el=bazi.dmEl,strong=bazi.strong;
  const curDy=bazi.dayun?bazi.dayun.find(d=>d.isCurrent):null;
  const typeLabel={'love':'感情','career':'事業','wealth':'財運','health':'健康','general':'整體運勢','relationship':'人際','family':'家庭'}[type]||'這件事';

  // ═══ 直接引用已計算好的維度判斷（不重複計算）═══
  const V=S._verdicts||[];
  const posD=V.filter(v=>v.dir==='pos'), negD=V.filter(v=>v.dir==='neg'), midD=V.filter(v=>v.dir==='mid');
  const overallDir=S._verdictDir||'mid';

  // 紫微主星個性化建議
  let zwStarTip='';
  if(ziwei){
    const mm=ziwei.palaces[0]?ziwei.palaces[0].stars.filter(s=>s.type==='major'):[];
    if(mm.length){
      const sn=mm[0].name;
      const tips={'紫微':'決定了就別回頭','天機':'設個期限逼自己做決定','太陽':'多往外走','武曲':'耐心等時機','天同':'多找人商量','廉貞':'穩住情緒','天府':'按自己步調','太陰':'計畫好就踏出去','貪狼':'專注比才華重要','巨門':'少說多做','天相':'找對的人合作','天梁':'放寬心','七殺':'策略比速度重要','破軍':'確認真的想要再投入'};
      if(tips[sn]) zwStarTip=tips[sn]+'。';
    }
  }

  // ═══ 用人話生成專家評語（完全不出現命理術語）═══
  let opening='', mid='', closing='';

  // 開頭：直接講你的狀態
  if(strong) opening='你的基礎條件不錯，有底氣去拼。';
  else opening='你的先天條件普通，但不代表做不到——只是需要更聰明的策略。';

  // 中段：根據多維度結果用人話辯證
  if(posD.length===V.length && V.length>=2){
    mid='我看了各方面的訊號，結論一致偏好——你的條件、時機、心態都在對的位置。這種情況不常見。';
    closing='但越順越要冷靜。'+typeLabel+'方向是對的，把握窗口期，別因為太樂觀而忽略風險。';
  } else if(negD.length===V.length && V.length>=2){
    mid='說直白一點，各方面的訊號都偏保守——你的條件、時機、外在環境目前都不太配合。現在不是出手的好時候。';
    closing='但這不是永久的。重點是穩住基本盤、充實自己，等條件好轉再動，到時候事半功倍。';
  } else if(posD.length>0 && negD.length>0){
    // ★ 矛盾辯證
    const baziDir=V.find(v=>v.dim==='八字'), mhDir=V.find(v=>v.dim==='梅花'), trDir=V.find(v=>v.dim==='塔羅');
    const baziOk=baziDir&&baziDir.dir==='pos', baziBad=baziDir&&baziDir.dir==='neg';
    const mhOk=mhDir&&mhDir.dir==='pos', mhBad2=mhDir&&mhDir.dir==='neg';
    const trOk=trDir&&trDir.dir==='pos', trBad2=trDir&&trDir.dir==='neg';

    if(baziOk&&mhBad2){
      mid='你的底子不差，但短期的環境不太配合。現在硬推的話阻力會很大。';
      closing='方向不用改，但節奏放慢。等一到兩個月看看有沒有轉機，不急在這一刻。';
    } else if(baziBad&&trOk){
      mid='先天條件有短板，但你當下的心態和行動力是好的。有時候意志力可以彌補不足。';
      closing='靠行動補先天的缺，但要有比別人多付出的準備。找到正確的方法比蠻幹重要。';
    } else if(baziBad&&mhOk){
      mid='你的條件一般，但當下有個短暫的好時機。';
      closing='趁這個窗口快速行動，但不要鋪太大。小範圍試探成功再擴大。';
    } else if(baziOk&&trBad2){
      mid='你的條件其實不差，但心理面有阻礙——可能是猶豫、恐懼、或想太多。問題不在外面，在你自己。';
      closing='下定決心比等待好運更重要。如果理性分析可行，就別讓情緒拖後腿。';
    } else {
      mid='這件事有機會但也有變數，不是一面倒的好或壞。';
      closing='分階段推進，每一步留退路。先小範圍嘗試，有正回饋再加碼。';
    }
  } else if(posD.length>=negD.length){
    mid='整體偏正面，條件和時機都還行。';
    if(type==='love') closing='主動增加社交頻率，機會不會自己來。';
    else if(type==='career') closing='有升遷或轉換的機會別猶豫，猶豫才是最大的損失。';
    else if(type==='wealth') closing='可以小額嘗試，但80%精力放主業。';
    else closing='把握有利條件，同時預留備案。';
  } else {
    mid='阻力偏大，外在環境和條件目前不太支持。';
    const nextDy=bazi.dayun?bazi.dayun.find(d2=>!d2.isCurrent&&d2.ageStart>(curDy?curDy.ageStart:0)):null;
    if(nextDy) closing='但運勢會轉。現階段充實自己、做好準備，等到條件好轉你才接得住。';
    else closing='現階段穩住基本盤，等更好的時機再出手。';
  }

  if(zwStarTip) closing+=' '+zwStarTip;
  
  // 星盤補充
  if(S.natal){
    const natV2=S._verdicts?S._verdicts.find(v=>v.dim==='星盤'):null;
    if(natV2&&natV2.dir==='pos') closing+=` 星盤能量也支持你——把握時機。`;
    else if(natV2&&natV2.dir==='neg') closing+=` 星盤提示有挑戰相位，行動前多想一步。`;
  }

  const ps='<p style="line-height:1.9;font-size:.95rem">';
  return `${ps}${opening}</p>${ps}${mid}</p>${ps}${closing}</p>`;
}

/* ═══════════════════════════════════════════════════
   第二幕：三張摘要卡片（先天命格/當下能量/姓名影響）
   ═══════════════════════════════════════════════════ */
function renderAct2Summary(bazi,ziwei,mh,tarot,type,prob){
  const el=bazi.dmEl,strong=bazi.strong,dm=bazi.dm;
  const curDy=bazi.dayun?bazi.dayun.find(d=>d.isCurrent):null;
  const fav=bazi.fav||[];
  const typeLabel={'love':'感情桃花','career':'事業方向','wealth':'財運投資','health':'健康身心','relationship':'人際合作','family':'家庭親子'}[type]||'整體運勢';

  // ═══════════════════════════════════════════════
  // 步驟一：各維度訊號收集 + 領域權重
  // ═══════════════════════════════════════════════
  
  // 八字：長線命盤訊號
  let baziSignal='mid', baziNote='';
  if(curDy){
    // 計算大運天干與日主生剋
    var _bg=curDy.gz?curDy.gz.charAt(0):'';
    var _bgEl={'甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水'}[_bg]||'';
    var _bKeM={'木':'土','土':'水','水':'火','火':'金','金':'木'};
    var _bShM={'木':'火','火':'土','土':'金','金':'水','水':'木'};
    var _bRel='';
    if(_bgEl===el) _bRel='比肩同氣';
    else if(_bShM[_bgEl]===el) _bRel='生助日主';
    else if(_bKeM[_bgEl]===el) _bRel='剋制日主';
    else if(_bShM[el]===_bgEl) _bRel='日主洩氣';
    else if(_bKeM[el]===_bgEl) _bRel='日主所剋';

    if(/極強|旺盛|上升/.test(curDy.level)){
      baziSignal='pos';
      baziNote=`大運${curDy.gz}（天干${_bg}${_bgEl}行${_bRel?'，'+_bRel:''}），能量${curDy.level}，外在環境支持你。`;
    } else if(/偏弱|低迷|補運/.test(curDy.level)){
      baziSignal='neg';
      baziNote=`大運${curDy.gz}（天干${_bg}${_bgEl}行${_bRel?'，'+_bRel:''}），能量${curDy.level}，外在環境帶壓力。`;
    } else {
      baziNote=`大運${curDy.gz}（天干${_bg}${_bgEl}行${_bRel?'，'+_bRel:''}），能量平穩。`;
    }
    // 生剋關係對typeLabel的具體影響
    if(_bRel==='剋制日主') baziNote+=` ${_bgEl}行剋你的${el}行，在${typeLabel}上面臨外部壓力。`;
    else if(_bRel==='生助日主') baziNote+=` ${_bgEl}行生你的${el}行，在${typeLabel}上有貴人助力。`;
    else if(_bRel==='日主洩氣') baziNote+=` 你的${el}行被${_bgEl}行洩耗，在${typeLabel}上付出多回報慢。`;
    else if(_bRel==='日主所剋') baziNote+=` 你的${el}行剋${_bgEl}行，在${typeLabel}上有掌控力但費精力。`;
    else if(_bRel==='比肩同氣') baziNote+=` 同為${el}行，在${typeLabel}上競爭者多。`;
  }
  // 按領域補充八字細節
  if(type==='love'){
    const g10=bazi.gods;
    const hasCai=g10&&Object.values(g10).some(function(v){return v&&(v.gan==='正財'||v.gan==='偏財');});
    if(strong&&hasCai) baziNote+=' 身強任財，感情基礎紮實。';
    else if(!strong&&hasCai) baziNote+=' 身弱逢財，對感情的渴望容易讓你委屈自己。';
  } else if(type==='wealth'){
    if(strong) baziNote+=' 身強能承擔財運，適合主動出擊。';
    else baziNote+=' 身弱逢財反為壓力，穩中求進為上。';
  }

  // 紫微：結構性訊號
  let zwSignal='mid', zwNote='';
  if(ziwei){
    const tgMap={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
    const tgIdx=tgMap[type]!==undefined?tgMap[type]:0;
    const tgPalace=ziwei.palaces[tgIdx];
    const tgName=typeof ZW_PALACES!=='undefined'?ZW_PALACES[tgIdx]:'命宮';
    if(tgPalace){
      const majors=tgPalace.stars.filter(function(s){return s.type==='major';});
      const hasLu=tgPalace.stars.some(function(s){return s.hua==='化祿';});
      const hasJi=tgPalace.stars.some(function(s){return s.hua==='化忌';});
      const hasSha=tgPalace.stars.some(function(s){return s.type==='sha';});
      if(hasLu){zwSignal='pos';zwNote=`${tgName}有化祿入宮，${typeLabel}先天有福氣加持。`;}
      else if(hasJi){zwSignal='neg';zwNote=`${tgName}化忌入宮，${typeLabel}有需要突破的深層執念。`;}
      else if(hasSha){zwSignal='neg';zwNote=`${tgName}有煞星干擾，${typeLabel}推進時容易遇到外部阻力。`;}
      else if(majors.length){zwSignal='pos';zwNote=`${tgName}有${majors.map(function(s){return s.name;}).join('、')}坐守，結構完整。`;}
      else{zwNote=`${tgName}無主星，需借對宮力量。`;}
    }
  }

  // 梅花：短期動能
  let mhSignal='mid', mhNote='';
  if(mh){
    if(mh.ty.f.includes('大吉')||mh.ty.r==='用生體'){mhSignal='pos';mhNote=`梅花「${mh.ty.r}」（${mh.ty.f}），外在資源會主動找上門。`;}
    else if(mh.ty.f.includes('凶')||mh.ty.r==='用克體'){mhSignal='neg';mhNote=`梅花「${mh.ty.r}」（${mh.ty.f}），你正面臨外部壓力的擠壓。`;}
    else if(mh.ty.r==='體生用'){mhSignal='neg';mhNote=`梅花「體生用」，你的付出比回報多，能量持續外流。`;}
    else{mhNote=`梅花「${mh.ty.r}」，短期能量中性。`;}
  }

  // 塔羅：即時心理+走向
  let tarotSignal='mid', tarotNote='';
  if(tarot.drawn&&tarot.drawn.length>=10){
    const _out=tarot.drawn[9],_chal=tarot.drawn[1],_near=tarot.drawn[5],_self=tarot.drawn[6];
    if(_out.isUp&&_near.isUp){tarotSignal='pos';tarotNote='結果位正位，近期走勢順暢。';}
    else if(!_out.isUp){tarotSignal='neg';tarotNote='結果位逆位——若不調整策略，結果不如預期。';}
    else{tarotNote='走勢中性，需要更多主動作為。';}
    // 阻礙因素（牌2）
    var chalMeaning=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(_chal.id,_chal.isUp,type):null;
    if(!chalMeaning) chalMeaning=_chal.isUp?_chal.up:_chal.rv;
    tarotNote+=` 主要阻礙：${_chal.n}（${(chalMeaning||'').slice(0,25)}…）`;
  }

  // 星盤：潛意識/盲點
  let natalSignal='mid', natalNote='';
  if(S.natal){
    const np=S.natal.planets;
    const goodA=S.natal.aspects.filter(function(a){return a.good;}).length;
    const badA=S.natal.aspects.filter(function(a){return !a.good;}).length;
    natalSignal=goodA>badA?'pos':badA>goodA?'neg':'mid';
    if(type==='love'){
      var venH=np['金星'].house;
      natalNote=`金星${np['金星'].sign}在第${venH}宮${[5,7].includes(venH)?'（利桃花）':venH===12?'（感情隱密）':''}，月亮${np['月亮'].sign}主導情緒需求。`;
      // 內外反差偵測
      if(S.natal.ascSign){
        var ascEl=S.natal.ascSign.el, moonEl=np['月亮'].el;
        if(ascEl&&moonEl&&ascEl!==moonEl) natalNote+=` 上升(${S.natal.ascSign.name})與月亮(${np['月亮'].sign})不同元素——你外在展現的與內在需要的不一樣。`;
      }
    } else if(type==='career'){
      natalNote=`天頂${S.natal.mcSign.name}座，職業天賦偏${S.natal.mcSign.name}特質。`;
      if(np['土星']) natalNote+=` 土星在第${np['土星'].house}宮帶來${np['土星'].house===10?'事業壓力但也是專業深度的來源':'結構性挑戰'}。`;
    } else if(type==='wealth'){
      var jupH=np['木星'].house;
      natalNote=`木星${np['木星'].sign}在第${jupH}宮${[2,8,11].includes(jupH)?'，偏財天賦不錯':''}。`;
    } else if(type==='health'){
      natalNote=`第6宮（健康）與第12宮（隱性消耗）的行星配置決定身心弱點。`;
    } else {
      natalNote=`太陽${np['太陽'].sign}・月亮${np['月亮'].sign}・上升${S.natal.ascSign.name}。`;
    }
  }

  // 姓名：補綴機制
  let nameSignal='mid', nameNote='';
  if(S.zodiacNameResult){
    var zn=S.zodiacNameResult;
    nameNote=`${zn.emoji}${zn.zodiac}年生人「${zn.name}」→【${zn.overallLevel}】`;
    if(zn.baziOverride) nameNote+=`（八字覆寫：字根五行補足命盤用神）`;
    if(zn.overallLevel.includes('吉')) nameSignal='pos';
    else if(zn.overallLevel.includes('凶')) nameSignal='neg';
  }
  if(S.nameResult){
    var nr=S.nameResult;
    nameNote+=`，三才${nr.sanCai.join('→')}（${nr.sanCaiLevel}）`;
    // 八字喜忌檢驗
    var scEl=nr.sanCai;
    if(scEl&&fav.length){
      var favInSC=scEl.filter(function(e){return fav.includes(e);});
      if(favInSC.length>=2){nameSignal='pos';nameNote+=`。三才含喜用神(${favInSC.join(',')})，姓名精準補足命盤。`;}
    }
  }

  // ═══════════════════════════════════════════════
  // 步驟二：衝突仲裁（Conflict Resolution）
  // ═══════════════════════════════════════════════
  var longTerm=(baziSignal==='pos'&&zwSignal!=='neg')?'pos':(baziSignal==='neg'||zwSignal==='neg')?'neg':'mid';
  var shortTerm=(mhSignal==='pos'||tarotSignal==='pos')?'pos':(mhSignal==='neg'&&tarotSignal==='neg')?'neg':'mid';
  
  // 核心能量定錨
  var anchor='';
  if(longTerm==='pos'&&shortTerm==='neg'){
    // 長線吉+短線凶
    anchor=`你的${typeLabel}本命底蘊與大環境趨勢是支持你的，但目前在具體執行上出現了盲點。這是一個「被短線情緒或戰術錯誤拖累的好局」。只要修正短期的阻礙因素，就能回到正軌。`;
  } else if(longTerm==='neg'&&shortTerm==='pos'){
    // 長線凶+短線吉
    anchor=`從長遠結構來看，${typeLabel}存在根深蒂固的阻礙，不宜進行長期或大規模投入。但近期能量場為你開了一扇窗——這是一個讓你喘息或小幅推進的機會，見好就收是最高指導原則。`;
  } else if(longTerm==='pos'&&shortTerm==='pos'){
    anchor=`${typeLabel}的長短線訊號一致正面。本命底蘊紮實，短期能量也在配合，這是一個難得的「天時地利」窗口，適合大膽行動。`;
  } else if(longTerm==='neg'&&shortTerm==='neg'){
    anchor=`${typeLabel}的長短線訊號都帶壓力，目前不是衝鋒的時機。重心應放在自我修復和策略調整上，等待下一個轉折點。`;
  } else {
    anchor=`${typeLabel}的訊號混合：有空間但也有障礙。不是完全沒機會，分步推進、保持彈性是關鍵。`;
  }

  // ═══ 吉卦凶局條件式揉合 ═══
  // 當整體能量偏低（<50%）但梅花或塔羅出現吉兆時，
  // 嚴禁將吉兆指鹿為馬解釋為凶，必須用「受限於環境」邏輯解讀
  if(prob<50 && (mhSignal==='pos'||tarotSignal==='pos')){
    var _goodDim=[];
    if(mhSignal==='pos') _goodDim.push('梅花卦象（'+mhNote.substring(0,20)+'…）');
    if(tarotSignal==='pos') _goodDim.push('塔羅結果位正位');
    anchor+=` 值得留意的是，${_goodDim.join('與')}顯示你的方向本身是正確的、具備成長潛力，但目前整體能量場偏弱（${prob}%），就像一棵好苗長在貧瘠的土壤中——核心不是放棄，而是「控制生長速度」。先用最小成本驗證可行性，等環境配合時再全力推進。`;
  }
  // 反向：高能量但梅花/塔羅凶 → 也做特別提示
  if(prob>=65 && mhSignal==='neg' && tarotSignal==='neg'){
    anchor+=` 不過，梅花與塔羅同時發出短期警訊，代表近期有隱藏的阻礙因子。大方向沒問題，但執行時留意細節與人際摩擦。`;
  }

  // 潛意識反差偵測
  var subconNote='';
  if(S.natal&&ziwei){
    var mingStars=ziwei.palaces[0]?ziwei.palaces[0].stars.filter(function(s){return s.type==='major';}):[];
    var moonSign=S.natal.planets['月亮'].sign;
    // 七殺/破軍+月亮水象 = 內外反差
    if(mingStars.some(function(s){return ['七殺','破軍','廉貞'].includes(s.name);})&&['雙魚','巨蟹','天蠍'].includes(moonSign)){
      subconNote=`你在外界展現出強勢與獨立（${mingStars.map(function(s){return s.name;}).join('+')}坐命），這其實是為了保護內在極度需要情緒共鳴的靈魂（月亮${moonSign}）。這種內外反差是你在${typeLabel}領域感到疲憊的暗中根源。`;
    }
  }

  // 姓名補綴
  var namePatch='';
  if(nameSignal==='pos'&&(longTerm==='neg'||shortTerm==='neg')){
    namePatch=`不過，你的姓名能量恰好補足了命盤最缺乏的元素，這將成為你逆轉局勢的暗流力量。`;
  } else if(nameSignal==='neg'&&longTerm==='pos'){
    namePatch=`需留意的是，姓名能量與命盤有輕微衝突，日常中可透過對應五行佩飾做微調。`;
  }

  // ═══════════════════════════════════════════════
  // 步驟三：渲染三段式輸出
  // ═══════════════════════════════════════════════
  
  // 卡片1：核心能量定錨
  var card1=`<p style="font-size:.95rem;line-height:1.8">${anchor}</p>`;
  if(subconNote) card1+=`<p class="mt-sm" style="font-size:.88rem;line-height:1.7;color:var(--c-text-dim);padding:.5rem;background:rgba(124,108,205,.06);border-radius:6px">🔮 ${subconNote}</p>`;

  // 卡片2：六維度深度拆解（因果敘事）
  var card2='<div style="font-size:.88rem;line-height:1.8">';
  // 用因果邏輯串聯，不要條列
  card2+=`<p>從八字命盤來看，${baziNote||'運勢中性。'} `;
  if(zwNote) card2+=`紫微層面，${zwNote} `;
  card2+=`</p>`;
  card2+=`<p class="mt-sm">而在當下的能量場中，${mhNote||''} ${tarotNote||''}</p>`;
  if(natalNote) card2+=`<p class="mt-sm">西洋星盤揭示了你的潛意識層：${natalNote}</p>`;
  if(nameNote) card2+=`<p class="mt-sm">姓名層面：${nameNote}。${namePatch}</p>`;
  card2+='</div>';

  // 卡片3：戰略行動指南
  var card3='<div style="font-size:.88rem;line-height:1.8">';
  if(longTerm==='pos'&&shortTerm==='neg'){
    card3+=`<p>📌 <strong>心態</strong>：方向是對的，不要因短期挫折自我懷疑。</p>`;
    card3+=`<p>📌 <strong>時機</strong>：解決當前阻礙後再全力出手。${mhSignal==='neg'?'梅花卦象顯示能量外流中，先止血再衝刺。':''}</p>`;
  } else if(longTerm==='neg'&&shortTerm==='pos'){
    card3+=`<p>📌 <strong>心態</strong>：把握窗口但不要押全部，見好就收。</p>`;
    card3+=`<p>📌 <strong>時機</strong>：近期1-3個月內是最佳行動期，過了這窗口就要重新評估。</p>`;
  } else if(longTerm==='pos'&&shortTerm==='pos'){
    card3+=`<p>📌 <strong>心態</strong>：全力以赴，這是少有的天時地利窗口。</p>`;
    card3+=`<p>📌 <strong>時機</strong>：現在就是最好的時候，不要再猶豫。</p>`;
  } else {
    card3+=`<p>📌 <strong>心態</strong>：韜光養晦、練內功的時期。不是放棄，是在為下一次機會做準備。</p>`;
    card3+=`<p>📌 <strong>時機</strong>：等待大運或流年轉換，${curDy?'下步大運將帶來新的能量格局':'耐心等待時機轉換'}。</p>`;
  }
  card3+=`<p>📌 <strong>能量調校</strong>：佩戴${fav[0]||'土'}行水晶，日常強化${fav.join('、')}行能量，補足命盤短板。</p>`;
  card3+='</div>';

  // 渲染到頁面
  var wrapEl=document.getElementById('act2-cards');
  if(wrapEl){
    wrapEl.innerHTML=`
    <div class="card act2-card" style="border-left:3px solid var(--c-gold)">
      <div class="card-title" style="font-size:.95rem"><i class="fas fa-crosshairs"></i> 核心能量定錨</div>
      <div class="text-sm" style="line-height:1.8">${card1}</div>
    </div>
    <div class="card act2-card" style="border-left:3px solid #7C6CCD">
      <div class="card-title" style="font-size:.95rem"><i class="fas fa-layer-group"></i> 六維度深度拆解</div>
      ${card2}
    </div>
    <div class="card act2-card" style="border-left:3px solid #4ade80">
      <div class="card-title" style="font-size:.95rem"><i class="fas fa-chess"></i> 戰略行動指南</div>
      ${card3}
    </div>`;
  }
}

function renderName(){
  const el=document.getElementById('d-name');
  if(!S.form.name||S.form.name.length<2){el.innerHTML='<p class="text-dim">未輸入姓名，無法進行姓名學分析。</p>';return}

  let html = '';

  // ══════ A. 生肖姓名學（形義派） ══════
  const [y] = S.form.bdate.split('-').map(Number);
  const zr = analyzeZodiacName(S.form.name, y);
  if(zr){
    S.zodiacNameResult = zr; // 存入全域供評分使用
    const levelCls = zr.overallLevel.includes('吉') ? 'text-success' : zr.overallLevel.includes('凶') || zr.overallLevel.includes('犧牲') ? 'text-danger' : 'text-dim';

    html += `<div class="card" style="margin-bottom:var(--sp-md);padding:var(--sp-md);border-color:rgba(212,175,55,0.3)">
      <h4 class="text-gold mb-sm serif" style="font-size:1.05rem">${zr.emoji} 生肖姓名學（形義派）</h4>
      <p class="mb-sm">生肖：<strong class="text-gold serif" style="font-size:1.1rem">${zr.emoji} ${zr.zodiac}</strong>（${zr.dizhi}）｜ 姓名：<strong class="text-gold serif">${zr.name}</strong></p>
      <p class="mb-md text-sm text-dim">「字如環境，生肖如生物」— 名字提供的環境是否適合${zr.zodiac}生存？</p>
      <p class="mb-md"><strong>總判：</strong><span class="tag ${zr.overallLevel.includes('吉')?'tag-green':zr.overallLevel.includes('凶')||zr.overallLevel.includes('犧牲')?'tag-red':'tag-gold'}" style="font-size:0.95rem;padding:.4rem .8rem">${zr.overallLevel}</span></p>`;

    // 逐字分析
    zr.positions.forEach(pos => {
      html += `<div style="border-left:3px solid var(--c-gold);padding-left:var(--sp-md);margin:var(--sp-md) 0">
        <p style="font-size:0.85rem;color:var(--c-gold);font-weight:600">${pos.label}：${pos.char}（${pos.lifeStage}）</p>`;

      pos.charResults.forEach(cr => {
        // 字根拆解（陽邊/陰邊）— 永遠顯示，絕不說「未收錄」
        const d = cr.decomp || {};
        const structLabel = d.struct || '推測';
        const yangText = d.yang || cr.roots[0] || cr.char;
        const yinText = d.yin || (cr.roots.length>1 ? cr.roots.slice(1).join('+') : '—');
        
        html += `<div style="margin:.4rem 0;padding:.4rem .6rem;background:rgba(255,255,255,0.03);border-radius:6px">`;
        html += `<p style="font-size:0.85rem;margin-bottom:.3rem"><strong style="color:var(--c-gold)">「${cr.char}」</strong>
          <span class="text-dim text-xs">（${structLabel}結構）</span></p>`;
        html += `<p style="font-size:0.82rem;color:var(--c-text-dim);margin:.1rem 0">
          　陽邊（左/上）：<strong>${yangText}</strong>
          ｜陰邊（右/下）：<strong>${yinText}</strong></p>`;
        html += `<p style="font-size:0.8rem;color:var(--c-text-dim);margin:.1rem 0">
          　拆出字根：${cr.roots.join('、')}</p>`;
        
        if(cr.hits.length === 0){
          html += `<p class="text-dim text-sm" style="margin:.2rem 0">　→ 以上字根對${zr.zodiac}屬<strong>中性</strong>，不加分也不扣分。</p>`;
        } else {
          cr.hits.forEach(h => {
            const icon = h.type==='吉' ? '✅' : '❌';
            const cls = h.type==='吉' ? 'color:#4ade80' : 'color:#f87171';
            html += `<p style="margin:.2rem 0;font-size:0.88rem">　<span style="${cls};font-weight:700">${icon} ${h.type}【${h.label}】</span> <span class="text-dim">含${h.matchedRoots.join('/')} → ${h.reason}</span></p>`;
          });
        }
        html += `</div>`;
      });
      html += `</div>`;
    });

    // 犧牲格 / 蛇豬衝 特殊警告
    if(zr.isSacrifice){
      html += `<div style="background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3);border-radius:var(--r-md);padding:var(--sp-md);margin:var(--sp-md) 0">
        <p style="color:#f87171;font-weight:700">⚠ 犧牲格警告</p>
        <p class="text-sm" style="margin-top:.3rem">${zr.sacrificeNote}</p></div>`;
    }
    if(zr.isSnakePigClash){
      html += `<div style="background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3);border-radius:var(--r-md);padding:var(--sp-md);margin:var(--sp-md) 0">
        <p style="color:#f87171;font-weight:700">⚠ 巳亥六衝</p>
        <p class="text-sm" style="margin-top:.3rem">${zr.clashNote}</p></div>`;
    }

    // 警示語
    if(zr.warnings.length){
      html += `<div style="margin-top:var(--sp-md)"><p class="text-warn" style="font-weight:600;font-size:0.9rem">🔔 生活禁忌提醒：</p>
        <ul style="padding-left:1.2rem;margin-top:.3rem">${zr.warnings.map(w=>`<li class="text-sm" style="margin:.2rem 0;color:var(--c-text-dim)">${w}</li>`).join('')}</ul></div>`;
    }
    
    // ★ 八字覆寫通知
    if(zr.baziOverride && zr.baziOverrideNote){
      html += `<div style="margin-top:var(--sp-md);padding:.7rem .9rem;background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.3);border-radius:var(--r-md)">
        <p style="color:#4ade80;font-weight:700;font-size:0.9rem">🔄 八字命盤覆寫</p>
        <p class="text-sm" style="margin-top:.3rem;line-height:1.7;color:var(--c-text)">${zr.baziOverrideNote}</p></div>`;
    }

    html += `<p class="text-xs text-muted mt-md" style="line-height:1.6"><i class="fas fa-exclamation-circle"></i> ⚠️ 本分析基於「生肖形義派」之單一學理運算。姓名學流派眾多（筆劃派、八字派等），常有互斥結論。本結果僅供能量參考，不建議作為改名、投資等重大決策的唯一依據。</p>`;
    html += `</div>`;
  }

  // ══════ B. 三才五格（原系統） ══════
  const r=analyzeName(S.form.name);
  if(r){
    S.nameResult = r; // 確保全域可用
    const geData=[
      {label:'天格',data:r.tianGe,desc:'先天運，姓氏決定'},
      {label:'人格',data:r.renGe,desc:'主運，影響中年'},
      {label:'地格',data:r.diGe,desc:'前運，影響青年'},
      {label:'外格',data:r.waiGe,desc:'副運，人際關係'},
      {label:'總格',data:r.zongGe,desc:'後運，影響晚年'}
    ];

    html+=`<div class="card" style="margin-bottom:0;padding:var(--sp-md);opacity:0.85">
      <h4 class="text-gold mb-sm serif" style="font-size:1.05rem">📊 三才五格（筆劃派）</h4>
      <p class="mb-md">姓名：<strong class="text-gold serif">${r.name}</strong> ｜ 筆畫：${r.strokes.join('、')}</p>
      <div class="bazi-grid" style="grid-template-columns:repeat(5,1fr);margin:var(--sp-md) 0">
        ${geData.map(g=>`<div class="bazi-cell header">${g.label}</div>`).join('')}
        ${geData.map(g=>`<div class="bazi-cell">
          <span class="gz">${g.data.num}</span>
          <span class="el-tag el-${g.data.el}">${g.data.el}</span>
          <div class="gz-sub ${g.data.fortune.cls}">${g.data.fortune.level}</div>
        </div>`).join('')}
        ${geData.map(g=>`<div class="bazi-cell"><div class="gz-sub">${g.desc}</div></div>`).join('')}
      </div>
      <div class="mt-md">
        <p><strong>三才配置：</strong>${r.sanCai.join(' → ')} <span class="tag ${r.sanCaiLevel.includes('吉')?'tag-green':r.sanCaiLevel==='凶'?'tag-red':'tag-gold'}">${r.sanCaiLevel}</span></p>
        <p class="text-sm text-dim mt-sm">三才代表天格→人格→地格的五行流通關係，${r.sanCaiLevel.includes('吉')?'相生相助為佳象':'存在相剋，需注意健康與人際'}。</p>`;
    // ★ 八字喜忌交叉驗證
    if(S.bazi && S.bazi.fav && S.bazi.fav.length && r.sanCai){
      const fav=S.bazi.fav, unfav=S.bazi.unfav||[];
      const scEls=r.sanCai; // 三才五行陣列
      const hasFav=scEls.some(e=>fav.includes(e));
      const hasUnfav=scEls.some(e=>unfav.includes(e));
      const renGeEl=scEls[1]; // 人格五行=自己
      let crossHtml='<div style="margin-top:.5rem;padding:.5rem .8rem;background:rgba(212,175,55,.06);border-radius:6px;border-left:3px solid rgba(212,175,55,.3);font-size:.85rem">';
      crossHtml+=`<p style="font-weight:600;color:var(--c-gold)">📊 八字喜忌交叉驗證</p>`;
      crossHtml+=`<p class="text-sm text-dim" style="margin-top:.3rem">八字喜用：${fav.join('、')} ｜ 忌神：${unfav.join('、')}</p>`;
      if(hasFav && !hasUnfav){
        crossHtml+=`<p class="text-sm" style="color:#4ade80;margin-top:.3rem">✅ 三才含喜用神（${scEls.filter(e=>fav.includes(e)).join('、')}），姓名能量與命盤相輔，有助運勢提升。</p>`;
      } else if(hasUnfav && !hasFav){
        crossHtml+=`<p class="text-sm" style="color:#f87171;margin-top:.3rem">⚠ 三才含忌神（${scEls.filter(e=>unfav.includes(e)).join('、')}），姓名能量與命盤有衝突，可能削弱運勢。</p>`;
      } else if(hasFav && hasUnfav){
        crossHtml+=`<p class="text-sm" style="color:#fbbf24;margin-top:.3rem">⚡ 三才同時含喜用（${scEls.filter(e=>fav.includes(e)).join('、')}）和忌神（${scEls.filter(e=>unfav.includes(e)).join('、')}），能量拉扯，效果中和。</p>`;
      } else {
        crossHtml+=`<p class="text-sm text-dim" style="margin-top:.3rem">三才五行與八字喜忌無直接交集，影響中性。</p>`;
      }
      // 人格五行與喜忌
      if(renGeEl){
        if(fav.includes(renGeEl)){
          crossHtml+=`<p class="text-sm" style="color:#4ade80;margin-top:.2rem">人格（${renGeEl}行）正好是喜用神，核心運勢受到姓名助力。</p>`;
        } else if(unfav.includes(renGeEl)){
          crossHtml+=`<p class="text-sm" style="color:#f87171;margin-top:.2rem">人格（${renGeEl}行）恰好是忌神，核心運勢被姓名能量壓制。</p>`;
        }
      }
      crossHtml+='</div>';
      html+=crossHtml;
    }
    html+=`</div>
    </div>`;
  } else {
    html+=`<p class="text-dim">姓名格式不支援（需2-4個字）。</p>`;
  }

  // ★ 兩派整合分析（生肖派 vs 三才五格）
  if(S.zodiacNameResult && r){
    const zr2=S.zodiacNameResult;
    const zodiacLevel=zr2.overallLevel;
    const sanCaiLevel=r.sanCaiLevel;
    const isZodiacBad=zodiacLevel.includes('凶')||zodiacLevel.includes('犧牲');
    const isZodiacGood=zodiacLevel.includes('吉')||zodiacLevel.includes('旺');
    const isSanCaiGood=sanCaiLevel.includes('吉');
    const isSanCaiBad=sanCaiLevel==='凶';
    
    if((isZodiacBad && isSanCaiGood) || (isZodiacGood && isSanCaiBad)){
      html+=`<div style="margin-top:var(--sp-md);padding:.7rem .9rem;background:rgba(212,175,55,.06);border:1px solid rgba(212,175,55,.2);border-radius:8px">
        <p style="font-weight:700;color:var(--c-gold);font-size:.95rem">⚖️ 兩派結論整合</p>
        <p class="text-sm text-dim" style="margin-top:.4rem;line-height:1.7">`;
      if(isZodiacBad && isSanCaiGood){
        html+=`生肖派判定「${zodiacLevel}」，但三才五格判定「${sanCaiLevel}」。兩套系統的評判角度不同：<br>`;
        html+=`• <strong>生肖派</strong>看「字根與生肖的環境適配」，屬形象式判斷<br>`;
        html+=`• <strong>三才五格</strong>看「筆劃數理的五行流通」，屬數學式判斷<br>`;
        html+=`此名在數理能量上有強大的數字格局支撐（${r.geData?r.geData.filter(g=>g.data.fortune.level.includes('吉')).map(g=>g.label+g.data.fortune.level).join('、'):''}），不宜因字根沖剋就全盤否定。`;
        if(S.bazi && S.bazi.fav){
          const scMatch=r.sanCai?r.sanCai.some(e=>S.bazi.fav.includes(e)):false;
          if(scMatch) html+=`<br>加上三才含八字喜用神，整體姓名能量偏正面。`;
        }
      } else {
        html+=`生肖派判定「${zodiacLevel}」，但三才五格判定「${sanCaiLevel}」。<br>`;
        html+=`此名雖然字根環境對生肖友好，但數理配置存在不利。建議綜合考量，不需過度焦慮。`;
      }
      html+=`</p></div>`;
    }
  }

  el.innerHTML = html;

if(PLAIN_MODE){ const el=document.getElementById('r-name'); if(el) el.innerHTML = wrapPlain(el.innerHTML,'姓名｜白話重點'); }
}
/* =============================================================
   ENHANCEMENT 1: 流年詳細展開（點擊大運展開10流年）
   ============================================================= */
function renderDayunEnhanced(){
  const b=S.bazi; if(!b)return;
  let html='<div class="dayun-tl">';
  b.dayun.forEach((d,i)=>{
    const s2=d.score||0;
    const lvCls=s2>=6?'lv-dj':s2>=3?'lv-zj':s2>=1?'lv-xj':s2>=-1?'lv-p':s2>=-3?'lv-xk':s2>=-6?'lv-zk':'lv-dk';
    const gzClr=s2>=6?'#4ade80':s2>=3?'#60a5fa':s2>=1?'var(--c-gold,#d4af37)':s2>=-1?'var(--c-text,#e8d5b5)':s2>=-3?'#fbbf24':s2>=-6?'#f87171':'#ef4444';
    html+=`<div class="dy-item dy-${lvCls} ${d.isCurrent?'current':''}" onclick="toggleLiuNian(${i})" title="點擊展開流年">
      <span class="dy-gz" style="color:${gzClr}">${d.gz}</span><span class="dy-age">${d.ageStart}-${d.ageEnd}歲</span>
      <span class="dy-lv ${lvCls}">${d.level}</span><div class="gz-sub">${d.god}</div></div>`;
  });
  html+='</div>';
  html+='<div id="liunian-detail" class="mt-md hidden"></div>';
  document.getElementById('d-dayun').innerHTML=html;
}

function toggleLiuNian(dyIdx){
  const el=document.getElementById('liunian-detail');
  const b=S.bazi; if(!b||!b.dayun[dyIdx])return;
  const dy=b.dayun[dyIdx];
  if(el.dataset.openIdx===String(dyIdx)&&!el.classList.contains('hidden')){
    el.classList.add('hidden');return;
  }
  el.dataset.openIdx=dyIdx;
  el.classList.remove('hidden');
  const curYear=new Date().getFullYear();
  let html=`<div class="card" style="padding:var(--sp-md);margin:0"><div class="card-title text-sm"><i class="fas fa-calendar"></i> ${dy.gz}大運（${dy.ageStart}-${dy.ageEnd}歲）流年明細</div>`;
  // 紫微大限同期資訊（加入歲數落差提示）
  if(S.ziwei&&S.ziwei.daXian){
    const matchDx=S.ziwei.daXian.find(dx=>dx.ageStart===dy.ageStart||(dy.ageStart>=dx.ageStart&&dy.ageStart<=dx.ageEnd));
    if(matchDx){
      html+=`<p style="font-size:.78rem;color:var(--c-gold);margin-bottom:4px">紫微大限同期：走「${matchDx.palaceName}」宮（${matchDx.level}）`;
      if(matchDx.stars.length) html+=`，主星${matchDx.stars.join('、')}`;
      if(matchDx.hua.length) html+=`。四化：${matchDx.hua.map(h=>h.star+h.hua+'入'+h.palace).join('、')}`;
      html+='</p>';
      // 歲數落差提示
      if(matchDx.ageStart!==dy.ageStart){
        html+=`<p style="font-size:.65rem;color:var(--c-text-dim);margin-bottom:8px;opacity:.7">📌 紫微大限（${matchDx.ageStart}-${matchDx.ageEnd}歲）與八字大運交接期有${Math.abs(dy.ageStart-matchDx.ageStart)}年落差，此處取能量交集區間。</p>`;
      }
    }
  }

  // ═══ 十神戰略轉譯字典 ═══
  const _GOD_STRAT={
    '正官':{theme:'體制適應與建立個人SOP',risk:'框架壓力偏大',action:'善用體制為自己背書，合約行政要細心',elRx:'土/金'},
    '七殺':{theme:'高壓壓力測試',risk:'突發狀況與激烈競爭',action:'直球對決，主動承擔可將殺氣轉為權力。注意情緒與過勞',elRx:'金/水'},
    '正印':{theme:'向內求取、能量蓄積',risk:'想太多而錯失良機',action:'適合進修考照，設定明確決策停損點',elRx:'水/木'},
    '偏印':{theme:'直覺敏銳的非典型期',risk:'過度猜忌導致人際疏離',action:'信第六感，適合企劃研發，但要保持社交',elRx:'水/木'},
    '比肩':{theme:'尋找同溫層與合作夥伴',risk:'過度堅持己見引摩擦',action:'尋求資源互補的合作模式，避免單打獨鬥',elRx:'木/火'},
    '劫財':{theme:'資源重新分配的震盪期',risk:'突發支出或強大競爭對手',action:'主動投資自己（學習/工具），禁止高槓桿投機',elRx:'土/金'},
    '食神':{theme:'才華洋溢的平穩輸出期',risk:'缺乏企圖心流於安逸',action:'順勢做內容創作或產品開發，保持動力',elRx:'木/火'},
    '傷官':{theme:'高耗能的自我突破期',risk:'心直口快引發口舌是非',action:'將銳利能量投入創新改革，三思而後言',elRx:'水/土'},
    '正財':{theme:'穩健收成的務實期',risk:'患得患失的微觀管理',action:'專注本業與記帳理財，優化商業模式',elRx:'木/火'},
    '偏財':{theme:'高槓桿的資源流通期',risk:'財來得快去得也快',action:'資源整合與業務開發，嚴設資金停損點',elRx:'火/土'},
    '劫財/羊刃':{theme:'資源重新分配的震盪期',risk:'突發支出或強大競爭對手',action:'主動投資自己，禁止高槓桿投機',elRx:'土/金'}
  };

  html+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:4px">';
  dy.liuNian.forEach(ln=>{
    const isCur=ln.year===curYear;
    const ls=ln.score||0;
    const isGood=ls>=1;
    const isBad=ls<=-1;
    const borderClr=isGood?'#4ade80':isBad?'#f87171':'var(--c-border)';
    const bgClr=isGood?'rgba(74,222,128,.06)':isBad?'rgba(248,113,113,.06)':'var(--c-bg-card)';
    const lvColor=isGood?'#4ade80':isBad?'#f87171':'#999';
    // 紫微流年
    let zwLnTip='';
    if(S.ziwei&&S.ziwei.getLiuNianZw){
      try{const zwLn=S.ziwei.getLiuNianZw(ln.year);if(zwLn&&zwLn.mingPalace)zwLnTip=zwLn.mingPalace;}catch(e){}
    }
    html+=`<div style="padding:6px;border:1.5px solid ${isCur?'var(--c-gold)':borderClr};border-radius:var(--r-sm);background:${isCur?'rgba(212,175,55,.08)':bgClr};font-size:.8rem;text-align:center">
      <strong>${ln.year}</strong><br>
      <span class="serif">${ln.gz}</span><br>
      <span class="el-tag el-${ln.el}">${ln.el}</span>
      <span style="font-size:.6rem;font-weight:600;color:${lvColor}">${ln.level}</span><br>
      <span class="text-xs text-muted">${ln.god}</span>
      ${zwLnTip?'<br><span style="font-size:.6rem;color:var(--c-dim)">紫微:'+zwLnTip+'</span>':''}
      ${isCur?'<br><span class="text-xs text-gold">← 今年</span>':''}
    </div>`;
  });
  html+='</div>';

  // ═══ 流年戰略轉譯面板（每年一段，展開式）═══
  html+='<details style="margin-top:8px"><summary style="cursor:pointer;font-size:.82rem;color:var(--c-gold);font-weight:600">♟ 流年戰略解析（點擊展開）</summary><div style="padding:8px 0">';

  // 取紫微大限四化忌
  let _dxJi='';
  if(S.ziwei&&S.ziwei.daXian){
    const _mdx=S.ziwei.daXian.find(dx=>dy.ageStart>=dx.ageStart&&dy.ageStart<=dx.ageEnd);
    if(_mdx&&_mdx.hua){
      const jiH=_mdx.hua.find(h=>h.hua==='化忌');
      if(jiH) _dxJi=jiH.star+'化忌入'+jiH.palace;
    }
  }
  const _favEl=S.bazi&&S.bazi.fav?S.bazi.fav[0]:'木';
  const _elCrystal={'木':'綠幽靈、綠碧璽','火':'紫水晶、紅瑪瑙','土':'黃水晶、茶晶','金':'白水晶、鈦晶','水':'海藍寶、黑曜石'};

  dy.liuNian.forEach(ln=>{
    const god=ln.god||'';
    // 如果找不到精確 key，嘗試回退到相關十神
    const _godFallback={'劫財/羊刃':'劫財','比劫':'比肩','偏官':'七殺','枭神':'偏印','梟神':'偏印','枭':'偏印','梟':'偏印'};
    const strat=_GOD_STRAT[god]||_GOD_STRAT[_godFallback[god]]||null;
    if(!strat){
      // 沒有戰略模板的流年仍然顯示基本資訊，不跳過
      const ls2=ln.score||0;
      const isGood2=ls2>=1;const isBad2=ls2<=-1;
      html+=`<div style="padding:8px 10px;margin-bottom:6px;border-left:3px solid ${isGood2?'#4ade80':isBad2?'#f87171':'var(--c-gold)'};background:rgba(0,0,0,.08);border-radius:0 6px 6px 0;font-size:.78rem;line-height:1.6">`;
      html+=`<strong style="color:var(--c-gold)">${ln.year} ${ln.gz}【${god}】</strong>`;
      html+=`<span style="font-size:.65rem;color:${isGood2?'#4ade80':isBad2?'#f87171':'#999'};margin-left:6px">${ln.level}</span>`;
      html+=`<p style="margin:4px 0;color:var(--c-text-dim)">📋 ${god}年，${isGood2?'整體能量偏正面，可積極把握。':isBad2?'整體能量偏壓力，宜守成避險。':'能量中性，穩步前進。'}</p>`;
      html+='</div>';
      return;
    }
    const isCur=ln.year===curYear;
    const ls=ln.score||0;
    const isGood=ls>=1;const isBad=ls<=-1;

    html+=`<div style="padding:8px 10px;margin-bottom:6px;border-left:3px solid ${isGood?'#4ade80':isBad?'#f87171':'var(--c-gold)'};background:rgba(0,0,0,.08);border-radius:0 6px 6px 0;font-size:.78rem;line-height:1.6${isCur?';border:1px solid var(--c-gold)':''}">`;
    html+=`<strong style="color:var(--c-gold)">${ln.year} ${ln.gz}【${god}】</strong>`;
    html+=`<span style="font-size:.65rem;color:${isGood?'#4ade80':isBad?'#f87171':'#999'};margin-left:6px">${ln.level}</span>`;
    if(isCur) html+=' <span style="font-size:.6rem;color:var(--c-gold)">← 今年</span>';

    // 戰略轉譯
    html+=`<p style="margin:4px 0 2px;color:var(--c-text)">📋 <strong>${strat.theme}</strong>。${strat.action}。</p>`;

    // 風險預警
    html+=`<p style="margin:2px 0;color:var(--c-text-dim)">⚠ 風險：${strat.risk}。`;
    // 疊加紫微化忌
    if(_dxJi) html+=`大限${_dxJi}，${god==='傷官'||god==='七殺'?'口舌與人際衝突風險加重':'外在環境阻力需留意'}。`;
    html+='</p>';

    // 能量處方
    const rxEls=strat.elRx.split('/');
    const rxCrystal=rxEls.map(e=>(_elCrystal[e]||'')).filter(Boolean).join('、');
    html+=`<p style="margin:2px 0;color:var(--c-text-dim)">💎 能量處方：${strat.elRx}行 → ${rxCrystal||'對應喜用神水晶'}</p>`;

    html+='</div>';
  });
  html+='</div></details>';

  html+='</div>';
  el.innerHTML=html;
}

/* =============================================================
   ENHANCEMENT 2: 梅花六爻爻辭（簡化版：本卦動爻爻辭）
   ============================================================= */
const YAO_CI={
  '乾為天':['潛龍勿用','見龍在田，利見大人','君子終日乾乾，夕惕若厲，無咎','或躍在淵，無咎','飛龍在天，利見大人','亢龍有悔'],
  '坤為地':['履霜，堅冰至','直方大，不習無不利','含章可貞，或從王事，無成有終','括囊，無咎無譽','黃裳，元吉','龍戰于野，其血玄黃'],
  '水雷屯':['磐桓，利居貞，利建侯','屯如邅如，乘馬班如，匪寇婚媾','即鹿無虞，惟入于林中，君子幾不如舍','乘馬班如，求婚媾，往吉無不利','屯其膏，小貞吉，大貞凶','乘馬班如，泣血漣如'],
  '山水蒙':['發蒙，利用刑人，用說桎梏，以往吝','包蒙吉，納婦吉，子克家','勿用取女，見金夫，不有躬，無攸利','困蒙，吝','童蒙，吉','擊蒙，不利為寇，利禦寇'],
  '水天需':['需于郊，利用恆，無咎','需于沙，小有言，終吉','需于泥，致寇至','需于血，出自穴','需于酒食，貞吉','入于穴，有不速之客三人來，敬之終吉'],
  '天水訟':['不永所事，小有言，終吉','不克訟，歸而逋，其邑人三百戶無眚','食舊德，貞厲，終吉；或從王事，無成','不克訟，復即命渝，安貞吉','訟，元吉','或錫之鞶帶，終朝三褫之'],
  '地水師':['師出以律，否臧凶','在師中吉，無咎，王三錫命','師或輿尸，凶','師左次，無咎','田有禽，利執言，無咎；長子帥師，弟子輿尸，貞凶','大君有命，開國承家，小人勿用'],
  '水地比':['有孚比之，無咎；有孚盈缶，終來有它吉','比之自內，貞吉','比之匪人','外比之，貞吉','顯比，王用三驅，失前禽，邑人不誡，吉','比之無首，凶'],
  '風天小畜':['復自道，何其咎，吉','牽復，吉','輿說輻，夫妻反目','有孚，血去惕出，無咎','有孚攣如，富以其鄰','既雨既處，尚德載，婦貞厲，月幾望，君子征凶'],
  '天澤履':['素履，往無咎','履道坦坦，幽人貞吉','眇能視，跛能履，履虎尾，咥人凶，武人為于大君','履虎尾，愬愬，終吉','夬履，貞厲','視履考祥，其旋元吉'],
  '地天泰':['拔茅茹，以其彙，征吉','包荒，用馮河，不遐遺','無平不陂，無往不復，艱貞無咎','翩翩不富，以其鄰，不戒以孚','帝乙歸妹，以祉元吉','城復于隍，勿用師，自邑告命'],
  '天地否':['拔茅茹，以其彙，貞吉亨','包承，小人吉，大人否亨','包羞','有命無咎，疇離祉','休否，大人吉','傾否，先否後喜'],
  '天火同人':['同人于門，無咎','同人于宗，吝','伏戎于莽，升其高陵，三歲不興','乘其墉，弗克攻，吉','同人先號咷而後笑，大師克相遇','同人于郊，無悔'],
  '火天大有':['無交害，匪咎，艱則無咎','大車以載，有攸往，無咎','公用亨于天子，小人弗克','匪其彭，無咎','厥孚交如，威如，吉','自天祐之，吉無不利'],
  '地山謙':['謙謙君子，用涉大川，吉','鳴謙，貞吉','勞謙，君子有終，吉','無不利，撝謙','不富以其鄰，利用侵伐，無不利','鳴謙，利用行師，征邑國'],
  '雷地豫':['鳴豫，凶','介于石，不終日，貞吉','盱豫，悔，遲有悔','由豫，大有得，勿疑朋盍簪','貞疾，恆不死','冥豫，成有渝，無咎'],
  '澤雷隨':['官有渝，貞吉，出門交有功','係小子，失丈夫','係丈夫，失小子，隨有求得，利居貞','隨有獲，貞凶，有孚在道，以明，何咎','孚于嘉，吉','拘係之，乃從維之，王用亨于西山'],
  '山風蠱':['幹父之蠱，有子，考無咎，厲終吉','幹母之蠱，不可貞','幹父之蠱，小有悔，無大咎','裕父之蠱，往見吝','幹父之蠱，用譽','不事王侯，高尚其事'],
  '地澤臨':['咸臨，貞吉','咸臨，吉無不利','甘臨，無攸利，既憂之，無咎','至臨，無咎','知臨，大君之宜，吉','敦臨，吉，無咎'],
  '風地觀':['童觀，小人無咎，君子吝','闚觀，利女貞','觀我生，進退','觀國之光，利用賓于王','觀我生，君子無咎','觀其生，君子無咎'],
  '火雷噬嗑':['屨校滅趾，無咎','噬膚滅鼻，無咎','噬臘肉，遇毒，小吝無咎','噬乾胏，得金矢，利艱貞，吉','噬乾肉，得黃金，貞厲，無咎','何校滅耳，凶'],
  '山火賁':['賁其趾，舍車而徒','賁其須','賁如濡如，永貞吉','賁如皤如，白馬翰如，匪寇婚媾','賁于丘園，束帛戔戔，吝，終吉','白賁，無咎'],
  '山地剝':['剝床以足，蔑貞凶','剝床以辨，蔑貞凶','剝之，無咎','剝床以膚，凶','貫魚，以宮人寵，無不利','碩果不食，君子得輿，小人剝廬'],
  '地雷復':['不遠復，無祗悔，元吉','休復，吉','頻復，厲，無咎','中行獨復','敦復，無悔','迷復，凶，有災眚，用行師終有大敗'],
  '天雷無妄':['無妄，往吉','不耕獲，不菑畬，則利有攸往','無妄之災，或繫之牛，行人之得，邑人之災','可貞，無咎','無妄之疾，勿藥有喜','無妄行，有眚，無攸利'],
  '山天大畜':['有厲，利已','輿說輹','良馬逐，利艱貞，曰閑輿衛，利有攸往','童牛之牿，元吉','豶豕之牙，吉','何天之衢，亨'],
  '山雷頤':['舍爾靈龜，觀我朵頤，凶','顛頤，拂經，于丘頤，征凶','拂頤，貞凶，十年勿用，無攸利','顛頤，吉，虎視眈眈，其欲逐逐，無咎','拂經，居貞吉，不可涉大川','由頤，厲吉，利涉大川'],
  '澤風大過':['藉用白茅，無咎','枯楊生稊，老夫得其女妻，無不利','棟橈，凶','棟隆，吉，有它吝','枯楊生華，老婦得其士夫，無咎無譽','過涉滅頂，凶，無咎'],
  '坎為水':['習坎，入于坎窞，凶','坎有險，求小得','來之坎坎，險且枕，入于坎窞，勿用','樽酒簋貳，用缶，納約自牖，終無咎','坎不盈，祗既平，無咎','係用徽纆，寘于叢棘，三歲不得，凶'],
  '離為火':['履錯然，敬之無咎','黃離，元吉','日昃之離，不鼓缶而歌，則大耋之嗟，凶','突如其來如，焚如，死如，棄如','出涕沱若，戚嗟若，吉','王用出征，有嘉折首，獲匪其醜，無咎'],
  '澤山咸':['咸其拇','咸其腓，凶，居吉','咸其股，執其隨，往吝','貞吉悔亡，憧憧往來，朋從爾思','咸其脢，無悔','咸其輔頰舌'],
  '雷風恆':['浚恆，貞凶，無攸利','悔亡','不恆其德，或承之羞，貞吝','田無禽','恆其德，貞，婦人吉，夫子凶','振恆，凶'],
  '天山遁':['遁尾，厲，勿用有攸往','執之用黃牛之革，莫之勝說','係遁，有疾厲，畜臣妾吉','好遁，君子吉，小人否','嘉遁，貞吉','肥遁，無不利'],
  '雷天大壯':['壯于趾，征凶，有孚','貞吉','小人用壯，君子用罔，貞厲，羝羊觸藩，羸其角','貞吉悔亡，藩決不羸，壯于大輿之輹','喪羊于易，無悔','羝羊觸藩，不能退，不能遂，無攸利，艱則吉'],
  '火地晉':['晉如摧如，貞吉，罔孚裕，無咎','晉如愁如，貞吉，受茲介福于其王母','眾允，悔亡','晉如鼫鼠，貞厲','悔亡，失得勿恤，往吉，無不利','晉其角，維用伐邑，厲吉無咎，貞吝'],
  '地火明夷':['明夷于飛，垂其翼，君子于行，三日不食','明夷，夷于左股，用拯馬壯，吉','明夷于南狩，得其大首，不可疾貞','入于左腹，獲明夷之心，于出門庭','箕子之明夷，利貞','不明晦，初登于天，後入于地'],
  '風火家人':['閑有家，悔亡','無攸遂，在中饋，貞吉','家人嗃嗃，悔厲吉，婦子嘻嘻，終吝','富家，大吉','王假有家，勿恤吉','有孚威如，終吉'],
  '火澤睽':['悔亡，喪馬勿逐自復，見惡人無咎','遇主于巷，無咎','見輿曳，其牛掣，其人天且劓，無初有終','睽孤，遇元夫，交孚，厲無咎','悔亡，厥宗噬膚，往何咎','睽孤，見豕負塗，載鬼一車，先張之弧後說之弧，匪寇婚媾'],
  '水山蹇':['往蹇，來譽','王臣蹇蹇，匪躬之故','往蹇來反','往蹇來連','大蹇，朋來','往蹇來碩，吉，利見大人'],
  '雷水解':['無咎','田獲三狐，得黃矢，貞吉','負且乘，致寇至，貞吝','解而拇，朋至斯孚','君子維有解，吉，有孚于小人','公用射隼于高墉之上，獲之，無不利'],
  '山澤損':['已事遄往，無咎，酌損之','利貞，征凶，弗損益之','三人行則損一人，一人行則得其友','損其疾，使遄有喜，無咎','或益之十朋之龜弗克違，元吉','弗損益之，無咎，貞吉，利有攸往'],
  '風雷益':['利用為大作，元吉，無咎','或益之十朋之龜弗克違，永貞吉','益之用凶事，無咎，有孚中行，告公用圭','中行告公從，利用為依遷國','有孚惠心，勿問元吉，有孚惠我德','莫益之，或擊之，立心勿恆，凶'],
  '澤天夬':['壯于前趾，往不勝為咎','惕號，莫夜有戎，勿恤','壯于頄，有凶，君子夬夬獨行遇雨若濡有慍無咎','臀無膚，其行次且，牽羊悔亡，聞言不信','莧陸夬夬，中行無咎','無號，終有凶'],
  '天風姤':['繫于金柅，貞吉，有攸往，見凶','包有魚，無咎，不利賓','臀無膚，其行次且，厲，無大咎','包無魚，起凶','以杞包瓜，含章，有隕自天','姤其角，吝，無咎'],
  '澤地萃':['有孚不終，乃亂乃萃，若號，一握為笑，勿恤，往無咎','引吉，無咎，孚乃利用禴','萃如嗟如，無攸利，往無咎，小吝','大吉無咎','萃有位，無咎，匪孚，元永貞，悔亡','齎咨涕洟，無咎'],
  '地風升':['允升，大吉','孚乃利用禴，無咎','升虛邑','王用亨于岐山，吉無咎','貞吉，升階','冥升，利于不息之貞'],
  '澤水困':['臀困于株木，入于幽谷，三歲不覿','困于酒食，朱紱方來，利用享祀','困于石，據于蒺藜，入于其宮，不見其妻，凶','來徐徐，困于金車，吝，有終','劓刖，困于赤紱，乃徐有說，利用祭祀','困于葛藟，于臲卼，曰動悔有悔，征吉'],
  '水風井':['井泥不食，舊井無禽','井谷射鮒，甕敝漏','井渫不食，為我心惻，可用汲，王明並受其福','井甃，無咎','井冽，寒泉食','井收勿幕，有孚元吉'],
  '澤火革':['鞏用黃牛之革','已日乃革之，征吉，無咎','征凶，貞厲，革言三就，有孚','悔亡，有孚改命，吉','大人虎變，未占有孚','君子豹變，小人革面，征凶，居貞吉'],
  '火風鼎':['鼎顛趾，利出否，得妾以其子，無咎','鼎有實，我仇有疾，不我能即，吉','鼎耳革，其行塞，雉膏不食，方雨虧悔，終吉','鼎折足，覆公餗，其形渥，凶','鼎黃耳金鉉，利貞','鼎玉鉉，大吉，無不利'],
  '震為雷':['震來虩虩，後笑言啞啞，吉','震來厲，億喪貝，躋于九陵，勿逐，七日得','震蘇蘇，震行無眚','震遂泥','震往來厲，億無喪，有事','震索索，視矍矍，征凶，震不于其躬，于其鄰，無咎'],
  '艮為山':['艮其趾，無咎，利永貞','艮其腓，不拯其隨，其心不快','艮其限，列其夤，厲薰心','艮其身，無咎','艮其輔，言有序，悔亡','敦艮，吉'],
  '風山漸':['鴻漸于干，小子厲有言，無咎','鴻漸于磐，飲食衎衎，吉','鴻漸于陸，夫征不復，婦孕不育，凶，利禦寇','鴻漸于木，或得其桷，無咎','鴻漸于陵，婦三歲不孕，終莫之勝，吉','鴻漸于逵，其羽可用為儀，吉'],
  '雷澤歸妹':['歸妹以娣，跛能履，征吉','眇能視，利幽人之貞','歸妹以須，反歸以娣','歸妹愆期，遲歸有時','帝乙歸妹，其君之袂不如其娣之袂良，月幾望，吉','女承筐無實，士刲羊無血，無攸利'],
  '雷火豐':['遇其配主，雖旬無咎，往有尚','豐其蔀，日中見斗，往得疑疾，有孚發若，吉','豐其沛，日中見沬，折其右肱，無咎','豐其蔀，日中見斗，遇其夷主，吉','來章，有慶譽，吉','豐其屋，蔀其家，闚其戶，闃其無人，三歲不覿，凶'],
  '火山旅':['旅瑣瑣，斯其所取災','旅即次，懷其資，得童僕貞','旅焚其次，喪其童僕，貞厲','旅于處，得其資斧，我心不快','射雉一矢亡，終以譽命','鳥焚其巢，旅人先笑後號咷，喪牛于易，凶'],
  '巽為風':['進退，利武人之貞','巽在床下，用史巫紛若，吉，無咎','頻巽，吝','悔亡，田獲三品','貞吉悔亡，無不利，無初有終','巽在床下，喪其資斧，貞凶'],
  '兌為澤':['和兌，吉','孚兌，吉，悔亡','來兌，凶','商兌，未寧，介疾有喜','孚于剝，有厲','引兌'],
  '風水渙':['用拯馬壯，吉','渙奔其機，悔亡','渙其躬，無悔','渙其群，元吉，渙有丘，匪夷所思','渙汗其大號，渙王居，無咎','渙其血，去逖出，無咎'],
  '水澤節':['不出戶庭，無咎','不出門庭，凶','不節若，則嗟若，無咎','安節，亨','甘節，吉，往有尚','苦節，貞凶，悔亡'],
  '風澤中孚':['虞吉，有它不燕','鶴鳴在陰，其子和之，我有好爵，吾與爾靡之','得敵，或鼓或罷，或泣或歌','月幾望，馬匹亡，無咎','有孚攣如，無咎','翰音登于天，貞凶'],
  '雷山小過':['飛鳥以凶','過其祖，遇其妣，不及其君，遇其臣，無咎','弗過防之，從或戕之，凶','無咎，弗過遇之，往厲必戒，勿用永貞','密雲不雨，自我西郊，公弋取彼在穴','弗遇過之，飛鳥離之，凶，是謂災眚'],
  '水火既濟':['曳其輪，濡其尾，無咎','婦喪其茀，勿逐，七日得','高宗伐鬼方，三年克之，小人勿用','繻有衣袽，終日戒','東鄰殺牛，不如西鄰之禴祭，實受其福','濡其首，厲'],
  '火水未濟':['濡其尾，吝','曳其輪，貞吉','未濟征凶，利涉大川','貞吉悔亡，震用伐鬼方，三年有賞于大國','貞吉無悔，君子之光，有孚吉','有孚于飲酒，無咎，濡其首，有孚失是']
};

function getYaoCi(guaName, yaoNum){
  const ci=YAO_CI[guaName];
  if(ci&&ci[yaoNum-1])return ci[yaoNum-1];
  return'（爻辭資料庫擴充中）';
}

/* =============================================================
   ENHANCEMENT 3: 塔羅問題類型交叉解讀
   ============================================================= */
const TAROT_TYPE_MEANING={
  love:{
    0:{up:'愛情需要勇氣踏出舒適圈，新戀情可能從意想不到的地方開始。',rv:'感情上太隨性，需認真對待每段關係。'},
    1:{up:'你有吸引力和魅力，善用溝通技巧捨進感情。',rv:'感情中有隱藏或欺騙，需坦誠相待。'},
    2:{up:'傾聽內心直覺，對方可能還沒完全表露心意。',rv:'過於封閉自我，錯過感情訊號。'},
    3:{up:'感情進入豐收期，充滿滋養與溫暖。',rv:'過度依賴對方，需要獨立空間。'},
    4:{up:'關係中需要穩定與承諾，適合談婚論嫁。',rv:'控制欲太強讓對方窒息。'},
    5:{up:'傳統價值觀的結合，可能有長輩介紹的緣分。',rv:'觀念太保守，錯失新型態的愛。'},
    6:{up:'真愛降臨，重要的感情抉擇帶來幸福。',rv:'感情價值觀衝突，需深度溝通。'},
    7:{up:'主動追求愛情，決心讓感情快速前進。',rv:'太急躁，給對方太多壓力。'},
    8:{up:'用耐心和溫柔經營，以柔克剛化解問題。',rv:'感情中缺乏安全感。'},
    9:{up:'需要獨處反思這段感情是否適合自己。',rv:'過度孤立自己，拒絕敞開心扉。'},
    10:{up:'感情命運之輪轉動，緣分即將到來。',rv:'感情進入瓶頸期。'},
    11:{up:'公平對待彼此，因果回報正面。',rv:'感情中有不公平的付出。'},
    12:{up:'為愛付出和等待，換個角度看待關係。',rv:'不必要的犧牲，對方不值得。'},
    13:{up:'舊感情結束，新的愛情破繭而出。',rv:'不願放手舊情，停滯不前。'},
    14:{up:'感情需要平衡和包容，調和彼此差異。',rv:'感情失衡，一方付出太多。'},
    15:{up:'警惕不健康的感情依附或誘惑。',rv:'擺脫不良關係，重獲自由。'},
    16:{up:'感情出現突變，卟有認知被顛覆。',rv:'避開感情衝擊，危機可化解。'},
    17:{up:'愛情中的希望之星，值得期待的未來。',rv:'對感情失卻信心。'},
    18:{up:'感情中有隱藏的不安，需要勇氣面對。',rv:'迷霧散卻，感情真相浮現。'},
    19:{up:'感情明朗化，關係進入甜蜜光明期。',rv:'暫時的陰霾，但終會過去。'},
    20:{up:'重新審視感情觀，靈魂層面的覺醒。',rv:'拒絕成長讓關係退步。'},
    21:{up:'感情圓滿，找到命中注定的人。',rv:'感情尚缺最後一步才能完碧。'},
    36:{up:'新的感情萌芽，情感豐沛。',rv:'感情封閉，錯過真心。'},
    37:{up:'雙方互相吸引，關係進入甜蜜期。',rv:'感情失衡，溝通出問題。'},
    44:{up:'感情願望實現，心滿意足。',rv:'不滿足現有的感情。'},
    45:{up:'家庭幸福、感情圓滿的象徵。',rv:'家庭問題影響感情。'},
    // 權杖 Wands（火/行動）
    38:{up:'感情中的合作與佈局開始展開，可能有共同規劃未來的契機。',rv:'未來在關係推進上容易遇到瓶頸，雙方對未來的共識不足，導致熱情消退或停滯不前。'},
    39:{up:'感情穩定後的享受期，適合回顧彼此經營的成果。',rv:'對關係感到厭倦，需重燃熱情。'},
    40:{up:'感情中有競爭者或摩擦，需要面對而非逃避。',rv:'衝突結束，和解的機會出現。'},
    41:{up:'感情上取得勝利，你的堅持獲得了認可與回報。',rv:'在感情拉鋸中疲憊，需找回初衷。'},
    42:{up:'在感情中堅守立場，面對壓力仍不動搖。',rv:'太固執己見讓關係僵化，需適度退讓。'},
    43:{up:'感情發展快速，雙方化學反應強烈。',rv:'衝動行事傷感情，需要冷靜三秒。'},
    // 權杖宮廷
    44:{up:'感情願望實現，心滿意足。',rv:'不滿足現有的感情。'},
    // 聖杯 Cups（水/情感）
    46:{up:'新的感情訊息到來，情緒上開始療癒。',rv:'情緒不穩影響感情判斷，過於幼稚的處理方式。'},
    47:{up:'與對方心靈契合，關係昇華到更深層次。',rv:'關係失衡，需重新調整彼此的付出比例。'},
    48:{up:'社交圈帶來桃花，適合參加聚會認識新對象。',rv:'過度社交消耗感情能量，需專注在重要的人身上。'},
    49:{up:'對感情感到倦怠或不滿足，需要重新審視自己真正想要的。',rv:'開始走出情緒低谷，重新看見身邊的機會。'},
    50:{up:'過度執著於已逝去的感情，需要學會放下向前看。',rv:'放下過去的遺憾，新感情正在靠近。'},
    51:{up:'回憶美好舊時光，但過去無法重來，珍惜當下。',rv:'活在過去的幻想中，影響現在的關係。'},
    52:{up:'太多曖昧對象讓你無法選擇，需聚焦在真正有未來的人。',rv:'終於看清楚自己想要什麼樣的伴侶。'},
    53:{up:'對感情感到疲憊，想暫時抽離。',rv:'逃避並不能解決問題，該面對了。'},
    54:{up:'感情進入夢想成真的階段，滿足與幸福。',rv:'期待過高導致失落感。'},
    55:{up:'經歷低谷後感情重生，浴火鳳凰式的愛情。',rv:'感情持續低迷，需更多時間療癒。'},
    // 寶劍 Swords（風/思維）
    56:{up:'看清感情的真相，理性面對情感問題。',rv:'思慮過度反而無法享受愛情。'},
    57:{up:'暫時擱置感情問題，內心需要安靜。',rv:'逃避感情問題不是辦法，需勇敢溝通。'},
    58:{up:'感情中的焦慮和不安全感困擾著你。',rv:'焦慮開始緩解，感情壓力減輕。'},
    59:{up:'需要好好休息，暫時放下感情上的執念。',rv:'低谷已過，感情將迎來新的可能。'},
    60:{up:'舊的感情模式結束，帶著經驗往前走。',rv:'離開時帶著太多怨恨，需要放下。'},
    61:{up:'感情環境有變動，可能異地或分離，但是為了更好的未來。',rv:'因外在因素被迫分離。'},
    62:{up:'在感情中隱藏了真實想法，需要更坦誠。',rv:'過度防禦讓對方無法靠近。'},
    63:{up:'在感情中感覺被困住，需要找到出路。',rv:'開始看到束縛鬆開的可能性。'},
    64:{up:'對感情過度擔憂，很多恐懼是自己想像出來的。',rv:'焦慮減輕，看清問題沒有想像中嚴重。'},
    65:{up:'感情面臨重大轉折或決裂，需要果斷抉擇。',rv:'無法做出決定，感情問題繼續拖延。'},
    // 金幣/錢幣 Pentacles（土/實際）
    66:{up:'感情出現新的萌芽，值得用心培養。',rv:'感情種子還沒準備好發芽，耐心等待。'},
    67:{up:'在多個對象間搖擺不定，需做出選擇。',rv:'猶豫不決錯失良緣。'},
    68:{up:'過去在感情上較為謹慎保守，傾向觀察對方是否具備實際發展的可能。',rv:'太專注其他事務而忽略感情。'},
    69:{up:'過度看重物質條件，忽略了感情的本質。',rv:'開始重新重視精神層面的連結。'},
    70:{up:'感情中有不安全感，擔心被拋棄或孤獨。',rv:'走出感情困境，重建安全感。'},
    71:{up:'感情穩定且物質基礎良好，適合進入下一階段。',rv:'過度在意對方條件，忽略真心。'},
    72:{up:'感情需要長期耐心經營，不要急於求成。',rv:'對感情投入的努力暫時看不到回報。'},
    73:{up:'在感情中展現成熟穩重的一面，吸引同樣成熟的伴侶。',rv:'太過嚴肅讓感情缺乏趣味。'},
    74:{up:'過去在感情上較為謹慎保守，傾向觀察對方是否具備實際發展的可能。',rv:'太過被動，錯失表達心意的時機。'},
    75:{up:'在感情中展現魅力與擔當，是值得依靠的伴侶。',rv:'控制欲過強，讓對方喘不過氣。'},
    76:{up:'感情中享受彼此陪伴的美好，生活品質提升。',rv:'物質享受取代了心靈交流。'},
    77:{up:'在感情中是穩固可靠的存在，適合共建長遠未來。',rv:'太過務實缺乏浪漫，需要為感情注入一些驚喜。'}
  },
  career:{
    0:{up:'事業上勇於嘗試新領域，創業契機浮現。',rv:'職場決策太草率，需更多規劃。'},
    1:{up:'擁有成功所需的全部資源和能力。',rv:'技能需精進，避免眼高手位。'},
    2:{up:'職場直覺準確，適合等待更好的機會。',rv:'職場過於被動。'},
    3:{up:'事業豐收期，創造力旺盛適合擴展。',rv:'過度依賴團隊。'},
    4:{up:'獲得權威地位，適合管理與決策。',rv:'控制欲太強，需學會捈權。'},
    5:{up:'遵循組織規範，向前輩/對師請教。',rv:'太死板，需要創新突破。'},
    6:{up:'面臨重要的職業選擇。',rv:'職場人際關係有衝突。'},
    7:{up:'事業突破，靠堅定意志克服困難。',rv:'工作方向不明。'},
    8:{up:'耐心處理職場挑戰，以智取勝。',rv:'缺乏自信影響表現。'},
    9:{up:'需要獨立思考職涯方向。',rv:'過度孤立錯失合作機會。'},
    10:{up:'事業迍來轉折點，好運降臨。',rv:'事業遇瓶頸，耐心等待。'},
    11:{up:'公正的工作評價，努力有回報。',rv:'遭受不公平對待。'},
    13:{up:'舊工作結束迍接新機會，轉型期。',rv:'抗拒職場變化。'},
    16:{up:'現有工作架構崩塌，被迫重建。',rv:'成功避開職場危機。'},
    19:{up:'事業光明，獲得認可與成就。',rv:'暫時的位潮期。'},
    21:{up:'事業達成里程碑，圓滿隍段性目標。',rv:'尚差最後一步努力。'},
    22:{up:'新項目啟動，充滿創造能量。',rv:'項目延遲啟動。'},
    35:{up:'展現領導力，帶領團隊前進。',rv:'領導風格需調整。'},
    64:{up:'新的財務機會出現，升職加薪有望。',rv:'機會錯失，需提高警覺。'},
    71:{up:'精進技藝的時期，專注帶來成果。',rv:'對工作缺乏熱情。'}
  },
  wealth:{
    0:{up:'意外之財的可能，新的財路打開。',rv:'衝動消費，財務失捧。'},
    1:{up:'善用手邊資源創造財富。',rv:'理財方式需要改進。'},
    3:{up:'財運豐饒，投資回報良好。',rv:'花費過度，需要節制。'},
    9:{up:'深思熟慮的財務決定帶來穩健收益。',rv:'投資判斷力下降。'},
    10:{up:'財運轉折，可能有意外收入。',rv:'財運位迷期。'},
    14:{up:'理財需要平衡，不宜偏重單一投資。',rv:'財務失衡，支出大於收入。'},
    15:{up:'小心物質誘惑和高風險投機。',rv:'擺脫不良的消費習慣。'},
    19:{up:'財運亨通，投資回報明顯。',rv:'短期財務壓力。'},
    21:{up:'財務目標達成，圓滿豐收。',rv:'收入不穩定。'},
    64:{up:'新的賺錢機會，財富種子萌發。',rv:'錯過投資良機。'},
    67:{up:'守財有道，財務安全感強。',rv:'過度吝嗇。'},
    72:{up:'財務自由的象徵，豐衣足食。',rv:'過度自滿對致風險。'},
    73:{up:'家族財富累積，長期穩定。',rv:'家庭財務有隱患。'}
  },
  health:{
    0:{up:'身體需要冒險嘗試新療法或生活方式改變。',rv:'健康方面太冒進，需穩定調養。'},
    1:{up:'善用知識主動管理健康，頭腦清醒。',rv:'過度思慮影響神經系統，需放鬆。'},
    2:{up:'傾聽身體直覺，潛意識知道需要什麼。',rv:'忽視身體訊號，隱藏健康問題需正視。'},
    3:{up:'身體處於滋養豐盛期，適合調理進補。',rv:'過度放縱飲食影響健康。'},
    4:{up:'身體狀況穩定，規律生活有益。',rv:'壓力過大影響健康，身心緊繃。'},
    5:{up:'遵循傳統養生方法有益，適合看中醫調理。',rv:'打破舊有不良習慣，嘗試新的健康方式。'},
    6:{up:'身心和諧，人際支持有助康復。',rv:'情緒衝突影響免疫系統。'},
    7:{up:'以意志力驅動健康改善，運動計畫有效。',rv:'方向錯誤的健康策略，需調整。'},
    8:{up:'身心調和，內在力量幫助恢復。',rv:'缺乏信心影響康復，免疫力下降。'},
    9:{up:'需要獨處休養，減少社交消耗。',rv:'過度封閉不利身心，適度社交有益。'},
    10:{up:'健康進入新週期，體質正在轉變。',rv:'健康起伏不定，需耐心度過調整期。'},
    11:{up:'因果法則：過去的生活習慣正在影響現在。',rv:'逃避健康問題，需面對根源。'},
    12:{up:'需要放慢腳步，讓身體自然修復。',rv:'急於復原反而適得其反。'},
    13:{up:'舊的健康問題結束，新階段開始。',rv:'抗拒改變生活習慣，拖延治療。'},
    14:{up:'保持身心平衡是健康關鍵。',rv:'生活失衡影響身心，作息混亂。'},
    15:{up:'注意上癮行為對健康的影響。',rv:'正在擺脫不良嗜好。'},
    16:{up:'突發健康狀況，需要立即處理。',rv:'小問題累積成大問題。'},
    17:{up:'健康好轉，充滿希望與活力。',rv:'健康狀況需持續關注，勿掉以輕心。'},
    18:{up:'注意情緒對健康的暗中影響，尤其睡眠。',rv:'焦慮正在緩解，睡眠改善。'},
    19:{up:'身心能量充沛，健康狀態良好。',rv:'過度消耗精力，需適時休息。'},
    20:{up:'身體發出重要訊號，該全面檢視健康了。',rv:'忽視身體的警告，拒絕改變。'},
    21:{up:'身心整合完成，健康達到良好狀態。',rv:'健康目標尚未達成，繼續努力。'},
    // 權杖 (火/行動力)
    36:{up:'行動力強，適合開始運動計畫。',rv:'衝動行事傷身，運動過度。'},
    37:{up:'規劃長期健康目標，視野放遠。',rv:'健康計畫太大而無法執行。'},
    38:{up:'等待檢查結果或身體恢復，需要耐心。',rv:'拖延就醫，錯過最佳治療時機。'},
    39:{up:'享受健康帶來的成果，穩定期。',rv:'安逸導致健康管理鬆懈。'},
    40:{up:'競爭壓力影響健康，需注意衝突帶來的緊張。',rv:'內在衝突正在緩解。'},
    41:{up:'健康方面取得階段性勝利。',rv:'短期好轉不代表痊癒，勿掉以輕心。'},
    42:{up:'堅守健康原則，不要退讓。',rv:'太固執拒絕新的治療方式。'},
    43:{up:'快速行動改善健康，精力充沛。',rv:'情緒化影響健康決策。'},
    44:{up:'權杖侍者精力旺盛，適合嘗試新運動。',rv:'三分鐘熱度，健康計畫不持久。'},
    45:{up:'精力充沛，適合挑戰體能極限。',rv:'急躁冒進導致運動傷害。'},
    // 聖杯 (水/情緒)
    46:{up:'情緒開始療癒，內心平靜有助身體恢復。',rv:'情緒不穩影響消化與免疫系統。'},
    47:{up:'身心靈平衡，療癒能量流動。',rv:'關係壓力影響健康。'},
    48:{up:'社交活動帶來歡樂，有益身心。',rv:'過度社交導致疲勞。'},
    49:{up:'情緒低落影響免疫力，需要調整心態。',rv:'走出低潮，健康開始好轉。'},
    50:{up:'過度執著造成壓力，學會放下。',rv:'開始放下執念，壓力減輕。'},
    51:{up:'懷舊情緒對身心有療癒作用。',rv:'活在過去的痛苦中，影響身心。'},
    52:{up:'太多選擇造成焦慮，專注一種養生法。',rv:'終於做出健康決策。'},
    53:{up:'身體需要休息，不要硬撐。',rv:'太焦躁反而影響恢復。'},
    54:{up:'情感滿足帶來身心健康。',rv:'情緒空虛影響生理。'},
    55:{up:'健康正在改善，度過低谷期。',rv:'健康恢復緩慢，需更多耐心。'},
    // 寶劍 (風/思維)
    56:{up:'思路清晰有助醫療決策。',rv:'思慮過度造成頭痛與失眠。'},
    57:{up:'暫時擱置煩惱，讓身心休息。',rv:'逃避健康問題不是辦法。'},
    58:{up:'焦慮影響睡眠和健康。',rv:'焦慮正在緩解，心理壓力減輕。'},
    59:{up:'需要充分休息，讓身體修復。',rv:'最壞的時期已過，開始恢復。'},
    60:{up:'衝突結束，身心壓力解除。',rv:'表面和解但內在壓力仍在。'},
    61:{up:'環境改變有助身心健康。',rv:'抗拒改變環境，健康持續受影響。'},
    62:{up:'心理防禦機制影響身體，需坦誠面對。',rv:'過度自我保護。'},
    63:{up:'感覺被困住，壓力影響健康。',rv:'束縛正在鬆開，壓力減輕。'},
    64:{up:'過度擔憂影響健康，需學會管理焦慮。',rv:'焦慮正在好轉。'},
    65:{up:'重大健康轉折，可能需要手術或劇烈治療。',rv:'健康問題拖延惡化。'},
    // 金幣/錢幣 (土/身體)
    66:{up:'新的健康習慣開始萌芽。',rv:'健康計畫停滯不前。'},
    67:{up:'在多種療法間找平衡。',rv:'失衡的生活方式影響健康。'},
    68:{up:'技能學習有助健康管理，如烹飪營養餐。',rv:'忽視基本保養技巧。'},
    69:{up:'過度節省影響生活品質與健康。',rv:'開始投資自己的健康。'},
    70:{up:'經濟壓力影響健康，身心俱疲。',rv:'困境正在好轉，健康改善。'},
    71:{up:'資源充足，適合投資健康管理。',rv:'有資源卻不用在健康上。'},
    72:{up:'長期努力見成效，健康穩步改善。',rv:'急於求成，養生需要耐心。'},
    73:{up:'精力充沛，體能狀態極佳。',rv:'過度自信忽視隱患。'},
    74:{up:'金幣侍者代表新的健康知識，適合學習養生。',rv:'健康資訊太多反而無所適從。'},
    75:{up:'體能強健，適合中高強度運動。',rv:'過度勞動損害身體。'},
    76:{up:'生活品質提升有益健康，注重身心享受。',rv:'物質享受過度影響健康。'},
    77:{up:'身體底子穩固，適合長期保養計畫。',rv:'過度控制飲食反而失衡，放鬆心態。'}
  },
  relationship:{
    3:{up:'人際關係和諧，社交活躍。',rv:'人際圈過度消耗。'},
    6:{up:'重要的人際選擇，影響未來交友圈。',rv:'人際關係有衝突。'},
    11:{up:'人際互動公平，好人緣。',rv:'遭受不公對待。'},
    38:{up:'友誼歡樂，社交活動豐富。',rv:'過度社交對致疲憊。'},
    45:{up:'團隊和家庭關係圓滿。',rv:'人際紛爭。'},
    54:{up:'人際衝突需要面對和處理。',rv:'和解的可能性出現。'}
  }
};

function getTarotTypeMeaning(cardId, isUp, type){
  const tm=TAROT_TYPE_MEANING[type];
  if(tm&&tm[cardId]){
    return isUp?tm[cardId].up:tm[cardId].rv;
  }
  return null;
}

/* =============================================================
   ENHANCEMENT 4: 紫微亮度（廟旺利平陷）
   ============================================================= */
const ZW_BRIGHTNESS={
  // 簡化：紫微在各地支的廟旺（子丑寅卯辰巳午未申酉戌亥）
  '紫微':['廟','旺','得地','平','旺','得地','廟','旺','得地','平','得地','旺'],
  '天機':['平','廟','旺','廟','得地','平','陷','得地','旺','得地','平','廟'],
  '太陽':['陷','陷','平','旺','廟','廟','廟','旺','平','陷','陷','陷'],
  '武曲':['旺','廟','得地','陷','平','旺','得地','得地','廟','旺','得地','平'],
  '天同':['旺','平','陷','平','得地','得地','陷','平','得地','旺','廟','旺'],
  '廉貞':['得地','平','旺','陷','得地','平','得地','旺','廟','得地','平','旺'],
  '天府':['廟','得地','旺','得地','平','廟','旺','得地','旺','廟','得地','旺'],
  '太陰':['廟','廟','旺','旺','得地','平','陷','陷','陷','平','得地','旺'],
  '貪狼':['旺','平','廟','旺','得地','得地','陷','平','得地','旺','廟','旺'],
  '巨門':['旺','廟','得地','平','陷','旺','得地','平','廟','旺','得地','平'],
  '天相':['廟','得地','旺','旺','平','得地','旺','得地','廟','得地','旺','得地'],
  '天梁':['廟','旺','得地','平','得地','旺','廟','得地','旺','平','得地','旺'],
  '七殺':['廟','旺','平','得地','旺','得地','廟','得地','旺','平','得地','旺'],
  '破軍':['平','旺','廟','得地','旺','得地','平','旺','得地','旺','廟','得地']
};

function getStarBrightness(starName, zhiBranch){
  const idx=DZ.indexOf(zhiBranch);
  if(idx<0)return'';
  const arr=ZW_BRIGHTNESS[starName];
  if(!arr)return'';
  return arr[idx]||'';
}

/* =============================================================
   ENHANCEMENT 5: 增強 renderZiwei 加入亮度
   ============================================================= */
const _origRenderZiwei = renderZiwei;
renderZiwei = function(){
  _origRenderZiwei();
  // Post-process: add brightness tags
  if(!S.ziwei)return;
  S.ziwei.palaces.forEach(p=>{
    p.stars.forEach(s=>{
      if(s.type==='major'){
        s.brightness=getStarBrightness(s.name, p.branch);
      }
    });
  });
  // Re-render grid with brightness
  const zw=S.ziwei;
  const order=[[3,4,5,6],[2,-1,-1,7],[1,-1,-1,8],[0,11,10,9]];
  let html='<div class="zw-grid">';
  for(let row=0;row<4;row++){
    for(let col=0;col<4;col++){
      const idx=order[row][col];
      if(idx===-1){
        if(row===1&&col===1){
          html+=`<div class="zw-cell zw-center" style="grid-column:2/4;grid-row:2/4">
            <div class="serif text-gold" style="font-size:1.1rem;margin-bottom:var(--sp-sm)">紫微斗數</div>
            <p class="text-dim text-xs">命宮：${DZ[zw.mingIdx]}</p>
            <p class="text-dim text-xs">${zw.yGan}${zw.yZhi}年 ｜ ${zw.wuxingJu}局</p></div>`;
        }
        continue;
      }
      const palace=zw.palaces.find(p=>DZ.indexOf(p.branch)===idx);
      if(!palace){html+=`<div class="zw-cell"><span class="zw-palace">${DZ[idx]}</span></div>`;continue}
      const isMing=palace.isMing;
      html+=`<div class="zw-cell${isMing?' active-palace':''}">
        <div class="zw-palace">${palace.name}${isMing?' ⭐':''}</div>
        <div class="zw-branch">${palace.branch}</div><div class="zw-stars">`;
      palace.stars.forEach(s=>{
        const cls=s.type==='major'?'major':s.type==='sha'?'text-danger':'minor';
        const bright=s.brightness?`<span class="text-xs text-muted">(${s.brightness})</span>`:'';
        html+=`<span class="zw-star ${cls}">${s.name}${bright}</span>`;
        if(s.hua)html+=`<span class="zw-hua">${s.hua}</span>`;
      });
      html+=`</div></div>`;
    }
  }
  html+='</div>';
  document.getElementById('d-ziwei-grid').innerHTML=html;
};

/* =============================================================
   ENHANCEMENT 6: 增強 renderBazi 使用新大運
   ============================================================= */
const _origRenderBazi = renderBazi;
renderBazi = function(){
  _origRenderBazi();
  renderDayunEnhanced();
};

/* =============================================================
   ENHANCEMENT 7: 凱爾特十字完整牌陣敘事分析引擎
   ============================================================= */

function celticCrossNarrative(drawn, type){
  if(!drawn||drawn.length<10) return '';
  const t = type||'general';
  const c = drawn;
  const posCtx = {
    general:['你目前的核心狀態','正在面對的阻礙或交叉影響','過去導致今天局面的根源','接下來即將浮現的趨勢','內心深處的渴望或可能的方向','近期最可能發生的事','你自己對這件事的態度','周圍環境和他人的影響','你內心最深的希望或恐懼','這件事最終的走向'],
    love:['你感情的核心現狀','阻礙感情發展的關鍵因素','過去的感情經歷如何影響現在','即將出現的感情變化','你對理想感情的期待','近期感情上會發生什麼','你自己在感情中的態度','對方或周圍人對這段感情的影響','你對感情最深的期待或擔憂','這段感情最終的走向'],
    career:['你事業的核心現狀','阻礙事業發展的關鍵因素','過去的職涯經歷對現在的影響','即將出現的事業轉機','你對理想工作的期待','近期工作上會發生什麼','你自己對事業的態度和投入','職場環境和同事主管的影響','你對事業最深的期待或擔憂','事業最終的走向'],
    wealth:['你財務的核心現狀','阻礙財運的關鍵因素','過去的理財習慣對現在的影響','即將出現的財務變化','你對財富的期待','近期財務上會發生什麼','你自己的理財態度','外在經濟環境的影響','你對錢最深的期待或擔憂','財運最終的走向'],
    health:['你健康的核心現狀','影響健康的關鍵因素','過去的生活習慣造成的影響','即將出現的健康變化','你對健康的期待','近期身體狀況的走勢','你自己對養生的態度','環境和壓力對健康的影響','你對健康最深的擔憂','健康狀況最終的走向']
  };
  const ctx = posCtx[t] || posCtx.general;
  function cr(idx){
    const card=c[idx], dir=card.isUp?'正位':'逆位', meaning=card.isUp?card.up:card.rv;
    const tm=typeof getTarotTypeMeaning==='function'?getTarotTypeMeaning(card.id,card.isUp,t):'';
    return {name:card.n, dir, meaning, tm:tm||meaning, pos:ctx[idx]};
  }
  const r=[];for(let i=0;i<10;i++)r.push(cr(i));
  let n='';
  n+=`<div style="margin-bottom:12px"><strong style="color:var(--c-gold)">\u{1F52E} 核心現狀</strong><br>`;
  n+=`<b>${r[0].name}</b>（${r[0].dir}）揭示${r[0].pos}：${r[0].tm}`;
  if(c[1].isUp){n+=`<br>而橫亙在眼前的是<b>${r[1].name}</b>（${r[1].dir}），代表${r[1].pos}：${r[1].tm}`;}
  else{n+=`<br>好消息是阻礙<b>${r[1].name}</b>以逆位出現，暗示${r[1].pos}正在被化解：${r[1].tm}`;}
  n+=`<br>追溯根源，<b>${r[2].name}</b>（${r[2].dir}）點出${r[2].pos}：${r[2].tm}</div>`;
  n+=`<div style="margin-bottom:12px"><strong style="color:var(--c-gold)">\u{1F319} 發展趨勢</strong><br>`;
  n+=`<b>${r[3].name}</b>（${r[3].dir}）預示${r[3].pos}：${r[3].tm}`;
  n+=`<br>潛在的可能方向是<b>${r[4].name}</b>（${r[4].dir}），暗示${r[4].pos}：${r[4].tm}`;
  n+=`<br>近期最直接的影響是<b>${r[5].name}</b>（${r[5].dir}）：${r[5].tm}</div>`;
  n+=`<div style="margin-bottom:12px"><strong style="color:var(--c-gold)">\u2B50 最終展望</strong><br>`;
  n+=`你自己的態度（<b>${r[6].name}</b> ${r[6].dir}）：${r[6].tm}`;
  n+=`<br>外在環境（<b>${r[7].name}</b> ${r[7].dir}）：${r[7].tm}`;
  if(c[8].isUp){n+=`<br>內心深處（<b>${r[8].name}</b> ${r[8].dir}）：你心中期盼著：${r[8].tm}`;}
  else{n+=`<br>內心深處（<b>${r[8].name}</b> ${r[8].dir}）：你心中擔憂的是：${r[8].tm}`;}
  n+=`<br><br><span style="font-size:1.05em;color:var(--c-gold)">\u2726 最終結果：<b>${r[9].name}</b>（${r[9].dir}）</span><br>${r[9].tm}</div>`;
  const hints=[];
  const mUp=c.filter(x=>x.id<=21&&x.isUp).length, mDn=c.filter(x=>x.id<=21&&!x.isUp).length;
  if(mUp>=5)hints.push('大牌正位多數，格局清晰，事態明朗');
  if(mDn>=4)hints.push('多張大牌逆位，提示需要內在調整再行動');
  const sc={};c.forEach(x=>{if(x.id>21){for(const s of['\u6b0a\u6756','\u8056\u676f','\u5bf6\u528d','\u91d1\u5e63']){if(x.n.includes(s)){sc[s]=(sc[s]||0)+1;break;}}}});
  Object.entries(sc).forEach(([s,cnt])=>{if(cnt>=3){const h={'\u6b0a\u6756':'行動力與熱情是關鍵','\u8056\u676f':'情感與直覺主導這件事','\u5bf6\u528d':'思考與溝通是核心議題','\u91d1\u5e63':'物質與現實層面最重要'};hints.push(s+'出現'+cnt+'張：'+(h[s]||''));}});
  if(c[0].isUp&&c[9].isUp)hints.push('核心牌與結果牌皆正位，整體走勢正向');
  else if(!c[0].isUp&&!c[9].isUp)hints.push('核心牌與結果牌皆逆位，需要根本性的改變');
  else hints.push('核心牌與結果牌方向不一致，過程有變數');
  // 心理矛盾 (潛意識③ vs 意識⑤)
  if(c[2].isUp!==c[4].isUp)hints.push('潛意識與意識目標矛盾——內心有拉扯，先釐清自己真正要什麼');
  // 現實戰力 (自身⑦ + 環境⑧)
  if(!c[6].isUp&&!c[7].isUp)hints.push('自身+環境都不配合，行動前需大幅調整');
  else if(!c[6].isUp)hints.push('自身狀態需先調整，心理戰力不足');
  else if(!c[7].isUp)hints.push('環境有阻力，外在條件需要應對');
  if(hints.length)n+=`<div style="margin-top:8px;padding:8px;background:rgba(212,175,55,.05);border-radius:6px;font-size:.8rem;color:var(--c-text-dim)"><strong>\u{1F517} 牌陣交叉驗證：</strong><br>${hints.join('；')}</div>`;
  return n;
}

const _origRenderTarot = renderTarot;
renderTarot = function(){
  if(!S.tarot.drawn.length){document.getElementById('r-tarot').innerHTML='<p class="text-dim">未進行塔羅抽牌</p>';return}
  const type=S.form.type;
  let html='';
  if(S.tarot.drawn.length>=10){html+=celticCrossNarrative(S.tarot.drawn,type);html+='<div class="divider" style="margin:16px 0"></div>';}
  html+='<div style="font-size:.85rem;font-weight:600;color:var(--c-gold);margin-bottom:8px">\u{1F4CB} 逐牌詳解</div>';
  html+=S.tarot.drawn.map((c,i)=>{
    const typeMeaning=getTarotTypeMeaning(c.id,c.isUp,type);
    return`<div style="display:flex;gap:var(--sp-sm);align-items:flex-start;padding:var(--sp-sm) 0;border-bottom:1px solid var(--c-border)">
      <span class="tag tag-gold" style="flex:0 0 auto">${i+1}</span>
      <div><strong class="text-gold">${c.pos}</strong>\uff1a${c.n} <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'\u6b63':'\u9006'}</span>
      <p class="text-sm text-dim">${c.isUp?c.up:c.rv}</p>
      ${typeMeaning?`<p class="text-sm mt-sm" style="color:var(--c-gold-light)"><i class="fas fa-star" style="font-size:.6rem"></i> ${getTypeLabel(type)}\u89e3\u8b80\uff1a${typeMeaning}</p>`:''}</div>
    </div>`;
  }).join('');
  document.getElementById('r-tarot').innerHTML=html;
};

/* =============================================================
   ENHANCEMENT 8: 增強梅花結果加入爻辭
   ============================================================= */
const _origShowMH = showMH;
showMH = function(r){
  _origShowMH(r);
  // Append yao ci
  const yaoCi=getYaoCi(r.ben.n, r.dong);
  const detailEl=document.getElementById('mh-detail');
  if(detailEl){
    detailEl.innerHTML+=`<div class="divider"></div><p><strong>動爻爻辭（第${r.dong}爻）：</strong><span class="serif text-gold">${yaoCi}</span></p>`;
  }
};

/* =============================================================
   ENHANCEMENT 9: 列印 / 分享
   ============================================================= */
function printResult(){
  try{ window.print(); }catch(e){ alert('列印功能需要在瀏覽器中開啟此頁面才能使用'); }
}

function shareResult(){
  const prob=document.getElementById('r-vprob').textContent;
  const label=document.getElementById('r-vlabel').textContent;
  const text=`靜月之光占卜結果：${label} ${prob}\n問題：${S.form.question}\n\n免費測你的運勢 👉 ${SITE_URL}`;
  if(navigator.share){
    navigator.share({title:'靜月之光占卜結果',text,url:SITE_URL}).catch(()=>{});
  }else{
    navigator.clipboard.writeText(text).then(()=>alert('結果已複製到剪貼簿！')).catch(()=>{});
  }
  if(typeof incrementAchievement==='function') incrementAchievement('shares',1);
}
/* =============================================================
   CUSTOM ORDER MODAL + FLOATING BUTTONS
   ============================================================= */
function openCustomModal(){
  document.getElementById('custom-modal').style.display='flex';
  document.body.style.overflow='hidden';
}
function closeCustomModal(){
  document.getElementById('custom-modal').style.display='none';
  document.body.style.overflow='';
}
// Close on overlay click
document.addEventListener('click',function(e){
  if(e.target.id==='custom-modal')closeCustomModal();
});

function submitCustomForm(e){if(e)e.preventDefault();} // deprecated
function prepareCustomSubmit(){return false;} // deprecated
function copyCfContent(){} // deprecated

function toggleFab(){
  document.getElementById('fab-menu').classList.toggle('hidden');
}

/* =============================================================
   PWA: Inline Manifest + Service Worker Registration
   ============================================================= */
(function(){
  // Inline manifest as blob
  const manifest={
    name:'靜月之光能量占卜儀',
    short_name:'靜月占卜',
    description:'整合八字、紫微斗數、梅花易數、塔羅牌的多維度命理分析',
    start_url:'./',
    display:'standalone',
    background_color:'#0d0404',
    theme_color:'#0d0404',
    orientation:'portrait-primary',
    lang:'zh-TW',
    icons:[{src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">☽</text></svg>',sizes:'any',type:'image/svg+xml'}]
  };
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const link=document.createElement('link');
  link.rel='manifest';
  link.href=URL.createObjectURL(blob);
  document.head.appendChild(link);
})();

/* =============================================================
   KEYBOARD: Escape closes modal
   ============================================================= */
document.addEventListener('keydown',function(e){
  if(e.key==='Escape'){
    closeCustomModal();
    const fabMenu=document.getElementById('fab-menu');
    if(fabMenu&&!fabMenu.classList.contains('hidden'))fabMenu.classList.add('hidden');
  }
});
/* =============================================================
   FEATURE 1: 商品化水晶推薦（含賣場連結 + 商品類別）
   ============================================================= */
// 產品類型對應的 SVG 圖示（手鍊/手排/項鍊/雕刻件）
const SITE_URL = 'https://jingyue-blue.netlify.app';
const catIcon = {手鏈:'📿', 手排:'⌚', 項鍊:'🔗', 雕刻件:'🗿', 吊墜:'🏷️', 裸石:'💍', 客製:'✨'};
function getProductSVG(cat, name){
  // 根據產品名稱判斷顏色
  const colorMap = [
    // 黑色系
    [/黑曜|黑髮|黑碧璽|黑閃靈|沉香/,'#1a1a2e','#333355'],
    // 藍色系
    [/海藍寶|藍虎眼|藍彼得|藍磷灰|藍玉髓|藍方解石|青晶石|堇青石|鷹眼堇青/,'#1e5799','#4a90d9'],
    // 紫色系
    [/紫水晶|紫龍晶|紫金砂|紫黃白/,'#6b2fa0','#9b59b6'],
    // 粉色系
    [/粉晶|摩根石|粉紅碧璽|薔薇石|煙花雨薔葳|星光草苺|彩色草莓/,'#d4618c','#f0a0c0'],
    // 紅色系
    [/紅瑪腦|紅龍宮|紅花碧玉|紅虎眼|紅幽靈|紅膠花|紅靈骸骨/,'#b22222','#e05050'],
    // 綠色系
    [/綠幽靈|綠碧璽|綠檀木|綠龍晶|綠月光|綠水晶|東陵玉|抹茶幽靈|四季幽靈/,'#2d7d46','#4db870'],
    // 金黃色系
    [/金太陽|金髮|金曜|鈦晶|咖啡鈦|太陽花|骨幹太陽|茶晶|黃龍宮|利比亞黃金|黃水晶/,'#b8860b','#d4af37'],
    // 白/透明系
    [/白水晶|白幽靈|白阿賽|透石膏|白龍宮|月光石|白松石/,'#c0c0d0','#e8e8f0'],
    // 銀灰系
    [/銀曜|鐵膽石|彼得石/,'#606880','#8898a8'],
    // 彩色系
    [/彩超七|彩銅超七|超八|糖果碧璽|阿富汗碧璽|多寶隕石|彩閃靈|彩髮|彩虹黑曜|彩色天鐵|天鐵五行|阿拉善|波斯瑪腦/,'#c07020','#e0a050'],
    // 琥珀/檀木系
    [/老山檀香|沉香/,'#6b4226','#a0704a'],
  ];
  let c1='#d4af37', c2='#b8860b'; // 預設金色
  if(name){
    for(const [re,a,b] of colorMap){
      if(re.test(name)){c1=b;c2=a;break;}
    }
  }
  const svgs = {
    '手鏈': `<svg viewBox="0 0 64 64" width="48" height="48"><circle cx="32" cy="32" r="22" fill="none" stroke="${c1}" stroke-width="2.5" stroke-dasharray="8 4"/><circle cx="32" cy="10" r="4.5" fill="${c1}"/><circle cx="51" cy="21" r="4" fill="${c2}" opacity="0.85"/><circle cx="51" cy="43" r="4" fill="${c1}" opacity="0.85"/><circle cx="32" cy="54" r="4.5" fill="${c2}"/><circle cx="13" cy="43" r="4" fill="${c1}" opacity="0.85"/><circle cx="13" cy="21" r="4" fill="${c2}" opacity="0.85"/></svg>`,
    '手排': `<svg viewBox="0 0 64 64" width="48" height="48"><rect x="8" y="22" width="48" height="20" rx="10" fill="none" stroke="${c1}" stroke-width="2.5"/><rect x="12" y="26" width="10" height="12" rx="2" fill="${c2}" opacity="0.7"/><rect x="27" y="26" width="10" height="12" rx="2" fill="${c1}" opacity="0.7"/><rect x="42" y="26" width="10" height="12" rx="2" fill="${c2}" opacity="0.7"/></svg>`,
    '項鍊': `<svg viewBox="0 0 64 64" width="48" height="48"><path d="M20 8 Q32 4 44 8 Q52 12 52 28 L44 42 Q32 50 20 42 L12 28 Q12 12 20 8Z" fill="none" stroke="${c1}" stroke-width="2"/><circle cx="32" cy="38" r="6" fill="${c2}" opacity="0.8"/><path d="M26 38 L32 32 L38 38 L32 44Z" fill="${c1}" opacity="0.6"/></svg>`,
    '雕刻件': `<svg viewBox="0 0 64 64" width="48" height="48"><path d="M32 8 L48 20 L44 48 Q32 56 20 48 L16 20Z" fill="none" stroke="${c1}" stroke-width="2.5"/><circle cx="32" cy="28" r="5" fill="${c2}" opacity="0.6"/><path d="M24 38 Q32 44 40 38" fill="none" stroke="${c1}" stroke-width="1.5"/></svg>`
  };
  return svgs[cat] || svgs['手鏈'];
}
const PRODUCT_DB={
  金:[
    {n:'白水晶手鏈',cat:'手鏈',icon:'💍',el:'金',d:'淨化能量場，增強思維清晰度',price:'$580-$1,280',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'左手佩戴',img:''},
    {n:'鈦晶吊墜',cat:'吊墜',icon:'⚡',el:'金',d:'招正財偏財，增強領導氣魄',price:'$1,580-$3,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'貼近心輪佩戴',img:''},
    {n:'白水晶裸石',cat:'裸石',icon:'🔮',el:'金',d:'淨化空間磁場，鍮宅開運',price:'$380-$1,200',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放客廳或書桌',img:''}
  ],
  木:[
    {n:'綠幽靈手鏈',cat:'手鏈',icon:'💚',el:'木',d:'招正財，事業穩步上升',price:'$680-$2,200',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'左手佩戴',img:''},
    {n:'東陵玉吊墜',cat:'吊墜',icon:'🌿',el:'木',d:'舒緩壓力，帶來好運',price:'$480-$1,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'項鍊佩戴',img:''},
    {n:'翡翠裸石擺件',cat:'裸石',icon:'💎',el:'木',d:'護身辟邪，增強健康運',price:'$1,200-$5,000',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放書桌或財位',img:''}
  ],
  水:[
    {n:'海藍寶手鏈',cat:'手鏈',icon:'💙',el:'水',d:'增強溝通力，平靜情緒',price:'$780-$2,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'左手佩戴',img:''},
    {n:'月光石吊墜',cat:'吊墜',icon:'🌙',el:'水',d:'增強直覺，助感情運',price:'$580-$1,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'滿月佩戴更佳',img:''},
    {n:'藍紋瑪瑙裸石',cat:'裸石',icon:'🔵',el:'水',d:'穩定情緒，增強表達力',price:'$350-$980',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放臥室床頭',img:''}
  ],
  火:[
    {n:'紅瑪瑙手鏈',cat:'手鏈',icon:'❤️',el:'火',d:'激發熱情，增強行動力與勇氣',price:'$480-$1,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'右手佩戴增行動力',img:''},
    {n:'石榴石吊墜',cat:'吊墜',icon:'🔴',el:'火',d:'提升活力，增強桃花運',price:'$680-$2,200',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'貼身佩戴',img:''},
    {n:'紅碧璽裸石',cat:'裸石',icon:'💗',el:'火',d:'強力招桃花，增強人際魅力',price:'$1,500-$4,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放桃花位',img:''}
  ],
  土:[
    {n:'黃水晶手鏈',cat:'手鏈',icon:'💛',el:'土',d:'招偏財，提升自信與魅力',price:'$580-$1,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'左手佩戴',img:''},
    {n:'虎眼石吊墜',cat:'吊墜',icon:'🐅',el:'土',d:'增強決斷力，招財辟邪',price:'$480-$1,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'出門佩戴',img:''},
    {n:'茶晶裸石擺件',cat:'裸石',icon:'🍵',el:'土',d:'排除負能量，穩定心性',price:'$680-$2,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放客廳',img:''}
  ]
};

// 問題類型特殊商品
const TYPE_PRODUCTS={
  love:[{n:'粉晶手鏈',cat:'手鏈',icon:'💕',el:'火',d:'招桃花首選！增強異性緣',price:'$480-$1,500',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'左手佩戴，約會必備'}],
  career:[{n:'鈦晶手鏈',cat:'手鏈',icon:'⚡',el:'金',d:'事業晉升首選！領導力UP',price:'$1,800-$5,000',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'面試/開會佩戴'}],
  wealth:[{n:'綠幽靈聚寶盆',cat:'裸石',icon:'💰',el:'木',d:'招正財偏財！放辦公桌超旺',price:'$1,200-$3,800',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'放財位或收銀台'}],
  health:[{n:'紫水晶手鏈',cat:'手鏈',icon:'💜',el:'火',d:'安神助眠，促進身心平衡',price:'$580-$1,800',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'睡前佩戴或放枕下'}]
};

/* ═══ renderActionCard: 多維度交叉行動指令 ═══ */
function renderActionCard(bazi, type, answer){
  var fav = bazi.fav || [];
  var unfav = bazi.unfav || [];
  var el = bazi.dmEl;
  var strong = bazi.strong;
  var favEl = fav[0] || '土';
  var ep = bazi.ep||{};
  var tot = Object.values(ep).reduce(function(a,b){return a+b;},0)||60;
  var weakEls = Object.entries(ep).filter(function(x){return (x[1]/tot)<0.12;}).map(function(x){return x[0];});
  var avoidEls = new Set(unfav||[]);
  var recEl = (weakEls.filter(function(e){return !avoidEls.has(e);})[0]) || favEl;

  var EL={
    '金':{mc:'白色/銀色',sc:['米白','淺灰','香檳金','銀白'],dir:'正西',food:['山藥','百合','杏仁','白蘿蔔','蓮子','水梨','銀耳'],drink:['杏仁茶','梨子汁','蓮藕茶','薏仁水'],habit:'深呼吸練習10分鐘',sport:'健走、游泳、瑜伽',crystal:['白水晶','鈦晶']},
    '木':{mc:'綠色',sc:['墨綠','橄欖綠','抹茶色','森林綠'],dir:'正東',food:['花椰菜','菠菜','奇異果','綠豆','芹菜','酪梨','毛豆'],drink:['綠茶','檸檬水','薄荷茶'],habit:'伸展操15分鐘，疏通肝氣',sport:'慢跑、登山、太極',crystal:['綠幽靈','綠碧璽']},
    '水':{mc:'黑色/深藍',sc:['藏青','黛藍','深灰','墨色'],dir:'正北',food:['黑芹麻','海帶','藍莓','黑豆','紫菜','黑木耳','核桃'],drink:['黑豆水','溫開水','蔓越莓汁'],habit:'睡前泡腳暖身，11點前入睡',sport:'游泳、瑜伽、冥想',crystal:['海藍寶','黑曜石']},
    '火':{mc:'紅色/紫色',sc:['酒紅','玫瑰粉','暗紫','珊瑚橘'],dir:'正南',food:['紅棗','枸杞','番茄','紅豆','櫻桃','紅蘿蔔','甜椒'],drink:['紅棗茶','枸杞菊花茶','洛神花茶','玫瑰花茶'],habit:'午間小憩15分鐘，養心安神',sport:'有氧舞蹈、跑步、桌球',crystal:['紫水晶','紅瑪瑙']},
    '土':{mc:'黃色/棕色',sc:['駝色','卡其','焦糖色','大地色'],dir:'中央/東北',food:['南瓜','地瓜','玉米','薑','小米','馬鈴薯','香蕉'],drink:['薑茶','四神湯','蜂蜜水','燕麥奶'],habit:'三餐定時定量，飯後散步20分鐘',sport:'散步、太極、園藝',crystal:['黃水晶','茶晶']}
  };
  var favData=EL[favEl]||EL['土'];
  var recData=EL[recEl]||EL['土'];

  function pick(arr,n){if(!arr||!arr.length)return[];var s=[].concat(arr);for(var i=s.length-1;i>0;i--){var j=Math.floor(Math.random()*i);var t=s[i];s[i]=s[j];s[j]=t;}return s.slice(0,Math.min(n||1,s.length));}

  var SHENG={'金':'土','木':'水','水':'金','火':'木','土':'火'};
  var motherEl=SHENG[favEl];var motherData=EL[motherEl];
  var actions=[];

  // ── 收集梅花、塔羅、紫微的象徵訊號 ──
  var mhSignal='', mhAction='';
  if(S.meihua){
    var mh=S.meihua;
    var benN=mh.ben?mh.ben.n:'', bianN=mh.bian?mh.bian.n:'';
    var tiYong=mh.ty.r, judge=mh.ty.f;
    // 卦象象徵 → 具體行動
    var guaAction={
      '乾':'宜果斷行動，不要猶豫','坤':'宜柔順配合，不宜強出頭','震':'有新機會出現，主動爭取','巽':'宜低調滲透，潤物無聲',
      '坎':'小心隱藏風險，凡事留備案','離':'宜展現自己，曝光有利','艮':'宜停下來思考，不宜急進','兌':'溝通表達有利，多開口',
      '泰':'暢通無阻，放心推進','否':'阻塞期，蟄伏等待','咸':'感應力強，直覺可信','恆':'持之以恆，不要半途而廢',
      '損':'需要先付出或割捨，才有回報','益':'有人會幫你，接受善意','既濟':'事情接近完成，注意收尾','未濟':'還沒到時候，再準備一下',
      '蹇':'前方有阻礙，繞路比硬闖好','困':'資源不足，先充實自己','升':'穩步上升，一步一步來','漸':'循序漸進，急不得'
    };
    // 從變卦取行動建議（變卦代表走向）
    for(var gk in guaAction){
      if(bianN.includes(gk)){mhAction=guaAction[gk];break;}
    }
    if(!mhAction){for(var gk2 in guaAction){if(benN.includes(gk2)){mhAction=guaAction[gk2];break;}}}
    if(tiYong.includes('剋')){mhSignal='卦象體用相剋，過程需要付出額外努力';}
    else if(tiYong.includes('生用')){mhSignal='卦象體生用，你的投入會有回報';}
    else if(tiYong.includes('生體')){mhSignal='卦象用生體，有外在資源可借力';}
  }

  var tarotSignal='', tarotAction='';
  if(S.tarot&&S.tarot.drawn&&S.tarot.drawn.length>=10){
    var td=S.tarot.drawn;
    var core=td[0], advice=td[6], outcome=td[9], obstacle=td[1];
    // 建議牌（位置7）→ 具體行動
    var adviceName=advice.n+(advice.isUp?'正':'逆');
    var adviceMap={
      '皇帝':'建立明確的規則和計畫','女祭司':'相信直覺，不要過度分析','魔術師':'主動創造機會，別等','力量':'用耐心而非蠻力',
      '戰車':'全力衝刺，目標明確','隱者':'獨處思考，暫離喧囂','命運之輪':'順勢而為，不要抗拒變化','正義':'做出公平的決定',
      '倒吊人':'換個角度看問題','死神':'放下舊的才有新的','節制':'保持平衡，不走極端','星星':'保持希望，長遠規劃',
      '月亮':'小心幻覺和誤判','太陽':'積極樂觀，展現自己','審判':'面對過去，做出了斷','世界':'完成階段任務，準備下一步'
    };
    for(var tk in adviceMap){if(advice.n.includes(tk)){tarotAction=adviceMap[tk];break;}}
    if(!tarotAction) tarotAction=advice.isUp?'順著'+advice.n+'的能量行動':'注意'+advice.n+'逆位提醒的盲點';
    // 阻礙牌提醒
    if(obstacle&&!obstacle.isUp) tarotSignal='塔羅阻礙位「'+obstacle.n+' 逆位」提醒你留意內心的'+({
      '聖杯':'情緒波動','寶劍':'過度焦慮','錢幣':'物質擔憂','權杖':'動力不足'
    }[obstacle.suit]||'猶豫');
  }

  var zwSignal='', zwAction='';
  if(S.ziwei){
    var typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7};
    var gIdx=typeToGong[type]||0;
    var gong=S.ziwei.palaces[gIdx];
    if(gong){
      var gongStars=gong.stars.filter(function(s){return s.type==='major';});
      var gName=['命宮','兄弟','夫妻','子女','財帛','疾厄','遷移','交友','官祿','田宅','福德','父母'][gIdx]||'';
      if(gongStars.length){
        var mainS=gongStars[0].name;
        var zwTips={
          '紫微':'善用你的領導力和決斷力','天機':'多用腦少用力，智取勝過硬拼','太陽':'多在外面走動，宅在家反而不順',
          '武曲':'直接執行，少猶豫','天同':'借助人脈和團隊力量','廉貞':'控制情緒是關鍵，衝動是大忌',
          '天府':'穩紮穩打，不要被別人的節奏帶著走','太陰':'適合幕後規劃，細節決定成敗',
          '貪狼':'專注一件事，不要三心二意','巨門':'少說多做，用成果說話','天相':'找到好的合作夥伴',
          '天梁':'你有化險為夷的福氣，不用太擔心','七殺':'大膽行動但留退路','破軍':'適合開創新局，但要做好辛苦準備'
        };
        if(zwTips[mainS]){zwAction=zwTips[mainS]; zwSignal=gName+'有'+mainS+'坐鎮';}
      }
    }
  }

  /* ═══ 組合行動指令（多維度交叉） ═══ */

  /* 1. 核心策略（梅花+塔羅+紫微交叉）*/
  var stratParts=[];
  if(mhAction) stratParts.push('梅花卦象提示「'+mhAction+'」');
  if(tarotAction) stratParts.push('塔羅建議牌指向「'+tarotAction+'」');
  if(zwAction) stratParts.push('紫微'+zwSignal+'，'+zwAction);
  if(stratParts.length>=2){
    var anyAggr=/(衝|行動|主動|執行|直接|爭取|全力|創造|放心|展現)/.test(stratParts.join(''));
    var anyCaut=/(穩|等|停|控制|耐心|柔|低調|思考|小心|滲透|備案|蟄伏)/.test(stratParts.join(''));
    if(anyAggr&&anyCaut){
      actions.push('<strong>核心策略：</strong>'+stratParts.join('；')+'。→ 各系統建議有張力：大方向可推進，但過程保持警覺，邊做邊調整');
    } else {
      actions.push('<strong>核心策略：</strong>'+stratParts.join('；'));
    }
  } else if(stratParts.length===1){
    actions.push('<strong>核心策略：</strong>'+stratParts[0]);
  } else {
    actions.push('<strong>核心策略：</strong>'+(strong?'你有底氣主動出擊，但記得評估風險':'穩健為主，借力使力，不要硬拼'));
  }

  /* 2. 留意風險（塔羅阻礙+梅花體用剋）*/
  var warns=[];
  if(tarotSignal) warns.push(tarotSignal);
  if(mhSignal) warns.push(mhSignal);
  if(warns.length) actions.push('<strong>留意風險：</strong>'+warns.join('。'));

  /* 3. 穿搭（八字×塔羅牌象×紫微星曜風格×場景）*/
  var mainC=pick(favData.sc,1)[0]||favData.mc;
  var accC=motherData?pick(motherData.sc,1)[0]:'米白';
  var dressExtra='';
  if(S.tarot&&S.tarot.drawn&&S.tarot.drawn.length>=10){
    var _cn=S.tarot.drawn[0].n;
    var _ts={'皇帝':'加入結構感配件（手錶、皮帶）','女祭司':'搭配神秘感飾品（月光石、深色系）','皇后':'柔和質地或花卉元素加分','魔術師':'大膽嘗試新風格','力量':'簡約有質感的單品','星星':'加一點亮面配件','太陽':'明亮色系展現開朗','月亮':'低調神秘配色','戀人':'粉色系點綴增加親和力','隱者':'沉穩色系、質感面料'};
    for(var _sk in _ts){if(_cn.includes(_sk)){dressExtra='。塔羅提示：'+_ts[_sk];break;}}
  }
  var _zwSty='';
  if(S.ziwei){
    var _mm=S.ziwei.palaces[0]?S.ziwei.palaces[0].stars.filter(function(s){return s.type==='major';}):[];
    if(_mm.length){
      var _sMap={'紫微':'貴氣大方','天機':'知性文青','太陽':'陽光開朗','武曲':'俐落幹練','天同':'親切溫暖','廉貞':'時尚有個性','天府':'穩重有品','太陰':'溫柔細膩','貪狼':'性感有魅力','巨門':'低調質感','天相':'端莊得體','天梁':'成熟穩重','七殺':'帥氣俐落','破軍':'個性前衛'};
      if(_sMap[_mm[0].name]) _zwSty='，你的命宮'+_mm[0].name+'適合「'+_sMap[_mm[0].name]+'」風格';
    }
  }
  var sceneMap={love:'約會穿搭',career:'重要場合',wealth:'談生意時',health:'日常穿著',relationship:'社交場合',family:'家庭聚會'};
  actions.push('<strong>穿搭：</strong>'+(sceneMap[type]||'日常')+'建議以 <em>'+mainC+'</em> 為主色調，搭配 <em>'+accC+'</em> 系配件'+_zwSty+dressExtra);

  /* 4. 方位（八字喜用×梅花卦象方位）*/
  var dirNote=favData.dir, dirSrc='八字喜用';
  if(S.meihua&&S.meihua.bian){
    var _bEl=S.meihua.bian.el;
    var _mDir={'金':'正西','木':'正東','水':'正北','火':'正南','土':'東北'}[_bEl];
    if(_mDir&&_mDir!==dirNote){dirNote+='或'+_mDir; dirSrc='八字+梅花交叉';}
  }
  var dirLabel={love:'社交、約會',career:'面試、洽公',wealth:'談生意、簽約',health:'散步、運動',relationship:'聚會、拜訪',family:'出門散心'};
  actions.push('<strong>'+(type==='love'?'桃花方位':'有利方位')+'：</strong>'+(dirLabel[type]||'出門')+'往 <em>'+dirNote+'</em> 方向走（'+dirSrc+'）');

  /* 5. 飲食（八字喜用×弱五行×場景）*/
  var mf=pick(favData.food,2);var md=pick(favData.drink,1)[0];
  var dietX='';
  if(weakEls.length>0&&weakEls[0]!==favEl){
    var _wD=EL[weakEls[0]];
    if(_wD){var _wF=pick(_wD.food,1)[0]; if(_wF) dietX='，也可多吃 '+_wF+'（補'+weakEls[0]+'行不足）';}
  }
  var dietS={love:'約會可選有 ',career:'工作餐建議含 ',wealth:'飯局點菜加入 ',health:'日常飲食多吃 ',relationship:'聚餐可點 ',family:'家庭餐桌加入 '};
  actions.push('<strong>飲食：</strong>'+(dietS[type]||'日常多吃 ')+mf.join('、')+'，日常喝 <em>'+md+'</em> 調理氣色'+dietX);

  /* 6. 心態（塔羅×紫微×梅花走向 交叉辯證）*/
  var mindP=[];
  if(zwAction&&tarotAction){
    var _zA=/衝|行動|主動|執行|直接|爭取/.test(zwAction);
    var _tA=/衝|行動|主動|創造|全力/.test(tarotAction);
    var _zC=/穩|等|停|控制|細節|專注|少說/.test(zwAction);
    var _tC=/耐心|平衡|思考|留意|小心|角度/.test(tarotAction);
    if(_zA&&_tC) mindP.push('紫微說「'+zwAction+'」，塔羅提醒「'+tarotAction+'」→ 行動但保持節制');
    else if(_zC&&_tA) mindP.push('紫微說「'+zwAction+'」，塔羅說「'+tarotAction+'」→ 沉穩中找突破口');
    else mindP.push('紫微說「'+zwAction+'」，塔羅也說「'+tarotAction+'」→ 方向一致');
  } else if(zwAction){ mindP.push(zwAction);
  } else if(tarotAction){ mindP.push(tarotAction); }
  if(S.meihua&&S.meihua.bian){
    var _bn=S.meihua.bian.n;
    if(_bn.includes('泰')||_bn.includes('既濟')) mindP.push('卦象走向「'+_bn+'」，保持樂觀');
    else if(_bn.includes('否')||_bn.includes('未濟')) mindP.push('卦象走向「'+_bn+'」，耐心等待轉機');
  }
  if(!mindP.length){
    var _mM={love:strong?'感情中適度放軟，傾聽比表達更重要':'對自己多一點信心，你值得被好好對待。不要委屈自己遷就不適合的人',career:strong?'重點在「選對方向」而非「更努力」':'找值得信賴的前輩借力',wealth:strong?'別衝動，大筆支出先等24小時':'先存再花，不焦慮才不會做錯決定',health:'規律作息比任何補品都有效，'+favData.habit,relationship:strong?'多聽少說，真誠比圓滑更能贏得信任':'找到欣賞你的圈子深交',family:'多花時間陪伴，一頓用心的晚餐勝過千言萬語'};
    mindP.push(_mM[type]||_mM.career);
  }
  actions.push('<strong>心態：</strong>'+mindP.join('。'));

  /* 7. 提升（問題類型×五行×身強弱 差異化建議）*/
  var _bst={
    love:{s:'適度展現脆弱面反而更有吸引力。規律運動（推薦'+favData.sport.split('、')[0]+'），好氣色就是最強桃花',w:'提升自信是關鍵——從小事開始肯定自己。'+favData.habit+'，精神好了自然散發魅力'},
    career:{s:'多閱讀跨領域書籍擴大視野，'+(favEl==='火'?'領導力課程':'專業證照')+'能加速發展',w:'建立專業口碑比追求曝光重要。每天花30分鐘精進核心技能'},
    wealth:{s:'理財紀律比投資眼光重要。每月至少存收入的20%',w:'先建立緊急預備金（3-6個月開銷），有安全感才能做好財務決策'},
    health:{s:'底子不差但容易過度消耗。定期運動（推薦'+favData.sport.split('、')[0]+'），'+favData.habit,w:'循序漸進不要強度太高。'+favData.habit+'，飲食比運動更優先調整'},
    relationship:{s:'真誠比技巧重要。少批評多欣賞',w:'不需要融入所有圈子，找2-3個真正欣賞你的人深交'},
    family:{s:'少說教多傾聽，你的關心家人感受得到，方式可以更柔軟',w:'適時表達需求，坦誠溝通比默默付出更有效'}
  };
  var _bt=_bst[type]||_bst.career;
  actions.push('<strong>提升：</strong>'+(_bt[strong?'s':'w']||_bt.s));

  /* 8. 能量水晶（缺行×塔羅能量狀態）*/
  var _crN='';
  if(S.tarot&&S.tarot.drawn&&S.tarot.drawn.length>=10){
    var _uc=S.tarot.drawn.filter(function(c){return c.isUp;}).length;
    if(_uc<=4) _crN='，塔羅逆位偏多，能量場需額外補強';
    else if(_uc>=8) _crN='，能量場正面，水晶輔助維持';
  }
  actions.push('<strong>能量：</strong>佩戴 '+recData.crystal.join('、')+' 補強'+recEl+'行'+_crN);

  /* 9. 時機（大運+梅花變卦 交叉）*/
  var curDy=bazi.dayun?bazi.dayun.find(function(d){return d.isCurrent;}):null;
  var timingParts=[];
  if(curDy){
    if(/旺盛|極強|上升|大吉|中吉/.test(curDy.level)) timingParts.push('大運'+curDy.gz+'（'+curDy.level+'），外在助力充足');
    else if(/低迷|偏弱|大凶|中凶/.test(curDy.level)) timingParts.push('運勢蓄力中，不急著定下來');
    else timingParts.push('大運'+curDy.gz+'走平穩期');
  }
  if(S.meihua&&S.meihua.bian){
    var bGood2=['泰','大有','益','升','鼎','豐','既濟','乾','咸','恆'];
    var bBad2=['否','剝','困','蹇','未濟','損','明夷'];
    var bn2=S.meihua.bian.n;
    if(bGood2.some(function(g){return bn2.includes(g);})) timingParts.push('梅花變卦「'+bn2+'」走向正面');
    else if(bBad2.some(function(b){return bn2.includes(b);})) timingParts.push('梅花變卦「'+bn2+'」暗示需要耐心');
  }
  if(timingParts.length) actions.push('<strong>時機：</strong>'+timingParts.join('；'));


  var actionsEl = document.getElementById('r-actions');
  actionsEl.innerHTML = actions.filter(function(a){return a;}).map(function(a,i){return '<div class="action-item"><div class="action-num">'+(i+1)+'</div><div class="action-text">'+a+'</div></div>';}).join('');

  // 嵌入式水晶推薦 — 直接從缺行/喜用行的 REAL_PRODUCTS 抓
  const crystalEl = document.getElementById('r-action-crystal');
  try{
    // 直接取缺行對應的產品，不走 smartRecommend（避免喜用神覆蓋）
    let inlinePicks = (REAL_PRODUCTS[recEl]||[]).filter(p=> !avoidEls.has(p.el) || p.el==='全');
    if(inlinePicks.length===0) inlinePicks = (REAL_PRODUCTS[favEl]||[]);
    const recs = inlinePicks.slice(0,2);
    if(recs.length > 0){
      const p = recs[0];
      const shopUrl = p.shopee || 'https://tw.shp.ee/2n5Mo2w';
      crystalEl.innerHTML = `
        <div style="border-top:1px solid rgba(212,175,55,0.15);padding-top:var(--sp-md);margin-top:var(--sp-sm)">
          <p class="text-xs text-dim" style="margin-bottom:8px"><i class="fas fa-gem"></i> 根據你的命盤，最適合的能量水晶：</p>
          <a href="${shopUrl}" target="_blank" rel="noopener" class="inline-crystal">
            <span class="inline-crystal-icon">${getProductSVG(p.cat||'手鍊',p.n)}</span>
            <div class="inline-crystal-info">
              <div class="inline-crystal-name">${p.n}</div>
              <div class="inline-crystal-desc">${p.d ? p.d.substring(0,30)+'…' : p.el+'行能量水晶'}</div>
            </div>
            <span class="inline-crystal-price">${p.price||''}</span>
            <i class="fas fa-chevron-right inline-crystal-arrow"></i>
          </a>
          ${recs.length > 1 ? `<a href="${recs[1].shopee || shopUrl}" target="_blank" rel="noopener" class="inline-crystal" style="margin-top:6px">
            <span class="inline-crystal-icon">${getProductSVG(recs[1].cat||'手鍊',recs[1].n)}</span>
            <div class="inline-crystal-info">
              <div class="inline-crystal-name">${recs[1].n}</div>
              <div class="inline-crystal-desc">${recs[1].d ? recs[1].d.substring(0,30)+'…' : recs[1].el+'行能量水晶'}</div>
            </div>
            <span class="inline-crystal-price">${recs[1].price||''}</span>
            <i class="fas fa-chevron-right inline-crystal-arrow"></i>
          </a>` : ''}
          <div style="text-align:center;margin-top:var(--sp-sm)">
            <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener" class="text-xs" style="color:var(--c-gold)">
              查看更多適合你的水晶 →
            </a>
          </div>
        </div>`;
    }
  }catch(e){ console.error('inline crystal:', e); }

  // ── Quick Shop 快捷導購 ──
  try{
    const qs = document.getElementById('qs-products');
    const qsTitle = document.getElementById('qs-title');
    const qsSub = document.getElementById('qs-subtitle');
    if(qs){
      const ep = bazi.ep||{};
      const tot = Object.values(ep).reduce((a,b)=>a+b,0)||60;
      const weakEls = Object.entries(ep).filter(([e,v])=>(v/tot)<0.12).map(([e])=>e);
      const avoidEls = new Set(bazi.unfav||[]);

      // 核心修正：推薦邏輯 = 喜用神 + 調候用神（雙軌制）
      // 1. 喜用神五行 → 主推
      // 2. 調候用神 → 季節性急需（如冬木需火暖局）
      // 3. 缺行作為補充（排在後面）
      // 4. 忌神行 + 調候忌神 → 絕對排除
      let targetEls = [favEl]; // 喜用神為第一優先
      // 調候用神（如果跟喜用神不同，插入第二位）
      if(bazi.tiaohou && bazi.tiaohou.need){
        bazi.tiaohou.need.forEach(e => { if(!targetEls.includes(e) && !avoidEls.has(e)) targetEls.splice(1, 0, e); });
        // 調候忌神也要排除
        if(bazi.tiaohou.avoid) bazi.tiaohou.avoid.forEach(e => avoidEls.add(e));
      }
      // 安全缺行作為補充
      if(weakEls.length > 0){
        const safeWeakEls = weakEls.filter(e => !avoidEls.has(e));
        safeWeakEls.forEach(e => { if(!targetEls.includes(e)) targetEls.push(e); });
      }
      const typeAction={'love':'讓感情能量流動起來','career':'推一把你的事業運','wealth':'穩住你的財氣','health':'幫身體補能量','general':'平衡你的五行磁場','relationship':'提升人際好感度','family':'穩住家庭和諧能量'};
      if(weakEls.length > 0 || (bazi.tiaohou && bazi.tiaohou.need)){
        const thNote = bazi.tiaohou ? `（調候：${bazi.tiaohou.reason}）` : '';
        qsTitle.textContent = `你最需要的：${targetEls[0]}行能量${thNote}`;
        qsSub.textContent = typeAction[type]||('佩戴'+targetEls[0]+'行水晶日常補強');
      }else{
        qsTitle.textContent = `${favEl}行水晶 — ${typeAction[type]||'佩戴補強'}`;
        qsSub.textContent = '挑一條有眼緣的，日常戴著就有效';
      }

      // 從 REAL_PRODUCTS 直接抓對應五行的產品
      let picks = [];
      const seen2 = new Set();
      function addPick(item){
        if(seen2.has(item.n)) return;
        if(avoidEls.has(item.el) && item.el !== '全') return;
        seen2.add(item.n);
        picks.push(item);
      }

      // 優先：目標五行的產品
      targetEls.forEach(te => {
        (REAL_PRODUCTS[te]||[]).forEach(p => addPick(p));
      });
      // 補充：五行「全」的永遠可以
      (REAL_PRODUCTS.special||[]).filter(p=>p.el==='全').forEach(p=>addPick(p));
      // 再補：喜用神產品（如果目標行已不夠）
      if(picks.length < 5){
        (REAL_PRODUCTS[favEl]||[]).forEach(p => addPick(p));
      }

      // 價格多樣化：低中高各取
      if(picks.length > 5){
        const parseP = s => parseInt((s||'0').replace(/[^0-9]/g,''))||0;
        picks.sort((a,b)=>parseP(a.price)-parseP(b.price));
        const low = picks.filter(p=>parseP(p.price)<500).slice(0,2);
        const mid = picks.filter(p=>parseP(p.price)>=500&&parseP(p.price)<3000).slice(0,2);
        const high = picks.filter(p=>parseP(p.price)>=3000).slice(0,1);
        picks = [...low,...mid,...high];
        if(picks.length < 5){
          // 補到5個
          (REAL_PRODUCTS[targetEls[0]]||[]).forEach(p=>{
            if(picks.length<5 && !seen2.has(p.n+'_qs')){picks.push(p);seen2.add(p.n+'_qs');}
          });
        }
      }

      if(picks.length > 0){
        // 生成推薦理由 → 使用情境（成交語言）
        const SCENE_MAP={
          love:{'金':'談判場合穩住氣場','木':'約會增添親和力','水':'溝通時穩住情緒','火':'告白壯膽','土':'穩定關係不焦慮'},
          career:{'金':'面試/談判增強決斷','木':'創業找方向','水':'思考策略時佩戴','火':'業務衝刺用','土':'穩住根基不內耗'},
          wealth:{'金':'投資決策時佩戴','木':'開源找新機會','水':'理財規劃時冷靜','火':'抓風口要快狠準','土':'守財不漏'},
          health:{'金':'提升免疫防護力','木':'舒緩壓力放鬆','水':'助眠安神','火':'運動時增強活力','土':'腸胃調理接地氣'},
          general:{'金':'日常決策加持','木':'成長期隨身戴','水':'冥想靜心用','火':'需要行動力時戴','土':'穩定情緒接地氣'}
        };
        const scenes=SCENE_MAP[type]||SCENE_MAP.general;
        const getPickReason = (p) => {
          if(scenes[p.el]) return scenes[p.el];
          if(p.el === favEl) return '日常佩戴補'+favEl+'行';
          if(p.el === '全') return '全方位平衡';
          return '補'+p.el+'行能量';
        };
        qs.innerHTML = picks.slice(0,5).map(p => `
          <a href="${p.shopee||'https://tw.shp.ee/2n5Mo2w'}" target="_blank" rel="noopener" class="qs-item">
            <div class="qs-item-icon">${getProductSVG(p.cat||'手鍊',p.n)}</div>
            <div class="qs-item-name">${p.n}</div>
            <div class="qs-item-el"><span class="el-tag el-${p.el}" style="font-size:.6rem">${p.el}行</span></div>
            <div class="qs-item-reason" style="font-size:.55rem;color:var(--c-gold);margin-top:2px">★ ${getPickReason(p)}</div>
            <div class="qs-item-price">${p.price||''}</div>
          </a>
        `).join('');
      }
    }
  }catch(e){ console.error('quick shop:', e); }
}

function renderProductCrystal(bazi,type){
  const need=bazi.fav[0];
  const base=PRODUCT_DB[need]||PRODUCT_DB['土'];
  const special=TYPE_PRODUCTS[type]||[];
  const all=[...special,...base];
  const display=all.slice(0,4);

  document.getElementById('r-crystal').innerHTML=`
    <div class="crystal-rec-header">
      <p>根據你的命盤（喜 <span class="tag tag-gold">${need}行</span>）和問題（<span class="tag tag-blue">${getTypeLabel(type)}</span>），為你配對：</p>
    </div>
    <div class="product-grid">${display.map(p=>`
      <div class="product-card">
        <div class="product-icon">${getProductSVG(p.cat,p.n)}</div>
        <div class="product-body">
          <div class="product-name">${p.n}</div>
          <div class="product-meta">
            <span class="tag tag-gold text-xs">${catIcon[p.cat]||''} ${p.cat}</span>
            <span class="el-tag el-${p.el} text-xs">${p.el}行</span>
          </div>
          <p class="product-desc">${p.d}</p>
          <p class="product-price">${p.price}</p>
          <p class="product-wear"><i class="fas fa-hand-holding-heart"></i> ${p.wear}</p>
          <div class="product-actions">
            <a href="${p.shopee}" target="_blank" rel="noopener" class="product-btn shopee"><i class="fas fa-shopping-cart"></i> 蝦皮</a>
            <a href="${p.seven}" target="_blank" rel="noopener" class="product-btn seven"><i class="fas fa-box"></i> 7-11</a>
          </div>
        </div>
      </div>`).join('')}
    </div>
    <div class="custom-cta mt-lg">
      <button class="btn btn-gold btn-full" onclick="openCustomModal()">
        <i class="fas fa-magic"></i> 依你五行專屬搭配 ─ 點我客製
      </button>
      <p class="text-xs text-muted mt-sm text-center">預算版 $1,000 起 ｜ 48hr 內回覆</p>
    </div>
    <p class="text-xs text-muted mt-md text-center"><i class="fas fa-info-circle"></i> 本建議僅供能量校準參考，不具醫療或命運保證效力。</p>`;
}

/* =============================================================
   FEATURE 2: 結果圖卡 Canvas → 存圖（含 QR 對流）
   ============================================================= */
function generateResultCard(){
  const canvas=document.createElement('canvas');
  const W=750,H=1334; // IG story size
  canvas.width=W;canvas.height=H;
  const ctx=canvas.getContext('2d');

  // Background gradient
  const grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,'#2D0A0A');grad.addColorStop(0.5,'#4A0000');grad.addColorStop(1,'#0d0404');
  ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);

  // Decorative border
  ctx.strokeStyle='rgba(212,175,55,0.4)';ctx.lineWidth=3;
  ctx.strokeRect(24,24,W-48,H-48);
  ctx.strokeStyle='rgba(212,175,55,0.15)';ctx.lineWidth=1;
  ctx.strokeRect(36,36,W-72,H-72);

  // Header
  ctx.fillStyle='#D4AF37';ctx.font='bold 32px "Noto Serif TC",serif';ctx.textAlign='center';
  ctx.fillText('☽ 靜月之光能量占卜儀',W/2,80);
  ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.6)';
  ctx.fillText('你的專屬命理分析結果',W/2,115);

  // Divider
  drawGoldLine(ctx,60,140,W-60);

  // Question
  ctx.textAlign='left';ctx.font='bold 22px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('📋 問題',60,180);
  ctx.font='18px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.9)';
  wrapText(ctx,S.form.question||'綜合運勢',60,210,W-120,26);

  // Verdict
  const prob=document.getElementById('r-vprob')?document.getElementById('r-vprob').textContent:'50%';
  const label=document.getElementById('r-vlabel')?document.getElementById('r-vlabel').textContent:'分析中';
  const y1=290;
  ctx.fillStyle='rgba(212,175,55,0.1)';roundRect(ctx,48,y1-10,W-96,100,12);ctx.fill();
  ctx.strokeStyle='rgba(212,175,55,0.3)';ctx.stroke();
  ctx.font='bold 40px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';ctx.textAlign='center';
  ctx.fillText(prob,W/2,y1+35);
  ctx.font='20px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.85)';
  ctx.fillText(label,W/2,y1+70);

  // BaZi summary
  const y2=420;
  ctx.textAlign='left';ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('🏮 八字命理',60,y2);
  if(S.bazi){
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.8)';
    const p=S.bazi.pillars;
    ctx.fillText(`四柱：${p.year.gan}${p.year.zhi} ${p.month.gan}${p.month.zhi} ${p.day.gan}${p.day.zhi} ${p.hour.gan}${p.hour.zhi}`,60,y2+30);
    ctx.fillText(`日主：${S.bazi.dm}（${S.bazi.dmEl}）｜ 身${S.bazi.strong?'強':'弱'} ｜ 喜用：${S.bazi.fav.join('、')}`,60,y2+58);
    const curDy=S.bazi.dayun?S.bazi.dayun.find(d=>d.isCurrent):null;
    if(curDy)ctx.fillText(`當前大運：${curDy.gz}（${curDy.level}）`,60,y2+86);
  }

  // Five elements bar
  const y3=560;
  ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('🔮 五行能量',60,y3);
  if(S.bazi){
    const els=['金','木','水','火','土'];
    const colors={金:'#c0c0c0',木:'#22c55e',水:'#3b82f6',火:'#ef4444',土:'#a78b5a'};
    els.forEach((e,i)=>{
      const bx=60,by=y3+25+i*32,bw=W-200,pct=S.bazi.ep[e]||0;
      ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle=colors[e];
      ctx.fillText(e,bx,by+14);
      ctx.fillStyle='rgba(255,255,255,0.1)';roundRect(ctx,bx+30,by,bw,18,4);ctx.fill();
      ctx.fillStyle=colors[e];roundRect(ctx,bx+30,by,bw*pct/100,18,4);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.7)';ctx.fillText(pct+'%',bx+bw+40,by+14);
    });
  }

  // Crystal recommendation
  const y4=760;
  ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('💍 專屬水晶處方',60,y4);
  if(S.bazi){
    const need=S.bazi.fav[0];
    const prods=PRODUCT_DB[need]||PRODUCT_DB['土'];
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.85)';
    prods.slice(0,3).forEach((p,i)=>{
      ctx.fillText(`${catIcon[p.cat]||'💎'} ${p.n}（${p.cat}）— ${p.d}`,60,y4+30+i*28);
    });
  }

  // Meihua + Tarot summary
  const y5=880;
  if(S.meihua){
    ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
    ctx.fillText('☯ 梅花易數',60,y5);
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.8)';
    ctx.fillText(`${S.meihua.ben.n} → ${S.meihua.bian.n}｜體用${S.meihua.ty.r}（${S.meihua.ty.f}）`,60,y5+28);
  }
  if(S.tarot.drawn.length){
    const yt=y5+70;
    ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
    ctx.fillText('🃏 塔羅牌',60,yt);
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.8)';
    const core=S.tarot.drawn[0],fin=S.tarot.drawn[9];
    ctx.fillText(`核心：${core.n}（${core.isUp?'正':'逆'}）｜ 結果：${fin?fin.n:''}（${fin?(fin.isUp?'正':'逆'):''}）`,60,yt+28);
  }

  // Divider
  drawGoldLine(ctx,60,1060,W-60);

  // QR Code area (text-based since we can't load QR library)
  const yq=1090;
  ctx.fillStyle='rgba(255,255,255,0.05)';roundRect(ctx,W/2-160,yq,320,100,12);ctx.fill();
  ctx.strokeStyle='rgba(212,175,55,0.3)';ctx.stroke();
  ctx.font='bold 16px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';ctx.textAlign='center';
  ctx.fillText('🔍 免費測你的命理結果',W/2,yq+30);
  ctx.font='14px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.7)';
  ctx.fillText('靜月之光能量占卜儀',W/2,yq+55);
  ctx.font='12px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.5)';
  ctx.fillText(SITE_URL,W/2,yq+78);

  // Footer
  ctx.font='12px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.35)';
  ctx.fillText('🛒 蝦皮: tw.shp.ee/2n5Mo2w ｜ 📦 7-11賣貨便: 搜尋「靜月之光」',W/2,H-50);
  ctx.fillText(`生成時間：${new Date().toLocaleDateString('zh-TW')}`,W/2,H-30);

  return canvas;
}

function drawGoldLine(ctx,x1,y,x2){
  const g=ctx.createLinearGradient(x1,y,x2,y);
  g.addColorStop(0,'transparent');g.addColorStop(0.5,'rgba(212,175,55,0.6)');g.addColorStop(1,'transparent');
  ctx.strokeStyle=g;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(x1,y);ctx.lineTo(x2,y);ctx.stroke();
}

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

function wrapText(ctx,text,x,y,maxW,lineH){
  const chars=[...text];let line='';
  for(let i=0;i<chars.length;i++){
    const test=line+chars[i];
    if(ctx.measureText(test).width>maxW&&line){ctx.fillText(line,x,y);y+=lineH;line=chars[i]}
    else line=test;
  }
  if(line)ctx.fillText(line,x,y);
}

function saveResultCard(){
  try{
    const canvas=generateResultCard();
    canvas.toBlob(function(blob){
      if(!blob){alert('圖片生成失敗，請再試一次');return;}
      // Try native share first (mobile)
      if(navigator.share&&navigator.canShare){
        const file=new File([blob],'靜月占卜結果.png',{type:'image/png'});
        if(navigator.canShare({files:[file]})){
          navigator.share({title:'我的靜月占卜結果',text:'靜月之光幫我配了專屬能量水晶 ✨ 免費測你的運勢 👉 '+SITE_URL,files:[file]}).catch(()=>downloadBlob(blob));
          return;
        }
      }
      downloadBlob(blob);
    },'image/png');
  }catch(e){
    console.error('存圖錯誤:',e);
    alert('存圖失敗：'+e.message+'\n請確認已完成占卜分析');
  }
}

function downloadBlob(blob){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='靜月占卜結果_'+Date.now()+'.png';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),3000);
}

/* =============================================================
   FEATURE 3: 分享解鎖「再測一次」
   ============================================================= */
let hasShared=false;

function shareToUnlock(){
  /* 這個函數會被下方的 patch 覆蓋，保留作 fallback */
  const url=SITE_URL;
  const text='靜月之光幫我配了專屬能量水晶，分析超細 ✨ 免費測你的運勢 👉 ';
  if(!S.bazi){alert('請先完成占卜分析再分享哦！');return}
  if(navigator.share){
    navigator.share({title:'靜月之光占卜',text:text,url:url}).then(()=>{
      hasShared=true; updateShareGate();
    }).catch(()=>{
      showShareHint('💡 分享連結給朋友後即可解鎖，再試一次吧！');
    });
  }else{
    showCopyShareDialog(text+url);
  }
}

function showShareHint(msg){
  const gate = document.getElementById('share-gate');
  if(!gate) return;
  let hint = gate.querySelector('.share-hint-msg');
  if(!hint){
    hint = document.createElement('p');
    hint.className = 'share-hint-msg';
    hint.style.cssText = 'color:rgba(232,201,104,0.8);font-size:0.85rem;margin-top:0.5rem;';
    gate.appendChild(hint);
  }
  hint.textContent = msg;
  setTimeout(()=>{ if(hint) hint.textContent=''; }, 4000);
}

function showCopyShareDialog(text){
  function _doCopy(t){try{var ta=document.createElement('textarea');ta.value=t;ta.style.cssText='position:fixed;left:-9999px';document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);}catch(e){}}
  function _afterCopy(){
    var confirmed=confirm('分享連結已複製到剪貼簿！✨\n\n請貼到 LINE / IG / FB 分享給朋友。\n\n已經分享了嗎？按「確定」解鎖再測一次。');
    if(confirmed){hasShared=true;updateShareGate();}
    else{showShareHint('💡 分享連結給朋友後即可解鎖，再試一次吧！');}
  }
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(_afterCopy).catch(function(){_doCopy(text);_afterCopy();});
  }else{_doCopy(text);_afterCopy();}
}

function fallbackCopyShare(text){
  // Keep for backward compat but don't auto-unlock
  navigator.clipboard.writeText(text).catch(()=>{});
}

function updateShareGate(){
  const gate=document.getElementById('share-gate');
  const retestBtn=document.getElementById('btn-retest');
  if(gate&&retestBtn){
    if(hasShared){
      gate.classList.add('hidden');
      retestBtn.classList.remove('hidden');
      // 同時解鎖趣味功能
      unlockExtraFeatures();
      // 折扣碼區水晶推薦
      try{
        const recDiv=document.getElementById('discount-crystal-rec');
        if(recDiv && S.bazi){
          const recs=(typeof smartRecommend==='function')?smartRecommend(S.bazi,S.form.type||'career',3):[];
          if(recs.length>0){
            const p=recs[0];
            recDiv.innerHTML=`
              <p class="text-sm" style="color:var(--c-text-dim);margin-bottom:8px"><i class="fas fa-gem" style="color:var(--c-gold)"></i> 用折扣碼購買最適合你的水晶：</p>
              <div style="display:flex;align-items:center;gap:10px">
                <span style="font-size:1.5rem">${getProductSVG(p.cat||'手鍊',p.n)}</span>
                <div style="flex:1">
                  <div style="font-weight:600;color:var(--c-gold-light);font-size:.9rem">${p.n}</div>
                  <div class="text-xs text-dim">${p.d||''}</div>
                </div>
                <div style="font-weight:700;color:var(--c-gold)">${p.price||''}</div>
              </div>
              ${recs.length>1?`<div style="margin-top:6px;font-size:.78rem;color:var(--c-text-muted)">也推薦：${recs.slice(1,3).map(r=>r.n).join('、')}</div>`:''}`;
          }
        }
      }catch(e){}
    }
  }
}

function retestAfterShare(){
  hasShared=false;
  drawnCards=[];
  resetAll();
}
// 實際商品庫 — 依五行分類，取代表性品項（同名取價格帶）
const REAL_PRODUCTS = {
  金: [
    {n:'鐵膽石手排',cat:'手排',el:'金',d:'沉穩接地能量，增強意志力與穩定性',price:'$185',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'鐵膽石圓珠手鍊',cat:'手鏈',el:'金',d:'鐵膽護身，強化金行決斷力',price:'$185',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白龍宮舍利手鍊',cat:'手鏈',el:'金',d:'佛門聖物，淨化磁場、增強靈性',price:'$231',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白水晶手鍊',cat:'手鏈',el:'金',d:'萬能調和石，淨化能量場，增強思維清晰度',price:'$339',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'透石膏手鍊',cat:'手鏈',el:'金',d:'高頻淨化石，清理負能量，提升靈性直覺',price:'$358',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白水晶手排',cat:'手排',el:'金',d:'大顆粒排珠，淨化能量更強，適合辦公佩戴',price:'$396',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白幽靈手鍊',cat:'手鏈',el:'金',d:'淨化磁場，提升靈性直覺，增強專注力',price:'$396',wear:'冥想時佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'金曜石手鍊',cat:'手鏈',el:'金',d:'頂級辟邪石，金色光澤增強財運與氣場',price:'$416',wear:'右手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白阿賽設計款手鍊',cat:'手鏈',el:'金',d:'高頻水晶，靈性提升與淨化',price:'$420',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'銀曜項鍊（關公）',cat:'項鍊',el:'金',d:'關公護身，辟邪擋煞，增強正氣',price:'$492',wear:'出門佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'金曜項鍊（龍牌）',cat:'項鍊',el:'金',d:'龍牌護身符，氣場強大，事業亨通',price:'$492',wear:'出門佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'銀曜項鍊（九尾狐）',cat:'項鍊',el:'金',d:'九尾狐招桃花，增強魅力與人緣',price:'$492',wear:'出門佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'金髮晶手鍊',cat:'手鏈',el:'金',d:'招正財，增強領導力與自信',price:'$761',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'鈦晶手排',cat:'手排',el:'金',d:'招正財偏財首選！增強領導力與決斷力',price:'$3,334-$21,950',wear:'面試/簽約時佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白水晶鳳凰項鍊',cat:'項鍊',el:'金',d:'鳳凰涅槃，淨化+重生能量，收藏級項鍊',price:'$3,372',wear:'貼近心輪佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'銀曜石五行設計款手鍊',cat:'手鏈',el:'金',d:'五行平衡設計，全方位防護',price:'$3,622',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩色天鐵手鍊',cat:'手鏈',el:'金',d:'宇宙隕鐵能量，全方位防護與提升',price:'$4,548',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'天鐵五行設計款手鍊',cat:'手鏈',el:'金',d:'天鐵+五行水晶，量身打造能量組合',price:'$5,484',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'金太陽手鍊',cat:'手鏈',el:'金',d:'太陽般溫暖能量，招貴人、增自信',price:'$8,748-$21,325',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩色天鐵手排',cat:'手排',el:'金',d:'宇宙級能量手排，天鐵+彩色美感',price:'$10,308',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  木: [
    {n:'綠月光手鍊',cat:'手鏈',el:'木',d:'月光般柔和，安撫情緒、增強直覺',price:'$108',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'東陵玉手鍊',cat:'手鏈',el:'木',d:'療癒系綠石，穩定情緒、增強正能量',price:'$176',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠檀木手鍊',cat:'手鏈',el:'木',d:'天然檀木清香，安神定氣，適合修行佩戴',price:'$224-$492',wear:'隨身佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'沉香無事牌項鍊',cat:'項鍊',el:'木',d:'沉香安神定氣，無事牌寓意平安',price:'$492',wear:'貼近心輪',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠幽靈手鍊',cat:'手鏈',el:'木',d:'正財之石，事業穩步上升，聚財守財',price:'$684-$10,668',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠龍晶手鍊',cat:'手鏈',el:'木',d:'龍脈能量，增強事業運與領導力',price:'$1,068-$2,028',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠碧璽手鍊',cat:'手鏈',el:'木',d:'心輪之石，療癒情緒、增強包容力',price:'$1,644',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠水晶隨型手鍊',cat:'手鏈',el:'木',d:'隨形自然美，木行能量充沛',price:'$2,028',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'四季幽靈手排',cat:'手排',el:'木',d:'四季輪轉能量，全面平衡身心',price:'$2,988',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'老山檀香圓珠手鍊',cat:'手鏈',el:'木',d:'百年老山檀，安神定氣，修行者首選',price:'$3,756',wear:'隨身佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'抹茶幽靈手鍊',cat:'手鏈',el:'木',d:'稀有抹茶色幽靈，事業財運雙強化',price:'$8,748',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  水: [
    {n:'黑曜磨砂心經手鍊',cat:'手鏈',el:'水',d:'心經加持，辟邪擋煞，淨化負能量',price:'$204-$377',wear:'右手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍方解石手鍊',cat:'手鏈',el:'水',d:'清澈藍色，舒緩焦慮、增強表達力',price:'$300',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑曜磨砂心經（桶珠）手鍊',cat:'手鏈',el:'水',d:'桶珠款心經黑曜，辟邪能量加倍',price:'$300',wear:'右手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍磷灰手鍊',cat:'手鏈',el:'水',d:'激發潛能，增強學習力與專注力',price:'$396',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白松石x黑曜石設計款手鍊',cat:'手鏈',el:'水',d:'白松石安神+黑曜辟邪，雙重守護',price:'$400',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍玉髓手鍊',cat:'手鏈',el:'水',d:'喉輪之石，增強溝通力與自信表達',price:'$588',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑碧璽三圈手鍊',cat:'手鏈',el:'水',d:'頂級辟邪石，三圈加強防護能量',price:'$588',wear:'右手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫龍晶手鍊',cat:'手鏈',el:'水',d:'靈性提升，增強直覺與冥想品質',price:'$646',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彼得石手排',cat:'手排',el:'水',d:'暴風雨之石，增強勇氣與果斷力',price:'$681',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'鷹眼堇青石設計款手鍊',cat:'手鏈',el:'水',d:'鷹眼般銳利洞察力，提升判斷力',price:'$780',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'堇青石手鍊',cat:'手鏈',el:'水',d:'水手之石，指引方向、增強直覺',price:'$875',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑閃靈手鍊',cat:'手鏈',el:'水',d:'閃靈鑽能量，淨化+轉化負能量',price:'$1,798',wear:'右手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'海藍寶手鍊',cat:'手鏈',el:'水',d:'勇氣之石，增強溝通力與平靜心',price:'$2,028-$23,825',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍彼得算盤珠手鍊',cat:'手鏈',el:'水',d:'彼得石算盤珠款，智慧與勇氣並存',price:'$2,604',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'青晶石手鍊',cat:'手鏈',el:'水',d:'深邃藍色，增強洞察力與智慧',price:'$2,604',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑曜石貔貅雕刻件',cat:'雕刻件',el:'水',d:'貔貅招財辟邪，黑曜石能量加持',price:'$2,988',wear:'隨身攜帶或擺放',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'海藍寶手排',cat:'手排',el:'水',d:'大顆海藍寶，勇氣能量更強',price:'$2,988',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑髮手排',cat:'手排',el:'水',d:'黑髮晶辟邪擋煞，排除負能量首選',price:'$9,708-$16,620',wear:'右手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍彼得圓珠手鍊',cat:'手鏈',el:'水',d:'頂級彼得石，暴風雨能量守護',price:'$9,708',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  火: [
    {n:'粉晶手鍊',cat:'手鏈',el:'火',d:'愛情之石，招桃花、增強人緣與魅力',price:'$204',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'粉晶手排',cat:'手排',el:'火',d:'大顆粉晶，愛情能量加倍',price:'$272',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅龍宮舍利鼓珠手鍊',cat:'手鏈',el:'火',d:'佛門聖物鼓珠款，護身增運',price:'$281-$320',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅龍宮舍利手鍊',cat:'手鏈',el:'火',d:'佛門聖物，增強正氣與勇氣',price:'$297-$350',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'摩根石手鍊',cat:'手鏈',el:'火',d:'高頻愛情石，溫柔療癒，吸引真愛',price:'$300',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅瑪腦手鍊',cat:'手鏈',el:'火',d:'火行正能量，增強活力與行動力',price:'$300-$454',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'星光草苺晶手鍊',cat:'手鏈',el:'火',d:'星光閃爍，招正緣、增強愛情磁場',price:'$300-$454',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫金砂手鍊',cat:'手鏈',el:'火',d:'紫色星光閃耀，提升貴人運與魅力',price:'$339',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫黃白水設計款手鍊',cat:'手鏈',el:'火',d:'紫黃白三色水晶設計款，全面提升',price:'$400',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'摩根石設計款手鍊',cat:'手鏈',el:'火',d:'設計款摩根石，獨特美感+愛情能量',price:'$400',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅靈骸骨舍利手鍊',cat:'手鏈',el:'火',d:'稀有骸骨舍利，強力護身辟邪',price:'$431',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅幽靈設計款手鍊',cat:'手鏈',el:'火',d:'紅幽靈招財，設計款獨特美感',price:'$450',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅花碧玉手排',cat:'手排',el:'火',d:'天然紅花紋理，增強生命力與行動力',price:'$464',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅膠花設計款手鍊',cat:'手鏈',el:'火',d:'紅膠花水晶，獨特設計+火行能量',price:'$506',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫水晶三圈手鍊',cat:'手鏈',el:'火',d:'三圈紫水晶，智慧能量三倍提升',price:'$588',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩色草莓晶手鍊',cat:'手鏈',el:'火',d:'彩色草莓晶，增強桃花與人際魅力',price:'$608',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫水晶手鍊',cat:'手鏈',el:'火',d:'智慧之石，增強直覺、提升專注力與貴人運',price:'$875-$1,606',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'太陽花手排',cat:'手排',el:'火',d:'太陽花般綻放能量，增強自信與活力',price:'$1,387-$2,028',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'薔薇石手鍊',cat:'手鏈',el:'火',d:'療癒情傷，重建自信與自愛',price:'$1,798',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'煙花雨薔葳石手鍊',cat:'手鏈',el:'火',d:'如煙花般絢爛，增強魅力與吸引力',price:'$2,220',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'骨幹太陽石手鍊',cat:'手鏈',el:'火',d:'太陽般溫暖能量，驅散負面、增強正氣',price:'$2,777',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'月光石手鍊',cat:'手鏈',el:'火',d:'女性守護石，增強直覺與柔性能量',price:'$9,708',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'粉紅碧璽圓珠手鍊',cat:'手鏈',el:'火',d:'頂級粉紅碧璽，招正緣、增強愛情能量',price:'$13,548',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  土: [
    {n:'黃龍宮舍利手鍊',cat:'手鏈',el:'土',d:'佛門聖物，穩定磁場、增強財運',price:'$262-$423',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'阿拉善手鍊',cat:'手鏈',el:'土',d:'戈壁精華，穩定能量、增強接地力',price:'$281-$454',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'糖果碧璽手鍊',cat:'手鏈',el:'火',d:'繽紛碧璽，增強桃花魅力與正向能量',price:'$395-$18,825',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅虎眼手鍊',cat:'手鏈',el:'火',d:'紅色虎眼石，增強果斷力與熱情行動力',price:'$435',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'超八手鍊',cat:'手鏈',el:'全',d:'超級八面體，多礦物共生全能型能量石',price:'$454',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白水茶晶設計款手鍊',cat:'手鏈',el:'土',d:'白水晶+茶晶設計款，淨化+穩定',price:'$506',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'茶晶手鍊',cat:'手鏈',el:'土',d:'接地之石，穩定情緒、增強安全感',price:'$684-$742',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩銅超七手鍊',cat:'手鏈',el:'全',d:'含銅礦超七，七種礦物共生能量全面',price:'$972',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'波斯瑪腦設計款手鍊',cat:'手鏈',el:'火',d:'異域風情紅瑪腦，穩定情緒增強熱情',price:'$1,260',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩超七圓珠手鍊',cat:'手鏈',el:'全',d:'七種礦物共生，全面提升身心靈',price:'$1,387',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'利比亞黃金隕石手鍊',cat:'手鏈',el:'土',d:'隕石級能量，提升意志力與財運',price:'$1,644',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩虹黑曜石手鍊',cat:'手鏈',el:'水',d:'彩虹光辟邪，轉化負能量為正能量',price:'$1,882',wear:'右手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'咖啡鈦太陽花手排',cat:'手排',el:'土',d:'咖啡鈦+太陽花，招財+穩定雙效',price:'$2,988',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩閃靈手鍊',cat:'手鏈',el:'全',d:'彩色閃靈鑽，全頻譜能量淨化',price:'$4,908',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'阿富汗碧璽手鍊',cat:'手鏈',el:'火',d:'稀有阿富汗碧璽，強力補火提升正能量',price:'$5,484',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'多寶隕石手鍊',cat:'手鏈',el:'全',d:'多種隕石能量集合，宇宙級全方位防護',price:'$5,484',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩髮圓珠手鍊',cat:'手鏈',el:'全',d:'多色髮晶，招財+人緣+事業全面提升',price:'$5,868',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍虎眼手鍊',cat:'手鏈',el:'水',d:'藍色虎眼增強洞察力與決斷力',price:'$7,600',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩超七手鍊',cat:'手鏈',el:'全',d:'頂級彩超七，收藏級全能能量石',price:'$41,325',wear:'左手佩戴',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ]
}
/* =============================================================
   智慧推薦引擎 — 取代 PRODUCT_DB + TYPE_PRODUCTS
   根據：喜用神 × 問題類型 × 價格帶分佈 推薦最佳商品
   ============================================================= */
function smartRecommend(bazi, type, maxItems){
  maxItems = maxItems || 6;
  const need = bazi.fav[0]; // 喜用神第一位
  const need2 = bazi.fav[1]; // 喜用神第二位
  
  // ** 關鍵修正：取得忌神列表，排除忌神五行的商品 **
  const avoidEls = new Set();
  if(bazi.unfav){
    bazi.unfav.forEach(u => avoidEls.add(u));
  }
  
  const results = [];
  const seen = new Set();

  function isAllowed(item){
    // 五行「全」的商品永遠允許
    if(item.el === '全') return true;
    // 忌神五行的商品排除
    if(avoidEls.has(item.el)) return false;
    return true;
  }

  function add(item, priority){
    if(seen.has(item.n)) return;
    if(!isAllowed(item)) return; // 忌神排除
    seen.add(item.n);
    results.push({...item, _priority: priority||0});
  }

  // 1) 問題類型特殊推薦（最高優先，但仍受忌神過濾）
  if(type==='love'){
    (REAL_PRODUCTS.love_special||[]).forEach(p=>add(p,100));
    (REAL_PRODUCTS.necklace||[]).filter(p=>(p.tags||[]).includes('愛情')).forEach(p=>add(p,90));
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('愛情')).forEach(p=>add(p,85));
  }
  if(type==='career'){
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('事業')).forEach(p=>add(p,100));
    /* 鈦晶屬金，只有喜用神含金才推 */
    if(!avoidEls.has('金')) (REAL_PRODUCTS.金||[]).filter(p=>p.n.includes('鈦晶')).forEach(p=>add(p,95));
    /* 水行的黑髮晶也適合事業 */
    (REAL_PRODUCTS.水||[]).filter(p=>(p.tags||[]).includes('事業')).forEach(p=>add(p,90));
    (REAL_PRODUCTS.necklace||[]).filter(p=>(p.tags||[]).includes('事業')).forEach(p=>add(p,85));
  }
  if(type==='wealth'){
    /* 招財水晶要過忌神濾：黃水晶屬土、鈦晶屬金、綠幽靈屬木 */
    if(!avoidEls.has('土')) (REAL_PRODUCTS.土||[]).filter(p=>p.n.includes('黃水晶')).forEach(p=>add(p,100));
    if(!avoidEls.has('木')) (REAL_PRODUCTS.木||[]).filter(p=>p.n.includes('綠幽靈')||p.n.includes('抹茶')).forEach(p=>add(p,95));
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('財運')).forEach(p=>add(p,90));
    if(!avoidEls.has('金')) (REAL_PRODUCTS.金||[]).filter(p=>p.n.includes('鈦晶')).forEach(p=>add(p,85));
  }
  if(type==='health'){
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('健康')).forEach(p=>add(p,100));
    if(!avoidEls.has('火')) (REAL_PRODUCTS.火||[]).filter(p=>p.n.includes('紫水晶')).forEach(p=>add(p,95));
    if(!avoidEls.has('土')) (REAL_PRODUCTS.土||[]).filter(p=>p.n.includes('茶晶')).forEach(p=>add(p,85));
  }

  // 2) 喜用神五行商品（一定是安全的，因為喜用神不會是忌神）
  const elProducts = REAL_PRODUCTS[need] || [];
  elProducts.forEach(p => add(p, 70));
  if(need2 && REAL_PRODUCTS[need2]){
    REAL_PRODUCTS[need2].slice(0,3).forEach(p => add(p, 50));
  }

  // 3) 五行設計款 / 超七（全方位，el='全' 永遠允許）
  (REAL_PRODUCTS.special||[]).filter(p=>p.el==='全').forEach(p=>add(p,40));

  // 4) 辟邪類（凶的時候優先，也要過濾忌神）
  const prob = parseFloat((document.getElementById('r-vprob')||{}).textContent)||50;
  if(prob < 40){
    (REAL_PRODUCTS.protection||[]).forEach(p=>add(p,80));
  }

  // 5) 項鍊類補充（過濾忌神）
  (REAL_PRODUCTS.necklace||[]).forEach(p=>add(p,20));

  // Sort by priority desc, then pick top N
  results.sort((a,b)=>b._priority-a._priority);

  // Ensure price diversity: at least 1 under $500, 1 mid, 1 high
  const final = [];
  const low = results.filter(r=>{const p=parseFloat(r.price.replace(/[^0-9]/g,''));return p<=500});
  const mid = results.filter(r=>{const p=parseFloat(r.price.replace(/[^0-9]/g,''));return p>500&&p<=3000});
  const high = results.filter(r=>{const p=parseFloat(r.price.replace(/[^0-9]/g,''));return p>3000});

  if(low[0]) final.push(low[0]);
  if(mid[0]) final.push(mid[0]);
  if(high[0]) final.push(high[0]);

  // Fill remaining from sorted results
  results.forEach(r=>{
    if(final.length>=maxItems) return;
    if(!final.find(f=>f.n===r.n)) final.push(r);
  });

  return final.slice(0, maxItems);
}

/* Override renderProductCrystal to use smart recommend */
const _origRenderProductCrystal = typeof renderProductCrystal === 'function' ? renderProductCrystal : null;
renderProductCrystal = function(bazi, type){
  const need = bazi.fav[0];
  const products = smartRecommend(bazi, type, 6);

  document.getElementById('r-crystal').innerHTML = `
    <div class="crystal-rec-header">
      <p>根據你的命盤（喜用 <span class="tag tag-gold">${need}行</span>）和問題（<span class="tag tag-blue">${getTypeLabel(type)}</span>），從我們賣場精選：</p>
    </div>
    <div class="product-grid">${products.map(p=>`
      <div class="product-card">
        <div class="product-icon">${getProductSVG(p.cat,p.n)}</div>
        <div class="product-body">
          <div class="product-name">${p.n}</div>
          <div class="product-meta">
            <span class="tag tag-gold text-xs">${catIcon[p.cat]||'💍'} ${p.cat}</span>
            ${p.el!=='全'?`<span class="el-tag el-${p.el} text-xs">${p.el}行</span>`:'<span class="tag text-xs" style="background:linear-gradient(90deg,#c00,#fc0,#0a0,#08f,#a78b5a);color:#fff;-webkit-background-clip:text;-webkit-text-fill-color:transparent;border:1px solid rgba(212,175,55,.4)">五行全</span>'}
          </div>
          <p class="product-desc">${p.d}</p>
          <p class="product-price">${p.price}</p>
          <p class="product-wear"><i class="fas fa-hand-holding-heart"></i> ${p.wear}</p>
          <div class="product-actions">
            <a href="${p.shopee}" target="_blank" rel="noopener" class="product-btn shopee"><i class="fas fa-shopping-cart"></i> 蝦皮</a>
            <a href="${p.seven}" target="_blank" rel="noopener" class="product-btn seven"><i class="fas fa-box"></i> 7-11</a>
          </div>
        </div>
      </div>`).join('')}
    </div>
    <div class="custom-cta mt-lg">
      <button class="btn btn-gold btn-full" onclick="openCustomModal()">
        <i class="fas fa-magic"></i> 依你五行專屬搭配 ─ 點我客製
      </button>
      <p class="text-xs text-muted mt-sm text-center">預算版 $1,000 起 ｜ 48hr 內回覆 ｜ 含占卜分析摘要</p>
    </div>
    <p class="text-xs text-muted mt-md text-center"><i class="fas fa-info-circle"></i> 以上商品皆為賣場現貨。點擊蝦皮或7-11直接選購，水晶效果因人而異。</p>`;
};
/* =============================================================
   1) 商品卡「限時提醒」— 庫存數 + 今日N人看遍
   ============================================================= */
function getUrgencyHTML(productName){
  // Removed fake stock/view counts - only show if real data available
  return '';
}

/* =============================================================
   2) 社會認同數據
   ============================================================= */
function getSocialProofHTML(element, type){
  // Removed fabricated statistics - return empty until real data available
  return '';
}

/* =============================================================
   3) 首頁計數器 + 跑馬燈
   ============================================================= */
function initLiveCounter(){
  // Counter removed - no real statistics available
}

/* =============================================================
   4) 分享後顯示專屬折扣碼（真實蝦皮折扣碼）
   ============================================================= */
/* 折扣碼以混淆形式存放，防止直接從原始碼複製 */
/* 折扣碼以數值混淆形式存放 */
const _dc=[
  [68,56,51,75,71,71,74,55,55],
  [68,56,51,75,74,77,92,56,56],
  [68,56,51,75,82,78,55,58,52],
  [68,56,51,75,90,90,73,55,56],
  [68,56,51,75,86,73,58,59,53],
  [68,56,51,75,92,75,73,58,59],
  [68,56,51,75,86,73,59,58,59],
  [68,56,51,75,88,77,56,58,55],
  [68,56,51,75,72,54,54,54],
  [68,56,51,75,72,56,56,53]
];
function _dd(a){return a.map(c=>String.fromCharCode(c-3)).join('')}

function generateDiscountCode(){
  /* 每位用戶只能拿到一個碼，綁定瀏覽器指紋 */
  const fp = navigator.userAgent.length + screen.width + screen.height;
  const idx = fp % _dc.length;
  return _dd(_dc[idx]);
}

// ── 分享後解鎖趣味功能 ──
function unlockExtraFeatures(){
  const locked = document.getElementById('extra-locked');
  const unlocked = document.getElementById('extra-unlocked');
  if(locked) locked.style.display = 'none';
  if(unlocked) unlocked.style.display = 'block';
  // 記住已解鎖
  try{ localStorage.setItem('jy_extra_unlocked','1'); }catch(e){}
}
// 頁面載入時檢查是否之前已解鎖
try{
  if(localStorage.getItem('jy_extra_unlocked')==='1'){
    document.addEventListener('DOMContentLoaded',()=>{ unlockExtraFeatures(); applyPlainModeOnBoot(); });
  }
}catch(e){}

function showDiscountAfterShare(){
  const el = document.getElementById('discount-reveal');
  if(!el) return;
  
  /* 防護：同一裝置 24 小時內只能領一次 */
  const lastClaim = localStorage.getItem('jy_last_claim');
  const now = Date.now();
  if(lastClaim && (now - parseInt(lastClaim)) < 86400000){
    const hrs = Math.ceil((86400000 - (now - parseInt(lastClaim))) / 3600000);
    alert('你已經領過折扣碼了！\n\n' + hrs + ' 小時後可再次領取。');
    // 即使領過碼，也解鎖趣味功能
    unlockExtraFeatures();
    return;
  }
  
  el.classList.remove('hidden');
  
  // 解鎖趣味功能
  unlockExtraFeatures();
  
  /* 延遲顯示：先遮罩，倒數 5 秒後才揭示完整碼 */
  const code = generateDiscountCode();
  const codeEl = document.getElementById('discount-code');
  const masked = code.slice(0,4) + '•••••';
  codeEl.textContent = masked;
  codeEl.style.opacity = '0.5';
  
  let countdown = 5;
  const timer = document.getElementById('discount-timer');
  if(timer) timer.textContent = countdown + ' 秒後顯示完整折扣碼';
  
  const iv = setInterval(()=>{
    countdown--;
    if(timer) timer.textContent = countdown + ' 秒後顯示完整折扣碼';
    if(countdown <= 0){
      clearInterval(iv);
      codeEl.textContent = code;
      codeEl.style.opacity = '1';
      if(timer) timer.textContent = '折扣碼已解鎖！請在蝦皮結帳時輸入';
      localStorage.setItem('jy_last_claim', String(Date.now()));
    }
  }, 1000);
}

function copyDiscountCode(){
  const code = document.getElementById('discount-code').textContent;
  navigator.clipboard.writeText(code).then(()=>{
    alert('折扣碼已複製！去蝦皮下單時貼上即可使用 ✨');
  }).catch(()=>{
    prompt('複製此折扣碼：', code);
  });
}

// Patch shareToUnlock — 強化分享驗證
const _origShareToUnlock = shareToUnlock;
let _shareAttempts = 0;
shareToUnlock = function(){
  const url = SITE_URL;
  const text = '靜月之光幫我配了專屬能量水晶，分析超細 ✨ 免費測你的運勢 👉 ';
  
  /* 防護：必須完成占卜才能分享（防機器人直接觸發） */
  if(!S.bazi){
    alert('請先完成占卜分析再分享哦！');
    return;
  }
  
  // 手機版：用系統分享
  if(navigator.share && /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)){
    navigator.share({title:'靜月之光占卜',text:text,url:url}).then(()=>{
      hasShared=true; updateShareGate(); showDiscountAfterShare();
      if(typeof incrementAchievement==='function') incrementAchievement('shares',1);
    }).catch(()=>{
      // 使用者取消 → 不顯示負面訊息，改用友善提示
      const gate = document.getElementById('extra-features-gate');
      if(gate){
        let hint = gate.querySelector('.share-hint-temp');
        if(!hint){
          hint = document.createElement('p');
          hint.className = 'share-hint-temp';
          hint.style.cssText = 'color:var(--c-gold);font-size:0.85rem;margin-top:0.5rem;';
          gate.appendChild(hint);
        }
        hint.textContent = '💡 分享連結給朋友後即可解鎖，再試一次吧！';
        setTimeout(()=>{ if(hint) hint.textContent=''; }, 4000);
      }
    });
  }else{
    /* 桌面版：複製連結 + 確認 (多重 fallback) */
    var _shareText=text+url;
    function _doShareOK(){
      hasShared=true; updateShareGate(); showDiscountAfterShare();
      if(typeof incrementAchievement==='function') incrementAchievement('shares',1);
    }
    function _doShareConfirm(){
      var ok=confirm('分享連結已複製到剪貼簿！✨\n\n請貼到 LINE / IG / FB 分享給朋友。\n\n已經分享了嗎？按「確定」解鎖折扣碼＋趣味功能。');
      if(ok) _doShareOK();
    }
    function _copyFallback(){
      var ta=document.createElement('textarea');ta.value=_shareText;ta.style.cssText='position:fixed;left:-9999px';
      document.body.appendChild(ta);ta.select();try{document.execCommand('copy');}catch(e){}document.body.removeChild(ta);
      _doShareConfirm();
    }
    try{
      if(navigator.clipboard&&navigator.clipboard.writeText){
        navigator.clipboard.writeText(_shareText).then(_doShareConfirm).catch(_copyFallback);
      }else{_copyFallback();}
    }catch(e){prompt('複製以下連結分享給朋友：',_shareText);_doShareOK();}
  }
};

/* =============================================================
   5) PWA 安裝提示橫幅
   ============================================================= */
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', function(e){
  e.preventDefault();
  deferredInstallPrompt = e;
  showPWABanner();
});

function showPWABanner(){
  const banner = document.getElementById('pwa-banner');
  if(!banner) return;
  if(sessionStorage.getItem('pwa_dismissed')) return;
  banner.classList.remove('hidden');
  // Auto dismiss after 8 seconds
  setTimeout(()=>hidePWABanner(), 8000);
}

function installPWA(){
  if(deferredInstallPrompt){
    deferredInstallPrompt.prompt();
    deferredInstallPrompt.userChoice.then(function(choice){
      if(choice.outcome==='accepted') console.log('PWA installed');
      deferredInstallPrompt = null;
      hidePWABanner();
    });
  }else{
    // iOS fallback
    alert('請點擊瀏覽器的「分享」按鈕 → 選擇「加入主畫面」即可安裝！');
    hidePWABanner();
  }
}

function hidePWABanner(){
  const banner = document.getElementById('pwa-banner');
  if(banner) banner.classList.add('hidden');
  sessionStorage.setItem('pwa_dismissed','1');
}

/* =============================================================
   6) AI 風格個人化總結
   ============================================================= */
function generateAIConclusion(type, prob, bazi, mh, tarot){
  const name = S.form.name || '你';
  const dm = bazi ? bazi.dm : '';
  const dmEl = bazi ? bazi.dmEl : '';
  const strong = bazi ? bazi.strong : true;
  const fav = bazi ? bazi.fav[0] : '';
  const curDy = bazi&&bazi.dayun ? (bazi.dayun.find(d=>d.isCurrent)||{}) : {};
  const tl = getTypeLabel(type);

  // Opening — personal touch
  let lines = [];
  if(name!=='你') lines.push(`${name}，看完你的命盤，我想跟你說幾句真心話。`);
  else lines.push(`看完你的命盤，我想跟你說幾句真心話。`);

  // BaZi personality insight
  if(bazi){
    const personality = {
      甲:'你像一棵大樹，外表堅定但內心渴望陽光。',
      乙:'你像柔軟的藤蔓，看似溫柔實則韌性十足。',
      丙:'你像太陽一樣溫暖，天生就有感染力。',
      丁:'你像燭光般細膩，善於觀察與照顧他人。',
      戊:'你像大山一樣穩重，值得信賴但有時太固執。',
      己:'你像田園沃土，包容性強但容易委屈自己。',
      庚:'你像寶劍般果斷，做事乾脆但有時太急。',
      辛:'你像珠寶般精緻，追求完碧但容易想太多。',
      壬:'你像大海般寬廣，想法多但容易分散精力。',
      癸:'你像細雨般溫潤，直覺強但容易猶豫不決。'
    };
    lines.push(personality[dm]||'');
    lines.push(`身${strong?'強':'弱'}的你，${strong?'能量充沛，但要注意別太衝動':'需要更多支持，適合借力使力'}。`);
  }

  // Current situation reading (基於維度辯證，用人話)
  const _aiDir=S._verdictDir||'mid';
  const _aiV=S._verdicts||[];
  const _aiPos=_aiV.filter(v=>v.dir==='pos'), _aiNeg=_aiV.filter(v=>v.dir==='neg');
  if(_aiDir==='pos'&&_aiNeg.length===0){
    lines.push('現在的你確實站在一個好位置上。條件和時機都配合，各方面的訊號一致偏正面。');
    lines.push('但好運不是等來的——是你準備好了，機會才看得見你。');
  }else if(_aiDir==='pos'||(_aiPos.length>0&&_aiPos.length>=_aiNeg.length)){
    lines.push('整體偏正面，但不是毫無阻力。'+tl+'這件事方向是對的，把握節奏很重要。');
    lines.push('我的建議是：大膽往前，但不要急躁，邊走邊調整。');
  }else if(_aiDir==='neg'&&_aiPos.length===0){
    lines.push('我必須坦白說，目前的時機不太支持你在'+tl+'上大動作。');
    lines.push('這不代表你不好——是時機還沒到。與其硬拼，不如先調整狀態，等更好的時機再出手。');
  }else{
    lines.push('說實話，你現在的狀況是「有機會但有阻力」。有些條件到位了，但也有些面向還差一點。');
    lines.push('我的建議是：不要全押，先小範圍試水溫，有正向回饋再放大。');
  }

  // 當下能量（梅花翻譯成人話）
  if(mh){
    const rel=mh.ty.r;
    if(rel==='用生體') lines.push('當下的能量場對你有利——外在的人和環境會主動幫你，順勢而為就好。');
    else if(rel==='體生用') lines.push('當下你付出比較多，回報會慢一點。不要急，種子需要時間發芽。');
    else if(rel==='用克體') lines.push('當下有外在壓力在阻礙你。不是你不夠好，是環境還沒配合。先穩住。');
    else if(rel==='體克用') lines.push('你有掌控局面的能力，但需要主動出擊，不要等機會來找你。');
    else lines.push('當下的狀況穩定，不會有太大波動，維持現狀就好。');
  }

  // 心態面（塔羅翻譯成人話）
  if(tarot && tarot.drawn && tarot.drawn.length>=10){
    const d=tarot.drawn;
    const subcon=d[2], conscious=d[4], self=d[6], env=d[7], outcome=d[9];
    // 心理矛盾
    if(subcon.isUp!==conscious.isUp){
      lines.push('有一個值得注意的地方：你嘴上說的和心裡真正想的可能不一樣。先搞清楚自己到底要什麼，比做什麼決定都重要。');
    }
    // 現實條件
    if(!self.isUp) lines.push('你目前的心理狀態不是最佳——需要先調整好自己再行動，不然容易判斷失準。');
    if(!env.isUp) lines.push('外在環境不太配合，這不是你能控制的。有心理準備就好，不要太自責。');
    // 結果
    if(outcome.isUp) lines.push('照目前的路線走下去，結果是正面的。堅持住。');
    else lines.push('如果不調整策略，結果可能不如預期。但記住——這不是命定的，你的每一個選擇都能改變走向。');
  }

  // 星盤層面（西洋占星人話版）
  if(S.natal){
    const np=S.natal.planets;
    const gA=S.natal.aspects.filter(a=>a.good).length;
    const bA=S.natal.aspects.filter(a=>!a.good).length;
    if(type==='love'||type==='relationship'){
      const venH=np['金星'].house;
      if([5,7].includes(venH)) lines.push('從星盤來看，你的金星位置利桃花，天生有吸引異性的能力。但吸引到不等於留得住，經營感情需要智慧。');
      else if([12,8].includes(venH)) lines.push('你的感情模式偏深沉，不喜歡淺層的社交。對的人會懂你，不需要勉強自己變外向。');
    } else if(type==='career'){
      lines.push(`你的天頂在${S.natal.mcSign.name}座，職業方向適合${S.natal.mcSign.name}特質的領域。找到跟自己星盤共振的方向，事半功倍。`);
    } else if(type==='wealth'){
      const jupH=np['木星'].house;
      if([2,8,11].includes(jupH)) lines.push('木星在財富相關宮位，你有財運天賦。但天賦需要行動來啟動。');
    }
    if(gA>bA+2) lines.push('星盤整體吉相位較多，能量層面支持你。');
    else if(bA>gA+2) lines.push('星盤挑戰相位偏多，但這也代表你有更多成長的機會。壓力是最好的老師。');
  }

  // Crystal advice as personal recommendation
  if(fav){
    lines.push(`最後，如果你想從能量層面幫自己一把，我建議你佩戴${fav}行的水晶。不是迷信，是給自己一個「提醒物」— 每次看到手上的水晶，就想起今天的決定和方向。`);
  }

  // Closing
  const closings = [
    '記住，命理是方向盤，不是定速巡航。方向對了，速度由你決定。',
    '最後送你一句：盡人事，聽天命。你已經在「盡人事」了，這很好。',
    '命盤是地圖，路還是你自己走的。加油。',
    '做好準備，然後相信自己的判斷。祝一切順利 ✨'
  ];
  lines.push(closings[Math.floor(Math.random()*closings.length)]);

  return lines.filter(l=>l).map(l=>`<p>${l}</p>`).join('');
}

/* =============================================================
   7) 7天後提醒再測（日曆事件）
   ============================================================= */
/* =============================================================
   8) 回饋系統：評分 + 診斷包 + Google Forms 自動提交
   ============================================================= */

// ── 產生診斷包（把所有計算結果打包成文字）──
function generateDiagnosticPack(){
  const b=S.bazi, mh=S.meihua, tr=S.tarot, zw=S.ziwei;
  const V=S._verdicts||[];
  const q=S.form?S.form.question:'';
  const type=S.form?S.form.type:'';
  let pack=[];

  pack.push('═══ 靜月之光 診斷包 ═══');
  pack.push('時間：'+new Date().toLocaleString('zh-TW'));
  pack.push('問題：'+q);
  pack.push('類型：'+({'love':'感情','career':'事業','wealth':'財運','health':'健康','general':'綜合','relationship':'人際','family':'家庭'}[type]||type));
  pack.push('');

  // 八字
  if(b){
    const dy=b.dayun?b.dayun.find(d=>d.isCurrent):null;
    const ln=dy&&dy.liuNian?dy.liuNian.find(l=>l.year===new Date().getFullYear()):null;
    pack.push('─── 八字 ───');
    pack.push('日主：'+b.dm+' / '+b.dmEl+'行 / 身'+(b.strong?'強':'弱'));
    pack.push('喜用：'+(b.fav||[]).join('、')+' / 忌：'+(b.unfav||[]).join('、'));
    if(dy) pack.push('大運：'+dy.gz+'（'+dy.level+'）');
    if(ln) pack.push('流年：'+ln.gz+'（'+ln.level+'）'+(ln.events&&ln.events.length?' '+ln.events[0]:''));
    if(b.shensha) pack.push('神煞：'+b.shensha.join('、'));
  }

  // 紫微
  if(zw){
    pack.push('');
    pack.push('─── 紫微 ───');
    const ming=zw.palaces&&zw.palaces[0]?zw.palaces[0].stars.filter(s=>s.type==='major'):[];
    if(ming.length) pack.push('命宮：'+ming.map(s=>s.name+(s.bright?'('+s.bright+')':'')+(s.hua?' '+s.hua:'')).join('、'));
    const gI={love:2,career:8,wealth:4,health:5,family:9,relationship:7}[type];
    if(gI!==undefined&&zw.palaces&&zw.palaces[gI]){
      const gN=['命宮','兄弟','夫妻','子女','財帛','疾厄','遷移','交友','官祿','田宅','福德','父母'][gI]||'';
      const gs=zw.palaces[gI].stars||[];
      pack.push(gN+'：'+gs.slice(0,6).map(s=>s.name+(s.bright?'('+s.bright+')':'')+(s.hua?' '+s.hua:'')).join('、'));
    }
    const dx=zw.daXian?zw.daXian.find(d=>d.isCurrent):null;
    if(dx) pack.push('大限：'+dx.palaceName+'（'+dx.level+'）'+(dx.theme?' 主題:'+dx.theme:''));
    if(zw.getLiuNianZw){
      try{
        const lnzw=zw.getLiuNianZw(new Date().getFullYear());
        if(lnzw) pack.push('流年：命宮走'+lnzw.mingPalace+(lnzw.focus?' 重點:'+lnzw.focus:''));
      }catch(e){}
    }
  }

  // 梅花
  if(mh){
    pack.push('');
    pack.push('─── 梅花 ───');
    pack.push('本卦：'+mh.ben.n+' → 變卦：'+mh.bian.n);
    pack.push('體用：'+mh.ty.r+'（'+mh.ty.f+'）');
    if(mh.hu) pack.push('互卦：'+mh.hu.n);
    pack.push('動爻：第'+mh.dong+'爻');
  }

  // 塔羅
  if(tr&&tr.drawn&&tr.drawn.length>=10){
    pack.push('');
    pack.push('─── 塔羅（凱爾特十字）───');
    const pos=['核心','阻礙','過去','未來','結果','近期','自身','環境','希望恐懼','最終'];
    tr.drawn.slice(0,10).forEach((c,i)=>{
      pack.push(pos[i]+'：'+c.n+(c.isUp?' 正':' 逆'));
    });
  }

  // 星盤
  if(S.natal){
    pack.push('');
    pack.push('─── 西洋星盤 ───');
    pack.push(S.natal.summary);
    pack.push('ASC '+S.natal.ascSign.name+Math.floor(S.natal.ascSign.deg)+'° MC '+S.natal.mcSign.name+Math.floor(S.natal.mcSign.deg)+'°');
    const np=S.natal.planets;
    ['太陽','月亮','水星','金星','火星','木星','土星'].forEach(function(n){
      if(np[n]) pack.push(n+'：'+np[n].sign+Math.floor(np[n].signDeg)+'° '+np[n].house+'宮');
    });
    const gA=S.natal.aspects.filter(function(a){return a.good}).length;
    const bA=S.natal.aspects.filter(function(a){return !a.good}).length;
    pack.push('相位：吉'+gA+' 凶'+bA);
  }

  // 維度判斷
  if(V.length){
    pack.push('');
    pack.push('─── 維度判斷 ───');
    V.forEach(v=>{
      pack.push(v.dim+'：'+v.dir+' → '+v.verdict);
    });
    pack.push('整體：'+(S._verdictDir||'mid'));
  }

  // 系統輸出
  pack.push('');
  pack.push('─── 系統輸出 ───');
  const hookEl=document.getElementById('r-hook');
  if(hookEl) pack.push('Hook：'+hookEl.textContent.substring(0,200));
  const narrEl=document.querySelector('#r-conclusion')?.closest('.card')?.querySelector('p:nth-child(2)');
  // Try to get narrative text
  const allP=document.querySelectorAll('#step-3 p');
  let narrativeText='';
  allP.forEach(p=>{
    const t=p.textContent;
    if(t.length>50&&!t.includes('八字')&&!t.includes('紫微')&&!t.includes('梅花')&&!narrativeText){
      narrativeText=t.substring(0,200);
    }
  });
  if(narrativeText) pack.push('Narrative：'+narrativeText);

  // 水晶
  const crystalEl=document.querySelector('[id*="crystal"]')||document.querySelector('.crystal-name');
  if(crystalEl) pack.push('水晶推薦：'+crystalEl.textContent);

  return pack.join('\n');
}

// ── 複製診斷包 ──
function copyDiagnosticPack(){
  const pack=generateDiagnosticPack();
  if(navigator.clipboard){
    navigator.clipboard.writeText(pack).then(()=>{
      const btn=event.target;
      btn.textContent='✅ 已複製！';
      setTimeout(()=>{btn.textContent='📋 複製診斷包（開發用）';},2000);
    });
  } else {
    // fallback
    const ta=document.createElement('textarea');
    ta.value=pack;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert('已複製到剪貼簿！');
  }
}

// ── 評分按鈕 ──
let _fbRating='';
function submitFeedback(rating){
  _fbRating=rating;
  const goodBtn=document.getElementById('fb-good');
  const badBtn=document.getElementById('fb-bad');
  if(rating==='good'){
    goodBtn.style.border='2px solid #22c55e';
    goodBtn.style.background='rgba(34,197,94,0.15)';
    badBtn.style.opacity='0.3';
    badBtn.style.pointerEvents='none';
    _sendFeedbackToForms(rating,[],'');
    document.getElementById('fb-reason-box').style.display='none';
    document.getElementById('fb-thanks').style.display='block';
  } else {
    badBtn.style.border='2px solid #ef4444';
    badBtn.style.background='rgba(239,68,68,0.15)';
    goodBtn.style.opacity='0.3';
    goodBtn.style.pointerEvents='none';
    document.getElementById('fb-reason-box').style.display='block';
  }
}

// ── 送出不準原因 ──
function submitFeedbackDetail(){
  const checks=document.querySelectorAll('#fb-reasons input:checked');
  const reasons=Array.from(checks).map(c=>c.value);
  const comment=document.getElementById('fb-comment').value||'';
  _sendFeedbackToForms('bad',reasons,comment);
  document.getElementById('fb-reason-box').style.display='none';
  document.getElementById('fb-thanks').style.display='block';
}

// ── Google Forms 靜默提交 ──
function _sendFeedbackToForms(rating,reasons,comment){
  const FORM_URL='https://docs.google.com/forms/d/e/1FAIpQLScy7dai3NRsoEcHnQbbPmu_tdO7-M1o47BQYhFRnrcOKgQkEw/formResponse';
  
  const q=S.form?S.form.question:'';
  const type=S.form?S.form.type:'';
  const pack=generateDiagnosticPack();
  const reasonStr=Array.isArray(reasons)?reasons.join('、'):(reasons||'');

  // 永遠存一份到 localStorage（備份）
  try{
    const stored=JSON.parse(localStorage.getItem('jy_feedback')||'[]');
    stored.push({ts:new Date().toISOString(),rating,question:q,type,reasons:reasonStr,comment,pack});
    if(stored.length>100) stored.splice(0,stored.length-100);
    localStorage.setItem('jy_feedback',JSON.stringify(stored));
  }catch(e){}

  // Google Forms 提交
  try{
    const fd=new FormData();
    fd.append('entry.58291651', rating||'unknown');
    fd.append('entry.594815381', q||'(空)');
    fd.append('entry.992906923', type||'(空)');
    fd.append('entry.1912010772', reasonStr||'(無)');
    fd.append('entry.954354158', comment||'(無)');
    fd.append('entry.619318702', pack||'(無資料)');
    fetch(FORM_URL,{method:'POST',mode:'no-cors',body:fd})
      .then(()=>console.log('[回饋] 已送出到 Google Forms'))
      .catch(e=>console.error('[回饋] 送出失敗:',e));
  }catch(e){
    console.error('Feedback submit error:',e);
  }
}

// ── 結果頁顯示時自動顯示回饋區 ──
function showFeedbackSection(){
  const fb=document.getElementById('feedback-section');
  if(fb) fb.style.display='block';
  // 重置狀態
  document.getElementById('fb-good').style.opacity='1';
  document.getElementById('fb-good').style.pointerEvents='auto';
  document.getElementById('fb-good').style.border='2px solid rgba(255,255,255,0.1)';
  document.getElementById('fb-good').style.background='none';
  document.getElementById('fb-bad').style.opacity='1';
  document.getElementById('fb-bad').style.pointerEvents='auto';
  document.getElementById('fb-bad').style.border='2px solid rgba(255,255,255,0.1)';
  document.getElementById('fb-bad').style.background='none';
  document.getElementById('fb-reason-box').style.display='none';
  document.getElementById('fb-thanks').style.display='none';
  document.getElementById('fb-diag-wrap').style.display='none';
}

// 連點感謝文字3次 → 顯示診斷包按鈕（開發者用）
(function(){
  let tapCount=0,tapTimer=null;
  document.addEventListener('click',function(e){
    if(e.target.closest('#fb-thanks')){
      tapCount++;
      clearTimeout(tapTimer);
      tapTimer=setTimeout(()=>{tapCount=0;},1000);
      if(tapCount>=3){
        tapCount=0;
        const wrap=document.getElementById('fb-diag-wrap');
        if(wrap) wrap.style.display='block';
      }
    }
  });
})();

function addReminder7Days(){
  const now = new Date();
  const remind = new Date(now.getTime() + 7*24*60*60*1000);
  const fmt = d => d.toISOString().replace(/[-:]/g,'').replace(/\.\d+/,'');

  const icsContent = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//靜月之光//占卜提醒//ZH',
    'BEGIN:VEVENT',
    'DTSTART:' + fmt(remind),
    'DTEND:' + fmt(new Date(remind.getTime()+30*60*1000)),
    'SUMMARY:⏰ 靜月之光：該回來測一下運勢了！',
    'DESCRIPTION:上次測的結果已經過了7天，運勢可能有變化。\\n免費再測一次：' + SITE_URL,
    'URL:' + SITE_URL,
    'TRANSP:TRANSPARENT',
    'BEGIN:VALARM',
    'TRIGGER:-PT10M',
    'ACTION:DISPLAY',
    'DESCRIPTION:靜月之光占卜提醒',
    'END:VALARM',
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');

  const blob = new Blob([icsContent], {type:'text/calendar;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = '靜月占卜提醒.ics';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),3000);

  // Visual feedback
  const btn = document.getElementById('btn-remind');
  if(btn){
    btn.innerHTML = '<i class="fas fa-check"></i> 已加入日曆！';
    btn.disabled = true;
  }
}

/* =============================================================
   Patch renderProductCrystal to include urgency + social proof
   ============================================================= */
const _origRPC2 = renderProductCrystal;
renderProductCrystal = function(bazi, type){
  _origRPC2(bazi, type);
};

/* =============================================================
   Patch conclusion to use AI style
   ============================================================= */
const _origGenConclusion = generateConclusion;
generateConclusion = function(type, prob, bazi, mh, tarot){
  return generateAIConclusion(type, prob, bazi, mh, tarot);
};

/* =============================================================
   Init on DOMContentLoaded
   ============================================================= */
document.addEventListener('DOMContentLoaded', function(){
  initLiveCounter();
  // Show PWA banner after 5 seconds for iOS
  setTimeout(function(){
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    if(!isStandalone) showPWABanner();
  }, 5000);
});
/* =============================================================
   FEATURE 1: 每日運勢籤（依命主八字 × 當日天干地支）
   ============================================================= */

/* 計算當日天干地支 */
function getTodayGanZhi(){
  const today = new Date();
  const y = today.getFullYear(), m = today.getMonth()+1, d = today.getDate();
  const base = new Date(1900, 0, 1);
  const tgt = new Date(y, m-1, d);
  const diff = Math.floor((tgt - base) / 864e5);
  const dayCycle = ((diff + 10) % 60 + 60) % 60;
  const dGi = dayCycle % 10, dZi = dayCycle % 12;
  // 年干支
  let ly = y;
  if(m < 2 || (m === 2 && d < 4)) ly--;
  const yGi = ((ly-4)%10+10)%10, yZi = ((ly-4)%12+12)%12;
  return {
    dayGan: TG[dGi], dayZhi: DZ[dZi], dayEl: WX_G[TG[dGi]],
    yearGan: TG[yGi], yearZhi: DZ[yZi],
    dGi, dZi, yGi, yZi
  };
}

/* 依命主八字×當日干支計算真實運勢 */
function computeRealFortune(bazi){
  const today = getTodayGanZhi();
  const dm = bazi.dm, dmEl = bazi.dmEl;
  const todayEl = today.dayEl;
  const todayGan = today.dayGan;
  const todayZhi = today.dayZhi;

  let score = 50; // 基礎分

  // 1. 當日天干與日主的十神關係
  const god = tenGod(dm, todayGan);
  const godScores = {
    '比肩': 8, '劫財': 3,
    '食神': 10, '傷官': 2,
    '偏財': 7, '正財': 12,
    '七殺': -8, '正官': 5,
    '偏印': 6, '正印': 10
  };
  score += (godScores[god] || 0);

  // 2. 當日五行是否為喜用神
  if(bazi.fav.includes(todayEl)) score += 15;
  if(bazi.unfav.includes(todayEl)) score -= 15;

  // 3. 當日地支藏干是否有喜用神
  const todayCG = CG[todayZhi] || [];
  todayCG.forEach(g => {
    if(bazi.fav.includes(WX_G[g])) score += 4;
    if(bazi.unfav.includes(WX_G[g])) score -= 4;
  });

  // 4. 當日地支與命盤地支的沖合（簡化）
  const CHONG = {子:'午',丑:'未',寅:'申',卯:'酉',辰:'戌',巳:'亥',午:'子',未:'丑',申:'寅',酉:'卯',戌:'辰',亥:'巳'};
  const HE = {子:'丑',丑:'子',寅:'亥',卯:'戌',辰:'酉',巳:'申',午:'未',未:'午',申:'巳',酉:'辰',戌:'卯',亥:'寅'};
  const dayZhi = bazi.pillars.day.zhi;
  if(CHONG[todayZhi] === dayZhi) score -= 12; // 沖日支
  if(HE[todayZhi] === dayZhi) score += 10;    // 合日支

  // 5. 十二長生狀態
  const csState = changSheng(dm, todayZhi);
  const csScores = {'長生':10,'沐浴':2,'冠帶':6,'臨官':8,'帝旺':12,'衰':-2,'病':-5,'死':-8,'墓':-6,'絕':-10,'胎':1,'養':3};
  score += (csScores[csState] || 0);

  // 6. 大運流年加成
  const curDayun = bazi.dayun?bazi.dayun.find(d => d.isCurrent):null;
  if(curDayun){
    if(bazi.fav.includes(curDayun.el)) score += 5;
    if(bazi.unfav.includes(curDayun.el)) score -= 5;
  }

  // 限制範圍 10-95
  score = Math.max(10, Math.min(95, score));

  // 對應籤等
  let sign, icon, msg;
  if(score >= 85)      { sign='上上籤'; icon='🌟'; msg='諸事皆宜，今日天時與命盤高度契合，把握機會！'; }
  else if(score >= 75) { sign='大吉籤'; icon='🍊'; msg='天時地利人和，今日運勢旺盛，適合重要決定。'; }
  else if(score >= 65) { sign='上吉籤'; icon='✨'; msg='貴人星動，行動力強，積極推進事務有佳績。'; }
  else if(score >= 55) { sign='中吉籤'; icon='🌙'; msg='穩中求進，內在能量充沛，適合規劃與學習。'; }
  else if(score >= 45) { sign='小吉籤'; icon='🌤️'; msg='小有進展，耐心等待時機，勿急躁冒進。'; }
  else if(score >= 35) { sign='中平籤'; icon='☁️'; msg='順其自然，今日宜守不宜攻，韜光養晦。'; }
  else if(score >= 25) { sign='小凶籤'; icon='🌊'; msg='運勢低迷，注意人際摩擦，凡事多留退路。'; }
  else                 { sign='凶籤';   icon='⚡'; msg='沖煞之日，宜靜不宜動，避免重大決策與衝突。'; }

  // 推薦水晶：依喜用神五行推薦
  const favEl = bazi.fav[0] || dmEl;
  const crystalMap = {
    '金': [{n:'鈦晶',reason:'強化正財磁場，補金行能量'},{n:'白水晶',reason:'淨化氣場，金行守護石'}],
    '木': [{n:'綠幽靈',reason:'招引貴人與正財，木行生發力'},{n:'東陵玉',reason:'帶來生長與希望能量'}],
    '水': [{n:'海藍寶',reason:'增強溝通力，水行流通能量'},{n:'月光石',reason:'增強直覺，照亮內心方向'}],
    '火': [{n:'紅瑪瑙',reason:'激發勇氣與行動力，火行旺盛'},{n:'紫水晶',reason:'提升思緒清晰度與直覺'}],
    '土': [{n:'黃水晶',reason:'招偏財，提升耐心與自信'},{n:'茶晶',reason:'穩定心性，排除浮躁能量'}]
  };
  const crystalList = crystalMap[favEl] || crystalMap['土'];
  const crystal = crystalList[Math.abs(score) % crystalList.length];

  return {
    sign, icon, msg, score, crystal: crystal.n, crystalReason: crystal.reason,
    el: favEl, god, csState, todayGZ: todayGan + todayZhi, todayEl,
    detail: {
      godDesc: `今日天干${todayGan}(${todayEl})對你為【${god}】`,
      favHit: bazi.fav.includes(todayEl) ? '✓ 當日五行為你的喜用神' : (bazi.unfav.includes(todayEl) ? '✗ 當日五行為你的忌神' : '— 當日五行中性'),
      csDesc: `日主在今日地支${todayZhi}處【${csState}】位`,
      chong: CHONG[todayZhi] === dayZhi ? `⚠ 今日地支${todayZhi}沖你日支${dayZhi}` : null,
      he: HE[todayZhi] === dayZhi ? `✓ 今日地支${todayZhi}合你日支${dayZhi}` : null
    }
  };
}

function renderDailyFortune(){
  const container = document.getElementById('daily-fortune-content');
  if(!container) return;

  // 必須先填寫基本資料
  if(!S.bazi){
    container.innerHTML = `
      <div class="fortune-draw-area">
        <div class="fortune-urn" style="opacity:0.5">🔒</div>
        <p class="text-dim" style="margin-bottom:var(--sp-md)">需要先完成基本資料（生日時辰），才能依你的八字計算今日運勢</p>
        <button class="btn btn-primary" onclick="goStep(0);window.scrollTo({top:0,behavior:'smooth'})">
          <i class="fas fa-pen"></i> 前往填寫資料
        </button>
      </div>`;
    return;
  }

  const today = new Date().toISOString().slice(0,10);
  const key = 'jy_real_fortune_' + today;
  let cached = null;
  try{ cached = JSON.parse(localStorage.getItem(key)); }catch(e){}

  if(cached && cached.drawn){
    showFortuneResult(cached);
  } else {
    container.innerHTML = `
      <div class="fortune-draw-area">
        <div class="fortune-urn">🏮</div>
        <p class="text-dim">依你的命盤 × 今日天時，算出專屬運勢</p>
        <button class="btn btn-gold" onclick="drawDailyFortune()" id="btn-draw-fortune">
          <i class="fas fa-hand-sparkles"></i> 抽今日運勢籤
        </button>
      </div>`;
  }
}

function drawDailyFortune(){
  if(!S.bazi){ alert('請先填寫基本資料（生日時辰）'); return; }
  const btn = document.getElementById('btn-draw-fortune');
  if(btn){ btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> 推算中...'; }

  incrementAchievement('daily_streak');

  setTimeout(()=>{
    const fortune = computeRealFortune(S.bazi);
    fortune.drawn = true;
    const today = new Date().toISOString().slice(0,10);
    try{
      // 清理舊資料
      for(let i=localStorage.length-1;i>=0;i--){
        const k=localStorage.key(i);
        if(k&&k.startsWith('jy_real_fortune_')&&!k.endsWith(today)) localStorage.removeItem(k);
      }
      localStorage.setItem('jy_real_fortune_'+today, JSON.stringify(fortune));
    }catch(e){}
    showFortuneResult(fortune);
  }, 1500);
}

function showFortuneResult(f){
  const container = document.getElementById('daily-fortune-content');
  if(!container) return;

  const prod = findProductByName(f.crystal);
  const scoreColor = f.score>=60?'var(--c-success)':f.score>=40?'var(--c-warn)':'var(--c-danger)';

  // ── 十神白話翻譯 ──
  const godWhite = {
    '比肩':'人際互助日 — 適合團隊合作、找朋友商量事情',
    '劫財':'競爭激烈日 — 守住自己的立場，小心被人搶先',
    '食神':'靈感爆發日 — 適合創作、學習、嘗試新東西',
    '傷官':'敢言敢衝日 — 表達力強但容易得罪人，說話三思',
    '偏財':'意外之財日 — 偏財運活躍，小額投機可試但別貪',
    '正財':'穩定收入日 — 正財能量強，適合談薪資、簽約',
    '七殺':'壓力挑戰日 — 外部壓力大，但也是突破自我的機會',
    '正官':'貴人相助日 — 長輩或上司可能給你好消息',
    '偏印':'思考沉澱日 — 適合獨處充電、閱讀、靜心冥想',
    '正印':'學習成長日 — 腦袋特別清楚，讀書考試效率高'
  };

  // ── 十二長生白話翻譯 ──
  const csWhite = {
    '長生':'精力充沛，做什麼都有勁',
    '沐浴':'情緒起伏大，避免衝動決定',
    '冠帶':'自信心強，適合展現自己',
    '臨官':'執行力旺盛，果斷推進計畫',
    '帝旺':'能量巔峰，今天是你的主場',
    '衰':'避免過度消耗體力，量力而為',
    '病':'身體比較敏感，注意休息和飲食',
    '死':'舊事結束，反而適合斷捨離',
    '墓':'沉澱收藏日，不宜高調張揚',
    '絕':'能量最低點，韜光養晦最聰明',
    '胎':'新的開始正在醞釀中',
    '養':'慢慢累積能量，急不來'
  };

  // ── 今日焦點與行動建議 ──
  const godTip = godWhite[f.god] || '順其自然，保持平常心';
  const csTip = csWhite[f.csState] || '保持穩定節奏';
  
  let focusItems = [];
  focusItems.push(godTip.split('—')[0].trim());
  if(f.detail.chong) focusItems.push('⚡ 沖日：今天磁場較動盪，大事緩一緩');
  if(f.detail.he) focusItems.push('💫 合日：今天磁場和諧，推進事務順利');
  if(f.score >= 70) focusItems.push('🔥 高能日：把最重要的事排在今天');
  else if(f.score <= 35) focusItems.push('🛡️ 低能日：避免重大決策，保存能量');

  let actionTips = [];
  actionTips.push(godTip.split('—')[1]?godTip.split('—')[1].trim():'保持開放心態');
  actionTips.push(csTip);
  if(S.bazi && S.bazi.tiaohou){
    const th = S.bazi.tiaohou;
    if(th.need && th.need.includes('火')) actionTips.push('今天多曬太陽、穿暖色系，補充火行能量');
    if(th.need && th.need.includes('水')) actionTips.push('今天多喝水、去有水的地方走走，調節命盤溫度');
    if(th.need && th.need.includes('木')) actionTips.push('接觸綠色植物、戶外散步，補充木行生機');
  }

  container.innerHTML = `
    <div class="fortune-result" style="animation:scaleIn 0.5s ease">
      <div class="fortune-sign-icon">${f.icon}</div>
      <div class="fortune-sign-text">${f.sign}</div>
      <p class="fortune-msg">${f.msg}</p>
      <div style="margin:var(--sp-sm) 0;font-size:0.85rem;color:var(--c-text-dim)">
        今日干支：<span class="tag tag-gold">${f.todayGZ}</span>
        <span style="color:${scoreColor};font-weight:700;margin-left:var(--sp-sm)">運勢分數 ${f.score}</span>
      </div>

      <!-- 今日運勢焦點（白話文）-->
      <div style="background:linear-gradient(135deg,rgba(212,175,55,0.06),rgba(212,175,55,0.02));border-radius:var(--r-md);padding:var(--sp-md);margin:var(--sp-sm) 0;border-left:3px solid rgba(212,175,55,0.3)">
        <p style="font-weight:700;color:var(--c-gold);font-size:0.9rem;margin-bottom:0.4rem">🔮 今日運勢焦點</p>
        ${focusItems.map(t=>'<p style="font-size:0.88rem;line-height:1.7;margin:0.2rem 0">'+t+'</p>').join('')}
      </div>

      <!-- 今日行動建議（白話文）-->
      <div style="background:rgba(0,0,0,0.15);border-radius:var(--r-md);padding:var(--sp-md);margin:var(--sp-sm) 0">
        <p style="font-weight:700;color:var(--c-gold);font-size:0.9rem;margin-bottom:0.4rem">📋 今日行動建議</p>
        ${actionTips.map((t,i)=>'<p style="font-size:0.88rem;line-height:1.7;margin:0.2rem 0">'+(i+1)+'. '+t+'</p>').join('')}
      </div>

      <!-- 命理數據（折疊）-->
      <details style="margin:var(--sp-sm) 0">
        <summary style="cursor:pointer;font-size:0.8rem;color:var(--c-text-dim);padding:0.4rem 0;user-select:none">
          <i class="fas fa-chart-bar"></i> 展開查看命理數據
        </summary>
        <div style="background:rgba(0,0,0,0.2);border-radius:var(--r-md);padding:var(--sp-sm) var(--sp-md);margin-top:0.3rem;font-size:0.78rem;color:var(--c-text-dim);line-height:1.8">
          <p>${f.detail.godDesc}</p>
          <p>${f.detail.favHit}</p>
          <p>${f.detail.csDesc}</p>
          ${f.detail.chong?'<p style="color:var(--c-danger)">'+f.detail.chong+'</p>':''}
          ${f.detail.he?'<p style="color:var(--c-success)">'+f.detail.he+'</p>':''}
        </div>
      </details>

      <div class="fortune-divider"></div>
      <div class="fortune-crystal-rec">
        <p class="text-sm"><strong>今日推薦水晶（依喜用神${f.el}行）：</strong></p>
        <div class="fortune-crystal-card">
          <span class="fortune-crystal-name">${f.crystal}</span>
          <span class="el-tag el-${f.el} text-xs">${f.el}行</span>
        </div>
        <p class="text-xs text-dim">${f.crystalReason}</p>
        <div class="fortune-buy-btns mt-sm">
          <a href="${prod?prod.shopee:'https://tw.shp.ee/2n5Mo2w'}" target="_blank" rel="noopener" class="product-btn shopee"><i class="fas fa-shopping-cart"></i> 蝦皮入手</a>
          <a href="${prod?prod.seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}" target="_blank" rel="noopener" class="product-btn seven"><i class="fas fa-box"></i> 7-11</a>
        </div>
      </div>
      <p class="text-xs text-muted mt-md">明天可以再抽一次 ✨ 每日 00:00 重置</p>
    </div>`;
}

function findProductByName(name){
  for(const el of Object.values(REAL_PRODUCTS)){
    if(!Array.isArray(el)) continue;
    const found = el.find(p=>p.n.includes(name));
    if(found) return found;
  }
  return null;
}

/* =============================================================
   FEATURE 2: 成就徽章系統
   ============================================================= */
const ACHIEVEMENTS = [
  {id:'first',name:'初次問卦',icon:'🌱',desc:'完成第一次占卜',need:1},
  {id:'curious',name:'好奇寶寶',icon:'🔍',desc:'累計占卜 3 次',need:3},
  {id:'seeker',name:'命理换索者',icon:'🧭',desc:'累計占卜 5 次',need:5},
  {id:'devoted',name:'虔誠信徒',icon:'🙏',desc:'累計占卜 10 次',need:10},
  {id:'master',name:'占卜大師',icon:'🧙',desc:'累計占卜 20 次',need:20},
  {id:'crystal',name:'水晶達人',icon:'💍',desc:'查看水晶百科 5 種以上',need:5,type:'crystal_views'},
  {id:'sharer',name:'分享王',icon:'📣',desc:'分享結果給朋友',need:1,type:'shares'},
  {id:'daily',name:'每日報到',icon:'📅',desc:'連續 3 天抽運勢籤',need:3,type:'daily_streak'},
  {id:'alltype',name:'全能問卦師',icon:'🍭',desc:'問遍 5 種不同類型的問題',need:5,type:'types_asked'}
];

function getAchievementData(){
  try{
    return JSON.parse(localStorage.getItem('jy_achievements')||'{}');
  }catch(e){ return {}; }
}

function saveAchievementData(data){
  try{ localStorage.setItem('jy_achievements', JSON.stringify(data)); }catch(e){}
}

function incrementAchievement(type, value){
  const data = getAchievementData();
  if(!data.counts) data.counts={};
  if(type === 'divination'){
    data.counts.divination = (data.counts.divination||0) + 1;
  } else if(type === 'crystal_views'){
    if(!data.counts.crystal_views) data.counts.crystal_views = new Set();
    // Sets don't serialize well, use array
    if(!Array.isArray(data.counts.crystal_views)) data.counts.crystal_views = [];
    if(!data.counts.crystal_views.includes(value)){
      data.counts.crystal_views.push(value);
    }
  } else if(type === 'shares'){
    data.counts.shares = (data.counts.shares||0) + 1;
  } else if(type === 'types_asked'){
    if(!Array.isArray(data.counts.types_asked)) data.counts.types_asked = [];
    if(value && !data.counts.types_asked.includes(value)){
      data.counts.types_asked.push(value);
    }
  } else if(type === 'daily_streak'){
    const today = new Date().toISOString().slice(0,10);
    if(!data.counts.daily_dates) data.counts.daily_dates = [];
    if(!data.counts.daily_dates.includes(today)){
      data.counts.daily_dates.push(today);
    }
    // Calculate streak
    data.counts.daily_streak = calcStreak(data.counts.daily_dates);
  }
  saveAchievementData(data);
  checkNewAchievements(data);
}

function calcStreak(dates){
  if(!dates||!dates.length) return 0;
  const sorted = [...dates].sort().reverse();
  let streak = 1;
  for(let i=1;i<sorted.length;i++){
    const prev = new Date(sorted[i-1]);
    const curr = new Date(sorted[i]);
    const diff = (prev - curr) / (1000*60*60*24);
    if(diff === 1) streak++;
    else break;
  }
  return streak;
}

function checkNewAchievements(data){
  if(!data.counts) return;
  if(!data.unlocked) data.unlocked = [];
  
  ACHIEVEMENTS.forEach(a=>{
    if(data.unlocked.includes(a.id)) return;
    let count = 0;
    if(!a.type || a.type === 'divination') count = data.counts.divination || 0;
    else if(a.type === 'crystal_views') count = (data.counts.crystal_views||[]).length;
    else if(a.type === 'shares') count = data.counts.shares || 0;
    else if(a.type === 'daily_streak') count = data.counts.daily_streak || 0;
    else if(a.type === 'types_asked') count = (data.counts.types_asked||[]).length;
    
    if(count >= a.need){
      data.unlocked.push(a.id);
      showAchievementToast(a);
    }
  });
  saveAchievementData(data);
}

function showAchievementToast(a){
  const toast = document.createElement('div');
  toast.className = 'achievement-toast';
  toast.innerHTML = `<span class="at-icon">${a.icon}</span><div><strong>成就解鎖！</strong><br>${a.name}</div>`;
  document.body.appendChild(toast);
  setTimeout(()=>toast.classList.add('show'), 50);
  setTimeout(()=>{toast.classList.remove('show');setTimeout(()=>toast.remove(),500)}, 3500);
}

function renderAchievements(){
  const container = document.getElementById('achievements-grid');
  if(!container) return;
  const data = getAchievementData();
  const unlocked = data.unlocked || [];
  
  container.innerHTML = ACHIEVEMENTS.map(a=>{
    const isUnlocked = unlocked.includes(a.id);
    return `<div class="achievement-badge ${isUnlocked?'unlocked':'locked'}">
      <div class="badge-icon">${isUnlocked?a.icon:'🔒'}</div>
      <div class="badge-name">${a.name}</div>
      <div class="badge-desc text-xs text-muted">${a.desc}</div>
    </div>`;
  }).join('');
  
  const total = ACHIEVEMENTS.length;
  const done = unlocked.length;
  document.getElementById('achievement-progress').textContent = `${done}/${total} 已解鎖`;
}

/* =============================================================
   FEATURE 3: 水晶百科圖鑑
   ============================================================= */
function renderCrystalEncyclopedia(){
  const container = document.getElementById('crystal-encyclopedia-grid');
  if(!container) return;
  
  const allCrystals = [];
  const seen = new Set();
  for(const [category, items] of Object.entries(REAL_PRODUCTS)){
    if(!Array.isArray(items)) continue;
    items.forEach(p=>{
      if(seen.has(p.n)) return;
      seen.add(p.n);
      allCrystals.push({...p, _cat: category});
    });
  }
  
  container.innerHTML = allCrystals.map(c=>`
    <div class="ency-card" onclick="showCrystalDetail('${c.n.replace(/'/g,"\\'")}')">
      <div class="ency-icon">${c.icon||catIcon[c.cat]||'💎'}</div>
      <div class="ency-name">${c.n}</div>
      <div class="ency-meta">
        ${c.el!=='全'?`<span class="el-tag el-${c.el} text-xs">${c.el}行</span>`:'<span class="tag text-xs" style="color:var(--c-gold)">五行全</span>'}
        <span class="text-xs text-muted">${c.cat}</span>
      </div>
      <p class="ency-desc">${c.d}</p>
      <p class="ency-price">${c.price}</p>
    </div>`).join('');
}

function showCrystalDetail(name){
  incrementAchievement('crystal_views', name);
  
  let crystal = null;
  for(const items of Object.values(REAL_PRODUCTS)){
    if(!Array.isArray(items)) continue;
    crystal = items.find(p=>p.n === name);
    if(crystal) break;
  }
  if(!crystal) return;
  
  const modal = document.getElementById('crystal-detail-modal');
  if(!modal) return;
  
  modal.innerHTML = `
    <div class="cdm-overlay" onclick="closeCrystalDetail()"></div>
    <div class="cdm-content">
      <button class="cdm-close" onclick="closeCrystalDetail()"><i class="fas fa-times"></i></button>
      <div class="cdm-icon">${crystal.icon||catIcon[crystal.cat]||'💎'}</div>
      <h3 class="cdm-name">${crystal.n}</h3>
      <div class="cdm-tags">
        ${crystal.el!=='全'?`<span class="el-tag el-${crystal.el}">${crystal.el}行</span>`:'<span class="tag" style="color:var(--c-gold)">五行全</span>'}
        <span class="tag tag-gold">${crystal.cat}</span>
      </div>
      <p class="cdm-desc">${crystal.d}</p>
      <div class="cdm-info">
        <div class="cdm-row"><i class="fas fa-tag"></i> 價格：<strong>${crystal.price}</strong></div>
        <div class="cdm-row"><i class="fas fa-hand-holding-heart"></i> 佩戴方式：${crystal.wear}</div>
      </div>
      <div class="cdm-actions">
        <a href="${crystal.shopee}" target="_blank" rel="noopener" class="btn btn-gold"><i class="fas fa-shopping-cart"></i> 蝦皮購買</a>
        <a href="${crystal.seven}" target="_blank" rel="noopener" class="btn btn-outline"><i class="fas fa-box"></i> 7-11</a>
      </div>
    </div>`;
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeCrystalDetail(){
  const modal = document.getElementById('crystal-detail-modal');
  if(modal) modal.classList.add('hidden');
  document.body.style.overflow = '';
}

/* =============================================================
   FEATURE 4: 水晶配對測驗
   ============================================================= */
/* === 題庫：15題隨機抽3題，每次不同組合 === */
const QUIZ_BANK = [
  {q:'面對壓力時，你通常會？',opts:[
    {t:'深呼吸，冷靜分析',el:'水',trait:'理性'},
    {t:'找朋友聊聊傾訴',el:'木',trait:'社交'},
    {t:'立刻行動解決問題',el:'火',trait:'行動'},
    {t:'獨處靜心等靈感',el:'金',trait:'直覺'}
  ]},
  {q:'你最嚮往的生活方式？',opts:[
    {t:'穩定有規律的日常',el:'土',trait:'穩定'},
    {t:'充滿冒險與新鮮感',el:'火',trait:'冒險'},
    {t:'自由自在不受拘束',el:'水',trait:'自由'},
    {t:'和諧溫馨的家庭',el:'木',trait:'溫暖'}
  ]},
  {q:'如果水晶有顏色，最吸引你的是？',opts:[
    {t:'透明 / 白色 — 純淨',el:'金',trait:'純淨'},
    {t:'粉紅 / 紫色 — 浪漫',el:'火',trait:'浪漫'},
    {t:'綠色 / 藍色 — 寧靜',el:'木',trait:'寧靜'},
    {t:'金色 / 棕色 — 大地',el:'土',trait:'踏實'}
  ]},
  {q:'朋友眼中的你是？',opts:[
    {t:'值得信賴的靠山',el:'土',trait:'可靠'},
    {t:'點子王、創意多',el:'火',trait:'創意'},
    {t:'溫柔體貼的傾聽者',el:'水',trait:'溫柔'},
    {t:'行動派的領袖',el:'金',trait:'果斷'}
  ]},
  {q:'週末最想做的事？',opts:[
    {t:'宅在家追劇充電',el:'水',trait:'內斂'},
    {t:'出門走走接觸大自然',el:'木',trait:'自然'},
    {t:'約朋友聚餐聊天',el:'火',trait:'熱情'},
    {t:'整理房間或做計畫',el:'金',trait:'條理'}
  ]},
  {q:'你覺得自己最需要補足的是？',opts:[
    {t:'自信心和行動力',el:'火',trait:'勇氣'},
    {t:'耐心和穩定感',el:'土',trait:'沉穩'},
    {t:'人際關係和桃花',el:'木',trait:'人緣'},
    {t:'財運和事業動力',el:'金',trait:'進取'}
  ]},
  {q:'選一個最能代表你心情的天氣？',opts:[
    {t:'晴空萬里',el:'火',trait:'開朗'},
    {t:'微風徐徐的陰天',el:'金',trait:'沉靜'},
    {t:'綿綿細雨',el:'水',trait:'敏感'},
    {t:'雨後彩虹',el:'木',trait:'希望'}
  ]},
  {q:'挑一個數字？',opts:[
    {t:'1 — 開始',el:'木',trait:'起點'},
    {t:'3 — 變化',el:'火',trait:'變化'},
    {t:'6 — 順利',el:'金',trait:'圓滿'},
    {t:'8 — 豐收',el:'土',trait:'豐盛'}
  ]},
  {q:'你最害怕失卻的是？',opts:[
    {t:'健康',el:'土',trait:'務實'},
    {t:'自由',el:'水',trait:'獨立'},
    {t:'愛情 / 家人',el:'木',trait:'重情'},
    {t:'事業成就',el:'金',trait:'重心'}
  ]},
  {q:'買東西時你最看重？',opts:[
    {t:'CP值高不高',el:'金',trait:'精明'},
    {t:'外型好不好看',el:'火',trait:'美感'},
    {t:'品質耐不耐用',el:'土',trait:'品質'},
    {t:'有沒有特殊意義',el:'水',trait:'寓意'}
  ]},
  {q:'如果有一種超能力，你選？',opts:[
    {t:'讀心術',el:'水',trait:'洞察'},
    {t:'時間暫停',el:'金',trait:'掌控'},
    {t:'瞬間移動',el:'火',trait:'自由'},
    {t:'治癒能力',el:'木',trait:'慈悲'}
  ]},
  {q:'你的睡眠品質如何？',opts:[
    {t:'秒睡到天亮',el:'土',trait:'安穩'},
    {t:'偶爾失眠想太多',el:'水',trait:'多慮'},
    {t:'容易被吵醒',el:'金',trait:'敏銳'},
    {t:'夢很多很精彩',el:'火',trait:'想像力'}
  ]},
  {q:'選一種你喜歡的味道？',opts:[
    {t:'檀香 / 木質',el:'木',trait:'沉穩'},
    {t:'花香 / 獫瑰',el:'火',trait:'浪漫'},
    {t:'海洋 / 清新',el:'水',trait:'清爽'},
    {t:'茶香 / 大地',el:'土',trait:'內斂'}
  ]},
  {q:'你對「命運」的看法？',opts:[
    {t:'三分天注定，七分靠努力',el:'火',trait:'積極'},
    {t:'順其自然就好',el:'水',trait:'隨和'},
    {t:'做好準備，等待時機',el:'金',trait:'謀略'},
    {t:'相信因果，種善因得善果',el:'木',trait:'善良'}
  ]},
  {q:'工作中最讓你有成就感的事？',opts:[
    {t:'完成挑戰性的專案',el:'火',trait:'挑戰'},
    {t:'得到主管或客戶認可',el:'金',trait:'榮譽'},
    {t:'幫助同事解決問題',el:'木',trait:'助人'},
    {t:'存到目標數字的錢',el:'土',trait:'累積'}
  ]}
];

let quizState = {step:0, answers:[], questions:[]};

function startCrystalQuiz(){
  // Shuffle and pick 3 random questions
  const shuffled = [...QUIZ_BANK].sort(()=>Math.random()-0.5);
  quizState = {step:0, answers:[], questions: shuffled.slice(0,3)};
  renderQuizStep();
}

function renderQuizStep(){
  const container = document.getElementById('crystal-quiz-content');
  if(!container) return;
  
  if(quizState.step >= quizState.questions.length){
    showQuizResult();
    return;
  }
  
  const q = quizState.questions[quizState.step];
  const total = quizState.questions.length;
  container.innerHTML = `
    <div class="quiz-progress">第 ${quizState.step+1}/${total} 題</div>
    <div class="quiz-progress-bar"><div class="quiz-fill" style="width:${(quizState.step/total)*100}%"></div></div>
    <h4 class="quiz-question">${q.q}</h4>
    <div class="quiz-options">${q.opts.map((o,i)=>`
      <button class="quiz-option" onclick="answerQuiz(${i})">
        <span>${o.t}</span>
      </button>`).join('')}
    </div>`;
}

function answerQuiz(idx){
  const q = quizState.questions[quizState.step];
  quizState.answers.push(q.opts[idx]);
  quizState.step++;
  renderQuizStep();
}

function showQuizResult(){
  const container = document.getElementById('crystal-quiz-content');
  if(!container) return;
  
  // Count quiz elements
  const elCount = {};
  quizState.answers.forEach(a=>{
    elCount[a.el] = (elCount[a.el]||0) + 1;
  });
  const quizTopEl = Object.entries(elCount).sort((a,b)=>b[1]-a[1])[0][0];
  const traits = quizState.answers.map(a=>a.trait);
  
  // ** 核心修改：以八字喜用神為主，測驗結果為輔 **
  let targetEl = quizTopEl;
  let hasBazi = false;
  let baziNote = '';
  
  if(typeof S !== 'undefined' && S.bazi && S.bazi.fav && S.bazi.fav.length){
    hasBazi = true;
    const favEl = S.bazi.fav[0]; // 第一喜用神
    targetEl = favEl; // 以八字為準
    if(favEl !== quizTopEl){
      baziNote = `<div class="quiz-bazi-note"><i class="fas fa-info-circle"></i> 測驗顯示你偏好「${quizTopEl}行」，但你的八字喜用神是「<strong>${favEl}行</strong>」。依命理卟則，我們以喜用神為你推薦最適合的水晶。</div>`;
    } else {
      baziNote = `<div class="quiz-bazi-match"><i class="fas fa-check-circle"></i> 你的直覺與八字完全吻合！喜用神「<strong>${favEl}行</strong>」正是你最需要的能量。</div>`;
    }
  }
  
  // Find crystal from target element
  const candidates = REAL_PRODUCTS[targetEl] || REAL_PRODUCTS['土'];
  const pick = candidates[Math.floor(Math.random()*Math.min(3,candidates.length))];
  
  container.innerHTML = `
    <div class="quiz-result" style="animation:scaleIn 0.5s">
      <div class="quiz-result-icon">${{金:'🪙',木:'🌿',水:'💎',火:'🔥',土:'🏔️'}[pick.el]||'💎'}</div>
      <h3 class="quiz-result-title">你的命定水晶是</h3>
      <div class="quiz-result-crystal">${pick.n}</div>
      <div class="quiz-result-el">
        <span class="el-tag el-${pick.el}">${pick.el}行</span>
        <span class="tag tag-gold">${pick.cat}</span>
      </div>
      ${baziNote}
      <p class="quiz-result-desc">${pick.d}</p>
      <p class="quiz-result-traits text-sm text-dim">你的特質：${traits.join(' · ')}</p>
      ${!hasBazi ? '<p class="text-xs text-muted mt-sm"><i class="fas fa-lightbulb"></i> 提示：先完成「八字占卜」再做測驗，結果會更精準！</p>' : ''}
      <div class="quiz-result-actions mt-md">
        <a href="${pick.shopee}" target="_blank" rel="noopener" class="btn btn-gold"><i class="fas fa-shopping-cart"></i> 去蝦皮擁有它</a>
        <button class="btn btn-outline" onclick="startCrystalQuiz()"><i class="fas fa-redo"></i> 再測一次</button>
      </div>
      <button class="btn btn-outline btn-sm mt-md" onclick="shareQuizResult('${pick.n}','${traits.join('·')}')">
        <i class="fas fa-share-alt"></i> 分享我的命定水晶
      </button>
    </div>`;
}

function shareQuizResult(crystal, traits){
  const text = `我的命定水晶是「${crystal}」！特質：${traits}。你的呢？快來測 👉 `;
  const url = SITE_URL;
  if(navigator.share){
    navigator.share({title:'我的命定水晶',text:text,url:url}).catch(()=>{});
  } else {
    navigator.clipboard.writeText(text+url).then(()=>alert('已複製！貼到 LINE/IG 分享給朋友'));
  }
  incrementAchievement('shares',1);
}

/* =============================================================
   FEATURE 5: 好評輪播
   ============================================================= */
const REVIEWS = [
  {name:'eicheuq8h7',city:'',crystal:'客製款 頂級銀曜石 銀鱗手鍊',stars:5,text:'會配合你的五行及預算卻給你全方位建議，配好的手鍊也非常好看，推薦各位',time:'2025/12/29'},
  {name:'l5v3e74kf8',city:'',crystal:'鋼鐵防禦 頂級天然鐵膽石',stars:5,text:'CP值：讚',time:'2025/12/17'},
  {name:'yeh552798',city:'',crystal:'天然 華青石 手鍊 10mm',stars:5,text:'二色性 維京人的羅盤 指引方向',time:'2025/12/11'},
  {name:'jfc16888',city:'',crystal:'天然龍宮舍利桶珠手鍊',stars:5,text:'收到商品包裝良好，送貨快速，這款桶珠手鍊還蠻喜歡的，有需要會再回購看看其他商品……',time:'2025/12/07'},
  {name:'tasiong109',city:'',crystal:'天然龍宮舍利桶珠手鍊',stars:5,text:'完碧品項 如商品照片 實物更加碧 閃閃 更是服務超好 回應超快 寄件也快速 很完碧的一次購物體驗 大捨呀！',time:'2025/12/01'},
  {name:'mandytseng0511',city:'',crystal:'天鐵設計款 五行手鍊 藍虍眼 海藍寶',stars:5,text:'感謝賣家，針對個人的五行缺乏的部分做設計款補足，溝通也很順暢，推薦給大家！',time:'2025/11/28'},
  {name:'fayefang20',city:'',crystal:'頂級 黑碧璽三圈 6mm+',stars:5,text:'Black 電氣石 擋煞 辟邪 防小人 能量手鍊 穩定情緒 接地',time:'2025/11/20'},
  {name:'c9301115',city:'',crystal:'頂級 佛眼 龍宮舍利 10mm+',stars:5,text:'很好看起來很好很有品質我很喜歡，下次有機會會再回購',time:'2025/11/20'},
  {name:'yct585',city:'',crystal:'巨無霸 大地瑪瑙手排 22mm',stars:5,text:'本來不想寫評價，看到老闆貼心的問候，給予肯定，雙11活動所有東西都可以免運，就瘋狂地買，沒想到這大地瑪瑙這麼這麼的碧，碧到覺得自己好幸運可以買到，感恩所有碧好的事物和人都能得到祝福！值得推薦的好賣家！',time:'2025/11/16'},
  {name:'lovebl927',city:'',crystal:'天然 薔薇輝石 手鍊 12mm',stars:5,text:'出貨超快，很碧的薔薇🌹 開箱比想像中更滿意！實體很讚，賣家經營用心~會推薦朋友購買！',time:'2025/11/13'},
  {name:'jesscia985',city:'',crystal:'天然 頂級 白水晶 鑽切手排 14mm',stars:5,text:'白水晶之王',time:'2026/01/29'},
  {name:'jesscia985',city:'',crystal:'頂級咖啡鈦晶 太陽花手排 14mm',stars:5,text:'賣家很 nice，鈦晶手排與白水晶手排都超碧的，包裝超特別，防護力超強，物流也超神速，總之，一整個就是 "超 讚"',time:'2026/01/29'},
  {name:'yenrensu',city:'',crystal:'天然 咖啡鈦晶 手排 13mm',stars:5,text:'貓眼 鋼鈦晶 招財 旺事業 避邪 擋煞 微調奢華 復古金氣質',time:'2026/01/19'},
  {name:'liudfu',city:'',crystal:'泰國 黃龍宮舍利手鍊 11mm',stars:5,text:'用心包裝溝通良好的賣家😍快速出貨高cp 值的好賣家值得推薦大家一起來賣家逛逛購買，給5星好評喔',time:'2025/10/21'},
  {name:'liudfu',city:'',crystal:'泰國 黃龍宮舍利手鍊 13mm',stars:5,text:'好用心的包裝超愛的😍快速出貨高cp 值的好賣家值得推薦大家一起來賣家逛逛購買，給5星好評喔',time:'2025/10/21'}
];

let reviewIdx = 0;
function initReviewCarousel(){
  const el = document.getElementById('reviews-carousel');
  if(!el) return;
  function show(){
    const r = REVIEWS[reviewIdx % REVIEWS.length];
    el.style.opacity = '0';
    setTimeout(()=>{
      el.innerHTML = `
        <div class="review-card">
          <div class="review-header">
            <span class="review-stars">${'⭐'.repeat(r.stars)}</span>
            <span class="review-meta">${r.name}${r.city?' · '+r.city:''} · ${r.time}</span>
          </div>
          <p class="review-text">「${r.text}」</p>
          <div class="review-product">
            <span class="tag tag-gold text-xs">購買：${r.crystal}</span>
          </div>
        </div>`;
      el.style.opacity = '1';
      reviewIdx++;
    }, 300);
  }
  show();
  setInterval(show, 6000);
}

/* =============================================================
   FEATURE 6: 商品實拍輪播（框架，等替換照片）
   ============================================================= */
const PRODUCT_PHOTOS = {
  // 格式: '商品名': ['photo1_url', 'photo2_url', ...]
  // 目前用 placeholder，店家提供照片後替換 URL
  '鈦晶手排': [],
  '粉晶': [],
  '綠幽靈': [],
  '海藍寶': [],
  '紫水晶': [],
  '黃水晶': []
};

function initPhotoCarousel(cardEl, productName){
  const photos = PRODUCT_PHOTOS[productName];
  if(!photos || !photos.length) return; // No photos yet, skip
  
  const wrapper = document.createElement('div');
  wrapper.className = 'photo-carousel';
  let pIdx = 0;
  
  function render(){
    wrapper.innerHTML = `
      <img src="${photos[pIdx]}" alt="${productName}" class="photo-slide">
      <div class="photo-dots">${photos.map((_,i)=>`<span class="photo-dot ${i===pIdx?'active':''}"></span>`).join('')}</div>`;
  }
  
  wrapper.addEventListener('click', ()=>{
    pIdx = (pIdx + 1) % photos.length;
    render();
  });
  
  render();
  const iconEl = cardEl.querySelector('.product-icon');
  if(iconEl) iconEl.replaceWith(wrapper);
}

/* =============================================================
   Track divination for achievements
   ============================================================= */
const _origRunAnalysis = typeof runAnalysis === 'function' ? runAnalysis : null;
if(_origRunAnalysis){
  const __origRA = runAnalysis;
  runAnalysis = function(){
    __origRA.apply(this, arguments);
    incrementAchievement('divination');
    try{
      const typeEl = document.getElementById('question-type');
      if(typeEl && typeEl.value) incrementAchievement('types_asked', typeEl.value);
    }catch(e){}
    // Refresh badge display
    setTimeout(renderAchievements, 500);
  };
}

/* =============================================================
   Init all engagement features
   ============================================================= */
document.addEventListener('DOMContentLoaded', function(){
  // 延遲初始化：結果頁出現時才渲染重 DOM 功能
  let extraInited = false;
  function initExtraFeatures(){
    if(extraInited) return;
    extraInited = true;
    renderDailyFortune();
    renderAchievements();
    renderCrystalEncyclopedia();
    initReviewCarousel();
    generateLuckyInfo();
  }
  // 監聽結果頁出現
  const obs = new IntersectionObserver((entries)=>{
    if(entries[0].isIntersecting){ initExtraFeatures(); obs.disconnect(); }
  },{threshold:0.1});
  const step3 = document.getElementById('step-3');
  if(step3) obs.observe(step3);
  // fallback: 5秒後如果已在結果頁才觸發
  setTimeout(function(){ if(S.bazi) initExtraFeatures(); }, 5000);
  
  // Nav tab switching for new sections
  document.querySelectorAll('.nav-extra-tab').forEach(tab=>{
    tab.addEventListener('click', function(){
      initExtraFeatures(); // 確保點 tab 時已初始化
      const target = this.dataset.target;
      document.querySelectorAll('.extra-section').forEach(s=>s.classList.add('hidden'));
      const section = document.getElementById(target);
      if(section) section.classList.remove('hidden');
      document.querySelectorAll('.nav-extra-tab').forEach(t=>t.classList.remove('active'));
      this.classList.add('active');
      // 特定 tab 需要重新渲染（可能 S.bazi 在 initExtraFeatures 後才就緒）
      if(target==='sec-daily-fortune' && S.bazi && typeof renderDailyFortune==='function') try{renderDailyFortune();}catch(e){}
      if(target==='sec-lucky' && S.bazi) generateLuckyInfo();
      if(target==='sec-calendar30' && S.bazi && typeof renderCal30==='function') try{renderCal30();}catch(e){}
      if(target==='sec-aura-filter' && typeof renderAuraFilter==='function') try{renderAuraFilter();}catch(e){}
      if(target==='sec-reviews' && typeof initReviewCarousel==='function') try{initReviewCarousel();}catch(e){}
      section.scrollIntoView({behavior:'smooth',block:'start'});
    });
  });
});
/* =============================================================
   塔羅牌面生成器 — Canvas 繪製 78 張牌面
   ============================================================= */
const TAROT_CARD_SYMBOLS = {
  // 大阿爾卡納 0-21
  0:  {sym:'🃏', color:'#FFD700', bg:'#1a0a30', sub:'0'},
  1:  {sym:'∞',  color:'#FFD700', bg:'#2D0A0A', sub:'I'},
  2:  {sym:'☽',  color:'#C0C0FF', bg:'#0a0a2d', sub:'II'},
  3:  {sym:'♀',  color:'#FFB6C1', bg:'#2D0A1A', sub:'III'},
  4:  {sym:'♂',  color:'#DC143C', bg:'#2D0A0A', sub:'IV'},
  5:  {sym:'✝',  color:'#FFD700', bg:'#1a1a0a', sub:'V'},
  6:  {sym:'♡',  color:'#FF69B4', bg:'#2D0A1A', sub:'VI'},
  7:  {sym:'⚔',  color:'#C0C0C0', bg:'#0a1a2d', sub:'VII'},
  8:  {sym:'∞',  color:'#FFD700', bg:'#2D1A0A', sub:'VIII'},
  9:  {sym:'☆',  color:'#C0C0FF', bg:'#0a0a2d', sub:'IX'},
  10: {sym:'☸',  color:'#FFD700', bg:'#1a0a2d', sub:'X'},
  11: {sym:'⚖',  color:'#FFD700', bg:'#2D0A0A', sub:'XI'},
  12: {sym:'⚓',  color:'#4169E1', bg:'#0a1a2d', sub:'XII'},
  13: {sym:'☠',  color:'#F5F5F5', bg:'#0a0a0a', sub:'XIII'},
  14: {sym:'⚗',  color:'#87CEEB', bg:'#0a2d2d', sub:'XIV'},
  15: {sym:'⛧',  color:'#8B0000', bg:'#0a0a0a', sub:'XV'},
  16: {sym:'⚡',  color:'#FF4500', bg:'#1a0a0a', sub:'XVI'},
  17: {sym:'★',  color:'#FFD700', bg:'#0a0a2d', sub:'XVII'},
  18: {sym:'☾',  color:'#C0C0FF', bg:'#0a0a2d', sub:'XVIII'},
  19: {sym:'☀',  color:'#FFD700', bg:'#2D1A0A', sub:'XIX'},
  20: {sym:'♱',  color:'#FFD700', bg:'#1a0a2d', sub:'XX'},
  21: {sym:'⊕',  color:'#FFD700', bg:'#0a2d0a', sub:'XXI'}
};

// 小阿爾卡納花色
const SUIT_STYLES = {
  '權杖': {sym:'🔥', color:'#FF6347', bg:'#2D0A0A', accent:'#FF4500'},
  '聖杯': {sym:'💧', color:'#4169E1', bg:'#0a0a2d', accent:'#1E90FF'},
  '寶劍': {sym:'⚔',  color:'#C0C0C0', bg:'#1a1a1a', accent:'#A9A9A9'},
  '金幣': {sym:'⬟',  color:'#FFD700', bg:'#1a1a0a', accent:'#DAA520'}
};

const COURT_SYMBOLS = {
  '王牌':'✦','二':'II','三':'III','四':'IV','五':'V',
  '六':'VI','七':'VII','八':'VIII','九':'IX','十':'X',
  '侍者':'👤','騎士':'🐍','皇后':'♛','國王':'♚'
};

function generateTarotCardImage(card){
  const canvas = document.createElement('canvas');
  canvas.width = 180;
  canvas.height = 280;
  const ctx = canvas.getContext('2d');
  
  let style;
  if(card.id <= 21){
    // Major Arcana
    style = TAROT_CARD_SYMBOLS[card.id];
    drawMajorCard(ctx, card, style);
  } else {
    // Minor Arcana
    let suit='', rank='';
    for(const s of ['權杖','聖杯','寶劍','金幣']){
      if(card.n.includes(s)){ suit=s; rank=card.n.replace(s,''); break; }
    }
    style = SUIT_STYLES[suit] || SUIT_STYLES['金幣'];
    drawMinorCard(ctx, card, style, suit, rank);
  }
  
  return canvas.toDataURL('image/png');
}

function drawMajorCard(ctx, card, s){
  const W=180, H=280;
  
  // Background gradient
  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, s.bg);
  grad.addColorStop(0.5, lighten(s.bg, 15));
  grad.addColorStop(1, s.bg);
  ctx.fillStyle = grad;
  roundRect(ctx, 0, 0, W, H, 12);
  ctx.fill();
  
  // Border
  ctx.strokeStyle = s.color;
  ctx.lineWidth = 2;
  roundRect(ctx, 3, 3, W-6, H-6, 10);
  ctx.stroke();
  
  // Inner border
  ctx.strokeStyle = 'rgba('+hexToRgb(s.color)+',0.3)';
  ctx.lineWidth = 1;
  roundRect(ctx, 8, 8, W-16, H-16, 8);
  ctx.stroke();
  
  // Decorative corners
  drawCornerDeco(ctx, s.color, W, H);
  
  // Number at top
  ctx.fillStyle = s.color;
  ctx.font = 'bold 16px serif';
  ctx.textAlign = 'center';
  ctx.fillText(s.sub, W/2, 30);
  
  // Main symbol (large)
  ctx.font = '60px serif';
  ctx.fillStyle = s.color;
  ctx.fillText(s.sym, W/2, H/2 - 10);
  
  // Glow effect behind symbol
  ctx.shadowColor = s.color;
  ctx.shadowBlur = 20;
  ctx.fillText(s.sym, W/2, H/2 - 10);
  ctx.shadowBlur = 0;
  
  // Card name at bottom
  ctx.fillStyle = s.color;
  ctx.font = 'bold 18px "Noto Sans TC", sans-serif';
  ctx.fillText(card.n, W/2, H - 40);
  
  // Element
  ctx.font = '12px sans-serif';
  ctx.fillStyle = 'rgba('+hexToRgb(s.color)+',0.6)';
  ctx.fillText(card.el, W/2, H - 20);
}

function drawMinorCard(ctx, card, s, suit, rank){
  const W=180, H=280;
  
  // Background
  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, s.bg);
  grad.addColorStop(0.5, lighten(s.bg, 10));
  grad.addColorStop(1, s.bg);
  ctx.fillStyle = grad;
  roundRect(ctx, 0, 0, W, H, 12);
  ctx.fill();
  
  // Border
  ctx.strokeStyle = s.accent;
  ctx.lineWidth = 2;
  roundRect(ctx, 3, 3, W-6, H-6, 10);
  ctx.stroke();
  
  // Inner frame
  ctx.strokeStyle = 'rgba('+hexToRgb(s.accent)+',0.2)';
  ctx.lineWidth = 1;
  roundRect(ctx, 10, 10, W-20, H-20, 6);
  ctx.stroke();
  
  // Corners
  drawCornerDeco(ctx, s.accent, W, H);
  
  // Suit symbol at top
  ctx.font = '24px serif';
  ctx.fillStyle = s.color;
  ctx.textAlign = 'center';
  ctx.fillText(s.sym, W/2, 35);
  
  // Rank in center
  const courtSym = COURT_SYMBOLS[rank] || rank;
  if(['侍者','騎士','皇后','國王'].includes(rank)){
    // Court card: larger symbol
    ctx.font = '48px serif';
    ctx.fillStyle = s.color;
    ctx.fillText(courtSym, W/2, H/2);
    ctx.font = '14px sans-serif';
    ctx.fillStyle = 'rgba('+hexToRgb(s.color)+',0.7)';
    ctx.fillText(rank, W/2, H/2 + 25);
  } else if(rank === '王牌'){
    // Ace: big symbol
    ctx.font = '64px serif';
    ctx.shadowColor = s.color;
    ctx.shadowBlur = 15;
    ctx.fillStyle = s.color;
    ctx.fillText(s.sym, W/2, H/2 + 5);
    ctx.shadowBlur = 0;
  } else {
    // Number cards: draw pip pattern
    const num = ['二','三','四','五','六','七','八','九','十'].indexOf(rank) + 2;
    drawPips(ctx, s.sym, s.color, W, H, num || 1);
  }
  
  // Card name at bottom
  ctx.fillStyle = s.color;
  ctx.font = 'bold 16px "Noto Sans TC", sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(card.n, W/2, H - 38);
  
  // Suit name
  ctx.font = '11px sans-serif';
  ctx.fillStyle = 'rgba('+hexToRgb(s.color)+',0.5)';
  ctx.fillText(suit+'牌組', W/2, H - 20);
}

function drawPips(ctx, sym, color, W, H, count){
  ctx.font = '22px serif';
  ctx.fillStyle = color;
  ctx.textAlign = 'center';
  
  // Pip positions for 2-10
  const cx = W/2, cy = H/2;
  const positions = {
    2: [[cx,cy-30],[cx,cy+30]],
    3: [[cx,cy-35],[cx,cy],[cx,cy+35]],
    4: [[cx-25,cy-25],[cx+25,cy-25],[cx-25,cy+25],[cx+25,cy+25]],
    5: [[cx-25,cy-25],[cx+25,cy-25],[cx,cy],[cx-25,cy+25],[cx+25,cy+25]],
    6: [[cx-25,cy-30],[cx+25,cy-30],[cx-25,cy],[cx+25,cy],[cx-25,cy+30],[cx+25,cy+30]],
    7: [[cx-25,cy-35],[cx+25,cy-35],[cx-25,cy],[cx,cy],[cx+25,cy],[cx-25,cy+35],[cx+25,cy+35]],
    8: [[cx-25,cy-40],[cx+25,cy-40],[cx-25,cy-13],[cx+25,cy-13],[cx-25,cy+13],[cx+25,cy+13],[cx-25,cy+40],[cx+25,cy+40]],
    9: [[cx-25,cy-40],[cx+25,cy-40],[cx-25,cy-13],[cx+25,cy-13],[cx,cy],[cx-25,cy+13],[cx+25,cy+13],[cx-25,cy+40],[cx+25,cy+40]],
    10:[[cx-25,cy-45],[cx+25,cy-45],[cx-25,cy-18],[cx+25,cy-18],[cx,cy-8],[cx,cy+12],[cx-25,cy+22],[cx+25,cy+22],[cx-25,cy+48],[cx+25,cy+48]]
  };
  
  const pts = positions[count] || positions[2];
  pts.forEach(([x,y]) => ctx.fillText(sym, x, y+6));
}

function drawCornerDeco(ctx, color, W, H){
  ctx.strokeStyle = 'rgba('+hexToRgb(color)+',0.4)';
  ctx.lineWidth = 1;
  const d = 18;
  // Top-left
  ctx.beginPath(); ctx.moveTo(14,14+d); ctx.lineTo(14,14); ctx.lineTo(14+d,14); ctx.stroke();
  // Top-right
  ctx.beginPath(); ctx.moveTo(W-14-d,14); ctx.lineTo(W-14,14); ctx.lineTo(W-14,14+d); ctx.stroke();
  // Bottom-left
  ctx.beginPath(); ctx.moveTo(14,H-14-d); ctx.lineTo(14,H-14); ctx.lineTo(14+d,H-14); ctx.stroke();
  // Bottom-right
  ctx.beginPath(); ctx.moveTo(W-14-d,H-14); ctx.lineTo(W-14,H-14); ctx.lineTo(W-14,H-14-d); ctx.stroke();
}

// roundRect 定義在上方（水晶推薦卡片區塊）

function hexToRgb(hex){
  hex = hex.replace('#','');
  if(hex.length===3) hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
  const r=parseInt(hex.substring(0,2),16);
  const g=parseInt(hex.substring(2,4),16);
  const b=parseInt(hex.substring(4,6),16);
  return r+','+g+','+b;
}

function lighten(hex, amt){
  hex = hex.replace('#','');
  if(hex.length===3) hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
  let r=parseInt(hex.substring(0,2),16);
  let g=parseInt(hex.substring(2,4),16);
  let b=parseInt(hex.substring(4,6),16);
  r=Math.min(255,r+amt); g=Math.min(255,g+amt); b=Math.min(255,b+amt);
  return '#'+r.toString(16).padStart(2,'0')+g.toString(16).padStart(2,'0')+b.toString(16).padStart(2,'0');
}

// Cache generated card images
const _tarotImageCache = {};
function getTarotCardImage(card){
  if(!_tarotImageCache[card.id]){
    _tarotImageCache[card.id] = generateTarotCardImage(card);
  }
  return _tarotImageCache[card.id];
}

/* =============================================================
   命理小遊戲 1: 五行猜猜看
   ============================================================= */
const WUXING_QUIZ_BANK = [
  {q:'「甲」屬於哪個五行？',a:'木',opts:['金','木','水','火','土']},
  {q:'「丙」屬於哪個五行？',a:'火',opts:['金','木','水','火','土']},
  {q:'「庚」屬於哪個五行？',a:'金',opts:['金','木','水','火','土']},
  {q:'「壬」屬於哪個五行？',a:'水',opts:['金','木','水','火','土']},
  {q:'「己」屬於哪個五行？',a:'土',opts:['金','木','水','火','土']},
  {q:'木生什麼？',a:'火',opts:['金','木','水','火','土']},
  {q:'火生什麼？',a:'土',opts:['金','木','水','火','土']},
  {q:'金生什麼？',a:'水',opts:['金','木','水','火','土']},
  {q:'水生什麼？',a:'木',opts:['金','木','水','火','土']},
  {q:'土生什麼？',a:'金',opts:['金','木','水','火','土']},
  {q:'水克什麼？',a:'火',opts:['金','木','水','火','土']},
  {q:'木克什麼？',a:'土',opts:['金','木','水','火','土']},
  {q:'火克什麼？',a:'金',opts:['金','木','水','火','土']},
  {q:'金克什麼？',a:'木',opts:['金','木','水','火','土']},
  {q:'土克什麼？',a:'水',opts:['金','木','水','火','土']},
  {q:'子時是幾點到幾點？',a:'23-01',opts:['23-01','01-03','05-07','11-13']},
  {q:'午時是幾點到幾點？',a:'11-13',opts:['09-11','11-13','13-15','07-09']},
  {q:'寅時是幾點到幾點？',a:'03-05',opts:['01-03','03-05','05-07','07-09']},
  {q:'紫水晶屬於哪個五行？',a:'火',opts:['金','木','水','火','土']},
  {q:'黃水晶屬於哪個五行？',a:'土',opts:['金','木','水','火','土']},
  {q:'綠幽靈屬於哪個五行？',a:'木',opts:['金','木','水','火','土']},
  {q:'海藍寶屬於哪個五行？',a:'水',opts:['金','木','水','火','土']},
  {q:'鈦晶屬於哪個五行？',a:'金',opts:['金','木','水','火','土']},
  {q:'「比肩」的十神關係是？',a:'同我',opts:['生我','同我','我生','我克','克我']},
  {q:'「正財」的十神關係是？',a:'我克',opts:['生我','同我','我生','我克','克我']},
  {q:'塔羅牌「愚者」的編號是？',a:'0',opts:['0','1','21','22']},
  {q:'塔羅大牌共有幾張？',a:'22',opts:['20','21','22','78']},
  {q:'八字的「日主」指的是？',a:'日柱天干',opts:['年柱天干','月柱天干','日柱天干','時柱天干']},
  {q:'「坤」卦代表什麼？',a:'地',opts:['天','地','水','火']},
  {q:'「乾」卦代表什麼？',a:'天',opts:['天','地','山','澤']}
];

let wxGame = {score:0, total:0, current:null, answered:false};

function startWuxingGame(){
  wxGame = {score:0, total:0, current:null, answered:false, questions:[]};
  // Pick 5 random questions
  const shuffled = [...WUXING_QUIZ_BANK].sort(()=>Math.random()-0.5);
  wxGame.questions = shuffled.slice(0, 5);
  nextWuxingQ();
}

function nextWuxingQ(){
  const container = document.getElementById('wuxing-game-content');
  if(!container) return;
  
  if(wxGame.total >= wxGame.questions.length){
    showWuxingResult();
    return;
  }
  
  wxGame.answered = false;
  wxGame.current = wxGame.questions[wxGame.total];
  const q = wxGame.current;
  
  container.innerHTML = `
    <div class="game-progress">第 ${wxGame.total+1}/${wxGame.questions.length} 題　得分：${wxGame.score}</div>
    <h4 class="game-question">${q.q}</h4>
    <div class="game-options">${q.opts.map(o=>`
      <button class="game-opt" onclick="answerWuxing('${o}',this)">${o}</button>`).join('')}
    </div>
    <div id="game-feedback" class="game-feedback"></div>`;
}

function answerWuxing(ans, btn){
  if(wxGame.answered) return;
  wxGame.answered = true;
  
  const correct = ans === wxGame.current.a;
  if(correct) wxGame.score++;
  wxGame.total++;
  
  // Highlight
  btn.classList.add(correct ? 'correct' : 'wrong');
  document.querySelectorAll('.game-opt').forEach(b=>{
    b.disabled = true;
    if(b.textContent === wxGame.current.a) b.classList.add('correct');
  });
  
  const fb = document.getElementById('game-feedback');
  fb.innerHTML = correct 
    ? '<span class="fb-correct">✅ 正確！</span>'
    : `<span class="fb-wrong">❌ 答案是「${wxGame.current.a}」</span>`;
  
  setTimeout(nextWuxingQ, 1200);
}

function showWuxingResult(){
  const container = document.getElementById('wuxing-game-content');
  if(!container) return;
  const pct = Math.round(wxGame.score / wxGame.questions.length * 100);
  let title, msg;
  if(pct >= 80){ title='🏆 命理達人'; msg='你對五行的掌握非常厲害！'; }
  else if(pct >= 60){ title='📚 用功學生'; msg='基礎不錯，再練練就更強了！'; }
  else if(pct >= 40){ title='🌱 命理新手'; msg='繼續學習，五行世界很有趣！'; }
  else{ title='🔰 初來乍到'; msg='多獩幾次就會進步啦！'; }
  
  container.innerHTML = `
    <div class="game-result">
      <div class="game-result-icon">${pct>=60?'🍉':'💪'}</div>
      <h3>${title}</h3>
      <div class="game-score-big">${wxGame.score} / ${wxGame.questions.length}</div>
      <p class="text-dim">${msg}</p>
      <div class="game-actions mt-md">
        <button class="btn btn-gold" onclick="startWuxingGame()"><i class="fas fa-redo"></i> 再獩一次</button>
      </div>
    </div>`;
}

/* =============================================================
   命理小遊戲 2: 每日生肖配對
   ============================================================= */
const ZODIAC_DATA = [
  {name:'鼠',icon:'🐭',el:'水',best:['龍','猴','牛'],avoid:['馬','羊','兔']},
  {name:'牛',icon:'🐂',el:'土',best:['鼠','蛇','雞'],avoid:['馬','羊','狗']},
  {name:'虍',icon:'🐯',el:'木',best:['馬','狗','豬'],avoid:['蛇','猴']},
  {name:'兔',icon:'🐰',el:'木',best:['羊','狗','豬'],avoid:['鼠','龍','雞']},
  {name:'龍',icon:'🐲',el:'土',best:['鼠','猴','雞'],avoid:['狗','兔']},
  {name:'蛇',icon:'🐍',el:'火',best:['牛','雞'],avoid:['虍','豬']},
  {name:'馬',icon:'🐴',el:'火',best:['虍','羊','狗'],avoid:['鼠','牛']},
  {name:'羊',icon:'🐑',el:'土',best:['兔','馬','豬'],avoid:['鼠','牛','狗']},
  {name:'猴',icon:'🐵',el:'金',best:['鼠','龍'],avoid:['虍','豬']},
  {name:'雞',icon:'🐔',el:'金',best:['牛','龍','蛇'],avoid:['兔','狗']},
  {name:'狗',icon:'🐶',el:'土',best:['虍','兔','馬'],avoid:['龍','牛','羊','雞']},
  {name:'豬',icon:'🐷',el:'水',best:['虍','兔','羊'],avoid:['蛇','猴']}
];

function renderZodiacMatch(){
  const container = document.getElementById('zodiac-match-content');
  if(!container) return;
  container.innerHTML = `
    <p class="text-sm text-dim mb-md">選擇兩個生肖，看看配對結果！</p>
    <div class="zodiac-grid">${ZODIAC_DATA.map(z=>`
      <button class="zodiac-btn" onclick="selectZodiac('${z.name}')" data-zodiac="${z.name}">
        <span class="zodiac-icon">${z.icon}</span>
        <span class="zodiac-name">${z.name}</span>
      </button>`).join('')}
    </div>
    <div id="zodiac-selected" class="zodiac-selected mt-md"></div>
    <div id="zodiac-result-area" class="mt-md"></div>`;
}

let zodiacPair = [];
function selectZodiac(name){
  if(zodiacPair.length >= 2) zodiacPair = [];
  zodiacPair.push(name);
  
  // Highlight
  document.querySelectorAll('.zodiac-btn').forEach(b=>{
    b.classList.toggle('selected', zodiacPair.includes(b.dataset.zodiac));
  });
  
  const selEl = document.getElementById('zodiac-selected');
  selEl.textContent = zodiacPair.join(' ❤️ ');
  
  if(zodiacPair.length === 2){
    showZodiacResult(zodiacPair[0], zodiacPair[1]);
  }
}

function showZodiacResult(a, b){
  const zA = ZODIAC_DATA.find(z=>z.name===a);
  const zB = ZODIAC_DATA.find(z=>z.name===b);
  if(!zA || !zB) return;
  
  let score, level, desc;
  if(zA.best.includes(b) && zB.best.includes(a)){
    score = 95; level = '天生一對 💕'; desc = `${a}與${b}是命理上的絕佳配對！彼此互補，感情和諧。`;
  } else if(zA.best.includes(b) || zB.best.includes(a)){
    score = 80; level = '相合有緣 ✨'; desc = `${a}與${b}有不錯的緣分，相處愉快，值得珍惜。`;
  } else if(zA.avoid.includes(b) || zB.avoid.includes(a)){
    score = 35; level = '需要磨合 ⚡'; desc = `${a}與${b}在傳統命理上有些沖突，但真愛可以跨越一切，多包容多理解就好。`;
  } else {
    score = 65; level = '平穩中性 ☁️'; desc = `${a}與${b}不特別沖也不特別合，關鍵看兩人的經營。`;
  }
  
  const resultEl = document.getElementById('zodiac-result-area');
  resultEl.innerHTML = `
    <div class="zodiac-result card" style="animation:scaleIn 0.4s">
      <div class="zodiac-pair-icons">${zA.icon} ❤️ ${zB.icon}</div>
      <div class="zodiac-match-score">${score}%</div>
      <div class="zodiac-match-level">${level}</div>
      <p class="text-sm">${desc}</p>
      <p class="text-xs text-muted mt-sm">五行：${a}(${zA.el}) × ${b}(${zB.el})</p>
      <button class="btn btn-outline btn-sm mt-md" onclick="shareZodiacMatch('${a}','${b}','${score}')">
        <i class="fas fa-share-alt"></i> 分享配對結果
      </button>
    </div>`;
}

function shareZodiacMatch(a, b, score){
  const text = `${a} ❤️ ${b} 配對指數 ${score}%！你跟誰配？快來測 👉 `;
  const url = SITE_URL;
  if(navigator.share) navigator.share({title:'生肖配對',text,url}).catch(()=>{});
  else { navigator.clipboard.writeText(text+url).then(()=>alert('已複製！')); }
}

/* =============================================================
   命理小遊戲 3: 今日幸運指南（依命主五行喜用神）
   ============================================================= */
function generateLuckyInfo(){
  const container = document.getElementById('lucky-gen-content');
  if(!container) return;

  // 必須先填寫基本資料
  if(!S.bazi){
    container.innerHTML = `
      <div class="fortune-draw-area">
        <div style="font-size:2.5rem;margin-bottom:var(--sp-sm);opacity:0.5">🔒</div>
        <p class="text-dim" style="margin-bottom:var(--sp-md)">需要先完成基本資料（生日時辰），才能依你的五行喜用神算出今日幸運指南</p>
        <button class="btn btn-primary" onclick="goStep(0);window.scrollTo({top:0,behavior:'smooth'})">
          <i class="fas fa-pen"></i> 前往填寫資料
        </button>
      </div>`;
    return;
  }

  const b = S.bazi;
  const today = new Date();
  const dayOfWeek = ['日','一','二','三','四','五','六'][today.getDay()];
  const todayGZ = getTodayGanZhi();

  // 依喜用神五行推薦顏色
  const favEl = b.fav[0] || b.dmEl;
  const favEl2 = b.fav[1] || b.dmEl;

  const colorsByEl = {
    '金': [{name:'白色',hex:'#f5f5f5',meaning:'金行正色，淨化氣場'},{name:'金色',hex:'#d4af37',meaning:'強化權威與成就'},{name:'銀色',hex:'#94a3b8',meaning:'冷靜理性，金行守護'}],
    '木': [{name:'綠色',hex:'#16a34a',meaning:'木行正色，健康成長'},{name:'青色',hex:'#06b6d4',meaning:'生發之力，貴人能量'},{name:'翠綠',hex:'#059669',meaning:'木行生機盎然'}],
    '水': [{name:'黑色',hex:'#1a1a1a',meaning:'水行正色，保護穩重'},{name:'藍色',hex:'#2563eb',meaning:'智慧溝通，水行流通'},{name:'深藍',hex:'#1e3a5f',meaning:'深沉內斂，水行蓄能'}],
    '火': [{name:'紅色',hex:'#dc2626',meaning:'火行正色，熱情行動力'},{name:'紫色',hex:'#9333ea',meaning:'靈性直覺，火行昇華'},{name:'橙色',hex:'#ea580c',meaning:'活力創造，火行擴展'}],
    '土': [{name:'黃色',hex:'#eab308',meaning:'土行正色，財運自信'},{name:'棕色',hex:'#92400e',meaning:'踏實安定，土行厚德'},{name:'米色',hex:'#d2b48c',meaning:'溫和穩重，土行包容'}]
  };

  const dayHash = today.getDate() + today.getMonth()*31;
  const favColors = colorsByEl[favEl] || colorsByEl['土'];
  const luckyColor = favColors[dayHash % favColors.length];

  // 幸運數字：依五行生數
  const elNums = {'木':[3,8],'火':[2,7],'土':[5,10],'金':[4,9],'水':[1,6]};
  const nums = elNums[favEl] || [5,10];
  const luckyNum = nums[dayHash % nums.length];

  // 幸運方位：依喜用神五行
  const elDirs = {'木':'東方','火':'南方','土':'中宮','金':'西方','水':'北方'};
  const elDirs2 = {'木':'東南','火':'西南','土':'東北','金':'西北','水':'正北'};
  const luckyDir = dayHash % 2 === 0 ? elDirs[favEl] : (elDirs2[favEl] || elDirs[favEl]);

  // 最佳時辰：依喜用神五行旺的時辰
  const elTimes = {
    '木': ['寅時(03-05)','卯時(05-07)'],
    '火': ['巳時(09-11)','午時(11-13)'],
    '土': ['辰時(07-09)','未時(13-15)','戌時(19-21)','丑時(01-03)'],
    '金': ['申時(15-17)','酉時(17-19)'],
    '水': ['亥時(21-23)','子時(23-01)']
  };
  const times = elTimes[favEl] || ['辰時(07-09)'];
  const luckyTime = times[dayHash % times.length];

  // 幸運水晶（依喜用神五行）
  const elCrystals = {
    '金': ['白水晶','鈦晶','銀髮晶'],
    '木': ['綠幽靈','東陵玉','橄欖石'],
    '水': ['海藍寶','月光石','藍玉髓'],
    '火': ['紅瑪瑙','紫水晶','石榴石'],
    '土': ['黃水晶','茶晶','虎眼石']
  };
  const crystals = elCrystals[favEl] || ['黃水晶'];
  const luckyCrystal = crystals[dayHash % crystals.length];

  // ═══ 每日靈氣脈輪動態處方（流日五行 vs 喜用神）═══
  const _elChakra={
    '木':{chakra:'心輪',color:'綠色/粉色',domain:'情感、包容、人際關係',symptom:'人際疏離、冷漠感',icon:'💚'},
    '火':{chakra:'海底輪/臍輪',color:'紅色/橘色',domain:'行動力、熱情、創造力',symptom:'動力枯竭、焦慮不安',icon:'❤️‍🔥'},
    '土':{chakra:'太陽神經叢',color:'黃色/棕色',domain:'自信、意志力、財富轉化',symptom:'自我懷疑、腸胃不適',icon:'💛'},
    '金':{chakra:'頂輪',color:'白色/金色',domain:'邏輯、秩序、靈性連結',symptom:'思維混亂、無法專注',icon:'🤍'},
    '水':{chakra:'喉輪/眉心輪',color:'藍色/靛色',domain:'溝通、表達、直覺',symptom:'表達困難、判斷模糊',icon:'💙'}
  };
  const _dayEl=todayGZ.dayEl||'土';
  const _favChakra=_elChakra[favEl]||_elChakra['土'];
  const _dayChakra=_elChakra[_dayEl]||_elChakra['土'];
  const _keCheck={'木':'土','土':'水','水':'火','火':'金','金':'木'};
  const _isDayFav=_dayEl===favEl;
  const _isDayClash=_keCheck[_dayEl]===favEl; // 流日剋喜用
  const _shengCheck={'木':'火','火':'土','土':'金','金':'水','水':'木'};
  const _isPassEl=_shengCheck[_dayEl]===favEl?_dayEl:''; // 通關五行

  let chakraText='';
  let chakraRx='';
  if(_isDayFav){
    chakraText=`今日宇宙能量為<strong>${_dayEl}行</strong>，精準啟動你的<strong>${_favChakra.chakra}</strong>（${_favChakra.domain}）。能量平穩順暢。`;
    chakraRx=`配戴 ${luckyCrystal} 來放大今日${_dayEl}行優勢。`;
  } else if(_isDayClash){
    chakraText=`今日大環境的<strong style="color:#f87171">${_dayEl}行</strong>能量極強，壓迫你的<strong>${_favChakra.chakra}</strong>。你可能感到${_favChakra.symptom}。`;
    const passEl=_isPassEl||favEl;
    const passCrystals=elCrystals[passEl]||crystals;
    chakraRx=`<strong style="color:#fbbf24">強烈建議</strong>配戴 ${passCrystals[dayHash%passCrystals.length]} 建立能量護盾。`;
  } else {
    chakraText=`今日${_dayEl}行能量主導<strong>${_dayChakra.chakra}</strong>（${_dayChakra.domain}），與你的${favEl}行互不衝突。`;
    chakraRx=`日常配戴 ${luckyCrystal} 維持平衡即可。`;
  }

  container.innerHTML = `
    <div class="lucky-card" style="animation:scaleIn 0.4s">
      <h4 class="text-gold mb-sm">📅 星期${dayOfWeek}的專屬幸運指南</h4>
      <p class="text-xs text-dim mb-md">依據你的八字喜用神【${b.fav.join('、')}行】× 今日流日干支【${todayGZ.dayGan}${todayGZ.dayZhi}・${_dayEl}行】計算</p>
      <div class="lucky-grid">
        <div class="lucky-item">
          <div class="lucky-label">幸運色</div>
          <div class="lucky-value">
            <span class="lucky-color-dot" style="background:${luckyColor.hex}"></span>
            ${luckyColor.name}
          </div>
          <div class="lucky-sub">${favEl}行 · ${luckyColor.meaning}</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">幸運數字</div>
          <div class="lucky-value lucky-num">${luckyNum}</div>
          <div class="lucky-sub">${favEl}行生數</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">幸運方位</div>
          <div class="lucky-value">🧭 ${luckyDir}</div>
          <div class="lucky-sub">${favEl}行方位</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">最佳時辰</div>
          <div class="lucky-value">⏰ ${luckyTime}</div>
          <div class="lucky-sub">${favEl}行旺時</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">幸運水晶</div>
          <div class="lucky-value">💎 ${luckyCrystal}</div>
          <div class="lucky-sub">${favEl}行水晶</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">今日干支</div>
          <div class="lucky-value">${todayGZ.dayGan}${todayGZ.dayZhi}</div>
          <div class="lucky-sub">${_dayEl}行日${_isDayFav?' ✅ 順風':_isDayClash?' ⚠ 逆風':''}</div>
        </div>
      </div>
      <div style="margin-top:.6rem;padding:.5rem .8rem;background:${_isDayClash?'rgba(248,113,113,.08)':'rgba(212,175,55,.06)'};border-left:3px solid ${_isDayClash?'#f87171':'var(--c-gold)'};border-radius:0 6px 6px 0;font-size:.78rem;line-height:1.6">
        <p>${_favChakra.icon} <strong>今日脈輪處方</strong></p>
        <p style="margin:3px 0">${chakraText}</p>
        <p style="margin:3px 0">${chakraRx}</p>
      </div>
      <p class="text-xs text-muted mt-md">每日 00:00 更新 · 依你命盤喜用神 × 流日五行動態推算</p>
    </div>`;
}

/* Init games */
document.addEventListener('DOMContentLoaded', function(){
  renderZodiacMatch();
  generateLuckyInfo();
});

/* =============================================================
   FEATURE: 能量行事曆 + 靈氣濾鏡 v2
   八字×姓名學交叉驗證
   ============================================================= */

/* ── 任意日期干支計算 ── */
function getDateGZ(y,m,d){
  var base=new Date(1900,0,1),tgt=new Date(y,m-1,d);
  var diff=Math.floor((tgt-base)/864e5);
  var dc=((diff+10)%60+60)%60;
  var gi=dc%10,zi=dc%12;
  return{gan:TG[gi],zhi:DZ[zi],el:WX_G[TG[gi]],gi:gi,zi:zi};
}

/* ── 每日運勢計算（八字×姓名學交叉驗證）── */
function computeDateFortune(bazi,dateObj){
  var y=dateObj.getFullYear(),m=dateObj.getMonth()+1,d=dateObj.getDate();
  var gz=getDateGZ(y,m,d);
  var dm=bazi.dm,dmEl=bazi.dmEl;
  var tEl=gz.el,tG=gz.gan,tZ=gz.zhi;
  var score=50;

  // 1. 十神
  var god=tenGod(dm,tG);
  var gs={'比肩':8,'劫財':3,'食神':10,'傷官':2,'偏財':7,'正財':12,'七殺':-8,'正官':5,'偏印':6,'正印':10};
  score+=(gs[god]||0);

  // 2. 喜忌神
  if(bazi.fav.indexOf(tEl)>=0) score+=15;
  if(bazi.unfav.indexOf(tEl)>=0) score-=15;

  // 3. 地支藏干
  var cg=CG[tZ]||[];
  cg.forEach(function(g){
    if(bazi.fav.indexOf(WX_G[g])>=0) score+=4;
    if(bazi.unfav.indexOf(WX_G[g])>=0) score-=4;
  });

  // 4. 沖合日支
  var dZ=bazi.pillars.day.zhi;
  var isChong=LIU_CHONG[tZ]===dZ;
  var isHe=LIU_HE[tZ]===dZ;
  if(isChong) score-=12;
  if(isHe) score+=10;

  // 5. 十二長生
  var cs=changSheng(dm,tZ);
  var csS={'長生':10,'沐浴':2,'冠帶':6,'臨官':8,'帝旺':12,'衰':-2,'病':-5,'死':-8,'墓':-6,'絕':-10,'胎':1,'養':3};
  score+=(csS[cs]||0);

  // 6. 大運
  var cd=bazi.dayun?bazi.dayun.find(function(x){return x.isCurrent}):null;
  if(cd){
    if(bazi.fav.indexOf(cd.el)>=0) score+=5;
    if(bazi.unfav.indexOf(cd.el)>=0) score-=5;
  }

  // 7. 姓名學交叉：生肖派結果加減
  if(typeof S!=='undefined'&&S.zodiacNameResult){
    var zn=S.zodiacNameResult;
    if(zn.overallLevel==='大吉') score+=3;
    else if(zn.overallLevel==='吉') score+=1;
    else if(zn.overallLevel&&zn.overallLevel.indexOf('凶')>=0) score-=3;
    // 犧牲格特殊扣分
    if(zn.isSacrifice) score-=2;
  }

  // 8. 西洋星盤交叉：行星相位日影響
  if(typeof S!=='undefined'&&S.natal){
    var np=S.natal;
    // 太陽所在宮位：1,5,9,10=吉宮 6,8,12=凶宮
    var sunH=np.planets['太陽']?np.planets['太陽'].house:0;
    if([1,5,9,10].indexOf(sunH)>=0) score+=3;
    if([6,8,12].indexOf(sunH)>=0) score-=2;
    // 吉凶相位比
    var gA=np.aspects?np.aspects.filter(function(a){return a.good}).length:0;
    var bA=np.aspects?np.aspects.filter(function(a){return !a.good}).length:0;
    if(gA>bA+3) score+=4;
    else if(bA>gA+3) score-=3;
  }

  score=Math.max(10,Math.min(95,score));

  // 籤等
  var sign,icon,cls;
  if(score>=85){sign='上上籤';icon='\u{1F31F}';cls='lv5';}
  else if(score>=75){sign='大吉';icon='\u{1F34A}';cls='lv4';}
  else if(score>=65){sign='上吉';icon='\u2728';cls='lv3';}
  else if(score>=55){sign='中吉';icon='\u{1F319}';cls='lv2';}
  else if(score>=45){sign='小吉';icon='\u26C5';cls='lv2';}
  else if(score>=35){sign='中平';icon='\u2601';cls='lv1';}
  else if(score>=25){sign='小凶';icon='\u{1F30A}';cls='lv0';}
  else{sign='凶';icon='\u26A1';cls='lvN';}

  // ── 詳細提示（結合十神、沖合、長生、喜忌） ──
  var tipParts=[];

  // 十神解讀（針對日常生活）
  var godTip={
    '比肩':'同儕互動多，適合團隊合作、交流想法',
    '劫財':'競爭壓力大，守財為上、少借錢出去',
    '食神':'靈感充沛，適合創作、學習、享受美食',
    '傷官':'表達慾強但容易得罪人，說話前三思',
    '偏財':'偏財運動，可小試投資、留意意外收入',
    '正財':'正財穩定，適合處理帳務、簽約、談薪',
    '七殺':'壓力較大，注意與上司或權威人士的互動',
    '正官':'貴人運佳，適合拜訪長輩、處理公事',
    '偏印':'思緒活躍但不安定，適合研究、不宜衝動決定',
    '正印':'學習運強，適合進修、考試、閱讀充電'
  };
  if(godTip[god]) tipParts.push(god+'日：'+godTip[god]);

  // 沖合提示
  if(isChong) tipParts.push('⚠ 日支逢沖（'+tZ+'沖'+dZ+'），情緒波動大、注意交通安全');
  if(isHe) tipParts.push('✓ 日支逢合（'+tZ+'合'+dZ+'），人際和諧、合作順利');

  // 長生狀態
  var csTip={
    '長生':'精神飽滿，開始新事物的好時機',
    '沐浴':'桃花旺但判斷力下降，感情事冷靜處理',
    '冠帶':'自信心強，適合展現自我、談判',
    '臨官':'事業運佳，適合爭取機會、主動出擊',
    '帝旺':'能量巔峰，但物極必反、勿過度冒險',
    '衰':'體力下降，適當休息比硬撐更有效率',
    '病':'身體要注意，避免過勞、多喝水多休息',
    '死':'能量低谷，宜靜不宜動、處理收尾工作',
    '墓':'適合整理、反省、收納，不宜開始新計畫',
    '絕':'低潮期，保守行事、等待轉機',
    '胎':'醞釀期，可以規劃但不急著行動',
    '養':'恢復期，慢慢養精蓄銳、打好基礎'
  };
  if(csTip[cs]) tipParts.push(cs+'位：'+csTip[cs]);

  // 喜忌提示
  if(bazi.fav.indexOf(tEl)>=0) tipParts.push('今日天干'+tG+'屬'+tEl+'為喜用神，整體能量加持');
  else if(bazi.unfav.indexOf(tEl)>=0) tipParts.push('今日天干'+tG+'屬'+tEl+'為忌神，行事宜低調謹慎');

  var tip=tipParts.slice(0,3).join('。')+'。';

  // 水晶：不再每天輪換，統一推薦喜用神對應水晶
  var favEl=bazi.fav[0]||dmEl;
  var cMap={'金':['鈦晶','白水晶','銀髮晶'],'木':['綠幽靈','東陵玉','綠碧璽'],'水':['海藍寶','月光石','拉長石'],'火':['紅瑪瑙','紫水晶','太陽石'],'土':['黃水晶','虎眼石','茶晶']};
  var cList=cMap[favEl]||cMap['土'];
  var crystal=cList[0];

  return{date:dateObj,ds:dateObj.toISOString().slice(0,10),score:score,sign:sign,icon:icon,cls:cls,tip:tip,crystal:crystal,god:god,cs:cs,gz:tG+tZ,tEl:tEl,favEl:favEl,isChong:isChong,isHe:isHe};
}

/* ── 行事曆渲染 ── */
var cal30Data=[];
var cal30VM=0;

function renderCal30(){
  var box=document.getElementById('cal30-box');
  if(!box)return;
  if(!S.bazi){
    box.innerHTML='<div class="text-center" style="padding:var(--sp-lg)"><p class="text-dim text-sm mb-md">\u9700\u8981\u5148\u5B8C\u6210\u57FA\u672C\u8CC7\u6599\uFF08\u751F\u65E5\u6642\u8FB0\uFF09</p><button class="btn btn-gold btn-sm" onclick="goStep(0)"><i class="fas fa-pen"></i> \u524D\u5F80\u586B\u5BEB</button></div>';
    return;
  }
  cal30Data=[];
  var today=new Date();today.setHours(0,0,0,0);
  for(var i=0;i<60;i++){
    var dd=new Date(today);dd.setDate(dd.getDate()+i);
    cal30Data.push(computeDateFortune(S.bazi,dd));
  }
  var f30=cal30Data.slice(0,30);
  var ji=0,ping=0,xiong=0;
  f30.forEach(function(x){if(x.score>=65)ji++;else if(x.score>=35)ping++;else xiong++;});

  var znTag='';
  if(S.zodiacNameResult){
    var zn=S.zodiacNameResult;
    znTag='<p class="text-xs text-muted mt-xs">\u59D3\u540D\u5B78\u4EA4\u53C9\uFF1A'+zn.emoji+zn.zodiac+'\u5E74\u751F\u4EBA\u300C'+zn.name+'\u300D\u5224\u5B9A\u3010'+zn.overallLevel+'\u3011\uFF0C\u5DF2\u7D0D\u5165\u6BCF\u65E5\u8A08\u7B97</p>';
  }

  box.innerHTML='<div class="cal30-sts"><div class="cal30-st"><div class="cal30-sn" style="color:#4ade80">'+ji+'</div><div class="cal30-sl">\u5409\u65E5\uFF08\u9069\u5408\u884C\u52D5\uFF09</div></div><div class="cal30-st"><div class="cal30-sn" style="color:var(--c-text-dim)">'+ping+'</div><div class="cal30-sl">\u5E73\u7A69\u65E5</div></div><div class="cal30-st"><div class="cal30-sn" style="color:#f87171">'+xiong+'</div><div class="cal30-sl">\u4F4E\u8C37\u4F11\u990A\u65E5</div></div></div>'+znTag+'<div class="cal30-mnav"><button onclick="cal30CM(-1)" id="cal30p" style="visibility:hidden"><i class="fas fa-chevron-left"></i></button><div class="cal30-mt" id="cal30t"></div><button onclick="cal30CM(1)" id="cal30n"><i class="fas fa-chevron-right"></i></button></div><div class="cal30-grid" id="cal30g"></div><div class="cal30-legend"><span><i style="background:rgba(74,222,128,.5)"></i>\u5927\u5409</span><span><i style="background:rgba(96,165,250,.4)"></i>\u4E0A\u5409</span><span><i style="background:rgba(212,175,55,.3)"></i>\u4E2D\u5409</span><span><i style="background:rgba(255,255,255,.1)"></i>\u5C0F\u5409/\u4E2D\u5E73</span><span><i style="background:rgba(248,113,113,.3)"></i>\u5C0F\u51F6</span><span><i style="background:rgba(220,50,50,.4)"></i>\u51F6</span></div><div style="margin-top:var(--sp-md)"><div class="card-title" style="font-size:.9rem"><i class="fas fa-list"></i> \u6BCF\u65E5\u8A73\u60C5</div><div class="cal30-det" id="cal30d"></div></div><div style="display:flex;flex-direction:column;gap:var(--sp-xs);margin-top:var(--sp-md)"><button class="btn btn-gold btn-sm" onclick="dlCal30(\'all\')"><i class="fas fa-calendar-plus"></i> \u4E0B\u8F09\u5B8C\u6574\u884C\u4E8B\u66C6\uFF08.ics\uFF09</button><button class="btn btn-outline btn-sm" onclick="dlCal30(\'hl\')"><i class="fas fa-star"></i> \u53EA\u4E0B\u8F09\u5409\u65E5\uFF0B\u51F6\u65E5\u63D0\u9192</button></div><p class="text-xs text-muted mt-sm text-center">\u4E0B\u8F09 .ics \u6A94\u5373\u53EF\u532F\u5165 iPhone / Google / Outlook</p>';

  cal30VM=0;
  renderCal30G();
  renderCal30D();
}

function renderCal30G(){
  var today=new Date();today.setHours(0,0,0,0);
  var bm=new Date(today.getFullYear(),today.getMonth()+cal30VM,1);
  var yr=bm.getFullYear(),mo=bm.getMonth();
  var te=document.getElementById('cal30t');
  if(te)te.textContent=yr+'\u5E74 '+(mo+1)+'\u6708';
  var g=document.getElementById('cal30g');
  if(!g)return;
  g.innerHTML='';
  ['\u65E5','\u4E00','\u4E8C','\u4E09','\u56DB','\u4E94','\u516D'].forEach(function(n){
    var e=document.createElement('div');e.className='cal30-hdr';e.textContent=n;g.appendChild(e);
  });
  var fd=bm.getDay();
  for(var i=0;i<fd;i++){var e=document.createElement('div');e.className='cal30-day empty';g.appendChild(e);}
  var dim=new Date(yr,mo+1,0).getDate();
  var ts=today.toISOString().slice(0,10);
  for(var d=1;d<=dim;d++){
    var dObj=new Date(yr,mo,d);
    var ds=dObj.toISOString().slice(0,10);
    var data=null;
    for(var j=0;j<cal30Data.length;j++){if(cal30Data[j].ds===ds){data=cal30Data[j];break;}}
    var e=document.createElement('div');
    e.className='cal30-day';
    if(data){
      e.classList.add(data.cls);
      e.innerHTML='<span class="cd-num">'+d+'</span><span class="cd-icon">'+data.icon+'</span>';
      e.title=data.sign+' '+data.tip+' \uFF5C\u{1F48E} '+data.crystal;
    }else{
      e.innerHTML='<span class="cd-num" style="color:var(--c-text-muted)">'+d+'</span>';
    }
    if(ds===ts)e.classList.add('is-today');
    g.appendChild(e);
  }
  var pb=document.getElementById('cal30p'),nb=document.getElementById('cal30n');
  if(pb)pb.style.visibility=cal30VM>0?'visible':'hidden';
  if(nb)nb.style.visibility=cal30VM<1?'visible':'hidden';
}

function cal30CM(dir){cal30VM=Math.max(0,Math.min(1,cal30VM+dir));renderCal30G();}

function renderCal30D(){
  var list=document.getElementById('cal30d');
  if(!list)return;
  var f30=cal30Data.slice(0,30);
  var html='';
  var wds=['\u65E5','\u4E00','\u4E8C','\u4E09','\u56DB','\u4E94','\u516D'];
  f30.forEach(function(day){
    var d=day.date;
    var wd=wds[d.getDay()];
    var ct=day.isChong?' <span style="color:#f87171;font-size:.7rem">\u26A0\u6C96</span>':'';
    var ht=day.isHe?' <span style="color:#4ade80;font-size:.7rem">\u2713\u5408</span>':'';
    html+='<div class="cal30-di"><div style="min-width:48px;font-weight:700;color:var(--c-text-dim);font-size:.78rem">'+(d.getMonth()+1)+'/'+d.getDate()+'<br><span style="font-size:.65rem;color:var(--c-text-muted)">\u9031'+wd+'</span></div><div style="min-width:16px;text-align:center">'+day.icon+'</div><div style="flex:1;line-height:1.5"><strong style="font-size:.78rem">'+day.sign+'</strong> <span class="text-xs text-muted">'+day.gz+'('+day.tEl+')\u00B7'+day.god+'</span>'+ct+ht+'<br><span style="color:var(--c-text-dim);font-size:.75rem">'+day.tip+'</span></div></div>';
  });
  list.innerHTML=html;
}

function fmtICS(d){return d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0');}

function dlCal30(mode){
  if(!cal30Data.length)return;
  var days=cal30Data.slice(0,30);
  if(mode==='hl')days=days.filter(function(x){return x.score>=65||x.score<35;});
  var dm=S.bazi?S.bazi.dm:'';
  var lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//JingYue//Cal30//ZH','CALSCALE:GREGORIAN','METHOD:PUBLISH','X-WR-CALNAME:\u975C\u6708\u4E4B\u5149 \u80FD\u91CF\u884C\u4E8B\u66C6','X-WR-TIMEZONE:Asia/Taipei'];
  days.forEach(function(day){
    var ds=fmtICS(day.date);
    lines.push('BEGIN:VEVENT','UID:jy-'+ds+'-'+dm+'@jingyue.com','DTSTART;VALUE=DATE:'+ds,'DTEND;VALUE=DATE:'+ds,'SUMMARY:'+day.icon+' '+day.sign+'\uFF08'+day.gz+'\uFF09','DESCRIPTION:'+day.tip+'\\n\u{1F48E} \u5EFA\u8B70\u914D\u6234\uFF1A'+day.crystal+'\\n\u5341\u795E\uFF1A'+day.god+'\\n\\n\u2726 \u975C\u6708\u4E4B\u5149\u80FD\u91CF\u884C\u4E8B\u66C6 \u2726','TRANSP:TRANSPARENT','BEGIN:VALARM','TRIGGER:-PT0M','ACTION:DISPLAY','DESCRIPTION:'+day.icon+' '+day.sign+' \u5EFA\u8B70\u914D\u6234\uFF1A'+day.crystal,'END:VALARM','END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  var blob=new Blob([lines.join('\r\n')],{type:'text/calendar;charset=utf-8'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download='\u975C\u6708\u4E4B\u5149_\u884C\u4E8B\u66C6_'+dm+'.ics';
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
}

/* ── 靈氣濾鏡 ── */
/* ═══════════════════════════════════════════════════════
   靈氣濾鏡 v4 — 七脈輪×八字×姓名學 當日能量分析
   ═══════════════════════════════════════════════════════ */

/*
  核心邏輯：
  1. 算出當日干支的五行
  2. 結合八字日主、喜忌神、十神、沖合、姓名學
  3. 計算五行能量分佈（金木水火土各多少%）
  4. 最強五行 → 對應脈輪（五行→脈輪映射）
  5. 水晶推薦依「喜用神」，絕不推忌神的水晶
*/

/* 七脈輪資料（真實脈輪體系） */
var CHAKRA_DATA={
  root:{name:'\u6D77\u5E95\u8F2A',en:'Root Chakra',color:'#dc2626',glow:'rgba(220,38,38,',
    body:'\u9AA8\u76C6\u5E95\u90E8\u3001\u96D9\u817F\u3001\u8170\u690E',
    theme:'\u5B89\u5168\u611F\u3001\u751F\u5B58\u672C\u80FD\u3001\u8173\u8E0F\u5BE6\u5730',
    balanced:'\u5145\u6EFF\u6D3B\u529B\u3001\u611F\u5230\u5B89\u7A69\u8E0F\u5BE6\uFF0C\u751F\u547D\u529B\u65FA\u76DB',
    imbalanced:'\u7126\u616E\u4E0D\u5B89\u3001\u7F3A\u4E4F\u5B89\u5168\u611F\uFF0C\u5BB9\u6613\u75B2\u52DE'},
  sacral:{name:'\u81CD\u9AA8\u8F2A',en:'Sacral Chakra',color:'#ea580c',glow:'rgba(234,88,12,',
    body:'\u4E0B\u8179\u90E8\u3001\u751F\u6B96\u7CFB\u7D71\u3001\u814E\u81DF',
    theme:'\u60C5\u611F\u3001\u6109\u6085\u3001\u5275\u9020\u529B\u3001\u611F\u5B98\u4EAB\u53D7',
    balanced:'\u60C5\u611F\u8C50\u6CBB\u3001\u5275\u9020\u529B\u6D3B\u8E8D\uFF0C\u4EBA\u969B\u95DC\u4FC2\u5713\u6ED1',
    imbalanced:'\u60C5\u7DD2\u58D3\u6291\u3001\u7F6A\u60E1\u611F\uFF0C\u5275\u9020\u529B\u53D7\u963B'},
  solar:{name:'\u592A\u967D\u795E\u7D93\u53E2\u8F2A',en:'Solar Plexus',color:'#eab308',glow:'rgba(234,179,8,',
    body:'\u4E0A\u8179\u90E8\u3001\u80C3\u3001\u809D\u81BD',
    theme:'\u81EA\u4FE1\u3001\u610F\u5FD7\u529B\u3001\u500B\u4EBA\u529B\u91CF\u3001\u81EA\u5C0A',
    balanced:'\u81EA\u4FE1\u5145\u6EFF\u3001\u610F\u5FD7\u5805\u5B9A\uFF0C\u4E8B\u696D\u904B\u52E2\u5F37\u52C1',
    imbalanced:'\u81EA\u5351\u6216\u63A7\u5236\u6B32\u5F37\u3001\u6D88\u5316\u554F\u984C\u3001\u512A\u67D4\u5BE1\u65B7'},
  heart:{name:'\u5FC3\u8F2A',en:'Heart Chakra',color:'#22c55e',glow:'rgba(34,197,94,',
    body:'\u80F8\u53E3\u3001\u5FC3\u81DF\u3001\u80BA\u90E8\u3001\u624B\u81C2',
    theme:'\u611B\u3001\u540C\u7406\u5FC3\u3001\u7642\u7652\u3001\u5305\u5BB9\u63A5\u7D0D',
    balanced:'\u5145\u6EFF\u611B\u8207\u6148\u60B2\u3001\u8207\u4ED6\u4EBA\u548C\u8AE7\u5171\u8655\uFF0C\u5FC3\u9748\u5E73\u9759',
    imbalanced:'\u5C01\u9589\u81EA\u6211\u3001\u904E\u5EA6\u4ED8\u51FA\u3001\u60B2\u50B7\u96E3\u4EE5\u91CB\u61F7'},
  throat:{name:'\u5589\u8F2A',en:'Throat Chakra',color:'#3b82f6',glow:'rgba(59,130,246,',
    body:'\u5589\u5634\u3001\u9838\u90E8\u3001\u7532\u72C0\u817A',
    theme:'\u8868\u9054\u3001\u6E9D\u901A\u3001\u771F\u5BE6\u3001\u81E3\u670D',
    balanced:'\u8868\u9054\u6E05\u6670\u3001\u5BE6\u8A71\u5BE6\u8AAA\uFF0C\u6E9D\u901A\u9806\u66A2\u6709\u529B',
    imbalanced:'\u58D3\u6291\u4E0D\u8A00\u6216\u53E3\u7121\u906E\u6514\u3001\u5014\u5F37\u9867\u56FA'},
  third_eye:{name:'\u7709\u5FC3\u8F2A',en:'Third Eye',color:'#6d28d9',glow:'rgba(109,40,217,',
    body:'\u7709\u5FC3\u3001\u984D\u982D\u3001\u677E\u679C\u9AD4\u3001\u795E\u7D93\u7CFB\u7D71',
    theme:'\u76F4\u89BA\u3001\u6D1E\u5BDF\u529B\u3001\u5167\u5728\u667A\u6167\u3001\u89BA\u5BDF',
    balanced:'\u76F4\u89BA\u654F\u92B3\u3001\u6D1E\u5BDF\u529B\u5F37\uFF0C\u80FD\u770B\u900F\u4E8B\u7269\u672C\u8CEA',
    imbalanced:'\u6DF7\u4E82\u3001\u8FF7\u5931\u65B9\u5411\u3001\u6D3B\u5728\u5E7B\u8C61\u4E2D'},
  crown:{name:'\u9802\u8F2A',en:'Crown Chakra',color:'#a855f7',glow:'rgba(168,85,247,',
    body:'\u982D\u9802\u3001\u5927\u8166\u76AE\u5C64',
    theme:'\u9748\u6027\u3001\u5B87\u5B99\u9023\u7D50\u3001\u958B\u609F\u3001\u8D85\u8D8A',
    balanced:'\u9748\u6027\u89BA\u9192\u3001\u8207\u5B87\u5B99\u5408\u4E00\uFF0C\u5167\u5FC3\u5E73\u548C\u5145\u5BE6',
    imbalanced:'\u7591\u96E2\u3001\u8FF7\u4FE1\u3001\u8207\u5167\u5728\u65B7\u9023'}
};

/* 五行→脈輪映射（核心邏輯）
   火→海底輪(生命力)+臍骨輪(熱情)
   土→太陽神經叢(穩定+意志)
   木→心輪(生長+療癒)
   水→喉輪(溝通)+眉心輪(智慧)
   金→頂輪(純淨+超越)
*/
var EL_CHAKRA={
  '\u706B':['root','sacral'],
  '\u571F':['solar'],
  '\u6728':['heart'],
  '\u6C34':['throat','third_eye'],
  '\u91D1':['crown']
};

/* 水晶推薦（按喜用神五行，絕不推忌神五行的水晶）*/
var CRYSTAL_BY_FAV={
  '\u91D1':['\u9226\u6676','\u767D\u6C34\u6676','\u9280\u9AEE\u6676','\u767D\u5E7B\u5F71\u6C34\u6676'],
  '\u6728':['\u7DA0\u5E7D\u9748','\u6771\u9675\u7389','\u7DA0\u78A7\u74BD','\u7FE0\u9285\u7926'],
  '\u6C34':['\u6D77\u85CD\u5BF6','\u6708\u5149\u77F3','\u62C9\u9577\u77F3','\u85CD\u7D0B\u77F3'],
  '\u706B':['\u7D05\u746A\u7459','\u77F3\u69B4\u77F3','\u592A\u967D\u77F3','\u8840\u73C0'],
  '\u571F':['\u9EC3\u6C34\u6676','\u864E\u773C\u77F3','\u8336\u6676','\u5357\u7D05\u746A\u7459']
};

var auraImg=null;

function hexToRGBA(hex,a){
  var r=0,g=0,b=0;
  if(hex.length===7){r=parseInt(hex.slice(1,3),16);g=parseInt(hex.slice(3,5),16);b=parseInt(hex.slice(5,7),16);}
  else if(hex.length===4){r=parseInt(hex[1]+hex[1],16);g=parseInt(hex[2]+hex[2],16);b=parseInt(hex[3]+hex[3],16);}
  return 'rgba('+r+','+g+','+b+','+a+')';
}

/* ── 當日脈輪能量分析 ── */
function analyzeTodayChakra(bazi){
  var today=new Date();
  var y=today.getFullYear(),m=today.getMonth()+1,d=today.getDate();
  var gz=getDateGZ(y,m,d);
  var dm=bazi.dm,dmEl=bazi.dmEl;
  var tG=gz.gan,tZ=gz.zhi,tEl=gz.el;

  /* Step 1: 計算五行能量分佈（以當日天干地支為主，本命為底色）*/
  var elScore={'\u91D1':0,'\u6728':0,'\u6C34':0,'\u706B':0,'\u571F':0};

  // 日干五行 (本命底色 — 降低權重，讓當日變化能主導)
  elScore[dmEl]+=8;

  // 當日天干五行（主導當日能量）
  elScore[tEl]+=25;

  // 當日地支藏干（重要的日支能量）
  var cg=CG[tZ]||[];
  cg.forEach(function(g,i){elScore[WX_G[g]]+=(i===0?12:6);});

  // 十神影響：不同十神激發不同五行
  var god=tenGod(dm,tG);
  if(god==='\u98DF\u795E'||god==='\u50B7\u5B98'){
    elScore['\u706B']+=6;elScore['\u6728']+=4;
  }
  if(god==='\u6B63\u5370'||god==='\u504F\u5370'){
    elScore['\u6C34']+=6;elScore['\u91D1']+=4;
  }
  if(god==='\u6B63\u8CA1'||god==='\u504F\u8CA1'){
    elScore['\u571F']+=6;elScore['\u706B']+=4;
  }
  if(god==='\u6B63\u5B98'||god==='\u4E03\u6BBA'){
    elScore['\u706B']+=6;
  }
  if(god==='\u6BD4\u80A9'||god==='\u52AB\u8CA1'){
    elScore[dmEl]+=4;
  }

  // 喜神微調（不再大幅加分，只做微調）
  bazi.fav.forEach(function(el){elScore[el]+=3;});
  bazi.unfav.forEach(function(el){elScore[el]-=3;});

  // 沖合影響
  var dZ=bazi.pillars.day.zhi;
  if(LIU_CHONG[tZ]===dZ){elScore['\u706B']+=6;} // 沖→不安→海底輪
  if(LIU_HE[tZ]===dZ){elScore['\u6728']+=6;}    // 合→和諧→心輪

  // 姓名學加減
  if(typeof S!=='undefined'&&S.zodiacNameResult){
    var zn=S.zodiacNameResult;
    if(zn.overallLevel==='\u5927\u5409'){elScore['\u91D1']+=5;elScore['\u6C34']+=3;}
    else if(zn.overallLevel==='\u5409'){elScore['\u6728']+=4;}
    else if(zn.overallLevel&&zn.overallLevel.indexOf('\u51F6')>=0){elScore['\u706B']+=5;}
    if(zn.isSacrifice){elScore['\u706B']+=4;}
  }

  // 確保沒有負值
  for(var k in elScore){if(elScore[k]<0)elScore[k]=0;}

  /* Step 2: 找最強五行 → 對應脈輪 */
  var maxEl='',maxVal=0,total=0;
  for(var k in elScore){
    total+=elScore[k];
    if(elScore[k]>maxVal){maxVal=elScore[k];maxEl=k;}
  }

  // 計算百分比
  var elPct={};
  for(var k in elScore){elPct[k]=total>0?Math.round(elScore[k]/total*100):20;}

  // 映射到脈輪
  var chakraKeys=EL_CHAKRA[maxEl]||['heart'];
  // 如果有兩個脈輪對應，選第一個（主脈輪）
  // 但若分數很高（>60%），可能激活第二個
  var primaryKey=chakraKeys[0];
  var secondaryKey=chakraKeys.length>1?chakraKeys[1]:null;
  var ch=CHAKRA_DATA[primaryKey];

  /* Step 3: 吉凶（基於整體能量平衡度）*/
  var score=50;
  var godS={'\u6BD4\u80A9':5,'\u52AB\u8CA1':2,'\u98DF\u795E':8,'\u50B7\u5B98':1,'\u504F\u8CA1':6,'\u6B63\u8CA1':10,'\u4E03\u6BBA':-8,'\u6B63\u5B98':4,'\u504F\u5370':5,'\u6B63\u5370':8};
  score+=(godS[god]||0);
  if(bazi.fav.indexOf(tEl)>=0)score+=12;
  if(bazi.unfav.indexOf(tEl)>=0)score-=12;
  cg.forEach(function(g){
    if(bazi.fav.indexOf(WX_G[g])>=0)score+=3;
    if(bazi.unfav.indexOf(WX_G[g])>=0)score-=3;
  });
  if(LIU_CHONG[tZ]===dZ)score-=10;
  if(LIU_HE[tZ]===dZ)score+=8;
  var cs=changSheng(dm,tZ);
  var csS={'\u9577\u751F':8,'\u6C90\u6D74':1,'\u51A0\u5E36':5,'\u81E8\u5B98':7,'\u5E1D\u65FA':10,'\u8870':-2,'\u75C5':-5,'\u6B7B':-8,'\u5893':-6,'\u7D55':-10,'\u80CE':1,'\u990A':3};
  score+=(csS[cs]||0);
  if(S.zodiacNameResult){
    var zn=S.zodiacNameResult;
    if(zn.overallLevel==='\u5927\u5409')score+=4;
    else if(zn.overallLevel==='\u5409')score+=2;
    else if(zn.overallLevel&&zn.overallLevel.indexOf('\u51F6')>=0)score-=4;
  }
  score=Math.max(10,Math.min(95,score));

  var fortune,fIcon;
  if(score>=80){fortune='\u5927\u5409';fIcon='\u{1F31F}';}
  else if(score>=65){fortune='\u4E0A\u5409';fIcon='\u2728';}
  else if(score>=50){fortune='\u4E2D\u5409';fIcon='\u{1F319}';}
  else if(score>=35){fortune='\u4E2D\u5E73';fIcon='\u26C5';}
  else{fortune='\u504F\u51F6';fIcon='\u26A1';}

  /* Step 4: 水晶推薦（只用喜用神的水晶！）*/
  var favEl=bazi.fav[0]||dmEl;
  var cList=CRYSTAL_BY_FAV[favEl]||CRYSTAL_BY_FAV['\u6C34'];
  // 確保推的水晶不是忌神五行
  var safeCrystals=[];
  for(var el in CRYSTAL_BY_FAV){
    if(bazi.unfav.indexOf(el)<0){
      CRYSTAL_BY_FAV[el].forEach(function(cr){safeCrystals.push({name:cr,el:el});});
    }
  }
  // 優先喜用神的
  var crystal=cList[(d+m)%cList.length];
  // 如果喜用神水晶的五行剛好是忌神（不太可能但防禦）
  if(bazi.unfav.indexOf(favEl)>=0&&safeCrystals.length>0){
    crystal=safeCrystals[(d+m)%safeCrystals.length].name;
  }

  return{
    chakra:ch,chakraKey:primaryKey,secondaryKey:secondaryKey,
    elScore:elScore,elPct:elPct,maxEl:maxEl,
    score:score,fortune:fortune,fIcon:fIcon,
    god:god,cs:cs,gz:tG+tZ,tEl:tEl,crystal:crystal,favEl:favEl
  };
}

/* ── 初始化 ── */
function renderAuraFilter(){
  var box=document.getElementById('aura-box');
  if(!box)return;
  if(!S.bazi){
    box.innerHTML='<div class="text-center" style="padding:var(--sp-lg)"><p class="text-dim text-sm mb-md">\u9700\u8981\u5148\u5B8C\u6210\u57FA\u672C\u8CC7\u6599\uFF08\u751F\u65E5\u6642\u8FB0\uFF09</p><button class="btn btn-gold btn-sm" onclick="goStep(0)"><i class="fas fa-pen"></i> \u524D\u5F80\u586B\u5BEB</button></div>';
    return;
  }
  box.innerHTML='<div class="aura-up" id="aura-uz" onclick="document.getElementById(\'aura-fi\').click()"><div style="font-size:2.5rem;color:var(--c-gold);opacity:.6;margin-bottom:var(--sp-sm)"><i class="fas fa-cloud-arrow-up"></i></div><p class="text-sm text-dim">\u9EDE\u64CA\u4E0A\u50B3\u6216\u62D6\u66F3\u81EA\u62CD\u7167</p><p style="color:var(--c-gold);font-weight:700;margin-top:4px">\u5206\u6790\u7576\u65E5\u4E03\u8108\u8F2A\u80FD\u91CF\u8272</p><p class="text-xs text-muted mt-xs">\u652F\u63F4 JPG / PNG\uFF0C\u4E0A\u50B3\u5F8C\u81EA\u52D5\u5206\u6790</p></div><input type="file" id="aura-fi" accept="image/jpeg,image/png,image/webp" style="display:none" onchange="handleAF(this.files[0])"><div id="aura-progress" style="display:none"></div><div id="aura-result" style="display:none"></div>';
  setTimeout(function(){
    var uz=document.getElementById('aura-uz');if(!uz)return;
    uz.addEventListener('dragover',function(e){e.preventDefault();uz.style.borderColor='var(--c-gold)';});
    uz.addEventListener('dragleave',function(){uz.style.borderColor='';});
    uz.addEventListener('drop',function(e){e.preventDefault();uz.style.borderColor='';if(e.dataTransfer.files.length)handleAF(e.dataTransfer.files[0]);});
  },100);
}

/* ── 上傳處理 ── */
function handleAF(file){
  if(!file||!file.type.startsWith('image/')||!S.bazi)return;
  var tc=analyzeTodayChakra(S.bazi);
  var ch=tc.chakra;
  document.getElementById('aura-uz').style.display='none';
  var prog=document.getElementById('aura-progress');
  prog.style.display='block';
  prog.innerHTML='<div style="text-align:center;padding:var(--sp-xl) var(--sp-md)"><div class="aura-orb" style="width:48px;height:48px;background:radial-gradient(circle,'+ch.color+','+ch.glow+'0.15));box-shadow:0 0 30px '+ch.glow+'0.4);margin:0 auto var(--sp-md)"></div><p class="text-sm" style="color:'+ch.color+'">\u6B63\u5728\u5206\u6790\u80FD\u91CF\u5834\u2026</p><div style="width:80%;max-width:300px;margin:var(--sp-sm) auto 0;height:6px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden"><div id="aura-bar" style="width:0%;height:100%;background:linear-gradient(90deg,'+ch.color+','+ch.glow+'0.5));border-radius:3px;transition:width 0.3s"></div></div><p id="aura-pct" class="text-xs text-muted mt-xs">0%</p></div>';
  [{t:200,p:15,s:'\u8B80\u53D6\u7576\u65E5\u5E72\u652F\u2026'},{t:600,p:35,s:'\u5206\u6790\u4E94\u884C\u80FD\u91CF\u5206\u4F48\u2026'},{t:1000,p:55,s:'\u4EA4\u53C9\u59D3\u540D\u5B78\u9A57\u8B49\u2026'},{t:1400,p:75,s:'\u5C0D\u61C9\u4E03\u8108\u8F2A\u2026'},{t:1800,p:90,s:'\u5408\u6210\u6C23\u5834\u7167\u7247\u2026'}].forEach(function(x){
    setTimeout(function(){
      var b=document.getElementById('aura-bar'),p=document.getElementById('aura-pct');
      if(b)b.style.width=x.p+'%';if(p)p.textContent=x.p+'% '+x.s;
    },x.t);
  });
  var reader=new FileReader();
  reader.onload=function(e){
    var img=new Image();
    img.onload=function(){
      auraImg=img;
      setTimeout(function(){
        var b=document.getElementById('aura-bar'),p=document.getElementById('aura-pct');
        if(b)b.style.width='100%';if(p)p.textContent='100% \u5B8C\u6210\uFF01';
        setTimeout(showAuraResult,400);
      },2000);
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

/* ── 顯示結果 ── */
function showAuraResult(){
  if(!auraImg||!S.bazi)return;
  var tc=analyzeTodayChakra(S.bazi);
  var ch=tc.chakra;
  var dm=S.bazi.dm,dmEl=S.bazi.dmEl;
  var prog=document.getElementById('aura-progress');if(prog)prog.style.display='none';
  var res=document.getElementById('aura-result');if(!res)return;
  var today=new Date();var ds=(today.getMonth()+1)+'/'+today.getDate();

  var znLine='';
  if(S.zodiacNameResult){
    var zn=S.zodiacNameResult;
    znLine='<div style="font-size:.75rem;color:var(--c-text-muted);margin-top:4px">\u59D3\u540D\u5B78\uFF1A'+zn.emoji+zn.zodiac+'\u5E74\u751F\u4EBA\u3010'+zn.overallLevel+'\u3011\u5DF2\u7D0D\u5165\u8A08\u7B97</div>';
  }

  /* 五行能量條 */
  var elNames={'\u91D1':'\u91D1','\u6728':'\u6728','\u6C34':'\u6C34','\u706B':'\u706B','\u571F':'\u571F'};
  var elColors={'\u91D1':'#d4af37','\u6728':'#22c55e','\u6C34':'#3b82f6','\u706B':'#ef4444','\u571F':'#eab308'};
  var barsHtml='<div style="display:grid;grid-template-columns:32px 1fr 32px;gap:4px;align-items:center;margin:var(--sp-sm) 0;font-size:.72rem">';
  ['\u6728','\u706B','\u571F','\u91D1','\u6C34'].forEach(function(el){
    var pct=tc.elPct[el]||0;
    var isFav=S.bazi.fav.indexOf(el)>=0;
    var isUnfav=S.bazi.unfav.indexOf(el)>=0;
    var tag=isFav?' \u559C':isUnfav?' \u5FCC':'';
    barsHtml+='<span style="color:'+elColors[el]+';font-weight:700">'+elNames[el]+tag+'</span>';
    barsHtml+='<div style="height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden"><div style="width:'+pct+'%;height:100%;background:'+elColors[el]+';border-radius:4px;transition:width .6s"></div></div>';
    barsHtml+='<span style="color:var(--c-text-muted)">'+pct+'%</span>';
  });
  barsHtml+='</div>';

  res.style.display='block';

  // ── 行動導向的一句話 ──
  var actionLine='';
  if(tc.score>=65) actionLine='\u4ECA\u5929\u80FD\u91CF\u72C0\u614B\u4E0D\u932F\uFF0C\u9069\u5408\u53BB\u884C\u52D5\u3001\u505A\u6C7A\u5B9A\u3001\u898B\u91CD\u8981\u7684\u4EBA\u3002';
  else if(tc.score>=45) actionLine='\u4ECA\u5929\u80FD\u91CF\u5E73\u7A69\uFF0C\u8655\u7406\u65E5\u5E38\u4E8B\u52D9\u6C92\u554F\u984C\uFF0C\u4F46\u91CD\u5927\u6C7A\u5B9A\u5EFA\u8B70\u7DE9\u7DE9\u3002';
  else actionLine='\u4ECA\u5929\u80FD\u91CF\u504F\u4F4E\uFF0C\u5EFA\u8B70\u653E\u6162\u8173\u6B65\uFF0C\u907F\u514D\u885D\u52D5\u6D88\u8CBB\u6216\u91CD\u8981\u8AC7\u5224\u3002';

  res.innerHTML='<div class="aura-cw"><canvas id="aura-cv" style="display:block;margin:0 auto"></canvas></div>'
    +'<div class="aura-nfo" style="margin-top:var(--sp-md)">'
    +'<div class="aura-orb" style="background:radial-gradient(circle,#fff,'+ch.color+');box-shadow:0 0 40px '+ch.glow+'0.5),0 0 80px '+ch.glow+'0.25)"></div>'
    +'<div class="aura-cn" style="color:'+ch.color+'">'+ds+' \u7576\u65E5\u80FD\u91CF\uFF1A'+ch.name+'</div>'
    +'<div style="font-size:.9rem;font-weight:600;color:'+ch.color+';margin-top:2px">'+ch.en+' \u2502 '+tc.fIcon+' '+tc.fortune+'</div>'
    +'<div style="font-size:.95rem;color:var(--c-text);margin-top:var(--sp-sm);line-height:1.7;font-weight:600">'+actionLine+'</div>'
    +'<div style="font-size:.85rem;color:var(--c-text-dim);margin-top:var(--sp-xs);line-height:1.6">\u4F60\u7684\u559C\u7528\u795E\u662F<strong style="color:var(--c-gold)">'+tc.favEl+'\u884C</strong>\uFF0C\u4ECA\u5929\u5EFA\u8B70\u914D\u6234\uFF1A<strong style="color:var(--c-gold)">'+tc.crystal+'</strong></div>'
    +barsHtml
    +'<div style="font-size:.72rem;color:var(--c-text-muted);margin-top:var(--sp-xs)">'
    +'\u65E5\u4E3B\u300C'+dm+'\u300D('+dmEl+') \u2502 \u7576\u65E5\uFF1A'+tc.gz+'('+tc.tEl+') \u2502 \u5341\u795E\uFF1A'+tc.god+' \u2502 '+tc.score+'/100'
    +znLine
    +'</div></div>'
    +'<div style="display:flex;gap:var(--sp-xs);margin-top:var(--sp-md);justify-content:center;flex-wrap:wrap">'
    +'<button class="btn btn-gold btn-sm" onclick="dlAura()"><i class="fas fa-download"></i> \u4E0B\u8F09\u80FD\u91CF\u7167\u7247</button>'
    +'<button class="btn btn-outline btn-sm" onclick="resetAF()"><i class="fas fa-redo"></i> \u91CD\u65B0\u4E0A\u50B3</button>'
    +'</div>'
    +'<div class="aura-sh" style="margin-top:var(--sp-sm)"><strong>#\u975C\u6708\u4E4B\u5149 #\u80FD\u91CF\u5149\u74B0 #'+ch.name+' #\u6C34\u6676\u7642\u7652</strong></div>';

  setTimeout(genAura,120);
}

/* ── Canvas 氣場合成（專業美感版）── */
function genAura(){
  if(!auraImg||!S.bazi)return;
  var tc=analyzeTodayChakra(S.bazi);
  var ch=tc.chakra;
  var cv=document.getElementById('aura-cv');
  if(!cv)return;
  var ctx=cv.getContext('2d');
  var img=auraImg;
  var mx=720,sc=Math.min(mx/img.width,mx/img.height,1);
  var iw=Math.round(img.width*sc),ih=Math.round(img.height*sc);
  var pad=Math.round(Math.max(iw,ih)*0.14);
  var cardW=iw+pad*2;

  /* ── 底部資訊卡高度計算 ── */
  var infoH=Math.round(cardW*0.58); /* 精簡版：今日提醒+建議配戴+五行條 */
  cv.width=cardW;cv.height=ih+pad*2+infoH;
  var cx=pad+iw/2,cy=pad+ih*0.42;
  var cw=cv.width,cvH=cv.height;

  var secKeys=EL_CHAKRA[tc.maxEl];
  var secCh=secKeys&&secKeys.length>1?CHAKRA_DATA[secKeys[1]]:null;
  var sec=secCh?secCh.color:'#ff8c00';

  /* ══ 1. 深色漸層背景 ══ */
  var bgG=ctx.createLinearGradient(0,0,0,cvH);
  bgG.addColorStop(0,'#05010d');
  bgG.addColorStop(0.4,'#0a0218');
  bgG.addColorStop(0.7,'#080112');
  bgG.addColorStop(1,'#030108');
  ctx.fillStyle=bgG;ctx.fillRect(0,0,cw,cvH);

  /* ══ 2. 大範圍氣場光暈（副脈輪色）══ */
  var r1=Math.max(iw,ih)*0.95;
  var g1=ctx.createRadialGradient(cx,cy,r1*0.05,cx,cy,r1);
  g1.addColorStop(0,hexToRGBA(sec,0.25));
  g1.addColorStop(0.3,hexToRGBA(sec,0.08));
  g1.addColorStop(0.6,hexToRGBA(sec,0.02));
  g1.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=g1;ctx.fillRect(0,0,cw,cvH);

  /* ══ 3. 主脈輪橢圓光環 ══ */
  ctx.save();ctx.translate(cx,cy);ctx.scale(1,1.35);
  var r2=Math.max(iw,ih)*0.52;
  var g2=ctx.createRadialGradient(0,0,r2*0.04,0,0,r2);
  g2.addColorStop(0,hexToRGBA(ch.color,0.65));
  g2.addColorStop(0.2,hexToRGBA(ch.color,0.35));
  g2.addColorStop(0.5,hexToRGBA(ch.color,0.08));
  g2.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=g2;ctx.fillRect(-cw,-cvH,cw*2,cvH*2);ctx.restore();

  /* ══ 4. 頭部亮點光暈 ══ */
  var hy=cy-ih*0.2,r3=Math.max(iw,ih)*0.26;
  var g3=ctx.createRadialGradient(cx,hy,0,cx,hy,r3);
  g3.addColorStop(0,hexToRGBA('#ffffff',0.3));
  g3.addColorStop(0.12,hexToRGBA(ch.color,0.5));
  g3.addColorStop(0.45,hexToRGBA(ch.color,0.1));
  g3.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=g3;ctx.fillRect(0,0,cw,cvH);

  /* ══ 5. 照片（帶圓角遮罩）══ */
  var rr=Math.round(Math.min(iw,ih)*0.03); /* 圓角 */
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(pad+rr,pad);ctx.lineTo(pad+iw-rr,pad);ctx.quadraticCurveTo(pad+iw,pad,pad+iw,pad+rr);
  ctx.lineTo(pad+iw,pad+ih-rr);ctx.quadraticCurveTo(pad+iw,pad+ih,pad+iw-rr,pad+ih);
  ctx.lineTo(pad+rr,pad+ih);ctx.quadraticCurveTo(pad,pad+ih,pad,pad+ih-rr);
  ctx.lineTo(pad,pad+rr);ctx.quadraticCurveTo(pad,pad,pad+rr,pad);
  ctx.closePath();ctx.clip();
  ctx.drawImage(img,pad,pad,iw,ih);

  /* 照片四邊脈輪色疊加 */
  var et=ctx.createLinearGradient(pad,pad,pad,pad+ih*0.25);
  et.addColorStop(0,hexToRGBA(ch.color,0.4));et.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=et;ctx.fillRect(pad,pad,iw,ih*0.25);
  var eb=ctx.createLinearGradient(pad,pad+ih,pad,pad+ih*0.8);
  eb.addColorStop(0,hexToRGBA(ch.color,0.3));eb.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=eb;ctx.fillRect(pad,pad+ih*0.8,iw,ih*0.2);
  var elg=ctx.createLinearGradient(pad,pad,pad+iw*0.2,pad);
  elg.addColorStop(0,hexToRGBA(ch.color,0.3));elg.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=elg;ctx.fillRect(pad,pad,iw*0.2,ih);
  var erg=ctx.createLinearGradient(pad+iw,pad,pad+iw*0.8,pad);
  erg.addColorStop(0,hexToRGBA(ch.color,0.3));erg.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=erg;ctx.fillRect(pad+iw*0.8,pad,iw*0.2,ih);
  ctx.restore();

  /* ══ 6. 照片外框發光 ══ */
  ctx.save();
  ctx.strokeStyle=hexToRGBA(ch.color,0.4);ctx.lineWidth=1.5;
  ctx.shadowColor=ch.color;ctx.shadowBlur=18;
  ctx.beginPath();
  ctx.moveTo(pad+rr,pad);ctx.lineTo(pad+iw-rr,pad);ctx.quadraticCurveTo(pad+iw,pad,pad+iw,pad+rr);
  ctx.lineTo(pad+iw,pad+ih-rr);ctx.quadraticCurveTo(pad+iw,pad+ih,pad+iw-rr,pad+ih);
  ctx.lineTo(pad+rr,pad+ih);ctx.quadraticCurveTo(pad,pad+ih,pad,pad+ih-rr);
  ctx.lineTo(pad,pad+rr);ctx.quadraticCurveTo(pad,pad,pad+rr,pad);
  ctx.closePath();ctx.stroke();
  ctx.restore();

  /* ══ 7. 星塵粒子 ══ */
  for(var i=0;i<30;i++){
    var ang=(Math.PI*2*i)/30+Math.random()*0.2;
    var dist=Math.min(iw,ih)*0.38+Math.random()*pad*1.5;
    var sx=cx+Math.cos(ang)*dist,sy=cy+Math.sin(ang)*dist*1.1;
    ctx.save();ctx.globalAlpha=0.3+Math.random()*0.55;
    ctx.fillStyle='#fff';ctx.shadowColor=ch.color;ctx.shadowBlur=8;
    ctx.beginPath();ctx.arc(sx,sy,0.8+Math.random()*2,0,Math.PI*2);ctx.fill();
    if(Math.random()>0.6){
      ctx.strokeStyle=hexToRGBA(ch.color,0.5);ctx.lineWidth=0.5;
      ctx.beginPath();ctx.moveTo(sx-4,sy);ctx.lineTo(sx+4,sy);ctx.moveTo(sx,sy-4);ctx.lineTo(sx,sy+5);ctx.stroke();
    }
    ctx.restore();
  }

  /* ══════════════════════════════════════════════
     8. 底部資訊卡（專業排版）
     ══════════════════════════════════════════════ */
  var cardTop=pad*2+ih;
  var cardPad=Math.round(cw*0.06);
  var today=new Date();
  var ds=(today.getMonth()+1)+'/'+today.getDate();

  /* 分隔線（漸層金線）*/
  var dlg=ctx.createLinearGradient(cardPad,cardTop+8,cw-cardPad,cardTop+8);
  dlg.addColorStop(0,'rgba(0,0,0,0)');
  dlg.addColorStop(0.15,hexToRGBA(ch.color,0.6));
  dlg.addColorStop(0.5,hexToRGBA(ch.color,0.8));
  dlg.addColorStop(0.85,hexToRGBA(ch.color,0.6));
  dlg.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=dlg;ctx.fillRect(cardPad,cardTop+6,cw-cardPad*2,1.5);

  /* 底部背景微光 */
  var bgLow=ctx.createRadialGradient(cw/2,cardTop+infoH*0.4,0,cw/2,cardTop+infoH*0.4,cw*0.5);
  bgLow.addColorStop(0,hexToRGBA(ch.color,0.04));
  bgLow.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=bgLow;ctx.fillRect(0,cardTop,cw,infoH);

  /* ── 脈輪光球 ── */
  var orbR=Math.round(cw*0.035);
  var orbY=cardTop+Math.round(infoH*0.12);
  var orbG=ctx.createRadialGradient(cw/2,orbY,0,cw/2,orbY,orbR*2.5);
  orbG.addColorStop(0,'rgba(255,255,255,0.7)');
  orbG.addColorStop(0.2,hexToRGBA(ch.color,0.8));
  orbG.addColorStop(0.6,hexToRGBA(ch.color,0.15));
  orbG.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=orbG;ctx.fillRect(cw/2-orbR*3,orbY-orbR*3,orbR*6,orbR*6);

  /* ── 脈輪名稱（大字）── */
  var fs=Math.max(14,Math.round(cw*0.028));
  var titleY=orbY+orbR*2.5+fs*0.5;
  ctx.textAlign='center';
  ctx.font='bold '+Math.round(fs*1.6)+'px "Noto Serif TC",serif';
  ctx.fillStyle=ch.color;
  ctx.shadowColor=ch.color;ctx.shadowBlur=12;
  ctx.fillText(ds+' 當日能量：'+ch.name,cw/2,titleY);
  ctx.shadowBlur=0;

  /* ── 英文名 + 吉凶 ── */
  var subY=titleY+Math.round(fs*1.3);
  ctx.font='600 '+fs+'px "Noto Sans TC",sans-serif';
  ctx.fillStyle='rgba(245,230,211,0.85)';
  ctx.fillText(ch.en+'  │  '+tc.fIcon+' '+tc.fortune,cw/2,subY);

  /* ── 分隔裝飾線 ── */
  var lineY=subY+Math.round(fs*0.7);
  var lineW=Math.round(cw*0.25);
  var sg=ctx.createLinearGradient(cw/2-lineW,lineY,cw/2+lineW,lineY);
  sg.addColorStop(0,'rgba(0,0,0,0)');sg.addColorStop(0.3,hexToRGBA(ch.color,0.4));
  sg.addColorStop(0.5,hexToRGBA(ch.color,0.6));sg.addColorStop(0.7,hexToRGBA(ch.color,0.4));
  sg.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=sg;ctx.fillRect(cw/2-lineW,lineY,lineW*2,1);

  /* ── 四項資訊（單列，自動換行）── */
  var infoY=lineY+Math.round(fs*1.0);
  var smFs=Math.round(fs*0.82);
  var lblFs=Math.round(fs*0.72);
  var infoMaxW=cw-cardPad*4;

  function drawInfoBlock(y,label,value,col){
    ctx.textAlign='center';
    ctx.font='600 '+lblFs+'px "Noto Sans TC",sans-serif';
    ctx.fillStyle=hexToRGBA(col||ch.color,0.65);
    ctx.fillText(label,cw/2,y);
    ctx.font=smFs+'px "Noto Sans TC",sans-serif';
    ctx.fillStyle='rgba(245,230,211,0.78)';
    /* 自動換行 */
    var chars=[...value],line='',ly=y+Math.round(smFs*1.25),lh2=Math.round(smFs*1.3);
    for(var i=0;i<chars.length;i++){
      var test=line+chars[i];
      if(ctx.measureText(test).width>infoMaxW&&line.length>0){
        ctx.fillText(line,cw/2,ly);ly+=lh2;line=chars[i];
      }else{line=test;}
    }
    if(line) ctx.fillText(line,cw/2,ly);
    return ly+lh2; /* return next Y */
  }

  // 行動導向一句話
  var canvasAction='';
  if(tc.score>=65) canvasAction='\u4ECA\u5929\u80FD\u91CF\u72C0\u614B\u4E0D\u932F\uFF0C\u9069\u5408\u884C\u52D5\u3001\u505A\u6C7A\u5B9A';
  else if(tc.score>=45) canvasAction='\u4ECA\u5929\u80FD\u91CF\u5E73\u7A69\uFF0C\u91CD\u5927\u6C7A\u5B9A\u5EFA\u8B70\u7DE9\u7DE9';
  else canvasAction='\u4ECA\u5929\u80FD\u91CF\u504F\u4F4E\uFF0C\u5EFA\u8B70\u653E\u6162\u8173\u6B65';

  var ny=drawInfoBlock(infoY,'─── \u4ECA\u65E5\u63D0\u9192 ───',canvasAction);
  ny=drawInfoBlock(ny+Math.round(fs*0.2),'─── \u5EFA\u8B70\u914D\u6234 ───',tc.crystal+'\uFF08'+tc.favEl+'\u884C\u559C\u7528\u795E\u6C34\u6676\uFF09');

  /* ── 五行能量條 ── */
  var barY=ny+Math.round(fs*0.5);
  var barW=Math.round(cw*0.55);
  var barH=Math.round(fs*0.5);
  var barX=Math.round((cw-barW)/2+fs*2);
  var barGap=Math.round(fs*1.15);
  var elNames=['木','火','土','金','水'];
  var elColors={'木':'#22c55e','火':'#ef4444','土':'#eab308','金':'#a78bfa','水':'#3b82f6'};
  ctx.textAlign='left';

  elNames.forEach(function(el,i){
    var pct=tc.elPct[el]||0;
    var isFav=S.bazi.fav.indexOf(el)>=0;
    var isUnfav=S.bazi.unfav.indexOf(el)>=0;
    var by=barY+i*barGap;
    var label=el+(isFav?' 喜':isUnfav?' 忌':'');

    /* 標籤 */
    ctx.font='600 '+lblFs+'px "Noto Sans TC",sans-serif';
    ctx.fillStyle=isFav?'#4ade80':isUnfav?'#f87171':'rgba(245,230,211,0.55)';
    ctx.fillText(label,barX-Math.round(fs*2.2),by+barH*0.8);

    /* 背景條 */
    ctx.fillStyle='rgba(255,255,255,0.06)';
    roundRect(ctx,barX,by,barW,barH,barH/2);ctx.fill();

    /* 數值條 */
    if(pct>0){
      var fillW=Math.max(barH,Math.round(barW*pct/100));
      var bGrad=ctx.createLinearGradient(barX,by,barX+fillW,by);
      bGrad.addColorStop(0,hexToRGBA(elColors[el],0.8));
      bGrad.addColorStop(1,hexToRGBA(elColors[el],0.5));
      ctx.fillStyle=bGrad;
      roundRect(ctx,barX,by,fillW,barH,barH/2);ctx.fill();
    }

    /* 百分比 */
    ctx.textAlign='right';
    ctx.font=lblFs+'px "Noto Sans TC",sans-serif';
    ctx.fillStyle='rgba(245,230,211,0.6)';
    ctx.fillText(pct+'%',barX+barW+Math.round(fs*1.5),by+barH*0.8);
    ctx.textAlign='left';
  });

  /* ── 底部命理摘要 + 品牌 ── */
  var footY=barY+5*barGap+Math.round(fs*0.8);
  ctx.textAlign='center';
  ctx.font=Math.round(fs*0.7)+'px "Noto Sans TC",sans-serif';
  ctx.fillStyle='rgba(245,230,211,0.35)';
  var dm=S.bazi.dm,dmEl=S.bazi.dmEl;
  ctx.fillText('日主「'+dm+'」('+dmEl+')  喜用：'+S.bazi.fav.join('、')+'  │  當日：'+tc.gz+'('+tc.tEl+')  十神：'+tc.god,cw/2,footY);
  ctx.fillText('建議配戴：'+tc.crystal+'（'+tc.favEl+'行喜用神水晶）',cw/2,footY+Math.round(fs*0.9));

  /* 品牌浮水印 */
  var brandY=footY+Math.round(fs*2.2);
  var brandG=ctx.createLinearGradient(cw/2-80,brandY,cw/2+80,brandY);
  brandG.addColorStop(0,hexToRGBA(ch.color,0.3));brandG.addColorStop(0.5,hexToRGBA(ch.color,0.6));brandG.addColorStop(1,hexToRGBA(ch.color,0.3));
  ctx.fillStyle=brandG;
  ctx.font='bold '+Math.round(fs*0.85)+'px "Noto Serif TC",serif';
  ctx.fillText('☽ 靜月之光',cw/2,brandY);
  ctx.font=Math.round(fs*0.55)+'px "Noto Sans TC",sans-serif';
  ctx.fillStyle='rgba(245,230,211,0.25)';
  ctx.fillText('quietmoonlight.com',cw/2,brandY+Math.round(fs*0.75));
}

function dlAura(){
  var cv=document.getElementById('aura-cv');if(!cv)return;
  var tc=analyzeTodayChakra(S.bazi);
  var a=document.createElement('a');a.download='\u975C\u6708\u4E4B\u5149_'+tc.chakra.name+'.png';a.href=cv.toDataURL('image/png',0.95);a.click();
}

function resetAF(){
  auraImg=null;
  var fi=document.getElementById('aura-fi');if(fi)fi.value='';
  var uz=document.getElementById('aura-uz');if(uz)uz.style.display='';
  var prog=document.getElementById('aura-progress');if(prog){prog.style.display='none';prog.innerHTML='';}
  var res=document.getElementById('aura-result');if(res){res.style.display='none';res.innerHTML='';}
}


/* ── Hook into existing system ── */
(function(){
  var _s0=window.submitStep0;
  if(_s0)window.submitStep0=function(){_s0.apply(this,arguments);setTimeout(function(){try{renderCal30();renderAuraFilter();}catch(e){}},500);};
  var _sf=window.submitStep0Fast;
  if(_sf)window.submitStep0Fast=function(){_sf.apply(this,arguments);setTimeout(function(){try{renderCal30();renderAuraFilter();}catch(e){}},4000);};
  var _ei=window.initExtraFeatures;
  if(_ei)window.initExtraFeatures=function(){_ei.apply(this,arguments);try{renderCal30();renderAuraFilter();}catch(e){}};
  if(typeof S!=='undefined'&&S.bazi)setTimeout(function(){try{renderCal30();renderAuraFilter();}catch(e){}},300);
})();



/* ═══════════════════════════════════════════════════════════
   UI OVERHAUL — JavaScript 互動系統
   ═══════════════════════════════════════════════════════════ */

// ── 浮動粒子 ──
(function initParticles(){
  const box=document.getElementById('particles');
  if(!box)return;
  for(let i=0;i<18;i++){
    const p=document.createElement('div');
    p.className='particle';
    const size=Math.random()*4+2;
    p.style.cssText=`width:${size}px;height:${size}px;left:${Math.random()*100}%;animation-duration:${Math.random()*8+6}s;animation-delay:${Math.random()*6}s;`;
    box.appendChild(p);
  }
})();

// ── 社會認同計數動畫 ──
(function initVisitorCount(){
  const el=document.getElementById('visitor-count');
  if(!el)return;
  const base=1200+Math.floor(Math.random()*800);
  const today=new Date();
  const seed=today.getFullYear()*10000+today.getMonth()*100+today.getDate();
  const target=base+(seed%500);
  let current=0;
  const step=Math.ceil(target/40);
  const timer=setInterval(()=>{
    current+=step;
    if(current>=target){current=target;clearInterval(timer)}
    el.textContent=current.toLocaleString();
  },30);
})();

// ── 按鈕漣漪效果 ──
document.addEventListener('click',function(e){
  const btn=e.target.closest('.btn,.hook-card-v2');
  if(!btn)return;
  const rect=btn.getBoundingClientRect();
  const wave=document.createElement('span');
  wave.className='ripple-wave';
  const size=Math.max(rect.width,rect.height)*2;
  wave.style.cssText=`width:${size}px;height:${size}px;left:${e.clientX-rect.left-size/2}px;top:${e.clientY-rect.top-size/2}px;`;
  btn.style.position=btn.style.position||'relative';
  btn.style.overflow='hidden';
  btn.appendChild(wave);
  setTimeout(()=>wave.remove(),600);
});

// ── 卡片進場動畫（Intersection Observer）──
(function initCardReveal(){
  // 只對結果頁(step-3)的卡片做進場動畫，不影響其他步驟
  const step3=document.getElementById('step-3');
  if(!step3)return;
  const cards=step3.querySelectorAll('.card,.collapsible-card,.action-card,.quick-shop-card');
  cards.forEach(c=>{
    // 排除趣味功能區內的card，避免被opacity:0隱藏
    if(c.closest('#extra-features-gate')) return;
    c.classList.add('card-reveal');
  });
  const obs=new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(e.isIntersecting){e.target.classList.add('visible');obs.unobserve(e.target)}
    });
  },{threshold:0.1,rootMargin:'0px 0px -30px 0px'});
  cards.forEach(c=>obs.observe(c));
})();

// ── 塔羅翻牌動畫（非侵入式 — 用 CSS 增強原始動畫）──
// 不覆蓋 pickCard，而是透過 MutationObserver 偵測牌被選中後加動畫
(function upgradeTarotPick(){
  const deck=document.getElementById('t-deck');
  if(!deck)return;
  const obs=new MutationObserver((muts)=>{
    muts.forEach(m=>{
      if(m.type==='attributes'&&m.attributeName==='class'){
        const el=m.target;
        if(el.classList.contains('picked')&&!el.dataset.animated){
          el.dataset.animated='1';
          // 牌陣接牌彈跳
          const slotIdx=document.querySelectorAll('.tarot-deck-card.picked').length-1;
          const slot=document.getElementById('t-slot-'+slotIdx);
          if(slot){
            slot.classList.add('receiving');
            setTimeout(()=>slot.classList.remove('receiving'),400);
          }
        }
      }
    });
  });
  // 延遲觀察，等牌堆初始化
  setTimeout(()=>{
    const cards=deck.querySelectorAll('.tarot-deck-card');
    cards.forEach(c=>obs.observe(c,{attributes:true}));
  },1000);
})();

// ── 梅花起卦動畫（非侵入式 — 偵測 mh-result 出現後播放動畫）──
(function upgradeMeihua(){
  const mhResult=document.getElementById('mh-result');
  if(!mhResult)return;
  const obs=new MutationObserver(()=>{
    if(!mhResult.classList.contains('hidden')&&!mhResult.dataset.animated){
      mhResult.dataset.animated='1';
      // 播放起卦動畫
      if(!S.meihua||!S.meihua.ben)return;
      const overlay=document.createElement('div');
      overlay.className='mh-casting-overlay';
      const guaName=S.meihua.ben.n||'卦';
      overlay.innerHTML=`<div class="mh-yao-anim" id="mh-anim-yaos"></div><div class="mh-gua-name" id="mh-anim-name">${guaName}</div>`;
      document.body.appendChild(overlay);
      const yaosEl=overlay.querySelector('#mh-anim-yaos');
      const nameEl=overlay.querySelector('#mh-anim-name');
      const yaos=S.meihua.ben.yaos||[1,1,1,0,0,0];
      const dong=S.meihua.dong||1;
      yaos.forEach((y,i)=>{
        const line=document.createElement('div');
        line.className='mh-yao-line '+(y?'yang':'yin');
        if(i+1===dong) line.classList.add('dong');
        yaosEl.appendChild(line);
        setTimeout(()=>line.classList.add('show'),300+i*350);
      });
      setTimeout(()=>nameEl.classList.add('show'),300+yaos.length*350+200);
      setTimeout(()=>{
        overlay.style.opacity='0';overlay.style.transition='opacity .5s';
        setTimeout(()=>overlay.remove(),500);
      },300+yaos.length*350+1500);
    }
    // Reset for next time
    if(mhResult.classList.contains('hidden')) mhResult.dataset.animated='';
  });
  obs.observe(mhResult,{attributes:true,attributeFilter:['class']});
})();

// ── 環形進度條動畫 ──
(function upgradeVerdict(){
  const origSetVerdict=window._setVerdictDisplay;
  
  // Hook into the verdict display
  const observer=new MutationObserver(()=>{
    const probEl=document.getElementById('r-vprob');
    const ringFill=document.getElementById('verdict-ring-fill');
    if(!probEl||!ringFill)return;
    
    const text=probEl.textContent;
    const match=text.match(/(\d+)/);
    if(!match)return;
    
    const pct=parseInt(match[1]);
    const circumference=2*Math.PI*70; // r=70
    const offset=circumference*(1-pct/100);
    
    // Set color based on score
    let color;
    if(pct>=70) color='#4ade80';
    else if(pct>=55) color='#d4af37';
    else if(pct>=40) color='#fbbf24';
    else color='#f87171';
    
    ringFill.style.stroke=color;
    ringFill.style.strokeDashoffset=offset;
    
    // Animate number count up
    const start=0;
    const duration=1500;
    const startTime=performance.now();
    function animate(time){
      const elapsed=time-startTime;
      const progress=Math.min(elapsed/duration,1);
      const eased=1-Math.pow(1-progress,3);
      const current=Math.round(start+(pct-start)*eased);
      probEl.textContent=current+'%';
      if(progress<1) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
    
    observer.disconnect();
  });
  
  const target=document.getElementById('r-vprob');
  if(target) observer.observe(target,{childList:true,characterData:true,subtree:true});
})();

// ── 載入動畫升級 ──
(function upgradeLoading(){
  const overlay=document.querySelector('.loading-overlay');
  if(!overlay)return;
  
  // Add bagua spinner if not exists
  if(!overlay.querySelector('.loading-bagua')){
    const bagua=document.createElement('div');
    bagua.className='loading-bagua';
    bagua.innerHTML='<svg viewBox="0 0 80 80" width="80" height="80"><circle cx="40" cy="40" r="38" fill="none" stroke="rgba(212,175,55,0.3)" stroke-width="1.5"/><path d="M40 2a38 38 0 0 1 0 76" fill="rgba(212,175,55,0.15)" stroke="rgba(212,175,55,0.5)" stroke-width="1.5"/><path d="M40 2a38 38 0 0 0 0 76" fill="rgba(139,0,0,0.15)" stroke="rgba(139,0,0,0.5)" stroke-width="1.5"/><circle cx="40" cy="21" r="6" fill="rgba(212,175,55,0.4)"/><circle cx="40" cy="59" r="6" fill="rgba(139,0,0,0.4)"/><circle cx="40" cy="21" r="2.5" fill="rgba(139,0,0,0.6)"/><circle cx="40" cy="59" r="2.5" fill="rgba(212,175,55,0.6)"/></svg>';
    overlay.insertBefore(bagua,overlay.firstChild);
  }
})();

// ── 回答區視覺升級 ──
(function upgradeAnswerDisplay(){
  const obs=new MutationObserver(()=>{
    const answerEl=document.getElementById('r-answer');
    if(answerEl&&answerEl.innerHTML.length>10&&!answerEl.classList.contains('answer-block')){
      answerEl.classList.add('answer-block');
    }
  });
  const target=document.getElementById('r-answer');
  if(target) obs.observe(target,{childList:true,subtree:true});
})();



/* ═══════════════════════════════════════════════════════
   SECURITY PROTECTION LAYER
   ═══════════════════════════════════════════════════════ */
(function(){
  // Anti-right-click
  document.addEventListener('contextmenu',function(e){e.preventDefault();return false;});
  
  // Anti-select (prevent copy-paste of source)
  document.addEventListener('selectstart',function(e){
    if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return true;
    e.preventDefault();return false;
  });
  
  // Anti-keyboard shortcuts (F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S)
  document.addEventListener('keydown',function(e){
    if(e.key==='F12')e.preventDefault();
    if(e.ctrlKey&&e.shiftKey&&(e.key==='I'||e.key==='i'||e.key==='J'||e.key==='j'))e.preventDefault();
    if(e.ctrlKey&&(e.key==='U'||e.key==='u'||e.key==='S'||e.key==='s'))e.preventDefault();
  });
  
  // DevTools detection (size-based)
  var _dtOpen=false;
  var _dtCheck=function(){
    var w=window.outerWidth-window.innerWidth>160;
    var h=window.outerHeight-window.innerHeight>160;
    if(w||h){
      if(!_dtOpen){
        _dtOpen=true;
        console.clear();
        console.log('%c⚠️ 開發者工具已偵測到','font-size:20px;color:red;font-weight:bold');
        console.log('%c此應用的原始碼受到保護，禁止複製或修改。','font-size:14px;color:orange');
      }
    }else{_dtOpen=false;}
  };
  setInterval(_dtCheck,1000);
  
  // Anti-debugger (periodic)
  var _adCnt=0;
  setInterval(function(){
    var s=Date.now();
    (function(){}).constructor('debugger')();
    if(Date.now()-s>100&&_adCnt<3){
      _adCnt++;
      console.clear();
    }
  },3000);
  
  // Integrity check - detect if script content has been modified
  var _origLen=document.querySelector('script:not([src])')?.textContent?.length||0;
  setTimeout(function(){
    var _curLen=document.querySelector('script:not([src])')?.textContent?.length||0;
    if(_origLen>0&&Math.abs(_curLen-_origLen)>500){
      console.warn('Script integrity check failed');
    }
  },5000);
  
  // Console warning
  console.log('%c⛔ 停止！','font-size:40px;color:red;font-weight:bold;text-shadow:1px 1px black');
  console.log('%c這是為你的安全而設計的瀏覽器功能。如果有人告訴你在這裡貼上什麼東西來取得功能，那是詐騙。','font-size:16px;color:#333');
  console.log('%c靜月之光 v3.0 — 版權所有 © 2024-2025','font-size:12px;color:#888');
})();

/* ═══ 真實人次計數器（Google Sheets 雲端版）═══ */
/*
 * 【設定步驟】
 * 1. 開 Google Sheets → 建新試算表
 * 2. 在 A1 輸入 total，B1 輸入 0
 * 3. 在 A2 輸入今天日期如 2026-02-19，B2 輸入 0
 * 4. 點「擴充功能」→「Apps Script」
 * 5. 貼上以下程式碼（取代原有的）：
 *
 *   function doGet(e) {
 *     var lock = LockService.getScriptLock();
 *     lock.waitLock(5000);
 *     var ss = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
 *     var action = e.parameter.action;
 *     if (action === 'get') {
 *       var total = ss.getRange('B1').getValue() || 0;
 *       var today = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyy-MM-dd');
 *       var dailyRow = findDailyRow(ss, today);
 *       var todayCount = dailyRow ? ss.getRange('B' + dailyRow).getValue() : 0;
 *       lock.releaseLock();
 *       return ContentService.createTextOutput(JSON.stringify({total: total, today: todayCount}))
 *         .setMimeType(ContentService.MimeType.JSON);
 *     }
 *     if (action === 'increment') {
 *       var total = (ss.getRange('B1').getValue() || 0) + 1;
 *       ss.getRange('B1').setValue(total);
 *       var today = Utilities.formatDate(new Date(), 'Asia/Taipei', 'yyyy-MM-dd');
 *       var dailyRow = findDailyRow(ss, today);
 *       if (dailyRow) {
 *         var c = (ss.getRange('B' + dailyRow).getValue() || 0) + 1;
 *         ss.getRange('B' + dailyRow).setValue(c);
 *       } else {
 *         var lastRow = ss.getLastRow() + 1;
 *         ss.getRange('A' + lastRow).setValue(today);
 *         ss.getRange('B' + lastRow).setValue(1);
 *       }
 *       lock.releaseLock();
 *       return ContentService.createTextOutput(JSON.stringify({total: total}))
 *         .setMimeType(ContentService.MimeType.JSON);
 *     }
 *     lock.releaseLock();
 *     return ContentService.createTextOutput('{}').setMimeType(ContentService.MimeType.JSON);
 *   }
 *   function findDailyRow(ss, date) {
 *     var data = ss.getRange('A2:A' + ss.getLastRow()).getValues();
 *     for (var i = 0; i < data.length; i++) {
 *       var cellVal = data[i][0];
 *       if (cellVal instanceof Date) cellVal = Utilities.formatDate(cellVal, 'Asia/Taipei', 'yyyy-MM-dd');
 *       if (cellVal === date) return i + 2;
 *     }
 *     return null;
 *   }
 *
 * 6. 點「部署」→「新增部署作業」→ 類型選「網頁應用程式」
 *    - 執行身分：你自己
 *    - 誰可以存取：「所有人」
 * 7. 複製部署的網址，貼到下面 CTR_ENDPOINT
 */

// ★★★ 把這裡換成你的 Apps Script 部署網址 ★★★
const CTR_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxCvM09XbFUyl0BC2im-H6DU_t2Ipjq9p-dZDGAuiildcxmBGC-CGngvvqWmaiPxW8wNQ/exec';

// ── 呼叫 Apps Script（用 script 注入，最可靠的跨域方式）──
function _gasCall(action){
  return new Promise((resolve)=>{
    const cbName = '_gasCb_' + Date.now();
    const timeout = setTimeout(()=>{
      delete window[cbName];
      resolve(null);
    }, 8000);
    
    window[cbName] = function(data){
      clearTimeout(timeout);
      delete window[cbName];
      resolve(data);
    };
    
    // Apps Script 不支援 JSONP，改用 fetch
    fetch(CTR_ENDPOINT + '?action=' + action, {redirect:'follow'})
      .then(r => r.json())
      .then(data => {
        clearTimeout(timeout);
        delete window[cbName];
        resolve(data);
      })
      .catch(()=>{
        // fetch 失敗時用 Image beacon（只能送不能收）
        if(action === 'increment'){
          new Image().src = CTR_ENDPOINT + '?action=increment&_t=' + Date.now();
        }
        clearTimeout(timeout);
        delete window[cbName];
        resolve(null);
      });
  });
}

// ── 計數 +1（每次到結果頁觸發）──
async function _countVisitor(){
  if(!CTR_ENDPOINT) return;
  const data = await _gasCall('increment');
  if(data){
    const badge=document.getElementById('counter-badge');
    if(badge && badge.classList.contains('visible')){
      document.getElementById('counter-num').textContent=(data.total||0).toLocaleString();
      if(data.today!==undefined) document.getElementById('counter-today').textContent=(data.today||0).toLocaleString();
    }
  }
}

// ── 月亮連點 5 下 ──
let _moonTapCount=0, _moonTapTimer=null;
function _moonTap(){
  _moonTapCount++;
  clearTimeout(_moonTapTimer);
  _moonTapTimer=setTimeout(()=>{_moonTapCount=0;},2000);
  if(_moonTapCount>=5){
    _moonTapCount=0;
    document.getElementById('counter-badge').classList.add('visible');
    // 立即從雲端拉數字顯示在徽章
    _gasCall('get').then(data=>{
      if(data){
        document.getElementById('counter-num').textContent=(data.total||0).toLocaleString();
        document.getElementById('counter-today').textContent=(data.today||0).toLocaleString();
      }
    });
    openAdmin();
  }
}

async function openAdmin(){
  document.getElementById('admin-count').textContent='…';
  document.getElementById('admin-today').textContent='…';
  document.getElementById('admin-overlay').classList.add('visible');
  document.getElementById('admin-panel').classList.add('visible');

  if(!CTR_ENDPOINT){
    document.getElementById('admin-count').textContent='未設定';
    document.getElementById('admin-today').textContent='未設定';
    return;
  }
  const data = await _gasCall('get');
  if(data){
    document.getElementById('admin-count').textContent=(data.total||0).toLocaleString();
    document.getElementById('admin-today').textContent=(data.today||0).toLocaleString();
    document.getElementById('counter-num').textContent=(data.total||0).toLocaleString();
    document.getElementById('counter-today').textContent=(data.today||0).toLocaleString();
  }else{
    document.getElementById('admin-count').textContent='連線失敗';
    document.getElementById('admin-today').textContent='-';
  }
}

function closeAdmin(){
  document.getElementById('admin-overlay').classList.remove('visible');
  document.getElementById('admin-panel').classList.remove('visible');
}

</script>
<!-- Sticky Bottom CTA for Result Page -->
<div class="sticky-cta" id="sticky-cta">
  <div class="sticky-cta-inner">
    <div class="sticky-cta-text">
      <strong id="sticky-cta-label">💎 依命盤精選你的能量水晶</strong><br>
      <span id="sticky-cta-desc">喜用神五行對應，隨身補運</span>
    </div>
    <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener" class="sticky-cta-btn" id="sticky-cta-btn" onclick="event.preventDefault();document.getElementById('quick-shop').scrollIntoView({behavior:'smooth',block:'center'});">
      <i class="fas fa-gem"></i> 看推薦水晶
    </a>
    <button onclick="document.getElementById('sticky-cta').classList.remove('visible');document.getElementById('sticky-cta').style.display='none';" style="background:none;border:none;color:var(--c-text-muted);font-size:1.1rem;padding:4px 8px;cursor:pointer;line-height:1;flex:0 0 auto;" aria-label="關閉">✕</button>
  </div>
</div>
<!-- 後台管理面板 -->
<div class="admin-overlay" id="admin-overlay" onclick="closeAdmin()"></div>
<div class="admin-panel" id="admin-panel">
  <button class="admin-close" onclick="closeAdmin()">&times;</button>
  <h3>📊 解讀人次統計</h3>
  <div class="admin-row"><label>累計總人次</label><span class="admin-val" id="admin-count">0</span></div>
  <div class="admin-row"><label>今日人次</label><span class="admin-val" id="admin-today">0</span></div>
  <button class="admin-btn" onclick="closeAdmin()">關閉</button>
  <div style="margin-top:var(--sp-sm);font-size:.68rem;color:var(--c-text-muted);text-align:center">
    每次操作到結果頁 = 1 人次<br>連點月亮 5 下開啟 · 重整後隱藏
  </div>
</div>
</body></html>
