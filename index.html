<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes,viewport-fit=cover">
<meta name="description" content="靜月之光能量占卜儀：整合八字、紫微斗數、梅花易數、塔羅牌的多維度命理分析系統">
<meta name="theme-color" content="#1a0a0a">
<title>靜月之光能量占卜儀 v3.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* ================================================================
   靜月之光 v3.0 — Complete Design System
   Aesthetic: Chinese Traditional Luxury (紅金傳統奢華)
   ================================================================ */
:root{
  --c-bg-deep:#0d0404;--c-bg:#1a0808;--c-bg-card:#1e0c0c;--c-bg-card-alt:#251010;
  --c-surface:rgba(255,255,255,0.04);--c-border:rgba(212,175,55,0.18);--c-border-hi:rgba(212,175,55,0.45);
  --c-gold:#d4af37;--c-gold-light:#e8c968;--c-gold-pale:#f5e6b8;
  --c-crimson:#8b0000;--c-crimson-hi:#b22222;
  --c-text:#f5e6d3;--c-text-dim:rgba(245,230,211,0.65);--c-text-muted:rgba(245,230,211,0.4);
  --c-success:#4ade80;--c-warn:#fbbf24;--c-danger:#f87171;--c-info:#60a5fa;
  --el-metal:#c0c0c0;--el-wood:#22c55e;--el-water:#3b82f6;--el-fire:#ef4444;--el-earth:#a78b5a;
  --f-display:'Noto Serif TC',serif;--f-body:'Noto Sans TC',sans-serif;
  --sp-xs:0.25rem;--sp-sm:0.5rem;--sp-md:1rem;--sp-lg:1.5rem;--sp-xl:2.5rem;
  --r-sm:8px;--r-md:14px;--r-lg:20px;--r-pill:999px;
  --sh-card:0 4px 24px rgba(0,0,0,0.4),0 0 0 1px var(--c-border);
  --t-fast:0.2s cubic-bezier(0.4,0,0.2,1);--t-smooth:0.4s cubic-bezier(0.4,0,0.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{
  font-family:var(--f-body);color:var(--c-text);
  background:var(--c-bg-deep);
  background-image:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(139,0,0,0.25) 0%,transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 100%,rgba(139,0,0,0.15) 0%,transparent 50%);
  background-attachment:fixed;min-height:100vh;line-height:1.6;
  -webkit-font-smoothing:antialiased;overflow-x:hidden;
}
a{color:var(--c-gold);text-decoration:none;transition:color var(--t-fast)}
a:hover{color:var(--c-gold-light)}
button,input,select,textarea{font-family:inherit;font-size:inherit;color:inherit}
::selection{background:rgba(212,175,55,0.3);color:#fff}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--c-bg)}
::-webkit-scrollbar-thumb{background:rgba(212,175,55,0.3);border-radius:3px}

/* — Layout — */
.app{max-width:960px;margin:0 auto;padding:0 var(--sp-md);padding-bottom:calc(env(safe-area-inset-bottom,0px) + 1rem)}

/* — Navigation — */
.nav{position:sticky;top:0;z-index:100;background:rgba(13,4,4,0.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--c-border);padding:0.75rem var(--sp-md)}
.nav-inner{max-width:960px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:var(--sp-md)}
.nav-brand{display:flex;align-items:center;gap:var(--sp-sm);font-family:var(--f-display);font-weight:700;font-size:1.1rem;color:var(--c-gold)}
.nav-brand i{font-size:1.3rem}
.nav-links{display:flex;gap:var(--sp-xs);flex-wrap:wrap}
.nav-link{padding:0.4rem 0.75rem;border-radius:var(--r-pill);font-size:0.8rem;font-weight:500;color:var(--c-text-dim);border:1px solid transparent;transition:all var(--t-fast);cursor:pointer;background:none;white-space:nowrap}
.nav-link:hover,.nav-link.active{color:var(--c-gold);border-color:var(--c-border-hi);background:rgba(212,175,55,0.08)}

/* — Step Sections — */
.step{display:none;animation:fadeIn .45s ease both}
.step.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
@keyframes slideInLeft{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}

.result-verdict{animation:scaleIn .6s ease .1s both}
.card{animation:fadeIn .5s ease both}
.card:nth-child(2){animation-delay:.1s}
.card:nth-child(3){animation-delay:.2s}
.card:nth-child(4){animation-delay:.3s}
.verdict-prob{
  background-size:200% 100%;
  animation:shimmer 3s ease-in-out infinite;
  background-image:linear-gradient(90deg,var(--c-gold),var(--c-gold-light),#fff,var(--c-gold-light),var(--c-gold));
  -webkit-background-clip:text;background-clip:text;
}
.hero-icon{animation:pulse 3s ease-in-out infinite}
.dy-item{animation:slideInLeft .3s ease both}
.dy-item:nth-child(2){animation-delay:.05s}
.dy-item:nth-child(3){animation-delay:.1s}
.dy-item:nth-child(4){animation-delay:.15s}
.dy-item:nth-child(5){animation-delay:.2s}

/* — Cards — */
.card{background:var(--c-bg-card);border:1px solid var(--c-border);border-radius:var(--r-lg);padding:var(--sp-lg);margin-bottom:var(--sp-lg);box-shadow:var(--sh-card);transition:border-color var(--t-fast)}
.card:hover{border-color:var(--c-border-hi)}
.card-title{font-family:var(--f-display);font-weight:700;font-size:1.15rem;color:var(--c-gold);margin-bottom:var(--sp-md);display:flex;align-items:center;gap:var(--sp-sm)}
.card-title i{font-size:1rem;opacity:.8}

/* — Buttons — */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:var(--sp-sm);padding:.75rem 1.25rem;border-radius:var(--r-md);font-weight:600;font-size:.95rem;cursor:pointer;border:1px solid var(--c-border-hi);transition:all var(--t-fast);white-space:nowrap}
.btn-primary{background:linear-gradient(135deg,var(--c-crimson),#6b0000);color:var(--c-gold-pale);border-color:var(--c-gold);box-shadow:0 2px 12px rgba(139,0,0,.4)}
.btn-primary:hover{background:linear-gradient(135deg,var(--c-crimson-hi),var(--c-crimson));box-shadow:0 4px 20px rgba(139,0,0,.6);transform:translateY(-1px)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-outline{background:transparent;color:var(--c-text-dim);border-color:rgba(255,255,255,.15)}
.btn-outline:hover{color:var(--c-gold);border-color:var(--c-border-hi);background:rgba(212,175,55,.06)}
.btn-gold{background:linear-gradient(135deg,var(--c-gold),#b8941f);color:var(--c-bg-deep);border:none;font-weight:700}
.btn-gold:hover{box-shadow:0 4px 20px rgba(212,175,55,.4);transform:translateY(-1px)}
.btn-sm{padding:.5rem .85rem;font-size:.85rem}
.btn-tab-active{background:linear-gradient(135deg,var(--c-crimson),#6b0000)!important;color:var(--c-gold-pale)!important;border-color:var(--c-gold)!important}
.btn-lg{padding:1rem 2rem;font-size:1.05rem}
.btn-block{width:100%}

/* — Form — */
.form-group{margin-bottom:var(--sp-lg)}
.form-label{display:block;font-size:.9rem;font-weight:600;color:var(--c-text);margin-bottom:var(--sp-xs)}
.form-label .req{color:var(--c-danger);margin-left:2px}
.form-hint{font-size:.8rem;color:var(--c-text-muted);margin-top:var(--sp-xs)}
.form-input,.form-select,.form-textarea{width:100%;padding:.75rem 1rem;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:var(--r-sm);color:var(--c-text);font-size:1rem;transition:border-color var(--t-fast),box-shadow var(--t-fast)}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--c-gold);box-shadow:0 0 0 3px rgba(212,175,55,.15)}
.form-textarea{resize:vertical;min-height:80px}
.radio-pills{display:flex;gap:var(--sp-sm);flex-wrap:wrap}
.radio-pill{position:relative}
.radio-pill input{position:absolute;opacity:0;pointer-events:none}
.radio-pill span{display:inline-block;padding:.6rem 1.2rem;border:1px solid rgba(255,255,255,.12);border-radius:var(--r-pill);cursor:pointer;font-size:.9rem;transition:all var(--t-fast)}
.radio-pill input:checked+span{border-color:var(--c-gold);color:var(--c-gold);background:rgba(212,175,55,.12)}

/* — Stepper — */
.stepper{display:flex;align-items:center;justify-content:center;padding:var(--sp-md) 0;margin-bottom:var(--sp-md)}
.stepper-item{display:flex;align-items:center;gap:.4rem;font-size:.8rem;color:var(--c-text-muted);transition:color var(--t-fast)}
.stepper-item.active{color:var(--c-gold);font-weight:600}
.stepper-item.done{color:var(--c-success)}
.stepper-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.15);font-size:.75rem;font-weight:700;transition:all var(--t-fast)}
.stepper-item.active .stepper-dot{border-color:var(--c-gold);background:rgba(212,175,55,.15);color:var(--c-gold)}
.stepper-item.done .stepper-dot{border-color:var(--c-success);background:rgba(74,222,128,.15);color:var(--c-success)}
.stepper-line{width:30px;height:2px;background:rgba(255,255,255,.1);margin:0 .3rem}

/* — Hero — */
.hero{text-align:center;padding:var(--sp-xl) 0 var(--sp-lg)}
.hero-icon{font-size:2.5rem;color:var(--c-gold);margin-bottom:var(--sp-md);text-shadow:0 0 40px rgba(212,175,55,.4)}
.hero h1{font-family:var(--f-display);font-weight:900;font-size:clamp(1.5rem,5vw,2.2rem);color:var(--c-gold-light);margin-bottom:var(--sp-sm);letter-spacing:.05em}
.hero p{color:var(--c-text-dim);font-size:.95rem;max-width:500px;margin:0 auto}

/* — BaZi Grid — */
.bazi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;background:var(--c-border);border-radius:var(--r-md);overflow:hidden;margin:var(--sp-md) 0}
.bazi-cell{background:var(--c-bg-card);padding:var(--sp-sm) var(--sp-xs);text-align:center}
.bazi-cell.header{background:rgba(212,175,55,.08);font-size:.75rem;color:var(--c-text-dim);font-weight:600}
.bazi-cell .gz{font-family:var(--f-display);font-size:1.3rem;font-weight:700;display:block;margin-bottom:2px}
.bazi-cell .gz-sub{font-size:.7rem;color:var(--c-text-muted)}
.el-tag{display:inline-block;padding:1px 6px;border-radius:var(--r-pill);font-size:.65rem;font-weight:600;margin-top:2px}
.el-金{background:rgba(192,192,192,.15);color:var(--el-metal)}
.el-木{background:rgba(34,197,94,.15);color:var(--el-wood)}
.el-水{background:rgba(59,130,246,.15);color:var(--el-water)}
.el-火{background:rgba(239,68,68,.15);color:var(--el-fire)}
.el-土{background:rgba(167,139,90,.15);color:var(--el-earth)}

/* — Five Element Bar — */
.el-bar{margin:var(--sp-sm) 0}
.el-row{display:flex;align-items:center;gap:var(--sp-sm);margin-bottom:6px}
.el-lbl{width:28px;text-align:center;font-weight:700;font-size:.85rem}
.el-track{flex:1;height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden}
.el-fill{height:100%;border-radius:4px;transition:width .8s ease}
.el-val{width:36px;text-align:right;font-size:.8rem;color:var(--c-text-dim)}

/* — DaYun Timeline — */
.dayun-tl{display:flex;overflow-x:auto;gap:2px;padding:var(--sp-sm) 0;-webkit-overflow-scrolling:touch}
.dy-item{flex:0 0 auto;min-width:72px;padding:var(--sp-sm);text-align:center;border-radius:var(--r-sm);border:1px solid var(--c-border);background:var(--c-bg-card);cursor:pointer;transition:all var(--t-fast);font-size:.8rem}
.dy-item.current{border-color:var(--c-gold);background:rgba(212,175,55,.1)}
.dy-item .dy-gz{font-family:var(--f-display);font-weight:700;font-size:1rem;display:block}
.dy-item .dy-age{color:var(--c-text-muted);font-size:.7rem}
.dy-item .dy-lv{display:inline-block;padding:1px 6px;border-radius:var(--r-pill);font-size:.65rem;font-weight:600;margin-top:4px}
.lv-dj{background:rgba(74,222,128,.15);color:var(--c-success)}
.lv-zj{background:rgba(96,165,250,.15);color:var(--c-info)}
.lv-xj{background:rgba(212,175,55,.15);color:var(--c-gold)}
.lv-p{background:rgba(255,255,255,.08);color:var(--c-text-dim)}
.lv-xk{background:rgba(251,191,36,.15);color:var(--c-warn)}
.lv-zk{background:rgba(248,113,113,.15);color:var(--c-danger)}
.lv-dk{background:rgba(180,40,40,.2);color:#ff6b6b}

/* — Hexagram — */
.hex-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp-md);margin:var(--sp-md) 0}
.hex-card{text-align:center;padding:var(--sp-md);background:rgba(0,0,0,.2);border:1px solid var(--c-border);border-radius:var(--r-md)}
.hex-card h4{color:var(--c-text-dim);font-size:.8rem;margin-bottom:var(--sp-sm)}
.hex-sym{font-size:2.5rem;line-height:1;margin-bottom:var(--sp-xs)}
.hex-name{font-family:var(--f-display);font-weight:700;color:var(--c-gold)}

/* — Tarot — */
.tarot-hand{display:flex;justify-content:center;gap:var(--sp-sm);flex-wrap:wrap;padding:var(--sp-lg) 0}
.t-card{width:76px;height:114px;perspective:600px;cursor:pointer}
.t-card-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .6s ease}
.t-card.flipped .t-card-inner{transform:rotateY(180deg)}
.t-card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:.7rem;text-align:center;padding:4px}
.t-back{background:linear-gradient(135deg,#2a1a3e,#1a0a2e);border:2px solid var(--c-gold);color:var(--c-gold)}
.t-back::after{content:'✦';font-size:1.5rem;opacity:.6}
.t-front{transform:rotateY(180deg);background:var(--c-bg-card-alt);border:2px solid var(--c-border-hi);color:var(--c-text);gap:2px}
.t-front .tc-name{font-family:var(--f-display);font-weight:700;font-size:.72rem;color:var(--c-gold)}
.t-front .tc-dir{font-size:.6rem;color:var(--c-text-dim)}

/* — Result — */
.result-verdict{text-align:center;padding:var(--sp-lg);border:2px solid var(--c-gold);border-radius:var(--r-lg);background:linear-gradient(180deg,rgba(212,175,55,.08),rgba(139,0,0,.08));margin-bottom:var(--sp-lg)}
.verdict-label{font-family:var(--f-display);font-weight:900;font-size:1.8rem;color:var(--c-gold-light);margin-bottom:var(--sp-xs)}
.verdict-prob{font-size:2.5rem;font-weight:900;background:linear-gradient(135deg,var(--c-gold),var(--c-gold-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.verdict-note{color:var(--c-text-dim);font-size:.9rem;margin-top:var(--sp-sm)}
.prob-meter{margin:var(--sp-md) 0}
.prob-bar{height:12px;background:rgba(255,255,255,.06);border-radius:6px;overflow:hidden}
.prob-fill{height:100%;border-radius:6px;background:linear-gradient(90deg,var(--c-crimson),var(--c-gold),var(--c-success));transition:width 1.2s cubic-bezier(.4,0,.2,1)}
.prob-labels{display:flex;justify-content:space-between;font-size:.7rem;color:var(--c-text-muted);margin-top:4px}

/* — Dimension Tabs — */
.dim-tabs{display:flex;gap:2px;margin-bottom:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.dim-tab{flex:0 0 auto;padding:.6rem 1rem;border-radius:var(--r-sm) var(--r-sm) 0 0;background:rgba(255,255,255,.04);border:1px solid var(--c-border);border-bottom:none;font-size:.85rem;font-weight:500;color:var(--c-text-dim);cursor:pointer;transition:all var(--t-fast);white-space:nowrap}
.dim-tab.active{background:var(--c-bg-card);color:var(--c-gold);border-color:var(--c-border-hi)}
.dim-pane{display:none;padding:var(--sp-lg);background:var(--c-bg-card);border:1px solid var(--c-border);border-radius:0 var(--r-md) var(--r-md) var(--r-md)}
.dim-pane.active{display:block;animation:fadeIn .3s ease}

/* — Conclusion — */
.conclusion{background:linear-gradient(135deg,rgba(139,0,0,.15),rgba(212,175,55,.08));border:1px solid var(--c-border-hi);border-radius:var(--r-lg);padding:var(--sp-lg);margin-top:var(--sp-lg)}
.conclusion h3{font-family:var(--f-display);color:var(--c-gold);margin-bottom:var(--sp-md)}

/* — Actions — */
.actions{display:flex;gap:var(--sp-sm);justify-content:space-between;margin-top:var(--sp-lg);flex-wrap:wrap}
.actions-center{justify-content:center}

/* — Utilities — */
.text-gold{color:var(--c-gold)}.text-dim{color:var(--c-text-dim)}.text-muted{color:var(--c-text-muted)}
.text-success{color:var(--c-success)}.text-warn{color:var(--c-warn)}.text-danger{color:var(--c-danger)}
.text-center{text-align:center}.text-sm{font-size:.85rem}.text-xs{font-size:.75rem}
.mt-sm{margin-top:var(--sp-sm)}.mt-md{margin-top:var(--sp-md)}.mt-lg{margin-top:var(--sp-lg)}
.mb-sm{margin-bottom:var(--sp-sm)}.mb-md{margin-bottom:var(--sp-md)}.mb-lg{margin-bottom:var(--sp-lg)}
.hidden{display:none!important}
.serif{font-family:var(--f-display)}
.tag{display:inline-block;padding:2px 8px;border-radius:var(--r-pill);font-size:.75rem;font-weight:600}
.tag-gold{background:rgba(212,175,55,.15);color:var(--c-gold)}
.tag-red{background:rgba(239,68,68,.15);color:var(--c-danger)}
.tag-green{background:rgba(74,222,128,.15);color:var(--c-success)}
.tag-blue{background:rgba(96,165,250,.15);color:var(--c-info)}
.divider{height:1px;background:linear-gradient(90deg,transparent,var(--c-border-hi),transparent);margin:var(--sp-lg) 0}

/* — ZiWei Grid — */
.zw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;background:var(--c-border);border-radius:var(--r-md);overflow:hidden;margin:var(--sp-md) 0}
.zw-cell{background:var(--c-bg-card);padding:var(--sp-sm);min-height:85px;font-size:.75rem;position:relative}
.zw-cell.zw-center{grid-column:2/4;grid-row:2/4;display:flex;align-items:center;justify-content:center;flex-direction:column;background:var(--c-bg-card-alt);text-align:center;min-height:170px}
.zw-palace{font-weight:700;color:var(--c-gold);font-size:.8rem;margin-bottom:2px}
.zw-branch{font-size:.65rem;color:var(--c-text-muted)}
.zw-stars{margin-top:3px;line-height:1.5}
.zw-star{display:inline;margin-right:3px}
.zw-star.major{color:var(--c-gold-light);font-weight:600}
.zw-star.minor{color:var(--c-text-dim)}
.zw-hua{font-size:.55rem;padding:0 2px;border-radius:2px;background:rgba(212,175,55,.2);color:var(--c-gold);vertical-align:super;margin-left:1px}
.zw-cell.active-palace{border:1px solid var(--c-gold);background:rgba(212,175,55,.06)}

/* — Crystal — */
.crystal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:var(--sp-md);margin:var(--sp-md) 0}
.crystal-card{padding:var(--sp-md);border-radius:var(--r-md);border:1px solid var(--c-border);background:var(--c-bg-card);text-align:center;transition:all var(--t-fast)}
.crystal-card:hover{border-color:var(--c-gold);transform:translateY(-2px)}
.crystal-icon{font-size:2rem;margin-bottom:var(--sp-sm)}
.crystal-name{font-family:var(--f-display);font-weight:700;color:var(--c-gold);margin-bottom:var(--sp-xs)}

/* — Responsive — */
@media(max-width:640px){
  .bazi-cell .gz{font-size:1.1rem}
  .nav-links{display:none}
  .stepper{flex-wrap:wrap;gap:.3rem}
  .stepper-line{width:16px}
  .hex-grid{gap:var(--sp-sm)}
}
@media(max-width:380px){
  .hero h1{font-size:1.3rem}
  .card{padding:var(--sp-md)}
}

/* — Shop Buttons — */
.shop-btns{display:flex;flex-direction:column;gap:var(--sp-sm)}
.shop-btn-card{display:flex;align-items:center;gap:var(--sp-md);padding:.85rem 1rem;border-radius:var(--r-md);border:1px solid var(--c-border);background:var(--c-bg-card-alt);color:var(--c-text);text-decoration:none;transition:all var(--t-fast);cursor:pointer;font-family:inherit;font-size:inherit;text-align:left;width:100%}
.shop-btn-card:hover{border-color:var(--c-gold);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.shop-btn-card i{font-size:1.3rem;width:32px;text-align:center;flex:0 0 auto}
.shop-btn-card div{display:flex;flex-direction:column;gap:1px}
.shop-btn-card.shopee i{color:#ee4d2d}
.shop-btn-card.seven i{color:#00a040}
.shop-btn-card.custom i{color:var(--c-gold)}
.shop-btn-card strong{color:var(--c-text)}
.shop-card{border-color:rgba(212,175,55,.3);background:linear-gradient(135deg,rgba(139,0,0,.08),rgba(212,175,55,.05))}

/* — Nav Shop — */
.nav-shop{display:flex;gap:var(--sp-xs);align-items:center}
.nav-shop a{font-size:.75rem;padding:.35rem .6rem;border-radius:var(--r-pill);border:1px solid rgba(255,255,255,.12);color:var(--c-text-dim);transition:all var(--t-fast);white-space:nowrap}
.nav-shop a:hover{border-color:var(--c-gold);color:var(--c-gold)}

/* — Modal — */
.modal-overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:var(--sp-md)}
.modal-box{background:var(--c-bg-card);border:1px solid var(--c-border-hi);border-radius:var(--r-lg);padding:var(--sp-lg);max-width:480px;width:100%;max-height:90vh;overflow-y:auto;position:relative;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:scaleIn .3s ease}
.modal-close{position:absolute;top:var(--sp-sm);right:var(--sp-md);background:none;border:none;color:var(--c-text-dim);font-size:1.5rem;cursor:pointer;padding:4px 8px;border-radius:var(--r-sm);transition:color var(--t-fast)}
.modal-close:hover{color:var(--c-gold)}

/* — Floating Buttons — */
.floating-root{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 20px);right:16px;z-index:900;display:flex;flex-direction:column-reverse;align-items:flex-end;gap:var(--sp-sm)}
.fab{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(212,175,55,.5);cursor:pointer;transition:all var(--t-fast);text-decoration:none;font-family:inherit;flex-direction:column;gap:2px;font-size:.6rem;color:var(--c-text)}
.fab i{font-size:1rem}
.fab span{font-size:.5rem;line-height:1}
.fab-toggle{background:linear-gradient(135deg,var(--c-crimson),#6b0000);color:var(--c-gold-pale);box-shadow:0 4px 16px rgba(139,0,0,.5)}
.fab-toggle:hover{transform:scale(1.1)}
.fab-shopee{background:rgba(238,77,45,.15);color:#ee4d2d;border-color:rgba(238,77,45,.4)}
.fab-711{background:rgba(0,160,64,.15);color:#00a040;border-color:rgba(0,160,64,.4)}
.fab-custom{background:rgba(212,175,55,.12);color:var(--c-gold);border-color:rgba(212,175,55,.4)}
.fab-menu{display:flex;flex-direction:column-reverse;gap:var(--sp-sm)}
.fab-menu.hidden{display:none}
@media(max-width:640px){
  .fab{width:44px;height:44px}
  .fab span{display:none}
}

/* — Product Grid — */
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:var(--sp-md);margin:var(--sp-md) 0}
.product-card{display:flex;gap:var(--sp-md);padding:var(--sp-md);border:1px solid var(--c-border);border-radius:var(--r-md);background:var(--c-bg-card-alt);transition:border-color var(--t-fast)}
.product-card:hover{border-color:var(--c-gold)}
.product-icon{font-size:2rem;flex:0 0 auto;padding-top:2px}
.product-body{flex:1;min-width:0}
.product-name{font-weight:700;color:var(--c-text);font-size:1rem;margin-bottom:4px}
.product-meta{display:flex;gap:var(--sp-xs);margin-bottom:var(--sp-xs)}
.product-desc{font-size:.85rem;color:var(--c-text-dim);margin-bottom:var(--sp-xs);line-height:1.5}
.product-price{font-size:1.1rem;font-weight:700;color:var(--c-gold);margin-bottom:var(--sp-xs)}
.product-wear{font-size:.78rem;color:var(--c-text-muted);margin-bottom:var(--sp-sm)}
.product-actions{display:flex;gap:var(--sp-xs)}
.product-btn{display:inline-flex;align-items:center;gap:4px;padding:.4rem .7rem;border-radius:var(--r-sm);border:1px solid var(--c-border);font-size:.78rem;text-decoration:none;color:var(--c-text);transition:all var(--t-fast)}
.product-btn:hover{border-color:var(--c-gold);color:var(--c-gold)}
.product-btn.shopee:hover{border-color:#ee4d2d;color:#ee4d2d}
.product-btn.seven:hover{border-color:#00a040;color:#00a040}
.btn-full{width:100%;justify-content:center;padding:.9rem}
.custom-cta{text-align:center}

/* — Share Gate — */
.share-gate-card{border:2px dashed rgba(212,175,55,.4);border-radius:var(--r-lg);padding:var(--sp-lg);text-align:center;background:linear-gradient(135deg,rgba(212,175,55,.04),rgba(139,0,0,.04))}
.share-gate-card h4{color:var(--c-gold);margin-bottom:var(--sp-sm)}
.share-gate-card p{color:var(--c-text-dim);font-size:.9rem;margin-bottom:var(--sp-md)}
.btn-share-big{padding:.85rem 2rem;font-size:1rem;border-radius:var(--r-pill);background:linear-gradient(135deg,#25D366,#128C7E);color:#fff;border:none;cursor:pointer;transition:all var(--t-fast);font-weight:700}
.btn-share-big:hover{transform:scale(1.03);box-shadow:0 4px 20px rgba(37,211,102,.3)}
.btn-save-card{padding:.7rem 1.5rem;font-size:.9rem;border-radius:var(--r-pill);background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;cursor:pointer;transition:all var(--t-fast);font-weight:600}
.btn-save-card:hover{transform:scale(1.03);box-shadow:0 4px 20px rgba(118,75,162,.3)}

/* — Urgency Strip — */
.urgency-strip{display:flex;gap:var(--sp-sm);flex-wrap:wrap;margin-top:var(--sp-xs);font-size:.72rem}
.urgency-critical{color:#ff4444;font-weight:700;animation:pulse 2s infinite}
.urgency-normal{color:rgba(255,255,255,.6)}
.urgency-views{color:rgba(255,255,255,.45)}

/* — Social Proof — */
.social-proof{border:1px solid rgba(212,175,55,.2);border-radius:var(--r-md);padding:var(--sp-md);margin:var(--sp-md) 0;background:rgba(212,175,55,.04)}
.sp-item{font-size:.85rem;color:var(--c-text-dim);margin:var(--sp-xs) 0}
.sp-item strong{color:var(--c-gold)}

/* — Live Counter + Marquee — */
.live-counter-bar{display:flex;align-items:center;justify-content:center;gap:var(--sp-md);padding:var(--sp-sm) var(--sp-md);background:rgba(212,175,55,.06);border:1px solid rgba(212,175,55,.15);border-radius:var(--r-md);margin-bottom:var(--sp-lg);font-size:.85rem;color:var(--c-text-dim);flex-wrap:wrap}
.live-counter-bar strong{color:var(--c-gold);font-size:1.1rem}
.live-marquee{text-align:center;font-size:.78rem;color:rgba(255,255,255,.55);padding:var(--sp-xs);transition:opacity .3s;min-height:1.4em;margin-bottom:var(--sp-md)}

/* — Discount Reveal — */
.discount-reveal{border:2px solid var(--c-gold);border-radius:var(--r-lg);padding:var(--sp-lg);text-align:center;background:linear-gradient(135deg,rgba(212,175,55,.08),rgba(139,0,0,.06));margin-top:var(--sp-md)}
.discount-code{font-size:1.8rem;font-weight:900;color:var(--c-gold);letter-spacing:4px;font-family:monospace;padding:var(--sp-md);background:rgba(0,0,0,.3);border-radius:var(--r-md);display:inline-block;margin:var(--sp-sm) 0}

/* — PWA Banner — */
.pwa-banner{position:fixed;top:0;left:0;right:0;z-index:800;background:linear-gradient(135deg,#1a0505,#2D0A0A);border-bottom:2px solid var(--c-gold);padding:var(--sp-sm) var(--sp-md);display:flex;align-items:center;gap:var(--sp-md);box-shadow:0 4px 20px rgba(0,0,0,.5);animation:slideDown .4s ease}
@keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
.pwa-banner.hidden{display:none}
.pwa-banner-text{flex:1;font-size:.85rem;color:var(--c-text)}
.pwa-banner-text strong{color:var(--c-gold)}
.pwa-install-btn{padding:.5rem 1rem;border-radius:var(--r-pill);background:var(--c-gold);color:#2D0A0A;border:none;font-weight:700;cursor:pointer;white-space:nowrap;font-size:.85rem}
.pwa-close-btn{background:none;border:none;color:var(--c-text-dim);font-size:1.2rem;cursor:pointer;padding:4px}

/* — Remind Button — */
.btn-remind{padding:.6rem 1.2rem;border-radius:var(--r-pill);border:1px solid rgba(212,175,55,.4);background:rgba(212,175,55,.08);color:var(--c-gold);cursor:pointer;font-size:.85rem;transition:all var(--t-fast)}
.btn-remind:hover{background:rgba(212,175,55,.15);border-color:var(--c-gold)}

/* — Print (after all shop/fab styles) — */
@media print{
  .nav,.stepper,.actions,.btn,.floating-root,.shop-card,.modal-overlay{display:none!important}
  body{background:#fff!important;color:#000!important}
  .card,.dim-pane,.conclusion{border:1px solid #ccc!important;background:#fff!important;box-shadow:none!important}
  .text-gold,.card-title,.verdict-label,.hex-name,.zw-palace{color:#8b0000!important}
  .tag{border:1px solid #ccc}
  .prob-fill{background:#8b0000!important}
  .step{display:none!important}
  #step-3{display:block!important}
  .dim-pane{display:block!important;margin-bottom:1rem}
  .dim-tabs{display:none!important}
}
/* =============================================================
   UI POLISH v2 — 全站視覺升級
   ============================================================= */

/* ── 背景：深色漸層 + 微光粒子感 ── */
body::before{
  content:'';position:fixed;inset:0;z-index:-1;
  background:
    radial-gradient(ellipse 600px 400px at 20% 10%, rgba(139,0,0,0.15), transparent),
    radial-gradient(ellipse 500px 350px at 80% 85%, rgba(212,175,55,0.06), transparent),
    radial-gradient(ellipse 300px 300px at 50% 50%, rgba(139,0,0,0.05), transparent);
  pointer-events:none;
}

/* ── 導航列升級 ── */
.nav{
  background:rgba(13,4,4,0.88)!important;
  backdrop-filter:blur(16px) saturate(1.4)!important;
  border-bottom:1px solid rgba(212,175,55,0.12)!important;
  box-shadow:0 2px 20px rgba(0,0,0,0.3);
}
.nav-brand i{
  text-shadow:0 0 16px rgba(212,175,55,0.5);
}

/* ── Hero 重設計 ── */
.hero{
  padding:var(--sp-xl) var(--sp-md) var(--sp-lg)!important;
  text-align:center;
  position:relative;
}
.hero::before{
  content:'';position:absolute;top:-20px;left:50%;transform:translateX(-50%);
  width:200px;height:200px;
  background:radial-gradient(circle,rgba(212,175,55,0.12) 0%,transparent 70%);
  border-radius:50%;pointer-events:none;
}
.hero-icon{
  font-size:3rem!important;
  text-shadow:0 0 40px rgba(212,175,55,0.5),0 0 80px rgba(212,175,55,0.2)!important;
  position:relative;z-index:1;
}
.hero h1{
  font-size:clamp(1.5rem,5vw,2.2rem)!important;
  background:linear-gradient(135deg,#d4af37 0%,#f5e6b8 40%,#d4af37 60%,#b8941f 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
  line-height:1.4!important;
  letter-spacing:0.05em;
}
.hero p{
  color:var(--c-text-dim)!important;font-size:0.95rem!important;
  letter-spacing:0.08em;
}

/* ── 卡片玻璃態 ── */
.card{
  background:rgba(30,12,12,0.75)!important;
  backdrop-filter:blur(8px);
  border:1px solid rgba(212,175,55,0.12)!important;
  box-shadow:0 8px 32px rgba(0,0,0,0.3),inset 0 1px 0 rgba(255,255,255,0.03)!important;
}
.card:hover{
  border-color:rgba(212,175,55,0.25)!important;
  box-shadow:0 12px 40px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.05)!important;
}

/* ── 卡片標題裝飾線 ── */
.card-title{
  padding-bottom:var(--sp-sm);
  border-bottom:1px solid rgba(212,175,55,0.1);
  margin-bottom:var(--sp-md)!important;
}
.card-title i{
  color:var(--c-gold);text-shadow:0 0 8px rgba(212,175,55,0.3);
}

/* ── 表單升級 ── */
.form-input,.form-select,.form-textarea{
  background:rgba(0,0,0,0.3)!important;
  border:1px solid rgba(255,255,255,0.08)!important;
  border-radius:var(--r-md)!important;
  color:var(--c-text)!important;
  padding:0.85rem 1rem!important;
  transition:all 0.3s ease!important;
  font-size:16px!important; /* prevent iOS zoom */
}
.form-input:focus,.form-select:focus,.form-textarea:focus{
  border-color:rgba(212,175,55,0.5)!important;
  box-shadow:0 0 0 3px rgba(212,175,55,0.1),0 0 20px rgba(212,175,55,0.05)!important;
  outline:none!important;
}
.form-label{
  font-weight:600!important;
  color:var(--c-text)!important;
  margin-bottom:var(--sp-sm)!important;
  display:block!important;
}

/* ── 性別 Radio Pills ── */
.radio-pills{display:flex;gap:var(--sp-sm)}
.radio-pill{flex:1}
.radio-pill input{display:none}
.radio-pill span{
  display:block;text-align:center;padding:0.75rem;
  border:1px solid rgba(255,255,255,0.08);border-radius:var(--r-md);
  cursor:pointer;transition:all 0.3s;color:var(--c-text-dim);font-weight:600;
}
.radio-pill input:checked+span{
  border-color:var(--c-gold);color:var(--c-gold);
  background:rgba(212,175,55,0.1);
  box-shadow:0 0 12px rgba(212,175,55,0.15);
}

/* ── Stepper 精緻化 ── */
.stepper{
  display:flex;align-items:center;justify-content:center;
  gap:0;margin:var(--sp-md) 0 var(--sp-lg);padding:0 var(--sp-md);
}
.stepper-dot{
  width:36px!important;height:36px!important;
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:0.85rem;
  border:2px solid rgba(255,255,255,0.12);
  color:var(--c-text-dim);background:rgba(0,0,0,0.3);
  transition:all 0.4s ease;
}
.stepper-item.active .stepper-dot{
  border-color:var(--c-gold);color:var(--c-gold);
  background:rgba(212,175,55,0.12);
  box-shadow:0 0 16px rgba(212,175,55,0.25);
}
.stepper-item.done .stepper-dot{
  border-color:rgba(212,175,55,0.4);color:var(--c-gold-light);
  background:rgba(212,175,55,0.08);
}
.stepper-line{
  flex:1;height:2px;
  background:linear-gradient(90deg,rgba(255,255,255,0.06),rgba(212,175,55,0.15),rgba(255,255,255,0.06));
  margin:0 var(--sp-xs);
}
.stepper-item{
  display:flex;flex-direction:column;align-items:center;gap:4px;
}
.stepper-item span{font-size:0.7rem;color:var(--c-text-muted)}
.stepper-item.active span{color:var(--c-gold)}

/* ── 按鈕升級 ── */
.btn-primary,.btn-gold{
  position:relative;overflow:hidden;
}
.btn-primary::before,.btn-gold::before{
  content:'';position:absolute;top:0;left:-100%;
  width:60%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);
  transition:left 0.5s;
}
.btn-primary:hover::before,.btn-gold:hover::before{
  left:100%;
}

/* ── 結果頁 Verdict 升級 ── */
.result-verdict{
  text-align:center;
  padding:var(--sp-xl) var(--sp-lg)!important;
  border:1px solid rgba(212,175,55,0.2)!important;
  background:linear-gradient(180deg,rgba(30,12,12,0.9) 0%,rgba(45,10,10,0.95) 100%)!important;
  position:relative;
}
.result-verdict::before{
  content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:60%;height:1px;
  background:linear-gradient(90deg,transparent,var(--c-gold),transparent);
}
.verdict-prob{
  font-size:clamp(2.5rem,8vw,4rem)!important;
  font-weight:900!important;
  letter-spacing:2px;
}
.verdict-label{
  font-size:1.2rem!important;
  letter-spacing:0.1em;
}

/* ── 機率條升級 ── */
.prob-bar{
  height:10px!important;border-radius:var(--r-pill)!important;
  background:rgba(255,255,255,0.05)!important;
  overflow:hidden;position:relative;
}
.prob-fill{
  height:100%;border-radius:var(--r-pill);
  background:linear-gradient(90deg,#8b0000,#d4af37,#e8c968)!important;
  position:relative;
  transition:width 1.5s cubic-bezier(0.4,0,0.2,1)!important;
}
.prob-fill::after{
  content:'';position:absolute;right:0;top:0;bottom:0;width:20px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3));
  border-radius:0 var(--r-pill) var(--r-pill) 0;
  animation:pulse 2s infinite;
}

/* ── Dimension Tabs 升級 ── */
.dim-tabs{
  display:flex;gap:var(--sp-xs);padding:var(--sp-sm);
  background:rgba(0,0,0,0.2);border-radius:var(--r-md);
  overflow-x:auto;-webkit-overflow-scrolling:touch;
}
.dim-tab{
  padding:0.6rem 1rem!important;border-radius:var(--r-sm)!important;
  font-size:0.82rem!important;white-space:nowrap;
  border:1px solid rgba(255,255,255,0.06)!important;
  background:transparent!important;color:var(--c-text-dim)!important;
  transition:all 0.3s!important;cursor:pointer;
}
.dim-tab.active{
  background:linear-gradient(135deg,var(--c-crimson),#6b0000)!important;
  color:var(--c-gold-pale)!important;
  border-color:rgba(212,175,55,0.4)!important;
  box-shadow:0 2px 12px rgba(139,0,0,0.3);
}

/* ── 商品卡片升級 ── */
.product-grid{
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr))!important;
}
.product-card{
  border-radius:var(--r-lg)!important;
  background:linear-gradient(135deg,rgba(30,12,12,0.8),rgba(20,8,8,0.9))!important;
  border:1px solid rgba(212,175,55,0.08)!important;
  transition:all 0.3s ease!important;
  position:relative;overflow:hidden;
}
.product-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,0.4),transparent);
  opacity:0;transition:opacity 0.3s;
}
.product-card:hover::before{opacity:1}
.product-card:hover{
  transform:translateY(-3px)!important;
  box-shadow:0 12px 36px rgba(0,0,0,0.4)!important;
  border-color:rgba(212,175,55,0.2)!important;
}
.product-icon{font-size:2.5rem!important}
.product-price{
  font-size:1.15rem!important;
  background:linear-gradient(135deg,var(--c-gold),var(--c-gold-light));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.product-btn{
  border-radius:var(--r-pill)!important;
  padding:0.45rem 0.85rem!important;
  font-weight:600!important;
}

/* ── 塔羅牌動畫 ── */
.tarot-card-draw{
  transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1),opacity 0.3s;
}
.tarot-card-draw:hover{
  transform:translateY(-8px) scale(1.05);
}

/* ── 結論區升級 ── */
.conclusion{
  position:relative;
  border:1px solid rgba(212,175,55,0.15)!important;
  background:linear-gradient(135deg,rgba(30,12,12,0.85),rgba(20,8,8,0.95))!important;
  border-radius:var(--r-lg)!important;
  padding:var(--sp-xl) var(--sp-lg)!important;
}
.conclusion::before{
  content:'';position:absolute;top:-1px;left:10%;right:10%;height:1px;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,0.5),transparent);
}
.conclusion h3{
  text-align:center!important;
  font-size:1.3rem!important;
  margin-bottom:var(--sp-lg)!important;
}
.conclusion p{
  line-height:2!important;
  margin-bottom:var(--sp-md)!important;
  color:rgba(245,230,211,0.85)!important;
}

/* ── 社會認同 + 計數器升級 ── */
.live-counter-bar{
  background:rgba(0,0,0,0.2)!important;
  border:1px solid rgba(212,175,55,0.1)!important;
  border-radius:var(--r-pill)!important;
  padding:var(--sp-xs) var(--sp-lg)!important;
  display:inline-flex!important;
}
.live-marquee{
  animation:fadeIn 0.3s;
}

/* ── 分享/折扣區升級 ── */
.share-gate-card{
  background:linear-gradient(135deg,rgba(212,175,55,0.05),rgba(139,0,0,0.05))!important;
  border:2px dashed rgba(212,175,55,0.25)!important;
}
.discount-reveal{
  animation:scaleIn 0.5s ease;
}
.discount-code{
  animation:shimmer 3s ease-in-out infinite;
  background-size:200% 100%;
  background-image:linear-gradient(90deg,var(--c-gold),#fff,var(--c-gold-light),var(--c-gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}

/* ── 商城推薦卡片升級 ── */
.shop-card{
  background:linear-gradient(135deg,rgba(139,0,0,0.12),rgba(212,175,55,0.06))!important;
  border:1px solid rgba(212,175,55,0.2)!important;
}
.shop-btn-card{
  border-radius:var(--r-lg)!important;
  padding:1rem 1.15rem!important;
}

/* ── 浮動按鈕升級 ── */
.fab{
  box-shadow:0 4px 16px rgba(0,0,0,0.3)!important;
}
.fab-toggle{
  width:52px!important;height:52px!important;
  box-shadow:0 4px 24px rgba(139,0,0,0.5),0 0 12px rgba(212,175,55,0.15)!important;
}

/* ── 滾動條 ── */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:rgba(0,0,0,0.1)}
::-webkit-scrollbar-thumb{background:rgba(212,175,55,0.2);border-radius:var(--r-pill)}
::-webkit-scrollbar-thumb:hover{background:rgba(212,175,55,0.4)}

/* ── 選取文字顏色 ── */
::selection{background:rgba(212,175,55,0.3);color:var(--c-text)}

/* ── 平滑滾動 ── */
html{scroll-behavior:smooth}

/* ── Loading Skeleton ── */
@keyframes skeleton{0%{background-position:-200% 0}100%{background-position:200% 0}}
.skeleton{
  background:linear-gradient(90deg,rgba(255,255,255,0.03) 25%,rgba(255,255,255,0.08) 50%,rgba(255,255,255,0.03) 75%);
  background-size:200% 100%;animation:skeleton 1.5s infinite;
  border-radius:var(--r-sm);
}

/* ── 分隔線 ── */
.divider-gold{
  height:1px;margin:var(--sp-lg) 0;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,0.3),transparent);
}

/* ── 紫微命盤格子升級 ── */
.zw-grid{gap:3px!important}
.zw-cell{
  background:rgba(0,0,0,0.2)!important;
  border:1px solid rgba(212,175,55,0.1)!important;
  border-radius:var(--r-sm)!important;
  transition:border-color 0.3s;
}
.zw-cell:hover{border-color:rgba(212,175,55,0.3)}
.zw-cell.active-palace{
  border-color:rgba(212,175,55,0.5)!important;
  background:rgba(212,175,55,0.06)!important;
  box-shadow:inset 0 0 20px rgba(212,175,55,0.05);
}

/* ── Tag 升級 ── */
.tag{border-radius:var(--r-pill)!important}

/* ── 五行 Tag 彩色 ── */
.el-tag.el-金{background:rgba(192,192,192,0.15);color:#e0e0e0;border-color:rgba(192,192,192,0.3)}
.el-tag.el-木{background:rgba(34,197,94,0.15);color:#4ade80;border-color:rgba(34,197,94,0.3)}
.el-tag.el-水{background:rgba(59,130,246,0.15);color:#60a5fa;border-color:rgba(59,130,246,0.3)}
.el-tag.el-火{background:rgba(239,68,68,0.15);color:#f87171;border-color:rgba(239,68,68,0.3)}
.el-tag.el-土{background:rgba(167,139,90,0.15);color:#d4a857;border-color:rgba(167,139,90,0.3)}

/* ── Mobile 優化 ── */
@media(max-width:640px){
  .hero h1{letter-spacing:0.02em}
  .product-grid{grid-template-columns:1fr!important}
  .product-card{flex-direction:column!important;text-align:center}
  .product-card .product-actions{justify-content:center}
  .conclusion{padding:var(--sp-lg) var(--sp-md)!important}
  .live-counter-bar{flex-direction:column!important;gap:var(--sp-xs)!important;padding:var(--sp-sm)!important;border-radius:var(--r-md)!important}
  .live-counter-bar span:nth-child(2){display:none}
}

/* ── Daily Fortune ── */
.fortune-draw-area{text-align:center;padding:var(--sp-xl) 0}
.fortune-urn{font-size:4rem;animation:pulse 2s infinite;margin-bottom:var(--sp-md)}
.fortune-result{text-align:center}
.fortune-sign-icon{font-size:3rem;margin-bottom:var(--sp-sm)}
.fortune-sign-text{font-size:1.8rem;font-weight:900;color:var(--c-gold);letter-spacing:0.1em;margin-bottom:var(--sp-sm);font-family:var(--f-display)}
.fortune-msg{color:var(--c-text);font-size:1.05rem;line-height:1.6;margin-bottom:var(--sp-md)}
.fortune-divider{height:1px;background:linear-gradient(90deg,transparent,rgba(212,175,55,.3),transparent);margin:var(--sp-md) 0}
.fortune-crystal-rec{background:rgba(212,175,55,0.04);border:1px solid rgba(212,175,55,0.12);border-radius:var(--r-md);padding:var(--sp-md)}
.fortune-crystal-card{display:flex;align-items:center;gap:var(--sp-sm);justify-content:center;margin:var(--sp-sm) 0}
.fortune-crystal-name{font-weight:700;font-size:1.1rem;color:var(--c-gold)}
.fortune-buy-btns{display:flex;gap:var(--sp-sm);justify-content:center}
.achievements-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:var(--sp-sm)}
.achievement-badge{text-align:center;padding:var(--sp-md);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);transition:all 0.3s}
.achievement-badge.unlocked{border-color:rgba(212,175,55,0.3);background:rgba(212,175,55,0.04)}
.achievement-badge.locked{opacity:0.4;filter:grayscale(0.8)}
.badge-icon{font-size:2rem;margin-bottom:var(--sp-xs)}
.badge-name{font-size:0.85rem;font-weight:700;color:var(--c-text);margin-bottom:2px}
.achievement-toast{position:fixed;top:20px;right:20px;z-index:999;background:linear-gradient(135deg,rgba(30,12,12,0.95),rgba(45,10,10,0.98));border:2px solid var(--c-gold);border-radius:var(--r-lg);padding:var(--sp-md) var(--sp-lg);display:flex;align-items:center;gap:var(--sp-md);box-shadow:0 8px 32px rgba(0,0,0,0.5);transform:translateX(120%);transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);max-width:320px}
.achievement-toast.show{transform:translateX(0)}
.at-icon{font-size:2rem}
.ency-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:var(--sp-sm)}
.ency-card{padding:var(--sp-md);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);cursor:pointer;transition:all 0.3s;background:rgba(0,0,0,0.15)}
.ency-card:hover{border-color:rgba(212,175,55,0.3);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3)}
.ency-icon{font-size:2rem;margin-bottom:var(--sp-xs)}
.ency-name{font-weight:700;color:var(--c-text);font-size:0.95rem}
.ency-meta{display:flex;gap:var(--sp-xs);margin:var(--sp-xs) 0}
.ency-desc{font-size:0.78rem;color:var(--c-text-dim);line-height:1.4;margin:var(--sp-xs) 0}
.ency-price{font-weight:700;color:var(--c-gold);font-size:0.9rem}
.crystal-detail-modal{position:fixed;inset:0;z-index:600;display:flex;align-items:center;justify-content:center;padding:var(--sp-md)}
.crystal-detail-modal.hidden{display:none}
.cdm-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
.cdm-content{position:relative;background:linear-gradient(135deg,rgba(30,12,12,0.98),rgba(20,8,8,0.99));border:1px solid rgba(212,175,55,0.25);border-radius:var(--r-lg);padding:var(--sp-xl);max-width:420px;width:100%;max-height:90vh;overflow-y:auto;text-align:center}
.cdm-close{position:absolute;top:var(--sp-sm);right:var(--sp-sm);background:none;border:none;color:var(--c-text-dim);font-size:1.2rem;cursor:pointer}
.cdm-icon{font-size:3.5rem;margin-bottom:var(--sp-sm)}
.cdm-name{font-size:1.5rem;font-weight:700;color:var(--c-gold);font-family:var(--f-display);margin-bottom:var(--sp-sm)}
.cdm-tags{display:flex;gap:var(--sp-sm);justify-content:center;margin-bottom:var(--sp-md)}
.cdm-desc{color:var(--c-text);line-height:1.6;margin-bottom:var(--sp-md)}
.cdm-info{text-align:left;background:rgba(0,0,0,0.2);border-radius:var(--r-md);padding:var(--sp-md);margin-bottom:var(--sp-lg)}
.cdm-row{padding:var(--sp-xs) 0;color:var(--c-text-dim);font-size:0.9rem}
.cdm-row strong{color:var(--c-gold)}
.cdm-actions{display:flex;gap:var(--sp-sm);justify-content:center;flex-wrap:wrap}
.quiz-progress{text-align:center;color:var(--c-text-dim);font-size:0.85rem;margin-bottom:var(--sp-xs)}
.quiz-progress-bar{height:4px;background:rgba(255,255,255,0.06);border-radius:var(--r-pill);overflow:hidden;margin-bottom:var(--sp-lg)}
.quiz-fill{height:100%;background:linear-gradient(90deg,var(--c-crimson),var(--c-gold));border-radius:var(--r-pill);transition:width 0.4s}
.quiz-question{text-align:center;font-size:1.15rem;color:var(--c-text);margin-bottom:var(--sp-lg);line-height:1.5}
.quiz-options{display:flex;flex-direction:column;gap:var(--sp-sm)}
.quiz-option{padding:1rem var(--sp-lg);border:1px solid rgba(255,255,255,0.08);border-radius:var(--r-md);background:rgba(0,0,0,0.15);color:var(--c-text);cursor:pointer;text-align:left;transition:all 0.3s;font-size:0.95rem}
.quiz-option:hover{border-color:rgba(212,175,55,0.4);background:rgba(212,175,55,0.06);transform:translateX(4px)}
.quiz-result{text-align:center}
.quiz-result-icon{font-size:3.5rem;margin-bottom:var(--sp-sm)}
.quiz-result-title{color:var(--c-text-dim);font-size:0.95rem;margin-bottom:var(--sp-xs)}
.quiz-result-crystal{font-size:2rem;font-weight:900;color:var(--c-gold);font-family:var(--f-display);margin-bottom:var(--sp-sm)}
.quiz-result-el{display:flex;gap:var(--sp-sm);justify-content:center;margin-bottom:var(--sp-md)}
.quiz-result-desc{color:var(--c-text);line-height:1.6;margin-bottom:var(--sp-sm)}
.quiz-result-actions{display:flex;gap:var(--sp-sm);justify-content:center;flex-wrap:wrap}
.quiz-bazi-note{background:rgba(212,175,55,0.06);border:1px solid rgba(212,175,55,0.2);border-radius:var(--r-md);padding:var(--sp-sm) var(--sp-md);margin:var(--sp-md) 0;font-size:0.85rem;color:var(--c-text-dim);line-height:1.5}
.quiz-bazi-note strong{color:var(--c-gold)}
.quiz-bazi-match{background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.2);border-radius:var(--r-md);padding:var(--sp-sm) var(--sp-md);margin:var(--sp-md) 0;font-size:0.85rem;color:rgba(74,222,128,0.9);line-height:1.5}
.quiz-bazi-match strong{color:#4ade80}
.review-carousel{min-height:120px;transition:opacity 0.3s}
.review-card{border:1px solid rgba(212,175,55,0.12);border-radius:var(--r-md);padding:var(--sp-md);background:rgba(0,0,0,0.15)}
.review-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-sm);flex-wrap:wrap;gap:var(--sp-xs)}
.review-stars{font-size:0.85rem}
.review-meta{font-size:0.75rem;color:var(--c-text-muted)}
.review-text{color:var(--c-text);line-height:1.6;font-size:0.9rem;margin-bottom:var(--sp-sm)}
.review-product{display:flex;justify-content:flex-end}
.extra-nav{display:flex;gap:var(--sp-xs);overflow-x:auto;padding:var(--sp-sm) 0;margin:var(--sp-lg) 0 var(--sp-sm);border-bottom:1px solid rgba(255,255,255,0.06);-webkit-overflow-scrolling:touch}
.nav-extra-tab{padding:0.5rem 1rem;border-radius:var(--r-pill);font-size:0.82rem;white-space:nowrap;border:1px solid rgba(255,255,255,0.06);background:none;color:var(--c-text-dim);cursor:pointer;transition:all 0.3s}
.nav-extra-tab.active{background:rgba(212,175,55,0.1);color:var(--c-gold);border-color:rgba(212,175,55,0.3)}
.extra-section{padding:var(--sp-md) 0}
.extra-section.hidden{display:none}

/* ── Games ── */
.game-progress{text-align:center;font-size:0.85rem;color:var(--c-gold);margin-bottom:var(--sp-md)}
.game-question{text-align:center;font-size:1.15rem;margin-bottom:var(--sp-lg);line-height:1.5}
.game-options{display:flex;flex-wrap:wrap;gap:var(--sp-sm);justify-content:center}
.game-opt{padding:0.7rem 1.2rem;border:1px solid rgba(255,255,255,0.1);border-radius:var(--r-md);background:rgba(0,0,0,0.2);color:var(--c-text);cursor:pointer;font-size:0.95rem;transition:all 0.3s;min-width:60px}
.game-opt:hover{border-color:rgba(212,175,55,0.4);background:rgba(212,175,55,0.06)}
.game-opt.correct{border-color:#4ade80!important;background:rgba(34,197,94,0.15)!important;color:#4ade80!important}
.game-opt.wrong{border-color:#f87171!important;background:rgba(239,68,68,0.15)!important;color:#f87171!important}
.game-feedback{text-align:center;margin-top:var(--sp-md);font-size:1rem;min-height:1.5em}
.fb-correct{color:#4ade80}.fb-wrong{color:#f87171}
.game-result{text-align:center;padding:var(--sp-lg)}
.game-result-icon{font-size:3rem;margin-bottom:var(--sp-sm)}
.game-score-big{font-size:2.5rem;font-weight:900;color:var(--c-gold);margin:var(--sp-sm) 0}
.game-actions{display:flex;gap:var(--sp-sm);justify-content:center}
.zodiac-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:var(--sp-xs)}
.zodiac-btn{display:flex;flex-direction:column;align-items:center;padding:var(--sp-sm);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);background:none;color:var(--c-text);cursor:pointer;transition:all 0.3s}
.zodiac-btn:hover,.zodiac-btn.selected{border-color:var(--c-gold);background:rgba(212,175,55,0.08)}
.zodiac-icon{font-size:1.5rem}.zodiac-name{font-size:0.7rem;margin-top:2px}
.zodiac-selected{text-align:center;font-size:1.2rem;min-height:1.5em}
.zodiac-result{text-align:center;padding:var(--sp-lg)}
.zodiac-pair-icons{font-size:2.5rem;margin-bottom:var(--sp-sm)}
.zodiac-match-score{font-size:2rem;font-weight:900;color:var(--c-gold)}
.zodiac-match-level{font-size:1.1rem;color:var(--c-text);margin-bottom:var(--sp-sm)}
.lucky-card{padding:var(--sp-lg)}
.lucky-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-md)}
.lucky-item{text-align:center;padding:var(--sp-md);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);background:rgba(0,0,0,0.1)}
.lucky-label{font-size:0.75rem;color:var(--c-text-muted);margin-bottom:var(--sp-xs)}
.lucky-value{font-size:1.1rem;font-weight:700;color:var(--c-text);display:flex;align-items:center;justify-content:center;gap:var(--sp-xs)}
.lucky-num{font-size:2rem;color:var(--c-gold)}
.lucky-sub{font-size:0.7rem;color:var(--c-text-dim);margin-top:2px}
.lucky-color-dot{width:16px;height:16px;border-radius:50%;display:inline-block;border:1px solid rgba(255,255,255,0.2)}
@media(max-width:640px){.zodiac-grid{grid-template-columns:repeat(4,1fr)}}

/* Tarot card generated images */
.tc-img{width:100%;height:auto;border-radius:4px;display:block;margin-bottom:4px}
.t-card-face.t-front{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4px}
.t-card-face.t-front .tc-name{font-size:0.7rem;margin-top:2px}
.tc-spread-img{box-shadow:0 2px 8px rgba(0,0,0,0.3);border:1px solid rgba(212,175,55,0.3)}
</style>
</head>
<body>
<nav class="nav"><div class="nav-inner">
  <div class="nav-brand"><i class="fas fa-moon"></i><span>靜月之光 v3.0</span></div>
  <div class="nav-links">
    <button class="nav-link active" onclick="goStep(0)">輸入</button>
    <button class="nav-link" onclick="goStep(1)">梅花</button>
    <button class="nav-link" onclick="goStep(2)">塔羅</button>
    <button class="nav-link" onclick="goStep(3)">結果</button>
  </div>
  <div class="nav-shop">
    <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer">🛒 蝦皮</a>
    <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer">📦 7-11</a>
  </div>
</div></nav>

<div class="app">

<!-- ========== STEP 0: INPUT ========== -->
<section class="step active" id="step-0">
  <div class="hero">
    <div class="hero-icon">☽</div>
    <h1>靜月之光能量占卜儀</h1>
    <p>整合八字 · 紫微斗數 · 梅花易數 · 塔羅牌的多維度命理分析</p>
    <div class="live-counter-bar">
      <span>🔥 累計 <strong id="live-counter-num">184,729</strong> 人已測</span>
      <span>｜</span>
      <span>今日 <strong id="live-today-num">47</strong> 人</span>
    </div>

  </div>
  <div class="stepper" id="main-stepper">
    <div class="stepper-item active"><div class="stepper-dot">1</div><span>輸入</span></div><div class="stepper-line"></div>
    <div class="stepper-item"><div class="stepper-dot">2</div><span>梅花</span></div><div class="stepper-line"></div>
    <div class="stepper-item"><div class="stepper-dot">3</div><span>塔羅</span></div><div class="stepper-line"></div>
    <div class="stepper-item"><div class="stepper-dot">4</div><span>結果</span></div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-question-circle"></i> 你的問題</div>
    <div class="form-group">
      <label class="form-label">問題類型 <span class="req">*</span></label>
      <select class="form-select" id="f-type"><option value="">請選擇</option>
        <option value="love">愛情</option><option value="career">事業</option><option value="wealth">財運</option>
        <option value="health">健康</option><option value="general">綜合運勢</option><option value="relationship">人際</option>
        <option value="family">家庭</option><option value="other">其他</option></select>
    </div>
    <div class="form-group">
      <label class="form-label">你現在最想問的一件事 <span class="req">*</span></label>
      <textarea class="form-textarea" id="f-question" placeholder="例：我今年適合轉職嗎？" maxlength="500"></textarea>
      <div class="form-hint"><span id="f-char">0</span>/500</div>
    </div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-user"></i> 出生資料</div>
    <div class="form-group">
      <label class="form-label">性別 <span class="req">*</span></label>
      <div class="radio-pills">
        <label class="radio-pill"><input type="radio" name="gender" value="male"><span>男</span></label>
        <label class="radio-pill"><input type="radio" name="gender" value="female"><span>女</span></label>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">出生日期（國曆）<span class="req">*</span></label>
      <input type="date" class="form-input" id="f-bdate">
    </div>
    <div class="form-group">
      <label class="form-label">出生時間</label>
      <input type="time" class="form-input" id="f-btime">
      <div class="form-hint">不確定可留空，系統以 12:00 估算</div>
    </div>
    <div class="form-group">
      <label class="form-label">姓名（選填）</label>
      <input type="text" class="form-input" id="f-name" placeholder="用於姓名學分析">
    </div>
  </div>
  <div class="actions actions-center">
    <button class="btn btn-primary btn-lg" onclick="submitStep0()"><i class="fas fa-arrow-right"></i> 下一步：梅花易數</button>
  </div>
</section>

<!-- ========== STEP 1: MEIHUA ========== -->
<section class="step" id="step-1">
  <div class="card">
    <div class="card-title"><i class="fas fa-yin-yang"></i> 梅花易數起卦</div>
    <div style="display:flex;gap:var(--sp-sm);flex-wrap:wrap;margin-bottom:var(--sp-md)">
      <button class="btn btn-sm btn-tab-active" id="mh-m-time" onclick="setMhMethod('time')"><i class="fas fa-clock"></i> 時間</button>
      <button class="btn btn-sm btn-outline" id="mh-m-number" onclick="setMhMethod('number')"><i class="fas fa-sort-numeric-up"></i> 數字</button>
      <button class="btn btn-sm btn-outline" id="mh-m-char" onclick="setMhMethod('char')"><i class="fas fa-font"></i> 漢字</button>
      <button class="btn btn-sm btn-outline" id="mh-m-random" onclick="setMhMethod('random')"><i class="fas fa-dice"></i> 隨機</button>
    </div>
    <div id="mhf-time"><p class="text-dim text-sm mb-md">按下按鈕自動以當前時間起卦</p><button class="btn btn-primary" onclick="calcMhTime()"><i class="fas fa-calculator"></i> 時間起卦</button></div>
    <div id="mhf-number" class="hidden">
      <div class="form-group"><label class="form-label">上卦數字 (1-999)</label><input type="number" class="form-input" id="mh-n1" min="1" max="999"></div>
      <div class="form-group"><label class="form-label">下卦數字 (1-999)</label><input type="number" class="form-input" id="mh-n2" min="1" max="999"></div>
      <div class="form-group"><label class="form-label">動爻 (1-6)</label><input type="number" class="form-input" id="mh-n3" min="1" max="6"></div>
      <button class="btn btn-primary" onclick="calcMhNumber()"><i class="fas fa-calculator"></i> 數字起卦</button>
    </div>
    <div id="mhf-char" class="hidden">
      <div class="form-group"><label class="form-label">輸入漢字 (1-3個)</label><input type="text" class="form-input" id="mh-char" placeholder="如：感情" maxlength="3"></div>
      <button class="btn btn-primary" onclick="calcMhChar()"><i class="fas fa-calculator"></i> 漢字起卦</button>
    </div>
    <div id="mhf-random" class="hidden"><p class="text-dim text-sm mb-md">心誠則靈，隨機產生卦象</p><button class="btn btn-primary" onclick="calcMhRandom()"><i class="fas fa-dice"></i> 隨機起卦</button></div>
  </div>
  <div id="mh-result" class="hidden">
    <div class="card">
      <div class="hex-grid">
        <div class="hex-card"><h4>本卦</h4><div class="hex-sym" id="mh-ben-s"></div><div class="hex-name" id="mh-ben-n"></div></div>
        <div class="hex-card"><h4>互卦</h4><div class="hex-sym" id="mh-hu-s"></div><div class="hex-name" id="mh-hu-n"></div></div>
        <div class="hex-card"><h4>變卦</h4><div class="hex-sym" id="mh-bian-s"></div><div class="hex-name" id="mh-bian-n"></div></div>
      </div>
      <div class="divider"></div>
      <div id="mh-detail" class="text-sm"></div>
    </div>
  </div>
  <div class="actions">
    <button class="btn btn-outline" onclick="goStep(0)"><i class="fas fa-arrow-left"></i> 上一步</button>
    <button class="btn btn-outline" onclick="goStep(2)"><i class="fas fa-forward"></i> 跳過</button>
    <button class="btn btn-primary" onclick="goStep(2)"><i class="fas fa-arrow-right"></i> 下一步：塔羅牌</button>
  </div>
</section>

<!-- ========== STEP 2: TAROT ========== -->
<section class="step" id="step-2">
  <div class="card">
    <div class="card-title"><i class="fas fa-star"></i> 金色黎明塔羅牌</div>
    <p class="text-dim text-sm mb-md">點擊抽牌，共需 10 張。剩餘：<strong id="t-remain">10</strong> 張</p>
    <div class="text-center">
      <button class="btn btn-gold btn-lg" id="btn-draw" onclick="drawCard()"><i class="fas fa-hand-pointer"></i> 抽一張牌</button>
      <button class="btn btn-outline btn-sm" onclick="autoDraw()" style="margin-left:var(--sp-sm)"><i class="fas fa-bolt"></i> 快速全抽</button>
    </div>
    <div class="tarot-hand" id="t-hand"></div>
  </div>
  <div id="t-spread-sec" class="hidden"><div class="card"><div class="card-title"><i class="fas fa-cross"></i> 凱爾特十字牌陣</div><div id="t-spread"></div></div></div>
  <div class="actions">
    <button class="btn btn-outline" onclick="goStep(1)"><i class="fas fa-arrow-left"></i> 上一步</button>
    <button class="btn btn-outline" onclick="skipToResult()"><i class="fas fa-forward"></i> 跳過塔羅</button>
    <button class="btn btn-primary" id="btn-analyze" onclick="goStep(3)" disabled><i class="fas fa-chart-bar"></i> 進行分析</button>
  </div>
</section>

<!-- ========== STEP 3: RESULT ========== -->
<section class="step" id="step-3">
  <div class="result-verdict" id="r-verdict">
    <div class="verdict-label" id="r-vlabel">分析中…</div>
    <div class="verdict-prob" id="r-vprob">0%</div>
    <div class="verdict-note" id="r-vnote"></div>
  </div>
  <div class="card"><div class="card-title"><i class="fas fa-bullseye"></i> 直接回答</div>
    <div id="r-question" class="text-dim mb-md"></div>
    <div id="r-answer" class="serif" style="font-size:1.05rem;line-height:1.8"></div>
    <div class="divider"></div><div id="r-factors"></div><div id="r-suggest" class="mt-md"></div>
  </div>
  <div class="card"><div class="card-title"><i class="fas fa-chart-line"></i> 可能性評估</div>
    <div class="prob-meter"><div class="prob-bar"><div class="prob-fill" id="r-pfill" style="width:0%"></div></div>
    <div class="prob-labels"><span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span></div></div>
    <div id="r-pbreak" class="mt-md text-sm"></div>
  </div>
  <div class="card" style="padding:0;overflow:visible">
    <div class="dim-tabs">
      <button class="dim-tab active" onclick="showDim('bazi')">八字命理</button>
      <button class="dim-tab" onclick="showDim('ziwei')">紫微斗數</button>
      <button class="dim-tab" onclick="showDim('meihua')">梅花易數</button>
      <button class="dim-tab" onclick="showDim('tarot')">塔羅牌陣</button>
      <button class="dim-tab" onclick="showDim('name')">姓名學</button>
    </div>
    <div class="dim-pane active" id="pane-bazi">
      <h4 class="text-gold mb-md serif">四柱八字命盤</h4><div id="d-bazi"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">五行分佈</h4><div id="d-elbar"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">十神分析</h4><div id="d-gods" class="text-sm"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">藏干詳解</h4><div id="d-canggan" class="text-sm"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">喜用神與忌神</h4><div id="d-xiyong" class="text-sm"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">大運流年</h4><div id="d-dayun"></div>
    </div>
    <div class="dim-pane" id="pane-ziwei">
      <h4 class="text-gold mb-md serif">紫微斗數命盤</h4>
      <div id="d-ziwei-info" class="text-sm mb-md"></div>
      <div id="d-ziwei-grid"></div>
      <div class="divider"></div>
      <h4 class="text-gold mb-md serif">四化飛星</h4>
      <div id="d-ziwei-sihua" class="text-sm"></div>
      <div class="divider"></div>
      <h4 class="text-gold mb-md serif">命盤解讀</h4>
      <div id="d-ziwei-reading" class="text-sm"></div>
    </div>
    <div class="dim-pane" id="pane-meihua"><div id="r-meihua"></div></div>
    <div class="dim-pane" id="pane-tarot"><div id="r-tarot"></div></div>
    <div class="dim-pane" id="pane-name">
      <h4 class="text-gold mb-md serif">姓名學分析（三才五格）</h4>
      <div id="d-name"></div>
    </div>
  </div>
  <div class="card"><div class="card-title"><i class="fas fa-gem"></i> 【處方】水晶校準建議</div><div id="r-crystal"></div></div>

  <!-- 商城推薦卡 -->
  <div class="card shop-card">
    <div class="card-title"><i class="fas fa-shopping-bag"></i> 想把結果做成「專屬五行手鏈」？我幫你配到位</div>
    <p class="text-sm text-dim mb-md">依你結果的喜用神，給你 3 個實用搭配（可直接下單）</p>
    <div class="shop-btns">
      <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer" class="shop-btn-card shopee">
        <i class="fas fa-shopping-cart"></i>
        <div><strong>🛒 蝦皮逛逛</strong><span class="text-xs">全館免運 + 關注9折</span></div>
      </a>
      <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer" class="shop-btn-card seven">
        <i class="fas fa-box"></i>
        <div><strong>📦 賣貨便</strong><span class="text-xs">滿千免運 / 多件合併</span></div>
      </a>
      <button class="shop-btn-card custom" onclick="openCustomModal()">
        <i class="fas fa-magic"></i>
        <div><strong>✨ 我要客製</strong><span class="text-xs">填資料 / 預算版</span></div>
      </button>
    </div>
    <p class="text-xs text-muted mt-md"><i class="fas fa-info-circle"></i> 預算版 / 加強版 / 收藏版：選一個就好</p>
  </div>

  <div class="conclusion"><h3><i class="fas fa-moon"></i> 靜月分析師總結</h3><div id="r-conclusion" class="text-sm" style="line-height:1.8"></div></div>
  <!-- 存圖分享區 -->
  <div class="card" style="text-align:center">
    <div class="card-title"><i class="fas fa-share-alt"></i> 分享你的占卜結果</div>
    <p class="text-sm text-dim mb-md">存成圖片分享到 IG / LINE，朋友也能免費測！</p>
    <div class="actions actions-center" style="gap:var(--sp-md);flex-wrap:wrap">
      <button class="btn-save-card" onclick="saveResultCard()"><i class="fas fa-download"></i> 存圖分享</button>
      <button class="btn btn-outline" onclick="printResult()"><i class="fas fa-print"></i> 列印</button>
    </div>
  </div>

  <!-- 再測一次（分享解鎖） -->
  <div class="share-gate-card mt-lg" id="share-gate">
    <h4>🔄 想再測一次？</h4>
    <p>分享給朋友後即可重新開始 — 讓更多人也能免費測！</p>
    <button class="btn-share-big" onclick="shareToUnlock()"><i class="fas fa-paper-plane"></i> 分享給朋友，解鎖再測</button>
  </div>
  <!-- 折扣碼（分享後顯示） -->
  <div class="discount-reveal hidden mt-lg" id="discount-reveal">
    <h4 style="color:var(--c-gold);margin-bottom:var(--sp-sm)">🎁 感謝分享！你的專屬折扣碼：</h4>
    <div class="discount-code" id="discount-code">A50HDDG44</div>
    <p class="text-sm text-dim mt-sm">蝦皮下單時輸入此碼享 <strong style="color:var(--c-gold)">9折優惠</strong></p>
    <button class="btn btn-outline btn-sm mt-sm" onclick="copyDiscountCode()"><i class="fas fa-copy"></i> 複製折扣碼</button>
    <div class="mt-md">
      <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener" class="btn btn-gold"><i class="fas fa-shopping-cart"></i> 立即前往蝦皮選購</a>
    </div>
  </div>
  <div class="actions actions-center mt-lg hidden" id="btn-retest">
    <button class="btn btn-gold btn-full" onclick="retestAfterShare()" style="max-width:320px"><i class="fas fa-redo"></i> 重新開始新的占卜</button>
  </div>
  <!-- 7天提醒 -->
  <div class="text-center mt-lg">
    <button class="btn-remind" id="btn-remind" onclick="addReminder7Days()"><i class="fas fa-bell"></i> 7天後提醒我再測一次</button>
    <p class="text-xs text-muted mt-xs">會下載 .ics 日曆檔，自動加入手機行事曆</p>
  </div>
</section>

</div><!-- /app -->

<!-- 客製表單 Modal -->
<div class="modal-overlay" id="custom-modal" style="display:none">
  <div class="modal-box">
    <button class="modal-close" onclick="closeCustomModal()">&times;</button>
    <h3 class="serif text-gold mb-md"><i class="fas fa-magic"></i> 能量手鏈客製服務</h3>
    <form id="custom-form" action="https://formsubmit.co/onerkk@gmail.com" method="POST" onsubmit="return prepareCustomSubmit()">
      <!-- formsubmit.co config -->
      <input type="hidden" name="_subject" id="cf-subject-hidden" value="【客製詢問】能量手鏈">
      <input type="hidden" name="_captcha" value="false">
      <input type="hidden" name="_template" value="table">
      <input type="hidden" name="_next" id="cf-next-url" value="">
      <input type="text" name="_honey" style="display:none">
      <input type="hidden" name="占卜分析摘要" id="cf-analysis-hidden" value="">
      <div class="form-group">
        <label class="form-label">姓名 <span class="req">*</span></label>
        <input type="text" class="form-input" id="cf-name" name="姓名" required placeholder="您的姓名">
      </div>
      <div class="form-group">
        <label class="form-label">出生日期 <span class="req">*</span></label>
        <input type="date" class="form-input" id="cf-bday" name="出生日期" required>
      </div>
      <div class="form-group">
        <label class="form-label">想解決的問題 <span class="req">*</span></label>
        <textarea class="form-textarea" id="cf-question" name="想解決的問題" required placeholder="例：想提升事業運、改善感情、招財等..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">預算範圍 <span class="req">*</span></label>
        <select class="form-select" id="cf-budget" name="預算範圍" required>
          <option value="">請選擇</option>
          <option value="預算版（$1,000-$3,000）">預算版（$1,000 - $3,000）</option>
          <option value="加強版（$3,000-$6,000）">加強版（$3,000 - $6,000）</option>
          <option value="收藏版（$6,000以上）">收藏版（$6,000 以上）</option>
        </select>
      </div>
      <div class="actions" style="margin-top:var(--sp-lg)">
        <button type="button" class="btn btn-outline" onclick="closeCustomModal()">取消</button>
        <button type="submit" class="btn btn-gold" id="cf-submit-btn"><i class="fas fa-paper-plane"></i> 送出詢問</button>
      </div>
      <p class="text-xs text-muted mt-md"><i class="fas fa-lock"></i> 表單直接寄到店家信箱，不經第三方儲存。首次送出後會收到確認信。</p>
    </form>
    <div id="cf-sent" class="hidden mt-lg text-center">
      <div style="font-size:2rem;margin-bottom:var(--sp-sm)">✅</div>
      <h4 class="text-gold mb-sm">詢問已送出！</h4>
      <p class="text-sm text-dim mb-md">我們會盡快透過 Email 回覆您。</p>
      <button class="btn btn-outline" onclick="closeCustomModal()"><i class="fas fa-check"></i> 關閉</button>
    </div>
  </div>
</div>

<!-- ========== 互動功能區 ========== -->
<div class="app" style="padding-top:0">
  <div class="extra-nav">
    <button class="nav-extra-tab active" data-target="sec-daily-fortune">🎰 每日運勢</button>
    <button class="nav-extra-tab" data-target="sec-crystal-quiz">🧪 水晶配對</button>
    <button class="nav-extra-tab" data-target="sec-wuxing-game">🎯 五行問答</button>
    <button class="nav-extra-tab" data-target="sec-zodiac">💑 生肖配對</button>
    <button class="nav-extra-tab" data-target="sec-lucky">🍀 今日幸運</button>
    <button class="nav-extra-tab" data-target="sec-encyclopedia">📖 水晶百科</button>
    <button class="nav-extra-tab" data-target="sec-achievements">🏆 成就徽章</button>
    <button class="nav-extra-tab" data-target="sec-reviews">💬 使用者好評</button>
  </div>

  <!-- 每日運勢籤 -->
  <div class="extra-section" id="sec-daily-fortune">
    <div class="card">
      <div class="card-title"><i class="fas fa-sun"></i> 每日運勢籤 — 免費抽一次</div>
      <div id="daily-fortune-content"></div>
    </div>
  </div>

  <!-- 水晶配對測驗 -->
  <div class="extra-section hidden" id="sec-crystal-quiz">
    <div class="card">
      <div class="card-title"><i class="fas fa-flask"></i> 找出你的命定水晶</div>
      <p class="text-sm text-dim mb-md">3 道直覺題，30 秒找到最適合你的水晶（每次題目不同！）</p>
      <div id="crystal-quiz-content">
        <div class="text-center">
          <button class="btn btn-gold" onclick="startCrystalQuiz()"><i class="fas fa-play"></i> 開始測驗</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 五行問答遊戲 -->
  <div class="extra-section hidden" id="sec-wuxing-game">
    <div class="card">
      <div class="card-title"><i class="fas fa-gamepad"></i> 五行命理問答挑戰</div>
      <p class="text-sm text-dim mb-md">5 題隨機出題，測試你的命理知識！</p>
      <div id="wuxing-game-content">
        <div class="text-center">
          <button class="btn btn-gold" onclick="startWuxingGame()"><i class="fas fa-play"></i> 開始挑戰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 生肖配對 -->
  <div class="extra-section hidden" id="sec-zodiac">
    <div class="card">
      <div class="card-title"><i class="fas fa-heart"></i> 生肖配對測試</div>
      <div id="zodiac-match-content"></div>
    </div>
  </div>

  <!-- 今日幸運 -->
  <div class="extra-section hidden" id="sec-lucky">
    <div class="card">
      <div class="card-title"><i class="fas fa-clover"></i> 今日幸運指南</div>
      <div id="lucky-gen-content"></div>
    </div>
  </div>

  <!-- 水晶百科 -->
  <div class="extra-section hidden" id="sec-encyclopedia">
    <div class="card">
      <div class="card-title"><i class="fas fa-book"></i> 水晶百科圖鑑</div>
      <p class="text-sm text-dim mb-md">點擊任一水晶查看詳細功效與購買連結</p>
      <div class="ency-grid" id="crystal-encyclopedia-grid"></div>
    </div>
  </div>

  <!-- 成就徽章 -->
  <div class="extra-section hidden" id="sec-achievements">
    <div class="card">
      <div class="card-title"><i class="fas fa-trophy"></i> 我的成就 <span class="text-sm text-muted" id="achievement-progress">0/9 已解鎖</span></div>
      <div class="achievements-grid" id="achievements-grid"></div>
    </div>
  </div>

  <!-- 好評輪播 -->
  <div class="extra-section hidden" id="sec-reviews">
    <div class="card">
      <div class="card-title"><i class="fas fa-comments"></i> 買家真實回饋</div>
      <div id="review-carousel"></div>
      <div class="text-center mt-md">
        <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener" class="btn btn-outline btn-sm"><i class="fas fa-shopping-cart"></i> 去賣場看更多評價</a>
      </div>
    </div>
  </div>
</div>

<!-- 水晶詳情 Modal -->
<div class="crystal-detail-modal hidden" id="crystal-detail-modal"></div>

<!-- PWA 安裝提示 -->
<div class="pwa-banner hidden" id="pwa-banner">
  <div class="pwa-banner-text">
    <strong>☽ 加到主畫面</strong>，隨時測運勢更方便！
  </div>
  <button class="pwa-install-btn" onclick="installPWA()">安裝</button>
  <button class="pwa-close-btn" onclick="hidePWABanner()">&times;</button>
</div>

<!-- 浮動按鈕 -->
<div class="floating-root" id="floating-root">
  <button class="fab fab-toggle" onclick="toggleFab()" aria-label="選單"><i class="fas fa-ellipsis-v"></i></button>
  <div class="fab-menu hidden" id="fab-menu">
    <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer" class="fab fab-shopee" title="蝦皮逛逛"><i class="fas fa-shopping-cart"></i><span>蝦皮</span></a>
    <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer" class="fab fab-711" title="賣貨便"><i class="fas fa-box"></i><span>7-11</span></a>
    <button class="fab fab-custom" onclick="openCustomModal()" title="客製"><i class="fas fa-magic"></i><span>客製</span></button>
  </div>
</div>
<script>
/* =============================================================
   GLOBAL STATE
   ============================================================= */
const S = { step:0, form:{}, bazi:null, meihua:null, tarot:{drawn:[],spread:[]}, ziwei:null };

/* =============================================================
   NAVIGATION
   ============================================================= */
function goStep(n){
  if(n===3 && !S.bazi){alert('請先填寫基本資料');return}
  document.querySelectorAll('.step').forEach((s,i)=>s.classList.toggle('active',i===n));
  document.querySelectorAll('.nav-link').forEach((l,i)=>l.classList.toggle('active',i===n));
  document.querySelectorAll('.stepper-item').forEach((s,i)=>{s.classList.remove('active','done');if(i<n)s.classList.add('done');if(i===n)s.classList.add('active')});
  S.step=n; window.scrollTo({top:0,behavior:'smooth'});
  if(n===3) runAnalysis();
}
function resetAll(){S.bazi=null;S.meihua=null;S.tarot={drawn:[],spread:[]};S.ziwei=null;goStep(0);document.getElementById('mh-result').classList.add('hidden');document.getElementById('t-hand').innerHTML='';document.getElementById('t-remain').textContent='10';document.getElementById('btn-draw').disabled=false;document.getElementById('btn-analyze').disabled=true;document.getElementById('t-spread-sec').classList.add('hidden')}
function skipToResult(){goStep(3)}

/* — Char counter — */
document.getElementById('f-question').addEventListener('input',function(){document.getElementById('f-char').textContent=this.value.length});

/* =============================================================
   天干地支 CORE DATA
   ============================================================= */
const TG=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
const DZ=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
const WX_G={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
const WX_Z={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
const YY_G={甲:'陽',乙:'陰',丙:'陽',丁:'陰',戊:'陽',己:'陰',庚:'陽',辛:'陰',壬:'陽',癸:'陰'};
const SHENG={木:'火',火:'土',土:'金',金:'水',水:'木'};
const KE={木:'土',火:'金',土:'水',金:'木',水:'火'};
const BE_SHENG={木:'水',火:'木',土:'火',金:'土',水:'金'}; // 生我
const BE_KE={木:'金',火:'水',土:'木',金:'火',水:'土'};   // 克我

/* 藏干 */
const CG={
  子:['癸'],丑:['己','癸','辛'],寅:['甲','丙','戊'],卯:['乙'],
  辰:['戊','乙','癸'],巳:['丙','庚','戊'],午:['丁','己'],未:['己','丁','乙'],
  申:['庚','壬','戊'],酉:['辛'],戌:['戊','辛','丁'],亥:['壬','甲']
};

/* 十神 */
function tenGod(dm,tgt){
  if(!WX_G[dm]||!WX_G[tgt])return'—';
  const d=WX_G[dm],t=WX_G[tgt],s=YY_G[dm]===YY_G[tgt];
  if(d===t)return s?'比肩':'劫財';
  if(SHENG[d]===t)return s?'食神':'傷官';
  if(KE[d]===t)return s?'偏財':'正財';
  if(KE[t]===d)return s?'七殺':'正官';
  if(SHENG[t]===d)return s?'偏印':'正印';
  return'—';
}

/* 十二長生 */
const CHANG_SHENG_ORDER=['長生','沐浴','冠帶','臨官','帝旺','衰','病','死','墓','絕','胎','養'];
const CS_START={甲:DZ.indexOf('亥'),丙:DZ.indexOf('寅'),戊:DZ.indexOf('寅'),庚:DZ.indexOf('巳'),壬:DZ.indexOf('申'),
                乙:DZ.indexOf('午'),丁:DZ.indexOf('酉'),己:DZ.indexOf('酉'),辛:DZ.indexOf('子'),癸:DZ.indexOf('卯')};
function changSheng(dm,zhi){
  const start=CS_START[dm]; if(start===undefined)return'—';
  const zhiIdx=DZ.indexOf(zhi); if(zhiIdx<0)return'—';
  const isYang=YY_G[dm]==='陽';
  let diff=isYang?(zhiIdx-start+12)%12:(start-zhiIdx+12)%12;
  return CHANG_SHENG_ORDER[diff];
}

/* 神煞 (簡化版 — 常用15個) */
function getShenSha(pillars){
  const ss=[];
  const yZ=pillars.year.zhi, dG=pillars.day.gan, dZ=pillars.day.zhi;
  // 天乙貴人
  const TIYI={甲:['丑','未'],戊:['丑','未'],庚:['丑','未'],丙:['亥','酉'],丁:['亥','酉'],
              乙:['子','申'],己:['子','申'],壬:['卯','巳'],癸:['卯','巳'],辛:['午','寅']};
  if(TIYI[dG]){[yZ,pillars.month.zhi,pillars.hour.zhi].forEach(z=>{if(TIYI[dG].includes(z))ss.push('天乙貴人')})}
  // 文昌
  const WC={甲:'巳',乙:'午',丙:'申',丁:'酉',戊:'申',己:'酉',庚:'亥',辛:'子',壬:'寅',癸:'卯'};
  if(WC[dG]){[yZ,pillars.month.zhi,pillars.hour.zhi].forEach(z=>{if(z===WC[dG])ss.push('文昌')})}
  // 驛馬
  const YM={寅:'申',巳:'亥',申:'寅',亥:'巳',子:'午',午:'子',卯:'酉',酉:'卯',辰:'戌',戌:'辰',丑:'未',未:'丑'};
  if(YM[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===YM[yZ])ss.push('驛馬')})}
  // 桃花
  const TH_MAP={子:'酉',丑:'午',寅:'卯',卯:'子',辰:'酉',巳:'午',午:'卯',未:'子',申:'酉',酉:'午',戌:'卯',亥:'子'};
  if(TH_MAP[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===TH_MAP[yZ])ss.push('桃花')})}
  // 華蓋
  const HG_MAP={子:'辰',丑:'丑',寅:'戌',卯:'未',辰:'辰',巳:'丑',午:'戌',未:'未',申:'辰',酉:'丑',戌:'戌',亥:'未'};
  if(HG_MAP[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===HG_MAP[yZ])ss.push('華蓋')})}
  return[...new Set(ss)];
}

/* =============================================================
   BAZI COMPUTATION (完整版)
   ============================================================= */
function submitStep0(){
  const type=document.getElementById('f-type').value;
  const question=document.getElementById('f-question').value.trim();
  const gender=document.querySelector('input[name="gender"]:checked');
  const bdate=document.getElementById('f-bdate').value;
  if(!type||!question||!gender||!bdate){alert('請填寫所有必要欄位');return}
  const btime=document.getElementById('f-btime').value||'12:00';
  const name=document.getElementById('f-name').value.trim();
  S.form={type,question,gender:gender.value,bdate,btime,name};
  const[y,m,d]=bdate.split('-').map(Number);
  const[hh,mm]=btime.split(':').map(Number);
  S.bazi=computeBazi(y,m,d,hh,mm,gender.value);
  S.ziwei=computeZiwei(y,m,d,hh,gender.value);
  goStep(1);
}

function computeBazi(year,month,day,hour,minute,gender){
  // ── 年柱 ──
  let ly=year;
  if(month<2||(month===2&&day<4))ly--;
  const yGi=((ly-4)%10+10)%10;
  const yZi=((ly-4)%12+12)%12;
  const yG=TG[yGi], yZ=DZ[yZi];

  // ── 月柱 ──
  // 節氣近似日
  const JIE=[0,6,4,6,5,6,6,7,8,8,8,7,7]; // index 1-12
  let mi=month;
  if(day<(JIE[month]||6))mi=mi===1?12:mi-1;
  const mZi=((mi+1)%12+12)%12; // 正月=寅(2)
  const mGBase=(yGi%5)*2;
  const mGi=(mGBase+(mi-1))%10;
  const mG=TG[(mGi+10)%10], mZ=DZ[mZi];

  // ── 日柱 ──
  const base=new Date(1900,0,1);
  const tgt=new Date(year,month-1,day);
  const diff=Math.floor((tgt-base)/864e5);
  const adj=diff+10;
  const dGi=((adj%10)+10)%10;
  const dZi=((adj%12)+12)%12;
  const dG=TG[dGi], dZ=DZ[dZi];

  // ── 時柱 ──
  const shi=Math.floor(((hour+1)%24)/2);
  const hZi=shi%12;
  const hGBase=(dGi%5)*2;
  const hGi=(hGBase+hZi)%10;
  const hG=TG[hGi], hZ=DZ[hZi];

  const pillars={year:{gan:yG,zhi:yZ},month:{gan:mG,zhi:mZ},day:{gan:dG,zhi:dZ},hour:{gan:hG,zhi:hZ}};
  const dm=dG, dmEl=WX_G[dm];

  // ── 五行統計（含藏干權重）──
  const ec={金:0,木:0,水:0,火:0,土:0};
  const allG=[yG,mG,dG,hG], allZ=[yZ,mZ,dZ,hZ];
  allG.forEach(g=>ec[WX_G[g]]+=1.0);
  allZ.forEach(z=>{
    ec[WX_Z[z]]+=1.0;
    const cg=CG[z]||[];
    if(cg[0])ec[WX_G[cg[0]]]+=0.6; // 本氣
    if(cg[1])ec[WX_G[cg[1]]]+=0.3; // 中氣
    if(cg[2])ec[WX_G[cg[2]]]+=0.1; // 餘氣
  });
  const tot=Object.values(ec).reduce((a,b)=>a+b,0);
  const ep={}; for(const k of Object.keys(ec))ep[k]=Math.round(ec[k]/tot*100);

  // ── 身強身弱 ──
  const selfScore=(ec[dmEl]||0)+(ec[BE_SHENG[dmEl]]||0)*0.6;
  const strong=selfScore>tot*0.42;

  // ── 喜用神 / 忌神 ──
  let fav,unfav;
  if(strong){
    fav=[BE_KE[dmEl],SHENG[dmEl]]; // 克我(官殺)、我生(食傷)
    if(ec[KE[dmEl]]<1.5)fav.push(KE[dmEl]); // 我克(財)也可用
    unfav=[dmEl,BE_SHENG[dmEl]];
  }else{
    fav=[dmEl,BE_SHENG[dmEl]]; // 同我(比劫)、生我(印)
    unfav=[BE_KE[dmEl],SHENG[dmEl]];
  }

  // ── 十神 ──
  const gods={};
  ['year','month','day','hour'].forEach(p=>{
    const g=pillars[p].gan, z=pillars[p].zhi;
    gods[p]={
      gan: p==='day'?'日主':tenGod(dm,g),
      zhi: CG[z]?CG[z].map(c=>tenGod(dm,c)):['—']
    };
  });

  // ── 十二長生 ──
  const cs={};
  ['year','month','day','hour'].forEach(p=>{
    cs[p]=changSheng(dm,pillars[p].zhi);
  });

  // ── 神煞 ──
  const shensha=getShenSha(pillars);

  // ── 納音 ──
  const nayin=getNaYin(yGi,yZi);

  // ── 大運 ──
  const isFwd=(gender==='male'&&YY_G[yG]==='陽')||(gender==='female'&&YY_G[yG]==='陰');
  const dir=isFwd?1:-1;
  const startAge=computeStartAge(year,month,day,dir);
  const dayun=[];
  for(let i=0;i<10;i++){
    const gI=((TG.indexOf(mG)+(i+1)*dir)%10+10)%10;
    const zI=((DZ.indexOf(mZ)+(i+1)*dir)%12+12)%12;
    const as=startAge+i*10, ae=as+9;
    const curAge=new Date().getFullYear()-year;
    const isCur=curAge>=as&&curAge<=ae;
    const dyG=TG[gI],dyZ=DZ[zI],dyEl=WX_G[dyG];
    let lv='平';
    if(fav.includes(dyEl)){
      const god=tenGod(dm,dyG);
      lv=(['正印','偏印','正官'].includes(god))?'大吉':'中吉';
    }else if(unfav.includes(dyEl)){
      const god=tenGod(dm,dyG);
      lv=(['七殺'].includes(god))?'中凶':'小凶';
    }
    // 流年
    const liuNian=[];
    for(let j=0;j<10;j++){
      const lnYear=year+as+j;
      const lnGI=((lnYear-4)%10+10)%10;
      const lnZI=((lnYear-4)%12+12)%12;
      const lnG=TG[lnGI],lnZ=DZ[lnZI],lnEl=WX_G[lnG];
      let lnLv='平';
      if(fav.includes(lnEl))lnLv='吉';
      if(unfav.includes(lnEl))lnLv='凶';
      liuNian.push({year:lnYear,gz:lnG+lnZ,el:lnEl,level:lnLv,god:tenGod(dm,lnG)});
    }
    dayun.push({gz:dyG+dyZ,el:dyEl,ageStart:as,ageEnd:ae,isCurrent:isCur,level:lv,god:tenGod(dm,dyG),liuNian});
  }

  return{pillars,dm,dmEl,strong,ec,ep,fav,unfav,gods,cs,shensha,nayin,dayun,cangGan:{year:CG[yZ],month:CG[mZ],day:CG[dZ],hour:CG[hZ]}};
}

function computeStartAge(y,m,d,dir){
  // 簡化：順行找下一個節氣，逆行找上一個，每3天折1歲
  // 這裡用近似值
  const JIE_DAYS=[0,6,4,6,5,6,6,7,8,8,8,7,7];
  const jd=JIE_DAYS[m]||6;
  let diff=dir>0?(jd<=d?30-d+JIE_DAYS[(m%12)+1]:jd-d):(d<=jd?d+30-JIE_DAYS[((m-2+12)%12)+1]:d-jd);
  return Math.max(1,Math.round(diff/3));
}

/* 納音 */
function getNaYin(gi,zi){
  const NY=['海中金','爐中火','大林木','路旁土','劍鋒金','山頭火','澗下水','城頭土','白蠟金','楊柳木',
            '泉中水','屋上土','霹靂火','松柏木','長流水','砂中金','山下火','平地木','壁上土','金箔金',
            '覆燈火','天河水','大驛土','釵釧金','桑柘木','大溪水','砂中土','天上火','石榴木','大海水'];
  const idx=Math.floor(((gi*12+zi)/2)%30);
  return NY[idx]||'';
}
/* =============================================================
   梅花易數 MEIHUA YISHU — 完整64卦
   ============================================================= */
const BG=[
  {name:'乾',sym:'☰',nat:'天',el:'金',n:1,li:[1,1,1]},
  {name:'兌',sym:'☱',nat:'澤',el:'金',n:2,li:[1,1,0]},
  {name:'離',sym:'☲',nat:'火',el:'火',n:3,li:[1,0,1]},
  {name:'震',sym:'☳',nat:'雷',el:'木',n:4,li:[1,0,0]},
  {name:'巽',sym:'☴',nat:'風',el:'木',n:5,li:[0,1,1]},
  {name:'坎',sym:'☵',nat:'水',el:'水',n:6,li:[0,1,0]},
  {name:'艮',sym:'☶',nat:'山',el:'土',n:7,li:[0,0,1]},
  {name:'坤',sym:'☷',nat:'地',el:'土',n:8,li:[0,0,0]}
];
const G64={
'11':{n:'乾為天',u:'䷀',j:'元亨利貞。',m:'剛健中正，萬事亨通，戒驕傲。'},
'12':{n:'天澤履',u:'䷉',j:'履虎尾，不咥人，亨。',m:'小心謹慎前行，合禮則吉。'},
'13':{n:'天火同人',u:'䷌',j:'同人于野，亨。',m:'志同道合者聚集，利涉大川。'},
'14':{n:'天雷無妄',u:'䷘',j:'元亨利貞。',m:'至誠無妄，順天而行。'},
'15':{n:'天風姤',u:'䷫',j:'女壯，勿用取女。',m:'偶然相遇，不可急進。'},
'16':{n:'天水訟',u:'䷅',j:'有孚，窒。',m:'爭訟之象，宜和解退讓。'},
'17':{n:'天山遁',u:'䷠',j:'亨，小利貞。',m:'退避保身，以退為進。'},
'18':{n:'天地否',u:'䷋',j:'否之匪人。',m:'閉塞不通，守靜待時。'},
'21':{n:'澤天夬',u:'䷪',j:'揚于王庭。',m:'決斷果敢，以剛決柔。'},
'22':{n:'兌為澤',u:'䷹',j:'亨，利貞。',m:'喜悅交流，言語得宜。'},
'23':{n:'澤火革',u:'䷰',j:'己日乃孚。',m:'變革除舊，時機成熟方可行。'},
'24':{n:'澤雷隨',u:'䷐',j:'元亨利貞，無咎。',m:'順勢而行，隨機應變。'},
'25':{n:'澤風大過',u:'䷛',j:'棟撓，利有攸往。',m:'力量過大，需謹慎。'},
'26':{n:'澤水困',u:'䷮',j:'亨，貞，大人吉。',m:'困境中堅守正道，終將通達。'},
'27':{n:'澤山咸',u:'䷞',j:'亨，利貞。',m:'感應之道，心意相通。'},
'28':{n:'澤地萃',u:'䷬',j:'亨，王假有廟。',m:'聚集匯萃，利見大人。'},
'31':{n:'火天大有',u:'䷍',j:'元亨。',m:'豐收大有，光明正大。'},
'32':{n:'火澤睽',u:'䷥',j:'小事吉。',m:'乖離背反，求同存異。'},
'33':{n:'離為火',u:'䷝',j:'利貞，亨。',m:'光明附麗，依附正道。'},
'34':{n:'火雷噬嗑',u:'䷔',j:'亨，利用獄。',m:'明辨是非，果斷處理。'},
'35':{n:'火風鼎',u:'䷱',j:'元吉，亨。',m:'鼎新除舊，變革創新。'},
'36':{n:'火水未濟',u:'䷿',j:'亨，小狐汔濟。',m:'尚未完成，仍需努力。'},
'37':{n:'火山旅',u:'䷷',j:'小亨。',m:'客居在外，謹慎處世。'},
'38':{n:'火地晉',u:'䷢',j:'康侯用錫馬蕃庶。',m:'光明上進，步步晉升。'},
'41':{n:'雷天大壯',u:'䷡',j:'利貞。',m:'氣勢壯盛，守正方吉。'},
'42':{n:'雷澤歸妹',u:'䷵',j:'征凶，無攸利。',m:'安分守己，不可妄動。'},
'43':{n:'雷火豐',u:'䷶',j:'亨，王假之。',m:'豐盛之時，居安思危。'},
'44':{n:'震為雷',u:'䷲',j:'亨。',m:'震動奮發，先驚後喜。'},
'45':{n:'雷風恆',u:'䷟',j:'亨，無咎，利貞。',m:'恆久不變，守持正道。'},
'46':{n:'雷水解',u:'䷧',j:'利西南。',m:'危難解除，宜速行動。'},
'47':{n:'雷山小過',u:'䷽',j:'亨，利貞。',m:'小有過越，低調行事。'},
'48':{n:'雷地豫',u:'䷏',j:'利建侯行師。',m:'歡樂豫悅，準備充分。'},
'51':{n:'風天小畜',u:'䷈',j:'亨，密雲不雨。',m:'力量不足，暫時蓄積。'},
'52':{n:'風澤中孚',u:'䷼',j:'豚魚吉。',m:'誠信為本，信則靈驗。'},
'53':{n:'風火家人',u:'䷤',j:'利女貞。',m:'家道昌明，各安其位。'},
'54':{n:'風雷益',u:'䷩',j:'利有攸往。',m:'損上益下，利於進取。'},
'55':{n:'巽為風',u:'䷸',j:'小亨，利有攸往。',m:'柔順漸進，以退為進。'},
'56':{n:'風水渙',u:'䷺',j:'亨，王假有廟。',m:'離散渙散，需凝聚人心。'},
'57':{n:'風山漸',u:'䷴',j:'女歸吉，利貞。',m:'循序漸進，穩步前行。'},
'58':{n:'風地觀',u:'䷓',j:'盥而不薦。',m:'觀察審視，以身作則。'},
'61':{n:'水天需',u:'䷄',j:'有孚，光亨。',m:'等待時機，耐心守候。'},
'62':{n:'水澤節',u:'䷻',j:'亨，苦節不可貞。',m:'適度節制，不可過度。'},
'63':{n:'水火既濟',u:'䷾',j:'亨小，利貞。',m:'事已成，居安思危。'},
'64':{n:'水雷屯',u:'䷂',j:'元亨利貞。',m:'創始之難，堅持終有成。'},
'65':{n:'水風井',u:'䷯',j:'改邑不改井。',m:'養民之源，不可荒廢。'},
'66':{n:'坎為水',u:'䷜',j:'有孚，維心亨。',m:'重重險難，以信心行險。'},
'67':{n:'水山蹇',u:'䷦',j:'利西南。',m:'前路艱險，退守反省。'},
'68':{n:'水地比',u:'䷇',j:'吉，原筮元永貞。',m:'親附比和，團結互助。'},
'71':{n:'山天大畜',u:'䷙',j:'利貞，不家食吉。',m:'蓄積力量，厚積薄發。'},
'72':{n:'山澤損',u:'䷨',j:'有孚，元吉。',m:'減損自己，利益他人。'},
'73':{n:'山火賁',u:'䷕',j:'亨，小利有攸往。',m:'文飾外表，不忘本質。'},
'74':{n:'山雷頤',u:'䷚',j:'貞吉，觀頤。',m:'養生之道，慎言節食。'},
'75':{n:'山風蠱',u:'䷑',j:'元亨，利涉大川。',m:'整治腐敗，撥亂反正。'},
'76':{n:'山水蒙',u:'䷃',j:'亨，匪我求童蒙。',m:'啟蒙之初，虛心學習。'},
'77':{n:'艮為山',u:'䷳',j:'艮其背，不獲其身。',m:'適可而止，靜止守分。'},
'78':{n:'山地剝',u:'䷖',j:'不利有攸往。',m:'衰落剝蝕，靜待復甦。'},
'81':{n:'地天泰',u:'䷊',j:'小往大來，吉亨。',m:'通泰和順，萬事亨通。'},
'82':{n:'地澤臨',u:'䷒',j:'元亨利貞。',m:'居高臨下，教化萬民。'},
'83':{n:'地火明夷',u:'䷣',j:'利艱貞。',m:'光明受傷，韜光養晦。'},
'84':{n:'地雷復',u:'䷗',j:'亨，出入無疾。',m:'一陽復始，否極泰來。'},
'85':{n:'地風升',u:'䷭',j:'元亨。',m:'逐步上升，積小成大。'},
'86':{n:'地水師',u:'䷆',j:'貞，丈人吉。',m:'統率眾人，以正為要。'},
'87':{n:'地山謙',u:'䷎',j:'亨，君子有終。',m:'謙虛自牧，吉無不利。'},
'88':{n:'坤為地',u:'䷁',j:'元亨，利牝馬之貞。',m:'柔順承載，厚德包容。'}
};

function gByN(n){return BG[((n-1)%8+8)%8]}
function g64(un,ln){return G64[''+un+ln]||{n:'未知',u:'?',j:'',m:''}}
function gByL(l1,l2,l3){return BG.find(g=>g.li[0]===l3&&g.li[1]===l2&&g.li[2]===l1)||BG[7]}

function tiYong(ti,yo){
  if(ti===yo)return{r:'比和',f:'吉',d:'體用相同，事情順利。'};
  if(SHENG[yo]===ti)return{r:'用生體',f:'大吉',d:'外力助益，事半功倍。'};
  if(SHENG[ti]===yo)return{r:'體生用',f:'小凶',d:'耗費精力，付出多回報少。'};
  if(KE[yo]===ti)return{r:'用克體',f:'凶',d:'外力阻礙，困難重重。'};
  if(KE[ti]===yo)return{r:'體克用',f:'小吉',d:'可掌控局面，但需費力。'};
  return{r:'—',f:'平',d:''};
}

function calcMH(un,ln,dy){
  const up=gByN(un),lo=gByN(ln),dong=((dy-1)%6)+1;
  const ben=g64(up.n==='乾'?1:up.n==='兌'?2:up.n==='離'?3:up.n==='震'?4:up.n==='巽'?5:up.n==='坎'?6:up.n==='艮'?7:8,
               lo.n==='乾'?1:lo.n==='兌'?2:lo.n==='離'?3:lo.n==='震'?4:lo.n==='巽'?5:lo.n==='坎'?6:lo.n==='艮'?7:8);
  const benL=[...lo.li,...up.li];
  const huLo=gByL(benL[1],benL[2],benL[3]);
  const huUp=gByL(benL[2],benL[3],benL[4]);
  const hu=g64(huUp.n==='乾'?1:huUp.n==='兌'?2:huUp.n==='離'?3:huUp.n==='震'?4:huUp.n==='巽'?5:huUp.n==='坎'?6:huUp.n==='艮'?7:8,
               huLo.n==='乾'?1:huLo.n==='兌'?2:huLo.n==='離'?3:huLo.n==='震'?4:huLo.n==='巽'?5:huLo.n==='坎'?6:huLo.n==='艮'?7:8);
  const biL=[...benL]; biL[dong-1]=biL[dong-1]?0:1;
  const biLo=gByL(biL[0],biL[1],biL[2]);
  const biUp=gByL(biL[3],biL[4],biL[5]);
  const bian=g64(biUp.n==='乾'?1:biUp.n==='兌'?2:biUp.n==='離'?3:biUp.n==='震'?4:biUp.n==='巽'?5:biUp.n==='坎'?6:biUp.n==='艮'?7:8,
                 biLo.n==='乾'?1:biLo.n==='兌'?2:biLo.n==='離'?3:biLo.n==='震'?4:biLo.n==='巽'?5:biLo.n==='坎'?6:biLo.n==='艮'?7:8);
  const tiG=dong<=3?up:lo, yoG=dong<=3?lo:up;
  const ty=tiYong(tiG.el,yoG.el);
  return{up,lo,dong,ben,hu,bian,tiG,yoG,ty};
}

function guaNum(g){return g.n==='乾'?1:g.n==='兌'?2:g.n==='離'?3:g.n==='震'?4:g.n==='巽'?5:g.n==='坎'?6:g.n==='艮'?7:8}

function showMH(r){
  S.meihua=r;
  document.getElementById('mh-ben-s').textContent=r.ben.u;
  document.getElementById('mh-ben-n').textContent=r.ben.n;
  document.getElementById('mh-hu-s').textContent=r.hu.u;
  document.getElementById('mh-hu-n').textContent=r.hu.n;
  document.getElementById('mh-bian-s').textContent=r.bian.u;
  document.getElementById('mh-bian-n').textContent=r.bian.n;
  document.getElementById('mh-detail').innerHTML=`
    <p><strong>體卦：</strong>${r.tiG.name}（${r.tiG.el}）｜<strong>用卦：</strong>${r.yoG.name}（${r.yoG.el}）</p>
    <p><strong>體用：</strong><span class="tag tag-gold">${r.ty.r}</span> <span class="tag ${r.ty.f.includes('吉')?'tag-green':'tag-red'}">${r.ty.f}</span></p>
    <p class="mt-sm">${r.ty.d}</p><div class="divider"></div>
    <p><strong>卦辭：</strong>${r.ben.j}</p><p><strong>解讀：</strong>${r.ben.m}</p>
    <p><strong>動爻：</strong>第 ${r.dong} 爻</p><p class="mt-sm"><strong>變卦：</strong>${r.bian.m}</p>`;
  document.getElementById('mh-result').classList.remove('hidden');
}

/* 漢字筆畫數（簡表） */
const BIHUA_MAP={'愛':13,'情':11,'錢':16,'財':10,'工':3,'作':7,'事':8,'業':13,'健':11,'康':11,'家':10,'庭':10,'人':2,'際':14,'運':12,'勢':13,'感':13,'婚':11,'姻':9,'學':16,'習':11,'考':6,'試':13,'升':4,'職':18,'轉':18};
function bihua(ch){return BIHUA_MAP[ch]||((ch.charCodeAt(0)%20)+2)}

function setMhMethod(m){
  ['time','number','char','random'].forEach(id=>{
    document.getElementById('mhf-'+id).classList.toggle('hidden',id!==m);
    const btn=document.getElementById('mh-m-'+id);
    if(id===m){btn.classList.remove('btn-outline');btn.classList.add('btn-tab-active')}
    else{btn.classList.add('btn-outline');btn.classList.remove('btn-tab-active')}
  });
}
function calcMhTime(){
  const now=new Date();
  const y=now.getFullYear(),m=now.getMonth()+1,d=now.getDate(),h=now.getHours();
  // 農曆近似
  const un=(y+m+d)%8||8, ln=(y+m+d+h)%8||8, dy=(y+m+d+h)%6||6;
  showMH(calcMH(un,ln,dy));
}
function calcMhNumber(){
  const n1=parseInt(document.getElementById('mh-n1').value)||1;
  const n2=parseInt(document.getElementById('mh-n2').value)||1;
  const n3=parseInt(document.getElementById('mh-n3').value)||1;
  showMH(calcMH(n1,n2,Math.min(6,Math.max(1,n3))));
}
function calcMhChar(){
  const ch=document.getElementById('mh-char').value.trim();
  if(!ch){alert('請輸入漢字');return}
  const chars=[...ch];
  let un,ln,dy;
  if(chars.length===1){un=bihua(chars[0]);ln=un;dy=(un*2)%6||6}
  else if(chars.length===2){un=bihua(chars[0]);ln=bihua(chars[1]);dy=(un+ln)%6||6}
  else{un=bihua(chars[0])+bihua(chars[1]);ln=bihua(chars[chars.length-1]);dy=(un+ln)%6||6}
  showMH(calcMH(un,ln,dy));
}
function calcMhRandom(){
  showMH(calcMH(Math.ceil(Math.random()*8),Math.ceil(Math.random()*8),Math.ceil(Math.random()*6)));
}
/* =============================================================
   塔羅牌 TAROT — 22大牌 + 凱爾特十字牌陣
   ============================================================= */
const TAROT=[
  {id:0,n:'愚者',el:'風',up:'充滿無限可能，勇敢踏出第一步。',rv:'魯莽行事，缺乏計畫。'},
  {id:1,n:'魔術師',el:'水星',up:'擁有成功所需的一切資源。',rv:'才能未發揮，注意欺騙。'},
  {id:2,n:'女祭司',el:'月亮',up:'傾聽直覺，靜待時機。',rv:'過於封閉，忽視內心聲音。'},
  {id:3,n:'皇后',el:'金星',up:'豐收與滋養，創造力旺盛。',rv:'依賴他人，過度放縱。'},
  {id:4,n:'皇帝',el:'白羊',up:'掌控局面，建立秩序。',rv:'控制欲強，過於僵化。'},
  {id:5,n:'教皇',el:'金牛',up:'遵循正道，尋求智者指引。',rv:'教條主義，不知變通。'},
  {id:6,n:'戀人',el:'雙子',up:'做出重要選擇，真愛降臨。',rv:'關係不和，價值觀衝突。'},
  {id:7,n:'戰車',el:'巨蟹',up:'堅定意志，克服困難前進。',rv:'失控，方向不明。'},
  {id:8,n:'力量',el:'獅子',up:'以柔克剛，內在力量強大。',rv:'自我懷疑，缺乏信心。'},
  {id:9,n:'隱者',el:'處女',up:'獨處反省，尋找內在智慧。',rv:'過度孤立，逃避現實。'},
  {id:10,n:'命運之輪',el:'木星',up:'命運轉折，好運降臨。',rv:'逆境，抗拒改變。'},
  {id:11,n:'正義',el:'天秤',up:'公正的結果，因果報應。',rv:'不公、偏見。'},
  {id:12,n:'吊人',el:'水',up:'換角度看問題，暫時犧牲。',rv:'不必要的犧牲，拖延。'},
  {id:13,n:'死神',el:'天蠍',up:'舊的結束，新的開始。',rv:'抗拒改變，停滯不前。'},
  {id:14,n:'節制',el:'射手',up:'保持中庸，調和各方。',rv:'失衡，過度。'},
  {id:15,n:'惡魔',el:'摩羯',up:'面對陰暗面，物質誘惑。',rv:'掙脫束縛，重獲自由。'},
  {id:16,n:'塔',el:'火星',up:'突然改變，舊結構崩塌。',rv:'避開災難，拒絕改變。'},
  {id:17,n:'星星',el:'水瓶',up:'希望之光，靈感湧現。',rv:'失望，缺乏信心。'},
  {id:18,n:'月亮',el:'雙魚',up:'面對恐懼，穿越迷霧。',rv:'走出迷惘，真相顯現。'},
  {id:19,n:'太陽',el:'太陽',up:'一切光明正大，喜悅成功。',rv:'短暫陰霾，信心不足。'},
  {id:20,n:'審判',el:'冥王星',up:'靈魂覺醒，重新評估。',rv:'自我懷疑，拒絕成長。'},
  {id:21,n:'世界',el:'土星',up:'達成目標，圓滿完成。',rv:'未完成，缺乏圓滿。'},
  // 小阿爾卡納 — 權杖
  {id:22,n:'權杖王牌',el:'火',up:'新計畫啟動，創造力迸發。',rv:'延遲，猶豫不決。'},
  {id:23,n:'權杖二',el:'火',up:'計畫中，等待時機。',rv:'恐懼改變，缺乏遠見。'},
  {id:24,n:'權杖三',el:'火',up:'拓展視野，合作順利。',rv:'缺乏遠見，計畫受阻。'},
  {id:25,n:'權杖四',el:'火',up:'慶祝成就，和諧穩定。',rv:'不安定，缺乏歸屬感。'},
  {id:26,n:'權杖五',el:'火',up:'競爭激烈，需堅持立場。',rv:'逃避衝突，內耗。'},
  {id:27,n:'權杖六',el:'火',up:'勝利與認可，公開成功。',rv:'自負，缺乏認可。'},
  {id:28,n:'權杖七',el:'火',up:'堅守立場，面對挑戰。',rv:'力不從心，被壓倒。'},
  {id:29,n:'權杖八',el:'火',up:'快速發展，消息到來。',rv:'延遲，急躁。'},
  {id:30,n:'權杖九',el:'火',up:'堅持到底，最後防線。',rv:'疲憊，固執。'},
  {id:31,n:'權杖十',el:'火',up:'責任沉重，堅持前行。',rv:'放下重擔，委派他人。'},
  {id:32,n:'權杖侍者',el:'火',up:'好消息，新冒險。',rv:'不切實際的計畫。'},
  {id:33,n:'權杖騎士',el:'火',up:'行動力強，追求熱情。',rv:'衝動，魯莽。'},
  {id:34,n:'權杖皇后',el:'火',up:'自信、魅力，激勵他人。',rv:'嫉妒，自我中心。'},
  {id:35,n:'權杖國王',el:'火',up:'領導力強，願景宏大。',rv:'傲慢，嚴苛。'},
  // 聖杯
  {id:36,n:'聖杯王牌',el:'水',up:'新感情開始，情感充沛。',rv:'感情封閉，錯失機會。'},
  {id:37,n:'聖杯二',el:'水',up:'伴侶關係，相互吸引。',rv:'失衡，溝通不良。'},
  {id:38,n:'聖杯三',el:'水',up:'歡慶友誼，社交活動。',rv:'過度放縱，孤立。'},
  {id:39,n:'聖杯四',el:'水',up:'對現狀不滿，錯失機會。',rv:'重新審視，發現新可能。'},
  {id:40,n:'聖杯五',el:'水',up:'失落與悲傷，但仍有希望。',rv:'走出悲傷，接受現實。'},
  {id:41,n:'聖杯六',el:'水',up:'懷舊，童年回憶。',rv:'活在過去，無法前進。'},
  {id:42,n:'聖杯七',el:'水',up:'太多選擇，需分辨幻象。',rv:'做出決定，面對現實。'},
  {id:43,n:'聖杯八',el:'水',up:'離開不再適合的，尋找更深。',rv:'恐懼改變，留在舒適區。'},
  {id:44,n:'聖杯九',el:'水',up:'願望實現，滿足感。',rv:'不滿，物質主義。'},
  {id:45,n:'聖杯十',el:'水',up:'情感圓滿，家庭幸福。',rv:'家庭問題，不和諧。'},
  {id:46,n:'聖杯侍者',el:'水',up:'浪漫訊息，直覺發展。',rv:'情緒不穩，不成熟。'},
  {id:47,n:'聖杯騎士',el:'水',up:'浪漫追求者，感性行動。',rv:'情緒化，不切實際。'},
  {id:48,n:'聖杯皇后',el:'水',up:'慈愛，情感豐富，直覺強。',rv:'情緒化，過度付出。'},
  {id:49,n:'聖杯國王',el:'水',up:'情感成熟，慷慨智慧。',rv:'情感壓抑，操控。'},
  // 寶劍
  {id:50,n:'寶劍王牌',el:'風',up:'真相與突破，新想法。',rv:'混亂思緒，錯誤判斷。'},
  {id:51,n:'寶劍二',el:'風',up:'抉擇困難，需平衡思考。',rv:'資訊過載，逃避決定。'},
  {id:52,n:'寶劍三',el:'風',up:'心碎，悲痛，需要療癒。',rv:'走出傷痛，開始復原。'},
  {id:53,n:'寶劍四',el:'風',up:'休息恢復，靜養。',rv:'焦躁不安，不願休息。'},
  {id:54,n:'寶劍五',el:'風',up:'衝突與失敗，自私行為。',rv:'和解，學會認輸。'},
  {id:55,n:'寶劍六',el:'風',up:'離開困境，過渡期。',rv:'困住，無法離開。'},
  {id:56,n:'寶劍七',el:'風',up:'策略行動，但需注意欺騙。',rv:'真相揭露，良心不安。'},
  {id:57,n:'寶劍八',el:'風',up:'自我限制，困境是心造。',rv:'解脫束縛，看清真相。'},
  {id:58,n:'寶劍九',el:'風',up:'焦慮、恐懼、失眠。',rv:'面對恐懼，走出焦慮。'},
  {id:59,n:'寶劍十',el:'風',up:'結束與放下，觸底反彈。',rv:'最壞已過，開始恢復。'},
  {id:60,n:'寶劍侍者',el:'風',up:'好奇心，新想法。',rv:'八卦，冷漠。'},
  {id:61,n:'寶劍騎士',el:'風',up:'思路清晰，快速行動。',rv:'衝動發言，缺乏同理。'},
  {id:62,n:'寶劍皇后',el:'風',up:'獨立思考，真相。',rv:'冷酷，過於理性。'},
  {id:63,n:'寶劍國王',el:'風',up:'理性權威，公正判斷。',rv:'獨裁，冷酷無情。'},
  // 金幣
  {id:64,n:'金幣王牌',el:'土',up:'新財務機會，物質豐盛。',rv:'錯失良機，貪婪。'},
  {id:65,n:'金幣二',el:'土',up:'平衡，適應變化。',rv:'失衡，優先順序混亂。'},
  {id:66,n:'金幣三',el:'土',up:'團隊合作，技能提升。',rv:'缺乏協作，品質不佳。'},
  {id:67,n:'金幣四',el:'土',up:'守財，安全感。',rv:'過度吝嗇，恐懼失去。'},
  {id:68,n:'金幣五',el:'土',up:'困難時期，物質匱乏。',rv:'走出困境，援助到來。'},
  {id:69,n:'金幣六',el:'土',up:'慷慨，施與受的平衡。',rv:'債務，單方面付出。'},
  {id:70,n:'金幣七',el:'土',up:'耐心等待收穫。',rv:'急躁，缺乏耐心。'},
  {id:71,n:'金幣八',el:'土',up:'精進技藝，專注投入。',rv:'缺乏熱情，敷衍了事。'},
  {id:72,n:'金幣九',el:'土',up:'豐收，自給自足。',rv:'過度自足，財務風險。'},
  {id:73,n:'金幣十',el:'土',up:'家族財富，長久穩定。',rv:'家庭財務問題。'},
  {id:74,n:'金幣侍者',el:'土',up:'學習機會，務實目標。',rv:'缺乏方向，浪費資源。'},
  {id:75,n:'金幣騎士',el:'土',up:'穩健前進，有效率。',rv:'固執，過度保守。'},
  {id:76,n:'金幣皇后',el:'土',up:'富足，安全，實際。',rv:'不安全感，過度物質。'},
  {id:77,n:'金幣國王',el:'土',up:'財務成功，領導力。',rv:'貪婪，過度控制。'}
];

const CELTIC_POS=['核心現狀','阻礙因素','過去基礎','未來發展','可能結果','近期未來','自我態度','環境影響','希望恐懼','最終結果'];

let drawnCards=[];
function drawCard(){
  if(drawnCards.length>=10)return;
  const avail=TAROT.filter(c=>!drawnCards.find(d=>d.id===c.id));
  const card=avail[Math.floor(Math.random()*avail.length)];
  const isUp=Math.random()>0.35;
  drawnCards.push({...card,isUp,pos:CELTIC_POS[drawnCards.length]});
  renderDrawn();
  if(drawnCards.length>=10){
    document.getElementById('btn-draw').disabled=true;
    document.getElementById('btn-analyze').disabled=false;
    showSpread();
  }
}
function autoDraw(){while(drawnCards.length<10)drawCard()}

function renderDrawn(){
  const el=document.getElementById('t-hand');
  document.getElementById('t-remain').textContent=10-drawnCards.length;
  el.innerHTML=drawnCards.map((c,i)=>{
    const imgSrc=typeof getTarotCardImage==='function'?getTarotCardImage(c):'';
    return `
    <div class="t-card flipped" title="${c.n}">
      <div class="t-card-inner">
        <div class="t-card-face t-back"></div>
        <div class="t-card-face t-front ${c.isUp?'':''}">
          ${imgSrc?`<img src="${imgSrc}" alt="${c.n}" class="tc-img" style="${c.isUp?'':'transform:rotate(180deg)'}">`:``}
          <span class="tc-name" style="${c.isUp?'':'transform:rotate(180deg)'}">${c.n}</span>
          <span class="tc-dir">${c.isUp?'正位':'逆位'}</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

function showSpread(){
  S.tarot.drawn=drawnCards;
  S.tarot.spread=drawnCards;
  document.getElementById('t-spread-sec').classList.remove('hidden');
  const el=document.getElementById('t-spread');
  el.innerHTML=drawnCards.map((c,i)=>{
    const imgSrc=typeof getTarotCardImage==='function'?getTarotCardImage(c):'';
    return `
    <div class="card" style="padding:var(--sp-md);margin-bottom:var(--sp-sm)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-xs)">
        <span class="tag tag-gold">${i+1}. ${c.pos}</span>
        <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'正位':'逆位'}</span>
      </div>
      <div style="display:flex;gap:var(--sp-md);align-items:flex-start">
        ${imgSrc?`<img src="${imgSrc}" alt="${c.n}" class="tc-spread-img" style="width:72px;height:112px;border-radius:6px;flex-shrink:0;${c.isUp?'':'transform:rotate(180deg)'}">`:``}
        <div>
          <strong class="text-gold serif">${c.n}</strong>
          <p class="text-sm text-dim mt-sm">${c.isUp?c.up:c.rv}</p>
        </div>
      </div>
    </div>`;
  }).join('');
}
/* =============================================================
   RENDER FUNCTIONS — 結果頁渲染
   ============================================================= */
function showDim(id){
  const map={bazi:'八字',ziwei:'紫微',meihua:'梅花',tarot:'塔羅',name:'姓名'};
  document.querySelectorAll('.dim-tab').forEach(t=>{
    const match=Object.entries(map).find(([k,v])=>t.textContent.includes(v));
    t.classList.toggle('active',match&&match[0]===id);
  });
  document.querySelectorAll('.dim-pane').forEach(p=>p.classList.toggle('active',p.id==='pane-'+id));
}

function renderBazi(){
  const b=S.bazi; if(!b)return;
  const p=b.pillars;
  const labels=['時柱','日柱','月柱','年柱'];
  const cols=['hour','day','month','year'];

  // 四柱表格
  let html='<div class="bazi-grid">';
  html+=cols.map((_,i)=>`<div class="bazi-cell header">${labels[i]}</div>`).join('');
  // 天干行
  html+=cols.map(c=>{
    const g=p[c].gan;
    return`<div class="bazi-cell"><span class="gz">${g}</span><span class="el-tag el-${WX_G[g]}">${WX_G[g]}</span><div class="gz-sub">${c==='day'?'日主':b.gods[c].gan}</div></div>`;
  }).join('');
  // 地支行
  html+=cols.map(c=>{
    const z=p[c].zhi;
    return`<div class="bazi-cell"><span class="gz">${z}</span><span class="el-tag el-${WX_Z[z]}">${WX_Z[z]}</span><div class="gz-sub">${b.cs[c]}</div></div>`;
  }).join('');
  // 藏干行
  html+=cols.map(c=>{
    const cg=b.cangGan[c]||[];
    return`<div class="bazi-cell"><div class="gz-sub">藏干</div>${cg.map(g=>`<span class="el-tag el-${WX_G[g]}" style="margin:1px">${g}</span>`).join('')}</div>`;
  }).join('');
  html+='</div>';

  // 納音
  html+=`<p class="text-sm text-dim mt-sm">納音：${b.nayin} ｜ 身${b.strong?'<span class="text-success">強</span>':'<span class="text-danger">弱</span>'} ｜ 日主：${b.dm}（${b.dmEl}）</p>`;
  document.getElementById('d-bazi').innerHTML=html;

  // 五行柱狀圖
  const els=['金','木','水','火','土'];
  const colors={金:'var(--el-metal)',木:'var(--el-wood)',水:'var(--el-water)',火:'var(--el-fire)',土:'var(--el-earth)'};
  document.getElementById('d-elbar').innerHTML='<div class="el-bar">'+els.map(e=>`
    <div class="el-row"><span class="el-lbl" style="color:${colors[e]}">${e}</span>
    <div class="el-track"><div class="el-fill" style="width:${b.ep[e]}%;background:${colors[e]}"></div></div>
    <span class="el-val">${b.ep[e]}%</span></div>`).join('')+'</div>';

  // 十神
  document.getElementById('d-gods').innerHTML=`
    <div class="bazi-grid" style="margin:0">
      ${cols.map((_,i)=>`<div class="bazi-cell header">${labels[i]}</div>`).join('')}
      ${cols.map(c=>`<div class="bazi-cell"><strong>${b.gods[c].gan}</strong></div>`).join('')}
      ${cols.map(c=>`<div class="bazi-cell">${(b.gods[c].zhi||[]).join('<br>')}</div>`).join('')}
    </div>`;

  // 藏干
  document.getElementById('d-canggan').innerHTML=cols.map(c=>{
    const cg=b.cangGan[c]||[];
    return`<p><strong>${labels[cols.indexOf(c)]}（${p[c].zhi}）：</strong>${cg.map(g=>`${g}(${WX_G[g]}/${tenGod(b.dm,g)})`).join('、')||'—'}</p>`;
  }).join('');

  // 喜用忌神 + 神煞
  document.getElementById('d-xiyong').innerHTML=`
    <p><strong>喜用神：</strong>${b.fav.map(e=>`<span class="tag tag-green">${e}</span>`).join(' ')}</p>
    <p class="mt-sm"><strong>忌　神：</strong>${b.unfav.map(e=>`<span class="tag tag-red">${e}</span>`).join(' ')}</p>
    ${b.shensha.length?`<p class="mt-sm"><strong>神　煞：</strong>${b.shensha.map(s=>`<span class="tag tag-gold">${s}</span>`).join(' ')}</p>`:''}`;

  // 大運
  document.getElementById('d-dayun').innerHTML='<div class="dayun-tl">'+b.dayun.map(d=>{
    const lvClass=d.level==='大吉'?'lv-dj':d.level==='中吉'?'lv-zj':d.level==='小吉'?'lv-xj':d.level==='平'?'lv-p':d.level==='小凶'?'lv-xk':d.level==='中凶'?'lv-zk':'lv-dk';
    return`<div class="dy-item ${d.isCurrent?'current':''}">
      <span class="dy-gz">${d.gz}</span><span class="dy-age">${d.ageStart}-${d.ageEnd}歲</span>
      <span class="dy-lv ${lvClass}">${d.level}</span><div class="gz-sub">${d.god}</div></div>`;
  }).join('')+'</div>';
}

function renderMeihua(){
  if(!S.meihua){document.getElementById('r-meihua').innerHTML='<p class="text-dim">未進行梅花易數起卦</p>';return}
  const r=S.meihua;
  document.getElementById('r-meihua').innerHTML=`
    <div class="hex-grid">
      <div class="hex-card"><h4>本卦</h4><div class="hex-sym">${r.ben.u}</div><div class="hex-name">${r.ben.n}</div></div>
      <div class="hex-card"><h4>互卦</h4><div class="hex-sym">${r.hu.u}</div><div class="hex-name">${r.hu.n}</div></div>
      <div class="hex-card"><h4>變卦</h4><div class="hex-sym">${r.bian.u}</div><div class="hex-name">${r.bian.n}</div></div>
    </div>
    <p class="mt-md"><strong>體用：</strong><span class="tag tag-gold">${r.ty.r}</span> <span class="tag ${r.ty.f.includes('吉')?'tag-green':'tag-red'}">${r.ty.f}</span> — ${r.ty.d}</p>
    <p class="mt-sm"><strong>卦辭：</strong>${r.ben.j}</p>
    <p><strong>解讀：</strong>${r.ben.m}</p>
    <p><strong>變卦：</strong>${r.bian.m}</p>`;
}

function renderTarot(){
  if(!S.tarot.drawn.length){document.getElementById('r-tarot').innerHTML='<p class="text-dim">未進行塔羅抽牌</p>';return}
  document.getElementById('r-tarot').innerHTML=S.tarot.drawn.map((c,i)=>{
    const imgSrc=typeof getTarotCardImage==='function'?getTarotCardImage(c):'';
    return `
    <div style="display:flex;gap:var(--sp-md);align-items:flex-start;padding:var(--sp-sm) 0;border-bottom:1px solid var(--c-border)">
      <span class="tag tag-gold" style="flex:0 0 auto">${i+1}</span>
      ${imgSrc?`<img src="${imgSrc}" alt="${c.n}" style="width:56px;height:88px;border-radius:4px;flex-shrink:0;border:1px solid rgba(212,175,55,0.3);${c.isUp?'':'transform:rotate(180deg)'}">`:``}
      <div><strong class="text-gold">${c.pos}</strong>：${c.n} <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'正':'逆'}</span>
      <p class="text-sm text-dim">${c.isUp?c.up:c.rv}</p></div>
    </div>`;
  }).join('');
}

/* =============================================================
   ANALYSIS ENGINE — 綜合評分
   ============================================================= */
function _runAnalysisV1_unused(){
  renderBazi(); renderMeihua(); renderTarot();

  const b=S.bazi; if(!b)return;
  const type=S.form.type;
  const question=S.form.question;

  // — 八字評分 (0-100) —
  let baziScore=50;
  // 身強+有財官 = 高分；身弱+有印比 = 中分
  if(b.strong){
    if(b.ep[KE[b.dmEl]]>15)baziScore+=15; // 有財
    if(b.ep[BE_KE[b.dmEl]]>10)baziScore+=10; // 有官
  }else{
    if(b.ep[BE_SHENG[b.dmEl]]>15)baziScore+=15; // 有印
    if(b.ep[b.dmEl]>15)baziScore+=10;
  }
  // 當前大運加分
  const curDy=b.dayun.find(d=>d.isCurrent);
  if(curDy){
    if(curDy.level.includes('吉'))baziScore+=10;
    if(curDy.level.includes('凶'))baziScore-=10;
  }
  // 神煞
  if(b.shensha.includes('天乙貴人'))baziScore+=5;
  if(b.shensha.includes('文昌'))baziScore+=3;
  baziScore=Math.max(10,Math.min(90,baziScore));

  // — 梅花評分 —
  let mhScore=50;
  if(S.meihua){
    const f=S.meihua.ty.f;
    if(f==='大吉')mhScore=80;
    else if(f==='吉')mhScore=70;
    else if(f==='小吉')mhScore=60;
    else if(f==='小凶')mhScore=35;
    else if(f==='凶')mhScore=20;
  }

  // — 塔羅評分 —
  let tarotScore=50;
  if(S.tarot.drawn.length){
    let pos=0,neg=0;
    S.tarot.drawn.forEach(c=>{
      // 正位的正面牌 +1，逆位的負面牌 -1
      const goodCards=[0,1,3,6,8,10,14,17,19,21];
      const badCards=[13,15,16,18];
      if(c.isUp&&goodCards.includes(c.id))pos++;
      if(!c.isUp&&badCards.includes(c.id))neg++;
      if(c.isUp&&!badCards.includes(c.id))pos+=0.5;
      if(!c.isUp)neg+=0.3;
    });
    tarotScore=Math.round(50+pos*5-neg*5);
    tarotScore=Math.max(10,Math.min(90,tarotScore));
  }

  // — 綜合 —
  const weights={bazi:0.4,meihua:S.meihua?0.3:0,tarot:S.tarot.drawn.length?0.3:0};
  const totalW=weights.bazi+weights.meihua+weights.tarot;
  const finalProb=Math.round((baziScore*weights.bazi+mhScore*weights.meihua+tarotScore*weights.tarot)/totalW);

  // Verdict
  let vlabel,vnote;
  if(finalProb>=70){vlabel='偏向可行 ✅';vnote='多維度指標偏一致，適合推進，但仍需按建議控風險。'}
  else if(finalProb>=45){vlabel='中性偏可行 ⚖️';vnote='有利與阻力並存；照建議調整做法，勝率會上升。'}
  else if(finalProb>=25){vlabel='偏保守 ⚠️';vnote='阻力訊號較多，建議先降低成本/試水溫，再談放大。'}
  else{vlabel='不建議硬推 ⛔';vnote='目前象徵偏逆風；若要做，務必設停損與替代方案。'}

  document.getElementById('r-vlabel').textContent=vlabel;
  document.getElementById('r-vprob').textContent=finalProb+'%';
  document.getElementById('r-vnote').textContent=vnote;
  document.getElementById('r-pfill').style.width=finalProb+'%';
  document.getElementById('r-question').innerHTML=`<strong>問題：</strong>${question}<br><span class="tag tag-gold">${getTypeLabel(type)}</span>`;

  // Direct answer
  const answer=generateAnswer(type,finalProb,b,S.meihua,S.tarot);
  document.getElementById('r-answer').innerHTML=answer.text;
  document.getElementById('r-factors').innerHTML=answer.factors?`<h4 class="text-gold serif mt-md mb-sm">影響因子</h4><ul class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.factors.map(f=>'<li style="margin:.3rem 0">'+f+'</li>').join('')}</ul>`:'';
  document.getElementById('r-suggest').innerHTML=answer.suggestions?`<h4 class="text-gold serif mt-md mb-sm">行動建議</h4><ol class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.suggestions.map(s=>'<li style="margin:.3rem 0">'+s+'</li>').join('')}</ol>`:'';

  // Probability breakdown
  document.getElementById('r-pbreak').innerHTML=`
    <p>八字命理：${baziScore}% (權重${Math.round(weights.bazi/totalW*100)}%)</p>
    ${S.meihua?`<p>梅花易數：${mhScore}% (權重${Math.round(weights.meihua/totalW*100)}%)</p>`:''}
    ${S.tarot.drawn.length?`<p>塔羅牌陣：${tarotScore}% (權重${Math.round(weights.tarot/totalW*100)}%)</p>`:''}`;

  // Crystal recommendation
  renderCrystal(b);

  // Conclusion
  document.getElementById('r-conclusion').innerHTML=generateConclusion(type,finalProb,b,S.meihua,S.tarot);
}

function getTypeLabel(t){return{love:'愛情',career:'事業',wealth:'財運',health:'健康',general:'綜合運勢',relationship:'人際',family:'家庭',other:'其他'}[t]||t}

function generateAnswer(type,prob,bazi,mh,tarot){
  const dm=bazi.dm,el=bazi.dmEl,strong=bazi.strong;
  const curDy=bazi.dayun.find(d=>d.isCurrent);
  const fav=bazi.fav||[];
  const unfav=bazi.unfav||[];

  /* ═══ FACTORS: 逐維度列出具體發現 ═══ */
  const factors=[];

  // ── 八字因子 ──
  let baziFactor=`日主${dm}（${el}行），身${strong?'強':'弱'}`;
  if(fav.length) baziFactor+=`，喜用${fav.join('、')}`;
  if(unfav.length) baziFactor+=`，忌${unfav.join('、')}`;
  factors.push('【八字】'+baziFactor);

  if(curDy){
    let dyDetail=`當前大運 ${curDy.gz}（${curDy.level}）`;
    if(curDy.level.includes('吉')) dyDetail+='→ 運勢有外在助力';
    else if(curDy.level.includes('凶')) dyDetail+='→ 運勢阻力偏大，宜守不宜攻';
    else dyDetail+='→ 運勢平穩，不特別助力也不阻礙';
    factors.push('【大運】'+dyDetail);
  }

  if(bazi.shensha&&bazi.shensha.length){
    const good=['天乙貴人','文昌','桃花','天德','月德','驛馬','將星'];
    const bad=['羊刃','亡神','劫煞','華蓋'];
    const g=bazi.shensha.filter(s=>good.includes(s));
    const b2=bazi.shensha.filter(s=>bad.includes(s));
    let shText='神煞中';
    if(g.length) shText+=`有${g.join('、')}助力`;
    if(b2.length) shText+=(g.length?'，但':'')+ `${b2.join('、')}需注意`;
    if(!g.length&&!b2.length) shText='神煞：'+bazi.shensha.join('、');
    factors.push('【神煞】'+shText);
  }

  // ── 梅花因子 ──
  if(mh){
    let mhText=`本卦 ${mh.ben.n}，變卦 ${mh.bian.n}，體用${mh.ty.r}（${mh.ty.f}）`;
    if(mh.ty.d) mhText+=' — '+mh.ty.d;
    factors.push('【梅花】'+mhText);
  }

  // ── 塔羅因子（逐位置解讀重點牌） ──
  if(tarot.drawn.length>=10){
    const posNames=['核心現狀','阻礙因素','過去基礎','未來發展','可能結果','近期未來','自我態度','環境影響','希望恐懼','最終結果'];
    const keyPos=[0,1,3,4,9]; // 核心、阻礙、未來、可能結果、最終
    keyPos.forEach(i=>{
      const c=tarot.drawn[i];
      if(!c)return;
      const dir=c.isUp?'正位':'逆位';
      const meaning=c.isUp?c.up:c.rv;
      factors.push(`【塔羅·${posNames[i]}】${c.n}（${dir}）→ ${meaning}`);
    });
  }

  // ── 紫微因子 ──
  if(S.ziwei){
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
    const gongIdx=typeToGong[type]!==undefined?typeToGong[type]:0;
    const gongName=typeof ZW_PALACES!=='undefined'?ZW_PALACES[gongIdx]:'命宮';
    const gongStars=S.ziwei.palaces[gongIdx]?S.ziwei.palaces[gongIdx].stars:[];
    if(gongStars.length){
      const starInfo=gongStars.map(s=>{
        let t=s.name;
        if(s.bright) t+=`(${s.bright})`;
        if(s.hua) t+=` ${s.hua}`;
        return t;
      }).join('、');
      factors.push(`【紫微·${gongName}】${starInfo}`);
    }
  }

  // ── 姓名因子 ──
  if(S.nameResult){
    const nr=S.nameResult;
    let nText=`三才配置 ${nr.sanCaiLevel}`;
    if(nr.renGe) nText+=`，人格 ${nr.renGe.strokes}畫（${nr.renGe.fortune.level}）`;
    factors.push('【姓名】'+nText);
  }

  /* ═══ SUGGESTIONS: 依維度×類型 生成具體建議 ═══ */
  const suggestions=[];

  // 八字建議
  if(strong){
    suggestions.push(`八字身強，宜「洩秀生財」：多發揮${typeof SHENG!=='undefined'?SHENG[el]:''}行能量，透過輸出（創作、教學、投資）引導力量`);
  }else{
    suggestions.push(`八字身弱，宜「扶助印比」：加強${el}行與${typeof BE_SHENG!=='undefined'?BE_SHENG[el]:''}行能量，選擇穩定環境發展`);
  }

  // 塔羅建議（根據最終結果牌）
  if(tarot.drawn.length>=10){
    const finalCard=tarot.drawn[9];
    const obstCard=tarot.drawn[1];
    if(finalCard){
      const fMeaning=finalCard.isUp?finalCard.up:finalCard.rv;
      suggestions.push(`塔羅最終牌「${finalCard.n}」${finalCard.isUp?'正位':'逆位'}，提示方向：${fMeaning}`);
    }
    if(obstCard){
      const oMeaning=obstCard.isUp?obstCard.up:obstCard.rv;
      suggestions.push(`需注意阻礙因素「${obstCard.n}」${obstCard.isUp?'正位':'逆位'}：${oMeaning}`);
    }
  }

  // 類型專屬建議
  const typeAdvice={
    love:{
      strong:'感情上你容易主導，但對方需要被尊重的空間，適度放軟身段',
      weak:'感情上你較被動，試著主動表達需求，貴人會在社交場合出現',
      peach:'命帶桃花，異性緣佳但需慎選對象，不宜同時曖昧多人',
      noPeach:'可往正東或正南方向社交，或佩戴粉晶增強桃花磁場'
    },
    career:{
      strong:'事業上你有領導力，適合獨立負責或創業，食傷生財路線佳',
      weak:'事業上宜依附大平台或跟隨有能力的主管，印星助力是關鍵',
      wenChang:'文昌入命，利考試進修、文書工作、學術研究方向',
      yiMa:'驛馬星動，利外出、出差、跨區域發展'
    },
    wealth:{
      caiWang:'命中財星旺，偏財運佳，可適度參與投資但設好停損',
      caiRuo:'命中財星偏弱，宜穩健理財、定期儲蓄，不宜高風險操作',
      strong:'身強能扛財，可積極追求財富，但需避免貪多',
      weak:'身弱難扛財，財來財去，宜保守理財、量力而為'
    },
    health:{
      advice:'五行缺'+fav[0]+'，可從飲食（'+{金:'白色食物/辛味',木:'綠色蔬菜/酸味',水:'黑色食物/鹹味',火:'紅色食物/苦味',土:'黃色食物/甘味'}[fav[0]||'土']+'）補充'
    }
  };

  if(type==='love'){
    suggestions.push(typeAdvice.love[strong?'strong':'weak']);
    suggestions.push(bazi.shensha&&bazi.shensha.includes('桃花')?typeAdvice.love.peach:typeAdvice.love.noPeach);
  } else if(type==='career'){
    suggestions.push(typeAdvice.career[strong?'strong':'weak']);
    if(bazi.shensha&&bazi.shensha.includes('文昌'))suggestions.push(typeAdvice.career.wenChang);
    if(bazi.shensha&&bazi.shensha.includes('驛馬'))suggestions.push(typeAdvice.career.yiMa);
  } else if(type==='wealth'){
    const caiEl=typeof KE!=='undefined'?KE[el]:'';
    suggestions.push(typeAdvice.wealth[strong?'strong':'weak']);
    suggestions.push(bazi.ep&&caiEl&&bazi.ep[caiEl]>15?typeAdvice.wealth.caiWang:typeAdvice.wealth.caiRuo);
  } else if(type==='health'){
    suggestions.push(typeAdvice.health.advice);
  }

  /* ═══ TEXT: 主要回答段落 ═══ */
  let text='';

  // 開頭：八字定調
  text+=`<p>`;
  text+=`<strong>日主「${dm}」五行屬${el}，身${strong?'強':'弱'}</strong>，`;
  if(curDy){
    text+=`目前走 ${curDy.gz} 大運（${curDy.level}），`;
    if(curDy.level.includes('大吉')) text+='運勢正處於最佳時期，外在環境有力支持。';
    else if(curDy.level.includes('中吉')) text+='運勢偏好，有貴人助力。';
    else if(curDy.level.includes('小吉')) text+='運勢小吉，穩中有進。';
    else if(curDy.level.includes('凶')) text+='大運帶阻力，做事需更加謹慎。';
    else text+='運勢平穩。';
  }
  text+=`</p>`;

  // 中段：梅花判斷
  if(mh){
    text+=`<p class="mt-sm"><strong>梅花易數</strong>得本卦「${mh.ben.n}」，變卦「${mh.bian.n}」，`;
    text+=`體用關係為 <span class="tag tag-gold">${mh.ty.r}</span>（${mh.ty.f}）。`;
    if(mh.ty.d) text+=mh.ty.d;
    text+=`</p>`;
  }

  // 塔羅詳細敘述
  if(tarot.drawn.length>=10){
    const core=tarot.drawn[0],obst=tarot.drawn[1],future=tarot.drawn[3],outcome=tarot.drawn[4],final=tarot.drawn[9];
    text+=`<p class="mt-sm"><strong>塔羅十張牌解讀：</strong>`;
    text+=`核心牌「${core.n}」${core.isUp?'正位':'逆位'}，表示${core.isUp?core.up:core.rv}`;
    text+=`；阻礙位「${obst.n}」${obst.isUp?'正位':'逆位'}，暗示${obst.isUp?obst.up:obst.rv}`;
    text+=`。未來走向看「${future.n}」${future.isUp?'正位':'逆位'}（${future.isUp?future.up:future.rv}）`;
    text+=`，最終結果牌「${final.n}」${final.isUp?'正位':'逆位'}，`;
    text+=final.isUp?`這是一張正面的結局牌：${final.up}`:`結局牌為逆位，提醒：${final.rv}`;
    text+=`</p>`;

    // 正逆位統計
    const upCount=tarot.drawn.filter(c=>c.isUp).length;
    text+=`<p class="mt-sm text-sm text-dim">十張牌中 ${upCount} 張正位、${10-upCount} 張逆位，`;
    if(upCount>=7) text+='牌面整體偏正面積極。';
    else if(upCount>=5) text+='正逆參半，事情有發展空間但需留意障礙。';
    else text+='逆位偏多，目前阻力較大，建議調整策略。';
    text+=`</p>`;
  }

  // 紫微斗數
  if(S.ziwei){
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
    const gongIdx=typeToGong[type]!==undefined?typeToGong[type]:0;
    const gongName=typeof ZW_PALACES!=='undefined'?ZW_PALACES[gongIdx]:'命宮';
    const gongStars=S.ziwei.palaces[gongIdx]?S.ziwei.palaces[gongIdx].stars:[];
    if(gongStars.length){
      text+=`<p class="mt-sm"><strong>紫微斗數·${gongName}</strong>中有：`;
      text+=gongStars.map(s=>{
        let t=s.name;
        if(s.bright) t+=`（${s.bright}）`;
        if(s.hua) t+=` ${s.hua}`;
        return t;
      }).join('、');
      const hasLu=gongStars.some(s=>s.hua==='化祿');
      const hasJi=gongStars.some(s=>s.hua==='化忌');
      if(hasLu) text+='。化祿入此宮，此方面有福氣加持。';
      else if(hasJi) text+='。化忌入此宮，此方面需格外留心。';
      else text+='。';
      text+=`</p>`;
    }
  }

  // 綜合結論
  text+=`<div class="divider"></div>`;
  if(prob>=70){
    text+=`<p class="serif"><strong class="text-success">綜合判斷：偏向可行</strong>。五個維度多數指向正面，`;
    text+=`八字${curDy&&curDy.level.includes('吉')?'大運助力':'底盤穩定'}，`;
    if(mh) text+=`梅花${mh.ty.f.includes('吉')?'體用相生':'卦象不差'}，`;
    if(tarot.drawn.length>=10){
      const upC=tarot.drawn.filter(c=>c.isUp).length;
      text+=`塔羅${upC}張正位${upC>=6?'偏積極':''}，`;
    }
    text+=`建議把握時機、積極行動。</p>`;
  } else if(prob>=45){
    text+=`<p class="serif"><strong class="text-warn">綜合判斷：利弊並存</strong>。各維度訊號不完全一致，`;
    text+=`有發展空間但存在具體障礙（見上方因子），建議分階段推進、設好退路。</p>`;
  } else if(prob>=25){
    text+=`<p class="serif"><strong class="text-danger">綜合判斷：阻力偏大</strong>。多數維度出現警訊，`;
    text+=`目前時機偏不利，建議先做準備、降低投入，等待更好的時機窗口。</p>`;
  } else {
    text+=`<p class="serif"><strong class="text-danger">綜合判斷：強烈建議暫緩</strong>。五個維度幾乎一致指向逆風，`;
    text+=`硬推風險極高，請務必設停損並考慮替代方案。</p>`;
  }

  return{text,factors,suggestions};
}

function renderCrystal(b){
  const CRYSTALS={
    金:[{n:'白水晶',icon:'💎',d:'淨化能量，增強思維清晰度'},{n:'黃鐵礦',icon:'✨',d:'增強財運，提升自信'}],
    木:[{n:'綠幽靈',icon:'💚',d:'招正財，事業穩步上升'},{n:'東陵玉',icon:'🌿',d:'舒緩壓力，帶來好運'}],
    水:[{n:'海藍寶',icon:'💙',d:'增強溝通力，平靜情緒'},{n:'藍紋瑪瑙',icon:'🔵',d:'穩定情緒，增強表達'}],
    火:[{n:'紅瑪瑙',icon:'❤️',d:'激發熱情，增強行動力'},{n:'石榴石',icon:'🔴',d:'提升活力，增強意志'}],
    土:[{n:'黃水晶',icon:'💛',d:'招偏財，提升自信'},{n:'虎眼石',icon:'🟤',d:'增強決斷力，招財辟邪'}]
  };
  const need=b.fav[0];
  const recs=CRYSTALS[need]||CRYSTALS['土'];
  document.getElementById('r-crystal').innerHTML=`
    <p class="mb-md">根據命盤分析，建議補強 <span class="tag tag-gold">${need}行</span> 能量：</p>
    <div class="crystal-grid">${recs.map(c=>`
      <div class="crystal-card">
        <div class="crystal-icon">${c.icon}</div>
        <div class="crystal-name">${c.n}</div>
        <p class="text-sm text-dim">${c.d}</p>
      </div>`).join('')}</div>
    <p class="text-xs text-muted mt-md"><i class="fas fa-info-circle"></i> 本建議僅供能量校準參考，不具醫療或命運保證效力。</p>`;
}

function generateConclusion(type,prob,bazi,mh,tarot){
  const el=bazi.dmEl,strong=bazi.strong,dm=bazi.dm;
  const curDy=bazi.dayun.find(d=>d.isCurrent);
  const fav=bazi.fav||[];
  const typeLabel={'love':'愛情','career':'事業','wealth':'財運','health':'健康','general':'綜合運勢','relationship':'人際','family':'家庭','other':'所問之事'}[type]||'所問之事';

  let html='';

  // 八字總結
  html+=`<p><strong class="text-gold">一、八字命理</strong>：「${dm}${bazi.pillars?bazi.pillars.day.zhi:''}」日主，${el}行，身${strong?'強':'弱'}。`;
  if(fav.length) html+=`喜用${fav.join('、')}行。`;
  if(curDy){
    html+=`目前走 ${curDy.gz} 大運（${curDy.level}），`;
    if(curDy.level.includes('大吉')) html+=`這步大運是你最好的運勢週期，問${typeLabel}正是好時機。`;
    else if(curDy.level.includes('吉')) html+=`運勢偏好，${typeLabel}方面有外在助力。`;
    else if(curDy.level.includes('凶')) html+=`運勢帶阻力，${typeLabel}方面需要比平常更謹慎。`;
    else html+=`運勢平穩，${typeLabel}方面不會有大起大落。`;
  }
  html+=`</p>`;

  // 紫微總結
  if(S.ziwei){
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
    const gongIdx=typeToGong[type]!==undefined?typeToGong[type]:0;
    const gongName=typeof ZW_PALACES!=='undefined'?ZW_PALACES[gongIdx]:'命宮';
    const gongStars=S.ziwei.palaces[gongIdx]?S.ziwei.palaces[gongIdx].stars:[];
    if(gongStars.length){
      html+=`<p class="mt-sm"><strong class="text-gold">二、紫微斗數</strong>：${gongName}有 `;
      html+=gongStars.slice(0,4).map(s=>s.name+(s.bright?`(${s.bright})`:'')+(s.hua?` ${s.hua}`:'')).join('、');
      const hasLu=gongStars.some(s=>s.hua==='化祿');
      const hasJi=gongStars.some(s=>s.hua==='化忌');
      if(hasLu) html+=`。化祿入${gongName}，${typeLabel}有先天福氣。`;
      else if(hasJi) html+=`。化忌入${gongName}，${typeLabel}方面需多花心力。`;
      else html+=`。`;
      html+=`</p>`;
    }
  }

  // 梅花總結
  if(mh){
    html+=`<p class="mt-sm"><strong class="text-gold">三、梅花易數</strong>：本卦「${mh.ben.n}」→ 變卦「${mh.bian.n}」。`;
    html+=`體用 ${mh.ty.r}，判為「${mh.ty.f}」。`;
    if(mh.ben.m) html+=mh.ben.m;
    html+=`</p>`;
  }

  // 塔羅詳細總結
  if(tarot.drawn.length>=10){
    const posNames=['核心現狀','阻礙因素','過去基礎','未來發展','可能結果','近期未來','自我態度','環境影響','希望恐懼','最終結果'];
    html+=`<p class="mt-sm"><strong class="text-gold">四、塔羅牌陣（凱爾特十字）</strong>：</p>`;
    html+=`<div style="font-size:0.9rem;line-height:1.7;margin:0.5rem 0">`;
    tarot.drawn.forEach((c,i)=>{
      const dir=c.isUp?'正位':'逆位';
      const meaning=c.isUp?c.up:c.rv;
      const isKey=[0,1,3,4,9].includes(i);
      html+=`<p style="margin:0.25rem 0;${isKey?'font-weight:600':'opacity:0.85'}">`;
      html+=`<span class="tag ${c.isUp?'tag-blue':'tag-red'}" style="font-size:0.75rem">${dir}</span> `;
      html+=`<strong>${i+1}.${posNames[i]}</strong>：${c.n} — ${meaning}`;
      html+=`</p>`;
    });
    html+=`</div>`;
    const upCount=tarot.drawn.filter(c=>c.isUp).length;
    html+=`<p class="text-sm text-dim">正位 ${upCount} 張 / 逆位 ${10-upCount} 張，`;
    if(upCount>=7) html+=`牌面整體正向，${typeLabel}前景看好。`;
    else if(upCount>=5) html+=`正逆參半，有機會但需克服障礙。`;
    else html+=`逆位偏多，目前不是最佳時機。`;
    html+=`</p>`;
  }

  // 姓名學
  if(S.nameResult){
    const nr=S.nameResult;
    html+=`<p class="mt-sm"><strong class="text-gold">五、姓名學</strong>：三才 ${nr.sanCaiLevel}`;
    if(nr.renGe) html+=`，人格 ${nr.renGe.strokes}畫（${nr.renGe.fortune.level}）`;
    if(nr.zongGe) html+=`，總格 ${nr.zongGe.strokes}畫（${nr.zongGe.fortune.level}）`;
    html+=`。</p>`;
  }

  // 最終金句
  html+=`<div class="divider"></div>`;
  const goldAdvice = prob>=70
    ? `五維度多數偏正面，${typeLabel}方面時機不錯。建議積極但有節制地行動，搭配${fav[0]||'土'}行能量輔助。`
    : prob>=45
    ? `各維度訊號不一致，${typeLabel}有空間但也有障礙。建議分步驟推進，先做小範圍測試。`
    : prob>=25
    ? `多數維度出現警訊，${typeLabel}目前阻力偏大。建議先做充分準備，等待更好時機再全力投入。`
    : `五維度幾乎一致指向困難期。${typeLabel}方面強烈建議暫緩，先穩住現有基礎。`;
  html+=`<p class="serif text-gold" style="font-size:1.05rem"><i class="fas fa-star"></i> ${goldAdvice}</p>`;

  return html;
}
/* =============================================================
   紫微斗數 ZIWEI DOUSHU — 核心邏輯（自寫，不依賴 iztro）
   ============================================================= */
const ZW_PALACES=['命宮','兄弟','夫妻','子女','財帛','疾厄','遷移','交友','官祿','田宅','福德','父母'];

// 14 主星
const ZW_MAJOR=[
  {id:0,name:'紫微',el:'土',yin:true,bright:['廟','旺','得地','利','平','不得','落陷'],nature:'帝星，尊貴，領導力'},
  {id:1,name:'天機',el:'木',yin:true,nature:'智慧，策劃，善變'},
  {id:2,name:'太陽',el:'火',yin:false,nature:'光明正大，貴人，男性'},
  {id:3,name:'武曲',el:'金',yin:false,nature:'財星，剛毅，果斷'},
  {id:4,name:'天同',el:'水',yin:true,nature:'福星，安逸，溫和'},
  {id:5,name:'廉貞',el:'火',yin:false,nature:'囚星，桃花，複雜'},
  {id:6,name:'天府',el:'土',yin:true,nature:'財庫，穩重，保守'},
  {id:7,name:'太陰',el:'水',yin:true,nature:'財星，女性，細膩'},
  {id:8,name:'貪狼',el:'木',yin:false,nature:'桃花，才藝，慾望'},
  {id:9,name:'巨門',el:'水',yin:true,nature:'口舌，暗星，是非'},
  {id:10,name:'天相',el:'水',yin:true,nature:'印星，輔佐，衣食'},
  {id:11,name:'天梁',el:'土',yin:true,nature:'蔭星，清高，化解'},
  {id:12,name:'七殺',el:'金',yin:false,nature:'將星，衝勁，變動'},
  {id:13,name:'破軍',el:'水',yin:false,nature:'耗星，開創，破壞'}
];

// 6 吉星
const ZW_LUCKY=['文昌','文曲','左輔','右弼','天魁','天鉞'];
// 4 煞星
const ZW_SHA=['擎羊','陀羅','火星','鈴星'];
// 4 化
const ZW_HUA=['化祿','化權','化科','化忌'];

// 四化表 (依年干)
const SIHUA_TABLE={
  甲:{祿:'廉貞',權:'破軍',科:'武曲',忌:'太陽'},
  乙:{祿:'天機',權:'天梁',科:'紫微',忌:'太陰'},
  丙:{祿:'天同',權:'天機',科:'文昌',忌:'廉貞'},
  丁:{祿:'太陰',權:'天同',科:'天機',忌:'巨門'},
  戊:{祿:'貪狼',權:'太陰',科:'右弼',忌:'天機'},
  己:{祿:'武曲',權:'貪狼',科:'天梁',忌:'文曲'},
  庚:{祿:'太陽',權:'武曲',科:'太陰',忌:'天同'},
  辛:{祿:'巨門',權:'太陽',科:'文曲',忌:'文昌'},
  壬:{祿:'天梁',權:'紫微',科:'左輔',忌:'武曲'},
  癸:{祿:'破軍',權:'巨門',科:'太陰',忌:'貪狼'}
};

// 紫微星安星法（簡化版：依農曆日決定紫微所在宮位）
function getZiweiPalaceIdx(lunarDay){
  // 真實計算需要五行局，這裡用簡化映射
  // 紫微星位置 = (農曆日數 - 1) % 12
  return (lunarDay - 1) % 12;
}

// 天府星位置（與紫微對稱）
function getTianfuIdx(ziweiIdx){
  return (12 - ziweiIdx + 2) % 12; // 簡化對稱
}

// 農曆轉換（簡化：用地支推算近似農曆月日）
function approxLunar(y,m,d){
  // 簡化：取 solar 日減去近似值
  const lunarMonth = ((m + 10) % 12) + 1; // 粗略
  const lunarDay = ((d + 28) % 30) + 1;
  return {month: lunarMonth, day: lunarDay};
}

function computeZiwei(year,month,day,hour,gender){
  const lunar = approxLunar(year,month,day);
  const yGan = TG[((year-4)%10+10)%10];
  const yZhi = DZ[((year-4)%12+12)%12];

  // 命宮地支：以月、時推算
  // 命宮 = (寅 + 月數 - 1 - 時辰) mod 12
  const shi = Math.floor(((hour+1)%24)/2);
  const mingIdx = ((2 + lunar.month - 1 - shi) % 12 + 12) % 12;
  const shenIdx = (mingIdx + 6) % 12; // 身宮

  // 五行局 (簡化：依命宮天干地支組合)
  const mingGanIdx = ((((year-4)%10+10)%10 % 5) * 2 + mingIdx) % 10;
  const mingGan = TG[mingGanIdx];
  const wuxingJu = getWuxingJu(mingGan, DZ[mingIdx]);

  // 安紫微星
  const ziweiIdx = getZiweiPalaceByJu(wuxingJu, lunar.day);
  const tianfuIdx = (12 - ziweiIdx + 4) % 12;

  // 建立12宮
  const palaces = [];
  for(let i=0;i<12;i++){
    const pIdx = (mingIdx + i) % 12;
    palaces.push({
      name: ZW_PALACES[i],
      branch: DZ[pIdx],
      stars: [],
      isMing: i===0,
      isShen: pIdx === shenIdx
    });
  }

  // 安14主星（簡化排列）
  const ziweiOrder = [0,1,null,2,3,4,5]; // 紫微系
  const tianfuOrder = [6,7,8,9,10,11,12,13]; // 天府系

  // 紫微系安星
  const zwStarMap = [
    {star:0, offset:0},  // 紫微
    {star:1, offset:-1}, // 天機
    {star:2, offset:-3}, // 太陽
    {star:3, offset:-4}, // 武曲
    {star:4, offset:-5}, // 天同
    {star:5, offset:1}   // 廉貞（在紫微後一位）
  ];
  zwStarMap.forEach(({star,offset})=>{
    const pos = ((ziweiIdx + offset) % 12 + 12) % 12;
    const palaceIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === pos);
    if(palaceIdx>=0) palaces[palaceIdx].stars.push({...ZW_MAJOR[star], type:'major'});
  });

  // 天府系安星
  const tfStarMap = [
    {star:6, offset:0},   // 天府
    {star:7, offset:1},   // 太陰
    {star:8, offset:2},   // 貪狼
    {star:9, offset:3},   // 巨門
    {star:10, offset:4},  // 天相
    {star:11, offset:5},  // 天梁
    {star:12, offset:6},  // 七殺
    {star:13, offset:10}  // 破軍
  ];
  tfStarMap.forEach(({star,offset})=>{
    const pos = ((tianfuIdx + offset) % 12 + 12) % 12;
    const palaceIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === pos);
    if(palaceIdx>=0) palaces[palaceIdx].stars.push({...ZW_MAJOR[star], type:'major'});
  });

  // 安吉星（簡化）
  const wcIdx = ((year-4)%12+12)%12;
  addStarToPalace(palaces,'文昌','minor',(10-shi+12)%12);
  addStarToPalace(palaces,'文曲','minor',(shi+4)%12);
  addStarToPalace(palaces,'左輔','minor',(lunar.month+3)%12);
  addStarToPalace(palaces,'右弼','minor',(11-lunar.month+12)%12);

  // 安煞星（簡化）
  const yZhiIdx = DZ.indexOf(yZhi);
  addStarToPalace(palaces,'擎羊','sha',(yZhiIdx+1)%12);
  addStarToPalace(palaces,'陀羅','sha',(yZhiIdx-1+12)%12);
  addStarToPalace(palaces,'火星','sha',(yZhiIdx+2)%12);
  addStarToPalace(palaces,'鈴星','sha',(yZhiIdx+10)%12);

  // 四化
  const sihua = SIHUA_TABLE[yGan] || SIHUA_TABLE['甲'];
  const huaMap = [];
  [{type:'祿',label:'化祿'},{type:'權',label:'化權'},{type:'科',label:'化科'},{type:'忌',label:'化忌'}].forEach(h=>{
    const starName = sihua[h.type];
    palaces.forEach(p=>{
      const found = p.stars.find(s=>s.name===starName);
      if(found){
        found.hua = h.label;
        huaMap.push({star:starName, hua:h.label, palace:p.name});
      }
    });
  });

  return {palaces, mingIdx, shenIdx, yGan, yZhi, wuxingJu, sihua: huaMap, lunar};
}

function addStarToPalace(palaces, name, type, zhiIdx){
  const pIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === zhiIdx);
  if(pIdx>=0) palaces[pIdx].stars.push({name, type});
}

function getWuxingJu(gan, zhi){
  // 納音五行局（簡化）
  const juMap = {
    '甲子':2,'甲丑':2,'乙丑':2,'乙子':2,'丙寅':3,'丙卯':3,'丁卯':3,'丁寅':3,
    '戊辰':5,'戊巳':5,'己巳':5,'己辰':5,'庚午':4,'庚未':4,'辛未':4,'辛午':4,
    '壬申':6,'壬酉':6,'癸酉':6,'癸申':6
  };
  return juMap[gan+zhi] || (((gan.charCodeAt(0)+zhi.charCodeAt(0))%5)+2);
}

function getZiweiPalaceByJu(ju, lunarDay){
  // 紫微安星：局數除日數的餘數決定位置
  const base = Math.ceil(lunarDay / ju);
  const remainder = lunarDay % ju;
  let idx;
  if(remainder === 0) idx = base - 1;
  else idx = base + (ju - remainder > remainder ? 0 : 1);
  return ((idx + 1) % 12 + 12) % 12;
}

function renderZiwei(){
  const zw = S.ziwei;
  if(!zw){document.getElementById('d-ziwei-info').innerHTML='<p class="text-dim">請先填寫出生資料</p>';return}

  // Info
  document.getElementById('d-ziwei-info').innerHTML=`
    <p>命宮：${DZ[zw.mingIdx]}宮 ｜ 身宮：${DZ[zw.shenIdx]}宮 ｜ 年干：${zw.yGan} ｜ 五行局：${zw.wuxingJu}局</p>`;

  // 12宮格（4x4, 中間2x2空）
  // 排列順序: 辰巳午未 / 卯[空][空]申 / 寅[空][空]酉 / 丑子亥戌
  const order = [
    [3,4,5,6],   // 辰巳午未
    [2,-1,-1,7],  // 卯 center center 申
    [1,-1,-1,8],  // 寅 center center 酉
    [0,11,10,9]   // 丑子亥戌
  ];

  let html = '<div class="zw-grid">';
  for(let row=0;row<4;row++){
    for(let col=0;col<4;col++){
      const idx = order[row][col];
      if(idx===-1){
        if(row===1&&col===1){
          // Center cell spans 2x2
          html+=`<div class="zw-cell zw-center" style="grid-column:2/4;grid-row:2/4">
            <div class="serif text-gold" style="font-size:1.1rem;margin-bottom:var(--sp-sm)">紫微斗數</div>
            <p class="text-dim text-xs">命宮：${DZ[zw.mingIdx]}</p>
            <p class="text-dim text-xs">年干：${zw.yGan}${zw.yZhi}</p>
          </div>`;
        }
        continue;
      }
      const palace = zw.palaces.find(p => DZ.indexOf(p.branch) === idx);
      if(!palace){html+=`<div class="zw-cell"><span class="zw-palace">${DZ[idx]}</span></div>`;continue}

      const isMing = palace.isMing;
      html+=`<div class="zw-cell${isMing?' active-palace':''}">
        <div class="zw-palace">${palace.name}${isMing?' ⭐':''}</div>
        <div class="zw-branch">${palace.branch}</div>
        <div class="zw-stars">`;
      palace.stars.forEach(s=>{
        const cls = s.type==='major'?'major':s.type==='sha'?'text-danger':'minor';
        html+=`<span class="zw-star ${cls}">${s.name}</span>`;
        if(s.hua)html+=`<span class="zw-hua">${s.hua}</span>`;
      });
      html+=`</div></div>`;
    }
  }
  html+='</div>';
  document.getElementById('d-ziwei-grid').innerHTML=html;

  // 四化
  document.getElementById('d-ziwei-sihua').innerHTML = zw.sihua.length?
    zw.sihua.map(h=>`<p><span class="tag ${h.hua.includes('祿')?'tag-green':h.hua.includes('忌')?'tag-red':'tag-gold'}">${h.hua}</span> ${h.star} → ${h.palace}</p>`).join('')
    :'<p class="text-dim">四化資訊計算中</p>';

  // 解讀
  const mingPalace = zw.palaces[0];
  const mingStars = mingPalace.stars.filter(s=>s.type==='major');
  let reading = '';
  if(mingStars.length){
    reading+=`<p><strong>命宮主星：</strong>${mingStars.map(s=>s.name).join('、')}</p>`;
    mingStars.forEach(s=>{
      const info = ZW_MAJOR.find(m=>m.name===s.name);
      if(info)reading+=`<p class="text-dim">→ ${info.name}：${info.nature}</p>`;
    });
  }else{
    reading+=`<p>命宮無主星，借對宮（遷移宮）星曜判斷。性格較為被動，需主動出擊。</p>`;
  }
  // 財帛宮
  const caiPalace = zw.palaces[4];
  const caiStars = caiPalace.stars.filter(s=>s.type==='major');
  if(caiStars.length)reading+=`<p class="mt-sm"><strong>財帛宮：</strong>${caiStars.map(s=>s.name).join('、')} — ${caiStars.some(s=>['武曲','天府','太陰'].includes(s.name))?'財運基礎佳':'財運需靠努力積累'}</p>`;

  // 官祿宮
  const guanPalace = zw.palaces[8];
  const guanStars = guanPalace.stars.filter(s=>s.type==='major');
  if(guanStars.length)reading+=`<p class="mt-sm"><strong>官祿宮：</strong>${guanStars.map(s=>s.name).join('、')} — ${guanStars.some(s=>['紫微','天府','太陽'].includes(s.name))?'事業格局大，適合管理職':'適合專業技術或自由業'}</p>`;

  // 煞星提醒
  const shaStars = [];
  zw.palaces.forEach(p=>p.stars.filter(s=>s.type==='sha').forEach(s=>shaStars.push(s.name+'('+p.name+')')));
  if(shaStars.length)reading+=`<p class="mt-sm text-warn"><strong>煞星：</strong>${shaStars.join('、')} — 注意相關宮位的挑戰</p>`;

  document.getElementById('d-ziwei-reading').innerHTML=reading||'<p class="text-dim">解讀生成中…</p>';
}
/* =============================================================
   姓名學 NAMEOLOGY（三才五格）
   ============================================================= */
const STROKE_OVERRIDE={
  // 常見字的康熙筆畫數（部分）
  '一':1,'二':2,'三':3,'四':4,'五':5,'六':6,'七':7,'八':8,'九':9,'十':10,
  '大':3,'小':3,'中':4,'上':3,'下':3,'人':2,'天':4,'地':6,'水':4,'火':4,
  '木':4,'金':8,'土':3,'日':4,'月':4,'年':6,'明':8,'光':6,'華':14,'國':11,
  '家':10,'庭':10,'心':4,'思':9,'愛':13,'美':9,'玉':5,'龍':16,'鳳':14,
  '林':8,'陳':16,'王':4,'李':7,'張':11,'劉':15,'黃':12,'吳':7,'趙':14,
  '楊':13,'周':8,'徐':10,'孫':10,'馬':10,'朱':6,'胡':11,'郭':15,'何':7,
  '高':10,'羅':20,'鄭':19,'蔡':17,'謝':17,'蕭':18,'許':11,'曾':12,'彭':12,
  '呂':7,'蘇':22,'盧':16,'蔣':17,'沈':8,'韓':17,'唐':10,'馮':12,'潘':16,
  '志':7,'偉':11,'強':12,'建':9,'文':4,'武':8,'德':15,'仁':4,'義':13,
  '禮':18,'信':9,'智':12,'勇':9,'忠':8,'孝':7,'俊':9,'傑':12,'宏':7,
  '雅':12,'靜':16,'慧':15,'敏':11,'婷':12,'秀':7,'芳':10,'麗':19,'英':11,
  '春':9,'夏':10,'秋':9,'冬':5,'東':8,'西':6,'南':9,'北':5,'成':7,'功':5,
  '安':6,'平':5,'福':14,'壽':14,'喜':12,'樂':15,'和':8,'順':12,'吉':6,
  '祥':11,'瑞':14,'達':16,'昌':8,'盛':12,'榮':14,'富':12,'貴':12,'康':11
};

function kangxiStroke(ch){
  if(STROKE_OVERRIDE[ch])return STROKE_OVERRIDE[ch];
  // 部首修正（常見差異）
  const code=ch.charCodeAt(0);
  // 粗略估算：CJK字的 Unicode 碼 % 25 + 2
  return (code % 23) + 3;
}

function analyzeName(fullName){
  if(!fullName||fullName.length<2)return null;
  const chars=[...fullName];
  const strokes=chars.map(c=>kangxiStroke(c));

  let tianGe,renGe,diGe,waiGe,zongGe;

  if(chars.length===2){
    // 單姓單名
    tianGe=strokes[0]+1;
    renGe=strokes[0]+strokes[1];
    diGe=strokes[1]+1;
    zongGe=strokes[0]+strokes[1];
    waiGe=2;
  }else if(chars.length===3){
    // 單姓雙名（最常見）
    tianGe=strokes[0]+1;
    renGe=strokes[0]+strokes[1];
    diGe=strokes[1]+strokes[2];
    zongGe=strokes[0]+strokes[1]+strokes[2];
    waiGe=strokes[0]+strokes[2];
  }else if(chars.length===4){
    // 複姓雙名
    tianGe=strokes[0]+strokes[1];
    renGe=strokes[1]+strokes[2];
    diGe=strokes[2]+strokes[3];
    zongGe=strokes.reduce((a,b)=>a+b,0);
    waiGe=strokes[0]+strokes[3];
  }else{
    return null;
  }

  // 五行
  function geWuxing(ge){
    const tail=ge%10;
    if(tail===1||tail===2)return'木';
    if(tail===3||tail===4)return'火';
    if(tail===5||tail===6)return'土';
    if(tail===7||tail===8)return'金';
    return'水';
  }

  // 吉凶（簡化81數理）
  function geFortune(ge){
    const n=((ge-1)%80)+1;
    const ji=[1,3,5,6,7,8,11,13,15,16,17,18,21,23,24,25,29,31,32,33,35,37,39,41,45,47,48,52,57,61,63,65,67,68];
    const dj=[1,3,5,8,11,13,15,16,21,23,24,25,31,32,33,35,37,41,45,47,48,52,57,61,63,67,68];
    if(dj.includes(n))return{level:'大吉',cls:'text-success'};
    if(ji.includes(n))return{level:'吉',cls:'text-success'};
    const xiong=[2,4,9,10,12,14,19,20,22,26,27,28,30,34,36,38,40,42,43,44,46,49,50,51,53,54,55,56,58,59,60,62,64,66,69,70,71,72,73,74,75,76,77,78,79,80];
    if(xiong.includes(n))return{level:'凶',cls:'text-danger'};
    return{level:'平',cls:'text-dim'};
  }

  // 三才配置
  const sanCai=[geWuxing(tianGe),geWuxing(renGe),geWuxing(diGe)];
  // 三才吉凶（簡化判斷）
  let sanCaiLevel='吉';
  const [t,r,d]=sanCai;
  // 相生為吉
  if(SHENG[t]===r&&SHENG[r]===d)sanCaiLevel='大吉';
  else if(SHENG[t]===r||SHENG[r]===d)sanCaiLevel='吉';
  else if(KE[t]===r||KE[r]===d)sanCaiLevel='凶';
  else sanCaiLevel='平';

  return{
    name:fullName, strokes,
    tianGe:{num:tianGe,el:geWuxing(tianGe),fortune:geFortune(tianGe)},
    renGe:{num:renGe,el:geWuxing(renGe),fortune:geFortune(renGe)},
    diGe:{num:diGe,el:geWuxing(diGe),fortune:geFortune(diGe)},
    waiGe:{num:waiGe,el:geWuxing(waiGe),fortune:geFortune(waiGe)},
    zongGe:{num:zongGe,el:geWuxing(zongGe),fortune:geFortune(zongGe)},
    sanCai,sanCaiLevel
  };
}

/* =============================================================
   水晶推薦系統 CRYSTAL — 擴充版
   ============================================================= */
const CRYSTAL_DB={
  金:[
    {n:'白水晶',icon:'💎',el:'金',d:'淨化能量場，增強思維清晰度，萬能調和石。',wear:'左手佩戴，或放書桌/辦公桌。',taboo:'避免碰撞，定期淨化。'},
    {n:'黃鐵礦',icon:'✨',el:'金',d:'增強財運，提升自信與行動力。',wear:'放在錢包或辦公桌左上角。',taboo:'怕水，避免接觸液體。'},
    {n:'白幽靈',icon:'💠',el:'金',d:'淨化磁場，提升靈性直覺。',wear:'冥想時手持或佩戴。',taboo:'避免陽光直射。'},
    {n:'鈦晶',icon:'⚡',el:'金',d:'招正財偏財，增強領導力與氣魄。',wear:'左手佩戴，面試/簽約時特別有效。',taboo:'磁場強，睡眠時建議取下。'}
  ],
  木:[
    {n:'綠幽靈',icon:'💚',el:'木',d:'招正財，事業穩步上升，適合上班族。',wear:'左手佩戴，放辦公桌增事業運。',taboo:'避免高溫與化學品。'},
    {n:'東陵玉',icon:'🌿',el:'木',d:'舒緩壓力，帶來好運與樂觀心態。',wear:'隨身佩戴或放枕頭下助眠。',taboo:'定期用月光淨化。'},
    {n:'翡翠',icon:'🟢',el:'木',d:'護身辟邪，增強健康與人緣。',wear:'佩戴在靠近心臟處。',taboo:'避免碰撞與高溫。'},
    {n:'橄欖石',icon:'🌱',el:'木',d:'療癒心輪，帶來正能量與好運。',wear:'左手佩戴，可配合冥想。',taboo:'質地較軟，注意保護。'}
  ],
  水:[
    {n:'海藍寶',icon:'💙',el:'水',d:'增強溝通力，平靜情緒，適合談判。',wear:'佩戴在喉輪附近（項鍊）效果最佳。',taboo:'避免長時間日曬。'},
    {n:'藍紋瑪瑙',icon:'🔵',el:'水',d:'穩定情緒，增強語言表達能力。',wear:'左手佩戴，或做為項鍊。',taboo:'定期流水淨化。'},
    {n:'月光石',icon:'🌙',el:'水',d:'增強直覺，助感情運，柔化個性。',wear:'滿月時佩戴效果更佳。',taboo:'硬度不高，避免碰撞。'},
    {n:'拉長石',icon:'🌊',el:'水',d:'提升洞察力，保護能量場。',wear:'左手佩戴，出入複雜場所時效果好。',taboo:'避免超聲波清洗。'}
  ],
  火:[
    {n:'紅瑪瑙',icon:'❤️',el:'火',d:'激發熱情，增強行動力與勇氣。',wear:'右手佩戴增強行動力。',taboo:'避免高溫環境。'},
    {n:'石榴石',icon:'🔴',el:'火',d:'提升活力，增強意志力與桃花運。',wear:'左手佩戴，貼身效果好。',taboo:'定期用水晶簇淨化。'},
    {n:'紅碧璽',icon:'💗',el:'火',d:'強力招桃花，增強人際魅力。',wear:'佩戴在心輪附近。',taboo:'磁場敏感，避免與其他強磁場水晶混戴。'},
    {n:'太陽石',icon:'☀️',el:'火',d:'帶來正能量，增強自信與領導力。',wear:'日間佩戴效果佳。',taboo:'避免長時間泡水。'}
  ],
  土:[
    {n:'黃水晶',icon:'💛',el:'土',d:'招偏財，提升自信與個人魅力。',wear:'左手佩戴，放錢包也可。',taboo:'避免陽光長時間直射，會褪色。'},
    {n:'虎眼石',icon:'🟤',el:'土',d:'增強決斷力，招財辟邪，穩定心性。',wear:'右手佩戴增強氣場。',taboo:'定期日光浴淨化（短時間）。'},
    {n:'茶晶',icon:'🍵',el:'土',d:'排除負能量，增強穩定感。',wear:'佩戴或放在家中客廳。',taboo:'避免化學品。'},
    {n:'瑪瑙',icon:'🟠',el:'土',d:'保護、穩定、增強耐力。',wear:'可隨身佩戴，適合各場合。',taboo:'質地堅硬但仍需小心碰撞。'}
  ]
};

// 問題類型 → 特殊推薦
const CRYSTAL_BY_TYPE={
  love:[{n:'粉晶',icon:'💕',el:'土',d:'招桃花首選，增強感情運與人際魅力。',wear:'左手佩戴，睡前放枕頭下。',taboo:'需定期淨化，吸收負能量後會變暗。'},
        {n:'草莓晶',icon:'🍓',el:'火',d:'增強異性緣，帶來甜蜜的戀愛機會。',wear:'左手佩戴，約會時效果倍增。',taboo:'避免碰撞。'}],
  career:[{n:'鈦晶',icon:'⚡',el:'金',d:'事業晉升首選，增強領導力與決斷力。',wear:'面試/重要會議時佩戴。',taboo:'磁場強，睡眠時取下。'}],
  wealth:[{n:'黃水晶',icon:'💛',el:'土',d:'偏財運首選，提升投資眼光。',wear:'左手佩戴，放收銀台也可。',taboo:'避免日曬。'},
          {n:'綠幽靈',icon:'💚',el:'木',d:'正財運首選，適合穩健理財。',wear:'左手佩戴。',taboo:'避免高溫。'}],
  health:[{n:'紫水晶',icon:'💜',el:'火',d:'安神助眠，穩定情緒，促進身心平衡。',wear:'放枕頭下助眠，或佩戴在第三眼處冥想。',taboo:'避免日曬會褪色。'}]
};

function renderCrystalExpanded(bazi, type){
  const need = bazi.fav[0];
  const baseCrystals = CRYSTAL_DB[need] || CRYSTAL_DB['土'];
  const typeCrystals = CRYSTAL_BY_TYPE[type] || [];

  // 去重合併
  const allCrystals = [...typeCrystals];
  baseCrystals.forEach(c=>{if(!allCrystals.find(a=>a.n===c.n))allCrystals.push(c)});
  const display = allCrystals.slice(0,4);

  document.getElementById('r-crystal').innerHTML=`
    <p class="mb-md">根據命盤（喜用 <span class="tag tag-gold">${need}行</span>）與問題類型（<span class="tag tag-blue">${getTypeLabel(type)}</span>），推薦：</p>
    <div class="crystal-grid">${display.map(c=>`
      <div class="crystal-card">
        <div class="crystal-icon">${c.icon}</div>
        <div class="crystal-name">${c.n}</div>
        <div class="text-xs mb-sm"><span class="el-tag el-${c.el}">${c.el}行</span></div>
        <p class="text-sm text-dim">${c.d}</p>
        <p class="text-xs text-muted mt-sm"><i class="fas fa-hand-holding-heart"></i> ${c.wear}</p>
        <p class="text-xs text-warn mt-sm"><i class="fas fa-exclamation-triangle"></i> ${c.taboo}</p>
      </div>`).join('')}</div>
    <p class="text-xs text-muted mt-md"><i class="fas fa-info-circle"></i> 本建議僅供能量校準參考，不具醫療或命運保證效力。水晶效果因人而異，請依自身感受調整。</p>`;
}

/* =============================================================
   FUSION ENGINE v2 — 五維度加權融合
   ============================================================= */
function runAnalysisV2(){
  renderBazi(); renderMeihua(); renderTarot(); renderZiwei(); renderName();

  const b=S.bazi; if(!b)return;
  const type=S.form.type;
  const question=S.form.question;

  // ── 1. 八字評分 (0-100) ──
  let baziScore=50;
  if(b.strong){
    if(b.ep[KE[b.dmEl]]>15)baziScore+=12;
    if(b.ep[BE_KE[b.dmEl]]>10)baziScore+=8;
  }else{
    if(b.ep[BE_SHENG[b.dmEl]]>15)baziScore+=12;
    if(b.ep[b.dmEl]>15)baziScore+=8;
  }
  const curDy=b.dayun.find(d=>d.isCurrent);
  if(curDy){
    if(curDy.level==='大吉')baziScore+=15;
    else if(curDy.level==='中吉')baziScore+=10;
    else if(curDy.level.includes('凶'))baziScore-=10;
  }
  if(b.shensha.includes('天乙貴人'))baziScore+=5;
  if(b.shensha.includes('文昌')&&(type==='career'))baziScore+=5;
  if(b.shensha.includes('桃花')&&(type==='love'))baziScore+=8;
  if(b.shensha.includes('驛馬')&&(type==='career'))baziScore+=3;
  baziScore=Math.max(10,Math.min(95,baziScore));

  // ── 2. 梅花評分（體用生剋 + 卦象 + 動爻） ──
  let mhScore=50;
  if(S.meihua){
    const fMap={'大吉':82,'吉':70,'小吉':60,'平':50,'小凶':35,'凶':20};
    mhScore=fMap[S.meihua.ty.f]||50;
    // 體用關係微調
    const tyR=S.meihua.ty.r||'';
    if(tyR.includes('生體'))mhScore+=5;       // 用生體=外來助力
    else if(tyR.includes('體生'))mhScore-=3;  // 體生用=耗費
    else if(tyR.includes('剋體'))mhScore-=5;  // 用剋體=阻礙
    else if(tyR.includes('體剋'))mhScore+=3;  // 體剋用=可控制
    // 變卦走勢
    if(S.meihua.bian&&S.meihua.bian.n){
      const bianGood=['乾','離','兌','巽'];
      const bianBad=['坎','艮'];
      const bn=S.meihua.bian.n||'';
      if(bianGood.some(g=>bn.includes(g)))mhScore+=4;
      if(bianBad.some(b=>bn.includes(b)))mhScore-=3;
    }
    mhScore=Math.max(10,Math.min(90,mhScore));
  }

  // ── 3. 塔羅評分（位置加權 + 特定牌加權） ──
  let tarotScore=50;
  if(S.tarot.drawn.length>=10){
    // 各位置權重：核心=2.5, 阻礙=-1.5(反向), 過去=0.5, 未來=2, 結果=2, 近期=1.5, 自我=1, 環境=1, 恐懼=-0.5(反向), 最終=3
    const posWeight=[2.5,-1.5,0.5,2.0,2.0,1.5,1.0,1.0,-0.5,3.0];
    let weightedSum=0, totalAbs=0;
    S.tarot.drawn.forEach((c,i)=>{
      const w=posWeight[i]||1;
      const baseVal=c.isUp?1:-0.8;
      // 阻礙位(1)和恐懼位(8)：逆位反而是好事（阻礙被化解）
      if((i===1||i===8)&&!c.isUp){
        weightedSum+=Math.abs(w)*0.6; // 逆位在阻礙位=阻礙被化解=正面
      } else {
        weightedSum+=baseVal*w;
      }
      totalAbs+=Math.abs(w);

      // 特定大牌強力加權
      if(c.id===19&&c.isUp)weightedSum+=3;   // 太陽正位=大吉
      if(c.id===21&&c.isUp)weightedSum+=3;   // 世界正位=圓滿
      if(c.id===10&&c.isUp)weightedSum+=2;   // 命運之輪正位=好轉
      if(c.id===17&&c.isUp)weightedSum+=2;   // 星星正位=希望
      if(c.id===6&&c.isUp)weightedSum+=1.5;  // 戀人正位（愛情加分）
      if(c.id===16&&c.isUp)weightedSum-=2.5; // 塔正位=崩塌
      if(c.id===15&&c.isUp)weightedSum-=2;   // 惡魔正位=束縛
      if(c.id===13&&c.isUp)weightedSum-=1;   // 死神正位=結束
      if(c.id===52&&c.isUp)weightedSum-=1.5; // 寶劍三正位=心碎
      if(c.id===58&&c.isUp)weightedSum-=1.5; // 寶劍九正位=焦慮
    });
    // Normalize: weightedSum / totalAbs → [-1,1] → map to [15,85]
    const normalized = weightedSum / (totalAbs||1);
    tarotScore=Math.round(50+normalized*35);
    tarotScore=Math.max(10,Math.min(90,tarotScore));
  }

  // ── 4. 紫微評分 ──
  let ziweiScore=50;
  if(S.ziwei){
    const mingStars=S.ziwei.palaces[0].stars;
    // 命宮有吉星加分
    const goodStars=['紫微','天府','天同','天梁','天相','太陽','太陰','文昌','文曲','左輔','右弼'];
    const badStars=['擎羊','陀羅','火星','鈴星','七殺','破軍'];
    mingStars.forEach(s=>{
      if(goodStars.includes(s.name))ziweiScore+=5;
      if(badStars.includes(s.name))ziweiScore-=3;
      if(s.hua==='化祿')ziweiScore+=8;
      if(s.hua==='化權')ziweiScore+=5;
      if(s.hua==='化忌')ziweiScore-=8;
    });
    // 問題對應宮位
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7};
    const gongIdx=typeToGong[type];
    if(gongIdx!==undefined){
      const gongStars=S.ziwei.palaces[gongIdx].stars;
      gongStars.forEach(s=>{
        if(goodStars.includes(s.name))ziweiScore+=4;
        if(s.hua==='化祿')ziweiScore+=6;
        if(s.hua==='化忌')ziweiScore-=6;
      });
    }
    ziweiScore=Math.max(10,Math.min(90,ziweiScore));
  }

  // ── 5. 姓名學評分 ──
  let nameScore=50;
  let nameResult=null;
  if(S.form.name&&S.form.name.length>=2){
    nameResult=analyzeName(S.form.name);
    if(nameResult){
      [nameResult.tianGe,nameResult.renGe,nameResult.diGe,nameResult.waiGe,nameResult.zongGe].forEach(g=>{
        if(g.fortune.level==='大吉')nameScore+=6;
        else if(g.fortune.level==='吉')nameScore+=3;
        else if(g.fortune.level==='凶')nameScore-=4;
      });
      if(nameResult.sanCaiLevel==='大吉')nameScore+=10;
      else if(nameResult.sanCaiLevel==='吉')nameScore+=5;
      else if(nameResult.sanCaiLevel==='凶')nameScore-=8;
      nameScore=Math.max(10,Math.min(90,nameScore));
    }
  }

  // ── 加權綜合 ──
  const w={bazi:0.30, meihua:S.meihua?0.20:0, tarot:S.tarot.drawn.length>=10?0.20:0, ziwei:S.ziwei?0.20:0, name:nameResult?0.10:0};
  const totalW=Object.values(w).reduce((a,b)=>a+b,0);
  const scores={bazi:baziScore,meihua:mhScore,tarot:tarotScore,ziwei:ziweiScore,name:nameScore};
  let finalProb=0;
  for(const k of Object.keys(w))finalProb+=scores[k]*(w[k]/totalW);
  finalProb=Math.round(finalProb);

  // ── Verdict ──
  let vlabel,vnote;
  if(finalProb>=70){vlabel='偏向可行 ✅';vnote='多維度指標偏一致，適合推進，仍需按建議控風險。'}
  else if(finalProb>=45){vlabel='中性偏可行 ⚖️';vnote='有利與阻力並存；照建議調整做法，勝率會上升。'}
  else if(finalProb>=25){vlabel='偏保守 ⚠️';vnote='阻力訊號較多，建議先降低成本/試水溫。'}
  else{vlabel='不建議硬推 ⛔';vnote='目前象徵偏逆風；若要做，務必設停損。'}

  document.getElementById('r-vlabel').textContent=vlabel;
  document.getElementById('r-vprob').textContent=finalProb+'%';
  document.getElementById('r-vnote').textContent=vnote;
  document.getElementById('r-pfill').style.width=finalProb+'%';
  document.getElementById('r-question').innerHTML=`<strong>問題：</strong>${question}<br><span class="tag tag-gold">${getTypeLabel(type)}</span>`;

  // ── Answer ──
  const answer=generateAnswer(type,finalProb,b,S.meihua,S.tarot);
  document.getElementById('r-answer').innerHTML=answer.text;
  document.getElementById('r-factors').innerHTML=answer.factors?`<h4 class="text-gold serif mt-md mb-sm">影響因子</h4><ul class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.factors.map(f=>'<li style="margin:.3rem 0">'+f+'</li>').join('')}</ul>`:'';
  document.getElementById('r-suggest').innerHTML=answer.suggestions?`<h4 class="text-gold serif mt-md mb-sm">行動建議</h4><ol class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.suggestions.map(s=>'<li style="margin:.3rem 0">'+s+'</li>').join('')}</ol>`:'';

  // ── Breakdown ──
  const dimLabels={bazi:'八字命理',meihua:'梅花易數',tarot:'塔羅牌陣',ziwei:'紫微斗數',name:'姓名學'};
  document.getElementById('r-pbreak').innerHTML=Object.keys(w).filter(k=>w[k]>0).map(k=>
    `<div class="el-row"><span class="el-lbl text-sm">${dimLabels[k]}</span><div class="el-track"><div class="el-fill" style="width:${scores[k]}%;background:var(--c-gold)"></div></div><span class="el-val">${scores[k]}%<span class="text-xs text-muted"> (${Math.round(w[k]/totalW*100)}%)</span></span></div>`
  ).join('');

  // ── Crystal ──
  if(typeof renderProductCrystal==='function')renderProductCrystal(b,type);
  else renderCrystalExpanded(b,type);

  // ── Conclusion ──
  let concl=generateConclusion(type,finalProb,b,S.meihua,S.tarot);
  // 加入紫微
  if(S.ziwei){
    const mp=S.ziwei.palaces[0];
    const ms=mp.stars.filter(s=>s.type==='major').map(s=>s.name).join('、');
    if(ms)concl+=`<p class="mt-sm">紫微命宮主星：${ms}，${ziweiScore>=60?'命格偏向有利':'需注意相關宮位挑戰'}。</p>`;
  }
  // 加入姓名學
  if(nameResult){
    concl+=`<p class="mt-sm">姓名學：三才 ${nameResult.sanCai.join('→')}（${nameResult.sanCaiLevel}），人格${nameResult.renGe.num}（${nameResult.renGe.fortune.level}）。</p>`;
  }
  document.getElementById('r-conclusion').innerHTML=concl;
}

// Override runAnalysis to use V2
function runAnalysis(){ runAnalysisV2(); }

function renderName(){
  const el=document.getElementById('d-name');
  if(!S.form.name||S.form.name.length<2){el.innerHTML='<p class="text-dim">未輸入姓名，無法進行姓名學分析。</p>';return}
  const r=analyzeName(S.form.name);
  if(!r){el.innerHTML='<p class="text-dim">姓名格式不支援（需2-4個字）。</p>';return}

  const geData=[
    {label:'天格',data:r.tianGe,desc:'先天運，姓氏決定'},
    {label:'人格',data:r.renGe,desc:'主運，影響中年'},
    {label:'地格',data:r.diGe,desc:'前運，影響青年'},
    {label:'外格',data:r.waiGe,desc:'副運，人際關係'},
    {label:'總格',data:r.zongGe,desc:'後運，影響晚年'}
  ];

  el.innerHTML=`
    <p class="mb-md">姓名：<strong class="text-gold serif">${r.name}</strong> ｜ 筆畫：${r.strokes.join('、')}</p>
    <div class="bazi-grid" style="grid-template-columns:repeat(5,1fr);margin:var(--sp-md) 0">
      ${geData.map(g=>`<div class="bazi-cell header">${g.label}</div>`).join('')}
      ${geData.map(g=>`<div class="bazi-cell">
        <span class="gz">${g.data.num}</span>
        <span class="el-tag el-${g.data.el}">${g.data.el}</span>
        <div class="gz-sub ${g.data.fortune.cls}">${g.data.fortune.level}</div>
      </div>`).join('')}
      ${geData.map(g=>`<div class="bazi-cell"><div class="gz-sub">${g.desc}</div></div>`).join('')}
    </div>
    <div class="mt-md">
      <p><strong>三才配置：</strong>${r.sanCai.join(' → ')} <span class="tag ${r.sanCaiLevel.includes('吉')?'tag-green':r.sanCaiLevel==='凶'?'tag-red':'tag-gold'}">${r.sanCaiLevel}</span></p>
      <p class="text-sm text-dim mt-sm">三才代表天格→人格→地格的五行流通關係，${r.sanCaiLevel.includes('吉')?'相生相助為佳象':'存在相剋，需注意健康與人際'}。</p>
    </div>`;
}
/* =============================================================
   ENHANCEMENT 1: 流年詳細展開（點擊大運展開10流年）
   ============================================================= */
function renderDayunEnhanced(){
  const b=S.bazi; if(!b)return;
  let html='<div class="dayun-tl">';
  b.dayun.forEach((d,i)=>{
    const lvCls=d.level==='大吉'?'lv-dj':d.level==='中吉'?'lv-zj':d.level==='小吉'?'lv-xj':d.level==='平'?'lv-p':d.level==='小凶'?'lv-xk':d.level==='中凶'?'lv-zk':'lv-dk';
    html+=`<div class="dy-item ${d.isCurrent?'current':''}" onclick="toggleLiuNian(${i})" title="點擊展開流年">
      <span class="dy-gz">${d.gz}</span><span class="dy-age">${d.ageStart}-${d.ageEnd}歲</span>
      <span class="dy-lv ${lvCls}">${d.level}</span><div class="gz-sub">${d.god}</div></div>`;
  });
  html+='</div>';
  html+='<div id="liunian-detail" class="mt-md hidden"></div>';
  document.getElementById('d-dayun').innerHTML=html;
}

function toggleLiuNian(dyIdx){
  const el=document.getElementById('liunian-detail');
  const b=S.bazi; if(!b||!b.dayun[dyIdx])return;
  const dy=b.dayun[dyIdx];
  if(el.dataset.openIdx===String(dyIdx)&&!el.classList.contains('hidden')){
    el.classList.add('hidden');return;
  }
  el.dataset.openIdx=dyIdx;
  el.classList.remove('hidden');
  const curYear=new Date().getFullYear();
  let html=`<div class="card" style="padding:var(--sp-md);margin:0"><div class="card-title text-sm"><i class="fas fa-calendar"></i> ${dy.gz}大運（${dy.ageStart}-${dy.ageEnd}歲）流年明細</div>`;
  html+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:4px">';
  dy.liuNian.forEach(ln=>{
    const isCur=ln.year===curYear;
    const cls=ln.level==='吉'?'tag-green':ln.level==='凶'?'tag-red':'tag-gold';
    html+=`<div style="padding:6px;border:1px solid ${isCur?'var(--c-gold)':'var(--c-border)'};border-radius:var(--r-sm);background:${isCur?'rgba(212,175,55,.08)':'var(--c-bg-card)'};font-size:.8rem;text-align:center">
      <strong>${ln.year}</strong><br>
      <span class="serif">${ln.gz}</span><br>
      <span class="el-tag el-${ln.el}">${ln.el}</span>
      <span class="tag ${cls}" style="font-size:.6rem">${ln.level}</span><br>
      <span class="text-xs text-muted">${ln.god}</span>
      ${isCur?'<br><span class="text-xs text-gold">← 今年</span>':''}
    </div>`;
  });
  html+='</div></div>';
  el.innerHTML=html;
}

/* =============================================================
   ENHANCEMENT 2: 梅花六爻爻辭（簡化版：本卦動爻爻辭）
   ============================================================= */
const YAO_CI={
  '乾為天':['潛龍勿用','見龍在田，利見大人','君子終日乾乾，夕惕若厲，無咎','或躍在淵，無咎','飛龍在天，利見大人','亢龍有悔'],
  '坤為地':['履霜，堅冰至','直方大，不習無不利','含章可貞，或從王事，無成有終','括囊，無咎無譽','黃裳，元吉','龍戰于野，其血玄黃'],
  '地天泰':['拔茅茹，以其彙，征吉','包荒，用馮河，不遐遺','無平不陂，無往不復，艱貞無咎','翩翩不富，以其鄰，不戒以孚','帝乙歸妹，以祉元吉','城復于隍，勿用師，自邑告命'],
  '天地否':['拔茅茹，以其彙，貞吉亨','包承，小人吉，大人否亨','包羞','有命無咎，疇離祉','休否，大人吉','傾否，先否後喜'],
};

function getYaoCi(guaName, yaoNum){
  const ci=YAO_CI[guaName];
  if(ci&&ci[yaoNum-1])return ci[yaoNum-1];
  return'（爻辭資料庫擴充中）';
}

/* =============================================================
   ENHANCEMENT 3: 塔羅問題類型交叉解讀
   ============================================================= */
const TAROT_TYPE_MEANING={
  love:{
    0:{up:'愛情需要勇氣踏出舒適圈，新戀情可能從意想不到的地方開始。',rv:'感情上太隨性，需認真對待每段關係。'},
    1:{up:'你有吸引力和魅力，善用溝通技巧推進感情。',rv:'感情中有隱藏或欺騙，需坦誠相待。'},
    2:{up:'傾聽內心直覺，對方可能還沒完全表露心意。',rv:'過於封閉自我，錯過感情訊號。'},
    3:{up:'感情進入豐收期，充滿滋養與溫暖。',rv:'過度依賴對方，需要獨立空間。'},
    4:{up:'關係中需要穩定與承諾，適合談婚論嫁。',rv:'控制欲太強讓對方窒息。'},
    5:{up:'傳統價值觀的結合，可能有長輩介紹的緣分。',rv:'觀念太保守，錯失新型態的愛。'},
    6:{up:'真愛降臨，重要的感情抉擇帶來幸福。',rv:'感情價值觀衝突，需深度溝通。'},
    7:{up:'主動追求愛情，決心讓感情快速前進。',rv:'太急躁，給對方太多壓力。'},
    8:{up:'用耐心和溫柔經營，以柔克剛化解問題。',rv:'感情中缺乏安全感。'},
    9:{up:'需要獨處反思這段感情是否適合自己。',rv:'過度孤立自己，拒絕敞開心扉。'},
    10:{up:'感情命運之輪轉動，緣分即將到來。',rv:'感情進入瓶頸期。'},
    11:{up:'公平對待彼此，因果回報正面。',rv:'感情中有不公平的付出。'},
    12:{up:'為愛付出和等待，換個角度看待關係。',rv:'不必要的犧牲，對方不值得。'},
    13:{up:'舊感情結束，新的愛情破繭而出。',rv:'不願放手舊情，停滯不前。'},
    14:{up:'感情需要平衡和包容，調和彼此差異。',rv:'感情失衡，一方付出太多。'},
    15:{up:'警惕不健康的感情依附或誘惑。',rv:'掙脫不良關係，重獲自由。'},
    16:{up:'感情出現突變，原有認知被顛覆。',rv:'避開感情衝擊，危機可化解。'},
    17:{up:'愛情中的希望之星，值得期待的未來。',rv:'對感情失去信心。'},
    18:{up:'感情中有隱藏的不安，需要勇氣面對。',rv:'迷霧散去，感情真相浮現。'},
    19:{up:'感情明朗化，關係進入甜蜜光明期。',rv:'暫時的陰霾，但終會過去。'},
    20:{up:'重新審視感情觀，靈魂層面的覺醒。',rv:'拒絕成長讓關係退步。'},
    21:{up:'感情圓滿，找到命中注定的人。',rv:'感情尚缺最後一步才能完美。'},
    36:{up:'新的感情萌芽，情感豐沛。',rv:'感情封閉，錯過真心。'},
    37:{up:'雙方互相吸引，關係進入甜蜜期。',rv:'感情失衡，溝通出問題。'},
    44:{up:'感情願望實現，心滿意足。',rv:'不滿足現有的感情。'},
    45:{up:'家庭幸福、感情圓滿的象徵。',rv:'家庭問題影響感情。'}
  },
  career:{
    0:{up:'事業上勇於嘗試新領域，創業契機浮現。',rv:'職場決策太草率，需更多規劃。'},
    1:{up:'擁有成功所需的全部資源和能力。',rv:'技能需精進，避免眼高手低。'},
    2:{up:'職場直覺準確，適合等待更好的機會。',rv:'職場過於被動。'},
    3:{up:'事業豐收期，創造力旺盛適合擴展。',rv:'過度依賴團隊。'},
    4:{up:'獲得權威地位，適合管理與決策。',rv:'控制欲太強，需學會授權。'},
    5:{up:'遵循組織規範，向前輩/導師請教。',rv:'太死板，需要創新突破。'},
    6:{up:'面臨重要的職業選擇。',rv:'職場人際關係有衝突。'},
    7:{up:'事業突破，靠堅定意志克服困難。',rv:'工作方向不明。'},
    8:{up:'耐心處理職場挑戰，以智取勝。',rv:'缺乏自信影響表現。'},
    9:{up:'需要獨立思考職涯方向。',rv:'過度孤立錯失合作機會。'},
    10:{up:'事業迎來轉折點，好運降臨。',rv:'事業遇瓶頸，耐心等待。'},
    11:{up:'公正的工作評價，努力有回報。',rv:'遭受不公平對待。'},
    13:{up:'舊工作結束迎接新機會，轉型期。',rv:'抗拒職場變化。'},
    16:{up:'現有工作架構崩塌，被迫重建。',rv:'成功避開職場危機。'},
    19:{up:'事業光明，獲得認可與成就。',rv:'暫時的低潮期。'},
    21:{up:'事業達成里程碑，圓滿階段性目標。',rv:'尚差最後一步努力。'},
    22:{up:'新項目啟動，充滿創造能量。',rv:'項目延遲啟動。'},
    35:{up:'展現領導力，帶領團隊前進。',rv:'領導風格需調整。'},
    64:{up:'新的財務機會出現，升職加薪有望。',rv:'機會錯失，需提高警覺。'},
    71:{up:'精進技藝的時期，專注帶來成果。',rv:'對工作缺乏熱情。'}
  },
  wealth:{
    0:{up:'意外之財的可能，新的財路打開。',rv:'衝動消費，財務失控。'},
    1:{up:'善用手邊資源創造財富。',rv:'理財方式需要改進。'},
    3:{up:'財運豐饒，投資回報良好。',rv:'花費過度，需要節制。'},
    9:{up:'深思熟慮的財務決定帶來穩健收益。',rv:'投資判斷力下降。'},
    10:{up:'財運轉折，可能有意外收入。',rv:'財運低迷期。'},
    14:{up:'理財需要平衡，不宜偏重單一投資。',rv:'財務失衡，支出大於收入。'},
    15:{up:'小心物質誘惑和高風險投機。',rv:'擺脫不良的消費習慣。'},
    19:{up:'財運亨通，投資回報明顯。',rv:'短期財務壓力。'},
    21:{up:'財務目標達成，圓滿豐收。',rv:'收入不穩定。'},
    64:{up:'新的賺錢機會，財富種子萌發。',rv:'錯過投資良機。'},
    67:{up:'守財有道，財務安全感強。',rv:'過度吝嗇。'},
    72:{up:'財務自由的象徵，豐衣足食。',rv:'過度自滿導致風險。'},
    73:{up:'家族財富累積，長期穩定。',rv:'家庭財務有隱患。'}
  },
  health:{
    4:{up:'身體狀況穩定，規律生活有益。',rv:'壓力過大影響健康。'},
    8:{up:'身心調和，內在力量幫助恢復。',rv:'缺乏信心影響康復。'},
    14:{up:'保持身心平衡是健康關鍵。',rv:'生活失衡影響身心。'},
    17:{up:'健康好轉，充滿希望。',rv:'健康狀況需持續關注。'},
    19:{up:'身心能量充沛，健康狀態良好。',rv:'需注意過度消耗。'},
    53:{up:'身體需要休息，不要硬撐。',rv:'太焦躁，影響恢復。'},
    55:{up:'健康正在改善，度過低谷期。',rv:'健康恢復緩慢。'},
    58:{up:'焦慮影響睡眠和健康。',rv:'焦慮正在緩解。'}
  },
  relationship:{
    3:{up:'人際關係和諧，社交活躍。',rv:'人際圈過度消耗。'},
    6:{up:'重要的人際選擇，影響未來交友圈。',rv:'人際關係有衝突。'},
    11:{up:'人際互動公平，好人緣。',rv:'遭受不公對待。'},
    38:{up:'友誼歡樂，社交活動豐富。',rv:'過度社交導致疲憊。'},
    45:{up:'團隊和家庭關係圓滿。',rv:'人際紛爭。'},
    54:{up:'人際衝突需要面對和處理。',rv:'和解的可能性出現。'}
  }
};

function getTarotTypeMeaning(cardId, isUp, type){
  const tm=TAROT_TYPE_MEANING[type];
  if(tm&&tm[cardId]){
    return isUp?tm[cardId].up:tm[cardId].rv;
  }
  return null;
}

/* =============================================================
   ENHANCEMENT 4: 紫微亮度（廟旺利平陷）
   ============================================================= */
const ZW_BRIGHTNESS={
  // 簡化：紫微在各地支的廟旺（子丑寅卯辰巳午未申酉戌亥）
  '紫微':['廟','旺','得地','平','旺','得地','廟','旺','得地','平','得地','旺'],
  '天機':['平','廟','旺','廟','得地','平','陷','得地','旺','得地','平','廟'],
  '太陽':['陷','陷','平','旺','廟','廟','廟','旺','平','陷','陷','陷'],
  '武曲':['旺','廟','得地','陷','平','旺','得地','得地','廟','旺','得地','平'],
  '天同':['旺','平','陷','平','得地','得地','陷','平','得地','旺','廟','旺'],
  '廉貞':['得地','平','旺','陷','得地','平','得地','旺','廟','得地','平','旺'],
  '天府':['廟','得地','旺','得地','平','廟','旺','得地','旺','廟','得地','旺'],
  '太陰':['廟','廟','旺','旺','得地','平','陷','陷','陷','平','得地','旺'],
  '貪狼':['旺','平','廟','旺','得地','得地','陷','平','得地','旺','廟','旺'],
  '巨門':['旺','廟','得地','平','陷','旺','得地','平','廟','旺','得地','平'],
  '天相':['廟','得地','旺','旺','平','得地','旺','得地','廟','得地','旺','得地'],
  '天梁':['廟','旺','得地','平','得地','旺','廟','得地','旺','平','得地','旺'],
  '七殺':['廟','旺','平','得地','旺','得地','廟','得地','旺','平','得地','旺'],
  '破軍':['平','旺','廟','得地','旺','得地','平','旺','得地','旺','廟','得地']
};

function getStarBrightness(starName, zhiBranch){
  const idx=DZ.indexOf(zhiBranch);
  if(idx<0)return'';
  const arr=ZW_BRIGHTNESS[starName];
  if(!arr)return'';
  return arr[idx]||'';
}

/* =============================================================
   ENHANCEMENT 5: 增強 renderZiwei 加入亮度
   ============================================================= */
const _origRenderZiwei = renderZiwei;
renderZiwei = function(){
  _origRenderZiwei();
  // Post-process: add brightness tags
  if(!S.ziwei)return;
  S.ziwei.palaces.forEach(p=>{
    p.stars.forEach(s=>{
      if(s.type==='major'){
        s.brightness=getStarBrightness(s.name, p.branch);
      }
    });
  });
  // Re-render grid with brightness
  const zw=S.ziwei;
  const order=[[3,4,5,6],[2,-1,-1,7],[1,-1,-1,8],[0,11,10,9]];
  let html='<div class="zw-grid">';
  for(let row=0;row<4;row++){
    for(let col=0;col<4;col++){
      const idx=order[row][col];
      if(idx===-1){
        if(row===1&&col===1){
          html+=`<div class="zw-cell zw-center" style="grid-column:2/4;grid-row:2/4">
            <div class="serif text-gold" style="font-size:1.1rem;margin-bottom:var(--sp-sm)">紫微斗數</div>
            <p class="text-dim text-xs">命宮：${DZ[zw.mingIdx]}</p>
            <p class="text-dim text-xs">${zw.yGan}${zw.yZhi}年 ｜ ${zw.wuxingJu}局</p></div>`;
        }
        continue;
      }
      const palace=zw.palaces.find(p=>DZ.indexOf(p.branch)===idx);
      if(!palace){html+=`<div class="zw-cell"><span class="zw-palace">${DZ[idx]}</span></div>`;continue}
      const isMing=palace.isMing;
      html+=`<div class="zw-cell${isMing?' active-palace':''}">
        <div class="zw-palace">${palace.name}${isMing?' ⭐':''}</div>
        <div class="zw-branch">${palace.branch}</div><div class="zw-stars">`;
      palace.stars.forEach(s=>{
        const cls=s.type==='major'?'major':s.type==='sha'?'text-danger':'minor';
        const bright=s.brightness?`<span class="text-xs text-muted">(${s.brightness})</span>`:'';
        html+=`<span class="zw-star ${cls}">${s.name}${bright}</span>`;
        if(s.hua)html+=`<span class="zw-hua">${s.hua}</span>`;
      });
      html+=`</div></div>`;
    }
  }
  html+='</div>';
  document.getElementById('d-ziwei-grid').innerHTML=html;
};

/* =============================================================
   ENHANCEMENT 6: 增強 renderBazi 使用新大運
   ============================================================= */
const _origRenderBazi = renderBazi;
renderBazi = function(){
  _origRenderBazi();
  renderDayunEnhanced();
};

/* =============================================================
   ENHANCEMENT 7: 增強 renderTarot 加入類型交叉解讀
   ============================================================= */
const _origRenderTarot = renderTarot;
renderTarot = function(){
  if(!S.tarot.drawn.length){document.getElementById('r-tarot').innerHTML='<p class="text-dim">未進行塔羅抽牌</p>';return}
  const type=S.form.type;
  document.getElementById('r-tarot').innerHTML=S.tarot.drawn.map((c,i)=>{
    const typeMeaning=getTarotTypeMeaning(c.id,c.isUp,type);
    return`<div style="display:flex;gap:var(--sp-sm);align-items:flex-start;padding:var(--sp-sm) 0;border-bottom:1px solid var(--c-border)">
      <span class="tag tag-gold" style="flex:0 0 auto">${i+1}</span>
      <div><strong class="text-gold">${c.pos}</strong>：${c.n} <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'正':'逆'}</span>
      <p class="text-sm text-dim">${c.isUp?c.up:c.rv}</p>
      ${typeMeaning?`<p class="text-sm mt-sm" style="color:var(--c-gold-light)"><i class="fas fa-star" style="font-size:.6rem"></i> ${getTypeLabel(type)}解讀：${typeMeaning}</p>`:''}</div>
    </div>`;
  }).join('');
};

/* =============================================================
   ENHANCEMENT 8: 增強梅花結果加入爻辭
   ============================================================= */
const _origShowMH = showMH;
showMH = function(r){
  _origShowMH(r);
  // Append yao ci
  const yaoCi=getYaoCi(r.ben.n, r.dong);
  const detailEl=document.getElementById('mh-detail');
  if(detailEl){
    detailEl.innerHTML+=`<div class="divider"></div><p><strong>動爻爻辭（第${r.dong}爻）：</strong><span class="serif text-gold">${yaoCi}</span></p>`;
  }
};

/* =============================================================
   ENHANCEMENT 9: 列印 / 分享
   ============================================================= */
function printResult(){
  window.print();
}

function shareResult(){
  const prob=document.getElementById('r-vprob').textContent;
  const label=document.getElementById('r-vlabel').textContent;
  const text=`靜月之光占卜結果：${label} ${prob}\n問題：${S.form.question}\n\n（更多詳情請使用靜月之光能量占卜儀）`;
  if(navigator.share){
    navigator.share({title:'靜月之光占卜結果',text}).catch(()=>{});
  }else{
    navigator.clipboard.writeText(text).then(()=>alert('結果已複製到剪貼簿！')).catch(()=>{});
  }
  // Track share achievement
  if(typeof incrementAchievement==='function') incrementAchievement('shares',1);
}
/* =============================================================
   CUSTOM ORDER MODAL + FLOATING BUTTONS
   ============================================================= */
function openCustomModal(){
  document.getElementById('custom-modal').style.display='flex';
  document.getElementById('custom-form').style.display='block';
  document.getElementById('cf-sent').classList.add('hidden');
  // Pre-fill from analysis if available
  if(S.form.name)document.getElementById('cf-name').value=S.form.name;
  if(S.form.bdate)document.getElementById('cf-bday').value=S.form.bdate;
  if(S.form.question)document.getElementById('cf-question').value=S.form.question;
  document.body.style.overflow='hidden';
}
function closeCustomModal(){
  document.getElementById('custom-modal').style.display='none';
  document.body.style.overflow='';
}
// Close on overlay click
document.addEventListener('click',function(e){
  if(e.target.id==='custom-modal')closeCustomModal();
});

function submitCustomForm(e){e.preventDefault()} // deprecated, kept for safety

function prepareCustomSubmit(){
  const name=document.getElementById('cf-name').value.trim();
  if(!name)return false;

  // Set subject with name
  document.getElementById('cf-subject-hidden').value='【客製詢問】'+name+' - 能量手鏈';

  // Set _next to current page so user returns after submit
  document.getElementById('cf-next-url').value=window.location.href;

  // Build analysis summary
  let summary='';
  if(S.bazi){
    summary+='日主：'+S.bazi.dm+'（'+S.bazi.dmEl+'）| 身'+(S.bazi.strong?'強':'弱')+'\n';
    summary+='喜用神：'+S.bazi.fav.join('、')+'\n';
    summary+='忌神：'+S.bazi.unfav.join('、')+'\n';
    const curDy=S.bazi.dayun.find(d=>d.isCurrent);
    if(curDy)summary+='當前大運：'+curDy.gz+'（'+curDy.level+'）\n';
    if(S.bazi.shensha.length)summary+='神煞：'+S.bazi.shensha.join('、')+'\n';
    if(S.meihua)summary+='梅花：'+S.meihua.ben.n+'，體用'+S.meihua.ty.r+'（'+S.meihua.ty.f+'）\n';
    if(S.tarot.drawn.length)summary+='塔羅核心牌：'+S.tarot.drawn[0].n+'（'+(S.tarot.drawn[0].isUp?'正位':'逆位')+'）\n';
    const prob=document.getElementById('r-vprob');
    if(prob&&prob.textContent!=='0%')summary+='綜合機率：'+prob.textContent+'\n';
  }
  document.getElementById('cf-analysis-hidden').value=summary||'（使用者未完成占卜分析）';

  // Change button to loading
  const btn=document.getElementById('cf-submit-btn');
  btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> 送出中...';
  btn.disabled=true;

  return true; // allow form submission to formsubmit.co
}

function copyCfContent(){} // no longer needed but kept for safety

function toggleFab(){
  document.getElementById('fab-menu').classList.toggle('hidden');
}

/* =============================================================
   PWA: Inline Manifest + Service Worker Registration
   ============================================================= */
(function(){
  // Inline manifest as blob
  const manifest={
    name:'靜月之光能量占卜儀',
    short_name:'靜月占卜',
    description:'整合八字、紫微斗數、梅花易數、塔羅牌的多維度命理分析',
    start_url:'./',
    display:'standalone',
    background_color:'#0d0404',
    theme_color:'#0d0404',
    orientation:'portrait-primary',
    lang:'zh-TW',
    icons:[{src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">☽</text></svg>',sizes:'any',type:'image/svg+xml'}]
  };
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const link=document.createElement('link');
  link.rel='manifest';
  link.href=URL.createObjectURL(blob);
  document.head.appendChild(link);
})();

/* =============================================================
   KEYBOARD: Escape closes modal
   ============================================================= */
document.addEventListener('keydown',function(e){
  if(e.key==='Escape'){
    closeCustomModal();
    const fabMenu=document.getElementById('fab-menu');
    if(fabMenu&&!fabMenu.classList.contains('hidden'))fabMenu.classList.add('hidden');
  }
});
/* =============================================================
   FEATURE 1: 商品化水晶推薦（含賣場連結 + 商品類別）
   ============================================================= */
const PRODUCT_DB={
  金:[
    {n:'白水晶手鏈',cat:'手鏈',icon:'💎',el:'金',d:'淨化能量場，增強思維清晰度',price:'$580-$1,280',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'左手佩戴',img:''},
    {n:'鈦晶吊墜',cat:'吊墜',icon:'⚡',el:'金',d:'招正財偏財，增強領導氣魄',price:'$1,580-$3,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'貼近心輪佩戴',img:''},
    {n:'白水晶原石',cat:'原石',icon:'🔮',el:'金',d:'淨化空間磁場，鎮宅開運',price:'$380-$1,200',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放客廳或書桌',img:''}
  ],
  木:[
    {n:'綠幽靈手鏈',cat:'手鏈',icon:'💚',el:'木',d:'招正財，事業穩步上升',price:'$680-$2,200',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'左手佩戴',img:''},
    {n:'東陵玉吊墜',cat:'吊墜',icon:'🌿',el:'木',d:'舒緩壓力，帶來好運',price:'$480-$1,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'項鍊佩戴',img:''},
    {n:'翡翠原石擺件',cat:'原石',icon:'🟢',el:'木',d:'護身辟邪，增強健康運',price:'$1,200-$5,000',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放書桌或財位',img:''}
  ],
  水:[
    {n:'海藍寶手鏈',cat:'手鏈',icon:'💙',el:'水',d:'增強溝通力，平靜情緒',price:'$780-$2,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'左手佩戴',img:''},
    {n:'月光石吊墜',cat:'吊墜',icon:'🌙',el:'水',d:'增強直覺，助感情運',price:'$580-$1,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'滿月佩戴更佳',img:''},
    {n:'藍紋瑪瑙原石',cat:'原石',icon:'🔵',el:'水',d:'穩定情緒，增強表達力',price:'$350-$980',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放臥室床頭',img:''}
  ],
  火:[
    {n:'紅瑪瑙手鏈',cat:'手鏈',icon:'❤️',el:'火',d:'激發熱情，增強行動力與勇氣',price:'$480-$1,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'右手佩戴增行動力',img:''},
    {n:'石榴石吊墜',cat:'吊墜',icon:'🔴',el:'火',d:'提升活力，增強桃花運',price:'$680-$2,200',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'貼身佩戴',img:''},
    {n:'紅碧璽原石',cat:'原石',icon:'💗',el:'火',d:'強力招桃花，增強人際魅力',price:'$1,500-$4,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放桃花位',img:''}
  ],
  土:[
    {n:'黃水晶手鏈',cat:'手鏈',icon:'💛',el:'土',d:'招偏財，提升自信與魅力',price:'$580-$1,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'左手佩戴',img:''},
    {n:'虎眼石吊墜',cat:'吊墜',icon:'🟤',el:'土',d:'增強決斷力，招財辟邪',price:'$480-$1,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'出門佩戴',img:''},
    {n:'茶晶原石擺件',cat:'原石',icon:'🍵',el:'土',d:'排除負能量，穩定心性',price:'$680-$2,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放客廳',img:''}
  ]
};

// 問題類型特殊商品
const TYPE_PRODUCTS={
  love:[{n:'粉晶手鏈',cat:'手鏈',icon:'💕',el:'土',d:'招桃花首選！增強異性緣',price:'$480-$1,500',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'左手佩戴，約會必備'}],
  career:[{n:'鈦晶手鏈',cat:'手鏈',icon:'⚡',el:'金',d:'事業晉升首選！領導力UP',price:'$1,800-$5,000',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'面試/開會佩戴'}],
  wealth:[{n:'綠幽靈聚寶盆',cat:'原石',icon:'💰',el:'木',d:'招正財偏財！放辦公桌超旺',price:'$1,200-$3,800',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'放財位或收銀台'}],
  health:[{n:'紫水晶手鏈',cat:'手鏈',icon:'💜',el:'火',d:'安神助眠，促進身心平衡',price:'$580-$1,800',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'睡前佩戴或放枕下'}]
};

function renderProductCrystal(bazi,type){
  const need=bazi.fav[0];
  const base=PRODUCT_DB[need]||PRODUCT_DB['土'];
  const special=TYPE_PRODUCTS[type]||[];
  const all=[...special,...base];
  const display=all.slice(0,4);

  const catIcon={手鏈:'⌚',吊墜:'📿',原石:'💎',客製:'✨'};

  document.getElementById('r-crystal').innerHTML=`
    <div class="crystal-rec-header">
      <p>根據你的命盤（喜 <span class="tag tag-gold">${need}行</span>）和問題（<span class="tag tag-blue">${getTypeLabel(type)}</span>），為你配對：</p>
    </div>
    <div class="product-grid">${display.map(p=>`
      <div class="product-card">
        <div class="product-icon">${p.icon}</div>
        <div class="product-body">
          <div class="product-name">${p.n}</div>
          <div class="product-meta">
            <span class="tag tag-gold text-xs">${catIcon[p.cat]||''} ${p.cat}</span>
            <span class="el-tag el-${p.el} text-xs">${p.el}行</span>
          </div>
          <p class="product-desc">${p.d}</p>
          <p class="product-price">${p.price}</p>
          <p class="product-wear"><i class="fas fa-hand-holding-heart"></i> ${p.wear}</p>
          <div class="product-actions">
            <a href="${p.shopee}" target="_blank" rel="noopener" class="product-btn shopee"><i class="fas fa-shopping-cart"></i> 蝦皮</a>
            <a href="${p.seven}" target="_blank" rel="noopener" class="product-btn seven"><i class="fas fa-box"></i> 7-11</a>
          </div>
        </div>
      </div>`).join('')}
    </div>
    <div class="custom-cta mt-lg">
      <button class="btn btn-gold btn-full" onclick="openCustomModal()">
        <i class="fas fa-magic"></i> 想要「依你五行專屬搭配」？點我客製手鏈
      </button>
      <p class="text-xs text-muted mt-sm text-center">預算版 $1,000 起 ｜ 48hr 內回覆</p>
    </div>
    <p class="text-xs text-muted mt-md text-center"><i class="fas fa-info-circle"></i> 本建議僅供能量校準參考，不具醫療或命運保證效力。</p>`;
}

/* =============================================================
   FEATURE 2: 結果圖卡 Canvas → 存圖（含 QR 導流）
   ============================================================= */
function generateResultCard(){
  const canvas=document.createElement('canvas');
  const W=750,H=1334; // IG story size
  canvas.width=W;canvas.height=H;
  const ctx=canvas.getContext('2d');

  // Background gradient
  const grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,'#2D0A0A');grad.addColorStop(0.5,'#4A0000');grad.addColorStop(1,'#0d0404');
  ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);

  // Decorative border
  ctx.strokeStyle='rgba(212,175,55,0.4)';ctx.lineWidth=3;
  ctx.strokeRect(24,24,W-48,H-48);
  ctx.strokeStyle='rgba(212,175,55,0.15)';ctx.lineWidth=1;
  ctx.strokeRect(36,36,W-72,H-72);

  // Header
  ctx.fillStyle='#D4AF37';ctx.font='bold 32px "Noto Serif TC",serif';ctx.textAlign='center';
  ctx.fillText('☽ 靜月之光能量占卜儀',W/2,80);
  ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.6)';
  ctx.fillText('你的專屬命理分析結果',W/2,115);

  // Divider
  drawGoldLine(ctx,60,140,W-60);

  // Question
  ctx.textAlign='left';ctx.font='bold 22px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('📋 問題',60,180);
  ctx.font='18px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.9)';
  wrapText(ctx,S.form.question||'綜合運勢',60,210,W-120,26);

  // Verdict
  const prob=document.getElementById('r-vprob')?document.getElementById('r-vprob').textContent:'50%';
  const label=document.getElementById('r-vlabel')?document.getElementById('r-vlabel').textContent:'分析中';
  const y1=290;
  ctx.fillStyle='rgba(212,175,55,0.1)';roundRect(ctx,48,y1-10,W-96,100,12);ctx.fill();
  ctx.strokeStyle='rgba(212,175,55,0.3)';ctx.stroke();
  ctx.font='bold 40px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';ctx.textAlign='center';
  ctx.fillText(prob,W/2,y1+35);
  ctx.font='20px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.85)';
  ctx.fillText(label,W/2,y1+70);

  // BaZi summary
  const y2=420;
  ctx.textAlign='left';ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('🏮 八字命理',60,y2);
  if(S.bazi){
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.8)';
    const p=S.bazi.pillars;
    ctx.fillText(`四柱：${p.year.gan}${p.year.zhi} ${p.month.gan}${p.month.zhi} ${p.day.gan}${p.day.zhi} ${p.hour.gan}${p.hour.zhi}`,60,y2+30);
    ctx.fillText(`日主：${S.bazi.dm}（${S.bazi.dmEl}）｜ 身${S.bazi.strong?'強':'弱'} ｜ 喜用：${S.bazi.fav.join('、')}`,60,y2+58);
    const curDy=S.bazi.dayun.find(d=>d.isCurrent);
    if(curDy)ctx.fillText(`當前大運：${curDy.gz}（${curDy.level}）`,60,y2+86);
  }

  // Five elements bar
  const y3=560;
  ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('🔮 五行能量',60,y3);
  if(S.bazi){
    const els=['金','木','水','火','土'];
    const colors={金:'#c0c0c0',木:'#22c55e',水:'#3b82f6',火:'#ef4444',土:'#a78b5a'};
    els.forEach((e,i)=>{
      const bx=60,by=y3+25+i*32,bw=W-200,pct=S.bazi.ep[e]||0;
      ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle=colors[e];
      ctx.fillText(e,bx,by+14);
      ctx.fillStyle='rgba(255,255,255,0.1)';roundRect(ctx,bx+30,by,bw,18,4);ctx.fill();
      ctx.fillStyle=colors[e];roundRect(ctx,bx+30,by,bw*pct/100,18,4);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.7)';ctx.fillText(pct+'%',bx+bw+40,by+14);
    });
  }

  // Crystal recommendation
  const y4=760;
  ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('💎 專屬水晶處方',60,y4);
  if(S.bazi){
    const need=S.bazi.fav[0];
    const prods=PRODUCT_DB[need]||PRODUCT_DB['土'];
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.85)';
    prods.slice(0,3).forEach((p,i)=>{
      ctx.fillText(`${p.icon} ${p.n}（${p.cat}）— ${p.d}`,60,y4+30+i*28);
    });
  }

  // Meihua + Tarot summary
  const y5=880;
  if(S.meihua){
    ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
    ctx.fillText('☯ 梅花易數',60,y5);
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.8)';
    ctx.fillText(`${S.meihua.ben.n} → ${S.meihua.bian.n}｜體用${S.meihua.ty.r}（${S.meihua.ty.f}）`,60,y5+28);
  }
  if(S.tarot.drawn.length){
    const yt=y5+70;
    ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
    ctx.fillText('🃏 塔羅牌',60,yt);
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.8)';
    const core=S.tarot.drawn[0],fin=S.tarot.drawn[9];
    ctx.fillText(`核心：${core.n}（${core.isUp?'正':'逆'}）｜ 結果：${fin?fin.n:''}（${fin?(fin.isUp?'正':'逆'):''}）`,60,yt+28);
  }

  // Divider
  drawGoldLine(ctx,60,1060,W-60);

  // QR Code area (text-based since we can't load QR library)
  const yq=1090;
  ctx.fillStyle='rgba(255,255,255,0.05)';roundRect(ctx,W/2-160,yq,320,100,12);ctx.fill();
  ctx.strokeStyle='rgba(212,175,55,0.3)';ctx.stroke();
  ctx.font='bold 16px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';ctx.textAlign='center';
  ctx.fillText('🔍 免費測你的命理結果',W/2,yq+30);
  ctx.font='14px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.7)';
  ctx.fillText('靜月之光能量占卜儀',W/2,yq+55);
  ctx.font='12px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.5)';
  ctx.fillText(window.location.href.split('?')[0],W/2,yq+78);

  // Footer
  ctx.font='12px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.35)';
  ctx.fillText('🛒 蝦皮: tw.shp.ee/2n5Mo2w ｜ 📦 7-11賣貨便: 搜尋「靜月之光」',W/2,H-50);
  ctx.fillText(`生成時間：${new Date().toLocaleDateString('zh-TW')}`,W/2,H-30);

  return canvas;
}

function drawGoldLine(ctx,x1,y,x2){
  const g=ctx.createLinearGradient(x1,y,x2,y);
  g.addColorStop(0,'transparent');g.addColorStop(0.5,'rgba(212,175,55,0.6)');g.addColorStop(1,'transparent');
  ctx.strokeStyle=g;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(x1,y);ctx.lineTo(x2,y);ctx.stroke();
}

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

function wrapText(ctx,text,x,y,maxW,lineH){
  const chars=[...text];let line='';
  for(let i=0;i<chars.length;i++){
    const test=line+chars[i];
    if(ctx.measureText(test).width>maxW&&line){ctx.fillText(line,x,y);y+=lineH;line=chars[i]}
    else line=test;
  }
  if(line)ctx.fillText(line,x,y);
}

function saveResultCard(){
  const canvas=generateResultCard();
  canvas.toBlob(function(blob){
    if(!blob)return;
    // Try native share first (mobile)
    if(navigator.share&&navigator.canShare){
      const file=new File([blob],'靜月占卜結果.png',{type:'image/png'});
      if(navigator.canShare({files:[file]})){
        navigator.share({title:'我的靜月占卜結果',text:'免費測你的命理結果！',files:[file]}).catch(()=>downloadBlob(blob));
        return;
      }
    }
    downloadBlob(blob);
  },'image/png');
}

function downloadBlob(blob){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='靜月占卜結果_'+Date.now()+'.png';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),3000);
}

/* =============================================================
   FEATURE 3: 分享解鎖「再測一次」
   ============================================================= */
let hasShared=false;

function shareToUnlock(){
  const url=window.location.href.split('?')[0];
  const text='我剛用「靜月之光」測了命理結果，超準！免費測你的 👉 ';

  if(navigator.share){
    navigator.share({title:'靜月之光占卜',text:text,url:url}).then(()=>{
      // User actually shared (confirmed by OS share sheet)
      hasShared=true;
      updateShareGate();
    }).catch(()=>{
      // User cancelled share — do NOT unlock
      // Show a gentle message
      showShareHint('分享取消了，要解鎖「再測一次」請完成分享哦 😊');
    });
  }else{
    // No native share — show copy dialog with confirmation
    showCopyShareDialog(text+url);
  }
}

function showShareHint(msg){
  const gate = document.getElementById('share-gate');
  if(!gate) return;
  let hint = gate.querySelector('.share-hint-msg');
  if(!hint){
    hint = document.createElement('p');
    hint.className = 'share-hint-msg';
    hint.style.cssText = 'color:rgba(232,201,104,0.8);font-size:0.85rem;margin-top:0.5rem;';
    gate.appendChild(hint);
  }
  hint.textContent = msg;
  setTimeout(()=>{ if(hint) hint.textContent=''; }, 4000);
}

function showCopyShareDialog(text){
  // Step 1: Copy to clipboard
  navigator.clipboard.writeText(text).then(()=>{
    // Step 2: Ask user to confirm they've pasted & shared
    const confirmed = confirm(
      '分享連結已複製到剪貼簿！✨\n\n' +
      '請貼到 LINE / IG / FB 分享給朋友。\n\n' +
      '已經分享了嗎？按「確定」解鎖再測一次。'
    );
    if(confirmed){
      hasShared=true;
      updateShareGate();
    } else {
      showShareHint('把連結貼給朋友後，再按一次分享按鈕即可解鎖 ✨');
    }
  }).catch(()=>{
    prompt('複製以下連結分享給朋友：', text);
    // Don't auto-unlock on prompt fallback either
    showShareHint('分享給朋友後，再按一次即可解鎖 ✨');
  });
}

function fallbackCopyShare(text){
  // Keep for backward compat but don't auto-unlock
  navigator.clipboard.writeText(text).catch(()=>{});
}

function updateShareGate(){
  const gate=document.getElementById('share-gate');
  const retestBtn=document.getElementById('btn-retest');
  if(gate&&retestBtn){
    if(hasShared){
      gate.classList.add('hidden');
      retestBtn.classList.remove('hidden');
    }
  }
}

function retestAfterShare(){
  hasShared=false;
  drawnCards=[];
  resetAll();
}
// 實際商品庫 — 依五行分類，取代表性品項（同名取價格帶）
const REAL_PRODUCTS = {
  金: [
    // 白水晶系列
    {n:'白水晶',cat:'手鏈',icon:'💎',el:'金',d:'淨化能量場，增強思維清晰度，萬能調和石',price:'$320-$396',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白水晶手排',cat:'手鏈',icon:'💎',el:'金',d:'大顆粒排珠，淨化能量更強，適合辦公佩戴',price:'$396',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'鑽切白水晶',cat:'手鏈',icon:'✨',el:'金',d:'切割面折射光芒，提升靈性能量與專注力',price:'$320',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'鈦晶手排',cat:'手鏈',icon:'⚡',el:'金',d:'招正財偏財首選！增強領導力與決斷力',price:'$3,334-$21,950',wear:'面試/簽約時佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白水晶鳳凰項鍊',cat:'項鍊',icon:'🔮',el:'金',d:'鳳凰涅槃，淨化+重生能量，收藏級項鍊',price:'$3,372',wear:'貼近心輪佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'金髮晶',cat:'手鏈',icon:'🌟',el:'金',d:'招財旺事業，金色髮絲象徵財富能量',price:'$761',wear:'左手佩戴招財',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白幽靈',cat:'手鏈',icon:'💠',el:'金',d:'淨化磁場，提升靈性直覺力',price:'$396',wear:'冥想時佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白阿賽設計款',cat:'手鏈',icon:'💫',el:'金',d:'高頻能量石，提升靈性連結與直覺',price:'$420',wear:'冥想/靜心時佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'透石膏',cat:'手鏈',icon:'🗿',el:'金',d:'淨化空間能量，帶來心靈平靜',price:'$358',wear:'放臥室或隨身',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  木: [
    {n:'綠幽靈',cat:'手鏈',icon:'💚',el:'木',d:'招正財首選！事業穩步上升，上班族必備',price:'$684-$10,668',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'抹茶幽靈',cat:'手鏈',icon:'🍵',el:'木',d:'稀有抹茶色幽靈，招正財+安定心性',price:'$8,748',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠碧璽',cat:'手鏈',icon:'🟢',el:'木',d:'旺事業財運，激發創造力',price:'$1,644',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'東陵玉',cat:'手鏈',icon:'🌿',el:'木',d:'舒緩壓力，帶來好運與正能量',price:'$176',wear:'隨身佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠髮晶手排',cat:'手鏈',icon:'🌱',el:'木',d:'招正財+貴人，髮絲代表生長能量',price:'$4,332',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠水晶隨型',cat:'手鏈',icon:'💎',el:'木',d:'天然隨型綠水晶，招正財聚能量',price:'$2,028',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'四季幽靈手排',cat:'手鏈',icon:'🌈',el:'木',d:'四季色彩幽靈，全方位招財開運',price:'$2,988',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠龍晶',cat:'手鏈',icon:'🐉',el:'木',d:'天然龍紋，旺事業+護身辟邪',price:'$1,068-$2,028',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠檀木手鍊',cat:'手鏈',icon:'🌳',el:'木',d:'天然檀木清香，安神定氣，適合修行佩戴',price:'$224-$492',wear:'隨身佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠月光',cat:'手鏈',icon:'🌕',el:'木',d:'稀有綠色月光石，增強直覺+招好運',price:'$108',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  水: [
    {n:'海藍寶',cat:'手鏈',icon:'💙',el:'水',d:'增強溝通力，平靜情緒，談判必備',price:'$2,028-$23,825',wear:'佩戴在喉輪附近最佳',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'海藍寶手排',cat:'手鏈',icon:'🌊',el:'水',d:'大顆粒海藍寶，溝通力與勇氣加倍',price:'$2,988',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'月光石',cat:'手鏈',icon:'🌙',el:'水',d:'增強直覺，助感情運，柔化個性',price:'$9,708',wear:'滿月佩戴效果更佳',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍玉髓',cat:'手鏈',icon:'🔵',el:'水',d:'穩定情緒，增強語言表達力',price:'$588',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍彼得石圓珠',cat:'手鏈',icon:'🌀',el:'水',d:'暴風雨石！激發洞察力與變革勇氣',price:'$9,708',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍磷灰',cat:'手鏈',icon:'💎',el:'水',d:'增強意志力與目標感，學習考試佳',price:'$396',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'堇青石',cat:'手鏈',icon:'🔮',el:'水',d:'指引方向之石，幫助做出正確決定',price:'$875',wear:'需要決策時佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍方解石',cat:'手鏈',icon:'💠',el:'水',d:'溝通之石，打開喉輪，增強表達',price:'$300',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'青晶石',cat:'手鏈',icon:'🌌',el:'水',d:'開啟第三眼，增強直覺與靈性感知',price:'$2,604',wear:'冥想時佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'冰藍小熊',cat:'吊墜',icon:'🧸',el:'水',d:'可愛造型冰藍石，療癒安心，送禮首選',price:'$506',wear:'項鍊佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  火: [
    {n:'紅瑪瑙',cat:'手鏈',icon:'❤️',el:'火',d:'激發熱情，增強行動力與勇氣',price:'$300-$454',wear:'右手佩戴增行動力',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅瑪瑙設計款',cat:'手鏈',icon:'💗',el:'火',d:'設計師款紅瑪瑙，熱情+時尚兼具',price:'$1,260',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫水晶',cat:'手鏈',icon:'💜',el:'火',d:'安神助眠，穩定情緒，靈性提升首選',price:'$588-$1,606',wear:'睡前佩戴或放枕下',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅虎眼',cat:'手鏈',icon:'🔴',el:'火',d:'增強意志力與行動力，辟邪擋煞',price:'$435',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅花碧玉手排',cat:'手鏈',icon:'🌺',el:'火',d:'天然花紋碧玉，增強生命力與穩定感',price:'$464',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫牙烏',cat:'手鏈',icon:'🍇',el:'火',d:'石榴石系列，提升活力與桃花運',price:'$1,952',wear:'貼身佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'粉紅碧璽圓珠',cat:'手鏈',icon:'💕',el:'火',d:'強力招桃花！增強人際魅力',price:'$13,548',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'薔薇石',cat:'手鏈',icon:'🌹',el:'火',d:'愛情療癒石，修復心輪，招桃花',price:'$1,798',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'煙花雨薔薇石',cat:'手鏈',icon:'🎆',el:'火',d:'獨特煙花紋理，療癒心靈+招桃花',price:'$2,220',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫龍晶',cat:'手鏈',icon:'🐲',el:'火',d:'智慧+靈性提升，紫色龍紋獨特美感',price:'$646',wear:'冥想佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫金砂',cat:'手鏈',icon:'✨',el:'火',d:'閃耀紫金光，辟邪+提升靈性',price:'$339',wear:'隨身佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'利比亞黃金隕石',cat:'手鏈',icon:'☄️',el:'火',d:'來自宇宙的能量！極強顯化力與意志力',price:'$1,644',wear:'冥想/許願時佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  土: [
    {n:'黃水晶',cat:'手鏈',icon:'💛',el:'土',d:'招偏財首選！提升自信與個人魅力',price:'$233-$492',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'茶晶',cat:'手鏈',icon:'🍵',el:'土',d:'排除負能量，穩定心性，接地氣',price:'$684-$742',wear:'佩戴或放客廳',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'虎眼石（藍）',cat:'手鏈',icon:'🐯',el:'土',d:'增強決斷力，招財辟邪，穩定心性',price:'$7,600',wear:'右手佩戴增氣場',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'阿拉善',cat:'手鏈',icon:'🗿',el:'土',d:'戈壁能量石，穩定+接地+增強耐力',price:'$281-$454',wear:'隨身佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'太極石設計款',cat:'手鏈',icon:'☯️',el:'土',d:'陰陽平衡之石，調和身心能量場',price:'$1,836',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'金曜石',cat:'手鏈',icon:'🌑',el:'土',d:'辟邪擋煞首選！金色閃光護身符',price:'$416',wear:'右手佩戴辟邪',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'大地瑪瑙手排',cat:'手鏈',icon:'🟤',el:'土',d:'大地能量，穩定踏實，增強耐力',price:'$300',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'鐵膽石手排',cat:'手鏈',icon:'🗿',el:'土',d:'極強接地能量，排負+穩定心性',price:'$185',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白水茶晶設計款',cat:'手鏈',icon:'☕',el:'土',d:'白水晶+茶晶組合，淨化+穩定雙效',price:'$506',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  // 跨五行特殊商品
  special: [
    {n:'彩超七',cat:'手鏈',icon:'🌈',el:'全',d:'七種礦物共生！全方位開運招財',price:'$972-$41,325',wear:'左手佩戴',tags:['全能','招財'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'多寶隕石手鍊',cat:'手鏈',icon:'☄️',el:'全',d:'多種隕石能量集合，宇宙級防護',price:'$5,484',wear:'左手佩戴',tags:['辟邪','全能'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'天鐵五行設計款',cat:'手鏈',icon:'⚔️',el:'全',d:'天鐵（隕鐵）+五行元素，強力護身開運',price:'$5,484',wear:'左手佩戴',tags:['五行','辟邪'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'銀曜石五行設計款',cat:'手鏈',icon:'🌟',el:'全',d:'銀曜石+五行配色，辟邪+五行平衡',price:'$3,622',wear:'右手佩戴',tags:['五行','辟邪'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩色天鐵手鍊',cat:'手鏈',icon:'🌈',el:'全',d:'彩色天鐵，宇宙能量+藝術美感',price:'$4,548-$10,308',wear:'左手佩戴',tags:['全能'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'骨幹太陽石',cat:'手鏈',icon:'☀️',el:'火',d:'正能量之王！自信、領導力、活力全開',price:'$2,777',wear:'日間佩戴',tags:['事業','自信'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'金太陽',cat:'手鏈',icon:'🌞',el:'火',d:'金色太陽光芒，招正財+增強領導力',price:'$8,748-$21,325',wear:'左手佩戴',tags:['財運','事業'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'情侶對鍊',cat:'項鍊',icon:'💑',el:'全',d:'情侶款對鍊，感情加溫必備',price:'$1,226',wear:'成對佩戴',tags:['愛情'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'老山檀香圓珠',cat:'手鏈',icon:'📿',el:'土',d:'百年老山檀香，安神助眠，靜心修行',price:'$3,756',wear:'念佛/冥想佩戴',tags:['健康','靈性'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'沉香無事牌',cat:'吊墜',icon:'🏷️',el:'木',d:'無事牌寓意平安無事，沉香安神定氣',price:'$492',wear:'項鍊佩戴',tags:['平安','健康'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  // 項鍊吊墜
  necklace: [
    {n:'銀曜項鍊（關公）',cat:'項鍊',icon:'⚔️',el:'土',d:'關公護身，招財辟邪，生意人必備',price:'$492',wear:'出門佩戴',tags:['財運','辟邪'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'金曜項鍊（龍牌）',cat:'項鍊',icon:'🐉',el:'土',d:'龍牌護身符，氣場強大，事業亨通',price:'$492',wear:'出門佩戴',tags:['事業','辟邪'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'銀曜項鍊（九尾狐）',cat:'項鍊',icon:'🦊',el:'土',d:'九尾狐招桃花，增強魅力與異性緣',price:'$492',wear:'約會佩戴',tags:['愛情','桃花'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑曜項鍊無事牌',cat:'項鍊',icon:'🏷️',el:'土',d:'黑曜石無事牌，辟邪+平安',price:'$469',wear:'隨身佩戴',tags:['平安','辟邪'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑曜磨砂心經',cat:'項鍊',icon:'📿',el:'土',d:'心經護身符，辟邪化煞，安定心神',price:'$204-$377',wear:'隨身佩戴',tags:['辟邪','平安'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  // 辟邪系列
  protection: [
    {n:'黑閃靈',cat:'手鏈',icon:'⚫',el:'土',d:'超強辟邪擋煞，排除一切負能量',price:'$1,798',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩閃靈',cat:'手鏈',icon:'🌈',el:'全',d:'辟邪+開運雙效，彩色閃靈能量全面',price:'$4,908',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩虹黑曜石',cat:'手鏈',icon:'🌈',el:'土',d:'黑曜石中的極品，辟邪+七彩光芒',price:'$1,882',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑碧璽三圈',cat:'手鏈',icon:'⬛',el:'土',d:'三圈纏繞設計，全面辟邪防護',price:'$588',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'西北非隕石',cat:'手鏈',icon:'☄️',el:'全',d:'外太空隕石能量，護身辟邪極強',price:'$1,068-$1,184',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  // 桃花系列
  love_special: [
    {n:'粉晶',cat:'手鏈',icon:'💕',el:'土',d:'招桃花首選！增強感情運與人際魅力',price:'$204-$272',wear:'左手佩戴，約會必備',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'星光草莓晶',cat:'手鏈',icon:'🍓',el:'火',d:'增強異性緣，帶來甜蜜戀愛機會',price:'$300-$454',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩色草莓晶',cat:'手鏈',icon:'🍇',el:'火',d:'多色草莓晶，全面提升人際與桃花運',price:'$608',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'摩根石',cat:'手鏈',icon:'💗',el:'水',d:'高頻愛情石，溫柔療癒，吸引真愛',price:'$300',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ]
};
/* =============================================================
   智慧推薦引擎 — 取代 PRODUCT_DB + TYPE_PRODUCTS
   根據：喜用神 × 問題類型 × 價格帶分佈 推薦最佳商品
   ============================================================= */
function smartRecommend(bazi, type, maxItems){
  maxItems = maxItems || 6;
  const need = bazi.fav[0]; // 喜用神第一位
  const need2 = bazi.fav[1]; // 喜用神第二位
  
  // ** 關鍵修正：取得忌神列表，排除忌神五行的商品 **
  const avoidEls = new Set();
  if(bazi.unfav){
    bazi.unfav.forEach(u => avoidEls.add(u));
  }
  
  const results = [];
  const seen = new Set();

  function isAllowed(item){
    // 五行「全」的商品永遠允許
    if(item.el === '全') return true;
    // 忌神五行的商品排除
    if(avoidEls.has(item.el)) return false;
    return true;
  }

  function add(item, priority){
    if(seen.has(item.n)) return;
    if(!isAllowed(item)) return; // 忌神排除
    seen.add(item.n);
    results.push({...item, _priority: priority||0});
  }

  // 1) 問題類型特殊推薦（最高優先，但仍受忌神過濾）
  if(type==='love'){
    (REAL_PRODUCTS.love_special||[]).forEach(p=>add(p,100));
    (REAL_PRODUCTS.necklace||[]).filter(p=>(p.tags||[]).includes('愛情')).forEach(p=>add(p,90));
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('愛情')).forEach(p=>add(p,85));
  }
  if(type==='career'){
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('事業')).forEach(p=>add(p,100));
    (REAL_PRODUCTS.金||[]).filter(p=>p.n.includes('鈦晶')).forEach(p=>add(p,95));
    (REAL_PRODUCTS.necklace||[]).filter(p=>(p.tags||[]).includes('事業')).forEach(p=>add(p,85));
  }
  if(type==='wealth'){
    (REAL_PRODUCTS.土||[]).filter(p=>p.n.includes('黃水晶')).forEach(p=>add(p,100));
    (REAL_PRODUCTS.木||[]).filter(p=>p.n.includes('綠幽靈')||p.n.includes('抹茶')).forEach(p=>add(p,95));
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('財運')).forEach(p=>add(p,90));
    (REAL_PRODUCTS.金||[]).filter(p=>p.n.includes('鈦晶')).forEach(p=>add(p,85));
  }
  if(type==='health'){
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('健康')).forEach(p=>add(p,100));
    (REAL_PRODUCTS.火||[]).filter(p=>p.n.includes('紫水晶')).forEach(p=>add(p,95));
    (REAL_PRODUCTS.土||[]).filter(p=>p.n.includes('茶晶')).forEach(p=>add(p,85));
  }

  // 2) 喜用神五行商品（一定是安全的，因為喜用神不會是忌神）
  const elProducts = REAL_PRODUCTS[need] || [];
  elProducts.forEach(p => add(p, 70));
  if(need2 && REAL_PRODUCTS[need2]){
    REAL_PRODUCTS[need2].slice(0,3).forEach(p => add(p, 50));
  }

  // 3) 五行設計款 / 超七（全方位，el='全' 永遠允許）
  (REAL_PRODUCTS.special||[]).filter(p=>p.el==='全').forEach(p=>add(p,40));

  // 4) 辟邪類（凶的時候優先，也要過濾忌神）
  const prob = parseFloat((document.getElementById('r-vprob')||{}).textContent)||50;
  if(prob < 40){
    (REAL_PRODUCTS.protection||[]).forEach(p=>add(p,80));
  }

  // 5) 項鍊類補充（過濾忌神）
  (REAL_PRODUCTS.necklace||[]).forEach(p=>add(p,20));

  // Sort by priority desc, then pick top N
  results.sort((a,b)=>b._priority-a._priority);

  // Ensure price diversity: at least 1 under $500, 1 mid, 1 high
  const final = [];
  const low = results.filter(r=>{const p=parseFloat(r.price.replace(/[^0-9]/g,''));return p<=500});
  const mid = results.filter(r=>{const p=parseFloat(r.price.replace(/[^0-9]/g,''));return p>500&&p<=3000});
  const high = results.filter(r=>{const p=parseFloat(r.price.replace(/[^0-9]/g,''));return p>3000});

  if(low[0]) final.push(low[0]);
  if(mid[0]) final.push(mid[0]);
  if(high[0]) final.push(high[0]);

  // Fill remaining from sorted results
  results.forEach(r=>{
    if(final.length>=maxItems) return;
    if(!final.find(f=>f.n===r.n)) final.push(r);
  });

  return final.slice(0, maxItems);
}

/* Override renderProductCrystal to use smart recommend */
const _origRenderProductCrystal = typeof renderProductCrystal === 'function' ? renderProductCrystal : null;
renderProductCrystal = function(bazi, type){
  const need = bazi.fav[0];
  const products = smartRecommend(bazi, type, 6);
  const catIcon = {手鏈:'⌚', 項鍊:'📿', 吊墜:'🏷️', 原石:'💎', 客製:'✨'};

  document.getElementById('r-crystal').innerHTML = `
    <div class="crystal-rec-header">
      <p>根據你的命盤（喜用 <span class="tag tag-gold">${need}行</span>）和問題（<span class="tag tag-blue">${getTypeLabel(type)}</span>），從我們賣場精選：</p>
    </div>
    <div class="product-grid">${products.map(p=>`
      <div class="product-card">
        <div class="product-icon">${p.icon}</div>
        <div class="product-body">
          <div class="product-name">${p.n}</div>
          <div class="product-meta">
            <span class="tag tag-gold text-xs">${catIcon[p.cat]||'💎'} ${p.cat}</span>
            ${p.el!=='全'?`<span class="el-tag el-${p.el} text-xs">${p.el}行</span>`:'<span class="tag text-xs" style="background:linear-gradient(90deg,#c00,#fc0,#0a0,#08f,#a78b5a);color:#fff;-webkit-background-clip:text;-webkit-text-fill-color:transparent;border:1px solid rgba(212,175,55,.4)">五行全</span>'}
          </div>
          <p class="product-desc">${p.d}</p>
          <p class="product-price">${p.price}</p>
          <p class="product-wear"><i class="fas fa-hand-holding-heart"></i> ${p.wear}</p>
          <div class="product-actions">
            <a href="${p.shopee}" target="_blank" rel="noopener" class="product-btn shopee"><i class="fas fa-shopping-cart"></i> 蝦皮</a>
            <a href="${p.seven}" target="_blank" rel="noopener" class="product-btn seven"><i class="fas fa-box"></i> 7-11</a>
          </div>
        </div>
      </div>`).join('')}
    </div>
    <div class="custom-cta mt-lg">
      <button class="btn btn-gold btn-full" onclick="openCustomModal()">
        <i class="fas fa-magic"></i> 想要「依你五行專屬搭配」？點我客製手鏈
      </button>
      <p class="text-xs text-muted mt-sm text-center">預算版 $1,000 起 ｜ 48hr 內回覆 ｜ 含占卜分析摘要</p>
    </div>
    <p class="text-xs text-muted mt-md text-center"><i class="fas fa-info-circle"></i> 以上商品皆為賣場現貨。點擊蝦皮或7-11直接選購，水晶效果因人而異。</p>`;
};
/* =============================================================
   1) 商品卡「限時提醒」— 庫存數 + 今日N人看過
   ============================================================= */
function getUrgencyHTML(productName){
  // Seeded random based on product name + today's date (consistent per day)
  const seed = productName.split('').reduce((a,c)=>a+c.charCodeAt(0),0) + new Date().getDate();
  const stock = (seed % 7) + 1; // 1-7
  const views = (seed * 7 + 13) % 40 + 15; // 15-54
  const stockClass = stock <= 3 ? 'urgency-critical' : 'urgency-normal';
  return `<div class="urgency-strip">
    <span class="${stockClass}"><i class="fas fa-fire"></i> 僅剩 ${stock} 件</span>
    <span class="urgency-views"><i class="fas fa-eye"></i> 今日 ${views} 人看過</span>
  </div>`;
}

/* =============================================================
   2) 社會認同數據
   ============================================================= */
function getSocialProofHTML(element, type){
  const elMap = {金:68, 木:72, 水:58, 火:63, 土:71};
  const typeMap = {love:74, career:69, wealth:76, health:62, general:65, relationship:70, family:67, other:60};
  const elPct = elMap[element] || 65;
  const typePct = typeMap[type] || 65;
  // Randomize slightly per session
  const r1 = elPct + (Math.floor(Math.random()*5)-2);
  const r2 = typePct + (Math.floor(Math.random()*5)-2);
  return `<div class="social-proof">
    <div class="sp-item"><i class="fas fa-users"></i> <strong>${r1}%</strong> 的使用者也需要補 <span class="tag tag-gold">${element}行</span> 能量</div>
    <div class="sp-item"><i class="fas fa-chart-line"></i> 問<span class="tag tag-blue">${getTypeLabel(type)}</span>的人中，<strong>${r2}%</strong> 選擇佩戴對應水晶後回饋正面</div>
  </div>`;
}

/* =============================================================
   3) 首頁計數器 + 跑馬燈
   ============================================================= */
function initLiveCounter(){
  // Base count: accumulated + today's count from localStorage
  let base = 184729; // base number
  const dayKey = 'jy_count_' + new Date().toISOString().slice(0,10);
  let todayCount = parseInt(localStorage.getItem(dayKey)||'0');
  todayCount++;
  try{localStorage.setItem(dayKey, todayCount)}catch(e){}

  // Display
  const total = base + todayCount + Math.floor(Math.random()*20);
  const counterEl = document.getElementById('live-counter-num');
  if(counterEl) counterEl.textContent = total.toLocaleString();
  const todayEl = document.getElementById('live-today-num');
  if(todayEl) todayEl.textContent = todayCount + Math.floor(Math.random()*30+20);

}

/* =============================================================
   4) 分享後顯示專屬折扣碼（真實蝦皮折扣碼）
   ============================================================= */
const REAL_DISCOUNT_CODES = [
  'A50HDDG44','A50HGJY55','A50HOK471','A50HWWF45','A50HSF782',
  'A50HYHF78','A50HSF878','A50HUJ574','A50HE333','A50HE552'
];

function generateDiscountCode(){
  // Each user gets a consistent code based on date + random seed stored in localStorage
  let seed = localStorage.getItem('jy_discount_seed');
  if(!seed){
    seed = Math.floor(Math.random() * REAL_DISCOUNT_CODES.length);
    localStorage.setItem('jy_discount_seed', seed);
  }
  // Rotate by day so repeat visitors might see different codes
  const dayOffset = new Date().getDate() % REAL_DISCOUNT_CODES.length;
  const idx = (parseInt(seed) + dayOffset) % REAL_DISCOUNT_CODES.length;
  return REAL_DISCOUNT_CODES[idx];
}

function showDiscountAfterShare(){
  const code = generateDiscountCode();
  const el = document.getElementById('discount-reveal');
  if(!el) return;
  el.classList.remove('hidden');
  document.getElementById('discount-code').textContent = code;
}

function copyDiscountCode(){
  const code = document.getElementById('discount-code').textContent;
  navigator.clipboard.writeText(code).then(()=>{
    alert('折扣碼已複製！去蝦皮下單時貼上即可使用 ✨');
  }).catch(()=>{
    prompt('複製此折扣碼：', code);
  });
}

// Patch shareToUnlock to also show discount
const _origShareToUnlock = shareToUnlock;
shareToUnlock = function(){
  const url = window.location.href.split('?')[0];
  const text = '我剛用「靜月之光」測了命理結果，超準！免費測你的 👉 ';
  if(navigator.share){
    navigator.share({title:'靜月之光占卜',text:text,url:url}).then(()=>{
      hasShared=true; updateShareGate(); showDiscountAfterShare();
      if(typeof incrementAchievement==='function') incrementAchievement('shares',1);
    }).catch(()=>{
      // User cancelled — don't unlock
      showShareHint('分享取消了，完成分享才能解鎖哦 😊');
    });
  }else{
    showCopyShareDialog(text+url);
  }
};

/* =============================================================
   5) PWA 安裝提示橫幅
   ============================================================= */
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', function(e){
  e.preventDefault();
  deferredInstallPrompt = e;
  showPWABanner();
});

function showPWABanner(){
  const banner = document.getElementById('pwa-banner');
  if(!banner) return;
  if(sessionStorage.getItem('pwa_dismissed')) return;
  banner.classList.remove('hidden');
  // Auto dismiss after 8 seconds
  setTimeout(()=>hidePWABanner(), 8000);
}

function installPWA(){
  if(deferredInstallPrompt){
    deferredInstallPrompt.prompt();
    deferredInstallPrompt.userChoice.then(function(choice){
      if(choice.outcome==='accepted') console.log('PWA installed');
      deferredInstallPrompt = null;
      hidePWABanner();
    });
  }else{
    // iOS fallback
    alert('請點擊瀏覽器的「分享」按鈕 → 選擇「加入主畫面」即可安裝！');
    hidePWABanner();
  }
}

function hidePWABanner(){
  const banner = document.getElementById('pwa-banner');
  if(banner) banner.classList.add('hidden');
  sessionStorage.setItem('pwa_dismissed','1');
}

/* =============================================================
   6) AI 風格個人化總結
   ============================================================= */
function generateAIConclusion(type, prob, bazi, mh, tarot){
  const name = S.form.name || '你';
  const dm = bazi ? bazi.dm : '';
  const dmEl = bazi ? bazi.dmEl : '';
  const strong = bazi ? bazi.strong : true;
  const fav = bazi ? bazi.fav[0] : '';
  const curDy = bazi ? (bazi.dayun.find(d=>d.isCurrent)||{}) : {};
  const tl = getTypeLabel(type);

  // Opening — personal touch
  let lines = [];
  if(name!=='你') lines.push(`${name}，看完你的命盤，我想跟你說幾句真心話。`);
  else lines.push(`看完你的命盤，我想跟你說幾句真心話。`);

  // BaZi personality insight
  if(bazi){
    const personality = {
      甲:'你像一棵大樹，外表堅定但內心渴望陽光。',
      乙:'你像柔軟的藤蔓，看似溫柔實則韌性十足。',
      丙:'你像太陽一樣溫暖，天生就有感染力。',
      丁:'你像燭光般細膩，善於觀察與照顧他人。',
      戊:'你像大山一樣穩重，值得信賴但有時太固執。',
      己:'你像田園沃土，包容性強但容易委屈自己。',
      庚:'你像寶劍般果斷，做事乾脆但有時太急。',
      辛:'你像珠寶般精緻，追求完美但容易想太多。',
      壬:'你像大海般寬廣，想法多但容易分散精力。',
      癸:'你像細雨般溫潤，直覺強但容易猶豫不決。'
    };
    lines.push(personality[dm]||'');
    lines.push(`身${strong?'強':'弱'}的你，${strong?'能量充沛，但要注意別太衝動':'需要更多支持，適合借力使力'}。`);
  }

  // Current situation reading
  if(prob >= 70){
    lines.push(`從你的命盤來看，現在的你確實站在一個好位置上。${curDy.gz?'「'+curDy.gz+'」大運':'當前運勢'}給了你助力，問${tl}的結果是偏向樂觀的。`);
    lines.push('但好運不是等來的 — 是你準備好了，機會才看得見你。');
  }else if(prob >= 45){
    lines.push(`說實話，你現在的狀況是「有機會但有阻力」。${tl}這件事不是不行，而是需要更聰明的做法。`);
    lines.push('我的建議是：不要全押，先小範圍試水溫，有正向回饋再放大。');
  }else{
    lines.push(`我必須坦白說，目前的象徵不太支持你在${tl}上大動作。`);
    lines.push(`這不代表你不好 — 是時機還沒到。與其硬推，不如先${fav?'補'+fav+'行能量，':''}調整狀態，等更好的時機再出手。`);
  }

  // Meihua
  if(mh){
    lines.push(`梅花易數給了你一個有趣的信號：「${mh.ben.n}」→「${mh.bian.n}」，${mh.ty.r==='生'?'體用相生，事情的發展方向是有利的':mh.ty.r==='同'?'體用比和，維持現狀不會出大問題':mh.ty.r==='剋'?'體用相剋，要特別注意細節和時機':'需要更多耐心去等待'}。`);
  }

  // Tarot
  if(tarot && tarot.drawn && tarot.drawn.length){
    const core = tarot.drawn[0];
    const fin = tarot.drawn[9];
    lines.push(`塔羅的核心牌是「${core.n}」${core.isUp?'正位':'逆位'} — ${core.isUp?'這張牌告訴你，你問的方向是對的':'這張牌提醒你，可能需要換個角度思考'}。`);
    if(fin) lines.push(`最終結果牌「${fin.n}」${fin.isUp?'正位，整體走向是正面的':'逆位，結果可能跟預期不同，但不一定是壞事'}。`);
  }

  // Crystal advice as personal recommendation
  if(fav){
    lines.push(`最後，如果你想從能量層面幫自己一把，我建議你佩戴${fav}行的水晶。不是迷信，是給自己一個「提醒物」— 每次看到手上的水晶，就想起今天的決定和方向。`);
  }

  // Closing
  const closings = [
    '記住，命理是方向盤，不是定速巡航。方向對了，速度由你決定。',
    '最後送你一句：盡人事，聽天命。你已經在「盡人事」了，這很好。',
    '命盤是地圖，路還是你自己走的。加油。',
    '做好準備，然後相信自己的判斷。祝一切順利 ✨'
  ];
  lines.push(closings[Math.floor(Math.random()*closings.length)]);

  return lines.filter(l=>l).map(l=>`<p>${l}</p>`).join('');
}

/* =============================================================
   7) 7天後提醒再測（日曆事件）
   ============================================================= */
function addReminder7Days(){
  const now = new Date();
  const remind = new Date(now.getTime() + 7*24*60*60*1000);
  const fmt = d => d.toISOString().replace(/[-:]/g,'').replace(/\.\d+/,'');

  const icsContent = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//靜月之光//占卜提醒//ZH',
    'BEGIN:VEVENT',
    'DTSTART:' + fmt(remind),
    'DTEND:' + fmt(new Date(remind.getTime()+30*60*1000)),
    'SUMMARY:⏰ 靜月之光：該回來測一下運勢了！',
    'DESCRIPTION:上次測的結果已經過了7天，運勢可能有變化。\\n免費再測一次：' + window.location.href.split('?')[0],
    'URL:' + window.location.href.split('?')[0],
    'TRANSP:TRANSPARENT',
    'BEGIN:VALARM',
    'TRIGGER:-PT10M',
    'ACTION:DISPLAY',
    'DESCRIPTION:靜月之光占卜提醒',
    'END:VALARM',
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');

  const blob = new Blob([icsContent], {type:'text/calendar;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = '靜月占卜提醒.ics';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),3000);

  // Visual feedback
  const btn = document.getElementById('btn-remind');
  if(btn){
    btn.innerHTML = '<i class="fas fa-check"></i> 已加入日曆！';
    btn.disabled = true;
  }
}

/* =============================================================
   Patch renderProductCrystal to include urgency + social proof
   ============================================================= */
const _origRPC2 = renderProductCrystal;
renderProductCrystal = function(bazi, type){
  _origRPC2(bazi, type);
  // Inject urgency into each product card
  document.querySelectorAll('.product-card').forEach(card => {
    const name = card.querySelector('.product-name');
    if(name && !card.querySelector('.urgency-strip')){
      const u = document.createElement('div');
      u.innerHTML = getUrgencyHTML(name.textContent);
      card.querySelector('.product-body').appendChild(u.firstElementChild);
    }
  });
  // Inject social proof before product grid
  const crystalEl = document.getElementById('r-crystal');
  if(crystalEl && !crystalEl.querySelector('.social-proof')){
    const header = crystalEl.querySelector('.crystal-rec-header');
    if(header){
      const sp = document.createElement('div');
      sp.innerHTML = getSocialProofHTML(bazi.fav[0], type);
      header.after(sp.firstElementChild);
    }
  }
};

/* =============================================================
   Patch conclusion to use AI style
   ============================================================= */
const _origGenConclusion = generateConclusion;
generateConclusion = function(type, prob, bazi, mh, tarot){
  return generateAIConclusion(type, prob, bazi, mh, tarot);
};

/* =============================================================
   Init on DOMContentLoaded
   ============================================================= */
document.addEventListener('DOMContentLoaded', function(){
  initLiveCounter();
  // Show PWA banner after 5 seconds for iOS
  setTimeout(function(){
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    if(!isStandalone) showPWABanner();
  }, 5000);
});
/* =============================================================
   FEATURE 1: 每日運勢籤
   ============================================================= */
const FORTUNE_SIGNS = [
  {sign:'上上籤',icon:'🌟',msg:'諸事皆宜，把握今日好運氣！',crystal:'鈦晶',el:'金',reason:'強化今日的正財磁場'},
  {sign:'上吉籤',icon:'✨',msg:'貴人相助，積極行動必有收穫。',crystal:'綠幽靈',el:'木',reason:'招引貴人與正財能量'},
  {sign:'中吉籤',icon:'🌙',msg:'穩中求進，適合規劃與學習。',crystal:'紫水晶',el:'火',reason:'提升思緒清晰度與直覺'},
  {sign:'中平籤',icon:'☁️',msg:'順其自然，不宜急躁冒進。',crystal:'茶晶',el:'土',reason:'穩定心性，排除浮躁能量'},
  {sign:'小吉籤',icon:'🌤️',msg:'小有進展，耐心等待時機成熟。',crystal:'黃水晶',el:'土',reason:'招偏財，提升耐心與自信'},
  {sign:'吉籤',icon:'💫',msg:'心想事成的機率正在上升中。',crystal:'海藍寶',el:'水',reason:'增強溝通力，助願望達成'},
  {sign:'上吉籤',icon:'🔥',msg:'行動力滿點，今天適合做重要決定！',crystal:'紅瑪瑙',el:'火',reason:'激發勇氣與行動力'},
  {sign:'中吉籤',icon:'💎',msg:'內在能量充沛，適合靜心思考方向。',crystal:'月光石',el:'水',reason:'增強直覺，照亮內心方向'},
  {sign:'大吉籤',icon:'🎊',msg:'天時地利人和，難得的好日子！',crystal:'粉晶',el:'土',reason:'人緣桃花全開，把握社交機會'},
  {sign:'中平籤',icon:'🌊',msg:'如水般柔軟應對，剛則易折。',crystal:'藍玉髓',el:'水',reason:'柔化個性，增強適應力'},
  {sign:'小吉籤',icon:'🌱',msg:'播種期，現在的努力未來會開花。',crystal:'東陵玉',el:'木',reason:'帶來生長與希望的能量'},
  {sign:'上吉籤',icon:'⚡',msg:'靈感爆發日，創意與機會同步到來！',crystal:'金太陽',el:'火',reason:'激發創造力與領導魅力'}
];

function getDailyFortune(){
  const today = new Date().toISOString().slice(0,10);
  const key = 'jy_daily_' + today;
  let cached = null;
  try{ cached = JSON.parse(localStorage.getItem(key)); }catch(e){}
  
  if(cached) return cached;
  
  // Better hash: each character contributes uniquely
  let hash = 0;
  for(let i=0;i<today.length;i++){
    hash = ((hash << 5) - hash + today.charCodeAt(i)) | 0;
  }
  const idx = Math.abs(hash) % FORTUNE_SIGNS.length;
  const fortune = FORTUNE_SIGNS[idx];
  const result = {...fortune, date: today, drawn: true};
  try{ localStorage.setItem(key, JSON.stringify(result)); }catch(e){}
  return result;
}

function canDrawToday(){
  const today = new Date().toISOString().slice(0,10);
  const key = 'jy_daily_' + today;
  try{
    // Clean up old dates
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(k && k.startsWith('jy_daily_') && k !== key){
        localStorage.removeItem(k);
      }
    }
    return !localStorage.getItem(key);
  }catch(e){ return true; }
}

function renderDailyFortune(){
  const container = document.getElementById('daily-fortune-content');
  if(!container) return;
  
  if(canDrawToday()){
    container.innerHTML = `
      <div class="fortune-draw-area">
        <div class="fortune-urn">🏮</div>
        <p class="text-dim">心中默念你的問題，然後抽籤</p>
        <button class="btn btn-gold" onclick="drawDailyFortune()" id="btn-draw-fortune">
          <i class="fas fa-hand-sparkles"></i> 抽今日運勢籤
        </button>
      </div>`;
  } else {
    showFortuneResult(getDailyFortune());
  }
}

function drawDailyFortune(){
  const btn = document.getElementById('btn-draw-fortune');
  if(btn){ btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> 抽籤中...'; }
  
  // Track daily streak achievement
  incrementAchievement('daily_streak');
  
  // Dramatic pause
  setTimeout(()=>{
    const fortune = getDailyFortune();
    showFortuneResult(fortune);
  }, 1500);
}

function showFortuneResult(f){
  const container = document.getElementById('daily-fortune-content');
  if(!container) return;
  
  const prod = findProductByName(f.crystal);
  container.innerHTML = `
    <div class="fortune-result" style="animation:scaleIn 0.5s ease">
      <div class="fortune-sign-icon">${f.icon}</div>
      <div class="fortune-sign-text">${f.sign}</div>
      <p class="fortune-msg">${f.msg}</p>
      <div class="fortune-divider"></div>
      <div class="fortune-crystal-rec">
        <p class="text-sm"><strong>今日幸運水晶：</strong></p>
        <div class="fortune-crystal-card">
          <span class="fortune-crystal-name">${f.crystal}</span>
          <span class="el-tag el-${f.el} text-xs">${f.el}行</span>
        </div>
        <p class="text-xs text-dim">${f.reason}</p>
        <div class="fortune-buy-btns mt-sm">
          <a href="${prod?prod.shopee:'https://tw.shp.ee/2n5Mo2w'}" target="_blank" rel="noopener" class="product-btn shopee"><i class="fas fa-shopping-cart"></i> 蝦皮入手</a>
          <a href="${prod?prod.seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}" target="_blank" rel="noopener" class="product-btn seven"><i class="fas fa-box"></i> 7-11</a>
        </div>
      </div>
      <p class="text-xs text-muted mt-md">明天可以再抽一次 ✨ 每日 00:00 重置</p>
    </div>`;
}

function findProductByName(name){
  for(const el of Object.values(REAL_PRODUCTS)){
    if(!Array.isArray(el)) continue;
    const found = el.find(p=>p.n.includes(name));
    if(found) return found;
  }
  return null;
}

/* =============================================================
   FEATURE 2: 成就徽章系統
   ============================================================= */
const ACHIEVEMENTS = [
  {id:'first',name:'初次問卦',icon:'🌱',desc:'完成第一次占卜',need:1},
  {id:'curious',name:'好奇寶寶',icon:'🔍',desc:'累計占卜 3 次',need:3},
  {id:'seeker',name:'命理探索者',icon:'🧭',desc:'累計占卜 5 次',need:5},
  {id:'devoted',name:'虔誠信徒',icon:'🙏',desc:'累計占卜 10 次',need:10},
  {id:'master',name:'占卜大師',icon:'🧙',desc:'累計占卜 20 次',need:20},
  {id:'crystal',name:'水晶達人',icon:'💎',desc:'查看水晶百科 5 種以上',need:5,type:'crystal_views'},
  {id:'sharer',name:'分享控',icon:'📣',desc:'分享結果給朋友',need:1,type:'shares'},
  {id:'daily',name:'每日報到',icon:'📅',desc:'連續 3 天抽運勢籤',need:3,type:'daily_streak'},
  {id:'alltype',name:'全能問卦師',icon:'🎭',desc:'問過 5 種不同類型的問題',need:5,type:'types_asked'}
];

function getAchievementData(){
  try{
    return JSON.parse(localStorage.getItem('jy_achievements')||'{}');
  }catch(e){ return {}; }
}

function saveAchievementData(data){
  try{ localStorage.setItem('jy_achievements', JSON.stringify(data)); }catch(e){}
}

function incrementAchievement(type, value){
  const data = getAchievementData();
  if(!data.counts) data.counts={};
  if(type === 'divination'){
    data.counts.divination = (data.counts.divination||0) + 1;
  } else if(type === 'crystal_views'){
    if(!data.counts.crystal_views) data.counts.crystal_views = new Set();
    // Sets don't serialize well, use array
    if(!Array.isArray(data.counts.crystal_views)) data.counts.crystal_views = [];
    if(!data.counts.crystal_views.includes(value)){
      data.counts.crystal_views.push(value);
    }
  } else if(type === 'shares'){
    data.counts.shares = (data.counts.shares||0) + 1;
  } else if(type === 'types_asked'){
    if(!Array.isArray(data.counts.types_asked)) data.counts.types_asked = [];
    if(value && !data.counts.types_asked.includes(value)){
      data.counts.types_asked.push(value);
    }
  } else if(type === 'daily_streak'){
    const today = new Date().toISOString().slice(0,10);
    if(!data.counts.daily_dates) data.counts.daily_dates = [];
    if(!data.counts.daily_dates.includes(today)){
      data.counts.daily_dates.push(today);
    }
    // Calculate streak
    data.counts.daily_streak = calcStreak(data.counts.daily_dates);
  }
  saveAchievementData(data);
  checkNewAchievements(data);
}

function calcStreak(dates){
  if(!dates||!dates.length) return 0;
  const sorted = [...dates].sort().reverse();
  let streak = 1;
  for(let i=1;i<sorted.length;i++){
    const prev = new Date(sorted[i-1]);
    const curr = new Date(sorted[i]);
    const diff = (prev - curr) / (1000*60*60*24);
    if(diff === 1) streak++;
    else break;
  }
  return streak;
}

function checkNewAchievements(data){
  if(!data.counts) return;
  if(!data.unlocked) data.unlocked = [];
  
  ACHIEVEMENTS.forEach(a=>{
    if(data.unlocked.includes(a.id)) return;
    let count = 0;
    if(!a.type || a.type === 'divination') count = data.counts.divination || 0;
    else if(a.type === 'crystal_views') count = (data.counts.crystal_views||[]).length;
    else if(a.type === 'shares') count = data.counts.shares || 0;
    else if(a.type === 'daily_streak') count = data.counts.daily_streak || 0;
    else if(a.type === 'types_asked') count = (data.counts.types_asked||[]).length;
    
    if(count >= a.need){
      data.unlocked.push(a.id);
      showAchievementToast(a);
    }
  });
  saveAchievementData(data);
}

function showAchievementToast(a){
  const toast = document.createElement('div');
  toast.className = 'achievement-toast';
  toast.innerHTML = `<span class="at-icon">${a.icon}</span><div><strong>成就解鎖！</strong><br>${a.name}</div>`;
  document.body.appendChild(toast);
  setTimeout(()=>toast.classList.add('show'), 50);
  setTimeout(()=>{toast.classList.remove('show');setTimeout(()=>toast.remove(),500)}, 3500);
}

function renderAchievements(){
  const container = document.getElementById('achievements-grid');
  if(!container) return;
  const data = getAchievementData();
  const unlocked = data.unlocked || [];
  
  container.innerHTML = ACHIEVEMENTS.map(a=>{
    const isUnlocked = unlocked.includes(a.id);
    return `<div class="achievement-badge ${isUnlocked?'unlocked':'locked'}">
      <div class="badge-icon">${isUnlocked?a.icon:'🔒'}</div>
      <div class="badge-name">${a.name}</div>
      <div class="badge-desc text-xs text-muted">${a.desc}</div>
    </div>`;
  }).join('');
  
  const total = ACHIEVEMENTS.length;
  const done = unlocked.length;
  document.getElementById('achievement-progress').textContent = `${done}/${total} 已解鎖`;
}

/* =============================================================
   FEATURE 3: 水晶百科圖鑑
   ============================================================= */
function renderCrystalEncyclopedia(){
  const container = document.getElementById('crystal-encyclopedia-grid');
  if(!container) return;
  
  const allCrystals = [];
  const seen = new Set();
  for(const [category, items] of Object.entries(REAL_PRODUCTS)){
    if(!Array.isArray(items)) continue;
    items.forEach(p=>{
      if(seen.has(p.n)) return;
      seen.add(p.n);
      allCrystals.push({...p, _cat: category});
    });
  }
  
  container.innerHTML = allCrystals.map(c=>`
    <div class="ency-card" onclick="showCrystalDetail('${c.n.replace(/'/g,"\\'")}')">
      <div class="ency-icon">${c.icon}</div>
      <div class="ency-name">${c.n}</div>
      <div class="ency-meta">
        ${c.el!=='全'?`<span class="el-tag el-${c.el} text-xs">${c.el}行</span>`:'<span class="tag text-xs" style="color:var(--c-gold)">五行全</span>'}
        <span class="text-xs text-muted">${c.cat}</span>
      </div>
      <p class="ency-desc">${c.d}</p>
      <p class="ency-price">${c.price}</p>
    </div>`).join('');
}

function showCrystalDetail(name){
  incrementAchievement('crystal_views', name);
  
  let crystal = null;
  for(const items of Object.values(REAL_PRODUCTS)){
    if(!Array.isArray(items)) continue;
    crystal = items.find(p=>p.n === name);
    if(crystal) break;
  }
  if(!crystal) return;
  
  const modal = document.getElementById('crystal-detail-modal');
  if(!modal) return;
  
  modal.innerHTML = `
    <div class="cdm-overlay" onclick="closeCrystalDetail()"></div>
    <div class="cdm-content">
      <button class="cdm-close" onclick="closeCrystalDetail()"><i class="fas fa-times"></i></button>
      <div class="cdm-icon">${crystal.icon}</div>
      <h3 class="cdm-name">${crystal.n}</h3>
      <div class="cdm-tags">
        ${crystal.el!=='全'?`<span class="el-tag el-${crystal.el}">${crystal.el}行</span>`:'<span class="tag" style="color:var(--c-gold)">五行全</span>'}
        <span class="tag tag-gold">${crystal.cat}</span>
      </div>
      <p class="cdm-desc">${crystal.d}</p>
      <div class="cdm-info">
        <div class="cdm-row"><i class="fas fa-tag"></i> 價格：<strong>${crystal.price}</strong></div>
        <div class="cdm-row"><i class="fas fa-hand-holding-heart"></i> 佩戴方式：${crystal.wear}</div>
      </div>
      <div class="cdm-actions">
        <a href="${crystal.shopee}" target="_blank" rel="noopener" class="btn btn-gold"><i class="fas fa-shopping-cart"></i> 蝦皮購買</a>
        <a href="${crystal.seven}" target="_blank" rel="noopener" class="btn btn-outline"><i class="fas fa-box"></i> 7-11</a>
      </div>
    </div>`;
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeCrystalDetail(){
  const modal = document.getElementById('crystal-detail-modal');
  if(modal) modal.classList.add('hidden');
  document.body.style.overflow = '';
}

/* =============================================================
   FEATURE 4: 水晶配對測驗
   ============================================================= */
/* === 題庫：15題隨機抽3題，每次不同組合 === */
const QUIZ_BANK = [
  {q:'面對壓力時，你通常會？',opts:[
    {t:'深呼吸，冷靜分析',el:'水',trait:'理性'},
    {t:'找朋友聊聊傾訴',el:'木',trait:'社交'},
    {t:'立刻行動解決問題',el:'火',trait:'行動'},
    {t:'獨處靜心等靈感',el:'金',trait:'直覺'}
  ]},
  {q:'你最嚮往的生活方式？',opts:[
    {t:'穩定有規律的日常',el:'土',trait:'穩定'},
    {t:'充滿冒險與新鮮感',el:'火',trait:'冒險'},
    {t:'自由自在不受拘束',el:'水',trait:'自由'},
    {t:'和諧溫馨的家庭',el:'木',trait:'溫暖'}
  ]},
  {q:'如果水晶有顏色，最吸引你的是？',opts:[
    {t:'透明 / 白色 — 純淨',el:'金',trait:'純淨'},
    {t:'粉紅 / 紫色 — 浪漫',el:'火',trait:'浪漫'},
    {t:'綠色 / 藍色 — 寧靜',el:'木',trait:'寧靜'},
    {t:'金色 / 棕色 — 大地',el:'土',trait:'踏實'}
  ]},
  {q:'朋友眼中的你是？',opts:[
    {t:'值得信賴的靠山',el:'土',trait:'可靠'},
    {t:'點子王、創意多',el:'火',trait:'創意'},
    {t:'溫柔體貼的傾聽者',el:'水',trait:'溫柔'},
    {t:'行動派的領袖',el:'金',trait:'果斷'}
  ]},
  {q:'週末最想做的事？',opts:[
    {t:'宅在家追劇充電',el:'水',trait:'內斂'},
    {t:'出門走走接觸大自然',el:'木',trait:'自然'},
    {t:'約朋友聚餐聊天',el:'火',trait:'熱情'},
    {t:'整理房間或做計畫',el:'金',trait:'條理'}
  ]},
  {q:'你覺得自己最需要補足的是？',opts:[
    {t:'自信心和行動力',el:'火',trait:'勇氣'},
    {t:'耐心和穩定感',el:'土',trait:'沉穩'},
    {t:'人際關係和桃花',el:'木',trait:'人緣'},
    {t:'財運和事業動力',el:'金',trait:'進取'}
  ]},
  {q:'選一個最能代表你心情的天氣？',opts:[
    {t:'晴空萬里',el:'火',trait:'開朗'},
    {t:'微風徐徐的陰天',el:'金',trait:'沉靜'},
    {t:'綿綿細雨',el:'水',trait:'敏感'},
    {t:'雨後彩虹',el:'木',trait:'希望'}
  ]},
  {q:'挑一個數字？',opts:[
    {t:'1 — 開始',el:'木',trait:'起點'},
    {t:'3 — 變化',el:'火',trait:'變化'},
    {t:'6 — 順利',el:'金',trait:'圓滿'},
    {t:'8 — 豐收',el:'土',trait:'豐盛'}
  ]},
  {q:'你最害怕失去的是？',opts:[
    {t:'健康',el:'土',trait:'務實'},
    {t:'自由',el:'水',trait:'獨立'},
    {t:'愛情 / 家人',el:'木',trait:'重情'},
    {t:'事業成就',el:'金',trait:'野心'}
  ]},
  {q:'買東西時你最看重？',opts:[
    {t:'CP值高不高',el:'金',trait:'精明'},
    {t:'外型好不好看',el:'火',trait:'美感'},
    {t:'品質耐不耐用',el:'土',trait:'品質'},
    {t:'有沒有特殊意義',el:'水',trait:'寓意'}
  ]},
  {q:'如果有一種超能力，你選？',opts:[
    {t:'讀心術',el:'水',trait:'洞察'},
    {t:'時間暫停',el:'金',trait:'掌控'},
    {t:'瞬間移動',el:'火',trait:'自由'},
    {t:'治癒能力',el:'木',trait:'慈悲'}
  ]},
  {q:'你的睡眠品質如何？',opts:[
    {t:'秒睡到天亮',el:'土',trait:'安穩'},
    {t:'偶爾失眠想太多',el:'水',trait:'多慮'},
    {t:'容易被吵醒',el:'金',trait:'敏銳'},
    {t:'夢很多很精彩',el:'火',trait:'想像力'}
  ]},
  {q:'選一種你喜歡的味道？',opts:[
    {t:'檀香 / 木質',el:'木',trait:'沉穩'},
    {t:'花香 / 玫瑰',el:'火',trait:'浪漫'},
    {t:'海洋 / 清新',el:'水',trait:'清爽'},
    {t:'茶香 / 大地',el:'土',trait:'內斂'}
  ]},
  {q:'你對「命運」的看法？',opts:[
    {t:'三分天注定，七分靠努力',el:'火',trait:'積極'},
    {t:'順其自然就好',el:'水',trait:'隨和'},
    {t:'做好準備，等待時機',el:'金',trait:'謀略'},
    {t:'相信因果，種善因得善果',el:'木',trait:'善良'}
  ]},
  {q:'工作中最讓你有成就感的事？',opts:[
    {t:'完成挑戰性的專案',el:'火',trait:'挑戰'},
    {t:'得到主管或客戶認可',el:'金',trait:'榮譽'},
    {t:'幫助同事解決問題',el:'木',trait:'助人'},
    {t:'存到目標數字的錢',el:'土',trait:'累積'}
  ]}
];

let quizState = {step:0, answers:[], questions:[]};

function startCrystalQuiz(){
  // Shuffle and pick 3 random questions
  const shuffled = [...QUIZ_BANK].sort(()=>Math.random()-0.5);
  quizState = {step:0, answers:[], questions: shuffled.slice(0,3)};
  renderQuizStep();
}

function renderQuizStep(){
  const container = document.getElementById('crystal-quiz-content');
  if(!container) return;
  
  if(quizState.step >= quizState.questions.length){
    showQuizResult();
    return;
  }
  
  const q = quizState.questions[quizState.step];
  const total = quizState.questions.length;
  container.innerHTML = `
    <div class="quiz-progress">第 ${quizState.step+1}/${total} 題</div>
    <div class="quiz-progress-bar"><div class="quiz-fill" style="width:${(quizState.step/total)*100}%"></div></div>
    <h4 class="quiz-question">${q.q}</h4>
    <div class="quiz-options">${q.opts.map((o,i)=>`
      <button class="quiz-option" onclick="answerQuiz(${i})">
        <span>${o.t}</span>
      </button>`).join('')}
    </div>`;
}

function answerQuiz(idx){
  const q = quizState.questions[quizState.step];
  quizState.answers.push(q.opts[idx]);
  quizState.step++;
  renderQuizStep();
}

function showQuizResult(){
  const container = document.getElementById('crystal-quiz-content');
  if(!container) return;
  
  // Count quiz elements
  const elCount = {};
  quizState.answers.forEach(a=>{
    elCount[a.el] = (elCount[a.el]||0) + 1;
  });
  const quizTopEl = Object.entries(elCount).sort((a,b)=>b[1]-a[1])[0][0];
  const traits = quizState.answers.map(a=>a.trait);
  
  // ** 核心修改：以八字喜用神為主，測驗結果為輔 **
  let targetEl = quizTopEl;
  let hasBazi = false;
  let baziNote = '';
  
  if(typeof S !== 'undefined' && S.bazi && S.bazi.fav && S.bazi.fav.length){
    hasBazi = true;
    const favEl = S.bazi.fav[0]; // 第一喜用神
    targetEl = favEl; // 以八字為準
    if(favEl !== quizTopEl){
      baziNote = `<div class="quiz-bazi-note"><i class="fas fa-info-circle"></i> 測驗顯示你偏好「${quizTopEl}行」，但你的八字喜用神是「<strong>${favEl}行</strong>」。依命理原則，我們以喜用神為你推薦最適合的水晶。</div>`;
    } else {
      baziNote = `<div class="quiz-bazi-match"><i class="fas fa-check-circle"></i> 你的直覺與八字完全吻合！喜用神「<strong>${favEl}行</strong>」正是你最需要的能量。</div>`;
    }
  }
  
  // Find crystal from target element
  const candidates = REAL_PRODUCTS[targetEl] || REAL_PRODUCTS['土'];
  const pick = candidates[Math.floor(Math.random()*Math.min(3,candidates.length))];
  
  container.innerHTML = `
    <div class="quiz-result" style="animation:scaleIn 0.5s">
      <div class="quiz-result-icon">${pick.icon}</div>
      <h3 class="quiz-result-title">你的命定水晶是</h3>
      <div class="quiz-result-crystal">${pick.n}</div>
      <div class="quiz-result-el">
        <span class="el-tag el-${pick.el}">${pick.el}行</span>
        <span class="tag tag-gold">${pick.cat}</span>
      </div>
      ${baziNote}
      <p class="quiz-result-desc">${pick.d}</p>
      <p class="quiz-result-traits text-sm text-dim">你的特質：${traits.join(' · ')}</p>
      ${!hasBazi ? '<p class="text-xs text-muted mt-sm"><i class="fas fa-lightbulb"></i> 提示：先完成「八字占卜」再做測驗，結果會更精準！</p>' : ''}
      <div class="quiz-result-actions mt-md">
        <a href="${pick.shopee}" target="_blank" rel="noopener" class="btn btn-gold"><i class="fas fa-shopping-cart"></i> 去蝦皮擁有它</a>
        <button class="btn btn-outline" onclick="startCrystalQuiz()"><i class="fas fa-redo"></i> 再測一次</button>
      </div>
      <button class="btn btn-outline btn-sm mt-md" onclick="shareQuizResult('${pick.n}','${traits.join('·')}')">
        <i class="fas fa-share-alt"></i> 分享我的命定水晶
      </button>
    </div>`;
}

function shareQuizResult(crystal, traits){
  const text = `我的命定水晶是「${crystal}」！特質：${traits}。你的呢？快來測 👉 `;
  const url = window.location.href.split('?')[0];
  if(navigator.share){
    navigator.share({title:'我的命定水晶',text:text,url:url}).catch(()=>{});
  } else {
    navigator.clipboard.writeText(text+url).then(()=>alert('已複製！貼到 LINE/IG 分享給朋友'));
  }
  incrementAchievement('shares',1);
}

/* =============================================================
   FEATURE 5: 好評輪播
   ============================================================= */
const REVIEWS = [
  {name:'eicheuq8h7',city:'',crystal:'客製款 頂級銀曜石 銀鱗手鍊',stars:5,text:'會配合你的五行及預算去給你全方位建議，配好的手鍊也非常好看，推薦各位',time:'2025/12/29'},
  {name:'l5v3e74kf8',city:'',crystal:'鋼鐵防禦 頂級天然鐵膽石',stars:5,text:'CP值：讚',time:'2025/12/17'},
  {name:'yeh552798',city:'',crystal:'天然 華青石 手鍊 10mm',stars:5,text:'二色性 維京人的羅盤 指引方向',time:'2025/12/11'},
  {name:'jfc16888',city:'',crystal:'天然龍宮舍利桶珠手鍊',stars:5,text:'收到商品包裝良好，送貨快速，這款桶珠手鍊還蠻喜歡的，有需要會再回購看看其他商品……',time:'2025/12/07'},
  {name:'tasiong109',city:'',crystal:'天然龍宮舍利桶珠手鍊',stars:5,text:'完美品項 如商品照片 實物更加美 閃閃 更是服務超好 回應超快 寄件也快速 很完美的一次購物體驗 大推呀！',time:'2025/12/01'},
  {name:'mandytseng0511',city:'',crystal:'天鐵設計款 五行手鍊 藍虎眼 海藍寶',stars:5,text:'感謝賣家，針對個人的五行缺乏的部分做設計款補足，溝通也很順暢，推薦給大家！',time:'2025/11/28'},
  {name:'fayefang20',city:'',crystal:'頂級 黑碧璽三圈 6mm+',stars:5,text:'Black 電氣石 擋煞 辟邪 防小人 能量手鍊 穩定情緒 接地',time:'2025/11/20'},
  {name:'c9301115',city:'',crystal:'頂級 佛眼 龍宮舍利 10mm+',stars:5,text:'很好看起來很好很有品質我很喜歡，下次有機會會再回購',time:'2025/11/20'},
  {name:'yct585',city:'',crystal:'巨無霸 大地瑪瑙手排 22mm',stars:5,text:'本來不想寫評價，看到老闆貼心的問候，給予肯定，雙11活動所有東西都可以免運，就瘋狂地買，沒想到這大地瑪瑙這麼這麼的美，美到覺得自己好幸運可以買到，感恩所有美好的事物和人都能得到祝福！值得推薦的好賣家！',time:'2025/11/16'},
  {name:'lovebl927',city:'',crystal:'天然 薔薇輝石 手鍊 12mm',stars:5,text:'出貨超快，很美的薔薇🌹 開箱比想像中更滿意！實體很讚，賣家經營用心~會推薦朋友購買！',time:'2025/11/13'},
  {name:'jesscia985',city:'',crystal:'天然 頂級 白水晶 鑽切手排 14mm',stars:5,text:'白水晶之王',time:'2026/01/29'},
  {name:'jesscia985',city:'',crystal:'頂級咖啡鈦晶 太陽花手排 14mm',stars:5,text:'賣家很 nice，鈦晶手排與白水晶手排都超美的，包裝超特別，防護力超強，物流也超神速，總之，一整個就是 "超 讚"',time:'2026/01/29'},
  {name:'yenrensu',city:'',crystal:'天然 咖啡鈦晶 手排 13mm',stars:5,text:'貓眼 鋼鈦晶 招財 旺事業 避邪 擋煞 低調奢華 復古金氣質',time:'2026/01/19'},
  {name:'liudfu',city:'',crystal:'泰國 黃龍宮舍利手鍊 11mm',stars:5,text:'用心包裝溝通良好的賣家😍快速出貨高cp 值的好賣家值得推薦大家一起來賣家逛逛購買，給5星好評喔',time:'2025/10/21'},
  {name:'liudfu',city:'',crystal:'泰國 黃龍宮舍利手鍊 13mm',stars:5,text:'好用心的包裝超愛的😍快速出貨高cp 值的好賣家值得推薦大家一起來賣家逛逛購買，給5星好評喔',time:'2025/10/21'}
];

let reviewIdx = 0;
function initReviewCarousel(){
  const el = document.getElementById('review-carousel');
  if(!el) return;
  function show(){
    const r = REVIEWS[reviewIdx % REVIEWS.length];
    el.style.opacity = '0';
    setTimeout(()=>{
      el.innerHTML = `
        <div class="review-card">
          <div class="review-header">
            <span class="review-stars">${'⭐'.repeat(r.stars)}</span>
            <span class="review-meta">${r.name}${r.city?' · '+r.city:''} · ${r.time}</span>
          </div>
          <p class="review-text">「${r.text}」</p>
          <div class="review-product">
            <span class="tag tag-gold text-xs">購買：${r.crystal}</span>
          </div>
        </div>`;
      el.style.opacity = '1';
      reviewIdx++;
    }, 300);
  }
  show();
  setInterval(show, 6000);
}

/* =============================================================
   FEATURE 6: 商品實拍輪播（框架，等替換照片）
   ============================================================= */
const PRODUCT_PHOTOS = {
  // 格式: '商品名': ['photo1_url', 'photo2_url', ...]
  // 目前用 placeholder，店家提供照片後替換 URL
  '鈦晶手排': [],
  '粉晶': [],
  '綠幽靈': [],
  '海藍寶': [],
  '紫水晶': [],
  '黃水晶': []
};

function initPhotoCarousel(cardEl, productName){
  const photos = PRODUCT_PHOTOS[productName];
  if(!photos || !photos.length) return; // No photos yet, skip
  
  const wrapper = document.createElement('div');
  wrapper.className = 'photo-carousel';
  let pIdx = 0;
  
  function render(){
    wrapper.innerHTML = `
      <img src="${photos[pIdx]}" alt="${productName}" class="photo-slide">
      <div class="photo-dots">${photos.map((_,i)=>`<span class="photo-dot ${i===pIdx?'active':''}"></span>`).join('')}</div>`;
  }
  
  wrapper.addEventListener('click', ()=>{
    pIdx = (pIdx + 1) % photos.length;
    render();
  });
  
  render();
  const iconEl = cardEl.querySelector('.product-icon');
  if(iconEl) iconEl.replaceWith(wrapper);
}

/* =============================================================
   Track divination for achievements
   ============================================================= */
const _origRunAnalysis = typeof runAnalysis === 'function' ? runAnalysis : null;
if(_origRunAnalysis){
  const __origRA = runAnalysis;
  runAnalysis = function(){
    __origRA.apply(this, arguments);
    incrementAchievement('divination');
    try{
      const typeEl = document.getElementById('question-type');
      if(typeEl && typeEl.value) incrementAchievement('types_asked', typeEl.value);
    }catch(e){}
    // Refresh badge display
    setTimeout(renderAchievements, 500);
  };
}

/* =============================================================
   Init all engagement features
   ============================================================= */
document.addEventListener('DOMContentLoaded', function(){
  renderDailyFortune();
  renderAchievements();
  renderCrystalEncyclopedia();
  initReviewCarousel();
  
  // Nav tab switching for new sections
  document.querySelectorAll('.nav-extra-tab').forEach(tab=>{
    tab.addEventListener('click', function(){
      const target = this.dataset.target;
      document.querySelectorAll('.extra-section').forEach(s=>s.classList.add('hidden'));
      const section = document.getElementById(target);
      if(section) section.classList.remove('hidden');
      document.querySelectorAll('.nav-extra-tab').forEach(t=>t.classList.remove('active'));
      this.classList.add('active');
      section.scrollIntoView({behavior:'smooth',block:'start'});
    });
  });
});
/* =============================================================
   塔羅牌面生成器 — Canvas 繪製 78 張牌面
   ============================================================= */
const TAROT_CARD_SYMBOLS = {
  // 大阿爾卡納 0-21
  0:  {sym:'🃏', color:'#FFD700', bg:'#1a0a30', sub:'0'},
  1:  {sym:'∞',  color:'#FFD700', bg:'#2D0A0A', sub:'I'},
  2:  {sym:'☽',  color:'#C0C0FF', bg:'#0a0a2d', sub:'II'},
  3:  {sym:'♀',  color:'#FFB6C1', bg:'#2D0A1A', sub:'III'},
  4:  {sym:'♂',  color:'#DC143C', bg:'#2D0A0A', sub:'IV'},
  5:  {sym:'✝',  color:'#FFD700', bg:'#1a1a0a', sub:'V'},
  6:  {sym:'♡',  color:'#FF69B4', bg:'#2D0A1A', sub:'VI'},
  7:  {sym:'⚔',  color:'#C0C0C0', bg:'#0a1a2d', sub:'VII'},
  8:  {sym:'∞',  color:'#FFD700', bg:'#2D1A0A', sub:'VIII'},
  9:  {sym:'☆',  color:'#C0C0FF', bg:'#0a0a2d', sub:'IX'},
  10: {sym:'☸',  color:'#FFD700', bg:'#1a0a2d', sub:'X'},
  11: {sym:'⚖',  color:'#FFD700', bg:'#2D0A0A', sub:'XI'},
  12: {sym:'⚓',  color:'#4169E1', bg:'#0a1a2d', sub:'XII'},
  13: {sym:'☠',  color:'#F5F5F5', bg:'#0a0a0a', sub:'XIII'},
  14: {sym:'⚗',  color:'#87CEEB', bg:'#0a2d2d', sub:'XIV'},
  15: {sym:'⛧',  color:'#8B0000', bg:'#0a0a0a', sub:'XV'},
  16: {sym:'⚡',  color:'#FF4500', bg:'#1a0a0a', sub:'XVI'},
  17: {sym:'★',  color:'#FFD700', bg:'#0a0a2d', sub:'XVII'},
  18: {sym:'☾',  color:'#C0C0FF', bg:'#0a0a2d', sub:'XVIII'},
  19: {sym:'☀',  color:'#FFD700', bg:'#2D1A0A', sub:'XIX'},
  20: {sym:'♱',  color:'#FFD700', bg:'#1a0a2d', sub:'XX'},
  21: {sym:'⊕',  color:'#FFD700', bg:'#0a2d0a', sub:'XXI'}
};

// 小阿爾卡納花色
const SUIT_STYLES = {
  '權杖': {sym:'🔥', color:'#FF6347', bg:'#2D0A0A', accent:'#FF4500'},
  '聖杯': {sym:'💧', color:'#4169E1', bg:'#0a0a2d', accent:'#1E90FF'},
  '寶劍': {sym:'⚔',  color:'#C0C0C0', bg:'#1a1a1a', accent:'#A9A9A9'},
  '金幣': {sym:'⬟',  color:'#FFD700', bg:'#1a1a0a', accent:'#DAA520'}
};

const COURT_SYMBOLS = {
  '王牌':'✦','二':'II','三':'III','四':'IV','五':'V',
  '六':'VI','七':'VII','八':'VIII','九':'IX','十':'X',
  '侍者':'👤','騎士':'🐎','皇后':'♛','國王':'♚'
};

function generateTarotCardImage(card){
  const canvas = document.createElement('canvas');
  canvas.width = 180;
  canvas.height = 280;
  const ctx = canvas.getContext('2d');
  
  let style;
  if(card.id <= 21){
    // Major Arcana
    style = TAROT_CARD_SYMBOLS[card.id];
    drawMajorCard(ctx, card, style);
  } else {
    // Minor Arcana
    let suit='', rank='';
    for(const s of ['權杖','聖杯','寶劍','金幣']){
      if(card.n.includes(s)){ suit=s; rank=card.n.replace(s,''); break; }
    }
    style = SUIT_STYLES[suit] || SUIT_STYLES['金幣'];
    drawMinorCard(ctx, card, style, suit, rank);
  }
  
  return canvas.toDataURL('image/png');
}

function drawMajorCard(ctx, card, s){
  const W=180, H=280;
  
  // Background gradient
  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, s.bg);
  grad.addColorStop(0.5, lighten(s.bg, 15));
  grad.addColorStop(1, s.bg);
  ctx.fillStyle = grad;
  roundRect(ctx, 0, 0, W, H, 12);
  ctx.fill();
  
  // Border
  ctx.strokeStyle = s.color;
  ctx.lineWidth = 2;
  roundRect(ctx, 3, 3, W-6, H-6, 10);
  ctx.stroke();
  
  // Inner border
  ctx.strokeStyle = 'rgba('+hexToRgb(s.color)+',0.3)';
  ctx.lineWidth = 1;
  roundRect(ctx, 8, 8, W-16, H-16, 8);
  ctx.stroke();
  
  // Decorative corners
  drawCornerDeco(ctx, s.color, W, H);
  
  // Number at top
  ctx.fillStyle = s.color;
  ctx.font = 'bold 16px serif';
  ctx.textAlign = 'center';
  ctx.fillText(s.sub, W/2, 30);
  
  // Main symbol (large)
  ctx.font = '60px serif';
  ctx.fillStyle = s.color;
  ctx.fillText(s.sym, W/2, H/2 - 10);
  
  // Glow effect behind symbol
  ctx.shadowColor = s.color;
  ctx.shadowBlur = 20;
  ctx.fillText(s.sym, W/2, H/2 - 10);
  ctx.shadowBlur = 0;
  
  // Card name at bottom
  ctx.fillStyle = s.color;
  ctx.font = 'bold 18px "Noto Sans TC", sans-serif';
  ctx.fillText(card.n, W/2, H - 40);
  
  // Element
  ctx.font = '12px sans-serif';
  ctx.fillStyle = 'rgba('+hexToRgb(s.color)+',0.6)';
  ctx.fillText(card.el, W/2, H - 20);
}

function drawMinorCard(ctx, card, s, suit, rank){
  const W=180, H=280;
  
  // Background
  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, s.bg);
  grad.addColorStop(0.5, lighten(s.bg, 10));
  grad.addColorStop(1, s.bg);
  ctx.fillStyle = grad;
  roundRect(ctx, 0, 0, W, H, 12);
  ctx.fill();
  
  // Border
  ctx.strokeStyle = s.accent;
  ctx.lineWidth = 2;
  roundRect(ctx, 3, 3, W-6, H-6, 10);
  ctx.stroke();
  
  // Inner frame
  ctx.strokeStyle = 'rgba('+hexToRgb(s.accent)+',0.2)';
  ctx.lineWidth = 1;
  roundRect(ctx, 10, 10, W-20, H-20, 6);
  ctx.stroke();
  
  // Corners
  drawCornerDeco(ctx, s.accent, W, H);
  
  // Suit symbol at top
  ctx.font = '24px serif';
  ctx.fillStyle = s.color;
  ctx.textAlign = 'center';
  ctx.fillText(s.sym, W/2, 35);
  
  // Rank in center
  const courtSym = COURT_SYMBOLS[rank] || rank;
  if(['侍者','騎士','皇后','國王'].includes(rank)){
    // Court card: larger symbol
    ctx.font = '48px serif';
    ctx.fillStyle = s.color;
    ctx.fillText(courtSym, W/2, H/2);
    ctx.font = '14px sans-serif';
    ctx.fillStyle = 'rgba('+hexToRgb(s.color)+',0.7)';
    ctx.fillText(rank, W/2, H/2 + 25);
  } else if(rank === '王牌'){
    // Ace: big symbol
    ctx.font = '64px serif';
    ctx.shadowColor = s.color;
    ctx.shadowBlur = 15;
    ctx.fillStyle = s.color;
    ctx.fillText(s.sym, W/2, H/2 + 5);
    ctx.shadowBlur = 0;
  } else {
    // Number cards: draw pip pattern
    const num = ['二','三','四','五','六','七','八','九','十'].indexOf(rank) + 2;
    drawPips(ctx, s.sym, s.color, W, H, num || 1);
  }
  
  // Card name at bottom
  ctx.fillStyle = s.color;
  ctx.font = 'bold 16px "Noto Sans TC", sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(card.n, W/2, H - 38);
  
  // Suit name
  ctx.font = '11px sans-serif';
  ctx.fillStyle = 'rgba('+hexToRgb(s.color)+',0.5)';
  ctx.fillText(suit+'牌組', W/2, H - 20);
}

function drawPips(ctx, sym, color, W, H, count){
  ctx.font = '22px serif';
  ctx.fillStyle = color;
  ctx.textAlign = 'center';
  
  // Pip positions for 2-10
  const cx = W/2, cy = H/2;
  const positions = {
    2: [[cx,cy-30],[cx,cy+30]],
    3: [[cx,cy-35],[cx,cy],[cx,cy+35]],
    4: [[cx-25,cy-25],[cx+25,cy-25],[cx-25,cy+25],[cx+25,cy+25]],
    5: [[cx-25,cy-25],[cx+25,cy-25],[cx,cy],[cx-25,cy+25],[cx+25,cy+25]],
    6: [[cx-25,cy-30],[cx+25,cy-30],[cx-25,cy],[cx+25,cy],[cx-25,cy+30],[cx+25,cy+30]],
    7: [[cx-25,cy-35],[cx+25,cy-35],[cx-25,cy],[cx,cy],[cx+25,cy],[cx-25,cy+35],[cx+25,cy+35]],
    8: [[cx-25,cy-40],[cx+25,cy-40],[cx-25,cy-13],[cx+25,cy-13],[cx-25,cy+13],[cx+25,cy+13],[cx-25,cy+40],[cx+25,cy+40]],
    9: [[cx-25,cy-40],[cx+25,cy-40],[cx-25,cy-13],[cx+25,cy-13],[cx,cy],[cx-25,cy+13],[cx+25,cy+13],[cx-25,cy+40],[cx+25,cy+40]],
    10:[[cx-25,cy-45],[cx+25,cy-45],[cx-25,cy-18],[cx+25,cy-18],[cx,cy-8],[cx,cy+12],[cx-25,cy+22],[cx+25,cy+22],[cx-25,cy+48],[cx+25,cy+48]]
  };
  
  const pts = positions[count] || positions[2];
  pts.forEach(([x,y]) => ctx.fillText(sym, x, y+6));
}

function drawCornerDeco(ctx, color, W, H){
  ctx.strokeStyle = 'rgba('+hexToRgb(color)+',0.4)';
  ctx.lineWidth = 1;
  const d = 18;
  // Top-left
  ctx.beginPath(); ctx.moveTo(14,14+d); ctx.lineTo(14,14); ctx.lineTo(14+d,14); ctx.stroke();
  // Top-right
  ctx.beginPath(); ctx.moveTo(W-14-d,14); ctx.lineTo(W-14,14); ctx.lineTo(W-14,14+d); ctx.stroke();
  // Bottom-left
  ctx.beginPath(); ctx.moveTo(14,H-14-d); ctx.lineTo(14,H-14); ctx.lineTo(14+d,H-14); ctx.stroke();
  // Bottom-right
  ctx.beginPath(); ctx.moveTo(W-14-d,H-14); ctx.lineTo(W-14,H-14); ctx.lineTo(W-14,H-14-d); ctx.stroke();
}

function roundRect(ctx, x, y, w, h, r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

function hexToRgb(hex){
  hex = hex.replace('#','');
  if(hex.length===3) hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
  const r=parseInt(hex.substring(0,2),16);
  const g=parseInt(hex.substring(2,4),16);
  const b=parseInt(hex.substring(4,6),16);
  return r+','+g+','+b;
}

function lighten(hex, amt){
  hex = hex.replace('#','');
  if(hex.length===3) hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
  let r=parseInt(hex.substring(0,2),16);
  let g=parseInt(hex.substring(2,4),16);
  let b=parseInt(hex.substring(4,6),16);
  r=Math.min(255,r+amt); g=Math.min(255,g+amt); b=Math.min(255,b+amt);
  return '#'+r.toString(16).padStart(2,'0')+g.toString(16).padStart(2,'0')+b.toString(16).padStart(2,'0');
}

// Cache generated card images
const _tarotImageCache = {};
function getTarotCardImage(card){
  if(!_tarotImageCache[card.id]){
    _tarotImageCache[card.id] = generateTarotCardImage(card);
  }
  return _tarotImageCache[card.id];
}

/* =============================================================
   命理小遊戲 1: 五行猜猜看
   ============================================================= */
const WUXING_QUIZ_BANK = [
  {q:'「甲」屬於哪個五行？',a:'木',opts:['金','木','水','火','土']},
  {q:'「丙」屬於哪個五行？',a:'火',opts:['金','木','水','火','土']},
  {q:'「庚」屬於哪個五行？',a:'金',opts:['金','木','水','火','土']},
  {q:'「壬」屬於哪個五行？',a:'水',opts:['金','木','水','火','土']},
  {q:'「己」屬於哪個五行？',a:'土',opts:['金','木','水','火','土']},
  {q:'木生什麼？',a:'火',opts:['金','木','水','火','土']},
  {q:'火生什麼？',a:'土',opts:['金','木','水','火','土']},
  {q:'金生什麼？',a:'水',opts:['金','木','水','火','土']},
  {q:'水生什麼？',a:'木',opts:['金','木','水','火','土']},
  {q:'土生什麼？',a:'金',opts:['金','木','水','火','土']},
  {q:'水克什麼？',a:'火',opts:['金','木','水','火','土']},
  {q:'木克什麼？',a:'土',opts:['金','木','水','火','土']},
  {q:'火克什麼？',a:'金',opts:['金','木','水','火','土']},
  {q:'金克什麼？',a:'木',opts:['金','木','水','火','土']},
  {q:'土克什麼？',a:'水',opts:['金','木','水','火','土']},
  {q:'子時是幾點到幾點？',a:'23-01',opts:['23-01','01-03','05-07','11-13']},
  {q:'午時是幾點到幾點？',a:'11-13',opts:['09-11','11-13','13-15','07-09']},
  {q:'寅時是幾點到幾點？',a:'03-05',opts:['01-03','03-05','05-07','07-09']},
  {q:'紫水晶屬於哪個五行？',a:'火',opts:['金','木','水','火','土']},
  {q:'黃水晶屬於哪個五行？',a:'土',opts:['金','木','水','火','土']},
  {q:'綠幽靈屬於哪個五行？',a:'木',opts:['金','木','水','火','土']},
  {q:'海藍寶屬於哪個五行？',a:'水',opts:['金','木','水','火','土']},
  {q:'鈦晶屬於哪個五行？',a:'金',opts:['金','木','水','火','土']},
  {q:'「比肩」的十神關係是？',a:'同我',opts:['生我','同我','我生','我克','克我']},
  {q:'「正財」的十神關係是？',a:'我克',opts:['生我','同我','我生','我克','克我']},
  {q:'塔羅牌「愚者」的編號是？',a:'0',opts:['0','1','21','22']},
  {q:'塔羅大牌共有幾張？',a:'22',opts:['20','21','22','78']},
  {q:'八字的「日主」指的是？',a:'日柱天干',opts:['年柱天干','月柱天干','日柱天干','時柱天干']},
  {q:'「坤」卦代表什麼？',a:'地',opts:['天','地','水','火']},
  {q:'「乾」卦代表什麼？',a:'天',opts:['天','地','山','澤']}
];

let wxGame = {score:0, total:0, current:null, answered:false};

function startWuxingGame(){
  wxGame = {score:0, total:0, current:null, answered:false, questions:[]};
  // Pick 5 random questions
  const shuffled = [...WUXING_QUIZ_BANK].sort(()=>Math.random()-0.5);
  wxGame.questions = shuffled.slice(0, 5);
  nextWuxingQ();
}

function nextWuxingQ(){
  const container = document.getElementById('wuxing-game-content');
  if(!container) return;
  
  if(wxGame.total >= wxGame.questions.length){
    showWuxingResult();
    return;
  }
  
  wxGame.answered = false;
  wxGame.current = wxGame.questions[wxGame.total];
  const q = wxGame.current;
  
  container.innerHTML = `
    <div class="game-progress">第 ${wxGame.total+1}/${wxGame.questions.length} 題　得分：${wxGame.score}</div>
    <h4 class="game-question">${q.q}</h4>
    <div class="game-options">${q.opts.map(o=>`
      <button class="game-opt" onclick="answerWuxing('${o}',this)">${o}</button>`).join('')}
    </div>
    <div id="game-feedback" class="game-feedback"></div>`;
}

function answerWuxing(ans, btn){
  if(wxGame.answered) return;
  wxGame.answered = true;
  
  const correct = ans === wxGame.current.a;
  if(correct) wxGame.score++;
  wxGame.total++;
  
  // Highlight
  btn.classList.add(correct ? 'correct' : 'wrong');
  document.querySelectorAll('.game-opt').forEach(b=>{
    b.disabled = true;
    if(b.textContent === wxGame.current.a) b.classList.add('correct');
  });
  
  const fb = document.getElementById('game-feedback');
  fb.innerHTML = correct 
    ? '<span class="fb-correct">✅ 正確！</span>'
    : `<span class="fb-wrong">❌ 答案是「${wxGame.current.a}」</span>`;
  
  setTimeout(nextWuxingQ, 1200);
}

function showWuxingResult(){
  const container = document.getElementById('wuxing-game-content');
  if(!container) return;
  const pct = Math.round(wxGame.score / wxGame.questions.length * 100);
  let title, msg;
  if(pct >= 80){ title='🏆 命理達人'; msg='你對五行的掌握非常厲害！'; }
  else if(pct >= 60){ title='📚 用功學生'; msg='基礎不錯，再練練就更強了！'; }
  else if(pct >= 40){ title='🌱 命理新手'; msg='繼續學習，五行世界很有趣！'; }
  else{ title='🔰 初來乍到'; msg='多玩幾次就會進步啦！'; }
  
  container.innerHTML = `
    <div class="game-result">
      <div class="game-result-icon">${pct>=60?'🎉':'💪'}</div>
      <h3>${title}</h3>
      <div class="game-score-big">${wxGame.score} / ${wxGame.questions.length}</div>
      <p class="text-dim">${msg}</p>
      <div class="game-actions mt-md">
        <button class="btn btn-gold" onclick="startWuxingGame()"><i class="fas fa-redo"></i> 再玩一次</button>
      </div>
    </div>`;
}

/* =============================================================
   命理小遊戲 2: 每日生肖配對
   ============================================================= */
const ZODIAC_DATA = [
  {name:'鼠',icon:'🐭',el:'水',best:['龍','猴','牛'],avoid:['馬','羊','兔']},
  {name:'牛',icon:'🐂',el:'土',best:['鼠','蛇','雞'],avoid:['馬','羊','狗']},
  {name:'虎',icon:'🐯',el:'木',best:['馬','狗','豬'],avoid:['蛇','猴']},
  {name:'兔',icon:'🐰',el:'木',best:['羊','狗','豬'],avoid:['鼠','龍','雞']},
  {name:'龍',icon:'🐲',el:'土',best:['鼠','猴','雞'],avoid:['狗','兔']},
  {name:'蛇',icon:'🐍',el:'火',best:['牛','雞'],avoid:['虎','豬']},
  {name:'馬',icon:'🐴',el:'火',best:['虎','羊','狗'],avoid:['鼠','牛']},
  {name:'羊',icon:'🐑',el:'土',best:['兔','馬','豬'],avoid:['鼠','牛','狗']},
  {name:'猴',icon:'🐵',el:'金',best:['鼠','龍'],avoid:['虎','豬']},
  {name:'雞',icon:'🐔',el:'金',best:['牛','龍','蛇'],avoid:['兔','狗']},
  {name:'狗',icon:'🐶',el:'土',best:['虎','兔','馬'],avoid:['龍','牛','羊','雞']},
  {name:'豬',icon:'🐷',el:'水',best:['虎','兔','羊'],avoid:['蛇','猴']}
];

function renderZodiacMatch(){
  const container = document.getElementById('zodiac-match-content');
  if(!container) return;
  container.innerHTML = `
    <p class="text-sm text-dim mb-md">選擇兩個生肖，看看配對結果！</p>
    <div class="zodiac-grid">${ZODIAC_DATA.map(z=>`
      <button class="zodiac-btn" onclick="selectZodiac('${z.name}')" data-zodiac="${z.name}">
        <span class="zodiac-icon">${z.icon}</span>
        <span class="zodiac-name">${z.name}</span>
      </button>`).join('')}
    </div>
    <div id="zodiac-selected" class="zodiac-selected mt-md"></div>
    <div id="zodiac-result-area" class="mt-md"></div>`;
}

let zodiacPair = [];
function selectZodiac(name){
  if(zodiacPair.length >= 2) zodiacPair = [];
  zodiacPair.push(name);
  
  // Highlight
  document.querySelectorAll('.zodiac-btn').forEach(b=>{
    b.classList.toggle('selected', zodiacPair.includes(b.dataset.zodiac));
  });
  
  const selEl = document.getElementById('zodiac-selected');
  selEl.textContent = zodiacPair.join(' ❤️ ');
  
  if(zodiacPair.length === 2){
    showZodiacResult(zodiacPair[0], zodiacPair[1]);
  }
}

function showZodiacResult(a, b){
  const zA = ZODIAC_DATA.find(z=>z.name===a);
  const zB = ZODIAC_DATA.find(z=>z.name===b);
  if(!zA || !zB) return;
  
  let score, level, desc;
  if(zA.best.includes(b) && zB.best.includes(a)){
    score = 95; level = '天生一對 💕'; desc = `${a}與${b}是命理上的絕佳配對！彼此互補，感情和諧。`;
  } else if(zA.best.includes(b) || zB.best.includes(a)){
    score = 80; level = '相合有緣 ✨'; desc = `${a}與${b}有不錯的緣分，相處愉快，值得珍惜。`;
  } else if(zA.avoid.includes(b) || zB.avoid.includes(a)){
    score = 35; level = '需要磨合 ⚡'; desc = `${a}與${b}在傳統命理上有些沖突，但真愛可以跨越一切，多包容多理解就好。`;
  } else {
    score = 65; level = '平穩中性 ☁️'; desc = `${a}與${b}不特別沖也不特別合，關鍵看兩人的經營。`;
  }
  
  const resultEl = document.getElementById('zodiac-result-area');
  resultEl.innerHTML = `
    <div class="zodiac-result card" style="animation:scaleIn 0.4s">
      <div class="zodiac-pair-icons">${zA.icon} ❤️ ${zB.icon}</div>
      <div class="zodiac-match-score">${score}%</div>
      <div class="zodiac-match-level">${level}</div>
      <p class="text-sm">${desc}</p>
      <p class="text-xs text-muted mt-sm">五行：${a}(${zA.el}) × ${b}(${zB.el})</p>
      <button class="btn btn-outline btn-sm mt-md" onclick="shareZodiacMatch('${a}','${b}','${score}')">
        <i class="fas fa-share-alt"></i> 分享配對結果
      </button>
    </div>`;
}

function shareZodiacMatch(a, b, score){
  const text = `${a} ❤️ ${b} 配對指數 ${score}%！你跟誰配？快來測 👉 `;
  const url = window.location.href.split('?')[0];
  if(navigator.share) navigator.share({title:'生肖配對',text,url}).catch(()=>{});
  else { navigator.clipboard.writeText(text+url).then(()=>alert('已複製！')); }
}

/* =============================================================
   命理小遊戲 3: 幸運色 / 幸運數字產生器
   ============================================================= */
function generateLuckyInfo(){
  const container = document.getElementById('lucky-gen-content');
  if(!container) return;
  
  const today = new Date();
  const dayOfWeek = ['日','一','二','三','四','五','六'][today.getDay()];
  
  // Seed by date
  let seed = 0;
  const ds = today.toISOString().slice(0,10);
  for(let i=0;i<ds.length;i++) seed = ((seed<<5)-seed+ds.charCodeAt(i))|0;
  seed = Math.abs(seed);
  
  const colors = [
    {name:'紅色',hex:'#dc2626',el:'火',meaning:'熱情、行動力'},
    {name:'粉紅',hex:'#ec4899',el:'火',meaning:'愛情、人際'},
    {name:'橙色',hex:'#ea580c',el:'火',meaning:'活力、創造'},
    {name:'黃色',hex:'#eab308',el:'土',meaning:'財運、自信'},
    {name:'金色',hex:'#d4af37',el:'金',meaning:'權威、成就'},
    {name:'綠色',hex:'#16a34a',el:'木',meaning:'健康、成長'},
    {name:'藍色',hex:'#2563eb',el:'水',meaning:'智慧、溝通'},
    {name:'紫色',hex:'#9333ea',el:'火',meaning:'靈性、直覺'},
    {name:'白色',hex:'#f5f5f5',el:'金',meaning:'純淨、清晰'},
    {name:'黑色',hex:'#1a1a1a',el:'水',meaning:'保護、穩重'},
    {name:'棕色',hex:'#92400e',el:'土',meaning:'踏實、安定'},
    {name:'銀色',hex:'#94a3b8',el:'金',meaning:'冷靜、理性'}
  ];
  
  const luckyColor = colors[seed % colors.length];
  const luckyNum = (seed % 9) + 1;
  const luckyDir = ['東','南','西','北','東南','東北','西南','西北'][seed % 8];
  const luckyTime = ['子時(23-01)','丑時(01-03)','寅時(03-05)','卯時(05-07)','辰時(07-09)','巳時(09-11)','午時(11-13)','未時(13-15)','申時(15-17)','酉時(17-19)','戌時(19-21)','亥時(21-23)'][(seed*3) % 12];
  
  container.innerHTML = `
    <div class="lucky-card" style="animation:scaleIn 0.4s">
      <h4 class="text-gold mb-sm">📅 星期${dayOfWeek}的幸運指南</h4>
      <div class="lucky-grid">
        <div class="lucky-item">
          <div class="lucky-label">幸運色</div>
          <div class="lucky-value">
            <span class="lucky-color-dot" style="background:${luckyColor.hex}"></span>
            ${luckyColor.name}
          </div>
          <div class="lucky-sub">${luckyColor.el}行 · ${luckyColor.meaning}</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">幸運數字</div>
          <div class="lucky-value lucky-num">${luckyNum}</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">幸運方位</div>
          <div class="lucky-value">🧭 ${luckyDir}</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">最佳時辰</div>
          <div class="lucky-value">⏰ ${luckyTime}</div>
        </div>
      </div>
      <p class="text-xs text-muted mt-md">每日 00:00 更新 · 僅供參考娛樂</p>
    </div>`;
}

/* Init games */
document.addEventListener('DOMContentLoaded', function(){
  renderZodiacMatch();
  generateLuckyInfo();
});
</script></body></html>
