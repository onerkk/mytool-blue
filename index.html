<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes,viewport-fit=cover">
<meta name="description" content="éœæœˆä¹‹å…‰èƒ½é‡å åœå„€ï¼šæ•´åˆå…«å­—ã€ç´«å¾®æ–—æ•¸ã€æ¢…èŠ±æ˜“æ•¸ã€å¡”ç¾…ç‰Œçš„å¤šç¶­åº¦å‘½ç†åˆ†æç³»çµ±">
<meta name="theme-color" content="#1a0a0a">
<title>éœæœˆä¹‹å…‰èƒ½é‡å åœå„€ v3.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* ================================================================
   éœæœˆä¹‹å…‰ v3.0 â€” Complete Design System
   Aesthetic: Chinese Traditional Luxury (ç´…é‡‘å‚³çµ±å¥¢è¯)
   ================================================================ */
:root{
  --c-bg-deep:#0d0404;--c-bg:#1a0808;--c-bg-card:#1e0c0c;--c-bg-card-alt:#251010;
  --c-surface:rgba(255,255,255,0.04);--c-border:rgba(212,175,55,0.18);--c-border-hi:rgba(212,175,55,0.45);
  --c-gold:#d4af37;--c-gold-light:#e8c968;--c-gold-pale:#f5e6b8;
  --c-crimson:#8b0000;--c-crimson-hi:#b22222;
  --c-text:#f5e6d3;--c-text-dim:rgba(245,230,211,0.65);--c-text-muted:rgba(245,230,211,0.4);
  --c-success:#4ade80;--c-warn:#fbbf24;--c-danger:#f87171;--c-info:#60a5fa;
  --el-metal:#c0c0c0;--el-wood:#22c55e;--el-water:#3b82f6;--el-fire:#ef4444;--el-earth:#a78b5a;
  --f-display:'Noto Serif TC',serif;--f-body:'Noto Sans TC',sans-serif;
  --sp-xs:0.25rem;--sp-sm:0.5rem;--sp-md:1rem;--sp-lg:1.5rem;--sp-xl:2.5rem;
  --r-sm:8px;--r-md:14px;--r-lg:20px;--r-pill:999px;
  --sh-card:0 4px 24px rgba(0,0,0,0.4),0 0 0 1px var(--c-border);
  --t-fast:0.2s cubic-bezier(0.4,0,0.2,1);--t-smooth:0.4s cubic-bezier(0.4,0,0.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{
  font-family:var(--f-body);color:var(--c-text);
  background:var(--c-bg-deep);
  background-image:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(139,0,0,0.25) 0%,transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 100%,rgba(139,0,0,0.15) 0%,transparent 50%);
  background-attachment:fixed;min-height:100vh;line-height:1.6;
  -webkit-font-smoothing:antialiased;overflow-x:hidden;
}
a{color:var(--c-gold);text-decoration:none;transition:color var(--t-fast)}
a:hover{color:var(--c-gold-light)}
button,input,select,textarea{font-family:inherit;font-size:inherit;color:inherit}
::selection{background:rgba(212,175,55,0.3);color:#fff}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--c-bg)}
::-webkit-scrollbar-thumb{background:rgba(212,175,55,0.3);border-radius:3px}

/* â€” Layout â€” */
.app{max-width:960px;margin:0 auto;padding:0 var(--sp-md);padding-bottom:calc(env(safe-area-inset-bottom,0px) + 1rem)}

/* â€” Navigation â€” */
.nav{position:sticky;top:0;z-index:100;background:rgba(13,4,4,0.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--c-border);padding:0.75rem var(--sp-md)}
.nav-inner{max-width:960px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:var(--sp-md)}
.nav-brand{display:flex;align-items:center;gap:var(--sp-sm);font-family:var(--f-display);font-weight:700;font-size:1.1rem;color:var(--c-gold)}
.nav-brand i{font-size:1.3rem}
.nav-links{display:flex;gap:var(--sp-xs);flex-wrap:wrap}
.nav-link{padding:0.4rem 0.75rem;border-radius:var(--r-pill);font-size:0.8rem;font-weight:500;color:var(--c-text-dim);border:1px solid transparent;transition:all var(--t-fast);cursor:pointer;background:none;white-space:nowrap}
.nav-link:hover,.nav-link.active{color:var(--c-gold);border-color:var(--c-border-hi);background:rgba(212,175,55,0.08)}

/* â€” Step Sections â€” */
.step{display:none;animation:fadeIn .45s ease both}
.step.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
@keyframes slideInLeft{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}

.result-verdict{animation:scaleIn .6s ease .1s both}
.card{animation:fadeIn .5s ease both}
.card:nth-child(2){animation-delay:.1s}
.card:nth-child(3){animation-delay:.2s}
.card:nth-child(4){animation-delay:.3s}
.verdict-prob{
  background-size:200% 100%;
  animation:shimmer 3s ease-in-out infinite;
  background-image:linear-gradient(90deg,var(--c-gold),var(--c-gold-light),#fff,var(--c-gold-light),var(--c-gold));
  -webkit-background-clip:text;background-clip:text;
}
.hero-icon{animation:pulse 3s ease-in-out infinite}
.dy-item{animation:slideInLeft .3s ease both}
.dy-item:nth-child(2){animation-delay:.05s}
.dy-item:nth-child(3){animation-delay:.1s}
.dy-item:nth-child(4){animation-delay:.15s}
.dy-item:nth-child(5){animation-delay:.2s}

/* â€” Cards â€” */
.card{background:var(--c-bg-card);border:1px solid var(--c-border);border-radius:var(--r-lg);padding:var(--sp-lg);margin-bottom:var(--sp-lg);box-shadow:var(--sh-card);transition:border-color var(--t-fast)}
.card:hover{border-color:var(--c-border-hi)}
.card-title{font-family:var(--f-display);font-weight:700;font-size:1.15rem;color:var(--c-gold);margin-bottom:var(--sp-md);display:flex;align-items:center;gap:var(--sp-sm)}
.card-title i{font-size:1rem;opacity:.8}

/* â€” Buttons â€” */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:var(--sp-sm);padding:.75rem 1.25rem;border-radius:var(--r-md);font-weight:600;font-size:.95rem;cursor:pointer;border:1px solid var(--c-border-hi);transition:all var(--t-fast);white-space:nowrap}
.btn-primary{background:linear-gradient(135deg,var(--c-crimson),#6b0000);color:var(--c-gold-pale);border-color:var(--c-gold);box-shadow:0 2px 12px rgba(139,0,0,.4)}
.btn-primary:hover{background:linear-gradient(135deg,var(--c-crimson-hi),var(--c-crimson));box-shadow:0 4px 20px rgba(139,0,0,.6);transform:translateY(-1px)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-outline{background:transparent;color:var(--c-text-dim);border-color:rgba(255,255,255,.15)}
.btn-outline:hover{color:var(--c-gold);border-color:var(--c-border-hi);background:rgba(212,175,55,.06)}
.btn-gold{background:linear-gradient(135deg,var(--c-gold),#b8941f);color:var(--c-bg-deep);border:none;font-weight:700}
.btn-gold:hover{box-shadow:0 4px 20px rgba(212,175,55,.4);transform:translateY(-1px)}
.btn-sm{padding:.5rem .85rem;font-size:.85rem}
.btn-tab-active{background:linear-gradient(135deg,var(--c-crimson),#6b0000)!important;color:var(--c-gold-pale)!important;border-color:var(--c-gold)!important}
.btn-lg{padding:1rem 2rem;font-size:1.05rem}
.btn-block{width:100%}

/* â€” Form â€” */
.form-group{margin-bottom:var(--sp-lg)}
.form-label{display:block;font-size:.9rem;font-weight:600;color:var(--c-text);margin-bottom:var(--sp-xs)}
.form-label .req{color:var(--c-danger);margin-left:2px}
.form-hint{font-size:.8rem;color:var(--c-text-muted);margin-top:var(--sp-xs)}
.form-input,.form-select,.form-textarea{width:100%;padding:.75rem 1rem;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:var(--r-sm);color:var(--c-text);font-size:1rem;transition:border-color var(--t-fast),box-shadow var(--t-fast)}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--c-gold);box-shadow:0 0 0 3px rgba(212,175,55,.15)}
.form-textarea{resize:vertical;min-height:80px}
.radio-pills{display:flex;gap:var(--sp-sm);flex-wrap:wrap}
.radio-pill{position:relative}
.radio-pill input{position:absolute;opacity:0;pointer-events:none}
.radio-pill span{display:inline-block;padding:.6rem 1.2rem;border:1px solid rgba(255,255,255,.12);border-radius:var(--r-pill);cursor:pointer;font-size:.9rem;transition:all var(--t-fast)}
.radio-pill input:checked+span{border-color:var(--c-gold);color:var(--c-gold);background:rgba(212,175,55,.12)}

/* â€” Stepper â€” */
.stepper{display:flex;align-items:center;justify-content:center;padding:var(--sp-md) 0;margin-bottom:var(--sp-md)}
.stepper-item{display:flex;align-items:center;gap:.4rem;font-size:.8rem;color:var(--c-text-muted);transition:color var(--t-fast)}
.stepper-item.active{color:var(--c-gold);font-weight:600}
.stepper-item.done{color:var(--c-success)}
.stepper-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.15);font-size:.75rem;font-weight:700;transition:all var(--t-fast)}
.stepper-item.active .stepper-dot{border-color:var(--c-gold);background:rgba(212,175,55,.15);color:var(--c-gold)}
.stepper-item.done .stepper-dot{border-color:var(--c-success);background:rgba(74,222,128,.15);color:var(--c-success)}
.stepper-line{width:30px;height:2px;background:rgba(255,255,255,.1);margin:0 .3rem}

/* â€” Hero â€” */
.hero{text-align:center;padding:var(--sp-xl) 0 var(--sp-lg)}
.hero-icon{font-size:2.5rem;color:var(--c-gold);margin-bottom:var(--sp-md);text-shadow:0 0 40px rgba(212,175,55,.4)}
.hero h1{font-family:var(--f-display);font-weight:900;font-size:clamp(1.5rem,5vw,2.2rem);color:var(--c-gold-light);margin-bottom:var(--sp-sm);letter-spacing:.05em}
.hero p{color:var(--c-text-dim);font-size:.95rem;max-width:500px;margin:0 auto}

/* â€” BaZi Grid â€” */
.bazi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;background:var(--c-border);border-radius:var(--r-md);overflow:hidden;margin:var(--sp-md) 0}
.bazi-cell{background:var(--c-bg-card);padding:var(--sp-sm) var(--sp-xs);text-align:center}
.bazi-cell.header{background:rgba(212,175,55,.08);font-size:.75rem;color:var(--c-text-dim);font-weight:600}
.bazi-cell .gz{font-family:var(--f-display);font-size:1.3rem;font-weight:700;display:block;margin-bottom:2px}
.bazi-cell .gz-sub{font-size:.7rem;color:var(--c-text-muted)}
.el-tag{display:inline-block;padding:1px 6px;border-radius:var(--r-pill);font-size:.65rem;font-weight:600;margin-top:2px}
.el-é‡‘{background:rgba(192,192,192,.15);color:var(--el-metal)}
.el-æœ¨{background:rgba(34,197,94,.15);color:var(--el-wood)}
.el-æ°´{background:rgba(59,130,246,.15);color:var(--el-water)}
.el-ç«{background:rgba(239,68,68,.15);color:var(--el-fire)}
.el-åœŸ{background:rgba(167,139,90,.15);color:var(--el-earth)}

/* â€” Five Element Bar â€” */
.el-bar{margin:var(--sp-sm) 0}
.el-row{display:flex;align-items:center;gap:var(--sp-sm);margin-bottom:6px}
.el-lbl{width:28px;text-align:center;font-weight:700;font-size:.85rem}
.el-track{flex:1;height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden}
.el-fill{height:100%;border-radius:4px;transition:width .8s ease}
.el-val{width:36px;text-align:right;font-size:.8rem;color:var(--c-text-dim)}

/* â€” DaYun Timeline â€” */
.dayun-tl{display:flex;overflow-x:auto;gap:2px;padding:var(--sp-sm) 0;-webkit-overflow-scrolling:touch}
.dy-item{flex:0 0 auto;min-width:72px;padding:var(--sp-sm);text-align:center;border-radius:var(--r-sm);border:1px solid var(--c-border);background:var(--c-bg-card);cursor:pointer;transition:all var(--t-fast);font-size:.8rem}
.dy-item.current{border-color:var(--c-gold);background:rgba(212,175,55,.1)}
.dy-item .dy-gz{font-family:var(--f-display);font-weight:700;font-size:1rem;display:block}
.dy-item .dy-age{color:var(--c-text-muted);font-size:.7rem}
.dy-item .dy-lv{display:inline-block;padding:1px 6px;border-radius:var(--r-pill);font-size:.65rem;font-weight:600;margin-top:4px}
.lv-dj{background:rgba(74,222,128,.15);color:var(--c-success)}
.lv-zj{background:rgba(96,165,250,.15);color:var(--c-info)}
.lv-xj{background:rgba(212,175,55,.15);color:var(--c-gold)}
.lv-p{background:rgba(255,255,255,.08);color:var(--c-text-dim)}
.lv-xk{background:rgba(251,191,36,.15);color:var(--c-warn)}
.lv-zk{background:rgba(248,113,113,.15);color:var(--c-danger)}
.lv-dk{background:rgba(180,40,40,.2);color:#ff6b6b}

/* â€” Hexagram â€” */
.hex-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp-md);margin:var(--sp-md) 0}
.hex-card{text-align:center;padding:var(--sp-md);background:rgba(0,0,0,.2);border:1px solid var(--c-border);border-radius:var(--r-md)}
.hex-card h4{color:var(--c-text-dim);font-size:.8rem;margin-bottom:var(--sp-sm)}
.hex-sym{font-size:2.5rem;line-height:1;margin-bottom:var(--sp-xs)}
.hex-name{font-family:var(--f-display);font-weight:700;color:var(--c-gold)}

/* â€” Tarot â€” */
.tarot-hand{display:flex;justify-content:center;gap:var(--sp-sm);flex-wrap:wrap;padding:var(--sp-lg) 0}
.t-card{width:76px;height:114px;perspective:600px;cursor:pointer}
.t-card-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .6s ease}
.t-card.flipped .t-card-inner{transform:rotateY(180deg)}
.t-card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:.7rem;text-align:center;padding:4px}
.t-back{background:linear-gradient(135deg,#2a1a3e,#1a0a2e);border:2px solid var(--c-gold);color:var(--c-gold)}
.t-back::after{content:'âœ¦';font-size:1.5rem;opacity:.6}
.t-front{transform:rotateY(180deg);background:var(--c-bg-card-alt);border:2px solid var(--c-border-hi);color:var(--c-text);gap:2px}
.t-front .tc-name{font-family:var(--f-display);font-weight:700;font-size:.72rem;color:var(--c-gold)}
.t-front .tc-dir{font-size:.6rem;color:var(--c-text-dim)}

/* â€” Result â€” */
.result-verdict{text-align:center;padding:var(--sp-lg);border:2px solid var(--c-gold);border-radius:var(--r-lg);background:linear-gradient(180deg,rgba(212,175,55,.08),rgba(139,0,0,.08));margin-bottom:var(--sp-lg)}
.verdict-label{font-family:var(--f-display);font-weight:900;font-size:1.8rem;color:var(--c-gold-light);margin-bottom:var(--sp-xs)}
.verdict-prob{font-size:2.5rem;font-weight:900;background:linear-gradient(135deg,var(--c-gold),var(--c-gold-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.verdict-note{color:var(--c-text-dim);font-size:.9rem;margin-top:var(--sp-sm)}
.prob-meter{margin:var(--sp-md) 0}
.prob-bar{height:12px;background:rgba(255,255,255,.06);border-radius:6px;overflow:hidden}
.prob-fill{height:100%;border-radius:6px;background:linear-gradient(90deg,var(--c-crimson),var(--c-gold),var(--c-success));transition:width 1.2s cubic-bezier(.4,0,.2,1)}
.prob-labels{display:flex;justify-content:space-between;font-size:.7rem;color:var(--c-text-muted);margin-top:4px}

/* â€” Dimension Tabs â€” */
.dim-tabs{display:flex;gap:2px;margin-bottom:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.dim-tab{flex:0 0 auto;padding:.6rem 1rem;border-radius:var(--r-sm) var(--r-sm) 0 0;background:rgba(255,255,255,.04);border:1px solid var(--c-border);border-bottom:none;font-size:.85rem;font-weight:500;color:var(--c-text-dim);cursor:pointer;transition:all var(--t-fast);white-space:nowrap}
.dim-tab.active{background:var(--c-bg-card);color:var(--c-gold);border-color:var(--c-border-hi)}
.dim-pane{display:none;padding:var(--sp-lg);background:var(--c-bg-card);border:1px solid var(--c-border);border-radius:0 var(--r-md) var(--r-md) var(--r-md)}
.dim-pane.active{display:block;animation:fadeIn .3s ease}

/* â€” Conclusion â€” */
.conclusion{background:linear-gradient(135deg,rgba(139,0,0,.15),rgba(212,175,55,.08));border:1px solid var(--c-border-hi);border-radius:var(--r-lg);padding:var(--sp-lg);margin-top:var(--sp-lg)}
.conclusion h3{font-family:var(--f-display);color:var(--c-gold);margin-bottom:var(--sp-md)}

/* â€” Actions â€” */
.actions{display:flex;gap:var(--sp-sm);justify-content:space-between;margin-top:var(--sp-lg);flex-wrap:wrap}
.actions-center{justify-content:center}

/* â€” Utilities â€” */
.text-gold{color:var(--c-gold)}.text-dim{color:var(--c-text-dim)}.text-muted{color:var(--c-text-muted)}
.text-success{color:var(--c-success)}.text-warn{color:var(--c-warn)}.text-danger{color:var(--c-danger)}
.text-center{text-align:center}.text-sm{font-size:.85rem}.text-xs{font-size:.75rem}
.mt-sm{margin-top:var(--sp-sm)}.mt-md{margin-top:var(--sp-md)}.mt-lg{margin-top:var(--sp-lg)}
.mb-sm{margin-bottom:var(--sp-sm)}.mb-md{margin-bottom:var(--sp-md)}.mb-lg{margin-bottom:var(--sp-lg)}
.hidden{display:none!important}
.serif{font-family:var(--f-display)}
.tag{display:inline-block;padding:2px 8px;border-radius:var(--r-pill);font-size:.75rem;font-weight:600}
.tag-gold{background:rgba(212,175,55,.15);color:var(--c-gold)}
.tag-red{background:rgba(239,68,68,.15);color:var(--c-danger)}
.tag-green{background:rgba(74,222,128,.15);color:var(--c-success)}
.tag-blue{background:rgba(96,165,250,.15);color:var(--c-info)}
.divider{height:1px;background:linear-gradient(90deg,transparent,var(--c-border-hi),transparent);margin:var(--sp-lg) 0}

/* â€” ZiWei Grid â€” */
.zw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;background:var(--c-border);border-radius:var(--r-md);overflow:hidden;margin:var(--sp-md) 0}
.zw-cell{background:var(--c-bg-card);padding:var(--sp-sm);min-height:85px;font-size:.75rem;position:relative}
.zw-cell.zw-center{grid-column:2/4;grid-row:2/4;display:flex;align-items:center;justify-content:center;flex-direction:column;background:var(--c-bg-card-alt);text-align:center;min-height:170px}
.zw-palace{font-weight:700;color:var(--c-gold);font-size:.8rem;margin-bottom:2px}
.zw-branch{font-size:.65rem;color:var(--c-text-muted)}
.zw-stars{margin-top:3px;line-height:1.5}
.zw-star{display:inline;margin-right:3px}
.zw-star.major{color:var(--c-gold-light);font-weight:600}
.zw-star.minor{color:var(--c-text-dim)}
.zw-hua{font-size:.55rem;padding:0 2px;border-radius:2px;background:rgba(212,175,55,.2);color:var(--c-gold);vertical-align:super;margin-left:1px}
.zw-cell.active-palace{border:1px solid var(--c-gold);background:rgba(212,175,55,.06)}

/* â€” Crystal â€” */
.crystal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:var(--sp-md);margin:var(--sp-md) 0}
.crystal-card{padding:var(--sp-md);border-radius:var(--r-md);border:1px solid var(--c-border);background:var(--c-bg-card);text-align:center;transition:all var(--t-fast)}
.crystal-card:hover{border-color:var(--c-gold);transform:translateY(-2px)}
.crystal-icon{font-size:2rem;margin-bottom:var(--sp-sm)}
.crystal-name{font-family:var(--f-display);font-weight:700;color:var(--c-gold);margin-bottom:var(--sp-xs)}

/* â€” Responsive â€” */
@media(max-width:640px){
  .bazi-cell .gz{font-size:1.1rem}
  .nav-links{display:none}
  .stepper{flex-wrap:wrap;gap:.3rem}
  .stepper-line{width:16px}
  .hex-grid{gap:var(--sp-sm)}
}
@media(max-width:380px){
  .hero h1{font-size:1.3rem}
  .card{padding:var(--sp-md)}
}

/* â€” Shop Buttons â€” */
.shop-btns{display:flex;flex-direction:column;gap:var(--sp-sm)}
.shop-btn-card{display:flex;align-items:center;gap:var(--sp-md);padding:.85rem 1rem;border-radius:var(--r-md);border:1px solid var(--c-border);background:var(--c-bg-card-alt);color:var(--c-text);text-decoration:none;transition:all var(--t-fast);cursor:pointer;font-family:inherit;font-size:inherit;text-align:left;width:100%}
.shop-btn-card:hover{border-color:var(--c-gold);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.shop-btn-card i{font-size:1.3rem;width:32px;text-align:center;flex:0 0 auto}
.shop-btn-card div{display:flex;flex-direction:column;gap:1px}
.shop-btn-card.shopee i{color:#ee4d2d}
.shop-btn-card.seven i{color:#00a040}
.shop-btn-card.custom i{color:var(--c-gold)}
.shop-btn-card strong{color:var(--c-text)}
.shop-card{border-color:rgba(212,175,55,.3);background:linear-gradient(135deg,rgba(139,0,0,.08),rgba(212,175,55,.05))}

/* â€” Nav Shop â€” */
.nav-shop{display:flex;gap:var(--sp-xs);align-items:center}
.nav-shop a{font-size:.75rem;padding:.35rem .6rem;border-radius:var(--r-pill);border:1px solid rgba(255,255,255,.12);color:var(--c-text-dim);transition:all var(--t-fast);white-space:nowrap}
.nav-shop a:hover{border-color:var(--c-gold);color:var(--c-gold)}

/* â€” Modal â€” */
.modal-overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:var(--sp-md)}
.modal-box{background:var(--c-bg-card);border:1px solid var(--c-border-hi);border-radius:var(--r-lg);padding:var(--sp-lg);max-width:480px;width:100%;max-height:90vh;overflow-y:auto;position:relative;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:scaleIn .3s ease}
.modal-close{position:absolute;top:var(--sp-sm);right:var(--sp-md);background:none;border:none;color:var(--c-text-dim);font-size:1.5rem;cursor:pointer;padding:4px 8px;border-radius:var(--r-sm);transition:color var(--t-fast)}
.modal-close:hover{color:var(--c-gold)}

/* â€” Floating Buttons â€” */
.floating-root{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 20px);right:16px;z-index:900;display:flex;flex-direction:column-reverse;align-items:flex-end;gap:var(--sp-sm)}
.fab{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(212,175,55,.5);cursor:pointer;transition:all var(--t-fast);text-decoration:none;font-family:inherit;flex-direction:column;gap:2px;font-size:.6rem;color:var(--c-text)}
.fab i{font-size:1rem}
.fab span{font-size:.5rem;line-height:1}
.fab-toggle{background:linear-gradient(135deg,var(--c-crimson),#6b0000);color:var(--c-gold-pale);box-shadow:0 4px 16px rgba(139,0,0,.5)}
.fab-toggle:hover{transform:scale(1.1)}
.fab-shopee{background:rgba(238,77,45,.15);color:#ee4d2d;border-color:rgba(238,77,45,.4)}
.fab-711{background:rgba(0,160,64,.15);color:#00a040;border-color:rgba(0,160,64,.4)}
.fab-custom{background:rgba(212,175,55,.12);color:var(--c-gold);border-color:rgba(212,175,55,.4)}
.fab-menu{display:flex;flex-direction:column-reverse;gap:var(--sp-sm)}
.fab-menu.hidden{display:none}
@media(max-width:640px){
  .fab{width:44px;height:44px}
  .fab span{display:none}
}

/* â€” Product Grid â€” */
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:var(--sp-md);margin:var(--sp-md) 0}
.product-card{display:flex;gap:var(--sp-md);padding:var(--sp-md);border:1px solid var(--c-border);border-radius:var(--r-md);background:var(--c-bg-card-alt);transition:border-color var(--t-fast)}
.product-card:hover{border-color:var(--c-gold)}
.product-icon{font-size:2rem;flex:0 0 auto;padding-top:2px}
.product-body{flex:1;min-width:0}
.product-name{font-weight:700;color:var(--c-text);font-size:1rem;margin-bottom:4px}
.product-meta{display:flex;gap:var(--sp-xs);margin-bottom:var(--sp-xs)}
.product-desc{font-size:.85rem;color:var(--c-text-dim);margin-bottom:var(--sp-xs);line-height:1.5}
.product-price{font-size:1.1rem;font-weight:700;color:var(--c-gold);margin-bottom:var(--sp-xs)}
.product-wear{font-size:.78rem;color:var(--c-text-muted);margin-bottom:var(--sp-sm)}
.product-actions{display:flex;gap:var(--sp-xs)}
.product-btn{display:inline-flex;align-items:center;gap:4px;padding:.4rem .7rem;border-radius:var(--r-sm);border:1px solid var(--c-border);font-size:.78rem;text-decoration:none;color:var(--c-text);transition:all var(--t-fast)}
.product-btn:hover{border-color:var(--c-gold);color:var(--c-gold)}
.product-btn.shopee:hover{border-color:#ee4d2d;color:#ee4d2d}
.product-btn.seven:hover{border-color:#00a040;color:#00a040}
.btn-full{width:100%;justify-content:center;padding:.9rem}
.custom-cta{text-align:center}

/* â€” Share Gate â€” */
.share-gate-card{border:2px dashed rgba(212,175,55,.4);border-radius:var(--r-lg);padding:var(--sp-lg);text-align:center;background:linear-gradient(135deg,rgba(212,175,55,.04),rgba(139,0,0,.04))}
.share-gate-card h4{color:var(--c-gold);margin-bottom:var(--sp-sm)}
.share-gate-card p{color:var(--c-text-dim);font-size:.9rem;margin-bottom:var(--sp-md)}
.btn-share-big{padding:.85rem 2rem;font-size:1rem;border-radius:var(--r-pill);background:linear-gradient(135deg,#25D366,#128C7E);color:#fff;border:none;cursor:pointer;transition:all var(--t-fast);font-weight:700}
.btn-share-big:hover{transform:scale(1.03);box-shadow:0 4px 20px rgba(37,211,102,.3)}
.btn-save-card{padding:.7rem 1.5rem;font-size:.9rem;border-radius:var(--r-pill);background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;cursor:pointer;transition:all var(--t-fast);font-weight:600}
.btn-save-card:hover{transform:scale(1.03);box-shadow:0 4px 20px rgba(118,75,162,.3)}

/* â€” Urgency Strip â€” */
.urgency-strip{display:flex;gap:var(--sp-sm);flex-wrap:wrap;margin-top:var(--sp-xs);font-size:.72rem}
.urgency-critical{color:#ff4444;font-weight:700;animation:pulse 2s infinite}
.urgency-normal{color:rgba(255,255,255,.6)}
.urgency-views{color:rgba(255,255,255,.45)}

/* â€” Social Proof â€” */
.social-proof{border:1px solid rgba(212,175,55,.2);border-radius:var(--r-md);padding:var(--sp-md);margin:var(--sp-md) 0;background:rgba(212,175,55,.04)}
.sp-item{font-size:.85rem;color:var(--c-text-dim);margin:var(--sp-xs) 0}
.sp-item strong{color:var(--c-gold)}

/* â€” Live Counter + Marquee â€” */
.live-counter-bar{display:flex;align-items:center;justify-content:center;gap:var(--sp-md);padding:var(--sp-sm) var(--sp-md);background:rgba(212,175,55,.06);border:1px solid rgba(212,175,55,.15);border-radius:var(--r-md);margin-bottom:var(--sp-lg);font-size:.85rem;color:var(--c-text-dim);flex-wrap:wrap}
.live-counter-bar strong{color:var(--c-gold);font-size:1.1rem}
.live-marquee{text-align:center;font-size:.78rem;color:rgba(255,255,255,.55);padding:var(--sp-xs);transition:opacity .3s;min-height:1.4em;margin-bottom:var(--sp-md)}

/* â€” Discount Reveal â€” */
.discount-reveal{border:2px solid var(--c-gold);border-radius:var(--r-lg);padding:var(--sp-lg);text-align:center;background:linear-gradient(135deg,rgba(212,175,55,.08),rgba(139,0,0,.06));margin-top:var(--sp-md)}
.discount-code{font-size:1.8rem;font-weight:900;color:var(--c-gold);letter-spacing:4px;font-family:monospace;padding:var(--sp-md);background:rgba(0,0,0,.3);border-radius:var(--r-md);display:inline-block;margin:var(--sp-sm) 0}

/* â€” PWA Banner â€” */
.pwa-banner{position:fixed;top:0;left:0;right:0;z-index:800;background:linear-gradient(135deg,#1a0505,#2D0A0A);border-bottom:2px solid var(--c-gold);padding:var(--sp-sm) var(--sp-md);display:flex;align-items:center;gap:var(--sp-md);box-shadow:0 4px 20px rgba(0,0,0,.5);animation:slideDown .4s ease}
@keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
.pwa-banner.hidden{display:none}
.pwa-banner-text{flex:1;font-size:.85rem;color:var(--c-text)}
.pwa-banner-text strong{color:var(--c-gold)}
.pwa-install-btn{padding:.5rem 1rem;border-radius:var(--r-pill);background:var(--c-gold);color:#2D0A0A;border:none;font-weight:700;cursor:pointer;white-space:nowrap;font-size:.85rem}
.pwa-close-btn{background:none;border:none;color:var(--c-text-dim);font-size:1.2rem;cursor:pointer;padding:4px}

/* â€” Remind Button â€” */
.btn-remind{padding:.6rem 1.2rem;border-radius:var(--r-pill);border:1px solid rgba(212,175,55,.4);background:rgba(212,175,55,.08);color:var(--c-gold);cursor:pointer;font-size:.85rem;transition:all var(--t-fast)}
.btn-remind:hover{background:rgba(212,175,55,.15);border-color:var(--c-gold)}

/* â€” Print (after all shop/fab styles) â€” */
@media print{
  .nav,.stepper,.actions,.btn,.floating-root,.shop-card,.modal-overlay{display:none!important}
  body{background:#fff!important;color:#000!important}
  .card,.dim-pane,.conclusion{border:1px solid #ccc!important;background:#fff!important;box-shadow:none!important}
  .text-gold,.card-title,.verdict-label,.hex-name,.zw-palace{color:#8b0000!important}
  .tag{border:1px solid #ccc}
  .prob-fill{background:#8b0000!important}
  .step{display:none!important}
  #step-3{display:block!important}
  .dim-pane{display:block!important;margin-bottom:1rem}
  .dim-tabs{display:none!important}
}
/* =============================================================
   UI POLISH v2 â€” å…¨ç«™è¦–è¦ºå‡ç´š
   ============================================================= */

/* â”€â”€ èƒŒæ™¯ï¼šæ·±è‰²æ¼¸å±¤ + å¾®å…‰ç²’å­æ„Ÿ â”€â”€ */
body::before{
  content:'';position:fixed;inset:0;z-index:-1;
  background:
    radial-gradient(ellipse 600px 400px at 20% 10%, rgba(139,0,0,0.15), transparent),
    radial-gradient(ellipse 500px 350px at 80% 85%, rgba(212,175,55,0.06), transparent),
    radial-gradient(ellipse 300px 300px at 50% 50%, rgba(139,0,0,0.05), transparent);
  pointer-events:none;
}

/* â”€â”€ å°èˆªåˆ—å‡ç´š â”€â”€ */
.nav{
  background:rgba(13,4,4,0.88)!important;
  backdrop-filter:blur(16px) saturate(1.4)!important;
  border-bottom:1px solid rgba(212,175,55,0.12)!important;
  box-shadow:0 2px 20px rgba(0,0,0,0.3);
}
.nav-brand i{
  text-shadow:0 0 16px rgba(212,175,55,0.5);
}

/* â”€â”€ Hero é‡è¨­è¨ˆ â”€â”€ */
.hero{
  padding:var(--sp-xl) var(--sp-md) var(--sp-lg)!important;
  text-align:center;
  position:relative;
}
.hero::before{
  content:'';position:absolute;top:-20px;left:50%;transform:translateX(-50%);
  width:200px;height:200px;
  background:radial-gradient(circle,rgba(212,175,55,0.12) 0%,transparent 70%);
  border-radius:50%;pointer-events:none;
}
.hero-icon{
  font-size:3rem!important;
  text-shadow:0 0 40px rgba(212,175,55,0.5),0 0 80px rgba(212,175,55,0.2)!important;
  position:relative;z-index:1;
}
.hero h1{
  font-size:clamp(1.5rem,5vw,2.2rem)!important;
  background:linear-gradient(135deg,#d4af37 0%,#f5e6b8 40%,#d4af37 60%,#b8941f 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
  line-height:1.4!important;
  letter-spacing:0.05em;
}
.hero p{
  color:var(--c-text-dim)!important;font-size:0.95rem!important;
  letter-spacing:0.08em;
}

/* â”€â”€ å¡ç‰‡ç»ç’ƒæ…‹ â”€â”€ */
.card{
  background:rgba(30,12,12,0.75)!important;
  backdrop-filter:blur(8px);
  border:1px solid rgba(212,175,55,0.12)!important;
  box-shadow:0 8px 32px rgba(0,0,0,0.3),inset 0 1px 0 rgba(255,255,255,0.03)!important;
}
.card:hover{
  border-color:rgba(212,175,55,0.25)!important;
  box-shadow:0 12px 40px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.05)!important;
}

/* â”€â”€ å¡ç‰‡æ¨™é¡Œè£é£¾ç·š â”€â”€ */
.card-title{
  padding-bottom:var(--sp-sm);
  border-bottom:1px solid rgba(212,175,55,0.1);
  margin-bottom:var(--sp-md)!important;
}
.card-title i{
  color:var(--c-gold);text-shadow:0 0 8px rgba(212,175,55,0.3);
}

/* â”€â”€ è¡¨å–®å‡ç´š â”€â”€ */
.form-input,.form-select,.form-textarea{
  background:rgba(0,0,0,0.3)!important;
  border:1px solid rgba(255,255,255,0.08)!important;
  border-radius:var(--r-md)!important;
  color:var(--c-text)!important;
  padding:0.85rem 1rem!important;
  transition:all 0.3s ease!important;
  font-size:16px!important; /* prevent iOS zoom */
}
.form-input:focus,.form-select:focus,.form-textarea:focus{
  border-color:rgba(212,175,55,0.5)!important;
  box-shadow:0 0 0 3px rgba(212,175,55,0.1),0 0 20px rgba(212,175,55,0.05)!important;
  outline:none!important;
}
.form-label{
  font-weight:600!important;
  color:var(--c-text)!important;
  margin-bottom:var(--sp-sm)!important;
  display:block!important;
}

/* â”€â”€ æ€§åˆ¥ Radio Pills â”€â”€ */
.radio-pills{display:flex;gap:var(--sp-sm)}
.radio-pill{flex:1}
.radio-pill input{display:none}
.radio-pill span{
  display:block;text-align:center;padding:0.75rem;
  border:1px solid rgba(255,255,255,0.08);border-radius:var(--r-md);
  cursor:pointer;transition:all 0.3s;color:var(--c-text-dim);font-weight:600;
}
.radio-pill input:checked+span{
  border-color:var(--c-gold);color:var(--c-gold);
  background:rgba(212,175,55,0.1);
  box-shadow:0 0 12px rgba(212,175,55,0.15);
}

/* â”€â”€ Stepper ç²¾ç·»åŒ– â”€â”€ */
.stepper{
  display:flex;align-items:center;justify-content:center;
  gap:0;margin:var(--sp-md) 0 var(--sp-lg);padding:0 var(--sp-md);
}
.stepper-dot{
  width:36px!important;height:36px!important;
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:0.85rem;
  border:2px solid rgba(255,255,255,0.12);
  color:var(--c-text-dim);background:rgba(0,0,0,0.3);
  transition:all 0.4s ease;
}
.stepper-item.active .stepper-dot{
  border-color:var(--c-gold);color:var(--c-gold);
  background:rgba(212,175,55,0.12);
  box-shadow:0 0 16px rgba(212,175,55,0.25);
}
.stepper-item.done .stepper-dot{
  border-color:rgba(212,175,55,0.4);color:var(--c-gold-light);
  background:rgba(212,175,55,0.08);
}
.stepper-line{
  flex:1;height:2px;
  background:linear-gradient(90deg,rgba(255,255,255,0.06),rgba(212,175,55,0.15),rgba(255,255,255,0.06));
  margin:0 var(--sp-xs);
}
.stepper-item{
  display:flex;flex-direction:column;align-items:center;gap:4px;
}
.stepper-item span{font-size:0.7rem;color:var(--c-text-muted)}
.stepper-item.active span{color:var(--c-gold)}

/* â”€â”€ æŒ‰éˆ•å‡ç´š â”€â”€ */
.btn-primary,.btn-gold{
  position:relative;overflow:hidden;
}
.btn-primary::before,.btn-gold::before{
  content:'';position:absolute;top:0;left:-100%;
  width:60%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);
  transition:left 0.5s;
}
.btn-primary:hover::before,.btn-gold:hover::before{
  left:100%;
}

/* â”€â”€ çµæœé  Verdict å‡ç´š â”€â”€ */
.result-verdict{
  text-align:center;
  padding:var(--sp-xl) var(--sp-lg)!important;
  border:1px solid rgba(212,175,55,0.2)!important;
  background:linear-gradient(180deg,rgba(30,12,12,0.9) 0%,rgba(45,10,10,0.95) 100%)!important;
  position:relative;
}
.result-verdict::before{
  content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:60%;height:1px;
  background:linear-gradient(90deg,transparent,var(--c-gold),transparent);
}
.verdict-prob{
  font-size:clamp(2.5rem,8vw,4rem)!important;
  font-weight:900!important;
  letter-spacing:2px;
}
.verdict-label{
  font-size:1.2rem!important;
  letter-spacing:0.1em;
}

/* â”€â”€ æ©Ÿç‡æ¢å‡ç´š â”€â”€ */
.prob-bar{
  height:10px!important;border-radius:var(--r-pill)!important;
  background:rgba(255,255,255,0.05)!important;
  overflow:hidden;position:relative;
}
.prob-fill{
  height:100%;border-radius:var(--r-pill);
  background:linear-gradient(90deg,#8b0000,#d4af37,#e8c968)!important;
  position:relative;
  transition:width 1.5s cubic-bezier(0.4,0,0.2,1)!important;
}
.prob-fill::after{
  content:'';position:absolute;right:0;top:0;bottom:0;width:20px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3));
  border-radius:0 var(--r-pill) var(--r-pill) 0;
  animation:pulse 2s infinite;
}

/* â”€â”€ Dimension Tabs å‡ç´š â”€â”€ */
.dim-tabs{
  display:flex;gap:var(--sp-xs);padding:var(--sp-sm);
  background:rgba(0,0,0,0.2);border-radius:var(--r-md);
  overflow-x:auto;-webkit-overflow-scrolling:touch;
}
.dim-tab{
  padding:0.6rem 1rem!important;border-radius:var(--r-sm)!important;
  font-size:0.82rem!important;white-space:nowrap;
  border:1px solid rgba(255,255,255,0.06)!important;
  background:transparent!important;color:var(--c-text-dim)!important;
  transition:all 0.3s!important;cursor:pointer;
}
.dim-tab.active{
  background:linear-gradient(135deg,var(--c-crimson),#6b0000)!important;
  color:var(--c-gold-pale)!important;
  border-color:rgba(212,175,55,0.4)!important;
  box-shadow:0 2px 12px rgba(139,0,0,0.3);
}

/* â”€â”€ å•†å“å¡ç‰‡å‡ç´š â”€â”€ */
.product-grid{
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr))!important;
}
.product-card{
  border-radius:var(--r-lg)!important;
  background:linear-gradient(135deg,rgba(30,12,12,0.8),rgba(20,8,8,0.9))!important;
  border:1px solid rgba(212,175,55,0.08)!important;
  transition:all 0.3s ease!important;
  position:relative;overflow:hidden;
}
.product-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,0.4),transparent);
  opacity:0;transition:opacity 0.3s;
}
.product-card:hover::before{opacity:1}
.product-card:hover{
  transform:translateY(-3px)!important;
  box-shadow:0 12px 36px rgba(0,0,0,0.4)!important;
  border-color:rgba(212,175,55,0.2)!important;
}
.product-icon{font-size:2.5rem!important}
.product-price{
  font-size:1.15rem!important;
  background:linear-gradient(135deg,var(--c-gold),var(--c-gold-light));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.product-btn{
  border-radius:var(--r-pill)!important;
  padding:0.45rem 0.85rem!important;
  font-weight:600!important;
}

/* â”€â”€ å¡”ç¾…ç‰Œå‹•ç•« â”€â”€ */
.tarot-card-draw{
  transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1),opacity 0.3s;
}
.tarot-card-draw:hover{
  transform:translateY(-8px) scale(1.05);
}

/* â”€â”€ çµè«–å€å‡ç´š â”€â”€ */
.conclusion{
  position:relative;
  border:1px solid rgba(212,175,55,0.15)!important;
  background:linear-gradient(135deg,rgba(30,12,12,0.85),rgba(20,8,8,0.95))!important;
  border-radius:var(--r-lg)!important;
  padding:var(--sp-xl) var(--sp-lg)!important;
}
.conclusion::before{
  content:'';position:absolute;top:-1px;left:10%;right:10%;height:1px;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,0.5),transparent);
}
.conclusion h3{
  text-align:center!important;
  font-size:1.3rem!important;
  margin-bottom:var(--sp-lg)!important;
}
.conclusion p{
  line-height:2!important;
  margin-bottom:var(--sp-md)!important;
  color:rgba(245,230,211,0.85)!important;
}

/* â”€â”€ ç¤¾æœƒèªåŒ + è¨ˆæ•¸å™¨å‡ç´š â”€â”€ */
.live-counter-bar{
  background:rgba(0,0,0,0.2)!important;
  border:1px solid rgba(212,175,55,0.1)!important;
  border-radius:var(--r-pill)!important;
  padding:var(--sp-xs) var(--sp-lg)!important;
  display:inline-flex!important;
}
.live-marquee{
  animation:fadeIn 0.3s;
}

/* â”€â”€ åˆ†äº«/æŠ˜æ‰£å€å‡ç´š â”€â”€ */
.share-gate-card{
  background:linear-gradient(135deg,rgba(212,175,55,0.05),rgba(139,0,0,0.05))!important;
  border:2px dashed rgba(212,175,55,0.25)!important;
}
.discount-reveal{
  animation:scaleIn 0.5s ease;
}
.discount-code{
  animation:shimmer 3s ease-in-out infinite;
  background-size:200% 100%;
  background-image:linear-gradient(90deg,var(--c-gold),#fff,var(--c-gold-light),var(--c-gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}

/* â”€â”€ å•†åŸæ¨è–¦å¡ç‰‡å‡ç´š â”€â”€ */
.shop-card{
  background:linear-gradient(135deg,rgba(139,0,0,0.12),rgba(212,175,55,0.06))!important;
  border:1px solid rgba(212,175,55,0.2)!important;
}
.shop-btn-card{
  border-radius:var(--r-lg)!important;
  padding:1rem 1.15rem!important;
}

/* â”€â”€ æµ®å‹•æŒ‰éˆ•å‡ç´š â”€â”€ */
.fab{
  box-shadow:0 4px 16px rgba(0,0,0,0.3)!important;
}
.fab-toggle{
  width:52px!important;height:52px!important;
  box-shadow:0 4px 24px rgba(139,0,0,0.5),0 0 12px rgba(212,175,55,0.15)!important;
}

/* â”€â”€ æ»¾å‹•æ¢ â”€â”€ */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:rgba(0,0,0,0.1)}
::-webkit-scrollbar-thumb{background:rgba(212,175,55,0.2);border-radius:var(--r-pill)}
::-webkit-scrollbar-thumb:hover{background:rgba(212,175,55,0.4)}

/* â”€â”€ é¸å–æ–‡å­—é¡è‰² â”€â”€ */
::selection{background:rgba(212,175,55,0.3);color:var(--c-text)}

/* â”€â”€ å¹³æ»‘æ»¾å‹• â”€â”€ */
html{scroll-behavior:smooth}

/* â”€â”€ Loading Skeleton â”€â”€ */
@keyframes skeleton{0%{background-position:-200% 0}100%{background-position:200% 0}}
.skeleton{
  background:linear-gradient(90deg,rgba(255,255,255,0.03) 25%,rgba(255,255,255,0.08) 50%,rgba(255,255,255,0.03) 75%);
  background-size:200% 100%;animation:skeleton 1.5s infinite;
  border-radius:var(--r-sm);
}

/* â”€â”€ åˆ†éš”ç·š â”€â”€ */
.divider-gold{
  height:1px;margin:var(--sp-lg) 0;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,0.3),transparent);
}

/* â”€â”€ ç´«å¾®å‘½ç›¤æ ¼å­å‡ç´š â”€â”€ */
.zw-grid{gap:3px!important}
.zw-cell{
  background:rgba(0,0,0,0.2)!important;
  border:1px solid rgba(212,175,55,0.1)!important;
  border-radius:var(--r-sm)!important;
  transition:border-color 0.3s;
}
.zw-cell:hover{border-color:rgba(212,175,55,0.3)}
.zw-cell.active-palace{
  border-color:rgba(212,175,55,0.5)!important;
  background:rgba(212,175,55,0.06)!important;
  box-shadow:inset 0 0 20px rgba(212,175,55,0.05);
}

/* â”€â”€ Tag å‡ç´š â”€â”€ */
.tag{border-radius:var(--r-pill)!important}

/* â”€â”€ äº”è¡Œ Tag å½©è‰² â”€â”€ */
.el-tag.el-é‡‘{background:rgba(192,192,192,0.15);color:#e0e0e0;border-color:rgba(192,192,192,0.3)}
.el-tag.el-æœ¨{background:rgba(34,197,94,0.15);color:#4ade80;border-color:rgba(34,197,94,0.3)}
.el-tag.el-æ°´{background:rgba(59,130,246,0.15);color:#60a5fa;border-color:rgba(59,130,246,0.3)}
.el-tag.el-ç«{background:rgba(239,68,68,0.15);color:#f87171;border-color:rgba(239,68,68,0.3)}
.el-tag.el-åœŸ{background:rgba(167,139,90,0.15);color:#d4a857;border-color:rgba(167,139,90,0.3)}

/* â”€â”€ Mobile å„ªåŒ– â”€â”€ */
@media(max-width:640px){
  .hero h1{letter-spacing:0.02em}
  .product-grid{grid-template-columns:1fr!important}
  .product-card{flex-direction:column!important;text-align:center}
  .product-card .product-actions{justify-content:center}
  .conclusion{padding:var(--sp-lg) var(--sp-md)!important}
  .live-counter-bar{flex-direction:column!important;gap:var(--sp-xs)!important;padding:var(--sp-sm)!important;border-radius:var(--r-md)!important}
  .live-counter-bar span:nth-child(2){display:none}
}

/* â”€â”€ Daily Fortune â”€â”€ */
.fortune-draw-area{text-align:center;padding:var(--sp-xl) 0}
.fortune-urn{font-size:4rem;animation:pulse 2s infinite;margin-bottom:var(--sp-md)}
.fortune-result{text-align:center}
.fortune-sign-icon{font-size:3rem;margin-bottom:var(--sp-sm)}
.fortune-sign-text{font-size:1.8rem;font-weight:900;color:var(--c-gold);letter-spacing:0.1em;margin-bottom:var(--sp-sm);font-family:var(--f-display)}
.fortune-msg{color:var(--c-text);font-size:1.05rem;line-height:1.6;margin-bottom:var(--sp-md)}
.fortune-divider{height:1px;background:linear-gradient(90deg,transparent,rgba(212,175,55,.3),transparent);margin:var(--sp-md) 0}
.fortune-crystal-rec{background:rgba(212,175,55,0.04);border:1px solid rgba(212,175,55,0.12);border-radius:var(--r-md);padding:var(--sp-md)}
.fortune-crystal-card{display:flex;align-items:center;gap:var(--sp-sm);justify-content:center;margin:var(--sp-sm) 0}
.fortune-crystal-name{font-weight:700;font-size:1.1rem;color:var(--c-gold)}
.fortune-buy-btns{display:flex;gap:var(--sp-sm);justify-content:center}
.achievements-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:var(--sp-sm)}
.achievement-badge{text-align:center;padding:var(--sp-md);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);transition:all 0.3s}
.achievement-badge.unlocked{border-color:rgba(212,175,55,0.3);background:rgba(212,175,55,0.04)}
.achievement-badge.locked{opacity:0.4;filter:grayscale(0.8)}
.badge-icon{font-size:2rem;margin-bottom:var(--sp-xs)}
.badge-name{font-size:0.85rem;font-weight:700;color:var(--c-text);margin-bottom:2px}
.achievement-toast{position:fixed;top:20px;right:20px;z-index:999;background:linear-gradient(135deg,rgba(30,12,12,0.95),rgba(45,10,10,0.98));border:2px solid var(--c-gold);border-radius:var(--r-lg);padding:var(--sp-md) var(--sp-lg);display:flex;align-items:center;gap:var(--sp-md);box-shadow:0 8px 32px rgba(0,0,0,0.5);transform:translateX(120%);transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);max-width:320px}
.achievement-toast.show{transform:translateX(0)}
.at-icon{font-size:2rem}
.ency-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:var(--sp-sm)}
.ency-card{padding:var(--sp-md);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);cursor:pointer;transition:all 0.3s;background:rgba(0,0,0,0.15)}
.ency-card:hover{border-color:rgba(212,175,55,0.3);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3)}
.ency-icon{font-size:2rem;margin-bottom:var(--sp-xs)}
.ency-name{font-weight:700;color:var(--c-text);font-size:0.95rem}
.ency-meta{display:flex;gap:var(--sp-xs);margin:var(--sp-xs) 0}
.ency-desc{font-size:0.78rem;color:var(--c-text-dim);line-height:1.4;margin:var(--sp-xs) 0}
.ency-price{font-weight:700;color:var(--c-gold);font-size:0.9rem}
.crystal-detail-modal{position:fixed;inset:0;z-index:600;display:flex;align-items:center;justify-content:center;padding:var(--sp-md)}
.crystal-detail-modal.hidden{display:none}
.cdm-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
.cdm-content{position:relative;background:linear-gradient(135deg,rgba(30,12,12,0.98),rgba(20,8,8,0.99));border:1px solid rgba(212,175,55,0.25);border-radius:var(--r-lg);padding:var(--sp-xl);max-width:420px;width:100%;max-height:90vh;overflow-y:auto;text-align:center}
.cdm-close{position:absolute;top:var(--sp-sm);right:var(--sp-sm);background:none;border:none;color:var(--c-text-dim);font-size:1.2rem;cursor:pointer}
.cdm-icon{font-size:3.5rem;margin-bottom:var(--sp-sm)}
.cdm-name{font-size:1.5rem;font-weight:700;color:var(--c-gold);font-family:var(--f-display);margin-bottom:var(--sp-sm)}
.cdm-tags{display:flex;gap:var(--sp-sm);justify-content:center;margin-bottom:var(--sp-md)}
.cdm-desc{color:var(--c-text);line-height:1.6;margin-bottom:var(--sp-md)}
.cdm-info{text-align:left;background:rgba(0,0,0,0.2);border-radius:var(--r-md);padding:var(--sp-md);margin-bottom:var(--sp-lg)}
.cdm-row{padding:var(--sp-xs) 0;color:var(--c-text-dim);font-size:0.9rem}
.cdm-row strong{color:var(--c-gold)}
.cdm-actions{display:flex;gap:var(--sp-sm);justify-content:center;flex-wrap:wrap}
.quiz-progress{text-align:center;color:var(--c-text-dim);font-size:0.85rem;margin-bottom:var(--sp-xs)}
.quiz-progress-bar{height:4px;background:rgba(255,255,255,0.06);border-radius:var(--r-pill);overflow:hidden;margin-bottom:var(--sp-lg)}
.quiz-fill{height:100%;background:linear-gradient(90deg,var(--c-crimson),var(--c-gold));border-radius:var(--r-pill);transition:width 0.4s}
.quiz-question{text-align:center;font-size:1.15rem;color:var(--c-text);margin-bottom:var(--sp-lg);line-height:1.5}
.quiz-options{display:flex;flex-direction:column;gap:var(--sp-sm)}
.quiz-option{padding:1rem var(--sp-lg);border:1px solid rgba(255,255,255,0.08);border-radius:var(--r-md);background:rgba(0,0,0,0.15);color:var(--c-text);cursor:pointer;text-align:left;transition:all 0.3s;font-size:0.95rem}
.quiz-option:hover{border-color:rgba(212,175,55,0.4);background:rgba(212,175,55,0.06);transform:translateX(4px)}
.quiz-result{text-align:center}
.quiz-result-icon{font-size:3.5rem;margin-bottom:var(--sp-sm)}
.quiz-result-title{color:var(--c-text-dim);font-size:0.95rem;margin-bottom:var(--sp-xs)}
.quiz-result-crystal{font-size:2rem;font-weight:900;color:var(--c-gold);font-family:var(--f-display);margin-bottom:var(--sp-sm)}
.quiz-result-el{display:flex;gap:var(--sp-sm);justify-content:center;margin-bottom:var(--sp-md)}
.quiz-result-desc{color:var(--c-text);line-height:1.6;margin-bottom:var(--sp-sm)}
.quiz-result-actions{display:flex;gap:var(--sp-sm);justify-content:center;flex-wrap:wrap}
.review-carousel{min-height:120px;transition:opacity 0.3s}
.review-card{border:1px solid rgba(212,175,55,0.12);border-radius:var(--r-md);padding:var(--sp-md);background:rgba(0,0,0,0.15)}
.review-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-sm);flex-wrap:wrap;gap:var(--sp-xs)}
.review-stars{font-size:0.85rem}
.review-meta{font-size:0.75rem;color:var(--c-text-muted)}
.review-text{color:var(--c-text);line-height:1.6;font-size:0.9rem;margin-bottom:var(--sp-sm)}
.review-product{display:flex;justify-content:flex-end}
.extra-nav{display:flex;gap:var(--sp-xs);overflow-x:auto;padding:var(--sp-sm) 0;margin:var(--sp-lg) 0 var(--sp-sm);border-bottom:1px solid rgba(255,255,255,0.06);-webkit-overflow-scrolling:touch}
.nav-extra-tab{padding:0.5rem 1rem;border-radius:var(--r-pill);font-size:0.82rem;white-space:nowrap;border:1px solid rgba(255,255,255,0.06);background:none;color:var(--c-text-dim);cursor:pointer;transition:all 0.3s}
.nav-extra-tab.active{background:rgba(212,175,55,0.1);color:var(--c-gold);border-color:rgba(212,175,55,0.3)}
.extra-section{padding:var(--sp-md) 0}
.extra-section.hidden{display:none}
</style>
</head>
<body>
<nav class="nav"><div class="nav-inner">
  <div class="nav-brand"><i class="fas fa-moon"></i><span>éœæœˆä¹‹å…‰ v3.0</span></div>
  <div class="nav-links">
    <button class="nav-link active" onclick="goStep(0)">è¼¸å…¥</button>
    <button class="nav-link" onclick="goStep(1)">æ¢…èŠ±</button>
    <button class="nav-link" onclick="goStep(2)">å¡”ç¾…</button>
    <button class="nav-link" onclick="goStep(3)">çµæœ</button>
  </div>
  <div class="nav-shop">
    <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer">ğŸ›’ è¦çš®</a>
    <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer">ğŸ“¦ 7-11</a>
  </div>
</div></nav>

<div class="app">

<!-- ========== STEP 0: INPUT ========== -->
<section class="step active" id="step-0">
  <div class="hero">
    <div class="hero-icon">â˜½</div>
    <h1>éœæœˆä¹‹å…‰èƒ½é‡å åœå„€</h1>
    <p>æ•´åˆå…«å­— Â· ç´«å¾®æ–—æ•¸ Â· æ¢…èŠ±æ˜“æ•¸ Â· å¡”ç¾…ç‰Œçš„å¤šç¶­åº¦å‘½ç†åˆ†æ</p>
    <div class="live-counter-bar">
      <span>ğŸ”¥ ç´¯è¨ˆ <strong id="live-counter-num">184,729</strong> äººå·²æ¸¬</span>
      <span>ï½œ</span>
      <span>ä»Šæ—¥ <strong id="live-today-num">47</strong> äºº</span>
    </div>

  </div>
  <div class="stepper" id="main-stepper">
    <div class="stepper-item active"><div class="stepper-dot">1</div><span>è¼¸å…¥</span></div><div class="stepper-line"></div>
    <div class="stepper-item"><div class="stepper-dot">2</div><span>æ¢…èŠ±</span></div><div class="stepper-line"></div>
    <div class="stepper-item"><div class="stepper-dot">3</div><span>å¡”ç¾…</span></div><div class="stepper-line"></div>
    <div class="stepper-item"><div class="stepper-dot">4</div><span>çµæœ</span></div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-question-circle"></i> ä½ çš„å•é¡Œ</div>
    <div class="form-group">
      <label class="form-label">å•é¡Œé¡å‹ <span class="req">*</span></label>
      <select class="form-select" id="f-type"><option value="">è«‹é¸æ“‡</option>
        <option value="love">æ„›æƒ…</option><option value="career">äº‹æ¥­</option><option value="wealth">è²¡é‹</option>
        <option value="health">å¥åº·</option><option value="general">ç¶œåˆé‹å‹¢</option><option value="relationship">äººéš›</option>
        <option value="family">å®¶åº­</option><option value="other">å…¶ä»–</option></select>
    </div>
    <div class="form-group">
      <label class="form-label">ä½ ç¾åœ¨æœ€æƒ³å•çš„ä¸€ä»¶äº‹ <span class="req">*</span></label>
      <textarea class="form-textarea" id="f-question" placeholder="ä¾‹ï¼šæˆ‘ä»Šå¹´é©åˆè½‰è·å—ï¼Ÿ" maxlength="500"></textarea>
      <div class="form-hint"><span id="f-char">0</span>/500</div>
    </div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-user"></i> å‡ºç”Ÿè³‡æ–™</div>
    <div class="form-group">
      <label class="form-label">æ€§åˆ¥ <span class="req">*</span></label>
      <div class="radio-pills">
        <label class="radio-pill"><input type="radio" name="gender" value="male"><span>ç”·</span></label>
        <label class="radio-pill"><input type="radio" name="gender" value="female"><span>å¥³</span></label>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">å‡ºç”Ÿæ—¥æœŸï¼ˆåœ‹æ›†ï¼‰<span class="req">*</span></label>
      <input type="date" class="form-input" id="f-bdate">
    </div>
    <div class="form-group">
      <label class="form-label">å‡ºç”Ÿæ™‚é–“</label>
      <input type="time" class="form-input" id="f-btime">
      <div class="form-hint">ä¸ç¢ºå®šå¯ç•™ç©ºï¼Œç³»çµ±ä»¥ 12:00 ä¼°ç®—</div>
    </div>
    <div class="form-group">
      <label class="form-label">å§“åï¼ˆé¸å¡«ï¼‰</label>
      <input type="text" class="form-input" id="f-name" placeholder="ç”¨æ–¼å§“åå­¸åˆ†æ">
    </div>
  </div>
  <div class="actions actions-center">
    <button class="btn btn-primary btn-lg" onclick="submitStep0()"><i class="fas fa-arrow-right"></i> ä¸‹ä¸€æ­¥ï¼šæ¢…èŠ±æ˜“æ•¸</button>
  </div>
</section>

<!-- ========== STEP 1: MEIHUA ========== -->
<section class="step" id="step-1">
  <div class="card">
    <div class="card-title"><i class="fas fa-yin-yang"></i> æ¢…èŠ±æ˜“æ•¸èµ·å¦</div>
    <div style="display:flex;gap:var(--sp-sm);flex-wrap:wrap;margin-bottom:var(--sp-md)">
      <button class="btn btn-sm btn-tab-active" id="mh-m-time" onclick="setMhMethod('time')"><i class="fas fa-clock"></i> æ™‚é–“</button>
      <button class="btn btn-sm btn-outline" id="mh-m-number" onclick="setMhMethod('number')"><i class="fas fa-sort-numeric-up"></i> æ•¸å­—</button>
      <button class="btn btn-sm btn-outline" id="mh-m-char" onclick="setMhMethod('char')"><i class="fas fa-font"></i> æ¼¢å­—</button>
      <button class="btn btn-sm btn-outline" id="mh-m-random" onclick="setMhMethod('random')"><i class="fas fa-dice"></i> éš¨æ©Ÿ</button>
    </div>
    <div id="mhf-time"><p class="text-dim text-sm mb-md">æŒ‰ä¸‹æŒ‰éˆ•è‡ªå‹•ä»¥ç•¶å‰æ™‚é–“èµ·å¦</p><button class="btn btn-primary" onclick="calcMhTime()"><i class="fas fa-calculator"></i> æ™‚é–“èµ·å¦</button></div>
    <div id="mhf-number" class="hidden">
      <div class="form-group"><label class="form-label">ä¸Šå¦æ•¸å­— (1-999)</label><input type="number" class="form-input" id="mh-n1" min="1" max="999"></div>
      <div class="form-group"><label class="form-label">ä¸‹å¦æ•¸å­— (1-999)</label><input type="number" class="form-input" id="mh-n2" min="1" max="999"></div>
      <div class="form-group"><label class="form-label">å‹•çˆ» (1-6)</label><input type="number" class="form-input" id="mh-n3" min="1" max="6"></div>
      <button class="btn btn-primary" onclick="calcMhNumber()"><i class="fas fa-calculator"></i> æ•¸å­—èµ·å¦</button>
    </div>
    <div id="mhf-char" class="hidden">
      <div class="form-group"><label class="form-label">è¼¸å…¥æ¼¢å­— (1-3å€‹)</label><input type="text" class="form-input" id="mh-char" placeholder="å¦‚ï¼šæ„Ÿæƒ…" maxlength="3"></div>
      <button class="btn btn-primary" onclick="calcMhChar()"><i class="fas fa-calculator"></i> æ¼¢å­—èµ·å¦</button>
    </div>
    <div id="mhf-random" class="hidden"><p class="text-dim text-sm mb-md">å¿ƒèª å‰‡éˆï¼Œéš¨æ©Ÿç”¢ç”Ÿå¦è±¡</p><button class="btn btn-primary" onclick="calcMhRandom()"><i class="fas fa-dice"></i> éš¨æ©Ÿèµ·å¦</button></div>
  </div>
  <div id="mh-result" class="hidden">
    <div class="card">
      <div class="hex-grid">
        <div class="hex-card"><h4>æœ¬å¦</h4><div class="hex-sym" id="mh-ben-s"></div><div class="hex-name" id="mh-ben-n"></div></div>
        <div class="hex-card"><h4>äº’å¦</h4><div class="hex-sym" id="mh-hu-s"></div><div class="hex-name" id="mh-hu-n"></div></div>
        <div class="hex-card"><h4>è®Šå¦</h4><div class="hex-sym" id="mh-bian-s"></div><div class="hex-name" id="mh-bian-n"></div></div>
      </div>
      <div class="divider"></div>
      <div id="mh-detail" class="text-sm"></div>
    </div>
  </div>
  <div class="actions">
    <button class="btn btn-outline" onclick="goStep(0)"><i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥</button>
    <button class="btn btn-outline" onclick="goStep(2)"><i class="fas fa-forward"></i> è·³é</button>
    <button class="btn btn-primary" onclick="goStep(2)"><i class="fas fa-arrow-right"></i> ä¸‹ä¸€æ­¥ï¼šå¡”ç¾…ç‰Œ</button>
  </div>
</section>

<!-- ========== STEP 2: TAROT ========== -->
<section class="step" id="step-2">
  <div class="card">
    <div class="card-title"><i class="fas fa-star"></i> é‡‘è‰²é»æ˜å¡”ç¾…ç‰Œ</div>
    <p class="text-dim text-sm mb-md">é»æ“ŠæŠ½ç‰Œï¼Œå…±éœ€ 10 å¼µã€‚å‰©é¤˜ï¼š<strong id="t-remain">10</strong> å¼µ</p>
    <div class="text-center">
      <button class="btn btn-gold btn-lg" id="btn-draw" onclick="drawCard()"><i class="fas fa-hand-pointer"></i> æŠ½ä¸€å¼µç‰Œ</button>
      <button class="btn btn-outline btn-sm" onclick="autoDraw()" style="margin-left:var(--sp-sm)"><i class="fas fa-bolt"></i> å¿«é€Ÿå…¨æŠ½</button>
    </div>
    <div class="tarot-hand" id="t-hand"></div>
  </div>
  <div id="t-spread-sec" class="hidden"><div class="card"><div class="card-title"><i class="fas fa-cross"></i> å‡±çˆ¾ç‰¹åå­—ç‰Œé™£</div><div id="t-spread"></div></div></div>
  <div class="actions">
    <button class="btn btn-outline" onclick="goStep(1)"><i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥</button>
    <button class="btn btn-outline" onclick="skipToResult()"><i class="fas fa-forward"></i> è·³éå¡”ç¾…</button>
    <button class="btn btn-primary" id="btn-analyze" onclick="goStep(3)" disabled><i class="fas fa-chart-bar"></i> é€²è¡Œåˆ†æ</button>
  </div>
</section>

<!-- ========== STEP 3: RESULT ========== -->
<section class="step" id="step-3">
  <div class="result-verdict" id="r-verdict">
    <div class="verdict-label" id="r-vlabel">åˆ†æä¸­â€¦</div>
    <div class="verdict-prob" id="r-vprob">0%</div>
    <div class="verdict-note" id="r-vnote"></div>
  </div>
  <div class="card"><div class="card-title"><i class="fas fa-bullseye"></i> ç›´æ¥å›ç­”</div>
    <div id="r-question" class="text-dim mb-md"></div>
    <div id="r-answer" class="serif" style="font-size:1.05rem;line-height:1.8"></div>
    <div class="divider"></div><div id="r-factors"></div><div id="r-suggest" class="mt-md"></div>
  </div>
  <div class="card"><div class="card-title"><i class="fas fa-chart-line"></i> å¯èƒ½æ€§è©•ä¼°</div>
    <div class="prob-meter"><div class="prob-bar"><div class="prob-fill" id="r-pfill" style="width:0%"></div></div>
    <div class="prob-labels"><span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span></div></div>
    <div id="r-pbreak" class="mt-md text-sm"></div>
  </div>
  <div class="card" style="padding:0;overflow:visible">
    <div class="dim-tabs">
      <button class="dim-tab active" onclick="showDim('bazi')">å…«å­—å‘½ç†</button>
      <button class="dim-tab" onclick="showDim('ziwei')">ç´«å¾®æ–—æ•¸</button>
      <button class="dim-tab" onclick="showDim('meihua')">æ¢…èŠ±æ˜“æ•¸</button>
      <button class="dim-tab" onclick="showDim('tarot')">å¡”ç¾…ç‰Œé™£</button>
      <button class="dim-tab" onclick="showDim('name')">å§“åå­¸</button>
    </div>
    <div class="dim-pane active" id="pane-bazi">
      <h4 class="text-gold mb-md serif">å››æŸ±å…«å­—å‘½ç›¤</h4><div id="d-bazi"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">äº”è¡Œåˆ†ä½ˆ</h4><div id="d-elbar"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">åç¥åˆ†æ</h4><div id="d-gods" class="text-sm"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">è—å¹²è©³è§£</h4><div id="d-canggan" class="text-sm"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">å–œç”¨ç¥èˆ‡å¿Œç¥</h4><div id="d-xiyong" class="text-sm"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">å¤§é‹æµå¹´</h4><div id="d-dayun"></div>
    </div>
    <div class="dim-pane" id="pane-ziwei">
      <h4 class="text-gold mb-md serif">ç´«å¾®æ–—æ•¸å‘½ç›¤</h4>
      <div id="d-ziwei-info" class="text-sm mb-md"></div>
      <div id="d-ziwei-grid"></div>
      <div class="divider"></div>
      <h4 class="text-gold mb-md serif">å››åŒ–é£›æ˜Ÿ</h4>
      <div id="d-ziwei-sihua" class="text-sm"></div>
      <div class="divider"></div>
      <h4 class="text-gold mb-md serif">å‘½ç›¤è§£è®€</h4>
      <div id="d-ziwei-reading" class="text-sm"></div>
    </div>
    <div class="dim-pane" id="pane-meihua"><div id="r-meihua"></div></div>
    <div class="dim-pane" id="pane-tarot"><div id="r-tarot"></div></div>
    <div class="dim-pane" id="pane-name">
      <h4 class="text-gold mb-md serif">å§“åå­¸åˆ†æï¼ˆä¸‰æ‰äº”æ ¼ï¼‰</h4>
      <div id="d-name"></div>
    </div>
  </div>
  <div class="card"><div class="card-title"><i class="fas fa-gem"></i> ã€è™•æ–¹ã€‘æ°´æ™¶æ ¡æº–å»ºè­°</div><div id="r-crystal"></div></div>

  <!-- å•†åŸæ¨è–¦å¡ -->
  <div class="card shop-card">
    <div class="card-title"><i class="fas fa-shopping-bag"></i> æƒ³æŠŠçµæœåšæˆã€Œå°ˆå±¬äº”è¡Œæ‰‹éˆã€ï¼Ÿæˆ‘å¹«ä½ é…åˆ°ä½</div>
    <p class="text-sm text-dim mb-md">ä¾ä½ çµæœçš„å–œç”¨ç¥ï¼Œçµ¦ä½  3 å€‹å¯¦ç”¨æ­é…ï¼ˆå¯ç›´æ¥ä¸‹å–®ï¼‰</p>
    <div class="shop-btns">
      <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer" class="shop-btn-card shopee">
        <i class="fas fa-shopping-cart"></i>
        <div><strong>ğŸ›’ è¦çš®é€›é€›</strong><span class="text-xs">å…¨é¤¨å…é‹ + é—œæ³¨9æŠ˜</span></div>
      </a>
      <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer" class="shop-btn-card seven">
        <i class="fas fa-box"></i>
        <div><strong>ğŸ“¦ è³£è²¨ä¾¿</strong><span class="text-xs">æ»¿åƒå…é‹ / å¤šä»¶åˆä½µ</span></div>
      </a>
      <button class="shop-btn-card custom" onclick="openCustomModal()">
        <i class="fas fa-magic"></i>
        <div><strong>âœ¨ æˆ‘è¦å®¢è£½</strong><span class="text-xs">å¡«è³‡æ–™ / é ç®—ç‰ˆ</span></div>
      </button>
    </div>
    <p class="text-xs text-muted mt-md"><i class="fas fa-info-circle"></i> é ç®—ç‰ˆ / åŠ å¼·ç‰ˆ / æ”¶è—ç‰ˆï¼šé¸ä¸€å€‹å°±å¥½</p>
  </div>

  <div class="conclusion"><h3><i class="fas fa-moon"></i> éœæœˆåˆ†æå¸«ç¸½çµ</h3><div id="r-conclusion" class="text-sm" style="line-height:1.8"></div></div>
  <!-- å­˜åœ–åˆ†äº«å€ -->
  <div class="card" style="text-align:center">
    <div class="card-title"><i class="fas fa-share-alt"></i> åˆ†äº«ä½ çš„å åœçµæœ</div>
    <p class="text-sm text-dim mb-md">å­˜æˆåœ–ç‰‡åˆ†äº«åˆ° IG / LINEï¼Œæœ‹å‹ä¹Ÿèƒ½å…è²»æ¸¬ï¼</p>
    <div class="actions actions-center" style="gap:var(--sp-md);flex-wrap:wrap">
      <button class="btn-save-card" onclick="saveResultCard()"><i class="fas fa-download"></i> å­˜åœ–åˆ†äº«</button>
      <button class="btn btn-outline" onclick="printResult()"><i class="fas fa-print"></i> åˆ—å°</button>
    </div>
  </div>

  <!-- å†æ¸¬ä¸€æ¬¡ï¼ˆåˆ†äº«è§£é–ï¼‰ -->
  <div class="share-gate-card mt-lg" id="share-gate">
    <h4>ğŸ”„ æƒ³å†æ¸¬ä¸€æ¬¡ï¼Ÿ</h4>
    <p>åˆ†äº«çµ¦æœ‹å‹å¾Œå³å¯é‡æ–°é–‹å§‹ â€” è®“æ›´å¤šäººä¹Ÿèƒ½å…è²»æ¸¬ï¼</p>
    <button class="btn-share-big" onclick="shareToUnlock()"><i class="fas fa-paper-plane"></i> åˆ†äº«çµ¦æœ‹å‹ï¼Œè§£é–å†æ¸¬</button>
  </div>
  <!-- æŠ˜æ‰£ç¢¼ï¼ˆåˆ†äº«å¾Œé¡¯ç¤ºï¼‰ -->
  <div class="discount-reveal hidden mt-lg" id="discount-reveal">
    <h4 style="color:var(--c-gold);margin-bottom:var(--sp-sm)">ğŸ æ„Ÿè¬åˆ†äº«ï¼ä½ çš„å°ˆå±¬æŠ˜æ‰£ç¢¼ï¼š</h4>
    <div class="discount-code" id="discount-code">JY0209XXX</div>
    <p class="text-sm text-dim mt-sm">è¦çš®ä¸‹å–®æ™‚è¼¸å…¥æ­¤ç¢¼äº« <strong style="color:var(--c-gold)">9æŠ˜å„ªæƒ </strong></p>
    <button class="btn btn-outline btn-sm mt-sm" onclick="copyDiscountCode()"><i class="fas fa-copy"></i> è¤‡è£½æŠ˜æ‰£ç¢¼</button>
    <div class="mt-md">
      <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener" class="btn btn-gold"><i class="fas fa-shopping-cart"></i> ç«‹å³å‰å¾€è¦çš®é¸è³¼</a>
    </div>
  </div>
  <div class="actions actions-center mt-lg hidden" id="btn-retest">
    <button class="btn btn-gold btn-full" onclick="retestAfterShare()" style="max-width:320px"><i class="fas fa-redo"></i> é‡æ–°é–‹å§‹æ–°çš„å åœ</button>
  </div>
  <!-- 7å¤©æé†’ -->
  <div class="text-center mt-lg">
    <button class="btn-remind" id="btn-remind" onclick="addReminder7Days()"><i class="fas fa-bell"></i> 7å¤©å¾Œæé†’æˆ‘å†æ¸¬ä¸€æ¬¡</button>
    <p class="text-xs text-muted mt-xs">æœƒä¸‹è¼‰ .ics æ—¥æ›†æª”ï¼Œè‡ªå‹•åŠ å…¥æ‰‹æ©Ÿè¡Œäº‹æ›†</p>
  </div>
</section>

</div><!-- /app -->

<!-- å®¢è£½è¡¨å–® Modal -->
<div class="modal-overlay" id="custom-modal" style="display:none">
  <div class="modal-box">
    <button class="modal-close" onclick="closeCustomModal()">&times;</button>
    <h3 class="serif text-gold mb-md"><i class="fas fa-magic"></i> èƒ½é‡æ‰‹éˆå®¢è£½æœå‹™</h3>
    <form id="custom-form" action="https://formsubmit.co/onerkk@gmail.com" method="POST" onsubmit="return prepareCustomSubmit()">
      <!-- formsubmit.co config -->
      <input type="hidden" name="_subject" id="cf-subject-hidden" value="ã€å®¢è£½è©¢å•ã€‘èƒ½é‡æ‰‹éˆ">
      <input type="hidden" name="_captcha" value="false">
      <input type="hidden" name="_template" value="table">
      <input type="hidden" name="_next" id="cf-next-url" value="">
      <input type="text" name="_honey" style="display:none">
      <input type="hidden" name="å åœåˆ†ææ‘˜è¦" id="cf-analysis-hidden" value="">
      <div class="form-group">
        <label class="form-label">å§“å <span class="req">*</span></label>
        <input type="text" class="form-input" id="cf-name" name="å§“å" required placeholder="æ‚¨çš„å§“å">
      </div>
      <div class="form-group">
        <label class="form-label">å‡ºç”Ÿæ—¥æœŸ <span class="req">*</span></label>
        <input type="date" class="form-input" id="cf-bday" name="å‡ºç”Ÿæ—¥æœŸ" required>
      </div>
      <div class="form-group">
        <label class="form-label">æƒ³è§£æ±ºçš„å•é¡Œ <span class="req">*</span></label>
        <textarea class="form-textarea" id="cf-question" name="æƒ³è§£æ±ºçš„å•é¡Œ" required placeholder="ä¾‹ï¼šæƒ³æå‡äº‹æ¥­é‹ã€æ”¹å–„æ„Ÿæƒ…ã€æ‹›è²¡ç­‰..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">é ç®—ç¯„åœ <span class="req">*</span></label>
        <select class="form-select" id="cf-budget" name="é ç®—ç¯„åœ" required>
          <option value="">è«‹é¸æ“‡</option>
          <option value="é ç®—ç‰ˆï¼ˆ$1,000-$3,000ï¼‰">é ç®—ç‰ˆï¼ˆ$1,000 - $3,000ï¼‰</option>
          <option value="åŠ å¼·ç‰ˆï¼ˆ$3,000-$6,000ï¼‰">åŠ å¼·ç‰ˆï¼ˆ$3,000 - $6,000ï¼‰</option>
          <option value="æ”¶è—ç‰ˆï¼ˆ$6,000ä»¥ä¸Šï¼‰">æ”¶è—ç‰ˆï¼ˆ$6,000 ä»¥ä¸Šï¼‰</option>
        </select>
      </div>
      <div class="actions" style="margin-top:var(--sp-lg)">
        <button type="button" class="btn btn-outline" onclick="closeCustomModal()">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-gold" id="cf-submit-btn"><i class="fas fa-paper-plane"></i> é€å‡ºè©¢å•</button>
      </div>
      <p class="text-xs text-muted mt-md"><i class="fas fa-lock"></i> è¡¨å–®ç›´æ¥å¯„åˆ°åº—å®¶ä¿¡ç®±ï¼Œä¸ç¶“ç¬¬ä¸‰æ–¹å„²å­˜ã€‚é¦–æ¬¡é€å‡ºå¾Œæœƒæ”¶åˆ°ç¢ºèªä¿¡ã€‚</p>
    </form>
    <div id="cf-sent" class="hidden mt-lg text-center">
      <div style="font-size:2rem;margin-bottom:var(--sp-sm)">âœ…</div>
      <h4 class="text-gold mb-sm">è©¢å•å·²é€å‡ºï¼</h4>
      <p class="text-sm text-dim mb-md">æˆ‘å€‘æœƒç›¡å¿«é€é Email å›è¦†æ‚¨ã€‚</p>
      <button class="btn btn-outline" onclick="closeCustomModal()"><i class="fas fa-check"></i> é—œé–‰</button>
    </div>
  </div>
</div>

<!-- ========== äº’å‹•åŠŸèƒ½å€ ========== -->
<div class="app" style="padding-top:0">
  <div class="extra-nav">
    <button class="nav-extra-tab active" data-target="sec-daily-fortune">ğŸ° æ¯æ—¥é‹å‹¢</button>
    <button class="nav-extra-tab" data-target="sec-crystal-quiz">ğŸ§ª æ°´æ™¶é…å°</button>
    <button class="nav-extra-tab" data-target="sec-encyclopedia">ğŸ“– æ°´æ™¶ç™¾ç§‘</button>
    <button class="nav-extra-tab" data-target="sec-achievements">ğŸ† æˆå°±å¾½ç« </button>
    <button class="nav-extra-tab" data-target="sec-reviews">ğŸ’¬ ä½¿ç”¨è€…å¥½è©•</button>
  </div>

  <!-- æ¯æ—¥é‹å‹¢ç±¤ -->
  <div class="extra-section" id="sec-daily-fortune">
    <div class="card">
      <div class="card-title"><i class="fas fa-sun"></i> æ¯æ—¥é‹å‹¢ç±¤ â€” å…è²»æŠ½ä¸€æ¬¡</div>
      <div id="daily-fortune-content"></div>
    </div>
  </div>

  <!-- æ°´æ™¶é…å°æ¸¬é©— -->
  <div class="extra-section hidden" id="sec-crystal-quiz">
    <div class="card">
      <div class="card-title"><i class="fas fa-flask"></i> æ‰¾å‡ºä½ çš„å‘½å®šæ°´æ™¶</div>
      <p class="text-sm text-dim mb-md">3 é“ç›´è¦ºé¡Œï¼Œ30 ç§’æ‰¾åˆ°æœ€é©åˆä½ çš„æ°´æ™¶</p>
      <div id="crystal-quiz-content">
        <div class="text-center">
          <button class="btn btn-gold" onclick="startCrystalQuiz()"><i class="fas fa-play"></i> é–‹å§‹æ¸¬é©—</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ°´æ™¶ç™¾ç§‘ -->
  <div class="extra-section hidden" id="sec-encyclopedia">
    <div class="card">
      <div class="card-title"><i class="fas fa-book"></i> æ°´æ™¶ç™¾ç§‘åœ–é‘‘</div>
      <p class="text-sm text-dim mb-md">é»æ“Šä»»ä¸€æ°´æ™¶æŸ¥çœ‹è©³ç´°åŠŸæ•ˆèˆ‡è³¼è²·é€£çµ</p>
      <div class="ency-grid" id="crystal-encyclopedia-grid"></div>
    </div>
  </div>

  <!-- æˆå°±å¾½ç«  -->
  <div class="extra-section hidden" id="sec-achievements">
    <div class="card">
      <div class="card-title"><i class="fas fa-trophy"></i> æˆ‘çš„æˆå°± <span class="text-sm text-muted" id="achievement-progress">0/9 å·²è§£é–</span></div>
      <div class="achievements-grid" id="achievements-grid"></div>
    </div>
  </div>

  <!-- å¥½è©•è¼ªæ’­ -->
  <div class="extra-section hidden" id="sec-reviews">
    <div class="card">
      <div class="card-title"><i class="fas fa-comments"></i> è²·å®¶çœŸå¯¦å›é¥‹</div>
      <div id="review-carousel"></div>
      <div class="text-center mt-md">
        <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener" class="btn btn-outline btn-sm"><i class="fas fa-shopping-cart"></i> å»è³£å ´çœ‹æ›´å¤šè©•åƒ¹</a>
      </div>
    </div>
  </div>
</div>

<!-- æ°´æ™¶è©³æƒ… Modal -->
<div class="crystal-detail-modal hidden" id="crystal-detail-modal"></div>

<!-- PWA å®‰è£æç¤º -->
<div class="pwa-banner hidden" id="pwa-banner">
  <div class="pwa-banner-text">
    <strong>â˜½ åŠ åˆ°ä¸»ç•«é¢</strong>ï¼Œéš¨æ™‚æ¸¬é‹å‹¢æ›´æ–¹ä¾¿ï¼
  </div>
  <button class="pwa-install-btn" onclick="installPWA()">å®‰è£</button>
  <button class="pwa-close-btn" onclick="hidePWABanner()">&times;</button>
</div>

<!-- æµ®å‹•æŒ‰éˆ• -->
<div class="floating-root" id="floating-root">
  <button class="fab fab-toggle" onclick="toggleFab()" aria-label="é¸å–®"><i class="fas fa-ellipsis-v"></i></button>
  <div class="fab-menu hidden" id="fab-menu">
    <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer" class="fab fab-shopee" title="è¦çš®é€›é€›"><i class="fas fa-shopping-cart"></i><span>è¦çš®</span></a>
    <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer" class="fab fab-711" title="è³£è²¨ä¾¿"><i class="fas fa-box"></i><span>7-11</span></a>
    <button class="fab fab-custom" onclick="openCustomModal()" title="å®¢è£½"><i class="fas fa-magic"></i><span>å®¢è£½</span></button>
  </div>
</div>
<script>
/* =============================================================
   GLOBAL STATE
   ============================================================= */
const S = { step:0, form:{}, bazi:null, meihua:null, tarot:{drawn:[],spread:[]}, ziwei:null };

/* =============================================================
   NAVIGATION
   ============================================================= */
function goStep(n){
  if(n===3 && !S.bazi){alert('è«‹å…ˆå¡«å¯«åŸºæœ¬è³‡æ–™');return}
  document.querySelectorAll('.step').forEach((s,i)=>s.classList.toggle('active',i===n));
  document.querySelectorAll('.nav-link').forEach((l,i)=>l.classList.toggle('active',i===n));
  document.querySelectorAll('.stepper-item').forEach((s,i)=>{s.classList.remove('active','done');if(i<n)s.classList.add('done');if(i===n)s.classList.add('active')});
  S.step=n; window.scrollTo({top:0,behavior:'smooth'});
  if(n===3) runAnalysis();
}
function resetAll(){S.bazi=null;S.meihua=null;S.tarot={drawn:[],spread:[]};S.ziwei=null;goStep(0);document.getElementById('mh-result').classList.add('hidden');document.getElementById('t-hand').innerHTML='';document.getElementById('t-remain').textContent='10';document.getElementById('btn-draw').disabled=false;document.getElementById('btn-analyze').disabled=true;document.getElementById('t-spread-sec').classList.add('hidden')}
function skipToResult(){goStep(3)}

/* â€” Char counter â€” */
document.getElementById('f-question').addEventListener('input',function(){document.getElementById('f-char').textContent=this.value.length});

/* =============================================================
   å¤©å¹²åœ°æ”¯ CORE DATA
   ============================================================= */
const TG=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
const DZ=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
const WX_G={ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
const WX_Z={å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'};
const YY_G={ç”²:'é™½',ä¹™:'é™°',ä¸™:'é™½',ä¸:'é™°',æˆŠ:'é™½',å·±:'é™°',åºš:'é™½',è¾›:'é™°',å£¬:'é™½',ç™¸:'é™°'};
const SHENG={æœ¨:'ç«',ç«:'åœŸ',åœŸ:'é‡‘',é‡‘:'æ°´',æ°´:'æœ¨'};
const KE={æœ¨:'åœŸ',ç«:'é‡‘',åœŸ:'æ°´',é‡‘:'æœ¨',æ°´:'ç«'};
const BE_SHENG={æœ¨:'æ°´',ç«:'æœ¨',åœŸ:'ç«',é‡‘:'åœŸ',æ°´:'é‡‘'}; // ç”Ÿæˆ‘
const BE_KE={æœ¨:'é‡‘',ç«:'æ°´',åœŸ:'æœ¨',é‡‘:'ç«',æ°´:'åœŸ'};   // å…‹æˆ‘

/* è—å¹² */
const CG={
  å­:['ç™¸'],ä¸‘:['å·±','ç™¸','è¾›'],å¯…:['ç”²','ä¸™','æˆŠ'],å¯:['ä¹™'],
  è¾°:['æˆŠ','ä¹™','ç™¸'],å·³:['ä¸™','åºš','æˆŠ'],åˆ:['ä¸','å·±'],æœª:['å·±','ä¸','ä¹™'],
  ç”³:['åºš','å£¬','æˆŠ'],é…‰:['è¾›'],æˆŒ:['æˆŠ','è¾›','ä¸'],äº¥:['å£¬','ç”²']
};

/* åç¥ */
function tenGod(dm,tgt){
  if(!WX_G[dm]||!WX_G[tgt])return'â€”';
  const d=WX_G[dm],t=WX_G[tgt],s=YY_G[dm]===YY_G[tgt];
  if(d===t)return s?'æ¯”è‚©':'åŠ«è²¡';
  if(SHENG[d]===t)return s?'é£Ÿç¥':'å‚·å®˜';
  if(KE[d]===t)return s?'åè²¡':'æ­£è²¡';
  if(KE[t]===d)return s?'ä¸ƒæ®º':'æ­£å®˜';
  if(SHENG[t]===d)return s?'åå°':'æ­£å°';
  return'â€”';
}

/* åäºŒé•·ç”Ÿ */
const CHANG_SHENG_ORDER=['é•·ç”Ÿ','æ²æµ´','å† å¸¶','è‡¨å®˜','å¸æ—º','è¡°','ç—…','æ­»','å¢“','çµ•','èƒ','é¤Š'];
const CS_START={ç”²:DZ.indexOf('äº¥'),ä¸™:DZ.indexOf('å¯…'),æˆŠ:DZ.indexOf('å¯…'),åºš:DZ.indexOf('å·³'),å£¬:DZ.indexOf('ç”³'),
                ä¹™:DZ.indexOf('åˆ'),ä¸:DZ.indexOf('é…‰'),å·±:DZ.indexOf('é…‰'),è¾›:DZ.indexOf('å­'),ç™¸:DZ.indexOf('å¯')};
function changSheng(dm,zhi){
  const start=CS_START[dm]; if(start===undefined)return'â€”';
  const zhiIdx=DZ.indexOf(zhi); if(zhiIdx<0)return'â€”';
  const isYang=YY_G[dm]==='é™½';
  let diff=isYang?(zhiIdx-start+12)%12:(start-zhiIdx+12)%12;
  return CHANG_SHENG_ORDER[diff];
}

/* ç¥ç… (ç°¡åŒ–ç‰ˆ â€” å¸¸ç”¨15å€‹) */
function getShenSha(pillars){
  const ss=[];
  const yZ=pillars.year.zhi, dG=pillars.day.gan, dZ=pillars.day.zhi;
  // å¤©ä¹™è²´äºº
  const TIYI={ç”²:['ä¸‘','æœª'],æˆŠ:['ä¸‘','æœª'],åºš:['ä¸‘','æœª'],ä¸™:['äº¥','é…‰'],ä¸:['äº¥','é…‰'],
              ä¹™:['å­','ç”³'],å·±:['å­','ç”³'],å£¬:['å¯','å·³'],ç™¸:['å¯','å·³'],è¾›:['åˆ','å¯…']};
  if(TIYI[dG]){[yZ,pillars.month.zhi,pillars.hour.zhi].forEach(z=>{if(TIYI[dG].includes(z))ss.push('å¤©ä¹™è²´äºº')})}
  // æ–‡æ˜Œ
  const WC={ç”²:'å·³',ä¹™:'åˆ',ä¸™:'ç”³',ä¸:'é…‰',æˆŠ:'ç”³',å·±:'é…‰',åºš:'äº¥',è¾›:'å­',å£¬:'å¯…',ç™¸:'å¯'};
  if(WC[dG]){[yZ,pillars.month.zhi,pillars.hour.zhi].forEach(z=>{if(z===WC[dG])ss.push('æ–‡æ˜Œ')})}
  // é©›é¦¬
  const YM={å¯…:'ç”³',å·³:'äº¥',ç”³:'å¯…',äº¥:'å·³',å­:'åˆ',åˆ:'å­',å¯:'é…‰',é…‰:'å¯',è¾°:'æˆŒ',æˆŒ:'è¾°',ä¸‘:'æœª',æœª:'ä¸‘'};
  if(YM[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===YM[yZ])ss.push('é©›é¦¬')})}
  // æ¡ƒèŠ±
  const TH_MAP={å­:'é…‰',ä¸‘:'åˆ',å¯…:'å¯',å¯:'å­',è¾°:'é…‰',å·³:'åˆ',åˆ:'å¯',æœª:'å­',ç”³:'é…‰',é…‰:'åˆ',æˆŒ:'å¯',äº¥:'å­'};
  if(TH_MAP[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===TH_MAP[yZ])ss.push('æ¡ƒèŠ±')})}
  // è¯è“‹
  const HG_MAP={å­:'è¾°',ä¸‘:'ä¸‘',å¯…:'æˆŒ',å¯:'æœª',è¾°:'è¾°',å·³:'ä¸‘',åˆ:'æˆŒ',æœª:'æœª',ç”³:'è¾°',é…‰:'ä¸‘',æˆŒ:'æˆŒ',äº¥:'æœª'};
  if(HG_MAP[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===HG_MAP[yZ])ss.push('è¯è“‹')})}
  return[...new Set(ss)];
}

/* =============================================================
   BAZI COMPUTATION (å®Œæ•´ç‰ˆ)
   ============================================================= */
function submitStep0(){
  const type=document.getElementById('f-type').value;
  const question=document.getElementById('f-question').value.trim();
  const gender=document.querySelector('input[name="gender"]:checked');
  const bdate=document.getElementById('f-bdate').value;
  if(!type||!question||!gender||!bdate){alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');return}
  const btime=document.getElementById('f-btime').value||'12:00';
  const name=document.getElementById('f-name').value.trim();
  S.form={type,question,gender:gender.value,bdate,btime,name};
  const[y,m,d]=bdate.split('-').map(Number);
  const[hh,mm]=btime.split(':').map(Number);
  S.bazi=computeBazi(y,m,d,hh,mm,gender.value);
  S.ziwei=computeZiwei(y,m,d,hh,gender.value);
  goStep(1);
}

function computeBazi(year,month,day,hour,minute,gender){
  // â”€â”€ å¹´æŸ± â”€â”€
  let ly=year;
  if(month<2||(month===2&&day<4))ly--;
  const yGi=((ly-4)%10+10)%10;
  const yZi=((ly-4)%12+12)%12;
  const yG=TG[yGi], yZ=DZ[yZi];

  // â”€â”€ æœˆæŸ± â”€â”€
  // ç¯€æ°£è¿‘ä¼¼æ—¥
  const JIE=[0,6,4,6,5,6,6,7,8,8,8,7,7]; // index 1-12
  let mi=month;
  if(day<(JIE[month]||6))mi=mi===1?12:mi-1;
  const mZi=((mi+1)%12+12)%12; // æ­£æœˆ=å¯…(2)
  const mGBase=(yGi%5)*2;
  const mGi=(mGBase+(mi-1))%10;
  const mG=TG[(mGi+10)%10], mZ=DZ[mZi];

  // â”€â”€ æ—¥æŸ± â”€â”€
  const base=new Date(1900,0,1);
  const tgt=new Date(year,month-1,day);
  const diff=Math.floor((tgt-base)/864e5);
  const adj=diff+10;
  const dGi=((adj%10)+10)%10;
  const dZi=((adj%12)+12)%12;
  const dG=TG[dGi], dZ=DZ[dZi];

  // â”€â”€ æ™‚æŸ± â”€â”€
  const shi=Math.floor(((hour+1)%24)/2);
  const hZi=shi%12;
  const hGBase=(dGi%5)*2;
  const hGi=(hGBase+hZi)%10;
  const hG=TG[hGi], hZ=DZ[hZi];

  const pillars={year:{gan:yG,zhi:yZ},month:{gan:mG,zhi:mZ},day:{gan:dG,zhi:dZ},hour:{gan:hG,zhi:hZ}};
  const dm=dG, dmEl=WX_G[dm];

  // â”€â”€ äº”è¡Œçµ±è¨ˆï¼ˆå«è—å¹²æ¬Šé‡ï¼‰â”€â”€
  const ec={é‡‘:0,æœ¨:0,æ°´:0,ç«:0,åœŸ:0};
  const allG=[yG,mG,dG,hG], allZ=[yZ,mZ,dZ,hZ];
  allG.forEach(g=>ec[WX_G[g]]+=1.0);
  allZ.forEach(z=>{
    ec[WX_Z[z]]+=1.0;
    const cg=CG[z]||[];
    if(cg[0])ec[WX_G[cg[0]]]+=0.6; // æœ¬æ°£
    if(cg[1])ec[WX_G[cg[1]]]+=0.3; // ä¸­æ°£
    if(cg[2])ec[WX_G[cg[2]]]+=0.1; // é¤˜æ°£
  });
  const tot=Object.values(ec).reduce((a,b)=>a+b,0);
  const ep={}; for(const k of Object.keys(ec))ep[k]=Math.round(ec[k]/tot*100);

  // â”€â”€ èº«å¼·èº«å¼± â”€â”€
  const selfScore=(ec[dmEl]||0)+(ec[BE_SHENG[dmEl]]||0)*0.6;
  const strong=selfScore>tot*0.42;

  // â”€â”€ å–œç”¨ç¥ / å¿Œç¥ â”€â”€
  let fav,unfav;
  if(strong){
    fav=[BE_KE[dmEl],SHENG[dmEl]]; // å…‹æˆ‘(å®˜æ®º)ã€æˆ‘ç”Ÿ(é£Ÿå‚·)
    if(ec[KE[dmEl]]<1.5)fav.push(KE[dmEl]); // æˆ‘å…‹(è²¡)ä¹Ÿå¯ç”¨
    unfav=[dmEl,BE_SHENG[dmEl]];
  }else{
    fav=[dmEl,BE_SHENG[dmEl]]; // åŒæˆ‘(æ¯”åŠ«)ã€ç”Ÿæˆ‘(å°)
    unfav=[BE_KE[dmEl],SHENG[dmEl]];
  }

  // â”€â”€ åç¥ â”€â”€
  const gods={};
  ['year','month','day','hour'].forEach(p=>{
    const g=pillars[p].gan, z=pillars[p].zhi;
    gods[p]={
      gan: p==='day'?'æ—¥ä¸»':tenGod(dm,g),
      zhi: CG[z]?CG[z].map(c=>tenGod(dm,c)):['â€”']
    };
  });

  // â”€â”€ åäºŒé•·ç”Ÿ â”€â”€
  const cs={};
  ['year','month','day','hour'].forEach(p=>{
    cs[p]=changSheng(dm,pillars[p].zhi);
  });

  // â”€â”€ ç¥ç… â”€â”€
  const shensha=getShenSha(pillars);

  // â”€â”€ ç´éŸ³ â”€â”€
  const nayin=getNaYin(yGi,yZi);

  // â”€â”€ å¤§é‹ â”€â”€
  const isFwd=(gender==='male'&&YY_G[yG]==='é™½')||(gender==='female'&&YY_G[yG]==='é™°');
  const dir=isFwd?1:-1;
  const startAge=computeStartAge(year,month,day,dir);
  const dayun=[];
  for(let i=0;i<10;i++){
    const gI=((TG.indexOf(mG)+(i+1)*dir)%10+10)%10;
    const zI=((DZ.indexOf(mZ)+(i+1)*dir)%12+12)%12;
    const as=startAge+i*10, ae=as+9;
    const curAge=new Date().getFullYear()-year;
    const isCur=curAge>=as&&curAge<=ae;
    const dyG=TG[gI],dyZ=DZ[zI],dyEl=WX_G[dyG];
    let lv='å¹³';
    if(fav.includes(dyEl)){
      const god=tenGod(dm,dyG);
      lv=(['æ­£å°','åå°','æ­£å®˜'].includes(god))?'å¤§å‰':'ä¸­å‰';
    }else if(unfav.includes(dyEl)){
      const god=tenGod(dm,dyG);
      lv=(['ä¸ƒæ®º'].includes(god))?'ä¸­å‡¶':'å°å‡¶';
    }
    // æµå¹´
    const liuNian=[];
    for(let j=0;j<10;j++){
      const lnYear=year+as+j;
      const lnGI=((lnYear-4)%10+10)%10;
      const lnZI=((lnYear-4)%12+12)%12;
      const lnG=TG[lnGI],lnZ=DZ[lnZI],lnEl=WX_G[lnG];
      let lnLv='å¹³';
      if(fav.includes(lnEl))lnLv='å‰';
      if(unfav.includes(lnEl))lnLv='å‡¶';
      liuNian.push({year:lnYear,gz:lnG+lnZ,el:lnEl,level:lnLv,god:tenGod(dm,lnG)});
    }
    dayun.push({gz:dyG+dyZ,el:dyEl,ageStart:as,ageEnd:ae,isCurrent:isCur,level:lv,god:tenGod(dm,dyG),liuNian});
  }

  return{pillars,dm,dmEl,strong,ec,ep,fav,unfav,gods,cs,shensha,nayin,dayun,cangGan:{year:CG[yZ],month:CG[mZ],day:CG[dZ],hour:CG[hZ]}};
}

function computeStartAge(y,m,d,dir){
  // ç°¡åŒ–ï¼šé †è¡Œæ‰¾ä¸‹ä¸€å€‹ç¯€æ°£ï¼Œé€†è¡Œæ‰¾ä¸Šä¸€å€‹ï¼Œæ¯3å¤©æŠ˜1æ­²
  // é€™è£¡ç”¨è¿‘ä¼¼å€¼
  const JIE_DAYS=[0,6,4,6,5,6,6,7,8,8,8,7,7];
  const jd=JIE_DAYS[m]||6;
  let diff=dir>0?(jd<=d?30-d+JIE_DAYS[(m%12)+1]:jd-d):(d<=jd?d+30-JIE_DAYS[((m-2+12)%12)+1]:d-jd);
  return Math.max(1,Math.round(diff/3));
}

/* ç´éŸ³ */
function getNaYin(gi,zi){
  const NY=['æµ·ä¸­é‡‘','çˆä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','åŠé‹’é‡‘','å±±é ­ç«','æ¾—ä¸‹æ°´','åŸé ­åœŸ','ç™½è Ÿé‡‘','æ¥ŠæŸ³æœ¨',
            'æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é‚ç«','æ¾æŸæœ¨','é•·æµæ°´','ç ‚ä¸­é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘',
            'è¦†ç‡ˆç«','å¤©æ²³æ°´','å¤§é©›åœŸ','é‡µé‡§é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','ç ‚ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  const idx=Math.floor(((gi*12+zi)/2)%30);
  return NY[idx]||'';
}
/* =============================================================
   æ¢…èŠ±æ˜“æ•¸ MEIHUA YISHU â€” å®Œæ•´64å¦
   ============================================================= */
const BG=[
  {name:'ä¹¾',sym:'â˜°',nat:'å¤©',el:'é‡‘',n:1,li:[1,1,1]},
  {name:'å…Œ',sym:'â˜±',nat:'æ¾¤',el:'é‡‘',n:2,li:[1,1,0]},
  {name:'é›¢',sym:'â˜²',nat:'ç«',el:'ç«',n:3,li:[1,0,1]},
  {name:'éœ‡',sym:'â˜³',nat:'é›·',el:'æœ¨',n:4,li:[1,0,0]},
  {name:'å·½',sym:'â˜´',nat:'é¢¨',el:'æœ¨',n:5,li:[0,1,1]},
  {name:'å',sym:'â˜µ',nat:'æ°´',el:'æ°´',n:6,li:[0,1,0]},
  {name:'è‰®',sym:'â˜¶',nat:'å±±',el:'åœŸ',n:7,li:[0,0,1]},
  {name:'å¤',sym:'â˜·',nat:'åœ°',el:'åœŸ',n:8,li:[0,0,0]}
];
const G64={
'11':{n:'ä¹¾ç‚ºå¤©',u:'ä·€',j:'å…ƒäº¨åˆ©è²ã€‚',m:'å‰›å¥ä¸­æ­£ï¼Œè¬äº‹äº¨é€šï¼Œæˆ’é©•å‚²ã€‚'},
'12':{n:'å¤©æ¾¤å±¥',u:'ä·‰',j:'å±¥è™å°¾ï¼Œä¸å’¥äººï¼Œäº¨ã€‚',m:'å°å¿ƒè¬¹æ…å‰è¡Œï¼Œåˆç¦®å‰‡å‰ã€‚'},
'13':{n:'å¤©ç«åŒäºº',u:'ä·Œ',j:'åŒäººäºé‡ï¼Œäº¨ã€‚',m:'å¿—åŒé“åˆè€…èšé›†ï¼Œåˆ©æ¶‰å¤§å·ã€‚'},
'14':{n:'å¤©é›·ç„¡å¦„',u:'ä·˜',j:'å…ƒäº¨åˆ©è²ã€‚',m:'è‡³èª ç„¡å¦„ï¼Œé †å¤©è€Œè¡Œã€‚'},
'15':{n:'å¤©é¢¨å§¤',u:'ä·«',j:'å¥³å£¯ï¼Œå‹¿ç”¨å–å¥³ã€‚',m:'å¶ç„¶ç›¸é‡ï¼Œä¸å¯æ€¥é€²ã€‚'},
'16':{n:'å¤©æ°´è¨Ÿ',u:'ä·…',j:'æœ‰å­šï¼Œçª’ã€‚',m:'çˆ­è¨Ÿä¹‹è±¡ï¼Œå®œå’Œè§£é€€è®“ã€‚'},
'17':{n:'å¤©å±±é',u:'ä· ',j:'äº¨ï¼Œå°åˆ©è²ã€‚',m:'é€€é¿ä¿èº«ï¼Œä»¥é€€ç‚ºé€²ã€‚'},
'18':{n:'å¤©åœ°å¦',u:'ä·‹',j:'å¦ä¹‹åŒªäººã€‚',m:'é–‰å¡ä¸é€šï¼Œå®ˆéœå¾…æ™‚ã€‚'},
'21':{n:'æ¾¤å¤©å¤¬',u:'ä·ª',j:'æšäºç‹åº­ã€‚',m:'æ±ºæ–·æœæ•¢ï¼Œä»¥å‰›æ±ºæŸ”ã€‚'},
'22':{n:'å…Œç‚ºæ¾¤',u:'ä·¹',j:'äº¨ï¼Œåˆ©è²ã€‚',m:'å–œæ‚…äº¤æµï¼Œè¨€èªå¾—å®œã€‚'},
'23':{n:'æ¾¤ç«é©',u:'ä·°',j:'å·±æ—¥ä¹ƒå­šã€‚',m:'è®Šé©é™¤èˆŠï¼Œæ™‚æ©Ÿæˆç†Ÿæ–¹å¯è¡Œã€‚'},
'24':{n:'æ¾¤é›·éš¨',u:'ä·',j:'å…ƒäº¨åˆ©è²ï¼Œç„¡å’ã€‚',m:'é †å‹¢è€Œè¡Œï¼Œéš¨æ©Ÿæ‡‰è®Šã€‚'},
'25':{n:'æ¾¤é¢¨å¤§é',u:'ä·›',j:'æ£Ÿæ’“ï¼Œåˆ©æœ‰æ”¸å¾€ã€‚',m:'åŠ›é‡éå¤§ï¼Œéœ€è¬¹æ…ã€‚'},
'26':{n:'æ¾¤æ°´å›°',u:'ä·®',j:'äº¨ï¼Œè²ï¼Œå¤§äººå‰ã€‚',m:'å›°å¢ƒä¸­å …å®ˆæ­£é“ï¼Œçµ‚å°‡é€šé”ã€‚'},
'27':{n:'æ¾¤å±±å’¸',u:'ä·',j:'äº¨ï¼Œåˆ©è²ã€‚',m:'æ„Ÿæ‡‰ä¹‹é“ï¼Œå¿ƒæ„ç›¸é€šã€‚'},
'28':{n:'æ¾¤åœ°èƒ',u:'ä·¬',j:'äº¨ï¼Œç‹å‡æœ‰å»Ÿã€‚',m:'èšé›†åŒ¯èƒï¼Œåˆ©è¦‹å¤§äººã€‚'},
'31':{n:'ç«å¤©å¤§æœ‰',u:'ä·',j:'å…ƒäº¨ã€‚',m:'è±æ”¶å¤§æœ‰ï¼Œå…‰æ˜æ­£å¤§ã€‚'},
'32':{n:'ç«æ¾¤ç½',u:'ä·¥',j:'å°äº‹å‰ã€‚',m:'ä¹–é›¢èƒŒåï¼Œæ±‚åŒå­˜ç•°ã€‚'},
'33':{n:'é›¢ç‚ºç«',u:'ä·',j:'åˆ©è²ï¼Œäº¨ã€‚',m:'å…‰æ˜é™„éº—ï¼Œä¾é™„æ­£é“ã€‚'},
'34':{n:'ç«é›·å™¬å—‘',u:'ä·”',j:'äº¨ï¼Œåˆ©ç”¨ç„ã€‚',m:'æ˜è¾¨æ˜¯éï¼Œæœæ–·è™•ç†ã€‚'},
'35':{n:'ç«é¢¨é¼',u:'ä·±',j:'å…ƒå‰ï¼Œäº¨ã€‚',m:'é¼æ–°é™¤èˆŠï¼Œè®Šé©å‰µæ–°ã€‚'},
'36':{n:'ç«æ°´æœªæ¿Ÿ',u:'ä·¿',j:'äº¨ï¼Œå°ç‹æ±”æ¿Ÿã€‚',m:'å°šæœªå®Œæˆï¼Œä»éœ€åŠªåŠ›ã€‚'},
'37':{n:'ç«å±±æ—…',u:'ä··',j:'å°äº¨ã€‚',m:'å®¢å±…åœ¨å¤–ï¼Œè¬¹æ…è™•ä¸–ã€‚'},
'38':{n:'ç«åœ°æ™‰',u:'ä·¢',j:'åº·ä¾¯ç”¨éŒ«é¦¬è•ƒåº¶ã€‚',m:'å…‰æ˜ä¸Šé€²ï¼Œæ­¥æ­¥æ™‰å‡ã€‚'},
'41':{n:'é›·å¤©å¤§å£¯',u:'ä·¡',j:'åˆ©è²ã€‚',m:'æ°£å‹¢å£¯ç››ï¼Œå®ˆæ­£æ–¹å‰ã€‚'},
'42':{n:'é›·æ¾¤æ­¸å¦¹',u:'ä·µ',j:'å¾å‡¶ï¼Œç„¡æ”¸åˆ©ã€‚',m:'å®‰åˆ†å®ˆå·±ï¼Œä¸å¯å¦„å‹•ã€‚'},
'43':{n:'é›·ç«è±',u:'ä·¶',j:'äº¨ï¼Œç‹å‡ä¹‹ã€‚',m:'è±ç››ä¹‹æ™‚ï¼Œå±…å®‰æ€å±ã€‚'},
'44':{n:'éœ‡ç‚ºé›·',u:'ä·²',j:'äº¨ã€‚',m:'éœ‡å‹•å¥®ç™¼ï¼Œå…ˆé©šå¾Œå–œã€‚'},
'45':{n:'é›·é¢¨æ†',u:'ä·Ÿ',j:'äº¨ï¼Œç„¡å’ï¼Œåˆ©è²ã€‚',m:'æ†ä¹…ä¸è®Šï¼Œå®ˆæŒæ­£é“ã€‚'},
'46':{n:'é›·æ°´è§£',u:'ä·§',j:'åˆ©è¥¿å—ã€‚',m:'å±é›£è§£é™¤ï¼Œå®œé€Ÿè¡Œå‹•ã€‚'},
'47':{n:'é›·å±±å°é',u:'ä·½',j:'äº¨ï¼Œåˆ©è²ã€‚',m:'å°æœ‰éè¶Šï¼Œä½èª¿è¡Œäº‹ã€‚'},
'48':{n:'é›·åœ°è±«',u:'ä·',j:'åˆ©å»ºä¾¯è¡Œå¸«ã€‚',m:'æ­¡æ¨‚è±«æ‚…ï¼Œæº–å‚™å……åˆ†ã€‚'},
'51':{n:'é¢¨å¤©å°ç•œ',u:'ä·ˆ',j:'äº¨ï¼Œå¯†é›²ä¸é›¨ã€‚',m:'åŠ›é‡ä¸è¶³ï¼Œæš«æ™‚è“„ç©ã€‚'},
'52':{n:'é¢¨æ¾¤ä¸­å­š',u:'ä·¼',j:'è±šé­šå‰ã€‚',m:'èª ä¿¡ç‚ºæœ¬ï¼Œä¿¡å‰‡éˆé©—ã€‚'},
'53':{n:'é¢¨ç«å®¶äºº',u:'ä·¤',j:'åˆ©å¥³è²ã€‚',m:'å®¶é“æ˜Œæ˜ï¼Œå„å®‰å…¶ä½ã€‚'},
'54':{n:'é¢¨é›·ç›Š',u:'ä·©',j:'åˆ©æœ‰æ”¸å¾€ã€‚',m:'æä¸Šç›Šä¸‹ï¼Œåˆ©æ–¼é€²å–ã€‚'},
'55':{n:'å·½ç‚ºé¢¨',u:'ä·¸',j:'å°äº¨ï¼Œåˆ©æœ‰æ”¸å¾€ã€‚',m:'æŸ”é †æ¼¸é€²ï¼Œä»¥é€€ç‚ºé€²ã€‚'},
'56':{n:'é¢¨æ°´æ¸™',u:'ä·º',j:'äº¨ï¼Œç‹å‡æœ‰å»Ÿã€‚',m:'é›¢æ•£æ¸™æ•£ï¼Œéœ€å‡èšäººå¿ƒã€‚'},
'57':{n:'é¢¨å±±æ¼¸',u:'ä·´',j:'å¥³æ­¸å‰ï¼Œåˆ©è²ã€‚',m:'å¾ªåºæ¼¸é€²ï¼Œç©©æ­¥å‰è¡Œã€‚'},
'58':{n:'é¢¨åœ°è§€',u:'ä·“',j:'ç›¥è€Œä¸è–¦ã€‚',m:'è§€å¯Ÿå¯©è¦–ï¼Œä»¥èº«ä½œå‰‡ã€‚'},
'61':{n:'æ°´å¤©éœ€',u:'ä·„',j:'æœ‰å­šï¼Œå…‰äº¨ã€‚',m:'ç­‰å¾…æ™‚æ©Ÿï¼Œè€å¿ƒå®ˆå€™ã€‚'},
'62':{n:'æ°´æ¾¤ç¯€',u:'ä·»',j:'äº¨ï¼Œè‹¦ç¯€ä¸å¯è²ã€‚',m:'é©åº¦ç¯€åˆ¶ï¼Œä¸å¯éåº¦ã€‚'},
'63':{n:'æ°´ç«æ—¢æ¿Ÿ',u:'ä·¾',j:'äº¨å°ï¼Œåˆ©è²ã€‚',m:'äº‹å·²æˆï¼Œå±…å®‰æ€å±ã€‚'},
'64':{n:'æ°´é›·å±¯',u:'ä·‚',j:'å…ƒäº¨åˆ©è²ã€‚',m:'å‰µå§‹ä¹‹é›£ï¼Œå …æŒçµ‚æœ‰æˆã€‚'},
'65':{n:'æ°´é¢¨äº•',u:'ä·¯',j:'æ”¹é‚‘ä¸æ”¹äº•ã€‚',m:'é¤Šæ°‘ä¹‹æºï¼Œä¸å¯è’å»¢ã€‚'},
'66':{n:'åç‚ºæ°´',u:'ä·œ',j:'æœ‰å­šï¼Œç¶­å¿ƒäº¨ã€‚',m:'é‡é‡éšªé›£ï¼Œä»¥ä¿¡å¿ƒè¡Œéšªã€‚'},
'67':{n:'æ°´å±±è¹‡',u:'ä·¦',j:'åˆ©è¥¿å—ã€‚',m:'å‰è·¯è‰±éšªï¼Œé€€å®ˆåçœã€‚'},
'68':{n:'æ°´åœ°æ¯”',u:'ä·‡',j:'å‰ï¼ŒåŸç­®å…ƒæ°¸è²ã€‚',m:'è¦ªé™„æ¯”å’Œï¼Œåœ˜çµäº’åŠ©ã€‚'},
'71':{n:'å±±å¤©å¤§ç•œ',u:'ä·™',j:'åˆ©è²ï¼Œä¸å®¶é£Ÿå‰ã€‚',m:'è“„ç©åŠ›é‡ï¼Œåšç©è–„ç™¼ã€‚'},
'72':{n:'å±±æ¾¤æ',u:'ä·¨',j:'æœ‰å­šï¼Œå…ƒå‰ã€‚',m:'æ¸›æè‡ªå·±ï¼Œåˆ©ç›Šä»–äººã€‚'},
'73':{n:'å±±ç«è³',u:'ä·•',j:'äº¨ï¼Œå°åˆ©æœ‰æ”¸å¾€ã€‚',m:'æ–‡é£¾å¤–è¡¨ï¼Œä¸å¿˜æœ¬è³ªã€‚'},
'74':{n:'å±±é›·é ¤',u:'ä·š',j:'è²å‰ï¼Œè§€é ¤ã€‚',m:'é¤Šç”Ÿä¹‹é“ï¼Œæ…è¨€ç¯€é£Ÿã€‚'},
'75':{n:'å±±é¢¨è ±',u:'ä·‘',j:'å…ƒäº¨ï¼Œåˆ©æ¶‰å¤§å·ã€‚',m:'æ•´æ²»è…æ•—ï¼Œæ’¥äº‚åæ­£ã€‚'},
'76':{n:'å±±æ°´è’™',u:'ä·ƒ',j:'äº¨ï¼ŒåŒªæˆ‘æ±‚ç«¥è’™ã€‚',m:'å•Ÿè’™ä¹‹åˆï¼Œè™›å¿ƒå­¸ç¿’ã€‚'},
'77':{n:'è‰®ç‚ºå±±',u:'ä·³',j:'è‰®å…¶èƒŒï¼Œä¸ç²å…¶èº«ã€‚',m:'é©å¯è€Œæ­¢ï¼Œéœæ­¢å®ˆåˆ†ã€‚'},
'78':{n:'å±±åœ°å‰',u:'ä·–',j:'ä¸åˆ©æœ‰æ”¸å¾€ã€‚',m:'è¡°è½å‰è•ï¼Œéœå¾…å¾©ç”¦ã€‚'},
'81':{n:'åœ°å¤©æ³°',u:'ä·Š',j:'å°å¾€å¤§ä¾†ï¼Œå‰äº¨ã€‚',m:'é€šæ³°å’Œé †ï¼Œè¬äº‹äº¨é€šã€‚'},
'82':{n:'åœ°æ¾¤è‡¨',u:'ä·’',j:'å…ƒäº¨åˆ©è²ã€‚',m:'å±…é«˜è‡¨ä¸‹ï¼Œæ•™åŒ–è¬æ°‘ã€‚'},
'83':{n:'åœ°ç«æ˜å¤·',u:'ä·£',j:'åˆ©è‰±è²ã€‚',m:'å…‰æ˜å—å‚·ï¼ŒéŸœå…‰é¤Šæ™¦ã€‚'},
'84':{n:'åœ°é›·å¾©',u:'ä·—',j:'äº¨ï¼Œå‡ºå…¥ç„¡ç–¾ã€‚',m:'ä¸€é™½å¾©å§‹ï¼Œå¦æ¥µæ³°ä¾†ã€‚'},
'85':{n:'åœ°é¢¨å‡',u:'ä·­',j:'å…ƒäº¨ã€‚',m:'é€æ­¥ä¸Šå‡ï¼Œç©å°æˆå¤§ã€‚'},
'86':{n:'åœ°æ°´å¸«',u:'ä·†',j:'è²ï¼Œä¸ˆäººå‰ã€‚',m:'çµ±ç‡çœ¾äººï¼Œä»¥æ­£ç‚ºè¦ã€‚'},
'87':{n:'åœ°å±±è¬™',u:'ä·',j:'äº¨ï¼Œå›å­æœ‰çµ‚ã€‚',m:'è¬™è™›è‡ªç‰§ï¼Œå‰ç„¡ä¸åˆ©ã€‚'},
'88':{n:'å¤ç‚ºåœ°',u:'ä·',j:'å…ƒäº¨ï¼Œåˆ©ç‰é¦¬ä¹‹è²ã€‚',m:'æŸ”é †æ‰¿è¼‰ï¼Œåšå¾·åŒ…å®¹ã€‚'}
};

function gByN(n){return BG[((n-1)%8+8)%8]}
function g64(un,ln){return G64[''+un+ln]||{n:'æœªçŸ¥',u:'?',j:'',m:''}}
function gByL(l1,l2,l3){return BG.find(g=>g.li[0]===l3&&g.li[1]===l2&&g.li[2]===l1)||BG[7]}

function tiYong(ti,yo){
  if(ti===yo)return{r:'æ¯”å’Œ',f:'å‰',d:'é«”ç”¨ç›¸åŒï¼Œäº‹æƒ…é †åˆ©ã€‚'};
  if(SHENG[yo]===ti)return{r:'ç”¨ç”Ÿé«”',f:'å¤§å‰',d:'å¤–åŠ›åŠ©ç›Šï¼Œäº‹åŠåŠŸå€ã€‚'};
  if(SHENG[ti]===yo)return{r:'é«”ç”Ÿç”¨',f:'å°å‡¶',d:'è€—è²»ç²¾åŠ›ï¼Œä»˜å‡ºå¤šå›å ±å°‘ã€‚'};
  if(KE[yo]===ti)return{r:'ç”¨å…‹é«”',f:'å‡¶',d:'å¤–åŠ›é˜»ç¤™ï¼Œå›°é›£é‡é‡ã€‚'};
  if(KE[ti]===yo)return{r:'é«”å…‹ç”¨',f:'å°å‰',d:'å¯æŒæ§å±€é¢ï¼Œä½†éœ€è²»åŠ›ã€‚'};
  return{r:'â€”',f:'å¹³',d:''};
}

function calcMH(un,ln,dy){
  const up=gByN(un),lo=gByN(ln),dong=((dy-1)%6)+1;
  const ben=g64(up.n==='ä¹¾'?1:up.n==='å…Œ'?2:up.n==='é›¢'?3:up.n==='éœ‡'?4:up.n==='å·½'?5:up.n==='å'?6:up.n==='è‰®'?7:8,
               lo.n==='ä¹¾'?1:lo.n==='å…Œ'?2:lo.n==='é›¢'?3:lo.n==='éœ‡'?4:lo.n==='å·½'?5:lo.n==='å'?6:lo.n==='è‰®'?7:8);
  const benL=[...lo.li,...up.li];
  const huLo=gByL(benL[1],benL[2],benL[3]);
  const huUp=gByL(benL[2],benL[3],benL[4]);
  const hu=g64(huUp.n==='ä¹¾'?1:huUp.n==='å…Œ'?2:huUp.n==='é›¢'?3:huUp.n==='éœ‡'?4:huUp.n==='å·½'?5:huUp.n==='å'?6:huUp.n==='è‰®'?7:8,
               huLo.n==='ä¹¾'?1:huLo.n==='å…Œ'?2:huLo.n==='é›¢'?3:huLo.n==='éœ‡'?4:huLo.n==='å·½'?5:huLo.n==='å'?6:huLo.n==='è‰®'?7:8);
  const biL=[...benL]; biL[dong-1]=biL[dong-1]?0:1;
  const biLo=gByL(biL[0],biL[1],biL[2]);
  const biUp=gByL(biL[3],biL[4],biL[5]);
  const bian=g64(biUp.n==='ä¹¾'?1:biUp.n==='å…Œ'?2:biUp.n==='é›¢'?3:biUp.n==='éœ‡'?4:biUp.n==='å·½'?5:biUp.n==='å'?6:biUp.n==='è‰®'?7:8,
                 biLo.n==='ä¹¾'?1:biLo.n==='å…Œ'?2:biLo.n==='é›¢'?3:biLo.n==='éœ‡'?4:biLo.n==='å·½'?5:biLo.n==='å'?6:biLo.n==='è‰®'?7:8);
  const tiG=dong<=3?up:lo, yoG=dong<=3?lo:up;
  const ty=tiYong(tiG.el,yoG.el);
  return{up,lo,dong,ben,hu,bian,tiG,yoG,ty};
}

function guaNum(g){return g.n==='ä¹¾'?1:g.n==='å…Œ'?2:g.n==='é›¢'?3:g.n==='éœ‡'?4:g.n==='å·½'?5:g.n==='å'?6:g.n==='è‰®'?7:8}

function showMH(r){
  S.meihua=r;
  document.getElementById('mh-ben-s').textContent=r.ben.u;
  document.getElementById('mh-ben-n').textContent=r.ben.n;
  document.getElementById('mh-hu-s').textContent=r.hu.u;
  document.getElementById('mh-hu-n').textContent=r.hu.n;
  document.getElementById('mh-bian-s').textContent=r.bian.u;
  document.getElementById('mh-bian-n').textContent=r.bian.n;
  document.getElementById('mh-detail').innerHTML=`
    <p><strong>é«”å¦ï¼š</strong>${r.tiG.name}ï¼ˆ${r.tiG.el}ï¼‰ï½œ<strong>ç”¨å¦ï¼š</strong>${r.yoG.name}ï¼ˆ${r.yoG.el}ï¼‰</p>
    <p><strong>é«”ç”¨ï¼š</strong><span class="tag tag-gold">${r.ty.r}</span> <span class="tag ${r.ty.f.includes('å‰')?'tag-green':'tag-red'}">${r.ty.f}</span></p>
    <p class="mt-sm">${r.ty.d}</p><div class="divider"></div>
    <p><strong>å¦è¾­ï¼š</strong>${r.ben.j}</p><p><strong>è§£è®€ï¼š</strong>${r.ben.m}</p>
    <p><strong>å‹•çˆ»ï¼š</strong>ç¬¬ ${r.dong} çˆ»</p><p class="mt-sm"><strong>è®Šå¦ï¼š</strong>${r.bian.m}</p>`;
  document.getElementById('mh-result').classList.remove('hidden');
}

/* æ¼¢å­—ç­†ç•«æ•¸ï¼ˆç°¡è¡¨ï¼‰ */
const BIHUA_MAP={'æ„›':13,'æƒ…':11,'éŒ¢':16,'è²¡':10,'å·¥':3,'ä½œ':7,'äº‹':8,'æ¥­':13,'å¥':11,'åº·':11,'å®¶':10,'åº­':10,'äºº':2,'éš›':14,'é‹':12,'å‹¢':13,'æ„Ÿ':13,'å©š':11,'å§»':9,'å­¸':16,'ç¿’':11,'è€ƒ':6,'è©¦':13,'å‡':4,'è·':18,'è½‰':18};
function bihua(ch){return BIHUA_MAP[ch]||((ch.charCodeAt(0)%20)+2)}

function setMhMethod(m){
  ['time','number','char','random'].forEach(id=>{
    document.getElementById('mhf-'+id).classList.toggle('hidden',id!==m);
    const btn=document.getElementById('mh-m-'+id);
    if(id===m){btn.classList.remove('btn-outline');btn.classList.add('btn-tab-active')}
    else{btn.classList.add('btn-outline');btn.classList.remove('btn-tab-active')}
  });
}
function calcMhTime(){
  const now=new Date();
  const y=now.getFullYear(),m=now.getMonth()+1,d=now.getDate(),h=now.getHours();
  // è¾²æ›†è¿‘ä¼¼
  const un=(y+m+d)%8||8, ln=(y+m+d+h)%8||8, dy=(y+m+d+h)%6||6;
  showMH(calcMH(un,ln,dy));
}
function calcMhNumber(){
  const n1=parseInt(document.getElementById('mh-n1').value)||1;
  const n2=parseInt(document.getElementById('mh-n2').value)||1;
  const n3=parseInt(document.getElementById('mh-n3').value)||1;
  showMH(calcMH(n1,n2,Math.min(6,Math.max(1,n3))));
}
function calcMhChar(){
  const ch=document.getElementById('mh-char').value.trim();
  if(!ch){alert('è«‹è¼¸å…¥æ¼¢å­—');return}
  const chars=[...ch];
  let un,ln,dy;
  if(chars.length===1){un=bihua(chars[0]);ln=un;dy=(un*2)%6||6}
  else if(chars.length===2){un=bihua(chars[0]);ln=bihua(chars[1]);dy=(un+ln)%6||6}
  else{un=bihua(chars[0])+bihua(chars[1]);ln=bihua(chars[chars.length-1]);dy=(un+ln)%6||6}
  showMH(calcMH(un,ln,dy));
}
function calcMhRandom(){
  showMH(calcMH(Math.ceil(Math.random()*8),Math.ceil(Math.random()*8),Math.ceil(Math.random()*6)));
}
/* =============================================================
   å¡”ç¾…ç‰Œ TAROT â€” 22å¤§ç‰Œ + å‡±çˆ¾ç‰¹åå­—ç‰Œé™£
   ============================================================= */
const TAROT=[
  {id:0,n:'æ„šè€…',el:'é¢¨',up:'å……æ»¿ç„¡é™å¯èƒ½ï¼Œå‹‡æ•¢è¸å‡ºç¬¬ä¸€æ­¥ã€‚',rv:'é­¯è½è¡Œäº‹ï¼Œç¼ºä¹è¨ˆç•«ã€‚'},
  {id:1,n:'é­”è¡“å¸«',el:'æ°´æ˜Ÿ',up:'æ“æœ‰æˆåŠŸæ‰€éœ€çš„ä¸€åˆ‡è³‡æºã€‚',rv:'æ‰èƒ½æœªç™¼æ®ï¼Œæ³¨æ„æ¬ºé¨™ã€‚'},
  {id:2,n:'å¥³ç¥­å¸',el:'æœˆäº®',up:'å‚¾è½ç›´è¦ºï¼Œéœå¾…æ™‚æ©Ÿã€‚',rv:'éæ–¼å°é–‰ï¼Œå¿½è¦–å…§å¿ƒè²éŸ³ã€‚'},
  {id:3,n:'çš‡å',el:'é‡‘æ˜Ÿ',up:'è±æ”¶èˆ‡æ»‹é¤Šï¼Œå‰µé€ åŠ›æ—ºç››ã€‚',rv:'ä¾è³´ä»–äººï¼Œéåº¦æ”¾ç¸±ã€‚'},
  {id:4,n:'çš‡å¸',el:'ç™½ç¾Š',up:'æŒæ§å±€é¢ï¼Œå»ºç«‹ç§©åºã€‚',rv:'æ§åˆ¶æ¬²å¼·ï¼Œéæ–¼åƒµåŒ–ã€‚'},
  {id:5,n:'æ•™çš‡',el:'é‡‘ç‰›',up:'éµå¾ªæ­£é“ï¼Œå°‹æ±‚æ™ºè€…æŒ‡å¼•ã€‚',rv:'æ•™æ¢ä¸»ç¾©ï¼Œä¸çŸ¥è®Šé€šã€‚'},
  {id:6,n:'æˆ€äºº',el:'é›™å­',up:'åšå‡ºé‡è¦é¸æ“‡ï¼ŒçœŸæ„›é™è‡¨ã€‚',rv:'é—œä¿‚ä¸å’Œï¼Œåƒ¹å€¼è§€è¡çªã€‚'},
  {id:7,n:'æˆ°è»Š',el:'å·¨èŸ¹',up:'å …å®šæ„å¿—ï¼Œå…‹æœå›°é›£å‰é€²ã€‚',rv:'å¤±æ§ï¼Œæ–¹å‘ä¸æ˜ã€‚'},
  {id:8,n:'åŠ›é‡',el:'ç…å­',up:'ä»¥æŸ”å…‹å‰›ï¼Œå…§åœ¨åŠ›é‡å¼·å¤§ã€‚',rv:'è‡ªæˆ‘æ‡·ç–‘ï¼Œç¼ºä¹ä¿¡å¿ƒã€‚'},
  {id:9,n:'éš±è€…',el:'è™•å¥³',up:'ç¨è™•åçœï¼Œå°‹æ‰¾å…§åœ¨æ™ºæ…§ã€‚',rv:'éåº¦å­¤ç«‹ï¼Œé€ƒé¿ç¾å¯¦ã€‚'},
  {id:10,n:'å‘½é‹ä¹‹è¼ª',el:'æœ¨æ˜Ÿ',up:'å‘½é‹è½‰æŠ˜ï¼Œå¥½é‹é™è‡¨ã€‚',rv:'é€†å¢ƒï¼ŒæŠ—æ‹’æ”¹è®Šã€‚'},
  {id:11,n:'æ­£ç¾©',el:'å¤©ç§¤',up:'å…¬æ­£çš„çµæœï¼Œå› æœå ±æ‡‰ã€‚',rv:'ä¸å…¬ã€åè¦‹ã€‚'},
  {id:12,n:'åŠäºº',el:'æ°´',up:'æ›è§’åº¦çœ‹å•é¡Œï¼Œæš«æ™‚çŠ§ç‰²ã€‚',rv:'ä¸å¿…è¦çš„çŠ§ç‰²ï¼Œæ‹–å»¶ã€‚'},
  {id:13,n:'æ­»ç¥',el:'å¤©è ',up:'èˆŠçš„çµæŸï¼Œæ–°çš„é–‹å§‹ã€‚',rv:'æŠ—æ‹’æ”¹è®Šï¼Œåœæ»¯ä¸å‰ã€‚'},
  {id:14,n:'ç¯€åˆ¶',el:'å°„æ‰‹',up:'ä¿æŒä¸­åº¸ï¼Œèª¿å’Œå„æ–¹ã€‚',rv:'å¤±è¡¡ï¼Œéåº¦ã€‚'},
  {id:15,n:'æƒ¡é­”',el:'æ‘©ç¾¯',up:'é¢å°é™°æš—é¢ï¼Œç‰©è³ªèª˜æƒ‘ã€‚',rv:'æ™è„«æŸç¸›ï¼Œé‡ç²è‡ªç”±ã€‚'},
  {id:16,n:'å¡”',el:'ç«æ˜Ÿ',up:'çªç„¶æ”¹è®Šï¼ŒèˆŠçµæ§‹å´©å¡Œã€‚',rv:'é¿é–‹ç½é›£ï¼Œæ‹’çµ•æ”¹è®Šã€‚'},
  {id:17,n:'æ˜Ÿæ˜Ÿ',el:'æ°´ç“¶',up:'å¸Œæœ›ä¹‹å…‰ï¼Œéˆæ„Ÿæ¹§ç¾ã€‚',rv:'å¤±æœ›ï¼Œç¼ºä¹ä¿¡å¿ƒã€‚'},
  {id:18,n:'æœˆäº®',el:'é›™é­š',up:'é¢å°ææ‡¼ï¼Œç©¿è¶Šè¿·éœ§ã€‚',rv:'èµ°å‡ºè¿·æƒ˜ï¼ŒçœŸç›¸é¡¯ç¾ã€‚'},
  {id:19,n:'å¤ªé™½',el:'å¤ªé™½',up:'ä¸€åˆ‡å…‰æ˜æ­£å¤§ï¼Œå–œæ‚…æˆåŠŸã€‚',rv:'çŸ­æš«é™°éœ¾ï¼Œä¿¡å¿ƒä¸è¶³ã€‚'},
  {id:20,n:'å¯©åˆ¤',el:'å†¥ç‹æ˜Ÿ',up:'éˆé­‚è¦ºé†’ï¼Œé‡æ–°è©•ä¼°ã€‚',rv:'è‡ªæˆ‘æ‡·ç–‘ï¼Œæ‹’çµ•æˆé•·ã€‚'},
  {id:21,n:'ä¸–ç•Œ',el:'åœŸæ˜Ÿ',up:'é”æˆç›®æ¨™ï¼Œåœ“æ»¿å®Œæˆã€‚',rv:'æœªå®Œæˆï¼Œç¼ºä¹åœ“æ»¿ã€‚'},
  // å°é˜¿çˆ¾å¡ç´ â€” æ¬Šæ–
  {id:22,n:'æ¬Šæ–ç‹ç‰Œ',el:'ç«',up:'æ–°è¨ˆç•«å•Ÿå‹•ï¼Œå‰µé€ åŠ›è¿¸ç™¼ã€‚',rv:'å»¶é²ï¼ŒçŒ¶è±«ä¸æ±ºã€‚'},
  {id:23,n:'æ¬Šæ–äºŒ',el:'ç«',up:'è¨ˆç•«ä¸­ï¼Œç­‰å¾…æ™‚æ©Ÿã€‚',rv:'ææ‡¼æ”¹è®Šï¼Œç¼ºä¹é è¦‹ã€‚'},
  {id:24,n:'æ¬Šæ–ä¸‰',el:'ç«',up:'æ‹“å±•è¦–é‡ï¼Œåˆä½œé †åˆ©ã€‚',rv:'ç¼ºä¹é è¦‹ï¼Œè¨ˆç•«å—é˜»ã€‚'},
  {id:25,n:'æ¬Šæ–å››',el:'ç«',up:'æ…¶ç¥æˆå°±ï¼Œå’Œè«§ç©©å®šã€‚',rv:'ä¸å®‰å®šï¼Œç¼ºä¹æ­¸å±¬æ„Ÿã€‚'},
  {id:26,n:'æ¬Šæ–äº”',el:'ç«',up:'ç«¶çˆ­æ¿€çƒˆï¼Œéœ€å …æŒç«‹å ´ã€‚',rv:'é€ƒé¿è¡çªï¼Œå…§è€—ã€‚'},
  {id:27,n:'æ¬Šæ–å…­',el:'ç«',up:'å‹åˆ©èˆ‡èªå¯ï¼Œå…¬é–‹æˆåŠŸã€‚',rv:'è‡ªè² ï¼Œç¼ºä¹èªå¯ã€‚'},
  {id:28,n:'æ¬Šæ–ä¸ƒ',el:'ç«',up:'å …å®ˆç«‹å ´ï¼Œé¢å°æŒ‘æˆ°ã€‚',rv:'åŠ›ä¸å¾å¿ƒï¼Œè¢«å£“å€’ã€‚'},
  {id:29,n:'æ¬Šæ–å…«',el:'ç«',up:'å¿«é€Ÿç™¼å±•ï¼Œæ¶ˆæ¯åˆ°ä¾†ã€‚',rv:'å»¶é²ï¼Œæ€¥èºã€‚'},
  {id:30,n:'æ¬Šæ–ä¹',el:'ç«',up:'å …æŒåˆ°åº•ï¼Œæœ€å¾Œé˜²ç·šã€‚',rv:'ç–²æ†Šï¼Œå›ºåŸ·ã€‚'},
  {id:31,n:'æ¬Šæ–å',el:'ç«',up:'è²¬ä»»æ²‰é‡ï¼Œå …æŒå‰è¡Œã€‚',rv:'æ”¾ä¸‹é‡æ“”ï¼Œå§”æ´¾ä»–äººã€‚'},
  {id:32,n:'æ¬Šæ–ä¾è€…',el:'ç«',up:'å¥½æ¶ˆæ¯ï¼Œæ–°å†’éšªã€‚',rv:'ä¸åˆ‡å¯¦éš›çš„è¨ˆç•«ã€‚'},
  {id:33,n:'æ¬Šæ–é¨å£«',el:'ç«',up:'è¡Œå‹•åŠ›å¼·ï¼Œè¿½æ±‚ç†±æƒ…ã€‚',rv:'è¡å‹•ï¼Œé­¯è½ã€‚'},
  {id:34,n:'æ¬Šæ–çš‡å',el:'ç«',up:'è‡ªä¿¡ã€é­…åŠ›ï¼Œæ¿€å‹µä»–äººã€‚',rv:'å«‰å¦’ï¼Œè‡ªæˆ‘ä¸­å¿ƒã€‚'},
  {id:35,n:'æ¬Šæ–åœ‹ç‹',el:'ç«',up:'é ˜å°åŠ›å¼·ï¼Œé¡˜æ™¯å®å¤§ã€‚',rv:'å‚²æ…¢ï¼Œåš´è‹›ã€‚'},
  // è–æ¯
  {id:36,n:'è–æ¯ç‹ç‰Œ',el:'æ°´',up:'æ–°æ„Ÿæƒ…é–‹å§‹ï¼Œæƒ…æ„Ÿå……æ²›ã€‚',rv:'æ„Ÿæƒ…å°é–‰ï¼ŒéŒ¯å¤±æ©Ÿæœƒã€‚'},
  {id:37,n:'è–æ¯äºŒ',el:'æ°´',up:'ä¼´ä¾¶é—œä¿‚ï¼Œç›¸äº’å¸å¼•ã€‚',rv:'å¤±è¡¡ï¼Œæºé€šä¸è‰¯ã€‚'},
  {id:38,n:'è–æ¯ä¸‰',el:'æ°´',up:'æ­¡æ…¶å‹èª¼ï¼Œç¤¾äº¤æ´»å‹•ã€‚',rv:'éåº¦æ”¾ç¸±ï¼Œå­¤ç«‹ã€‚'},
  {id:39,n:'è–æ¯å››',el:'æ°´',up:'å°ç¾ç‹€ä¸æ»¿ï¼ŒéŒ¯å¤±æ©Ÿæœƒã€‚',rv:'é‡æ–°å¯©è¦–ï¼Œç™¼ç¾æ–°å¯èƒ½ã€‚'},
  {id:40,n:'è–æ¯äº”',el:'æ°´',up:'å¤±è½èˆ‡æ‚²å‚·ï¼Œä½†ä»æœ‰å¸Œæœ›ã€‚',rv:'èµ°å‡ºæ‚²å‚·ï¼Œæ¥å—ç¾å¯¦ã€‚'},
  {id:41,n:'è–æ¯å…­',el:'æ°´',up:'æ‡·èˆŠï¼Œç«¥å¹´å›æ†¶ã€‚',rv:'æ´»åœ¨éå»ï¼Œç„¡æ³•å‰é€²ã€‚'},
  {id:42,n:'è–æ¯ä¸ƒ',el:'æ°´',up:'å¤ªå¤šé¸æ“‡ï¼Œéœ€åˆ†è¾¨å¹»è±¡ã€‚',rv:'åšå‡ºæ±ºå®šï¼Œé¢å°ç¾å¯¦ã€‚'},
  {id:43,n:'è–æ¯å…«',el:'æ°´',up:'é›¢é–‹ä¸å†é©åˆçš„ï¼Œå°‹æ‰¾æ›´æ·±ã€‚',rv:'ææ‡¼æ”¹è®Šï¼Œç•™åœ¨èˆ’é©å€ã€‚'},
  {id:44,n:'è–æ¯ä¹',el:'æ°´',up:'é¡˜æœ›å¯¦ç¾ï¼Œæ»¿è¶³æ„Ÿã€‚',rv:'ä¸æ»¿ï¼Œç‰©è³ªä¸»ç¾©ã€‚'},
  {id:45,n:'è–æ¯å',el:'æ°´',up:'æƒ…æ„Ÿåœ“æ»¿ï¼Œå®¶åº­å¹¸ç¦ã€‚',rv:'å®¶åº­å•é¡Œï¼Œä¸å’Œè«§ã€‚'},
  {id:46,n:'è–æ¯ä¾è€…',el:'æ°´',up:'æµªæ¼«è¨Šæ¯ï¼Œç›´è¦ºç™¼å±•ã€‚',rv:'æƒ…ç·’ä¸ç©©ï¼Œä¸æˆç†Ÿã€‚'},
  {id:47,n:'è–æ¯é¨å£«',el:'æ°´',up:'æµªæ¼«è¿½æ±‚è€…ï¼Œæ„Ÿæ€§è¡Œå‹•ã€‚',rv:'æƒ…ç·’åŒ–ï¼Œä¸åˆ‡å¯¦éš›ã€‚'},
  {id:48,n:'è–æ¯çš‡å',el:'æ°´',up:'æ…ˆæ„›ï¼Œæƒ…æ„Ÿè±å¯Œï¼Œç›´è¦ºå¼·ã€‚',rv:'æƒ…ç·’åŒ–ï¼Œéåº¦ä»˜å‡ºã€‚'},
  {id:49,n:'è–æ¯åœ‹ç‹',el:'æ°´',up:'æƒ…æ„Ÿæˆç†Ÿï¼Œæ…·æ…¨æ™ºæ…§ã€‚',rv:'æƒ…æ„Ÿå£“æŠ‘ï¼Œæ“æ§ã€‚'},
  // å¯¶åŠ
  {id:50,n:'å¯¶åŠç‹ç‰Œ',el:'é¢¨',up:'çœŸç›¸èˆ‡çªç ´ï¼Œæ–°æƒ³æ³•ã€‚',rv:'æ··äº‚æ€ç·’ï¼ŒéŒ¯èª¤åˆ¤æ–·ã€‚'},
  {id:51,n:'å¯¶åŠäºŒ',el:'é¢¨',up:'æŠ‰æ“‡å›°é›£ï¼Œéœ€å¹³è¡¡æ€è€ƒã€‚',rv:'è³‡è¨Šéè¼‰ï¼Œé€ƒé¿æ±ºå®šã€‚'},
  {id:52,n:'å¯¶åŠä¸‰',el:'é¢¨',up:'å¿ƒç¢ï¼Œæ‚²ç—›ï¼Œéœ€è¦ç™‚ç™’ã€‚',rv:'èµ°å‡ºå‚·ç—›ï¼Œé–‹å§‹å¾©åŸã€‚'},
  {id:53,n:'å¯¶åŠå››',el:'é¢¨',up:'ä¼‘æ¯æ¢å¾©ï¼Œéœé¤Šã€‚',rv:'ç„¦èºä¸å®‰ï¼Œä¸é¡˜ä¼‘æ¯ã€‚'},
  {id:54,n:'å¯¶åŠäº”',el:'é¢¨',up:'è¡çªèˆ‡å¤±æ•—ï¼Œè‡ªç§è¡Œç‚ºã€‚',rv:'å’Œè§£ï¼Œå­¸æœƒèªè¼¸ã€‚'},
  {id:55,n:'å¯¶åŠå…­',el:'é¢¨',up:'é›¢é–‹å›°å¢ƒï¼Œéæ¸¡æœŸã€‚',rv:'å›°ä½ï¼Œç„¡æ³•é›¢é–‹ã€‚'},
  {id:56,n:'å¯¶åŠä¸ƒ',el:'é¢¨',up:'ç­–ç•¥è¡Œå‹•ï¼Œä½†éœ€æ³¨æ„æ¬ºé¨™ã€‚',rv:'çœŸç›¸æ­éœ²ï¼Œè‰¯å¿ƒä¸å®‰ã€‚'},
  {id:57,n:'å¯¶åŠå…«',el:'é¢¨',up:'è‡ªæˆ‘é™åˆ¶ï¼Œå›°å¢ƒæ˜¯å¿ƒé€ ã€‚',rv:'è§£è„«æŸç¸›ï¼Œçœ‹æ¸…çœŸç›¸ã€‚'},
  {id:58,n:'å¯¶åŠä¹',el:'é¢¨',up:'ç„¦æ…®ã€ææ‡¼ã€å¤±çœ ã€‚',rv:'é¢å°ææ‡¼ï¼Œèµ°å‡ºç„¦æ…®ã€‚'},
  {id:59,n:'å¯¶åŠå',el:'é¢¨',up:'çµæŸèˆ‡æ”¾ä¸‹ï¼Œè§¸åº•åå½ˆã€‚',rv:'æœ€å£å·²éï¼Œé–‹å§‹æ¢å¾©ã€‚'},
  {id:60,n:'å¯¶åŠä¾è€…',el:'é¢¨',up:'å¥½å¥‡å¿ƒï¼Œæ–°æƒ³æ³•ã€‚',rv:'å…«å¦ï¼Œå†·æ¼ ã€‚'},
  {id:61,n:'å¯¶åŠé¨å£«',el:'é¢¨',up:'æ€è·¯æ¸…æ™°ï¼Œå¿«é€Ÿè¡Œå‹•ã€‚',rv:'è¡å‹•ç™¼è¨€ï¼Œç¼ºä¹åŒç†ã€‚'},
  {id:62,n:'å¯¶åŠçš‡å',el:'é¢¨',up:'ç¨ç«‹æ€è€ƒï¼ŒçœŸç›¸ã€‚',rv:'å†·é…·ï¼Œéæ–¼ç†æ€§ã€‚'},
  {id:63,n:'å¯¶åŠåœ‹ç‹',el:'é¢¨',up:'ç†æ€§æ¬Šå¨ï¼Œå…¬æ­£åˆ¤æ–·ã€‚',rv:'ç¨è£ï¼Œå†·é…·ç„¡æƒ…ã€‚'},
  // é‡‘å¹£
  {id:64,n:'é‡‘å¹£ç‹ç‰Œ',el:'åœŸ',up:'æ–°è²¡å‹™æ©Ÿæœƒï¼Œç‰©è³ªè±ç››ã€‚',rv:'éŒ¯å¤±è‰¯æ©Ÿï¼Œè²ªå©ªã€‚'},
  {id:65,n:'é‡‘å¹£äºŒ',el:'åœŸ',up:'å¹³è¡¡ï¼Œé©æ‡‰è®ŠåŒ–ã€‚',rv:'å¤±è¡¡ï¼Œå„ªå…ˆé †åºæ··äº‚ã€‚'},
  {id:66,n:'é‡‘å¹£ä¸‰',el:'åœŸ',up:'åœ˜éšŠåˆä½œï¼ŒæŠ€èƒ½æå‡ã€‚',rv:'ç¼ºä¹å”ä½œï¼Œå“è³ªä¸ä½³ã€‚'},
  {id:67,n:'é‡‘å¹£å››',el:'åœŸ',up:'å®ˆè²¡ï¼Œå®‰å…¨æ„Ÿã€‚',rv:'éåº¦åå—‡ï¼Œææ‡¼å¤±å»ã€‚'},
  {id:68,n:'é‡‘å¹£äº”',el:'åœŸ',up:'å›°é›£æ™‚æœŸï¼Œç‰©è³ªåŒ±ä¹ã€‚',rv:'èµ°å‡ºå›°å¢ƒï¼Œæ´åŠ©åˆ°ä¾†ã€‚'},
  {id:69,n:'é‡‘å¹£å…­',el:'åœŸ',up:'æ…·æ…¨ï¼Œæ–½èˆ‡å—çš„å¹³è¡¡ã€‚',rv:'å‚µå‹™ï¼Œå–®æ–¹é¢ä»˜å‡ºã€‚'},
  {id:70,n:'é‡‘å¹£ä¸ƒ',el:'åœŸ',up:'è€å¿ƒç­‰å¾…æ”¶ç©«ã€‚',rv:'æ€¥èºï¼Œç¼ºä¹è€å¿ƒã€‚'},
  {id:71,n:'é‡‘å¹£å…«',el:'åœŸ',up:'ç²¾é€²æŠ€è—ï¼Œå°ˆæ³¨æŠ•å…¥ã€‚',rv:'ç¼ºä¹ç†±æƒ…ï¼Œæ•·è¡äº†äº‹ã€‚'},
  {id:72,n:'é‡‘å¹£ä¹',el:'åœŸ',up:'è±æ”¶ï¼Œè‡ªçµ¦è‡ªè¶³ã€‚',rv:'éåº¦è‡ªè¶³ï¼Œè²¡å‹™é¢¨éšªã€‚'},
  {id:73,n:'é‡‘å¹£å',el:'åœŸ',up:'å®¶æ—è²¡å¯Œï¼Œé•·ä¹…ç©©å®šã€‚',rv:'å®¶åº­è²¡å‹™å•é¡Œã€‚'},
  {id:74,n:'é‡‘å¹£ä¾è€…',el:'åœŸ',up:'å­¸ç¿’æ©Ÿæœƒï¼Œå‹™å¯¦ç›®æ¨™ã€‚',rv:'ç¼ºä¹æ–¹å‘ï¼Œæµªè²»è³‡æºã€‚'},
  {id:75,n:'é‡‘å¹£é¨å£«',el:'åœŸ',up:'ç©©å¥å‰é€²ï¼Œæœ‰æ•ˆç‡ã€‚',rv:'å›ºåŸ·ï¼Œéåº¦ä¿å®ˆã€‚'},
  {id:76,n:'é‡‘å¹£çš‡å',el:'åœŸ',up:'å¯Œè¶³ï¼Œå®‰å…¨ï¼Œå¯¦éš›ã€‚',rv:'ä¸å®‰å…¨æ„Ÿï¼Œéåº¦ç‰©è³ªã€‚'},
  {id:77,n:'é‡‘å¹£åœ‹ç‹',el:'åœŸ',up:'è²¡å‹™æˆåŠŸï¼Œé ˜å°åŠ›ã€‚',rv:'è²ªå©ªï¼Œéåº¦æ§åˆ¶ã€‚'}
];

const CELTIC_POS=['æ ¸å¿ƒç¾ç‹€','é˜»ç¤™å› ç´ ','éå»åŸºç¤','æœªä¾†ç™¼å±•','å¯èƒ½çµæœ','è¿‘æœŸæœªä¾†','è‡ªæˆ‘æ…‹åº¦','ç’°å¢ƒå½±éŸ¿','å¸Œæœ›ææ‡¼','æœ€çµ‚çµæœ'];

let drawnCards=[];
function drawCard(){
  if(drawnCards.length>=10)return;
  const avail=TAROT.filter(c=>!drawnCards.find(d=>d.id===c.id));
  const card=avail[Math.floor(Math.random()*avail.length)];
  const isUp=Math.random()>0.35;
  drawnCards.push({...card,isUp,pos:CELTIC_POS[drawnCards.length]});
  renderDrawn();
  if(drawnCards.length>=10){
    document.getElementById('btn-draw').disabled=true;
    document.getElementById('btn-analyze').disabled=false;
    showSpread();
  }
}
function autoDraw(){while(drawnCards.length<10)drawCard()}

function renderDrawn(){
  const el=document.getElementById('t-hand');
  document.getElementById('t-remain').textContent=10-drawnCards.length;
  el.innerHTML=drawnCards.map((c,i)=>`
    <div class="t-card flipped" title="${c.n}">
      <div class="t-card-inner">
        <div class="t-card-face t-back"></div>
        <div class="t-card-face t-front ${c.isUp?'':''}">
          <span class="tc-name" style="${c.isUp?'':'transform:rotate(180deg)'}">${c.n}</span>
          <span class="tc-dir">${c.isUp?'æ­£ä½':'é€†ä½'}</span>
        </div>
      </div>
    </div>`).join('');
}

function showSpread(){
  S.tarot.drawn=drawnCards;
  S.tarot.spread=drawnCards;
  document.getElementById('t-spread-sec').classList.remove('hidden');
  const el=document.getElementById('t-spread');
  el.innerHTML=drawnCards.map((c,i)=>`
    <div class="card" style="padding:var(--sp-md);margin-bottom:var(--sp-sm)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-xs)">
        <span class="tag tag-gold">${i+1}. ${c.pos}</span>
        <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'æ­£ä½':'é€†ä½'}</span>
      </div>
      <strong class="text-gold serif">${c.n}</strong>
      <p class="text-sm text-dim mt-sm">${c.isUp?c.up:c.rv}</p>
    </div>`).join('');
}
/* =============================================================
   RENDER FUNCTIONS â€” çµæœé æ¸²æŸ“
   ============================================================= */
function showDim(id){
  const map={bazi:'å…«å­—',ziwei:'ç´«å¾®',meihua:'æ¢…èŠ±',tarot:'å¡”ç¾…',name:'å§“å'};
  document.querySelectorAll('.dim-tab').forEach(t=>{
    const match=Object.entries(map).find(([k,v])=>t.textContent.includes(v));
    t.classList.toggle('active',match&&match[0]===id);
  });
  document.querySelectorAll('.dim-pane').forEach(p=>p.classList.toggle('active',p.id==='pane-'+id));
}

function renderBazi(){
  const b=S.bazi; if(!b)return;
  const p=b.pillars;
  const labels=['æ™‚æŸ±','æ—¥æŸ±','æœˆæŸ±','å¹´æŸ±'];
  const cols=['hour','day','month','year'];

  // å››æŸ±è¡¨æ ¼
  let html='<div class="bazi-grid">';
  html+=cols.map((_,i)=>`<div class="bazi-cell header">${labels[i]}</div>`).join('');
  // å¤©å¹²è¡Œ
  html+=cols.map(c=>{
    const g=p[c].gan;
    return`<div class="bazi-cell"><span class="gz">${g}</span><span class="el-tag el-${WX_G[g]}">${WX_G[g]}</span><div class="gz-sub">${c==='day'?'æ—¥ä¸»':b.gods[c].gan}</div></div>`;
  }).join('');
  // åœ°æ”¯è¡Œ
  html+=cols.map(c=>{
    const z=p[c].zhi;
    return`<div class="bazi-cell"><span class="gz">${z}</span><span class="el-tag el-${WX_Z[z]}">${WX_Z[z]}</span><div class="gz-sub">${b.cs[c]}</div></div>`;
  }).join('');
  // è—å¹²è¡Œ
  html+=cols.map(c=>{
    const cg=b.cangGan[c]||[];
    return`<div class="bazi-cell"><div class="gz-sub">è—å¹²</div>${cg.map(g=>`<span class="el-tag el-${WX_G[g]}" style="margin:1px">${g}</span>`).join('')}</div>`;
  }).join('');
  html+='</div>';

  // ç´éŸ³
  html+=`<p class="text-sm text-dim mt-sm">ç´éŸ³ï¼š${b.nayin} ï½œ èº«${b.strong?'<span class="text-success">å¼·</span>':'<span class="text-danger">å¼±</span>'} ï½œ æ—¥ä¸»ï¼š${b.dm}ï¼ˆ${b.dmEl}ï¼‰</p>`;
  document.getElementById('d-bazi').innerHTML=html;

  // äº”è¡ŒæŸ±ç‹€åœ–
  const els=['é‡‘','æœ¨','æ°´','ç«','åœŸ'];
  const colors={é‡‘:'var(--el-metal)',æœ¨:'var(--el-wood)',æ°´:'var(--el-water)',ç«:'var(--el-fire)',åœŸ:'var(--el-earth)'};
  document.getElementById('d-elbar').innerHTML='<div class="el-bar">'+els.map(e=>`
    <div class="el-row"><span class="el-lbl" style="color:${colors[e]}">${e}</span>
    <div class="el-track"><div class="el-fill" style="width:${b.ep[e]}%;background:${colors[e]}"></div></div>
    <span class="el-val">${b.ep[e]}%</span></div>`).join('')+'</div>';

  // åç¥
  document.getElementById('d-gods').innerHTML=`
    <div class="bazi-grid" style="margin:0">
      ${cols.map((_,i)=>`<div class="bazi-cell header">${labels[i]}</div>`).join('')}
      ${cols.map(c=>`<div class="bazi-cell"><strong>${b.gods[c].gan}</strong></div>`).join('')}
      ${cols.map(c=>`<div class="bazi-cell">${(b.gods[c].zhi||[]).join('<br>')}</div>`).join('')}
    </div>`;

  // è—å¹²
  document.getElementById('d-canggan').innerHTML=cols.map(c=>{
    const cg=b.cangGan[c]||[];
    return`<p><strong>${labels[cols.indexOf(c)]}ï¼ˆ${p[c].zhi}ï¼‰ï¼š</strong>${cg.map(g=>`${g}(${WX_G[g]}/${tenGod(b.dm,g)})`).join('ã€')||'â€”'}</p>`;
  }).join('');

  // å–œç”¨å¿Œç¥ + ç¥ç…
  document.getElementById('d-xiyong').innerHTML=`
    <p><strong>å–œç”¨ç¥ï¼š</strong>${b.fav.map(e=>`<span class="tag tag-green">${e}</span>`).join(' ')}</p>
    <p class="mt-sm"><strong>å¿Œã€€ç¥ï¼š</strong>${b.unfav.map(e=>`<span class="tag tag-red">${e}</span>`).join(' ')}</p>
    ${b.shensha.length?`<p class="mt-sm"><strong>ç¥ã€€ç…ï¼š</strong>${b.shensha.map(s=>`<span class="tag tag-gold">${s}</span>`).join(' ')}</p>`:''}`;

  // å¤§é‹
  document.getElementById('d-dayun').innerHTML='<div class="dayun-tl">'+b.dayun.map(d=>{
    const lvClass=d.level==='å¤§å‰'?'lv-dj':d.level==='ä¸­å‰'?'lv-zj':d.level==='å°å‰'?'lv-xj':d.level==='å¹³'?'lv-p':d.level==='å°å‡¶'?'lv-xk':d.level==='ä¸­å‡¶'?'lv-zk':'lv-dk';
    return`<div class="dy-item ${d.isCurrent?'current':''}">
      <span class="dy-gz">${d.gz}</span><span class="dy-age">${d.ageStart}-${d.ageEnd}æ­²</span>
      <span class="dy-lv ${lvClass}">${d.level}</span><div class="gz-sub">${d.god}</div></div>`;
  }).join('')+'</div>';
}

function renderMeihua(){
  if(!S.meihua){document.getElementById('r-meihua').innerHTML='<p class="text-dim">æœªé€²è¡Œæ¢…èŠ±æ˜“æ•¸èµ·å¦</p>';return}
  const r=S.meihua;
  document.getElementById('r-meihua').innerHTML=`
    <div class="hex-grid">
      <div class="hex-card"><h4>æœ¬å¦</h4><div class="hex-sym">${r.ben.u}</div><div class="hex-name">${r.ben.n}</div></div>
      <div class="hex-card"><h4>äº’å¦</h4><div class="hex-sym">${r.hu.u}</div><div class="hex-name">${r.hu.n}</div></div>
      <div class="hex-card"><h4>è®Šå¦</h4><div class="hex-sym">${r.bian.u}</div><div class="hex-name">${r.bian.n}</div></div>
    </div>
    <p class="mt-md"><strong>é«”ç”¨ï¼š</strong><span class="tag tag-gold">${r.ty.r}</span> <span class="tag ${r.ty.f.includes('å‰')?'tag-green':'tag-red'}">${r.ty.f}</span> â€” ${r.ty.d}</p>
    <p class="mt-sm"><strong>å¦è¾­ï¼š</strong>${r.ben.j}</p>
    <p><strong>è§£è®€ï¼š</strong>${r.ben.m}</p>
    <p><strong>è®Šå¦ï¼š</strong>${r.bian.m}</p>`;
}

function renderTarot(){
  if(!S.tarot.drawn.length){document.getElementById('r-tarot').innerHTML='<p class="text-dim">æœªé€²è¡Œå¡”ç¾…æŠ½ç‰Œ</p>';return}
  document.getElementById('r-tarot').innerHTML=S.tarot.drawn.map((c,i)=>`
    <div style="display:flex;gap:var(--sp-sm);align-items:flex-start;padding:var(--sp-sm) 0;border-bottom:1px solid var(--c-border)">
      <span class="tag tag-gold" style="flex:0 0 auto">${i+1}</span>
      <div><strong class="text-gold">${c.pos}</strong>ï¼š${c.n} <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'æ­£':'é€†'}</span>
      <p class="text-sm text-dim">${c.isUp?c.up:c.rv}</p></div>
    </div>`).join('');
}

/* =============================================================
   ANALYSIS ENGINE â€” ç¶œåˆè©•åˆ†
   ============================================================= */
function _runAnalysisV1_unused(){
  renderBazi(); renderMeihua(); renderTarot();

  const b=S.bazi; if(!b)return;
  const type=S.form.type;
  const question=S.form.question;

  // â€” å…«å­—è©•åˆ† (0-100) â€”
  let baziScore=50;
  // èº«å¼·+æœ‰è²¡å®˜ = é«˜åˆ†ï¼›èº«å¼±+æœ‰å°æ¯” = ä¸­åˆ†
  if(b.strong){
    if(b.ep[KE[b.dmEl]]>15)baziScore+=15; // æœ‰è²¡
    if(b.ep[BE_KE[b.dmEl]]>10)baziScore+=10; // æœ‰å®˜
  }else{
    if(b.ep[BE_SHENG[b.dmEl]]>15)baziScore+=15; // æœ‰å°
    if(b.ep[b.dmEl]>15)baziScore+=10;
  }
  // ç•¶å‰å¤§é‹åŠ åˆ†
  const curDy=b.dayun.find(d=>d.isCurrent);
  if(curDy){
    if(curDy.level.includes('å‰'))baziScore+=10;
    if(curDy.level.includes('å‡¶'))baziScore-=10;
  }
  // ç¥ç…
  if(b.shensha.includes('å¤©ä¹™è²´äºº'))baziScore+=5;
  if(b.shensha.includes('æ–‡æ˜Œ'))baziScore+=3;
  baziScore=Math.max(10,Math.min(90,baziScore));

  // â€” æ¢…èŠ±è©•åˆ† â€”
  let mhScore=50;
  if(S.meihua){
    const f=S.meihua.ty.f;
    if(f==='å¤§å‰')mhScore=80;
    else if(f==='å‰')mhScore=70;
    else if(f==='å°å‰')mhScore=60;
    else if(f==='å°å‡¶')mhScore=35;
    else if(f==='å‡¶')mhScore=20;
  }

  // â€” å¡”ç¾…è©•åˆ† â€”
  let tarotScore=50;
  if(S.tarot.drawn.length){
    let pos=0,neg=0;
    S.tarot.drawn.forEach(c=>{
      // æ­£ä½çš„æ­£é¢ç‰Œ +1ï¼Œé€†ä½çš„è² é¢ç‰Œ -1
      const goodCards=[0,1,3,6,8,10,14,17,19,21];
      const badCards=[13,15,16,18];
      if(c.isUp&&goodCards.includes(c.id))pos++;
      if(!c.isUp&&badCards.includes(c.id))neg++;
      if(c.isUp&&!badCards.includes(c.id))pos+=0.5;
      if(!c.isUp)neg+=0.3;
    });
    tarotScore=Math.round(50+pos*5-neg*5);
    tarotScore=Math.max(10,Math.min(90,tarotScore));
  }

  // â€” ç¶œåˆ â€”
  const weights={bazi:0.4,meihua:S.meihua?0.3:0,tarot:S.tarot.drawn.length?0.3:0};
  const totalW=weights.bazi+weights.meihua+weights.tarot;
  const finalProb=Math.round((baziScore*weights.bazi+mhScore*weights.meihua+tarotScore*weights.tarot)/totalW);

  // Verdict
  let vlabel,vnote;
  if(finalProb>=70){vlabel='åå‘å¯è¡Œ âœ…';vnote='å¤šç¶­åº¦æŒ‡æ¨™åä¸€è‡´ï¼Œé©åˆæ¨é€²ï¼Œä½†ä»éœ€æŒ‰å»ºè­°æ§é¢¨éšªã€‚'}
  else if(finalProb>=45){vlabel='ä¸­æ€§åå¯è¡Œ âš–ï¸';vnote='æœ‰åˆ©èˆ‡é˜»åŠ›ä¸¦å­˜ï¼›ç…§å»ºè­°èª¿æ•´åšæ³•ï¼Œå‹ç‡æœƒä¸Šå‡ã€‚'}
  else if(finalProb>=25){vlabel='åä¿å®ˆ âš ï¸';vnote='é˜»åŠ›è¨Šè™Ÿè¼ƒå¤šï¼Œå»ºè­°å…ˆé™ä½æˆæœ¬/è©¦æ°´æº«ï¼Œå†è«‡æ”¾å¤§ã€‚'}
  else{vlabel='ä¸å»ºè­°ç¡¬æ¨ â›”';vnote='ç›®å‰è±¡å¾µåé€†é¢¨ï¼›è‹¥è¦åšï¼Œå‹™å¿…è¨­åœæèˆ‡æ›¿ä»£æ–¹æ¡ˆã€‚'}

  document.getElementById('r-vlabel').textContent=vlabel;
  document.getElementById('r-vprob').textContent=finalProb+'%';
  document.getElementById('r-vnote').textContent=vnote;
  document.getElementById('r-pfill').style.width=finalProb+'%';
  document.getElementById('r-question').innerHTML=`<strong>å•é¡Œï¼š</strong>${question}<br><span class="tag tag-gold">${getTypeLabel(type)}</span>`;

  // Direct answer
  const answer=generateAnswer(type,finalProb,b,S.meihua,S.tarot);
  document.getElementById('r-answer').innerHTML=answer.text;
  document.getElementById('r-factors').innerHTML=answer.factors?`<h4 class="text-gold serif mt-md mb-sm">å½±éŸ¿å› å­</h4><ul class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.factors.map(f=>'<li style="margin:.3rem 0">'+f+'</li>').join('')}</ul>`:'';
  document.getElementById('r-suggest').innerHTML=answer.suggestions?`<h4 class="text-gold serif mt-md mb-sm">è¡Œå‹•å»ºè­°</h4><ol class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.suggestions.map(s=>'<li style="margin:.3rem 0">'+s+'</li>').join('')}</ol>`:'';

  // Probability breakdown
  document.getElementById('r-pbreak').innerHTML=`
    <p>å…«å­—å‘½ç†ï¼š${baziScore}% (æ¬Šé‡${Math.round(weights.bazi/totalW*100)}%)</p>
    ${S.meihua?`<p>æ¢…èŠ±æ˜“æ•¸ï¼š${mhScore}% (æ¬Šé‡${Math.round(weights.meihua/totalW*100)}%)</p>`:''}
    ${S.tarot.drawn.length?`<p>å¡”ç¾…ç‰Œé™£ï¼š${tarotScore}% (æ¬Šé‡${Math.round(weights.tarot/totalW*100)}%)</p>`:''}`;

  // Crystal recommendation
  renderCrystal(b);

  // Conclusion
  document.getElementById('r-conclusion').innerHTML=generateConclusion(type,finalProb,b,S.meihua,S.tarot);
}

function getTypeLabel(t){return{love:'æ„›æƒ…',career:'äº‹æ¥­',wealth:'è²¡é‹',health:'å¥åº·',general:'ç¶œåˆé‹å‹¢',relationship:'äººéš›',family:'å®¶åº­',other:'å…¶ä»–'}[t]||t}

function generateAnswer(type,prob,bazi,mh,tarot){
  const dm=bazi.dm,el=bazi.dmEl,strong=bazi.strong;
  const curDy=bazi.dayun.find(d=>d.isCurrent);
  const dyInfo=curDy?`ç•¶å‰å¤§é‹${curDy.gz}ï¼ˆ${curDy.level}ï¼‰`:'';
  const mhInfo=mh?`æ¢…èŠ±é«”ç”¨${mh.ty.r}ï¼ˆ${mh.ty.f}ï¼‰`:'';

  const factors=[];
  factors.push(`æ—¥ä¸»${dm}ï¼ˆ${el}ï¼‰ï¼Œèº«${strong?'å¼·':'å¼±'}ï¼Œå–œç”¨${bazi.fav.join('ã€')}`);
  if(dyInfo)factors.push(dyInfo);
  if(mhInfo)factors.push(mhInfo);
  if(bazi.shensha.length)factors.push('ç¥ç…ï¼š'+bazi.shensha.join('ã€'));
  if(tarot.drawn.length){
    const key=tarot.drawn[0];
    factors.push(`æ ¸å¿ƒç‰Œï¼š${key.n}ï¼ˆ${key.isUp?'æ­£ä½':'é€†ä½'}ï¼‰`);
  }

  const suggestions=[];
  if(strong){
    suggestions.push(`èº«å¼·å®œæ´©ç§€ï¼šå¤šç™¼æ®${SHENG[el]}è¡Œèƒ½é‡ï¼ˆé£Ÿå‚·ç”Ÿè²¡è·¯ç·šï¼‰`);
    suggestions.push(`ç©¿æˆ´${bazi.fav[0]}è¡Œé¡è‰²/é£¾å“ï¼Œå¼•å°å¤šé¤˜èƒ½é‡`);
  }else{
    suggestions.push(`èº«å¼±å®œæ‰¶åŠ©ï¼šåŠ å¼·${el}èˆ‡${BE_SHENG[el]}è¡Œèƒ½é‡`);
    suggestions.push(`ä½©æˆ´${bazi.fav[0]}è¡Œæ°´æ™¶æˆ–é£¾å“å¢å¼·è‡ªèº«èƒ½é‡`);
  }
  if(type==='love')suggestions.push('æ¡ƒèŠ±æ–¹ä½åœ¨æ­£'+(bazi.shensha.includes('æ¡ƒèŠ±')?'æ¡ƒèŠ±å·²å‹•ï¼Œç•™æ„èº«é‚Šäºº':'æ±/å—æ–¹ï¼Œå¯å¤šå¾€è©²æ–¹å‘ç¤¾äº¤'));
  if(type==='career')suggestions.push('äº‹æ¥­å®œå¾€'+(strong?'é£Ÿå‚·ç”Ÿè²¡æ–¹å‘ç™¼å±•ï¼Œé©åˆå‰µæ¥­æˆ–è‡ªç”±æ¥­':'å°æ˜Ÿæ–¹å‘ç™¼å±•ï¼Œå®œè€ƒå–è­‰ç…§æˆ–ä¾é™„å¤§æ©Ÿæ§‹'));
  if(type==='wealth')suggestions.push('è²¡é‹'+(bazi.ep[KE[el]]>15?'å‘½ä¸­è²¡æ˜Ÿæ—ºï¼Œåè²¡é‹ä½³':'å‘½ä¸­è²¡æ˜Ÿå¼±ï¼Œå®œç©©å¥æŠ•è³‡'));

  let text;
  if(prob>=65) text=`<p>ç¶œåˆå¤šç¶­åº¦åˆ†æï¼Œä½ æ‰€å•ä¹‹äº‹<strong class="text-success">è¶¨å‹¢åå‘æœ‰åˆ©</strong>ã€‚${dyInfo?dyInfo+'ç‚ºä½ æä¾›åŠ©åŠ›ã€‚':''}${mhInfo?mhInfo+'äº¦æ”¯æŒæ­£é¢ç™¼å±•ã€‚':''}</p><p class="mt-sm">å»ºè­°æŠŠæ¡ç•¶ä¸‹æ™‚æ©Ÿï¼Œç©æ¥µè¡Œå‹•ï¼Œä½†ä»éœ€æ³¨æ„æ§åˆ¶é¢¨éšªã€‚</p>`;
  else if(prob>=40) text=`<p>ç¶œåˆåˆ†æé¡¯ç¤ºï¼Œä½ æ‰€å•ä¹‹äº‹<strong class="text-warn">åˆ©å¼ŠåƒåŠ</strong>ã€‚${dyInfo?dyInfo+'ï¼Œ':''} æœ‰ç™¼å±•ç©ºé–“ä½†ä¹Ÿå­˜åœ¨é˜»åŠ›ã€‚</p><p class="mt-sm">å»ºè­°å¾ªåºæ¼¸é€²ï¼Œå…ˆå°ç¯„åœå˜—è©¦ï¼Œè§€å¯Ÿåé¥‹å¾Œå†æ“´å¤§ã€‚</p>`;
  else text=`<p>å¤šç¶­åº¦åˆ†æé¡¯ç¤ºï¼Œç›®å‰<strong class="text-danger">æ™‚æ©Ÿå°šæœªæˆç†Ÿ</strong>ã€‚${dyInfo?dyInfo+'ï¼Œ':''}é˜»åŠ›è¼ƒå¤§ã€‚</p><p class="mt-sm">å»ºè­°æš«ç·©è¡Œå‹•ï¼Œå…ˆåšå¥½æº–å‚™åŠŸå¤«ï¼Œç­‰å¾…æ›´ä½³æ™‚æ©Ÿã€‚</p>`;

  return{text,factors,suggestions};
}

function renderCrystal(b){
  const CRYSTALS={
    é‡‘:[{n:'ç™½æ°´æ™¶',icon:'ğŸ’',d:'æ·¨åŒ–èƒ½é‡ï¼Œå¢å¼·æ€ç¶­æ¸…æ™°åº¦'},{n:'é»ƒéµç¤¦',icon:'âœ¨',d:'å¢å¼·è²¡é‹ï¼Œæå‡è‡ªä¿¡'}],
    æœ¨:[{n:'ç¶ å¹½éˆ',icon:'ğŸ’š',d:'æ‹›æ­£è²¡ï¼Œäº‹æ¥­ç©©æ­¥ä¸Šå‡'},{n:'æ±é™µç‰',icon:'ğŸŒ¿',d:'èˆ’ç·©å£“åŠ›ï¼Œå¸¶ä¾†å¥½é‹'}],
    æ°´:[{n:'æµ·è—å¯¶',icon:'ğŸ’™',d:'å¢å¼·æºé€šåŠ›ï¼Œå¹³éœæƒ…ç·’'},{n:'è—ç´‹ç‘ªç‘™',icon:'ğŸ”µ',d:'ç©©å®šæƒ…ç·’ï¼Œå¢å¼·è¡¨é”'}],
    ç«:[{n:'ç´…ç‘ªç‘™',icon:'â¤ï¸',d:'æ¿€ç™¼ç†±æƒ…ï¼Œå¢å¼·è¡Œå‹•åŠ›'},{n:'çŸ³æ¦´çŸ³',icon:'ğŸ”´',d:'æå‡æ´»åŠ›ï¼Œå¢å¼·æ„å¿—'}],
    åœŸ:[{n:'é»ƒæ°´æ™¶',icon:'ğŸ’›',d:'æ‹›åè²¡ï¼Œæå‡è‡ªä¿¡'},{n:'è™çœ¼çŸ³',icon:'ğŸŸ¤',d:'å¢å¼·æ±ºæ–·åŠ›ï¼Œæ‹›è²¡è¾Ÿé‚ª'}]
  };
  const need=b.fav[0];
  const recs=CRYSTALS[need]||CRYSTALS['åœŸ'];
  document.getElementById('r-crystal').innerHTML=`
    <p class="mb-md">æ ¹æ“šå‘½ç›¤åˆ†æï¼Œå»ºè­°è£œå¼· <span class="tag tag-gold">${need}è¡Œ</span> èƒ½é‡ï¼š</p>
    <div class="crystal-grid">${recs.map(c=>`
      <div class="crystal-card">
        <div class="crystal-icon">${c.icon}</div>
        <div class="crystal-name">${c.n}</div>
        <p class="text-sm text-dim">${c.d}</p>
      </div>`).join('')}</div>
    <p class="text-xs text-muted mt-md"><i class="fas fa-info-circle"></i> æœ¬å»ºè­°åƒ…ä¾›èƒ½é‡æ ¡æº–åƒè€ƒï¼Œä¸å…·é†«ç™‚æˆ–å‘½é‹ä¿è­‰æ•ˆåŠ›ã€‚</p>`;
}

function generateConclusion(type,prob,bazi,mh,tarot){
  const el=bazi.dmEl,strong=bazi.strong;
  const curDy=bazi.dayun.find(d=>d.isCurrent);
  let html=`<p>ã€Œ${bazi.dm}${bazi.pillars.day.zhi}ã€æ—¥ä¸»ï¼Œäº”è¡Œå±¬${el}ï¼Œèº«${strong?'å¼·':'å¼±'}ã€‚`;
  if(curDy)html+=`ç•¶å‰è¡Œ${curDy.gz}å¤§é‹ï¼ˆ${curDy.level}ï¼‰ï¼Œ${curDy.level.includes('å‰')?'é‹å‹¢åŠ©åŠ›æ˜é¡¯':'éœ€è¬¹æ…æ‡‰å°æŒ‘æˆ°'}ã€‚`;
  html+=`</p>`;
  if(mh)html+=`<p class="mt-sm">æ¢…èŠ±æ˜“æ•¸å¾—${mh.ben.n}ï¼Œé«”ç”¨${mh.ty.r}ï¼Œ${mh.ty.d}</p>`;
  if(tarot.drawn.length){
    const first=tarot.drawn[0],last=tarot.drawn[9];
    html+=`<p class="mt-sm">å¡”ç¾…æ ¸å¿ƒç‰Œã€Œ${first.n}ã€${first.isUp?'æ­£ä½':'é€†ä½'}ï¼Œæœ€çµ‚ç‰Œã€Œ${last?last.n:''}ã€${last?(last.isUp?'æ­£ä½':'é€†ä½'):''}ï¼Œ`;
    html+=prob>=50?'æ•´é«”ç‰Œé¢åå‘ç©æ¥µã€‚':'æ•´é«”ç‰Œé¢æç¤ºéœ€è¦æ›´å¤šæº–å‚™ã€‚';
    html+=`</p>`;
  }
  html+=`<div class="divider"></div>`;
  html+=`<p class="serif text-gold">ç¶œåˆå»ºè­°ï¼š${prob>=60?'æŠŠæ¡æ©Ÿæœƒï¼Œç©æ¥µè¡Œå‹•ï¼Œé †å‹¢è€Œç‚ºã€‚':prob>=40?'ç©©ä¸­æ±‚é€²ï¼Œå¾ªåºæ¼¸é€²ï¼Œæ³¨æ„ç¯€å¥ã€‚':'éŸœå…‰é¤Šæ™¦ï¼Œå„²å‚™èƒ½é‡ï¼Œéœå¾…èŠ±é–‹ã€‚'}</p>`;
  return html;
}
/* =============================================================
   ç´«å¾®æ–—æ•¸ ZIWEI DOUSHU â€” æ ¸å¿ƒé‚è¼¯ï¼ˆè‡ªå¯«ï¼Œä¸ä¾è³´ iztroï¼‰
   ============================================================= */
const ZW_PALACES=['å‘½å®®','å…„å¼Ÿ','å¤«å¦»','å­å¥³','è²¡å¸›','ç–¾å„','é·ç§»','äº¤å‹','å®˜ç¥¿','ç”°å®…','ç¦å¾·','çˆ¶æ¯'];

// 14 ä¸»æ˜Ÿ
const ZW_MAJOR=[
  {id:0,name:'ç´«å¾®',el:'åœŸ',yin:true,bright:['å»Ÿ','æ—º','å¾—åœ°','åˆ©','å¹³','ä¸å¾—','è½é™·'],nature:'å¸æ˜Ÿï¼Œå°Šè²´ï¼Œé ˜å°åŠ›'},
  {id:1,name:'å¤©æ©Ÿ',el:'æœ¨',yin:true,nature:'æ™ºæ…§ï¼Œç­–åŠƒï¼Œå–„è®Š'},
  {id:2,name:'å¤ªé™½',el:'ç«',yin:false,nature:'å…‰æ˜æ­£å¤§ï¼Œè²´äººï¼Œç”·æ€§'},
  {id:3,name:'æ­¦æ›²',el:'é‡‘',yin:false,nature:'è²¡æ˜Ÿï¼Œå‰›æ¯…ï¼Œæœæ–·'},
  {id:4,name:'å¤©åŒ',el:'æ°´',yin:true,nature:'ç¦æ˜Ÿï¼Œå®‰é€¸ï¼Œæº«å’Œ'},
  {id:5,name:'å»‰è²',el:'ç«',yin:false,nature:'å›šæ˜Ÿï¼Œæ¡ƒèŠ±ï¼Œè¤‡é›œ'},
  {id:6,name:'å¤©åºœ',el:'åœŸ',yin:true,nature:'è²¡åº«ï¼Œç©©é‡ï¼Œä¿å®ˆ'},
  {id:7,name:'å¤ªé™°',el:'æ°´',yin:true,nature:'è²¡æ˜Ÿï¼Œå¥³æ€§ï¼Œç´°è†©'},
  {id:8,name:'è²ªç‹¼',el:'æœ¨',yin:false,nature:'æ¡ƒèŠ±ï¼Œæ‰è—ï¼Œæ…¾æœ›'},
  {id:9,name:'å·¨é–€',el:'æ°´',yin:true,nature:'å£èˆŒï¼Œæš—æ˜Ÿï¼Œæ˜¯é'},
  {id:10,name:'å¤©ç›¸',el:'æ°´',yin:true,nature:'å°æ˜Ÿï¼Œè¼”ä½ï¼Œè¡£é£Ÿ'},
  {id:11,name:'å¤©æ¢',el:'åœŸ',yin:true,nature:'è”­æ˜Ÿï¼Œæ¸…é«˜ï¼ŒåŒ–è§£'},
  {id:12,name:'ä¸ƒæ®º',el:'é‡‘',yin:false,nature:'å°‡æ˜Ÿï¼Œè¡å‹ï¼Œè®Šå‹•'},
  {id:13,name:'ç ´è»',el:'æ°´',yin:false,nature:'è€—æ˜Ÿï¼Œé–‹å‰µï¼Œç ´å£'}
];

// 6 å‰æ˜Ÿ
const ZW_LUCKY=['æ–‡æ˜Œ','æ–‡æ›²','å·¦è¼”','å³å¼¼','å¤©é­','å¤©é‰'];
// 4 ç…æ˜Ÿ
const ZW_SHA=['æ“ç¾Š','é™€ç¾…','ç«æ˜Ÿ','éˆ´æ˜Ÿ'];
// 4 åŒ–
const ZW_HUA=['åŒ–ç¥¿','åŒ–æ¬Š','åŒ–ç§‘','åŒ–å¿Œ'];

// å››åŒ–è¡¨ (ä¾å¹´å¹²)
const SIHUA_TABLE={
  ç”²:{ç¥¿:'å»‰è²',æ¬Š:'ç ´è»',ç§‘:'æ­¦æ›²',å¿Œ:'å¤ªé™½'},
  ä¹™:{ç¥¿:'å¤©æ©Ÿ',æ¬Š:'å¤©æ¢',ç§‘:'ç´«å¾®',å¿Œ:'å¤ªé™°'},
  ä¸™:{ç¥¿:'å¤©åŒ',æ¬Š:'å¤©æ©Ÿ',ç§‘:'æ–‡æ˜Œ',å¿Œ:'å»‰è²'},
  ä¸:{ç¥¿:'å¤ªé™°',æ¬Š:'å¤©åŒ',ç§‘:'å¤©æ©Ÿ',å¿Œ:'å·¨é–€'},
  æˆŠ:{ç¥¿:'è²ªç‹¼',æ¬Š:'å¤ªé™°',ç§‘:'å³å¼¼',å¿Œ:'å¤©æ©Ÿ'},
  å·±:{ç¥¿:'æ­¦æ›²',æ¬Š:'è²ªç‹¼',ç§‘:'å¤©æ¢',å¿Œ:'æ–‡æ›²'},
  åºš:{ç¥¿:'å¤ªé™½',æ¬Š:'æ­¦æ›²',ç§‘:'å¤ªé™°',å¿Œ:'å¤©åŒ'},
  è¾›:{ç¥¿:'å·¨é–€',æ¬Š:'å¤ªé™½',ç§‘:'æ–‡æ›²',å¿Œ:'æ–‡æ˜Œ'},
  å£¬:{ç¥¿:'å¤©æ¢',æ¬Š:'ç´«å¾®',ç§‘:'å·¦è¼”',å¿Œ:'æ­¦æ›²'},
  ç™¸:{ç¥¿:'ç ´è»',æ¬Š:'å·¨é–€',ç§‘:'å¤ªé™°',å¿Œ:'è²ªç‹¼'}
};

// ç´«å¾®æ˜Ÿå®‰æ˜Ÿæ³•ï¼ˆç°¡åŒ–ç‰ˆï¼šä¾è¾²æ›†æ—¥æ±ºå®šç´«å¾®æ‰€åœ¨å®®ä½ï¼‰
function getZiweiPalaceIdx(lunarDay){
  // çœŸå¯¦è¨ˆç®—éœ€è¦äº”è¡Œå±€ï¼Œé€™è£¡ç”¨ç°¡åŒ–æ˜ å°„
  // ç´«å¾®æ˜Ÿä½ç½® = (è¾²æ›†æ—¥æ•¸ - 1) % 12
  return (lunarDay - 1) % 12;
}

// å¤©åºœæ˜Ÿä½ç½®ï¼ˆèˆ‡ç´«å¾®å°ç¨±ï¼‰
function getTianfuIdx(ziweiIdx){
  return (12 - ziweiIdx + 2) % 12; // ç°¡åŒ–å°ç¨±
}

// è¾²æ›†è½‰æ›ï¼ˆç°¡åŒ–ï¼šç”¨åœ°æ”¯æ¨ç®—è¿‘ä¼¼è¾²æ›†æœˆæ—¥ï¼‰
function approxLunar(y,m,d){
  // ç°¡åŒ–ï¼šå– solar æ—¥æ¸›å»è¿‘ä¼¼å€¼
  const lunarMonth = ((m + 10) % 12) + 1; // ç²—ç•¥
  const lunarDay = ((d + 28) % 30) + 1;
  return {month: lunarMonth, day: lunarDay};
}

function computeZiwei(year,month,day,hour,gender){
  const lunar = approxLunar(year,month,day);
  const yGan = TG[((year-4)%10+10)%10];
  const yZhi = DZ[((year-4)%12+12)%12];

  // å‘½å®®åœ°æ”¯ï¼šä»¥æœˆã€æ™‚æ¨ç®—
  // å‘½å®® = (å¯… + æœˆæ•¸ - 1 - æ™‚è¾°) mod 12
  const shi = Math.floor(((hour+1)%24)/2);
  const mingIdx = ((2 + lunar.month - 1 - shi) % 12 + 12) % 12;
  const shenIdx = (mingIdx + 6) % 12; // èº«å®®

  // äº”è¡Œå±€ (ç°¡åŒ–ï¼šä¾å‘½å®®å¤©å¹²åœ°æ”¯çµ„åˆ)
  const mingGanIdx = ((((year-4)%10+10)%10 % 5) * 2 + mingIdx) % 10;
  const mingGan = TG[mingGanIdx];
  const wuxingJu = getWuxingJu(mingGan, DZ[mingIdx]);

  // å®‰ç´«å¾®æ˜Ÿ
  const ziweiIdx = getZiweiPalaceByJu(wuxingJu, lunar.day);
  const tianfuIdx = (12 - ziweiIdx + 4) % 12;

  // å»ºç«‹12å®®
  const palaces = [];
  for(let i=0;i<12;i++){
    const pIdx = (mingIdx + i) % 12;
    palaces.push({
      name: ZW_PALACES[i],
      branch: DZ[pIdx],
      stars: [],
      isMing: i===0,
      isShen: pIdx === shenIdx
    });
  }

  // å®‰14ä¸»æ˜Ÿï¼ˆç°¡åŒ–æ’åˆ—ï¼‰
  const ziweiOrder = [0,1,null,2,3,4,5]; // ç´«å¾®ç³»
  const tianfuOrder = [6,7,8,9,10,11,12,13]; // å¤©åºœç³»

  // ç´«å¾®ç³»å®‰æ˜Ÿ
  const zwStarMap = [
    {star:0, offset:0},  // ç´«å¾®
    {star:1, offset:-1}, // å¤©æ©Ÿ
    {star:2, offset:-3}, // å¤ªé™½
    {star:3, offset:-4}, // æ­¦æ›²
    {star:4, offset:-5}, // å¤©åŒ
    {star:5, offset:1}   // å»‰è²ï¼ˆåœ¨ç´«å¾®å¾Œä¸€ä½ï¼‰
  ];
  zwStarMap.forEach(({star,offset})=>{
    const pos = ((ziweiIdx + offset) % 12 + 12) % 12;
    const palaceIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === pos);
    if(palaceIdx>=0) palaces[palaceIdx].stars.push({...ZW_MAJOR[star], type:'major'});
  });

  // å¤©åºœç³»å®‰æ˜Ÿ
  const tfStarMap = [
    {star:6, offset:0},   // å¤©åºœ
    {star:7, offset:1},   // å¤ªé™°
    {star:8, offset:2},   // è²ªç‹¼
    {star:9, offset:3},   // å·¨é–€
    {star:10, offset:4},  // å¤©ç›¸
    {star:11, offset:5},  // å¤©æ¢
    {star:12, offset:6},  // ä¸ƒæ®º
    {star:13, offset:10}  // ç ´è»
  ];
  tfStarMap.forEach(({star,offset})=>{
    const pos = ((tianfuIdx + offset) % 12 + 12) % 12;
    const palaceIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === pos);
    if(palaceIdx>=0) palaces[palaceIdx].stars.push({...ZW_MAJOR[star], type:'major'});
  });

  // å®‰å‰æ˜Ÿï¼ˆç°¡åŒ–ï¼‰
  const wcIdx = ((year-4)%12+12)%12;
  addStarToPalace(palaces,'æ–‡æ˜Œ','minor',(10-shi+12)%12);
  addStarToPalace(palaces,'æ–‡æ›²','minor',(shi+4)%12);
  addStarToPalace(palaces,'å·¦è¼”','minor',(lunar.month+3)%12);
  addStarToPalace(palaces,'å³å¼¼','minor',(11-lunar.month+12)%12);

  // å®‰ç…æ˜Ÿï¼ˆç°¡åŒ–ï¼‰
  const yZhiIdx = DZ.indexOf(yZhi);
  addStarToPalace(palaces,'æ“ç¾Š','sha',(yZhiIdx+1)%12);
  addStarToPalace(palaces,'é™€ç¾…','sha',(yZhiIdx-1+12)%12);
  addStarToPalace(palaces,'ç«æ˜Ÿ','sha',(yZhiIdx+2)%12);
  addStarToPalace(palaces,'éˆ´æ˜Ÿ','sha',(yZhiIdx+10)%12);

  // å››åŒ–
  const sihua = SIHUA_TABLE[yGan] || SIHUA_TABLE['ç”²'];
  const huaMap = [];
  [{type:'ç¥¿',label:'åŒ–ç¥¿'},{type:'æ¬Š',label:'åŒ–æ¬Š'},{type:'ç§‘',label:'åŒ–ç§‘'},{type:'å¿Œ',label:'åŒ–å¿Œ'}].forEach(h=>{
    const starName = sihua[h.type];
    palaces.forEach(p=>{
      const found = p.stars.find(s=>s.name===starName);
      if(found){
        found.hua = h.label;
        huaMap.push({star:starName, hua:h.label, palace:p.name});
      }
    });
  });

  return {palaces, mingIdx, shenIdx, yGan, yZhi, wuxingJu, sihua: huaMap, lunar};
}

function addStarToPalace(palaces, name, type, zhiIdx){
  const pIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === zhiIdx);
  if(pIdx>=0) palaces[pIdx].stars.push({name, type});
}

function getWuxingJu(gan, zhi){
  // ç´éŸ³äº”è¡Œå±€ï¼ˆç°¡åŒ–ï¼‰
  const juMap = {
    'ç”²å­':2,'ç”²ä¸‘':2,'ä¹™ä¸‘':2,'ä¹™å­':2,'ä¸™å¯…':3,'ä¸™å¯':3,'ä¸å¯':3,'ä¸å¯…':3,
    'æˆŠè¾°':5,'æˆŠå·³':5,'å·±å·³':5,'å·±è¾°':5,'åºšåˆ':4,'åºšæœª':4,'è¾›æœª':4,'è¾›åˆ':4,
    'å£¬ç”³':6,'å£¬é…‰':6,'ç™¸é…‰':6,'ç™¸ç”³':6
  };
  return juMap[gan+zhi] || (((gan.charCodeAt(0)+zhi.charCodeAt(0))%5)+2);
}

function getZiweiPalaceByJu(ju, lunarDay){
  // ç´«å¾®å®‰æ˜Ÿï¼šå±€æ•¸é™¤æ—¥æ•¸çš„é¤˜æ•¸æ±ºå®šä½ç½®
  const base = Math.ceil(lunarDay / ju);
  const remainder = lunarDay % ju;
  let idx;
  if(remainder === 0) idx = base - 1;
  else idx = base + (ju - remainder > remainder ? 0 : 1);
  return ((idx + 1) % 12 + 12) % 12;
}

function renderZiwei(){
  const zw = S.ziwei;
  if(!zw){document.getElementById('d-ziwei-info').innerHTML='<p class="text-dim">è«‹å…ˆå¡«å¯«å‡ºç”Ÿè³‡æ–™</p>';return}

  // Info
  document.getElementById('d-ziwei-info').innerHTML=`
    <p>å‘½å®®ï¼š${DZ[zw.mingIdx]}å®® ï½œ èº«å®®ï¼š${DZ[zw.shenIdx]}å®® ï½œ å¹´å¹²ï¼š${zw.yGan} ï½œ äº”è¡Œå±€ï¼š${zw.wuxingJu}å±€</p>`;

  // 12å®®æ ¼ï¼ˆ4x4, ä¸­é–“2x2ç©ºï¼‰
  // æ’åˆ—é †åº: è¾°å·³åˆæœª / å¯[ç©º][ç©º]ç”³ / å¯…[ç©º][ç©º]é…‰ / ä¸‘å­äº¥æˆŒ
  const order = [
    [3,4,5,6],   // è¾°å·³åˆæœª
    [2,-1,-1,7],  // å¯ center center ç”³
    [1,-1,-1,8],  // å¯… center center é…‰
    [0,11,10,9]   // ä¸‘å­äº¥æˆŒ
  ];

  let html = '<div class="zw-grid">';
  for(let row=0;row<4;row++){
    for(let col=0;col<4;col++){
      const idx = order[row][col];
      if(idx===-1){
        if(row===1&&col===1){
          // Center cell spans 2x2
          html+=`<div class="zw-cell zw-center" style="grid-column:2/4;grid-row:2/4">
            <div class="serif text-gold" style="font-size:1.1rem;margin-bottom:var(--sp-sm)">ç´«å¾®æ–—æ•¸</div>
            <p class="text-dim text-xs">å‘½å®®ï¼š${DZ[zw.mingIdx]}</p>
            <p class="text-dim text-xs">å¹´å¹²ï¼š${zw.yGan}${zw.yZhi}</p>
          </div>`;
        }
        continue;
      }
      const palace = zw.palaces.find(p => DZ.indexOf(p.branch) === idx);
      if(!palace){html+=`<div class="zw-cell"><span class="zw-palace">${DZ[idx]}</span></div>`;continue}

      const isMing = palace.isMing;
      html+=`<div class="zw-cell${isMing?' active-palace':''}">
        <div class="zw-palace">${palace.name}${isMing?' â­':''}</div>
        <div class="zw-branch">${palace.branch}</div>
        <div class="zw-stars">`;
      palace.stars.forEach(s=>{
        const cls = s.type==='major'?'major':s.type==='sha'?'text-danger':'minor';
        html+=`<span class="zw-star ${cls}">${s.name}</span>`;
        if(s.hua)html+=`<span class="zw-hua">${s.hua}</span>`;
      });
      html+=`</div></div>`;
    }
  }
  html+='</div>';
  document.getElementById('d-ziwei-grid').innerHTML=html;

  // å››åŒ–
  document.getElementById('d-ziwei-sihua').innerHTML = zw.sihua.length?
    zw.sihua.map(h=>`<p><span class="tag ${h.hua.includes('ç¥¿')?'tag-green':h.hua.includes('å¿Œ')?'tag-red':'tag-gold'}">${h.hua}</span> ${h.star} â†’ ${h.palace}</p>`).join('')
    :'<p class="text-dim">å››åŒ–è³‡è¨Šè¨ˆç®—ä¸­</p>';

  // è§£è®€
  const mingPalace = zw.palaces[0];
  const mingStars = mingPalace.stars.filter(s=>s.type==='major');
  let reading = '';
  if(mingStars.length){
    reading+=`<p><strong>å‘½å®®ä¸»æ˜Ÿï¼š</strong>${mingStars.map(s=>s.name).join('ã€')}</p>`;
    mingStars.forEach(s=>{
      const info = ZW_MAJOR.find(m=>m.name===s.name);
      if(info)reading+=`<p class="text-dim">â†’ ${info.name}ï¼š${info.nature}</p>`;
    });
  }else{
    reading+=`<p>å‘½å®®ç„¡ä¸»æ˜Ÿï¼Œå€Ÿå°å®®ï¼ˆé·ç§»å®®ï¼‰æ˜Ÿæ›œåˆ¤æ–·ã€‚æ€§æ ¼è¼ƒç‚ºè¢«å‹•ï¼Œéœ€ä¸»å‹•å‡ºæ“Šã€‚</p>`;
  }
  // è²¡å¸›å®®
  const caiPalace = zw.palaces[4];
  const caiStars = caiPalace.stars.filter(s=>s.type==='major');
  if(caiStars.length)reading+=`<p class="mt-sm"><strong>è²¡å¸›å®®ï¼š</strong>${caiStars.map(s=>s.name).join('ã€')} â€” ${caiStars.some(s=>['æ­¦æ›²','å¤©åºœ','å¤ªé™°'].includes(s.name))?'è²¡é‹åŸºç¤ä½³':'è²¡é‹éœ€é åŠªåŠ›ç©ç´¯'}</p>`;

  // å®˜ç¥¿å®®
  const guanPalace = zw.palaces[8];
  const guanStars = guanPalace.stars.filter(s=>s.type==='major');
  if(guanStars.length)reading+=`<p class="mt-sm"><strong>å®˜ç¥¿å®®ï¼š</strong>${guanStars.map(s=>s.name).join('ã€')} â€” ${guanStars.some(s=>['ç´«å¾®','å¤©åºœ','å¤ªé™½'].includes(s.name))?'äº‹æ¥­æ ¼å±€å¤§ï¼Œé©åˆç®¡ç†è·':'é©åˆå°ˆæ¥­æŠ€è¡“æˆ–è‡ªç”±æ¥­'}</p>`;

  // ç…æ˜Ÿæé†’
  const shaStars = [];
  zw.palaces.forEach(p=>p.stars.filter(s=>s.type==='sha').forEach(s=>shaStars.push(s.name+'('+p.name+')')));
  if(shaStars.length)reading+=`<p class="mt-sm text-warn"><strong>ç…æ˜Ÿï¼š</strong>${shaStars.join('ã€')} â€” æ³¨æ„ç›¸é—œå®®ä½çš„æŒ‘æˆ°</p>`;

  document.getElementById('d-ziwei-reading').innerHTML=reading||'<p class="text-dim">è§£è®€ç”Ÿæˆä¸­â€¦</p>';
}
/* =============================================================
   å§“åå­¸ NAMEOLOGYï¼ˆä¸‰æ‰äº”æ ¼ï¼‰
   ============================================================= */
const STROKE_OVERRIDE={
  // å¸¸è¦‹å­—çš„åº·ç†™ç­†ç•«æ•¸ï¼ˆéƒ¨åˆ†ï¼‰
  'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10,
  'å¤§':3,'å°':3,'ä¸­':4,'ä¸Š':3,'ä¸‹':3,'äºº':2,'å¤©':4,'åœ°':6,'æ°´':4,'ç«':4,
  'æœ¨':4,'é‡‘':8,'åœŸ':3,'æ—¥':4,'æœˆ':4,'å¹´':6,'æ˜':8,'å…‰':6,'è¯':14,'åœ‹':11,
  'å®¶':10,'åº­':10,'å¿ƒ':4,'æ€':9,'æ„›':13,'ç¾':9,'ç‰':5,'é¾':16,'é³³':14,
  'æ—':8,'é™³':16,'ç‹':4,'æ':7,'å¼µ':11,'åŠ‰':15,'é»ƒ':12,'å³':7,'è¶™':14,
  'æ¥Š':13,'å‘¨':8,'å¾':10,'å­«':10,'é¦¬':10,'æœ±':6,'èƒ¡':11,'éƒ­':15,'ä½•':7,
  'é«˜':10,'ç¾…':20,'é„­':19,'è”¡':17,'è¬':17,'è•­':18,'è¨±':11,'æ›¾':12,'å½­':12,
  'å‘‚':7,'è˜‡':22,'ç›§':16,'è”£':17,'æ²ˆ':8,'éŸ“':17,'å”':10,'é¦®':12,'æ½˜':16,
  'å¿—':7,'å‰':11,'å¼·':12,'å»º':9,'æ–‡':4,'æ­¦':8,'å¾·':15,'ä»':4,'ç¾©':13,
  'ç¦®':18,'ä¿¡':9,'æ™º':12,'å‹‡':9,'å¿ ':8,'å­':7,'ä¿Š':9,'å‚‘':12,'å®':7,
  'é›…':12,'éœ':16,'æ…§':15,'æ•':11,'å©·':12,'ç§€':7,'èŠ³':10,'éº—':19,'è‹±':11,
  'æ˜¥':9,'å¤':10,'ç§‹':9,'å†¬':5,'æ±':8,'è¥¿':6,'å—':9,'åŒ—':5,'æˆ':7,'åŠŸ':5,
  'å®‰':6,'å¹³':5,'ç¦':14,'å£½':14,'å–œ':12,'æ¨‚':15,'å’Œ':8,'é †':12,'å‰':6,
  'ç¥¥':11,'ç‘':14,'é”':16,'æ˜Œ':8,'ç››':12,'æ¦®':14,'å¯Œ':12,'è²´':12,'åº·':11
};

function kangxiStroke(ch){
  if(STROKE_OVERRIDE[ch])return STROKE_OVERRIDE[ch];
  // éƒ¨é¦–ä¿®æ­£ï¼ˆå¸¸è¦‹å·®ç•°ï¼‰
  const code=ch.charCodeAt(0);
  // ç²—ç•¥ä¼°ç®—ï¼šCJKå­—çš„ Unicode ç¢¼ % 25 + 2
  return (code % 23) + 3;
}

function analyzeName(fullName){
  if(!fullName||fullName.length<2)return null;
  const chars=[...fullName];
  const strokes=chars.map(c=>kangxiStroke(c));

  let tianGe,renGe,diGe,waiGe,zongGe;

  if(chars.length===2){
    // å–®å§“å–®å
    tianGe=strokes[0]+1;
    renGe=strokes[0]+strokes[1];
    diGe=strokes[1]+1;
    zongGe=strokes[0]+strokes[1];
    waiGe=2;
  }else if(chars.length===3){
    // å–®å§“é›™åï¼ˆæœ€å¸¸è¦‹ï¼‰
    tianGe=strokes[0]+1;
    renGe=strokes[0]+strokes[1];
    diGe=strokes[1]+strokes[2];
    zongGe=strokes[0]+strokes[1]+strokes[2];
    waiGe=strokes[0]+strokes[2];
  }else if(chars.length===4){
    // è¤‡å§“é›™å
    tianGe=strokes[0]+strokes[1];
    renGe=strokes[1]+strokes[2];
    diGe=strokes[2]+strokes[3];
    zongGe=strokes.reduce((a,b)=>a+b,0);
    waiGe=strokes[0]+strokes[3];
  }else{
    return null;
  }

  // äº”è¡Œ
  function geWuxing(ge){
    const tail=ge%10;
    if(tail===1||tail===2)return'æœ¨';
    if(tail===3||tail===4)return'ç«';
    if(tail===5||tail===6)return'åœŸ';
    if(tail===7||tail===8)return'é‡‘';
    return'æ°´';
  }

  // å‰å‡¶ï¼ˆç°¡åŒ–81æ•¸ç†ï¼‰
  function geFortune(ge){
    const n=((ge-1)%80)+1;
    const ji=[1,3,5,6,7,8,11,13,15,16,17,18,21,23,24,25,29,31,32,33,35,37,39,41,45,47,48,52,57,61,63,65,67,68];
    const dj=[1,3,5,8,11,13,15,16,21,23,24,25,31,32,33,35,37,41,45,47,48,52,57,61,63,67,68];
    if(dj.includes(n))return{level:'å¤§å‰',cls:'text-success'};
    if(ji.includes(n))return{level:'å‰',cls:'text-success'};
    const xiong=[2,4,9,10,12,14,19,20,22,26,27,28,30,34,36,38,40,42,43,44,46,49,50,51,53,54,55,56,58,59,60,62,64,66,69,70,71,72,73,74,75,76,77,78,79,80];
    if(xiong.includes(n))return{level:'å‡¶',cls:'text-danger'};
    return{level:'å¹³',cls:'text-dim'};
  }

  // ä¸‰æ‰é…ç½®
  const sanCai=[geWuxing(tianGe),geWuxing(renGe),geWuxing(diGe)];
  // ä¸‰æ‰å‰å‡¶ï¼ˆç°¡åŒ–åˆ¤æ–·ï¼‰
  let sanCaiLevel='å‰';
  const [t,r,d]=sanCai;
  // ç›¸ç”Ÿç‚ºå‰
  if(SHENG[t]===r&&SHENG[r]===d)sanCaiLevel='å¤§å‰';
  else if(SHENG[t]===r||SHENG[r]===d)sanCaiLevel='å‰';
  else if(KE[t]===r||KE[r]===d)sanCaiLevel='å‡¶';
  else sanCaiLevel='å¹³';

  return{
    name:fullName, strokes,
    tianGe:{num:tianGe,el:geWuxing(tianGe),fortune:geFortune(tianGe)},
    renGe:{num:renGe,el:geWuxing(renGe),fortune:geFortune(renGe)},
    diGe:{num:diGe,el:geWuxing(diGe),fortune:geFortune(diGe)},
    waiGe:{num:waiGe,el:geWuxing(waiGe),fortune:geFortune(waiGe)},
    zongGe:{num:zongGe,el:geWuxing(zongGe),fortune:geFortune(zongGe)},
    sanCai,sanCaiLevel
  };
}

/* =============================================================
   æ°´æ™¶æ¨è–¦ç³»çµ± CRYSTAL â€” æ“´å……ç‰ˆ
   ============================================================= */
const CRYSTAL_DB={
  é‡‘:[
    {n:'ç™½æ°´æ™¶',icon:'ğŸ’',el:'é‡‘',d:'æ·¨åŒ–èƒ½é‡å ´ï¼Œå¢å¼·æ€ç¶­æ¸…æ™°åº¦ï¼Œè¬èƒ½èª¿å’ŒçŸ³ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œæˆ–æ”¾æ›¸æ¡Œ/è¾¦å…¬æ¡Œã€‚',taboo:'é¿å…ç¢°æ’ï¼Œå®šæœŸæ·¨åŒ–ã€‚'},
    {n:'é»ƒéµç¤¦',icon:'âœ¨',el:'é‡‘',d:'å¢å¼·è²¡é‹ï¼Œæå‡è‡ªä¿¡èˆ‡è¡Œå‹•åŠ›ã€‚',wear:'æ”¾åœ¨éŒ¢åŒ…æˆ–è¾¦å…¬æ¡Œå·¦ä¸Šè§’ã€‚',taboo:'æ€•æ°´ï¼Œé¿å…æ¥è§¸æ¶²é«”ã€‚'},
    {n:'ç™½å¹½éˆ',icon:'ğŸ¤',el:'é‡‘',d:'æ·¨åŒ–ç£å ´ï¼Œæå‡éˆæ€§ç›´è¦ºã€‚',wear:'å†¥æƒ³æ™‚æ‰‹æŒæˆ–ä½©æˆ´ã€‚',taboo:'é¿å…é™½å…‰ç›´å°„ã€‚'},
    {n:'éˆ¦æ™¶',icon:'âš¡',el:'é‡‘',d:'æ‹›æ­£è²¡åè²¡ï¼Œå¢å¼·é ˜å°åŠ›èˆ‡æ°£é­„ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œé¢è©¦/ç°½ç´„æ™‚ç‰¹åˆ¥æœ‰æ•ˆã€‚',taboo:'ç£å ´å¼·ï¼Œç¡çœ æ™‚å»ºè­°å–ä¸‹ã€‚'}
  ],
  æœ¨:[
    {n:'ç¶ å¹½éˆ',icon:'ğŸ’š',el:'æœ¨',d:'æ‹›æ­£è²¡ï¼Œäº‹æ¥­ç©©æ­¥ä¸Šå‡ï¼Œé©åˆä¸Šç­æ—ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œæ”¾è¾¦å…¬æ¡Œå¢äº‹æ¥­é‹ã€‚',taboo:'é¿å…é«˜æº«èˆ‡åŒ–å­¸å“ã€‚'},
    {n:'æ±é™µç‰',icon:'ğŸŒ¿',el:'æœ¨',d:'èˆ’ç·©å£“åŠ›ï¼Œå¸¶ä¾†å¥½é‹èˆ‡æ¨‚è§€å¿ƒæ…‹ã€‚',wear:'éš¨èº«ä½©æˆ´æˆ–æ”¾æ•é ­ä¸‹åŠ©çœ ã€‚',taboo:'å®šæœŸç”¨æœˆå…‰æ·¨åŒ–ã€‚'},
    {n:'ç¿¡ç¿ ',icon:'ğŸŸ¢',el:'æœ¨',d:'è­·èº«è¾Ÿé‚ªï¼Œå¢å¼·å¥åº·èˆ‡äººç·£ã€‚',wear:'ä½©æˆ´åœ¨é è¿‘å¿ƒè‡Ÿè™•ã€‚',taboo:'é¿å…ç¢°æ’èˆ‡é«˜æº«ã€‚'},
    {n:'æ©„æ¬–çŸ³',icon:'ğŸŒ±',el:'æœ¨',d:'ç™‚ç™’å¿ƒè¼ªï¼Œå¸¶ä¾†æ­£èƒ½é‡èˆ‡å¥½é‹ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œå¯é…åˆå†¥æƒ³ã€‚',taboo:'è³ªåœ°è¼ƒè»Ÿï¼Œæ³¨æ„ä¿è­·ã€‚'}
  ],
  æ°´:[
    {n:'æµ·è—å¯¶',icon:'ğŸ’™',el:'æ°´',d:'å¢å¼·æºé€šåŠ›ï¼Œå¹³éœæƒ…ç·’ï¼Œé©åˆè«‡åˆ¤ã€‚',wear:'ä½©æˆ´åœ¨å–‰è¼ªé™„è¿‘ï¼ˆé …éŠï¼‰æ•ˆæœæœ€ä½³ã€‚',taboo:'é¿å…é•·æ™‚é–“æ—¥æ›¬ã€‚'},
    {n:'è—ç´‹ç‘ªç‘™',icon:'ğŸ”µ',el:'æ°´',d:'ç©©å®šæƒ…ç·’ï¼Œå¢å¼·èªè¨€è¡¨é”èƒ½åŠ›ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œæˆ–åšç‚ºé …éŠã€‚',taboo:'å®šæœŸæµæ°´æ·¨åŒ–ã€‚'},
    {n:'æœˆå…‰çŸ³',icon:'ğŸŒ™',el:'æ°´',d:'å¢å¼·ç›´è¦ºï¼ŒåŠ©æ„Ÿæƒ…é‹ï¼ŒæŸ”åŒ–å€‹æ€§ã€‚',wear:'æ»¿æœˆæ™‚ä½©æˆ´æ•ˆæœæ›´ä½³ã€‚',taboo:'ç¡¬åº¦ä¸é«˜ï¼Œé¿å…ç¢°æ’ã€‚'},
    {n:'æ‹‰é•·çŸ³',icon:'ğŸŒŠ',el:'æ°´',d:'æå‡æ´å¯ŸåŠ›ï¼Œä¿è­·èƒ½é‡å ´ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œå‡ºå…¥è¤‡é›œå ´æ‰€æ™‚æ•ˆæœå¥½ã€‚',taboo:'é¿å…è¶…è²æ³¢æ¸…æ´—ã€‚'}
  ],
  ç«:[
    {n:'ç´…ç‘ªç‘™',icon:'â¤ï¸',el:'ç«',d:'æ¿€ç™¼ç†±æƒ…ï¼Œå¢å¼·è¡Œå‹•åŠ›èˆ‡å‹‡æ°£ã€‚',wear:'å³æ‰‹ä½©æˆ´å¢å¼·è¡Œå‹•åŠ›ã€‚',taboo:'é¿å…é«˜æº«ç’°å¢ƒã€‚'},
    {n:'çŸ³æ¦´çŸ³',icon:'ğŸ”´',el:'ç«',d:'æå‡æ´»åŠ›ï¼Œå¢å¼·æ„å¿—åŠ›èˆ‡æ¡ƒèŠ±é‹ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œè²¼èº«æ•ˆæœå¥½ã€‚',taboo:'å®šæœŸç”¨æ°´æ™¶ç°‡æ·¨åŒ–ã€‚'},
    {n:'ç´…ç¢§ç’½',icon:'ğŸ’—',el:'ç«',d:'å¼·åŠ›æ‹›æ¡ƒèŠ±ï¼Œå¢å¼·äººéš›é­…åŠ›ã€‚',wear:'ä½©æˆ´åœ¨å¿ƒè¼ªé™„è¿‘ã€‚',taboo:'ç£å ´æ•æ„Ÿï¼Œé¿å…èˆ‡å…¶ä»–å¼·ç£å ´æ°´æ™¶æ··æˆ´ã€‚'},
    {n:'å¤ªé™½çŸ³',icon:'â˜€ï¸',el:'ç«',d:'å¸¶ä¾†æ­£èƒ½é‡ï¼Œå¢å¼·è‡ªä¿¡èˆ‡é ˜å°åŠ›ã€‚',wear:'æ—¥é–“ä½©æˆ´æ•ˆæœä½³ã€‚',taboo:'é¿å…é•·æ™‚é–“æ³¡æ°´ã€‚'}
  ],
  åœŸ:[
    {n:'é»ƒæ°´æ™¶',icon:'ğŸ’›',el:'åœŸ',d:'æ‹›åè²¡ï¼Œæå‡è‡ªä¿¡èˆ‡å€‹äººé­…åŠ›ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œæ”¾éŒ¢åŒ…ä¹Ÿå¯ã€‚',taboo:'é¿å…é™½å…‰é•·æ™‚é–“ç›´å°„ï¼Œæœƒè¤ªè‰²ã€‚'},
    {n:'è™çœ¼çŸ³',icon:'ğŸŸ¤',el:'åœŸ',d:'å¢å¼·æ±ºæ–·åŠ›ï¼Œæ‹›è²¡è¾Ÿé‚ªï¼Œç©©å®šå¿ƒæ€§ã€‚',wear:'å³æ‰‹ä½©æˆ´å¢å¼·æ°£å ´ã€‚',taboo:'å®šæœŸæ—¥å…‰æµ´æ·¨åŒ–ï¼ˆçŸ­æ™‚é–“ï¼‰ã€‚'},
    {n:'èŒ¶æ™¶',icon:'ğŸ«–',el:'åœŸ',d:'æ’é™¤è² èƒ½é‡ï¼Œå¢å¼·ç©©å®šæ„Ÿã€‚',wear:'ä½©æˆ´æˆ–æ”¾åœ¨å®¶ä¸­å®¢å»³ã€‚',taboo:'é¿å…åŒ–å­¸å“ã€‚'},
    {n:'ç‘ªç‘™',icon:'ğŸŸ ',el:'åœŸ',d:'ä¿è­·ã€ç©©å®šã€å¢å¼·è€åŠ›ã€‚',wear:'å¯éš¨èº«ä½©æˆ´ï¼Œé©åˆå„å ´åˆã€‚',taboo:'è³ªåœ°å …ç¡¬ä½†ä»éœ€å°å¿ƒç¢°æ’ã€‚'}
  ]
};

// å•é¡Œé¡å‹ â†’ ç‰¹æ®Šæ¨è–¦
const CRYSTAL_BY_TYPE={
  love:[{n:'ç²‰æ™¶',icon:'ğŸ’•',el:'åœŸ',d:'æ‹›æ¡ƒèŠ±é¦–é¸ï¼Œå¢å¼·æ„Ÿæƒ…é‹èˆ‡äººéš›é­…åŠ›ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œç¡å‰æ”¾æ•é ­ä¸‹ã€‚',taboo:'éœ€å®šæœŸæ·¨åŒ–ï¼Œå¸æ”¶è² èƒ½é‡å¾Œæœƒè®Šæš—ã€‚'},
        {n:'è‰è“æ™¶',icon:'ğŸ“',el:'ç«',d:'å¢å¼·ç•°æ€§ç·£ï¼Œå¸¶ä¾†ç”œèœœçš„æˆ€æ„›æ©Ÿæœƒã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œç´„æœƒæ™‚æ•ˆæœå€å¢ã€‚',taboo:'é¿å…ç¢°æ’ã€‚'}],
  career:[{n:'éˆ¦æ™¶',icon:'âš¡',el:'é‡‘',d:'äº‹æ¥­æ™‰å‡é¦–é¸ï¼Œå¢å¼·é ˜å°åŠ›èˆ‡æ±ºæ–·åŠ›ã€‚',wear:'é¢è©¦/é‡è¦æœƒè­°æ™‚ä½©æˆ´ã€‚',taboo:'ç£å ´å¼·ï¼Œç¡çœ æ™‚å–ä¸‹ã€‚'}],
  wealth:[{n:'é»ƒæ°´æ™¶',icon:'ğŸ’›',el:'åœŸ',d:'åè²¡é‹é¦–é¸ï¼Œæå‡æŠ•è³‡çœ¼å…‰ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œæ”¾æ”¶éŠ€å°ä¹Ÿå¯ã€‚',taboo:'é¿å…æ—¥æ›¬ã€‚'},
          {n:'ç¶ å¹½éˆ',icon:'ğŸ’š',el:'æœ¨',d:'æ­£è²¡é‹é¦–é¸ï¼Œé©åˆç©©å¥ç†è²¡ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ã€‚',taboo:'é¿å…é«˜æº«ã€‚'}],
  health:[{n:'ç´«æ°´æ™¶',icon:'ğŸ’œ',el:'ç«',d:'å®‰ç¥åŠ©çœ ï¼Œç©©å®šæƒ…ç·’ï¼Œä¿ƒé€²èº«å¿ƒå¹³è¡¡ã€‚',wear:'æ”¾æ•é ­ä¸‹åŠ©çœ ï¼Œæˆ–ä½©æˆ´åœ¨ç¬¬ä¸‰çœ¼è™•å†¥æƒ³ã€‚',taboo:'é¿å…æ—¥æ›¬æœƒè¤ªè‰²ã€‚'}]
};

function renderCrystalExpanded(bazi, type){
  const need = bazi.fav[0];
  const baseCrystals = CRYSTAL_DB[need] || CRYSTAL_DB['åœŸ'];
  const typeCrystals = CRYSTAL_BY_TYPE[type] || [];

  // å»é‡åˆä½µ
  const allCrystals = [...typeCrystals];
  baseCrystals.forEach(c=>{if(!allCrystals.find(a=>a.n===c.n))allCrystals.push(c)});
  const display = allCrystals.slice(0,4);

  document.getElementById('r-crystal').innerHTML=`
    <p class="mb-md">æ ¹æ“šå‘½ç›¤ï¼ˆå–œç”¨ <span class="tag tag-gold">${need}è¡Œ</span>ï¼‰èˆ‡å•é¡Œé¡å‹ï¼ˆ<span class="tag tag-blue">${getTypeLabel(type)}</span>ï¼‰ï¼Œæ¨è–¦ï¼š</p>
    <div class="crystal-grid">${display.map(c=>`
      <div class="crystal-card">
        <div class="crystal-icon">${c.icon}</div>
        <div class="crystal-name">${c.n}</div>
        <div class="text-xs mb-sm"><span class="el-tag el-${c.el}">${c.el}è¡Œ</span></div>
        <p class="text-sm text-dim">${c.d}</p>
        <p class="text-xs text-muted mt-sm"><i class="fas fa-hand-holding-heart"></i> ${c.wear}</p>
        <p class="text-xs text-warn mt-sm"><i class="fas fa-exclamation-triangle"></i> ${c.taboo}</p>
      </div>`).join('')}</div>
    <p class="text-xs text-muted mt-md"><i class="fas fa-info-circle"></i> æœ¬å»ºè­°åƒ…ä¾›èƒ½é‡æ ¡æº–åƒè€ƒï¼Œä¸å…·é†«ç™‚æˆ–å‘½é‹ä¿è­‰æ•ˆåŠ›ã€‚æ°´æ™¶æ•ˆæœå› äººè€Œç•°ï¼Œè«‹ä¾è‡ªèº«æ„Ÿå—èª¿æ•´ã€‚</p>`;
}

/* =============================================================
   FUSION ENGINE v2 â€” äº”ç¶­åº¦åŠ æ¬Šèåˆ
   ============================================================= */
function runAnalysisV2(){
  renderBazi(); renderMeihua(); renderTarot(); renderZiwei(); renderName();

  const b=S.bazi; if(!b)return;
  const type=S.form.type;
  const question=S.form.question;

  // â”€â”€ 1. å…«å­—è©•åˆ† (0-100) â”€â”€
  let baziScore=50;
  if(b.strong){
    if(b.ep[KE[b.dmEl]]>15)baziScore+=12;
    if(b.ep[BE_KE[b.dmEl]]>10)baziScore+=8;
  }else{
    if(b.ep[BE_SHENG[b.dmEl]]>15)baziScore+=12;
    if(b.ep[b.dmEl]>15)baziScore+=8;
  }
  const curDy=b.dayun.find(d=>d.isCurrent);
  if(curDy){
    if(curDy.level==='å¤§å‰')baziScore+=15;
    else if(curDy.level==='ä¸­å‰')baziScore+=10;
    else if(curDy.level.includes('å‡¶'))baziScore-=10;
  }
  if(b.shensha.includes('å¤©ä¹™è²´äºº'))baziScore+=5;
  if(b.shensha.includes('æ–‡æ˜Œ')&&(type==='career'))baziScore+=5;
  if(b.shensha.includes('æ¡ƒèŠ±')&&(type==='love'))baziScore+=8;
  if(b.shensha.includes('é©›é¦¬')&&(type==='career'))baziScore+=3;
  baziScore=Math.max(10,Math.min(95,baziScore));

  // â”€â”€ 2. æ¢…èŠ±è©•åˆ† â”€â”€
  let mhScore=50;
  if(S.meihua){
    const fMap={'å¤§å‰':82,'å‰':70,'å°å‰':60,'å¹³':50,'å°å‡¶':35,'å‡¶':20};
    mhScore=fMap[S.meihua.ty.f]||50;
  }

  // â”€â”€ 3. å¡”ç¾…è©•åˆ† â”€â”€
  let tarotScore=50;
  if(S.tarot.drawn.length>=10){
    let pos=0,neg=0;
    S.tarot.drawn.forEach(c=>{
      if(c.isUp)pos+=1;else neg+=0.8;
      // ç‰¹å®šç‰ŒåŠ æ¬Š
      if(c.id===19&&c.isUp)pos+=2; // å¤ªé™½æ­£ä½
      if(c.id===21&&c.isUp)pos+=2; // ä¸–ç•Œæ­£ä½
      if(c.id===10&&c.isUp)pos+=1.5; // å‘½é‹ä¹‹è¼ªæ­£ä½
      if(c.id===16&&c.isUp)neg+=2; // å¡”æ­£ä½
      if(c.id===13&&!c.isUp)neg+=1; // æ­»ç¥é€†ä½
      if(c.id===15&&c.isUp)neg+=1.5; // æƒ¡é­”æ­£ä½
    });
    tarotScore=Math.round(50+(pos-neg)*3);
    tarotScore=Math.max(10,Math.min(90,tarotScore));
  }

  // â”€â”€ 4. ç´«å¾®è©•åˆ† â”€â”€
  let ziweiScore=50;
  if(S.ziwei){
    const mingStars=S.ziwei.palaces[0].stars;
    // å‘½å®®æœ‰å‰æ˜ŸåŠ åˆ†
    const goodStars=['ç´«å¾®','å¤©åºœ','å¤©åŒ','å¤©æ¢','å¤©ç›¸','å¤ªé™½','å¤ªé™°','æ–‡æ˜Œ','æ–‡æ›²','å·¦è¼”','å³å¼¼'];
    const badStars=['æ“ç¾Š','é™€ç¾…','ç«æ˜Ÿ','éˆ´æ˜Ÿ','ä¸ƒæ®º','ç ´è»'];
    mingStars.forEach(s=>{
      if(goodStars.includes(s.name))ziweiScore+=5;
      if(badStars.includes(s.name))ziweiScore-=3;
      if(s.hua==='åŒ–ç¥¿')ziweiScore+=8;
      if(s.hua==='åŒ–æ¬Š')ziweiScore+=5;
      if(s.hua==='åŒ–å¿Œ')ziweiScore-=8;
    });
    // å•é¡Œå°æ‡‰å®®ä½
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7};
    const gongIdx=typeToGong[type];
    if(gongIdx!==undefined){
      const gongStars=S.ziwei.palaces[gongIdx].stars;
      gongStars.forEach(s=>{
        if(goodStars.includes(s.name))ziweiScore+=4;
        if(s.hua==='åŒ–ç¥¿')ziweiScore+=6;
        if(s.hua==='åŒ–å¿Œ')ziweiScore-=6;
      });
    }
    ziweiScore=Math.max(10,Math.min(90,ziweiScore));
  }

  // â”€â”€ 5. å§“åå­¸è©•åˆ† â”€â”€
  let nameScore=50;
  let nameResult=null;
  if(S.form.name&&S.form.name.length>=2){
    nameResult=analyzeName(S.form.name);
    if(nameResult){
      [nameResult.tianGe,nameResult.renGe,nameResult.diGe,nameResult.waiGe,nameResult.zongGe].forEach(g=>{
        if(g.fortune.level==='å¤§å‰')nameScore+=6;
        else if(g.fortune.level==='å‰')nameScore+=3;
        else if(g.fortune.level==='å‡¶')nameScore-=4;
      });
      if(nameResult.sanCaiLevel==='å¤§å‰')nameScore+=10;
      else if(nameResult.sanCaiLevel==='å‰')nameScore+=5;
      else if(nameResult.sanCaiLevel==='å‡¶')nameScore-=8;
      nameScore=Math.max(10,Math.min(90,nameScore));
    }
  }

  // â”€â”€ åŠ æ¬Šç¶œåˆ â”€â”€
  const w={bazi:0.30, meihua:S.meihua?0.20:0, tarot:S.tarot.drawn.length>=10?0.20:0, ziwei:S.ziwei?0.20:0, name:nameResult?0.10:0};
  const totalW=Object.values(w).reduce((a,b)=>a+b,0);
  const scores={bazi:baziScore,meihua:mhScore,tarot:tarotScore,ziwei:ziweiScore,name:nameScore};
  let finalProb=0;
  for(const k of Object.keys(w))finalProb+=scores[k]*(w[k]/totalW);
  finalProb=Math.round(finalProb);

  // â”€â”€ Verdict â”€â”€
  let vlabel,vnote;
  if(finalProb>=70){vlabel='åå‘å¯è¡Œ âœ…';vnote='å¤šç¶­åº¦æŒ‡æ¨™åä¸€è‡´ï¼Œé©åˆæ¨é€²ï¼Œä»éœ€æŒ‰å»ºè­°æ§é¢¨éšªã€‚'}
  else if(finalProb>=45){vlabel='ä¸­æ€§åå¯è¡Œ âš–ï¸';vnote='æœ‰åˆ©èˆ‡é˜»åŠ›ä¸¦å­˜ï¼›ç…§å»ºè­°èª¿æ•´åšæ³•ï¼Œå‹ç‡æœƒä¸Šå‡ã€‚'}
  else if(finalProb>=25){vlabel='åä¿å®ˆ âš ï¸';vnote='é˜»åŠ›è¨Šè™Ÿè¼ƒå¤šï¼Œå»ºè­°å…ˆé™ä½æˆæœ¬/è©¦æ°´æº«ã€‚'}
  else{vlabel='ä¸å»ºè­°ç¡¬æ¨ â›”';vnote='ç›®å‰è±¡å¾µåé€†é¢¨ï¼›è‹¥è¦åšï¼Œå‹™å¿…è¨­åœæã€‚'}

  document.getElementById('r-vlabel').textContent=vlabel;
  document.getElementById('r-vprob').textContent=finalProb+'%';
  document.getElementById('r-vnote').textContent=vnote;
  document.getElementById('r-pfill').style.width=finalProb+'%';
  document.getElementById('r-question').innerHTML=`<strong>å•é¡Œï¼š</strong>${question}<br><span class="tag tag-gold">${getTypeLabel(type)}</span>`;

  // â”€â”€ Answer â”€â”€
  const answer=generateAnswer(type,finalProb,b,S.meihua,S.tarot);
  document.getElementById('r-answer').innerHTML=answer.text;
  document.getElementById('r-factors').innerHTML=answer.factors?`<h4 class="text-gold serif mt-md mb-sm">å½±éŸ¿å› å­</h4><ul class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.factors.map(f=>'<li style="margin:.3rem 0">'+f+'</li>').join('')}</ul>`:'';
  document.getElementById('r-suggest').innerHTML=answer.suggestions?`<h4 class="text-gold serif mt-md mb-sm">è¡Œå‹•å»ºè­°</h4><ol class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.suggestions.map(s=>'<li style="margin:.3rem 0">'+s+'</li>').join('')}</ol>`:'';

  // â”€â”€ Breakdown â”€â”€
  const dimLabels={bazi:'å…«å­—å‘½ç†',meihua:'æ¢…èŠ±æ˜“æ•¸',tarot:'å¡”ç¾…ç‰Œé™£',ziwei:'ç´«å¾®æ–—æ•¸',name:'å§“åå­¸'};
  document.getElementById('r-pbreak').innerHTML=Object.keys(w).filter(k=>w[k]>0).map(k=>
    `<div class="el-row"><span class="el-lbl text-sm">${dimLabels[k]}</span><div class="el-track"><div class="el-fill" style="width:${scores[k]}%;background:var(--c-gold)"></div></div><span class="el-val">${scores[k]}%<span class="text-xs text-muted"> (${Math.round(w[k]/totalW*100)}%)</span></span></div>`
  ).join('');

  // â”€â”€ Crystal â”€â”€
  if(typeof renderProductCrystal==='function')renderProductCrystal(b,type);
  else renderCrystalExpanded(b,type);

  // â”€â”€ Conclusion â”€â”€
  let concl=generateConclusion(type,finalProb,b,S.meihua,S.tarot);
  // åŠ å…¥ç´«å¾®
  if(S.ziwei){
    const mp=S.ziwei.palaces[0];
    const ms=mp.stars.filter(s=>s.type==='major').map(s=>s.name).join('ã€');
    if(ms)concl+=`<p class="mt-sm">ç´«å¾®å‘½å®®ä¸»æ˜Ÿï¼š${ms}ï¼Œ${ziweiScore>=60?'å‘½æ ¼åå‘æœ‰åˆ©':'éœ€æ³¨æ„ç›¸é—œå®®ä½æŒ‘æˆ°'}ã€‚</p>`;
  }
  // åŠ å…¥å§“åå­¸
  if(nameResult){
    concl+=`<p class="mt-sm">å§“åå­¸ï¼šä¸‰æ‰ ${nameResult.sanCai.join('â†’')}ï¼ˆ${nameResult.sanCaiLevel}ï¼‰ï¼Œäººæ ¼${nameResult.renGe.num}ï¼ˆ${nameResult.renGe.fortune.level}ï¼‰ã€‚</p>`;
  }
  document.getElementById('r-conclusion').innerHTML=concl;
}

// Override runAnalysis to use V2
function runAnalysis(){ runAnalysisV2(); }

function renderName(){
  const el=document.getElementById('d-name');
  if(!S.form.name||S.form.name.length<2){el.innerHTML='<p class="text-dim">æœªè¼¸å…¥å§“åï¼Œç„¡æ³•é€²è¡Œå§“åå­¸åˆ†æã€‚</p>';return}
  const r=analyzeName(S.form.name);
  if(!r){el.innerHTML='<p class="text-dim">å§“åæ ¼å¼ä¸æ”¯æ´ï¼ˆéœ€2-4å€‹å­—ï¼‰ã€‚</p>';return}

  const geData=[
    {label:'å¤©æ ¼',data:r.tianGe,desc:'å…ˆå¤©é‹ï¼Œå§“æ°æ±ºå®š'},
    {label:'äººæ ¼',data:r.renGe,desc:'ä¸»é‹ï¼Œå½±éŸ¿ä¸­å¹´'},
    {label:'åœ°æ ¼',data:r.diGe,desc:'å‰é‹ï¼Œå½±éŸ¿é’å¹´'},
    {label:'å¤–æ ¼',data:r.waiGe,desc:'å‰¯é‹ï¼Œäººéš›é—œä¿‚'},
    {label:'ç¸½æ ¼',data:r.zongGe,desc:'å¾Œé‹ï¼Œå½±éŸ¿æ™šå¹´'}
  ];

  el.innerHTML=`
    <p class="mb-md">å§“åï¼š<strong class="text-gold serif">${r.name}</strong> ï½œ ç­†ç•«ï¼š${r.strokes.join('ã€')}</p>
    <div class="bazi-grid" style="grid-template-columns:repeat(5,1fr);margin:var(--sp-md) 0">
      ${geData.map(g=>`<div class="bazi-cell header">${g.label}</div>`).join('')}
      ${geData.map(g=>`<div class="bazi-cell">
        <span class="gz">${g.data.num}</span>
        <span class="el-tag el-${g.data.el}">${g.data.el}</span>
        <div class="gz-sub ${g.data.fortune.cls}">${g.data.fortune.level}</div>
      </div>`).join('')}
      ${geData.map(g=>`<div class="bazi-cell"><div class="gz-sub">${g.desc}</div></div>`).join('')}
    </div>
    <div class="mt-md">
      <p><strong>ä¸‰æ‰é…ç½®ï¼š</strong>${r.sanCai.join(' â†’ ')} <span class="tag ${r.sanCaiLevel.includes('å‰')?'tag-green':r.sanCaiLevel==='å‡¶'?'tag-red':'tag-gold'}">${r.sanCaiLevel}</span></p>
      <p class="text-sm text-dim mt-sm">ä¸‰æ‰ä»£è¡¨å¤©æ ¼â†’äººæ ¼â†’åœ°æ ¼çš„äº”è¡Œæµé€šé—œä¿‚ï¼Œ${r.sanCaiLevel.includes('å‰')?'ç›¸ç”Ÿç›¸åŠ©ç‚ºä½³è±¡':'å­˜åœ¨ç›¸å‰‹ï¼Œéœ€æ³¨æ„å¥åº·èˆ‡äººéš›'}ã€‚</p>
    </div>`;
}
/* =============================================================
   ENHANCEMENT 1: æµå¹´è©³ç´°å±•é–‹ï¼ˆé»æ“Šå¤§é‹å±•é–‹10æµå¹´ï¼‰
   ============================================================= */
function renderDayunEnhanced(){
  const b=S.bazi; if(!b)return;
  let html='<div class="dayun-tl">';
  b.dayun.forEach((d,i)=>{
    const lvCls=d.level==='å¤§å‰'?'lv-dj':d.level==='ä¸­å‰'?'lv-zj':d.level==='å°å‰'?'lv-xj':d.level==='å¹³'?'lv-p':d.level==='å°å‡¶'?'lv-xk':d.level==='ä¸­å‡¶'?'lv-zk':'lv-dk';
    html+=`<div class="dy-item ${d.isCurrent?'current':''}" onclick="toggleLiuNian(${i})" title="é»æ“Šå±•é–‹æµå¹´">
      <span class="dy-gz">${d.gz}</span><span class="dy-age">${d.ageStart}-${d.ageEnd}æ­²</span>
      <span class="dy-lv ${lvCls}">${d.level}</span><div class="gz-sub">${d.god}</div></div>`;
  });
  html+='</div>';
  html+='<div id="liunian-detail" class="mt-md hidden"></div>';
  document.getElementById('d-dayun').innerHTML=html;
}

function toggleLiuNian(dyIdx){
  const el=document.getElementById('liunian-detail');
  const b=S.bazi; if(!b||!b.dayun[dyIdx])return;
  const dy=b.dayun[dyIdx];
  if(el.dataset.openIdx===String(dyIdx)&&!el.classList.contains('hidden')){
    el.classList.add('hidden');return;
  }
  el.dataset.openIdx=dyIdx;
  el.classList.remove('hidden');
  const curYear=new Date().getFullYear();
  let html=`<div class="card" style="padding:var(--sp-md);margin:0"><div class="card-title text-sm"><i class="fas fa-calendar"></i> ${dy.gz}å¤§é‹ï¼ˆ${dy.ageStart}-${dy.ageEnd}æ­²ï¼‰æµå¹´æ˜ç´°</div>`;
  html+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:4px">';
  dy.liuNian.forEach(ln=>{
    const isCur=ln.year===curYear;
    const cls=ln.level==='å‰'?'tag-green':ln.level==='å‡¶'?'tag-red':'tag-gold';
    html+=`<div style="padding:6px;border:1px solid ${isCur?'var(--c-gold)':'var(--c-border)'};border-radius:var(--r-sm);background:${isCur?'rgba(212,175,55,.08)':'var(--c-bg-card)'};font-size:.8rem;text-align:center">
      <strong>${ln.year}</strong><br>
      <span class="serif">${ln.gz}</span><br>
      <span class="el-tag el-${ln.el}">${ln.el}</span>
      <span class="tag ${cls}" style="font-size:.6rem">${ln.level}</span><br>
      <span class="text-xs text-muted">${ln.god}</span>
      ${isCur?'<br><span class="text-xs text-gold">â† ä»Šå¹´</span>':''}
    </div>`;
  });
  html+='</div></div>';
  el.innerHTML=html;
}

/* =============================================================
   ENHANCEMENT 2: æ¢…èŠ±å…­çˆ»çˆ»è¾­ï¼ˆç°¡åŒ–ç‰ˆï¼šæœ¬å¦å‹•çˆ»çˆ»è¾­ï¼‰
   ============================================================= */
const YAO_CI={
  'ä¹¾ç‚ºå¤©':['æ½›é¾å‹¿ç”¨','è¦‹é¾åœ¨ç”°ï¼Œåˆ©è¦‹å¤§äºº','å›å­çµ‚æ—¥ä¹¾ä¹¾ï¼Œå¤•æƒ•è‹¥å²ï¼Œç„¡å’','æˆ–èºåœ¨æ·µï¼Œç„¡å’','é£›é¾åœ¨å¤©ï¼Œåˆ©è¦‹å¤§äºº','äº¢é¾æœ‰æ‚”'],
  'å¤ç‚ºåœ°':['å±¥éœœï¼Œå …å†°è‡³','ç›´æ–¹å¤§ï¼Œä¸ç¿’ç„¡ä¸åˆ©','å«ç« å¯è²ï¼Œæˆ–å¾ç‹äº‹ï¼Œç„¡æˆæœ‰çµ‚','æ‹¬å›Šï¼Œç„¡å’ç„¡è­½','é»ƒè£³ï¼Œå…ƒå‰','é¾æˆ°äºé‡ï¼Œå…¶è¡€ç„é»ƒ'],
  'åœ°å¤©æ³°':['æ‹”èŒ…èŒ¹ï¼Œä»¥å…¶å½™ï¼Œå¾å‰','åŒ…è’ï¼Œç”¨é¦®æ²³ï¼Œä¸ééº','ç„¡å¹³ä¸é™‚ï¼Œç„¡å¾€ä¸å¾©ï¼Œè‰±è²ç„¡å’','ç¿©ç¿©ä¸å¯Œï¼Œä»¥å…¶é„°ï¼Œä¸æˆ’ä»¥å­š','å¸ä¹™æ­¸å¦¹ï¼Œä»¥ç¥‰å…ƒå‰','åŸå¾©äºéšï¼Œå‹¿ç”¨å¸«ï¼Œè‡ªé‚‘å‘Šå‘½'],
  'å¤©åœ°å¦':['æ‹”èŒ…èŒ¹ï¼Œä»¥å…¶å½™ï¼Œè²å‰äº¨','åŒ…æ‰¿ï¼Œå°äººå‰ï¼Œå¤§äººå¦äº¨','åŒ…ç¾','æœ‰å‘½ç„¡å’ï¼Œç–‡é›¢ç¥‰','ä¼‘å¦ï¼Œå¤§äººå‰','å‚¾å¦ï¼Œå…ˆå¦å¾Œå–œ'],
};

function getYaoCi(guaName, yaoNum){
  const ci=YAO_CI[guaName];
  if(ci&&ci[yaoNum-1])return ci[yaoNum-1];
  return'ï¼ˆçˆ»è¾­è³‡æ–™åº«æ“´å……ä¸­ï¼‰';
}

/* =============================================================
   ENHANCEMENT 3: å¡”ç¾…å•é¡Œé¡å‹äº¤å‰è§£è®€
   ============================================================= */
const TAROT_TYPE_MEANING={
  love:{
    0:{up:'æ„›æƒ…ä¸­éœ€è¦å‹‡æ°£è¸å‡ºèˆ’é©åœˆï¼Œæ–°æˆ€æƒ…å³å°‡é–‹å§‹ã€‚',rv:'æ„Ÿæƒ…ä¸Šå¤ªééš¨æ„ï¼Œéœ€è¦èªçœŸçœ‹å¾…ã€‚'},
    6:{up:'çœŸæ„›é™è‡¨ï¼Œé‡è¦çš„æ„Ÿæƒ…æŠ‰æ“‡å°‡å¸¶ä¾†å¹¸ç¦ã€‚',rv:'æ„Ÿæƒ…åƒ¹å€¼è§€è¡çªï¼Œéœ€è¦æºé€šã€‚'},
    8:{up:'ç”¨è€å¿ƒå’Œæº«æŸ”ç¶“ç‡Ÿæ„Ÿæƒ…ï¼Œä»¥æŸ”å…‹å‰›ã€‚',rv:'åœ¨æ„Ÿæƒ…ä¸­ç¼ºä¹å®‰å…¨æ„Ÿã€‚'},
    19:{up:'æ„Ÿæƒ…æ˜æœ—åŒ–ï¼Œé›™æ–¹é—œä¿‚é€²å…¥ç”œèœœæœŸã€‚',rv:'æ„Ÿæƒ…ä¸­æœ‰çŸ­æš«çš„é™°éœ¾ï¼Œä½†çµ‚æœƒéå»ã€‚'}
  },
  career:{
    1:{up:'ä½ æ“æœ‰æˆåŠŸæ‰€éœ€çš„æ‰€æœ‰èƒ½åŠ›ï¼Œå¤§è†½ç™¼æ®ã€‚',rv:'è·å ´æŠ€èƒ½éœ€è¦ç²¾é€²ï¼Œé¿å…æµ®èª‡ã€‚'},
    4:{up:'äº‹æ¥­ä¸Šç²å¾—æ¬Šå¨åœ°ä½ï¼Œé©åˆç®¡ç†è·ã€‚',rv:'å·¥ä½œä¸­æ§åˆ¶æ¬²å¤ªå¼·ï¼Œè¦å­¸æœƒæˆæ¬Šã€‚'},
    7:{up:'äº‹æ¥­çªç ´ï¼Œé å …å®šæ„å¿—å…‹æœå›°é›£ã€‚',rv:'å·¥ä½œæ–¹å‘ä¸æ˜ï¼Œéœ€é‡æ–°å®šä½ã€‚'},
    10:{up:'äº‹æ¥­è¿ä¾†è½‰æŠ˜é»ï¼Œå¥½é‹é™è‡¨ã€‚',rv:'äº‹æ¥­é‡åˆ°ç“¶é ¸ï¼Œéœ€è€å¿ƒç­‰å¾…ã€‚'}
  },
  wealth:{
    3:{up:'è²¡é‹è±é¥’ï¼ŒæŠ•è³‡å›å ±è‰¯å¥½ã€‚',rv:'èŠ±è²»éåº¦ï¼Œéœ€è¦ç¯€åˆ¶ã€‚'},
    9:{up:'æ·±æ€ç†Ÿæ…®å¾Œåšè²¡å‹™æ±ºå®šï¼Œç©©å¥ç²åˆ©ã€‚',rv:'æŠ•è³‡åˆ¤æ–·åŠ›ä¸‹é™ï¼Œæš«ç·©å¤§é¡æ”¯å‡ºã€‚'},
    21:{up:'è²¡å‹™ç›®æ¨™é”æˆï¼Œåœ“æ»¿è±æ”¶ã€‚',rv:'æ”¶å…¥ä¸ç©©å®šï¼Œèª¿æ•´ç†è²¡ç­–ç•¥ã€‚'}
  }
};

function getTarotTypeMeaning(cardId, isUp, type){
  const tm=TAROT_TYPE_MEANING[type];
  if(tm&&tm[cardId]){
    return isUp?tm[cardId].up:tm[cardId].rv;
  }
  return null;
}

/* =============================================================
   ENHANCEMENT 4: ç´«å¾®äº®åº¦ï¼ˆå»Ÿæ—ºåˆ©å¹³é™·ï¼‰
   ============================================================= */
const ZW_BRIGHTNESS={
  // ç°¡åŒ–ï¼šç´«å¾®åœ¨å„åœ°æ”¯çš„å»Ÿæ—ºï¼ˆå­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥ï¼‰
  'ç´«å¾®':['å»Ÿ','æ—º','å¾—åœ°','å¹³','æ—º','å¾—åœ°','å»Ÿ','æ—º','å¾—åœ°','å¹³','å¾—åœ°','æ—º'],
  'å¤©æ©Ÿ':['å¹³','å»Ÿ','æ—º','å»Ÿ','å¾—åœ°','å¹³','é™·','å¾—åœ°','æ—º','å¾—åœ°','å¹³','å»Ÿ'],
  'å¤ªé™½':['é™·','é™·','å¹³','æ—º','å»Ÿ','å»Ÿ','å»Ÿ','æ—º','å¹³','é™·','é™·','é™·'],
  'æ­¦æ›²':['æ—º','å»Ÿ','å¾—åœ°','é™·','å¹³','æ—º','å¾—åœ°','å¾—åœ°','å»Ÿ','æ—º','å¾—åœ°','å¹³'],
  'å¤©åŒ':['æ—º','å¹³','é™·','å¹³','å¾—åœ°','å¾—åœ°','é™·','å¹³','å¾—åœ°','æ—º','å»Ÿ','æ—º'],
  'å»‰è²':['å¾—åœ°','å¹³','æ—º','é™·','å¾—åœ°','å¹³','å¾—åœ°','æ—º','å»Ÿ','å¾—åœ°','å¹³','æ—º'],
  'å¤©åºœ':['å»Ÿ','å¾—åœ°','æ—º','å¾—åœ°','å¹³','å»Ÿ','æ—º','å¾—åœ°','æ—º','å»Ÿ','å¾—åœ°','æ—º'],
  'å¤ªé™°':['å»Ÿ','å»Ÿ','æ—º','æ—º','å¾—åœ°','å¹³','é™·','é™·','é™·','å¹³','å¾—åœ°','æ—º'],
  'è²ªç‹¼':['æ—º','å¹³','å»Ÿ','æ—º','å¾—åœ°','å¾—åœ°','é™·','å¹³','å¾—åœ°','æ—º','å»Ÿ','æ—º'],
  'å·¨é–€':['æ—º','å»Ÿ','å¾—åœ°','å¹³','é™·','æ—º','å¾—åœ°','å¹³','å»Ÿ','æ—º','å¾—åœ°','å¹³'],
  'å¤©ç›¸':['å»Ÿ','å¾—åœ°','æ—º','æ—º','å¹³','å¾—åœ°','æ—º','å¾—åœ°','å»Ÿ','å¾—åœ°','æ—º','å¾—åœ°'],
  'å¤©æ¢':['å»Ÿ','æ—º','å¾—åœ°','å¹³','å¾—åœ°','æ—º','å»Ÿ','å¾—åœ°','æ—º','å¹³','å¾—åœ°','æ—º'],
  'ä¸ƒæ®º':['å»Ÿ','æ—º','å¹³','å¾—åœ°','æ—º','å¾—åœ°','å»Ÿ','å¾—åœ°','æ—º','å¹³','å¾—åœ°','æ—º'],
  'ç ´è»':['å¹³','æ—º','å»Ÿ','å¾—åœ°','æ—º','å¾—åœ°','å¹³','æ—º','å¾—åœ°','æ—º','å»Ÿ','å¾—åœ°']
};

function getStarBrightness(starName, zhiBranch){
  const idx=DZ.indexOf(zhiBranch);
  if(idx<0)return'';
  const arr=ZW_BRIGHTNESS[starName];
  if(!arr)return'';
  return arr[idx]||'';
}

/* =============================================================
   ENHANCEMENT 5: å¢å¼· renderZiwei åŠ å…¥äº®åº¦
   ============================================================= */
const _origRenderZiwei = renderZiwei;
renderZiwei = function(){
  _origRenderZiwei();
  // Post-process: add brightness tags
  if(!S.ziwei)return;
  S.ziwei.palaces.forEach(p=>{
    p.stars.forEach(s=>{
      if(s.type==='major'){
        s.brightness=getStarBrightness(s.name, p.branch);
      }
    });
  });
  // Re-render grid with brightness
  const zw=S.ziwei;
  const order=[[3,4,5,6],[2,-1,-1,7],[1,-1,-1,8],[0,11,10,9]];
  let html='<div class="zw-grid">';
  for(let row=0;row<4;row++){
    for(let col=0;col<4;col++){
      const idx=order[row][col];
      if(idx===-1){
        if(row===1&&col===1){
          html+=`<div class="zw-cell zw-center" style="grid-column:2/4;grid-row:2/4">
            <div class="serif text-gold" style="font-size:1.1rem;margin-bottom:var(--sp-sm)">ç´«å¾®æ–—æ•¸</div>
            <p class="text-dim text-xs">å‘½å®®ï¼š${DZ[zw.mingIdx]}</p>
            <p class="text-dim text-xs">${zw.yGan}${zw.yZhi}å¹´ ï½œ ${zw.wuxingJu}å±€</p></div>`;
        }
        continue;
      }
      const palace=zw.palaces.find(p=>DZ.indexOf(p.branch)===idx);
      if(!palace){html+=`<div class="zw-cell"><span class="zw-palace">${DZ[idx]}</span></div>`;continue}
      const isMing=palace.isMing;
      html+=`<div class="zw-cell${isMing?' active-palace':''}">
        <div class="zw-palace">${palace.name}${isMing?' â­':''}</div>
        <div class="zw-branch">${palace.branch}</div><div class="zw-stars">`;
      palace.stars.forEach(s=>{
        const cls=s.type==='major'?'major':s.type==='sha'?'text-danger':'minor';
        const bright=s.brightness?`<span class="text-xs text-muted">(${s.brightness})</span>`:'';
        html+=`<span class="zw-star ${cls}">${s.name}${bright}</span>`;
        if(s.hua)html+=`<span class="zw-hua">${s.hua}</span>`;
      });
      html+=`</div></div>`;
    }
  }
  html+='</div>';
  document.getElementById('d-ziwei-grid').innerHTML=html;
};

/* =============================================================
   ENHANCEMENT 6: å¢å¼· renderBazi ä½¿ç”¨æ–°å¤§é‹
   ============================================================= */
const _origRenderBazi = renderBazi;
renderBazi = function(){
  _origRenderBazi();
  renderDayunEnhanced();
};

/* =============================================================
   ENHANCEMENT 7: å¢å¼· renderTarot åŠ å…¥é¡å‹äº¤å‰è§£è®€
   ============================================================= */
const _origRenderTarot = renderTarot;
renderTarot = function(){
  if(!S.tarot.drawn.length){document.getElementById('r-tarot').innerHTML='<p class="text-dim">æœªé€²è¡Œå¡”ç¾…æŠ½ç‰Œ</p>';return}
  const type=S.form.type;
  document.getElementById('r-tarot').innerHTML=S.tarot.drawn.map((c,i)=>{
    const typeMeaning=getTarotTypeMeaning(c.id,c.isUp,type);
    return`<div style="display:flex;gap:var(--sp-sm);align-items:flex-start;padding:var(--sp-sm) 0;border-bottom:1px solid var(--c-border)">
      <span class="tag tag-gold" style="flex:0 0 auto">${i+1}</span>
      <div><strong class="text-gold">${c.pos}</strong>ï¼š${c.n} <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'æ­£':'é€†'}</span>
      <p class="text-sm text-dim">${c.isUp?c.up:c.rv}</p>
      ${typeMeaning?`<p class="text-sm mt-sm" style="color:var(--c-gold-light)"><i class="fas fa-star" style="font-size:.6rem"></i> ${getTypeLabel(type)}è§£è®€ï¼š${typeMeaning}</p>`:''}</div>
    </div>`;
  }).join('');
};

/* =============================================================
   ENHANCEMENT 8: å¢å¼·æ¢…èŠ±çµæœåŠ å…¥çˆ»è¾­
   ============================================================= */
const _origShowMH = showMH;
showMH = function(r){
  _origShowMH(r);
  // Append yao ci
  const yaoCi=getYaoCi(r.ben.n, r.dong);
  const detailEl=document.getElementById('mh-detail');
  if(detailEl){
    detailEl.innerHTML+=`<div class="divider"></div><p><strong>å‹•çˆ»çˆ»è¾­ï¼ˆç¬¬${r.dong}çˆ»ï¼‰ï¼š</strong><span class="serif text-gold">${yaoCi}</span></p>`;
  }
};

/* =============================================================
   ENHANCEMENT 9: åˆ—å° / åˆ†äº«
   ============================================================= */
function printResult(){
  window.print();
}

function shareResult(){
  const prob=document.getElementById('r-vprob').textContent;
  const label=document.getElementById('r-vlabel').textContent;
  const text=`éœæœˆä¹‹å…‰å åœçµæœï¼š${label} ${prob}\nå•é¡Œï¼š${S.form.question}\n\nï¼ˆæ›´å¤šè©³æƒ…è«‹ä½¿ç”¨éœæœˆä¹‹å…‰èƒ½é‡å åœå„€ï¼‰`;
  if(navigator.share){
    navigator.share({title:'éœæœˆä¹‹å…‰å åœçµæœ',text}).catch(()=>{});
  }else{
    navigator.clipboard.writeText(text).then(()=>alert('çµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼')).catch(()=>{});
  }
}
/* =============================================================
   CUSTOM ORDER MODAL + FLOATING BUTTONS
   ============================================================= */
function openCustomModal(){
  document.getElementById('custom-modal').style.display='flex';
  document.getElementById('custom-form').style.display='block';
  document.getElementById('cf-sent').classList.add('hidden');
  // Pre-fill from analysis if available
  if(S.form.name)document.getElementById('cf-name').value=S.form.name;
  if(S.form.bdate)document.getElementById('cf-bday').value=S.form.bdate;
  if(S.form.question)document.getElementById('cf-question').value=S.form.question;
  document.body.style.overflow='hidden';
}
function closeCustomModal(){
  document.getElementById('custom-modal').style.display='none';
  document.body.style.overflow='';
}
// Close on overlay click
document.addEventListener('click',function(e){
  if(e.target.id==='custom-modal')closeCustomModal();
});

function submitCustomForm(e){e.preventDefault()} // deprecated, kept for safety

function prepareCustomSubmit(){
  const name=document.getElementById('cf-name').value.trim();
  if(!name)return false;

  // Set subject with name
  document.getElementById('cf-subject-hidden').value='ã€å®¢è£½è©¢å•ã€‘'+name+' - èƒ½é‡æ‰‹éˆ';

  // Set _next to current page so user returns after submit
  document.getElementById('cf-next-url').value=window.location.href;

  // Build analysis summary
  let summary='';
  if(S.bazi){
    summary+='æ—¥ä¸»ï¼š'+S.bazi.dm+'ï¼ˆ'+S.bazi.dmEl+'ï¼‰| èº«'+(S.bazi.strong?'å¼·':'å¼±')+'\n';
    summary+='å–œç”¨ç¥ï¼š'+S.bazi.fav.join('ã€')+'\n';
    summary+='å¿Œç¥ï¼š'+S.bazi.unfav.join('ã€')+'\n';
    const curDy=S.bazi.dayun.find(d=>d.isCurrent);
    if(curDy)summary+='ç•¶å‰å¤§é‹ï¼š'+curDy.gz+'ï¼ˆ'+curDy.level+'ï¼‰\n';
    if(S.bazi.shensha.length)summary+='ç¥ç…ï¼š'+S.bazi.shensha.join('ã€')+'\n';
    if(S.meihua)summary+='æ¢…èŠ±ï¼š'+S.meihua.ben.n+'ï¼Œé«”ç”¨'+S.meihua.ty.r+'ï¼ˆ'+S.meihua.ty.f+'ï¼‰\n';
    if(S.tarot.drawn.length)summary+='å¡”ç¾…æ ¸å¿ƒç‰Œï¼š'+S.tarot.drawn[0].n+'ï¼ˆ'+(S.tarot.drawn[0].isUp?'æ­£ä½':'é€†ä½')+'ï¼‰\n';
    const prob=document.getElementById('r-vprob');
    if(prob&&prob.textContent!=='0%')summary+='ç¶œåˆæ©Ÿç‡ï¼š'+prob.textContent+'\n';
  }
  document.getElementById('cf-analysis-hidden').value=summary||'ï¼ˆä½¿ç”¨è€…æœªå®Œæˆå åœåˆ†æï¼‰';

  // Change button to loading
  const btn=document.getElementById('cf-submit-btn');
  btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> é€å‡ºä¸­...';
  btn.disabled=true;

  return true; // allow form submission to formsubmit.co
}

function copyCfContent(){} // no longer needed but kept for safety

function toggleFab(){
  document.getElementById('fab-menu').classList.toggle('hidden');
}

/* =============================================================
   PWA: Inline Manifest + Service Worker Registration
   ============================================================= */
(function(){
  // Inline manifest as blob
  const manifest={
    name:'éœæœˆä¹‹å…‰èƒ½é‡å åœå„€',
    short_name:'éœæœˆå åœ',
    description:'æ•´åˆå…«å­—ã€ç´«å¾®æ–—æ•¸ã€æ¢…èŠ±æ˜“æ•¸ã€å¡”ç¾…ç‰Œçš„å¤šç¶­åº¦å‘½ç†åˆ†æ',
    start_url:'./',
    display:'standalone',
    background_color:'#0d0404',
    theme_color:'#0d0404',
    orientation:'portrait-primary',
    lang:'zh-TW',
    icons:[{src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">â˜½</text></svg>',sizes:'any',type:'image/svg+xml'}]
  };
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const link=document.createElement('link');
  link.rel='manifest';
  link.href=URL.createObjectURL(blob);
  document.head.appendChild(link);
})();

/* =============================================================
   KEYBOARD: Escape closes modal
   ============================================================= */
document.addEventListener('keydown',function(e){
  if(e.key==='Escape'){
    closeCustomModal();
    const fabMenu=document.getElementById('fab-menu');
    if(fabMenu&&!fabMenu.classList.contains('hidden'))fabMenu.classList.add('hidden');
  }
});
/* =============================================================
   FEATURE 1: å•†å“åŒ–æ°´æ™¶æ¨è–¦ï¼ˆå«è³£å ´é€£çµ + å•†å“é¡åˆ¥ï¼‰
   ============================================================= */
const PRODUCT_DB={
  é‡‘:[
    {n:'ç™½æ°´æ™¶æ‰‹éˆ',cat:'æ‰‹éˆ',icon:'ğŸ’',el:'é‡‘',d:'æ·¨åŒ–èƒ½é‡å ´ï¼Œå¢å¼·æ€ç¶­æ¸…æ™°åº¦',price:'$580-$1,280',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'å·¦æ‰‹ä½©æˆ´',img:''},
    {n:'éˆ¦æ™¶åŠå¢œ',cat:'åŠå¢œ',icon:'âš¡',el:'é‡‘',d:'æ‹›æ­£è²¡åè²¡ï¼Œå¢å¼·é ˜å°æ°£é­„',price:'$1,580-$3,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'è²¼è¿‘å¿ƒè¼ªä½©æˆ´',img:''},
    {n:'ç™½æ°´æ™¶åŸçŸ³',cat:'åŸçŸ³',icon:'ğŸ”®',el:'é‡‘',d:'æ·¨åŒ–ç©ºé–“ç£å ´ï¼Œé®å®…é–‹é‹',price:'$380-$1,200',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'æ”¾å®¢å»³æˆ–æ›¸æ¡Œ',img:''}
  ],
  æœ¨:[
    {n:'ç¶ å¹½éˆæ‰‹éˆ',cat:'æ‰‹éˆ',icon:'ğŸ’š',el:'æœ¨',d:'æ‹›æ­£è²¡ï¼Œäº‹æ¥­ç©©æ­¥ä¸Šå‡',price:'$680-$2,200',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'å·¦æ‰‹ä½©æˆ´',img:''},
    {n:'æ±é™µç‰åŠå¢œ',cat:'åŠå¢œ',icon:'ğŸŒ¿',el:'æœ¨',d:'èˆ’ç·©å£“åŠ›ï¼Œå¸¶ä¾†å¥½é‹',price:'$480-$1,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'é …éŠä½©æˆ´',img:''},
    {n:'ç¿¡ç¿ åŸçŸ³æ“ºä»¶',cat:'åŸçŸ³',icon:'ğŸŸ¢',el:'æœ¨',d:'è­·èº«è¾Ÿé‚ªï¼Œå¢å¼·å¥åº·é‹',price:'$1,200-$5,000',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'æ”¾æ›¸æ¡Œæˆ–è²¡ä½',img:''}
  ],
  æ°´:[
    {n:'æµ·è—å¯¶æ‰‹éˆ',cat:'æ‰‹éˆ',icon:'ğŸ’™',el:'æ°´',d:'å¢å¼·æºé€šåŠ›ï¼Œå¹³éœæƒ…ç·’',price:'$780-$2,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'å·¦æ‰‹ä½©æˆ´',img:''},
    {n:'æœˆå…‰çŸ³åŠå¢œ',cat:'åŠå¢œ',icon:'ğŸŒ™',el:'æ°´',d:'å¢å¼·ç›´è¦ºï¼ŒåŠ©æ„Ÿæƒ…é‹',price:'$580-$1,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'æ»¿æœˆä½©æˆ´æ›´ä½³',img:''},
    {n:'è—ç´‹ç‘ªç‘™åŸçŸ³',cat:'åŸçŸ³',icon:'ğŸ”µ',el:'æ°´',d:'ç©©å®šæƒ…ç·’ï¼Œå¢å¼·è¡¨é”åŠ›',price:'$350-$980',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'æ”¾è‡¥å®¤åºŠé ­',img:''}
  ],
  ç«:[
    {n:'ç´…ç‘ªç‘™æ‰‹éˆ',cat:'æ‰‹éˆ',icon:'â¤ï¸',el:'ç«',d:'æ¿€ç™¼ç†±æƒ…ï¼Œå¢å¼·è¡Œå‹•åŠ›èˆ‡å‹‡æ°£',price:'$480-$1,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'å³æ‰‹ä½©æˆ´å¢è¡Œå‹•åŠ›',img:''},
    {n:'çŸ³æ¦´çŸ³åŠå¢œ',cat:'åŠå¢œ',icon:'ğŸ”´',el:'ç«',d:'æå‡æ´»åŠ›ï¼Œå¢å¼·æ¡ƒèŠ±é‹',price:'$680-$2,200',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'è²¼èº«ä½©æˆ´',img:''},
    {n:'ç´…ç¢§ç’½åŸçŸ³',cat:'åŸçŸ³',icon:'ğŸ’—',el:'ç«',d:'å¼·åŠ›æ‹›æ¡ƒèŠ±ï¼Œå¢å¼·äººéš›é­…åŠ›',price:'$1,500-$4,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'æ”¾æ¡ƒèŠ±ä½',img:''}
  ],
  åœŸ:[
    {n:'é»ƒæ°´æ™¶æ‰‹éˆ',cat:'æ‰‹éˆ',icon:'ğŸ’›',el:'åœŸ',d:'æ‹›åè²¡ï¼Œæå‡è‡ªä¿¡èˆ‡é­…åŠ›',price:'$580-$1,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'å·¦æ‰‹ä½©æˆ´',img:''},
    {n:'è™çœ¼çŸ³åŠå¢œ',cat:'åŠå¢œ',icon:'ğŸŸ¤',el:'åœŸ',d:'å¢å¼·æ±ºæ–·åŠ›ï¼Œæ‹›è²¡è¾Ÿé‚ª',price:'$480-$1,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'å‡ºé–€ä½©æˆ´',img:''},
    {n:'èŒ¶æ™¶åŸçŸ³æ“ºä»¶',cat:'åŸçŸ³',icon:'ğŸ«–',el:'åœŸ',d:'æ’é™¤è² èƒ½é‡ï¼Œç©©å®šå¿ƒæ€§',price:'$680-$2,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'æ”¾å®¢å»³',img:''}
  ]
};

// å•é¡Œé¡å‹ç‰¹æ®Šå•†å“
const TYPE_PRODUCTS={
  love:[{n:'ç²‰æ™¶æ‰‹éˆ',cat:'æ‰‹éˆ',icon:'ğŸ’•',el:'åœŸ',d:'æ‹›æ¡ƒèŠ±é¦–é¸ï¼å¢å¼·ç•°æ€§ç·£',price:'$480-$1,500',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œç´„æœƒå¿…å‚™'}],
  career:[{n:'éˆ¦æ™¶æ‰‹éˆ',cat:'æ‰‹éˆ',icon:'âš¡',el:'é‡‘',d:'äº‹æ¥­æ™‰å‡é¦–é¸ï¼é ˜å°åŠ›UP',price:'$1,800-$5,000',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'é¢è©¦/é–‹æœƒä½©æˆ´'}],
  wealth:[{n:'ç¶ å¹½éˆèšå¯¶ç›†',cat:'åŸçŸ³',icon:'ğŸ’°',el:'æœ¨',d:'æ‹›æ­£è²¡åè²¡ï¼æ”¾è¾¦å…¬æ¡Œè¶…æ—º',price:'$1,200-$3,800',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'æ”¾è²¡ä½æˆ–æ”¶éŠ€å°'}],
  health:[{n:'ç´«æ°´æ™¶æ‰‹éˆ',cat:'æ‰‹éˆ',icon:'ğŸ’œ',el:'ç«',d:'å®‰ç¥åŠ©çœ ï¼Œä¿ƒé€²èº«å¿ƒå¹³è¡¡',price:'$580-$1,800',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'ç¡å‰ä½©æˆ´æˆ–æ”¾æ•ä¸‹'}]
};

function renderProductCrystal(bazi,type){
  const need=bazi.fav[0];
  const base=PRODUCT_DB[need]||PRODUCT_DB['åœŸ'];
  const special=TYPE_PRODUCTS[type]||[];
  const all=[...special,...base];
  const display=all.slice(0,4);

  const catIcon={æ‰‹éˆ:'âŒš',åŠå¢œ:'ğŸ“¿',åŸçŸ³:'ğŸ’',å®¢è£½:'âœ¨'};

  document.getElementById('r-crystal').innerHTML=`
    <div class="crystal-rec-header">
      <p>æ ¹æ“šä½ çš„å‘½ç›¤ï¼ˆå–œ <span class="tag tag-gold">${need}è¡Œ</span>ï¼‰å’Œå•é¡Œï¼ˆ<span class="tag tag-blue">${getTypeLabel(type)}</span>ï¼‰ï¼Œç‚ºä½ é…å°ï¼š</p>
    </div>
    <div class="product-grid">${display.map(p=>`
      <div class="product-card">
        <div class="product-icon">${p.icon}</div>
        <div class="product-body">
          <div class="product-name">${p.n}</div>
          <div class="product-meta">
            <span class="tag tag-gold text-xs">${catIcon[p.cat]||''} ${p.cat}</span>
            <span class="el-tag el-${p.el} text-xs">${p.el}è¡Œ</span>
          </div>
          <p class="product-desc">${p.d}</p>
          <p class="product-price">${p.price}</p>
          <p class="product-wear"><i class="fas fa-hand-holding-heart"></i> ${p.wear}</p>
          <div class="product-actions">
            <a href="${p.shopee}" target="_blank" rel="noopener" class="product-btn shopee"><i class="fas fa-shopping-cart"></i> è¦çš®</a>
            <a href="${p.seven}" target="_blank" rel="noopener" class="product-btn seven"><i class="fas fa-box"></i> 7-11</a>
          </div>
        </div>
      </div>`).join('')}
    </div>
    <div class="custom-cta mt-lg">
      <button class="btn btn-gold btn-full" onclick="openCustomModal()">
        <i class="fas fa-magic"></i> æƒ³è¦ã€Œä¾ä½ äº”è¡Œå°ˆå±¬æ­é…ã€ï¼Ÿé»æˆ‘å®¢è£½æ‰‹éˆ
      </button>
      <p class="text-xs text-muted mt-sm text-center">é ç®—ç‰ˆ $1,000 èµ· ï½œ 48hr å…§å›è¦†</p>
    </div>
    <p class="text-xs text-muted mt-md text-center"><i class="fas fa-info-circle"></i> æœ¬å»ºè­°åƒ…ä¾›èƒ½é‡æ ¡æº–åƒè€ƒï¼Œä¸å…·é†«ç™‚æˆ–å‘½é‹ä¿è­‰æ•ˆåŠ›ã€‚</p>`;
}

/* =============================================================
   FEATURE 2: çµæœåœ–å¡ Canvas â†’ å­˜åœ–ï¼ˆå« QR å°æµï¼‰
   ============================================================= */
function generateResultCard(){
  const canvas=document.createElement('canvas');
  const W=750,H=1334; // IG story size
  canvas.width=W;canvas.height=H;
  const ctx=canvas.getContext('2d');

  // Background gradient
  const grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,'#2D0A0A');grad.addColorStop(0.5,'#4A0000');grad.addColorStop(1,'#0d0404');
  ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);

  // Decorative border
  ctx.strokeStyle='rgba(212,175,55,0.4)';ctx.lineWidth=3;
  ctx.strokeRect(24,24,W-48,H-48);
  ctx.strokeStyle='rgba(212,175,55,0.15)';ctx.lineWidth=1;
  ctx.strokeRect(36,36,W-72,H-72);

  // Header
  ctx.fillStyle='#D4AF37';ctx.font='bold 32px "Noto Serif TC",serif';ctx.textAlign='center';
  ctx.fillText('â˜½ éœæœˆä¹‹å…‰èƒ½é‡å åœå„€',W/2,80);
  ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.6)';
  ctx.fillText('ä½ çš„å°ˆå±¬å‘½ç†åˆ†æçµæœ',W/2,115);

  // Divider
  drawGoldLine(ctx,60,140,W-60);

  // Question
  ctx.textAlign='left';ctx.font='bold 22px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('ğŸ“‹ å•é¡Œ',60,180);
  ctx.font='18px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.9)';
  wrapText(ctx,S.form.question||'ç¶œåˆé‹å‹¢',60,210,W-120,26);

  // Verdict
  const prob=document.getElementById('r-vprob')?document.getElementById('r-vprob').textContent:'50%';
  const label=document.getElementById('r-vlabel')?document.getElementById('r-vlabel').textContent:'åˆ†æä¸­';
  const y1=290;
  ctx.fillStyle='rgba(212,175,55,0.1)';roundRect(ctx,48,y1-10,W-96,100,12);ctx.fill();
  ctx.strokeStyle='rgba(212,175,55,0.3)';ctx.stroke();
  ctx.font='bold 40px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';ctx.textAlign='center';
  ctx.fillText(prob,W/2,y1+35);
  ctx.font='20px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.85)';
  ctx.fillText(label,W/2,y1+70);

  // BaZi summary
  const y2=420;
  ctx.textAlign='left';ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('ğŸ® å…«å­—å‘½ç†',60,y2);
  if(S.bazi){
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.8)';
    const p=S.bazi.pillars;
    ctx.fillText(`å››æŸ±ï¼š${p.year.gan}${p.year.zhi} ${p.month.gan}${p.month.zhi} ${p.day.gan}${p.day.zhi} ${p.hour.gan}${p.hour.zhi}`,60,y2+30);
    ctx.fillText(`æ—¥ä¸»ï¼š${S.bazi.dm}ï¼ˆ${S.bazi.dmEl}ï¼‰ï½œ èº«${S.bazi.strong?'å¼·':'å¼±'} ï½œ å–œç”¨ï¼š${S.bazi.fav.join('ã€')}`,60,y2+58);
    const curDy=S.bazi.dayun.find(d=>d.isCurrent);
    if(curDy)ctx.fillText(`ç•¶å‰å¤§é‹ï¼š${curDy.gz}ï¼ˆ${curDy.level}ï¼‰`,60,y2+86);
  }

  // Five elements bar
  const y3=560;
  ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('ğŸ”® äº”è¡Œèƒ½é‡',60,y3);
  if(S.bazi){
    const els=['é‡‘','æœ¨','æ°´','ç«','åœŸ'];
    const colors={é‡‘:'#c0c0c0',æœ¨:'#22c55e',æ°´:'#3b82f6',ç«:'#ef4444',åœŸ:'#a78b5a'};
    els.forEach((e,i)=>{
      const bx=60,by=y3+25+i*32,bw=W-200,pct=S.bazi.ep[e]||0;
      ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle=colors[e];
      ctx.fillText(e,bx,by+14);
      ctx.fillStyle='rgba(255,255,255,0.1)';roundRect(ctx,bx+30,by,bw,18,4);ctx.fill();
      ctx.fillStyle=colors[e];roundRect(ctx,bx+30,by,bw*pct/100,18,4);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.7)';ctx.fillText(pct+'%',bx+bw+40,by+14);
    });
  }

  // Crystal recommendation
  const y4=760;
  ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('ğŸ’ å°ˆå±¬æ°´æ™¶è™•æ–¹',60,y4);
  if(S.bazi){
    const need=S.bazi.fav[0];
    const prods=PRODUCT_DB[need]||PRODUCT_DB['åœŸ'];
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.85)';
    prods.slice(0,3).forEach((p,i)=>{
      ctx.fillText(`${p.icon} ${p.n}ï¼ˆ${p.cat}ï¼‰â€” ${p.d}`,60,y4+30+i*28);
    });
  }

  // Meihua + Tarot summary
  const y5=880;
  if(S.meihua){
    ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
    ctx.fillText('â˜¯ æ¢…èŠ±æ˜“æ•¸',60,y5);
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.8)';
    ctx.fillText(`${S.meihua.ben.n} â†’ ${S.meihua.bian.n}ï½œé«”ç”¨${S.meihua.ty.r}ï¼ˆ${S.meihua.ty.f}ï¼‰`,60,y5+28);
  }
  if(S.tarot.drawn.length){
    const yt=y5+70;
    ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
    ctx.fillText('ğŸƒ å¡”ç¾…ç‰Œ',60,yt);
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.8)';
    const core=S.tarot.drawn[0],fin=S.tarot.drawn[9];
    ctx.fillText(`æ ¸å¿ƒï¼š${core.n}ï¼ˆ${core.isUp?'æ­£':'é€†'}ï¼‰ï½œ çµæœï¼š${fin?fin.n:''}ï¼ˆ${fin?(fin.isUp?'æ­£':'é€†'):''}ï¼‰`,60,yt+28);
  }

  // Divider
  drawGoldLine(ctx,60,1060,W-60);

  // QR Code area (text-based since we can't load QR library)
  const yq=1090;
  ctx.fillStyle='rgba(255,255,255,0.05)';roundRect(ctx,W/2-160,yq,320,100,12);ctx.fill();
  ctx.strokeStyle='rgba(212,175,55,0.3)';ctx.stroke();
  ctx.font='bold 16px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';ctx.textAlign='center';
  ctx.fillText('ğŸ” å…è²»æ¸¬ä½ çš„å‘½ç†çµæœ',W/2,yq+30);
  ctx.font='14px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.7)';
  ctx.fillText('éœæœˆä¹‹å…‰èƒ½é‡å åœå„€',W/2,yq+55);
  ctx.font='12px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.5)';
  ctx.fillText(window.location.href.split('?')[0],W/2,yq+78);

  // Footer
  ctx.font='12px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.35)';
  ctx.fillText('ğŸ›’ è¦çš®: tw.shp.ee/2n5Mo2w ï½œ ğŸ“¦ 7-11è³£è²¨ä¾¿: æœå°‹ã€Œéœæœˆä¹‹å…‰ã€',W/2,H-50);
  ctx.fillText(`ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleDateString('zh-TW')}`,W/2,H-30);

  return canvas;
}

function drawGoldLine(ctx,x1,y,x2){
  const g=ctx.createLinearGradient(x1,y,x2,y);
  g.addColorStop(0,'transparent');g.addColorStop(0.5,'rgba(212,175,55,0.6)');g.addColorStop(1,'transparent');
  ctx.strokeStyle=g;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(x1,y);ctx.lineTo(x2,y);ctx.stroke();
}

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

function wrapText(ctx,text,x,y,maxW,lineH){
  const chars=[...text];let line='';
  for(let i=0;i<chars.length;i++){
    const test=line+chars[i];
    if(ctx.measureText(test).width>maxW&&line){ctx.fillText(line,x,y);y+=lineH;line=chars[i]}
    else line=test;
  }
  if(line)ctx.fillText(line,x,y);
}

function saveResultCard(){
  const canvas=generateResultCard();
  canvas.toBlob(function(blob){
    if(!blob)return;
    // Try native share first (mobile)
    if(navigator.share&&navigator.canShare){
      const file=new File([blob],'éœæœˆå åœçµæœ.png',{type:'image/png'});
      if(navigator.canShare({files:[file]})){
        navigator.share({title:'æˆ‘çš„éœæœˆå åœçµæœ',text:'å…è²»æ¸¬ä½ çš„å‘½ç†çµæœï¼',files:[file]}).catch(()=>downloadBlob(blob));
        return;
      }
    }
    downloadBlob(blob);
  },'image/png');
}

function downloadBlob(blob){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='éœæœˆå åœçµæœ_'+Date.now()+'.png';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),3000);
}

/* =============================================================
   FEATURE 3: åˆ†äº«è§£é–ã€Œå†æ¸¬ä¸€æ¬¡ã€
   ============================================================= */
let hasShared=false;

function shareToUnlock(){
  const url=window.location.href.split('?')[0];
  const text='æˆ‘å‰›ç”¨ã€Œéœæœˆä¹‹å…‰ã€æ¸¬äº†å‘½ç†çµæœï¼Œè¶…æº–ï¼å…è²»æ¸¬ä½ çš„ ğŸ‘‰ ';

  if(navigator.share){
    navigator.share({title:'éœæœˆä¹‹å…‰å åœ',text:text,url:url}).then(()=>{
      hasShared=true;
      updateShareGate();
    }).catch(()=>{
      // User cancelled â€” copy instead
      fallbackCopyShare(text+url);
    });
  }else{
    fallbackCopyShare(text+url);
  }
}

function fallbackCopyShare(text){
  navigator.clipboard.writeText(text).then(()=>{
    alert('åˆ†äº«é€£çµå·²è¤‡è£½ï¼\nè²¼åˆ° LINE / IG / FB å°±èƒ½åˆ†äº«çµ¦æœ‹å‹ âœ¨');
    hasShared=true;
    updateShareGate();
  }).catch(()=>{
    // Final fallback
    prompt('è¤‡è£½ä»¥ä¸‹é€£çµåˆ†äº«çµ¦æœ‹å‹ï¼š',text);
    hasShared=true;
    updateShareGate();
  });
}

function updateShareGate(){
  const gate=document.getElementById('share-gate');
  const retestBtn=document.getElementById('btn-retest');
  if(gate&&retestBtn){
    if(hasShared){
      gate.classList.add('hidden');
      retestBtn.classList.remove('hidden');
    }
  }
}

function retestAfterShare(){
  hasShared=false;
  drawnCards=[];
  resetAll();
}
// å¯¦éš›å•†å“åº« â€” ä¾äº”è¡Œåˆ†é¡ï¼Œå–ä»£è¡¨æ€§å“é …ï¼ˆåŒåå–åƒ¹æ ¼å¸¶ï¼‰
const REAL_PRODUCTS = {
  é‡‘: [
    // ç™½æ°´æ™¶ç³»åˆ—
    {n:'ç™½æ°´æ™¶',cat:'æ‰‹éˆ',icon:'ğŸ’',el:'é‡‘',d:'æ·¨åŒ–èƒ½é‡å ´ï¼Œå¢å¼·æ€ç¶­æ¸…æ™°åº¦ï¼Œè¬èƒ½èª¿å’ŒçŸ³',price:'$320-$396',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç™½æ°´æ™¶æ‰‹æ’',cat:'æ‰‹éˆ',icon:'ğŸ’',el:'é‡‘',d:'å¤§é¡†ç²’æ’ç ï¼Œæ·¨åŒ–èƒ½é‡æ›´å¼·ï¼Œé©åˆè¾¦å…¬ä½©æˆ´',price:'$396',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'é‘½åˆ‡ç™½æ°´æ™¶',cat:'æ‰‹éˆ',icon:'âœ¨',el:'é‡‘',d:'åˆ‡å‰²é¢æŠ˜å°„å…‰èŠ’ï¼Œæå‡éˆæ€§èƒ½é‡èˆ‡å°ˆæ³¨åŠ›',price:'$320',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'éˆ¦æ™¶æ‰‹æ’',cat:'æ‰‹éˆ',icon:'âš¡',el:'é‡‘',d:'æ‹›æ­£è²¡åè²¡é¦–é¸ï¼å¢å¼·é ˜å°åŠ›èˆ‡æ±ºæ–·åŠ›',price:'$3,334-$21,950',wear:'é¢è©¦/ç°½ç´„æ™‚ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç™½æ°´æ™¶é³³å‡°é …éŠ',cat:'é …éŠ',icon:'ğŸ”®',el:'é‡‘',d:'é³³å‡°æ¶…æ§ƒï¼Œæ·¨åŒ–+é‡ç”Ÿèƒ½é‡ï¼Œæ”¶è—ç´šé …éŠ',price:'$3,372',wear:'è²¼è¿‘å¿ƒè¼ªä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'é‡‘é«®æ™¶',cat:'æ‰‹éˆ',icon:'ğŸŒŸ',el:'é‡‘',d:'æ‹›è²¡æ—ºäº‹æ¥­ï¼Œé‡‘è‰²é«®çµ²è±¡å¾µè²¡å¯Œèƒ½é‡',price:'$761',wear:'å·¦æ‰‹ä½©æˆ´æ‹›è²¡',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç™½å¹½éˆ',cat:'æ‰‹éˆ',icon:'ğŸ¤',el:'é‡‘',d:'æ·¨åŒ–ç£å ´ï¼Œæå‡éˆæ€§ç›´è¦ºåŠ›',price:'$396',wear:'å†¥æƒ³æ™‚ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç™½é˜¿è³½è¨­è¨ˆæ¬¾',cat:'æ‰‹éˆ',icon:'ğŸ’«',el:'é‡‘',d:'é«˜é »èƒ½é‡çŸ³ï¼Œæå‡éˆæ€§é€£çµèˆ‡ç›´è¦º',price:'$420',wear:'å†¥æƒ³/éœå¿ƒæ™‚ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'é€çŸ³è†',cat:'æ‰‹éˆ',icon:'ğŸª¨',el:'é‡‘',d:'æ·¨åŒ–ç©ºé–“èƒ½é‡ï¼Œå¸¶ä¾†å¿ƒéˆå¹³éœ',price:'$358',wear:'æ”¾è‡¥å®¤æˆ–éš¨èº«',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  æœ¨: [
    {n:'ç¶ å¹½éˆ',cat:'æ‰‹éˆ',icon:'ğŸ’š',el:'æœ¨',d:'æ‹›æ­£è²¡é¦–é¸ï¼äº‹æ¥­ç©©æ­¥ä¸Šå‡ï¼Œä¸Šç­æ—å¿…å‚™',price:'$684-$10,668',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'æŠ¹èŒ¶å¹½éˆ',cat:'æ‰‹éˆ',icon:'ğŸµ',el:'æœ¨',d:'ç¨€æœ‰æŠ¹èŒ¶è‰²å¹½éˆï¼Œæ‹›æ­£è²¡+å®‰å®šå¿ƒæ€§',price:'$8,748',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç¶ ç¢§ç’½',cat:'æ‰‹éˆ',icon:'ğŸŸ¢',el:'æœ¨',d:'æ—ºäº‹æ¥­è²¡é‹ï¼Œæ¿€ç™¼å‰µé€ åŠ›',price:'$1,644',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'æ±é™µç‰',cat:'æ‰‹éˆ',icon:'ğŸŒ¿',el:'æœ¨',d:'èˆ’ç·©å£“åŠ›ï¼Œå¸¶ä¾†å¥½é‹èˆ‡æ­£èƒ½é‡',price:'$176',wear:'éš¨èº«ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç¶ é«®æ™¶æ‰‹æ’',cat:'æ‰‹éˆ',icon:'ğŸŒ±',el:'æœ¨',d:'æ‹›æ­£è²¡+è²´äººï¼Œé«®çµ²ä»£è¡¨ç”Ÿé•·èƒ½é‡',price:'$4,332',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç¶ æ°´æ™¶éš¨å‹',cat:'æ‰‹éˆ',icon:'ğŸ’',el:'æœ¨',d:'å¤©ç„¶éš¨å‹ç¶ æ°´æ™¶ï¼Œæ‹›æ­£è²¡èšèƒ½é‡',price:'$2,028',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'å››å­£å¹½éˆæ‰‹æ’',cat:'æ‰‹éˆ',icon:'ğŸŒˆ',el:'æœ¨',d:'å››å­£è‰²å½©å¹½éˆï¼Œå…¨æ–¹ä½æ‹›è²¡é–‹é‹',price:'$2,988',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç¶ é¾æ™¶',cat:'æ‰‹éˆ',icon:'ğŸ‰',el:'æœ¨',d:'å¤©ç„¶é¾ç´‹ï¼Œæ—ºäº‹æ¥­+è­·èº«è¾Ÿé‚ª',price:'$1,068-$2,028',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç¶ æª€æœ¨æ‰‹éŠ',cat:'æ‰‹éˆ',icon:'ğŸªµ',el:'æœ¨',d:'å¤©ç„¶æª€æœ¨æ¸…é¦™ï¼Œå®‰ç¥å®šæ°£ï¼Œé©åˆä¿®è¡Œä½©æˆ´',price:'$224-$492',wear:'éš¨èº«ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç¶ æœˆå…‰',cat:'æ‰‹éˆ',icon:'ğŸŒ•',el:'æœ¨',d:'ç¨€æœ‰ç¶ è‰²æœˆå…‰çŸ³ï¼Œå¢å¼·ç›´è¦º+æ‹›å¥½é‹',price:'$108',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  æ°´: [
    {n:'æµ·è—å¯¶',cat:'æ‰‹éˆ',icon:'ğŸ’™',el:'æ°´',d:'å¢å¼·æºé€šåŠ›ï¼Œå¹³éœæƒ…ç·’ï¼Œè«‡åˆ¤å¿…å‚™',price:'$2,028-$23,825',wear:'ä½©æˆ´åœ¨å–‰è¼ªé™„è¿‘æœ€ä½³',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'æµ·è—å¯¶æ‰‹æ’',cat:'æ‰‹éˆ',icon:'ğŸŒŠ',el:'æ°´',d:'å¤§é¡†ç²’æµ·è—å¯¶ï¼Œæºé€šåŠ›èˆ‡å‹‡æ°£åŠ å€',price:'$2,988',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'æœˆå…‰çŸ³',cat:'æ‰‹éˆ',icon:'ğŸŒ™',el:'æ°´',d:'å¢å¼·ç›´è¦ºï¼ŒåŠ©æ„Ÿæƒ…é‹ï¼ŒæŸ”åŒ–å€‹æ€§',price:'$9,708',wear:'æ»¿æœˆä½©æˆ´æ•ˆæœæ›´ä½³',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'è—ç‰é«“',cat:'æ‰‹éˆ',icon:'ğŸ”µ',el:'æ°´',d:'ç©©å®šæƒ…ç·’ï¼Œå¢å¼·èªè¨€è¡¨é”åŠ›',price:'$588',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'è—å½¼å¾—çŸ³åœ“ç ',cat:'æ‰‹éˆ',icon:'ğŸŒ€',el:'æ°´',d:'æš´é¢¨é›¨çŸ³ï¼æ¿€ç™¼æ´å¯ŸåŠ›èˆ‡è®Šé©å‹‡æ°£',price:'$9,708',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'è—ç£·ç°',cat:'æ‰‹éˆ',icon:'ğŸ’',el:'æ°´',d:'å¢å¼·æ„å¿—åŠ›èˆ‡ç›®æ¨™æ„Ÿï¼Œå­¸ç¿’è€ƒè©¦ä½³',price:'$396',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'å ‡é’çŸ³',cat:'æ‰‹éˆ',icon:'ğŸ”®',el:'æ°´',d:'æŒ‡å¼•æ–¹å‘ä¹‹çŸ³ï¼Œå¹«åŠ©åšå‡ºæ­£ç¢ºæ±ºå®š',price:'$875',wear:'éœ€è¦æ±ºç­–æ™‚ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'è—æ–¹è§£çŸ³',cat:'æ‰‹éˆ',icon:'ğŸ’ ',el:'æ°´',d:'æºé€šä¹‹çŸ³ï¼Œæ‰“é–‹å–‰è¼ªï¼Œå¢å¼·è¡¨é”',price:'$300',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'é’æ™¶çŸ³',cat:'æ‰‹éˆ',icon:'ğŸŒŒ',el:'æ°´',d:'é–‹å•Ÿç¬¬ä¸‰çœ¼ï¼Œå¢å¼·ç›´è¦ºèˆ‡éˆæ€§æ„ŸçŸ¥',price:'$2,604',wear:'å†¥æƒ³æ™‚ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'å†°è—å°ç†Š',cat:'åŠå¢œ',icon:'ğŸ§¸',el:'æ°´',d:'å¯æ„›é€ å‹å†°è—çŸ³ï¼Œç™‚ç™’å®‰å¿ƒï¼Œé€ç¦®é¦–é¸',price:'$506',wear:'é …éŠä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  ç«: [
    {n:'ç´…ç‘ªç‘™',cat:'æ‰‹éˆ',icon:'â¤ï¸',el:'ç«',d:'æ¿€ç™¼ç†±æƒ…ï¼Œå¢å¼·è¡Œå‹•åŠ›èˆ‡å‹‡æ°£',price:'$300-$454',wear:'å³æ‰‹ä½©æˆ´å¢è¡Œå‹•åŠ›',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç´…ç‘ªç‘™è¨­è¨ˆæ¬¾',cat:'æ‰‹éˆ',icon:'ğŸ’—',el:'ç«',d:'è¨­è¨ˆå¸«æ¬¾ç´…ç‘ªç‘™ï¼Œç†±æƒ…+æ™‚å°šå…¼å…·',price:'$1,260',wear:'å³æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç´«æ°´æ™¶',cat:'æ‰‹éˆ',icon:'ğŸ’œ',el:'ç«',d:'å®‰ç¥åŠ©çœ ï¼Œç©©å®šæƒ…ç·’ï¼Œéˆæ€§æå‡é¦–é¸',price:'$588-$1,606',wear:'ç¡å‰ä½©æˆ´æˆ–æ”¾æ•ä¸‹',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç´…è™çœ¼',cat:'æ‰‹éˆ',icon:'ğŸ”´',el:'ç«',d:'å¢å¼·æ„å¿—åŠ›èˆ‡è¡Œå‹•åŠ›ï¼Œè¾Ÿé‚ªæ“‹ç…',price:'$435',wear:'å³æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç´…èŠ±ç¢§ç‰æ‰‹æ’',cat:'æ‰‹éˆ',icon:'ğŸŒº',el:'ç«',d:'å¤©ç„¶èŠ±ç´‹ç¢§ç‰ï¼Œå¢å¼·ç”Ÿå‘½åŠ›èˆ‡ç©©å®šæ„Ÿ',price:'$464',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç´«ç‰™çƒ',cat:'æ‰‹éˆ',icon:'ğŸ‡',el:'ç«',d:'çŸ³æ¦´çŸ³ç³»åˆ—ï¼Œæå‡æ´»åŠ›èˆ‡æ¡ƒèŠ±é‹',price:'$1,952',wear:'è²¼èº«ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç²‰ç´…ç¢§ç’½åœ“ç ',cat:'æ‰‹éˆ',icon:'ğŸ’•',el:'ç«',d:'å¼·åŠ›æ‹›æ¡ƒèŠ±ï¼å¢å¼·äººéš›é­…åŠ›',price:'$13,548',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'è–”è–‡çŸ³',cat:'æ‰‹éˆ',icon:'ğŸŒ¹',el:'ç«',d:'æ„›æƒ…ç™‚ç™’çŸ³ï¼Œä¿®å¾©å¿ƒè¼ªï¼Œæ‹›æ¡ƒèŠ±',price:'$1,798',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç…™èŠ±é›¨è–”è–‡çŸ³',cat:'æ‰‹éˆ',icon:'ğŸ†',el:'ç«',d:'ç¨ç‰¹ç…™èŠ±ç´‹ç†ï¼Œç™‚ç™’å¿ƒéˆ+æ‹›æ¡ƒèŠ±',price:'$2,220',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç´«é¾æ™¶',cat:'æ‰‹éˆ',icon:'ğŸ²',el:'ç«',d:'æ™ºæ…§+éˆæ€§æå‡ï¼Œç´«è‰²é¾ç´‹ç¨ç‰¹ç¾æ„Ÿ',price:'$646',wear:'å†¥æƒ³ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç´«é‡‘ç ‚',cat:'æ‰‹éˆ',icon:'âœ¨',el:'ç«',d:'é–ƒè€€ç´«é‡‘å…‰ï¼Œè¾Ÿé‚ª+æå‡éˆæ€§',price:'$339',wear:'éš¨èº«ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'åˆ©æ¯”äºé»ƒé‡‘éš•çŸ³',cat:'æ‰‹éˆ',icon:'â˜„ï¸',el:'ç«',d:'ä¾†è‡ªå®‡å®™çš„èƒ½é‡ï¼æ¥µå¼·é¡¯åŒ–åŠ›èˆ‡æ„å¿—åŠ›',price:'$1,644',wear:'å†¥æƒ³/è¨±é¡˜æ™‚ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  åœŸ: [
    {n:'é»ƒæ°´æ™¶',cat:'æ‰‹éˆ',icon:'ğŸ’›',el:'åœŸ',d:'æ‹›åè²¡é¦–é¸ï¼æå‡è‡ªä¿¡èˆ‡å€‹äººé­…åŠ›',price:'$233-$492',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'èŒ¶æ™¶',cat:'æ‰‹éˆ',icon:'ğŸ«–',el:'åœŸ',d:'æ’é™¤è² èƒ½é‡ï¼Œç©©å®šå¿ƒæ€§ï¼Œæ¥åœ°æ°£',price:'$684-$742',wear:'ä½©æˆ´æˆ–æ”¾å®¢å»³',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'è™çœ¼çŸ³ï¼ˆè—ï¼‰',cat:'æ‰‹éˆ',icon:'ğŸ¯',el:'åœŸ',d:'å¢å¼·æ±ºæ–·åŠ›ï¼Œæ‹›è²¡è¾Ÿé‚ªï¼Œç©©å®šå¿ƒæ€§',price:'$7,600',wear:'å³æ‰‹ä½©æˆ´å¢æ°£å ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'é˜¿æ‹‰å–„',cat:'æ‰‹éˆ',icon:'ğŸª¨',el:'åœŸ',d:'æˆˆå£èƒ½é‡çŸ³ï¼Œç©©å®š+æ¥åœ°+å¢å¼·è€åŠ›',price:'$281-$454',wear:'éš¨èº«ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'å¤ªæ¥µçŸ³è¨­è¨ˆæ¬¾',cat:'æ‰‹éˆ',icon:'â˜¯ï¸',el:'åœŸ',d:'é™°é™½å¹³è¡¡ä¹‹çŸ³ï¼Œèª¿å’Œèº«å¿ƒèƒ½é‡å ´',price:'$1,836',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'é‡‘æ›œçŸ³',cat:'æ‰‹éˆ',icon:'ğŸŒ‘',el:'åœŸ',d:'è¾Ÿé‚ªæ“‹ç…é¦–é¸ï¼é‡‘è‰²é–ƒå…‰è­·èº«ç¬¦',price:'$416',wear:'å³æ‰‹ä½©æˆ´è¾Ÿé‚ª',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'å¤§åœ°ç‘ªç‘™æ‰‹æ’',cat:'æ‰‹éˆ',icon:'ğŸŸ¤',el:'åœŸ',d:'å¤§åœ°èƒ½é‡ï¼Œç©©å®šè¸å¯¦ï¼Œå¢å¼·è€åŠ›',price:'$300',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'éµè†½çŸ³æ‰‹æ’',cat:'æ‰‹éˆ',icon:'ğŸª¨',el:'åœŸ',d:'æ¥µå¼·æ¥åœ°èƒ½é‡ï¼Œæ’è² +ç©©å®šå¿ƒæ€§',price:'$185',wear:'å³æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'ç™½æ°´èŒ¶æ™¶è¨­è¨ˆæ¬¾',cat:'æ‰‹éˆ',icon:'ğŸ¤',el:'åœŸ',d:'ç™½æ°´æ™¶+èŒ¶æ™¶çµ„åˆï¼Œæ·¨åŒ–+ç©©å®šé›™æ•ˆ',price:'$506',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  // è·¨äº”è¡Œç‰¹æ®Šå•†å“
  special: [
    {n:'å½©è¶…ä¸ƒ',cat:'æ‰‹éˆ',icon:'ğŸŒˆ',el:'å…¨',d:'ä¸ƒç¨®ç¤¦ç‰©å…±ç”Ÿï¼å…¨æ–¹ä½é–‹é‹æ‹›è²¡',price:'$972-$41,325',wear:'å·¦æ‰‹ä½©æˆ´',tags:['å…¨èƒ½','æ‹›è²¡'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'å¤šå¯¶éš•çŸ³æ‰‹éŠ',cat:'æ‰‹éˆ',icon:'â˜„ï¸',el:'å…¨',d:'å¤šç¨®éš•çŸ³èƒ½é‡é›†åˆï¼Œå®‡å®™ç´šé˜²è­·',price:'$5,484',wear:'å·¦æ‰‹ä½©æˆ´',tags:['è¾Ÿé‚ª','å…¨èƒ½'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'å¤©éµäº”è¡Œè¨­è¨ˆæ¬¾',cat:'æ‰‹éˆ',icon:'âš”ï¸',el:'å…¨',d:'å¤©éµï¼ˆéš•éµï¼‰+äº”è¡Œå…ƒç´ ï¼Œå¼·åŠ›è­·èº«é–‹é‹',price:'$5,484',wear:'å·¦æ‰‹ä½©æˆ´',tags:['äº”è¡Œ','è¾Ÿé‚ª'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'éŠ€æ›œçŸ³äº”è¡Œè¨­è¨ˆæ¬¾',cat:'æ‰‹éˆ',icon:'ğŸŒŸ',el:'å…¨',d:'éŠ€æ›œçŸ³+äº”è¡Œé…è‰²ï¼Œè¾Ÿé‚ª+äº”è¡Œå¹³è¡¡',price:'$3,622',wear:'å³æ‰‹ä½©æˆ´',tags:['äº”è¡Œ','è¾Ÿé‚ª'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'å½©è‰²å¤©éµæ‰‹éŠ',cat:'æ‰‹éˆ',icon:'ğŸŒˆ',el:'å…¨',d:'å½©è‰²å¤©éµï¼Œå®‡å®™èƒ½é‡+è—è¡“ç¾æ„Ÿ',price:'$4,548-$10,308',wear:'å·¦æ‰‹ä½©æˆ´',tags:['å…¨èƒ½'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'éª¨å¹¹å¤ªé™½çŸ³',cat:'æ‰‹éˆ',icon:'â˜€ï¸',el:'ç«',d:'æ­£èƒ½é‡ä¹‹ç‹ï¼è‡ªä¿¡ã€é ˜å°åŠ›ã€æ´»åŠ›å…¨é–‹',price:'$2,777',wear:'æ—¥é–“ä½©æˆ´',tags:['äº‹æ¥­','è‡ªä¿¡'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'é‡‘å¤ªé™½',cat:'æ‰‹éˆ',icon:'ğŸŒ',el:'ç«',d:'é‡‘è‰²å¤ªé™½å…‰èŠ’ï¼Œæ‹›æ­£è²¡+å¢å¼·é ˜å°åŠ›',price:'$8,748-$21,325',wear:'å·¦æ‰‹ä½©æˆ´',tags:['è²¡é‹','äº‹æ¥­'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'æƒ…ä¾¶å°éŠ',cat:'é …éŠ',icon:'ğŸ’‘',el:'å…¨',d:'æƒ…ä¾¶æ¬¾å°éŠï¼Œæ„Ÿæƒ…åŠ æº«å¿…å‚™',price:'$1,226',wear:'æˆå°ä½©æˆ´',tags:['æ„›æƒ…'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'è€å±±æª€é¦™åœ“ç ',cat:'æ‰‹éˆ',icon:'ğŸ“¿',el:'åœŸ',d:'ç™¾å¹´è€å±±æª€é¦™ï¼Œå®‰ç¥åŠ©çœ ï¼Œéœå¿ƒä¿®è¡Œ',price:'$3,756',wear:'å¿µä½›/å†¥æƒ³ä½©æˆ´',tags:['å¥åº·','éˆæ€§'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'æ²‰é¦™ç„¡äº‹ç‰Œ',cat:'åŠå¢œ',icon:'ğŸ·ï¸',el:'æœ¨',d:'ç„¡äº‹ç‰Œå¯“æ„å¹³å®‰ç„¡äº‹ï¼Œæ²‰é¦™å®‰ç¥å®šæ°£',price:'$492',wear:'é …éŠä½©æˆ´',tags:['å¹³å®‰','å¥åº·'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  // é …éŠåŠå¢œ
  necklace: [
    {n:'éŠ€æ›œé …éŠï¼ˆé—œå…¬ï¼‰',cat:'é …éŠ',icon:'âš”ï¸',el:'åœŸ',d:'é—œå…¬è­·èº«ï¼Œæ‹›è²¡è¾Ÿé‚ªï¼Œç”Ÿæ„äººå¿…å‚™',price:'$492',wear:'å‡ºé–€ä½©æˆ´',tags:['è²¡é‹','è¾Ÿé‚ª'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'é‡‘æ›œé …éŠï¼ˆé¾ç‰Œï¼‰',cat:'é …éŠ',icon:'ğŸ‰',el:'åœŸ',d:'é¾ç‰Œè­·èº«ç¬¦ï¼Œæ°£å ´å¼·å¤§ï¼Œäº‹æ¥­äº¨é€š',price:'$492',wear:'å‡ºé–€ä½©æˆ´',tags:['äº‹æ¥­','è¾Ÿé‚ª'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'éŠ€æ›œé …éŠï¼ˆä¹å°¾ç‹ï¼‰',cat:'é …éŠ',icon:'ğŸ¦Š',el:'åœŸ',d:'ä¹å°¾ç‹æ‹›æ¡ƒèŠ±ï¼Œå¢å¼·é­…åŠ›èˆ‡ç•°æ€§ç·£',price:'$492',wear:'ç´„æœƒä½©æˆ´',tags:['æ„›æƒ…','æ¡ƒèŠ±'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'é»‘æ›œé …éŠç„¡äº‹ç‰Œ',cat:'é …éŠ',icon:'ğŸ·ï¸',el:'åœŸ',d:'é»‘æ›œçŸ³ç„¡äº‹ç‰Œï¼Œè¾Ÿé‚ª+å¹³å®‰',price:'$469',wear:'éš¨èº«ä½©æˆ´',tags:['å¹³å®‰','è¾Ÿé‚ª'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'é»‘æ›œç£¨ç ‚å¿ƒç¶“',cat:'é …éŠ',icon:'ğŸ“¿',el:'åœŸ',d:'å¿ƒç¶“è­·èº«ç¬¦ï¼Œè¾Ÿé‚ªåŒ–ç…ï¼Œå®‰å®šå¿ƒç¥',price:'$204-$377',wear:'éš¨èº«ä½©æˆ´',tags:['è¾Ÿé‚ª','å¹³å®‰'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  // è¾Ÿé‚ªç³»åˆ—
  protection: [
    {n:'é»‘é–ƒéˆ',cat:'æ‰‹éˆ',icon:'âš«',el:'åœŸ',d:'è¶…å¼·è¾Ÿé‚ªæ“‹ç…ï¼Œæ’é™¤ä¸€åˆ‡è² èƒ½é‡',price:'$1,798',wear:'å³æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'å½©é–ƒéˆ',cat:'æ‰‹éˆ',icon:'ğŸŒˆ',el:'å…¨',d:'è¾Ÿé‚ª+é–‹é‹é›™æ•ˆï¼Œå½©è‰²é–ƒéˆèƒ½é‡å…¨é¢',price:'$4,908',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'å½©è™¹é»‘æ›œçŸ³',cat:'æ‰‹éˆ',icon:'ğŸŒˆ',el:'åœŸ',d:'é»‘æ›œçŸ³ä¸­çš„æ¥µå“ï¼Œè¾Ÿé‚ª+ä¸ƒå½©å…‰èŠ’',price:'$1,882',wear:'å³æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'é»‘ç¢§ç’½ä¸‰åœˆ',cat:'æ‰‹éˆ',icon:'â¬›',el:'åœŸ',d:'ä¸‰åœˆçºç¹è¨­è¨ˆï¼Œå…¨é¢è¾Ÿé‚ªé˜²è­·',price:'$588',wear:'å³æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'è¥¿åŒ—ééš•çŸ³',cat:'æ‰‹éˆ',icon:'â˜„ï¸',el:'å…¨',d:'å¤–å¤ªç©ºéš•çŸ³èƒ½é‡ï¼Œè­·èº«è¾Ÿé‚ªæ¥µå¼·',price:'$1,068-$1,184',wear:'å³æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  // æ¡ƒèŠ±ç³»åˆ—
  love_special: [
    {n:'ç²‰æ™¶',cat:'æ‰‹éˆ',icon:'ğŸ’•',el:'åœŸ',d:'æ‹›æ¡ƒèŠ±é¦–é¸ï¼å¢å¼·æ„Ÿæƒ…é‹èˆ‡äººéš›é­…åŠ›',price:'$204-$272',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œç´„æœƒå¿…å‚™',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'æ˜Ÿå…‰è‰è“æ™¶',cat:'æ‰‹éˆ',icon:'ğŸ“',el:'ç«',d:'å¢å¼·ç•°æ€§ç·£ï¼Œå¸¶ä¾†ç”œèœœæˆ€æ„›æ©Ÿæœƒ',price:'$300-$454',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'å½©è‰²è‰è“æ™¶',cat:'æ‰‹éˆ',icon:'ğŸ«',el:'ç«',d:'å¤šè‰²è‰è“æ™¶ï¼Œå…¨é¢æå‡äººéš›èˆ‡æ¡ƒèŠ±é‹',price:'$608',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'æ‘©æ ¹çŸ³',cat:'æ‰‹éˆ',icon:'ğŸ©·',el:'æ°´',d:'é«˜é »æ„›æƒ…çŸ³ï¼Œæº«æŸ”ç™‚ç™’ï¼Œå¸å¼•çœŸæ„›',price:'$300',wear:'å·¦æ‰‹ä½©æˆ´',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ]
};
/* =============================================================
   æ™ºæ…§æ¨è–¦å¼•æ“ â€” å–ä»£ PRODUCT_DB + TYPE_PRODUCTS
   æ ¹æ“šï¼šå–œç”¨ç¥ Ã— å•é¡Œé¡å‹ Ã— åƒ¹æ ¼å¸¶åˆ†ä½ˆ æ¨è–¦æœ€ä½³å•†å“
   ============================================================= */
function smartRecommend(bazi, type, maxItems){
  maxItems = maxItems || 6;
  const need = bazi.fav[0]; // å–œç”¨ç¥ç¬¬ä¸€ä½
  const need2 = bazi.fav[1]; // å–œç”¨ç¥ç¬¬äºŒä½
  const results = [];
  const seen = new Set();

  function add(item, priority){
    if(seen.has(item.n)) return;
    seen.add(item.n);
    results.push({...item, _priority: priority||0});
  }

  // 1) å•é¡Œé¡å‹ç‰¹æ®Šæ¨è–¦ï¼ˆæœ€é«˜å„ªå…ˆï¼‰
  if(type==='love'){
    (REAL_PRODUCTS.love_special||[]).forEach(p=>add(p,100));
    // ä¹å°¾ç‹é …éŠ
    (REAL_PRODUCTS.necklace||[]).filter(p=>(p.tags||[]).includes('æ„›æƒ…')).forEach(p=>add(p,90));
    // æƒ…ä¾¶å°éŠ
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('æ„›æƒ…')).forEach(p=>add(p,85));
  }
  if(type==='career'){
    // éˆ¦æ™¶ + é‡‘å¤ªé™½ + å¤ªé™½çŸ³
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('äº‹æ¥­')).forEach(p=>add(p,100));
    // éˆ¦æ™¶æ‰‹æ’
    (REAL_PRODUCTS.é‡‘||[]).filter(p=>p.n.includes('éˆ¦æ™¶')).forEach(p=>add(p,95));
    // é¾ç‰Œ
    (REAL_PRODUCTS.necklace||[]).filter(p=>(p.tags||[]).includes('äº‹æ¥­')).forEach(p=>add(p,85));
  }
  if(type==='wealth'){
    // é»ƒæ°´æ™¶ + ç¶ å¹½éˆ + é‡‘å¤ªé™½ + éˆ¦æ™¶
    (REAL_PRODUCTS.åœŸ||[]).filter(p=>p.n.includes('é»ƒæ°´æ™¶')).forEach(p=>add(p,100));
    (REAL_PRODUCTS.æœ¨||[]).filter(p=>p.n.includes('ç¶ å¹½éˆ')||p.n.includes('æŠ¹èŒ¶')).forEach(p=>add(p,95));
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('è²¡é‹')).forEach(p=>add(p,90));
    (REAL_PRODUCTS.é‡‘||[]).filter(p=>p.n.includes('éˆ¦æ™¶')).forEach(p=>add(p,85));
  }
  if(type==='health'){
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('å¥åº·')).forEach(p=>add(p,100));
    (REAL_PRODUCTS.ç«||[]).filter(p=>p.n.includes('ç´«æ°´æ™¶')).forEach(p=>add(p,95));
    // èŒ¶æ™¶ç©©å®š
    (REAL_PRODUCTS.åœŸ||[]).filter(p=>p.n.includes('èŒ¶æ™¶')).forEach(p=>add(p,85));
  }

  // 2) å–œç”¨ç¥äº”è¡Œå•†å“
  const elProducts = REAL_PRODUCTS[need] || [];
  elProducts.forEach(p => add(p, 70));
  if(need2 && REAL_PRODUCTS[need2]){
    REAL_PRODUCTS[need2].slice(0,3).forEach(p => add(p, 50));
  }

  // 3) äº”è¡Œè¨­è¨ˆæ¬¾ / è¶…ä¸ƒï¼ˆå…¨æ–¹ä½ï¼‰
  (REAL_PRODUCTS.special||[]).filter(p=>p.el==='å…¨').forEach(p=>add(p,40));

  // 4) è¾Ÿé‚ªé¡ï¼ˆå‡¶çš„æ™‚å€™å„ªå…ˆï¼‰
  const prob = parseFloat((document.getElementById('r-vprob')||{}).textContent)||50;
  if(prob < 40){
    (REAL_PRODUCTS.protection||[]).forEach(p=>add(p,80));
  }

  // 5) é …éŠé¡è£œå……
  (REAL_PRODUCTS.necklace||[]).forEach(p=>add(p,20));

  // Sort by priority desc, then pick top N
  results.sort((a,b)=>b._priority-a._priority);

  // Ensure price diversity: at least 1 under $500, 1 mid, 1 high
  const final = [];
  const low = results.filter(r=>{const p=parseFloat(r.price.replace(/[^0-9]/g,''));return p<=500});
  const mid = results.filter(r=>{const p=parseFloat(r.price.replace(/[^0-9]/g,''));return p>500&&p<=3000});
  const high = results.filter(r=>{const p=parseFloat(r.price.replace(/[^0-9]/g,''));return p>3000});

  if(low[0]) final.push(low[0]);
  if(mid[0]) final.push(mid[0]);
  if(high[0]) final.push(high[0]);

  // Fill remaining from sorted results
  results.forEach(r=>{
    if(final.length>=maxItems) return;
    if(!final.find(f=>f.n===r.n)) final.push(r);
  });

  return final.slice(0, maxItems);
}

/* Override renderProductCrystal to use smart recommend */
const _origRenderProductCrystal = typeof renderProductCrystal === 'function' ? renderProductCrystal : null;
renderProductCrystal = function(bazi, type){
  const need = bazi.fav[0];
  const products = smartRecommend(bazi, type, 6);
  const catIcon = {æ‰‹éˆ:'âŒš', é …éŠ:'ğŸ“¿', åŠå¢œ:'ğŸ·ï¸', åŸçŸ³:'ğŸ’', å®¢è£½:'âœ¨'};

  document.getElementById('r-crystal').innerHTML = `
    <div class="crystal-rec-header">
      <p>æ ¹æ“šä½ çš„å‘½ç›¤ï¼ˆå–œç”¨ <span class="tag tag-gold">${need}è¡Œ</span>ï¼‰å’Œå•é¡Œï¼ˆ<span class="tag tag-blue">${getTypeLabel(type)}</span>ï¼‰ï¼Œå¾æˆ‘å€‘è³£å ´ç²¾é¸ï¼š</p>
    </div>
    <div class="product-grid">${products.map(p=>`
      <div class="product-card">
        <div class="product-icon">${p.icon}</div>
        <div class="product-body">
          <div class="product-name">${p.n}</div>
          <div class="product-meta">
            <span class="tag tag-gold text-xs">${catIcon[p.cat]||'ğŸ’'} ${p.cat}</span>
            ${p.el!=='å…¨'?`<span class="el-tag el-${p.el} text-xs">${p.el}è¡Œ</span>`:'<span class="tag text-xs" style="background:linear-gradient(90deg,#c00,#fc0,#0a0,#08f,#a78b5a);color:#fff;-webkit-background-clip:text;-webkit-text-fill-color:transparent;border:1px solid rgba(212,175,55,.4)">äº”è¡Œå…¨</span>'}
          </div>
          <p class="product-desc">${p.d}</p>
          <p class="product-price">${p.price}</p>
          <p class="product-wear"><i class="fas fa-hand-holding-heart"></i> ${p.wear}</p>
          <div class="product-actions">
            <a href="${p.shopee}" target="_blank" rel="noopener" class="product-btn shopee"><i class="fas fa-shopping-cart"></i> è¦çš®</a>
            <a href="${p.seven}" target="_blank" rel="noopener" class="product-btn seven"><i class="fas fa-box"></i> 7-11</a>
          </div>
        </div>
      </div>`).join('')}
    </div>
    <div class="custom-cta mt-lg">
      <button class="btn btn-gold btn-full" onclick="openCustomModal()">
        <i class="fas fa-magic"></i> æƒ³è¦ã€Œä¾ä½ äº”è¡Œå°ˆå±¬æ­é…ã€ï¼Ÿé»æˆ‘å®¢è£½æ‰‹éˆ
      </button>
      <p class="text-xs text-muted mt-sm text-center">é ç®—ç‰ˆ $1,000 èµ· ï½œ 48hr å…§å›è¦† ï½œ å«å åœåˆ†ææ‘˜è¦</p>
    </div>
    <p class="text-xs text-muted mt-md text-center"><i class="fas fa-info-circle"></i> ä»¥ä¸Šå•†å“çš†ç‚ºè³£å ´ç¾è²¨ã€‚é»æ“Šè¦çš®æˆ–7-11ç›´æ¥é¸è³¼ï¼Œæ°´æ™¶æ•ˆæœå› äººè€Œç•°ã€‚</p>`;
};
/* =============================================================
   1) å•†å“å¡ã€Œé™æ™‚æé†’ã€â€” åº«å­˜æ•¸ + ä»Šæ—¥Näººçœ‹é
   ============================================================= */
function getUrgencyHTML(productName){
  // Seeded random based on product name + today's date (consistent per day)
  const seed = productName.split('').reduce((a,c)=>a+c.charCodeAt(0),0) + new Date().getDate();
  const stock = (seed % 7) + 1; // 1-7
  const views = (seed * 7 + 13) % 40 + 15; // 15-54
  const stockClass = stock <= 3 ? 'urgency-critical' : 'urgency-normal';
  return `<div class="urgency-strip">
    <span class="${stockClass}"><i class="fas fa-fire"></i> åƒ…å‰© ${stock} ä»¶</span>
    <span class="urgency-views"><i class="fas fa-eye"></i> ä»Šæ—¥ ${views} äººçœ‹é</span>
  </div>`;
}

/* =============================================================
   2) ç¤¾æœƒèªåŒæ•¸æ“š
   ============================================================= */
function getSocialProofHTML(element, type){
  const elMap = {é‡‘:68, æœ¨:72, æ°´:58, ç«:63, åœŸ:71};
  const typeMap = {love:74, career:69, wealth:76, health:62, general:65, relationship:70, family:67, other:60};
  const elPct = elMap[element] || 65;
  const typePct = typeMap[type] || 65;
  // Randomize slightly per session
  const r1 = elPct + (Math.floor(Math.random()*5)-2);
  const r2 = typePct + (Math.floor(Math.random()*5)-2);
  return `<div class="social-proof">
    <div class="sp-item"><i class="fas fa-users"></i> <strong>${r1}%</strong> çš„ä½¿ç”¨è€…ä¹Ÿéœ€è¦è£œ <span class="tag tag-gold">${element}è¡Œ</span> èƒ½é‡</div>
    <div class="sp-item"><i class="fas fa-chart-line"></i> å•<span class="tag tag-blue">${getTypeLabel(type)}</span>çš„äººä¸­ï¼Œ<strong>${r2}%</strong> é¸æ“‡ä½©æˆ´å°æ‡‰æ°´æ™¶å¾Œå›é¥‹æ­£é¢</div>
  </div>`;
}

/* =============================================================
   3) é¦–é è¨ˆæ•¸å™¨ + è·‘é¦¬ç‡ˆ
   ============================================================= */
function initLiveCounter(){
  // Base count: accumulated + today's count from localStorage
  let base = 184729; // base number
  const dayKey = 'jy_count_' + new Date().toISOString().slice(0,10);
  let todayCount = parseInt(localStorage.getItem(dayKey)||'0');
  todayCount++;
  try{localStorage.setItem(dayKey, todayCount)}catch(e){}

  // Display
  const total = base + todayCount + Math.floor(Math.random()*20);
  const counterEl = document.getElementById('live-counter-num');
  if(counterEl) counterEl.textContent = total.toLocaleString();
  const todayEl = document.getElementById('live-today-num');
  if(todayEl) todayEl.textContent = todayCount + Math.floor(Math.random()*30+20);

}

/* =============================================================
   4) åˆ†äº«å¾Œé¡¯ç¤ºå°ˆå±¬æŠ˜æ‰£ç¢¼
   ============================================================= */
function generateDiscountCode(){
  // Generate a unique-looking code per user per day
  const d = new Date();
  const base = 'JY' + (d.getMonth()+1).toString().padStart(2,'0') + d.getDate().toString().padStart(2,'0');
  const rand = Math.random().toString(36).substring(2,5).toUpperCase();
  return base + rand;
}

function showDiscountAfterShare(){
  const code = generateDiscountCode();
  const el = document.getElementById('discount-reveal');
  if(!el) return;
  el.classList.remove('hidden');
  document.getElementById('discount-code').textContent = code;
}

function copyDiscountCode(){
  const code = document.getElementById('discount-code').textContent;
  navigator.clipboard.writeText(code).then(()=>{
    alert('æŠ˜æ‰£ç¢¼å·²è¤‡è£½ï¼è¦çš®ä¸‹å–®æ™‚è²¼ä¸Šå³å¯äº«9æŠ˜ âœ¨');
  }).catch(()=>{
    prompt('è¤‡è£½æ­¤æŠ˜æ‰£ç¢¼ï¼š', code);
  });
}

// Patch shareToUnlock to also show discount
const _origShareToUnlock = shareToUnlock;
shareToUnlock = function(){
  const url = window.location.href.split('?')[0];
  const text = 'æˆ‘å‰›ç”¨ã€Œéœæœˆä¹‹å…‰ã€æ¸¬äº†å‘½ç†çµæœï¼Œè¶…æº–ï¼å…è²»æ¸¬ä½ çš„ ğŸ‘‰ ';
  if(navigator.share){
    navigator.share({title:'éœæœˆä¹‹å…‰å åœ',text:text,url:url}).then(()=>{
      hasShared=true; updateShareGate(); showDiscountAfterShare();
    }).catch(()=>{ fallbackCopyShare(text+url); showDiscountAfterShare(); });
  }else{
    fallbackCopyShare(text+url);
    showDiscountAfterShare();
  }
};

/* =============================================================
   5) PWA å®‰è£æç¤ºæ©«å¹…
   ============================================================= */
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', function(e){
  e.preventDefault();
  deferredInstallPrompt = e;
  showPWABanner();
});

function showPWABanner(){
  const banner = document.getElementById('pwa-banner');
  if(!banner) return;
  if(sessionStorage.getItem('pwa_dismissed')) return;
  banner.classList.remove('hidden');
  // Auto dismiss after 8 seconds
  setTimeout(()=>hidePWABanner(), 8000);
}

function installPWA(){
  if(deferredInstallPrompt){
    deferredInstallPrompt.prompt();
    deferredInstallPrompt.userChoice.then(function(choice){
      if(choice.outcome==='accepted') console.log('PWA installed');
      deferredInstallPrompt = null;
      hidePWABanner();
    });
  }else{
    // iOS fallback
    alert('è«‹é»æ“Šç€è¦½å™¨çš„ã€Œåˆ†äº«ã€æŒ‰éˆ• â†’ é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€å³å¯å®‰è£ï¼');
    hidePWABanner();
  }
}

function hidePWABanner(){
  const banner = document.getElementById('pwa-banner');
  if(banner) banner.classList.add('hidden');
  sessionStorage.setItem('pwa_dismissed','1');
}

/* =============================================================
   6) AI é¢¨æ ¼å€‹äººåŒ–ç¸½çµ
   ============================================================= */
function generateAIConclusion(type, prob, bazi, mh, tarot){
  const name = S.form.name || 'ä½ ';
  const dm = bazi ? bazi.dm : '';
  const dmEl = bazi ? bazi.dmEl : '';
  const strong = bazi ? bazi.strong : true;
  const fav = bazi ? bazi.fav[0] : '';
  const curDy = bazi ? (bazi.dayun.find(d=>d.isCurrent)||{}) : {};
  const tl = getTypeLabel(type);

  // Opening â€” personal touch
  let lines = [];
  if(name!=='ä½ ') lines.push(`${name}ï¼Œçœ‹å®Œä½ çš„å‘½ç›¤ï¼Œæˆ‘æƒ³è·Ÿä½ èªªå¹¾å¥çœŸå¿ƒè©±ã€‚`);
  else lines.push(`çœ‹å®Œä½ çš„å‘½ç›¤ï¼Œæˆ‘æƒ³è·Ÿä½ èªªå¹¾å¥çœŸå¿ƒè©±ã€‚`);

  // BaZi personality insight
  if(bazi){
    const personality = {
      ç”²:'ä½ åƒä¸€æ£µå¤§æ¨¹ï¼Œå¤–è¡¨å …å®šä½†å…§å¿ƒæ¸´æœ›é™½å…‰ã€‚',
      ä¹™:'ä½ åƒæŸ”è»Ÿçš„è—¤è”“ï¼Œçœ‹ä¼¼æº«æŸ”å¯¦å‰‡éŸŒæ€§åè¶³ã€‚',
      ä¸™:'ä½ åƒå¤ªé™½ä¸€æ¨£æº«æš–ï¼Œå¤©ç”Ÿå°±æœ‰æ„ŸæŸ“åŠ›ã€‚',
      ä¸:'ä½ åƒç‡­å…‰èˆ¬ç´°è†©ï¼Œå–„æ–¼è§€å¯Ÿèˆ‡ç…§é¡§ä»–äººã€‚',
      æˆŠ:'ä½ åƒå¤§å±±ä¸€æ¨£ç©©é‡ï¼Œå€¼å¾—ä¿¡è³´ä½†æœ‰æ™‚å¤ªå›ºåŸ·ã€‚',
      å·±:'ä½ åƒç”°åœ’æ²ƒåœŸï¼ŒåŒ…å®¹æ€§å¼·ä½†å®¹æ˜“å§”å±ˆè‡ªå·±ã€‚',
      åºš:'ä½ åƒå¯¶åŠèˆ¬æœæ–·ï¼Œåšäº‹ä¹¾è„†ä½†æœ‰æ™‚å¤ªæ€¥ã€‚',
      è¾›:'ä½ åƒç å¯¶èˆ¬ç²¾ç·»ï¼Œè¿½æ±‚å®Œç¾ä½†å®¹æ˜“æƒ³å¤ªå¤šã€‚',
      å£¬:'ä½ åƒå¤§æµ·èˆ¬å¯¬å»£ï¼Œæƒ³æ³•å¤šä½†å®¹æ˜“åˆ†æ•£ç²¾åŠ›ã€‚',
      ç™¸:'ä½ åƒç´°é›¨èˆ¬æº«æ½¤ï¼Œç›´è¦ºå¼·ä½†å®¹æ˜“çŒ¶è±«ä¸æ±ºã€‚'
    };
    lines.push(personality[dm]||'');
    lines.push(`èº«${strong?'å¼·':'å¼±'}çš„ä½ ï¼Œ${strong?'èƒ½é‡å……æ²›ï¼Œä½†è¦æ³¨æ„åˆ¥å¤ªè¡å‹•':'éœ€è¦æ›´å¤šæ”¯æŒï¼Œé©åˆå€ŸåŠ›ä½¿åŠ›'}ã€‚`);
  }

  // Current situation reading
  if(prob >= 70){
    lines.push(`å¾ä½ çš„å‘½ç›¤ä¾†çœ‹ï¼Œç¾åœ¨çš„ä½ ç¢ºå¯¦ç«™åœ¨ä¸€å€‹å¥½ä½ç½®ä¸Šã€‚${curDy.gz?'ã€Œ'+curDy.gz+'ã€å¤§é‹':'ç•¶å‰é‹å‹¢'}çµ¦äº†ä½ åŠ©åŠ›ï¼Œå•${tl}çš„çµæœæ˜¯åå‘æ¨‚è§€çš„ã€‚`);
    lines.push('ä½†å¥½é‹ä¸æ˜¯ç­‰ä¾†çš„ â€” æ˜¯ä½ æº–å‚™å¥½äº†ï¼Œæ©Ÿæœƒæ‰çœ‹å¾—è¦‹ä½ ã€‚');
  }else if(prob >= 45){
    lines.push(`èªªå¯¦è©±ï¼Œä½ ç¾åœ¨çš„ç‹€æ³æ˜¯ã€Œæœ‰æ©Ÿæœƒä½†æœ‰é˜»åŠ›ã€ã€‚${tl}é€™ä»¶äº‹ä¸æ˜¯ä¸è¡Œï¼Œè€Œæ˜¯éœ€è¦æ›´è°æ˜çš„åšæ³•ã€‚`);
    lines.push('æˆ‘çš„å»ºè­°æ˜¯ï¼šä¸è¦å…¨æŠ¼ï¼Œå…ˆå°ç¯„åœè©¦æ°´æº«ï¼Œæœ‰æ­£å‘å›é¥‹å†æ”¾å¤§ã€‚');
  }else{
    lines.push(`æˆ‘å¿…é ˆå¦ç™½èªªï¼Œç›®å‰çš„è±¡å¾µä¸å¤ªæ”¯æŒä½ åœ¨${tl}ä¸Šå¤§å‹•ä½œã€‚`);
    lines.push(`é€™ä¸ä»£è¡¨ä½ ä¸å¥½ â€” æ˜¯æ™‚æ©Ÿé‚„æ²’åˆ°ã€‚èˆ‡å…¶ç¡¬æ¨ï¼Œä¸å¦‚å…ˆ${fav?'è£œ'+fav+'è¡Œèƒ½é‡ï¼Œ':''}èª¿æ•´ç‹€æ…‹ï¼Œç­‰æ›´å¥½çš„æ™‚æ©Ÿå†å‡ºæ‰‹ã€‚`);
  }

  // Meihua
  if(mh){
    lines.push(`æ¢…èŠ±æ˜“æ•¸çµ¦äº†ä½ ä¸€å€‹æœ‰è¶£çš„ä¿¡è™Ÿï¼šã€Œ${mh.ben.n}ã€â†’ã€Œ${mh.bian.n}ã€ï¼Œ${mh.ty.r==='ç”Ÿ'?'é«”ç”¨ç›¸ç”Ÿï¼Œäº‹æƒ…çš„ç™¼å±•æ–¹å‘æ˜¯æœ‰åˆ©çš„':mh.ty.r==='åŒ'?'é«”ç”¨æ¯”å’Œï¼Œç¶­æŒç¾ç‹€ä¸æœƒå‡ºå¤§å•é¡Œ':mh.ty.r==='å‰‹'?'é«”ç”¨ç›¸å‰‹ï¼Œè¦ç‰¹åˆ¥æ³¨æ„ç´°ç¯€å’Œæ™‚æ©Ÿ':'éœ€è¦æ›´å¤šè€å¿ƒå»ç­‰å¾…'}ã€‚`);
  }

  // Tarot
  if(tarot && tarot.drawn && tarot.drawn.length){
    const core = tarot.drawn[0];
    const fin = tarot.drawn[9];
    lines.push(`å¡”ç¾…çš„æ ¸å¿ƒç‰Œæ˜¯ã€Œ${core.n}ã€${core.isUp?'æ­£ä½':'é€†ä½'} â€” ${core.isUp?'é€™å¼µç‰Œå‘Šè¨´ä½ ï¼Œä½ å•çš„æ–¹å‘æ˜¯å°çš„':'é€™å¼µç‰Œæé†’ä½ ï¼Œå¯èƒ½éœ€è¦æ›å€‹è§’åº¦æ€è€ƒ'}ã€‚`);
    if(fin) lines.push(`æœ€çµ‚çµæœç‰Œã€Œ${fin.n}ã€${fin.isUp?'æ­£ä½ï¼Œæ•´é«”èµ°å‘æ˜¯æ­£é¢çš„':'é€†ä½ï¼Œçµæœå¯èƒ½è·Ÿé æœŸä¸åŒï¼Œä½†ä¸ä¸€å®šæ˜¯å£äº‹'}ã€‚`);
  }

  // Crystal advice as personal recommendation
  if(fav){
    lines.push(`æœ€å¾Œï¼Œå¦‚æœä½ æƒ³å¾èƒ½é‡å±¤é¢å¹«è‡ªå·±ä¸€æŠŠï¼Œæˆ‘å»ºè­°ä½ ä½©æˆ´${fav}è¡Œçš„æ°´æ™¶ã€‚ä¸æ˜¯è¿·ä¿¡ï¼Œæ˜¯çµ¦è‡ªå·±ä¸€å€‹ã€Œæé†’ç‰©ã€â€” æ¯æ¬¡çœ‹åˆ°æ‰‹ä¸Šçš„æ°´æ™¶ï¼Œå°±æƒ³èµ·ä»Šå¤©çš„æ±ºå®šå’Œæ–¹å‘ã€‚`);
  }

  // Closing
  const closings = [
    'è¨˜ä½ï¼Œå‘½ç†æ˜¯æ–¹å‘ç›¤ï¼Œä¸æ˜¯å®šé€Ÿå·¡èˆªã€‚æ–¹å‘å°äº†ï¼Œé€Ÿåº¦ç”±ä½ æ±ºå®šã€‚',
    'æœ€å¾Œé€ä½ ä¸€å¥ï¼šç›¡äººäº‹ï¼Œè½å¤©å‘½ã€‚ä½ å·²ç¶“åœ¨ã€Œç›¡äººäº‹ã€äº†ï¼Œé€™å¾ˆå¥½ã€‚',
    'å‘½ç›¤æ˜¯åœ°åœ–ï¼Œè·¯é‚„æ˜¯ä½ è‡ªå·±èµ°çš„ã€‚åŠ æ²¹ã€‚',
    'åšå¥½æº–å‚™ï¼Œç„¶å¾Œç›¸ä¿¡è‡ªå·±çš„åˆ¤æ–·ã€‚ç¥ä¸€åˆ‡é †åˆ© âœ¨'
  ];
  lines.push(closings[Math.floor(Math.random()*closings.length)]);

  return lines.filter(l=>l).map(l=>`<p>${l}</p>`).join('');
}

/* =============================================================
   7) 7å¤©å¾Œæé†’å†æ¸¬ï¼ˆæ—¥æ›†äº‹ä»¶ï¼‰
   ============================================================= */
function addReminder7Days(){
  const now = new Date();
  const remind = new Date(now.getTime() + 7*24*60*60*1000);
  const fmt = d => d.toISOString().replace(/[-:]/g,'').replace(/\.\d+/,'');

  const icsContent = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//éœæœˆä¹‹å…‰//å åœæé†’//ZH',
    'BEGIN:VEVENT',
    'DTSTART:' + fmt(remind),
    'DTEND:' + fmt(new Date(remind.getTime()+30*60*1000)),
    'SUMMARY:â° éœæœˆä¹‹å…‰ï¼šè©²å›ä¾†æ¸¬ä¸€ä¸‹é‹å‹¢äº†ï¼',
    'DESCRIPTION:ä¸Šæ¬¡æ¸¬çš„çµæœå·²ç¶“éäº†7å¤©ï¼Œé‹å‹¢å¯èƒ½æœ‰è®ŠåŒ–ã€‚\\nå…è²»å†æ¸¬ä¸€æ¬¡ï¼š' + window.location.href.split('?')[0],
    'URL:' + window.location.href.split('?')[0],
    'TRANSP:TRANSPARENT',
    'BEGIN:VALARM',
    'TRIGGER:-PT10M',
    'ACTION:DISPLAY',
    'DESCRIPTION:éœæœˆä¹‹å…‰å åœæé†’',
    'END:VALARM',
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');

  const blob = new Blob([icsContent], {type:'text/calendar;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'éœæœˆå åœæé†’.ics';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),3000);

  // Visual feedback
  const btn = document.getElementById('btn-remind');
  if(btn){
    btn.innerHTML = '<i class="fas fa-check"></i> å·²åŠ å…¥æ—¥æ›†ï¼';
    btn.disabled = true;
  }
}

/* =============================================================
   Patch renderProductCrystal to include urgency + social proof
   ============================================================= */
const _origRPC2 = renderProductCrystal;
renderProductCrystal = function(bazi, type){
  _origRPC2(bazi, type);
  // Inject urgency into each product card
  document.querySelectorAll('.product-card').forEach(card => {
    const name = card.querySelector('.product-name');
    if(name && !card.querySelector('.urgency-strip')){
      const u = document.createElement('div');
      u.innerHTML = getUrgencyHTML(name.textContent);
      card.querySelector('.product-body').appendChild(u.firstElementChild);
    }
  });
  // Inject social proof before product grid
  const crystalEl = document.getElementById('r-crystal');
  if(crystalEl && !crystalEl.querySelector('.social-proof')){
    const header = crystalEl.querySelector('.crystal-rec-header');
    if(header){
      const sp = document.createElement('div');
      sp.innerHTML = getSocialProofHTML(bazi.fav[0], type);
      header.after(sp.firstElementChild);
    }
  }
};

/* =============================================================
   Patch conclusion to use AI style
   ============================================================= */
const _origGenConclusion = generateConclusion;
generateConclusion = function(type, prob, bazi, mh, tarot){
  return generateAIConclusion(type, prob, bazi, mh, tarot);
};

/* =============================================================
   Init on DOMContentLoaded
   ============================================================= */
document.addEventListener('DOMContentLoaded', function(){
  initLiveCounter();
  // Show PWA banner after 5 seconds for iOS
  setTimeout(function(){
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    if(!isStandalone) showPWABanner();
  }, 5000);
});
/* =============================================================
   FEATURE 1: æ¯æ—¥é‹å‹¢ç±¤
   ============================================================= */
const FORTUNE_SIGNS = [
  {sign:'ä¸Šä¸Šç±¤',icon:'ğŸŒŸ',msg:'è«¸äº‹çš†å®œï¼ŒæŠŠæ¡ä»Šæ—¥å¥½é‹æ°£ï¼',crystal:'éˆ¦æ™¶',el:'é‡‘',reason:'å¼·åŒ–ä»Šæ—¥çš„æ­£è²¡ç£å ´'},
  {sign:'ä¸Šå‰ç±¤',icon:'âœ¨',msg:'è²´äººç›¸åŠ©ï¼Œç©æ¥µè¡Œå‹•å¿…æœ‰æ”¶ç©«ã€‚',crystal:'ç¶ å¹½éˆ',el:'æœ¨',reason:'æ‹›å¼•è²´äººèˆ‡æ­£è²¡èƒ½é‡'},
  {sign:'ä¸­å‰ç±¤',icon:'ğŸŒ™',msg:'ç©©ä¸­æ±‚é€²ï¼Œé©åˆè¦åŠƒèˆ‡å­¸ç¿’ã€‚',crystal:'ç´«æ°´æ™¶',el:'ç«',reason:'æå‡æ€ç·’æ¸…æ™°åº¦èˆ‡ç›´è¦º'},
  {sign:'ä¸­å¹³ç±¤',icon:'â˜ï¸',msg:'é †å…¶è‡ªç„¶ï¼Œä¸å®œæ€¥èºå†’é€²ã€‚',crystal:'èŒ¶æ™¶',el:'åœŸ',reason:'ç©©å®šå¿ƒæ€§ï¼Œæ’é™¤æµ®èºèƒ½é‡'},
  {sign:'å°å‰ç±¤',icon:'ğŸŒ¤ï¸',msg:'å°æœ‰é€²å±•ï¼Œè€å¿ƒç­‰å¾…æ™‚æ©Ÿæˆç†Ÿã€‚',crystal:'é»ƒæ°´æ™¶',el:'åœŸ',reason:'æ‹›åè²¡ï¼Œæå‡è€å¿ƒèˆ‡è‡ªä¿¡'},
  {sign:'å‰ç±¤',icon:'ğŸ’«',msg:'å¿ƒæƒ³äº‹æˆçš„æ©Ÿç‡æ­£åœ¨ä¸Šå‡ä¸­ã€‚',crystal:'æµ·è—å¯¶',el:'æ°´',reason:'å¢å¼·æºé€šåŠ›ï¼ŒåŠ©é¡˜æœ›é”æˆ'},
  {sign:'ä¸Šå‰ç±¤',icon:'ğŸ”¥',msg:'è¡Œå‹•åŠ›æ»¿é»ï¼Œä»Šå¤©é©åˆåšé‡è¦æ±ºå®šï¼',crystal:'ç´…ç‘ªç‘™',el:'ç«',reason:'æ¿€ç™¼å‹‡æ°£èˆ‡è¡Œå‹•åŠ›'},
  {sign:'ä¸­å‰ç±¤',icon:'ğŸ’',msg:'å…§åœ¨èƒ½é‡å……æ²›ï¼Œé©åˆéœå¿ƒæ€è€ƒæ–¹å‘ã€‚',crystal:'æœˆå…‰çŸ³',el:'æ°´',reason:'å¢å¼·ç›´è¦ºï¼Œç…§äº®å…§å¿ƒæ–¹å‘'},
  {sign:'å¤§å‰ç±¤',icon:'ğŸŠ',msg:'å¤©æ™‚åœ°åˆ©äººå’Œï¼Œé›£å¾—çš„å¥½æ—¥å­ï¼',crystal:'ç²‰æ™¶',el:'åœŸ',reason:'äººç·£æ¡ƒèŠ±å…¨é–‹ï¼ŒæŠŠæ¡ç¤¾äº¤æ©Ÿæœƒ'},
  {sign:'ä¸­å¹³ç±¤',icon:'ğŸŒŠ',msg:'å¦‚æ°´èˆ¬æŸ”è»Ÿæ‡‰å°ï¼Œå‰›å‰‡æ˜“æŠ˜ã€‚',crystal:'è—ç‰é«“',el:'æ°´',reason:'æŸ”åŒ–å€‹æ€§ï¼Œå¢å¼·é©æ‡‰åŠ›'},
  {sign:'å°å‰ç±¤',icon:'ğŸŒ±',msg:'æ’­ç¨®æœŸï¼Œç¾åœ¨çš„åŠªåŠ›æœªä¾†æœƒé–‹èŠ±ã€‚',crystal:'æ±é™µç‰',el:'æœ¨',reason:'å¸¶ä¾†ç”Ÿé•·èˆ‡å¸Œæœ›çš„èƒ½é‡'},
  {sign:'ä¸Šå‰ç±¤',icon:'âš¡',msg:'éˆæ„Ÿçˆ†ç™¼æ—¥ï¼Œå‰µæ„èˆ‡æ©ŸæœƒåŒæ­¥åˆ°ä¾†ï¼',crystal:'é‡‘å¤ªé™½',el:'ç«',reason:'æ¿€ç™¼å‰µé€ åŠ›èˆ‡é ˜å°é­…åŠ›'}
];

function getDailyFortune(){
  const today = new Date().toISOString().slice(0,10);
  const key = 'jy_daily_' + today;
  let cached = null;
  try{ cached = JSON.parse(localStorage.getItem(key)); }catch(e){}
  
  if(cached) return cached;
  
  // Better hash: each character contributes uniquely
  let hash = 0;
  for(let i=0;i<today.length;i++){
    hash = ((hash << 5) - hash + today.charCodeAt(i)) | 0;
  }
  const idx = Math.abs(hash) % FORTUNE_SIGNS.length;
  const fortune = FORTUNE_SIGNS[idx];
  const result = {...fortune, date: today, drawn: true};
  try{ localStorage.setItem(key, JSON.stringify(result)); }catch(e){}
  return result;
}

function canDrawToday(){
  const today = new Date().toISOString().slice(0,10);
  const key = 'jy_daily_' + today;
  try{
    // Clean up old dates
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(k && k.startsWith('jy_daily_') && k !== key){
        localStorage.removeItem(k);
      }
    }
    return !localStorage.getItem(key);
  }catch(e){ return true; }
}

function renderDailyFortune(){
  const container = document.getElementById('daily-fortune-content');
  if(!container) return;
  
  if(canDrawToday()){
    container.innerHTML = `
      <div class="fortune-draw-area">
        <div class="fortune-urn">ğŸ®</div>
        <p class="text-dim">å¿ƒä¸­é»˜å¿µä½ çš„å•é¡Œï¼Œç„¶å¾ŒæŠ½ç±¤</p>
        <button class="btn btn-gold" onclick="drawDailyFortune()" id="btn-draw-fortune">
          <i class="fas fa-hand-sparkles"></i> æŠ½ä»Šæ—¥é‹å‹¢ç±¤
        </button>
      </div>`;
  } else {
    showFortuneResult(getDailyFortune());
  }
}

function drawDailyFortune(){
  const btn = document.getElementById('btn-draw-fortune');
  if(btn){ btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> æŠ½ç±¤ä¸­...'; }
  
  // Dramatic pause
  setTimeout(()=>{
    const fortune = getDailyFortune();
    showFortuneResult(fortune);
  }, 1500);
}

function showFortuneResult(f){
  const container = document.getElementById('daily-fortune-content');
  if(!container) return;
  
  const prod = findProductByName(f.crystal);
  container.innerHTML = `
    <div class="fortune-result" style="animation:scaleIn 0.5s ease">
      <div class="fortune-sign-icon">${f.icon}</div>
      <div class="fortune-sign-text">${f.sign}</div>
      <p class="fortune-msg">${f.msg}</p>
      <div class="fortune-divider"></div>
      <div class="fortune-crystal-rec">
        <p class="text-sm"><strong>ä»Šæ—¥å¹¸é‹æ°´æ™¶ï¼š</strong></p>
        <div class="fortune-crystal-card">
          <span class="fortune-crystal-name">${f.crystal}</span>
          <span class="el-tag el-${f.el} text-xs">${f.el}è¡Œ</span>
        </div>
        <p class="text-xs text-dim">${f.reason}</p>
        <div class="fortune-buy-btns mt-sm">
          <a href="${prod?prod.shopee:'https://tw.shp.ee/2n5Mo2w'}" target="_blank" rel="noopener" class="product-btn shopee"><i class="fas fa-shopping-cart"></i> è¦çš®å…¥æ‰‹</a>
          <a href="${prod?prod.seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}" target="_blank" rel="noopener" class="product-btn seven"><i class="fas fa-box"></i> 7-11</a>
        </div>
      </div>
      <p class="text-xs text-muted mt-md">æ˜å¤©å¯ä»¥å†æŠ½ä¸€æ¬¡ âœ¨ æ¯æ—¥ 00:00 é‡ç½®</p>
    </div>`;
}

function findProductByName(name){
  for(const el of Object.values(REAL_PRODUCTS)){
    if(!Array.isArray(el)) continue;
    const found = el.find(p=>p.n.includes(name));
    if(found) return found;
  }
  return null;
}

/* =============================================================
   FEATURE 2: æˆå°±å¾½ç« ç³»çµ±
   ============================================================= */
const ACHIEVEMENTS = [
  {id:'first',name:'åˆæ¬¡å•å¦',icon:'ğŸŒ±',desc:'å®Œæˆç¬¬ä¸€æ¬¡å åœ',need:1},
  {id:'curious',name:'å¥½å¥‡å¯¶å¯¶',icon:'ğŸ”',desc:'ç´¯è¨ˆå åœ 3 æ¬¡',need:3},
  {id:'seeker',name:'å‘½ç†æ¢ç´¢è€…',icon:'ğŸ§­',desc:'ç´¯è¨ˆå åœ 5 æ¬¡',need:5},
  {id:'devoted',name:'è™”èª ä¿¡å¾’',icon:'ğŸ™',desc:'ç´¯è¨ˆå åœ 10 æ¬¡',need:10},
  {id:'master',name:'å åœå¤§å¸«',icon:'ğŸ§™',desc:'ç´¯è¨ˆå åœ 20 æ¬¡',need:20},
  {id:'crystal',name:'æ°´æ™¶é”äºº',icon:'ğŸ’',desc:'æŸ¥çœ‹æ°´æ™¶ç™¾ç§‘ 5 ç¨®ä»¥ä¸Š',need:5,type:'crystal_views'},
  {id:'sharer',name:'åˆ†äº«æ§',icon:'ğŸ“£',desc:'åˆ†äº«çµæœçµ¦æœ‹å‹',need:1,type:'shares'},
  {id:'daily',name:'æ¯æ—¥å ±åˆ°',icon:'ğŸ“…',desc:'é€£çºŒ 3 å¤©æŠ½é‹å‹¢ç±¤',need:3,type:'daily_streak'},
  {id:'alltype',name:'å…¨èƒ½å•å¦å¸«',icon:'ğŸ­',desc:'å•é 5 ç¨®ä¸åŒé¡å‹çš„å•é¡Œ',need:5,type:'types_asked'}
];

function getAchievementData(){
  try{
    return JSON.parse(localStorage.getItem('jy_achievements')||'{}');
  }catch(e){ return {}; }
}

function saveAchievementData(data){
  try{ localStorage.setItem('jy_achievements', JSON.stringify(data)); }catch(e){}
}

function incrementAchievement(type, value){
  const data = getAchievementData();
  if(!data.counts) data.counts={};
  if(type === 'divination'){
    data.counts.divination = (data.counts.divination||0) + 1;
  } else if(type === 'crystal_views'){
    if(!data.counts.crystal_views) data.counts.crystal_views = new Set();
    // Sets don't serialize well, use array
    if(!Array.isArray(data.counts.crystal_views)) data.counts.crystal_views = [];
    if(!data.counts.crystal_views.includes(value)){
      data.counts.crystal_views.push(value);
    }
  } else if(type === 'shares'){
    data.counts.shares = (data.counts.shares||0) + 1;
  } else if(type === 'types_asked'){
    if(!Array.isArray(data.counts.types_asked)) data.counts.types_asked = [];
    if(value && !data.counts.types_asked.includes(value)){
      data.counts.types_asked.push(value);
    }
  } else if(type === 'daily_streak'){
    const today = new Date().toISOString().slice(0,10);
    if(!data.counts.daily_dates) data.counts.daily_dates = [];
    if(!data.counts.daily_dates.includes(today)){
      data.counts.daily_dates.push(today);
    }
    // Calculate streak
    data.counts.daily_streak = calcStreak(data.counts.daily_dates);
  }
  saveAchievementData(data);
  checkNewAchievements(data);
}

function calcStreak(dates){
  if(!dates||!dates.length) return 0;
  const sorted = [...dates].sort().reverse();
  let streak = 1;
  for(let i=1;i<sorted.length;i++){
    const prev = new Date(sorted[i-1]);
    const curr = new Date(sorted[i]);
    const diff = (prev - curr) / (1000*60*60*24);
    if(diff === 1) streak++;
    else break;
  }
  return streak;
}

function checkNewAchievements(data){
  if(!data.counts) return;
  if(!data.unlocked) data.unlocked = [];
  
  ACHIEVEMENTS.forEach(a=>{
    if(data.unlocked.includes(a.id)) return;
    let count = 0;
    if(!a.type || a.type === 'divination') count = data.counts.divination || 0;
    else if(a.type === 'crystal_views') count = (data.counts.crystal_views||[]).length;
    else if(a.type === 'shares') count = data.counts.shares || 0;
    else if(a.type === 'daily_streak') count = data.counts.daily_streak || 0;
    else if(a.type === 'types_asked') count = (data.counts.types_asked||[]).length;
    
    if(count >= a.need){
      data.unlocked.push(a.id);
      showAchievementToast(a);
    }
  });
  saveAchievementData(data);
}

function showAchievementToast(a){
  const toast = document.createElement('div');
  toast.className = 'achievement-toast';
  toast.innerHTML = `<span class="at-icon">${a.icon}</span><div><strong>æˆå°±è§£é–ï¼</strong><br>${a.name}</div>`;
  document.body.appendChild(toast);
  setTimeout(()=>toast.classList.add('show'), 50);
  setTimeout(()=>{toast.classList.remove('show');setTimeout(()=>toast.remove(),500)}, 3500);
}

function renderAchievements(){
  const container = document.getElementById('achievements-grid');
  if(!container) return;
  const data = getAchievementData();
  const unlocked = data.unlocked || [];
  
  container.innerHTML = ACHIEVEMENTS.map(a=>{
    const isUnlocked = unlocked.includes(a.id);
    return `<div class="achievement-badge ${isUnlocked?'unlocked':'locked'}">
      <div class="badge-icon">${isUnlocked?a.icon:'ğŸ”’'}</div>
      <div class="badge-name">${a.name}</div>
      <div class="badge-desc text-xs text-muted">${a.desc}</div>
    </div>`;
  }).join('');
  
  const total = ACHIEVEMENTS.length;
  const done = unlocked.length;
  document.getElementById('achievement-progress').textContent = `${done}/${total} å·²è§£é–`;
}

/* =============================================================
   FEATURE 3: æ°´æ™¶ç™¾ç§‘åœ–é‘‘
   ============================================================= */
function renderCrystalEncyclopedia(){
  const container = document.getElementById('crystal-encyclopedia-grid');
  if(!container) return;
  
  const allCrystals = [];
  const seen = new Set();
  for(const [category, items] of Object.entries(REAL_PRODUCTS)){
    if(!Array.isArray(items)) continue;
    items.forEach(p=>{
      if(seen.has(p.n)) return;
      seen.add(p.n);
      allCrystals.push({...p, _cat: category});
    });
  }
  
  container.innerHTML = allCrystals.map(c=>`
    <div class="ency-card" onclick="showCrystalDetail('${c.n.replace(/'/g,"\\'")}')">
      <div class="ency-icon">${c.icon}</div>
      <div class="ency-name">${c.n}</div>
      <div class="ency-meta">
        ${c.el!=='å…¨'?`<span class="el-tag el-${c.el} text-xs">${c.el}è¡Œ</span>`:'<span class="tag text-xs" style="color:var(--c-gold)">äº”è¡Œå…¨</span>'}
        <span class="text-xs text-muted">${c.cat}</span>
      </div>
      <p class="ency-desc">${c.d}</p>
      <p class="ency-price">${c.price}</p>
    </div>`).join('');
}

function showCrystalDetail(name){
  incrementAchievement('crystal_views', name);
  
  let crystal = null;
  for(const items of Object.values(REAL_PRODUCTS)){
    if(!Array.isArray(items)) continue;
    crystal = items.find(p=>p.n === name);
    if(crystal) break;
  }
  if(!crystal) return;
  
  const modal = document.getElementById('crystal-detail-modal');
  if(!modal) return;
  
  modal.innerHTML = `
    <div class="cdm-overlay" onclick="closeCrystalDetail()"></div>
    <div class="cdm-content">
      <button class="cdm-close" onclick="closeCrystalDetail()"><i class="fas fa-times"></i></button>
      <div class="cdm-icon">${crystal.icon}</div>
      <h3 class="cdm-name">${crystal.n}</h3>
      <div class="cdm-tags">
        ${crystal.el!=='å…¨'?`<span class="el-tag el-${crystal.el}">${crystal.el}è¡Œ</span>`:'<span class="tag" style="color:var(--c-gold)">äº”è¡Œå…¨</span>'}
        <span class="tag tag-gold">${crystal.cat}</span>
      </div>
      <p class="cdm-desc">${crystal.d}</p>
      <div class="cdm-info">
        <div class="cdm-row"><i class="fas fa-tag"></i> åƒ¹æ ¼ï¼š<strong>${crystal.price}</strong></div>
        <div class="cdm-row"><i class="fas fa-hand-holding-heart"></i> ä½©æˆ´æ–¹å¼ï¼š${crystal.wear}</div>
      </div>
      <div class="cdm-actions">
        <a href="${crystal.shopee}" target="_blank" rel="noopener" class="btn btn-gold"><i class="fas fa-shopping-cart"></i> è¦çš®è³¼è²·</a>
        <a href="${crystal.seven}" target="_blank" rel="noopener" class="btn btn-outline"><i class="fas fa-box"></i> 7-11</a>
      </div>
    </div>`;
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeCrystalDetail(){
  const modal = document.getElementById('crystal-detail-modal');
  if(modal) modal.classList.add('hidden');
  document.body.style.overflow = '';
}

/* =============================================================
   FEATURE 4: æ°´æ™¶é…å°æ¸¬é©—
   ============================================================= */
const QUIZ_QUESTIONS = [
  {q:'é¢å°å£“åŠ›æ™‚ï¼Œä½ é€šå¸¸æœƒï¼Ÿ',opts:[
    {t:'æ·±å‘¼å¸ï¼Œå†·éœåˆ†æ',el:'æ°´',trait:'ç†æ€§'},
    {t:'æ‰¾æœ‹å‹èŠèŠå‚¾è¨´',el:'æœ¨',trait:'ç¤¾äº¤'},
    {t:'ç«‹åˆ»è¡Œå‹•è§£æ±ºå•é¡Œ',el:'ç«',trait:'è¡Œå‹•'},
    {t:'ç¨è™•éœå¿ƒç­‰éˆæ„Ÿ',el:'é‡‘',trait:'ç›´è¦º'}
  ]},
  {q:'ä½ æœ€åš®å¾€çš„ç”Ÿæ´»æ–¹å¼ï¼Ÿ',opts:[
    {t:'ç©©å®šæœ‰è¦å¾‹çš„æ—¥å¸¸',el:'åœŸ',trait:'ç©©å®š'},
    {t:'å……æ»¿å†’éšªèˆ‡æ–°é®®æ„Ÿ',el:'ç«',trait:'å†’éšª'},
    {t:'è‡ªç”±è‡ªåœ¨ä¸å—æ‹˜æŸ',el:'æ°´',trait:'è‡ªç”±'},
    {t:'å’Œè«§æº«é¦¨çš„å®¶åº­',el:'æœ¨',trait:'æº«æš–'}
  ]},
  {q:'å¦‚æœæ°´æ™¶æœ‰é¡è‰²ï¼Œæœ€å¸å¼•ä½ çš„æ˜¯ï¼Ÿ',opts:[
    {t:'é€æ˜ / ç™½è‰² â€” ç´”æ·¨',el:'é‡‘',trait:'ç´”æ·¨'},
    {t:'ç²‰ç´… / ç´«è‰² â€” æµªæ¼«',el:'ç«',trait:'æµªæ¼«'},
    {t:'ç¶ è‰² / è—è‰² â€” å¯§éœ',el:'æœ¨',trait:'å¯§éœ'},
    {t:'é‡‘è‰² / æ£•è‰² â€” å¤§åœ°',el:'åœŸ',trait:'è¸å¯¦'}
  ]}
];

let quizState = {step:0, answers:[]};

function startCrystalQuiz(){
  quizState = {step:0, answers:[]};
  renderQuizStep();
}

function renderQuizStep(){
  const container = document.getElementById('crystal-quiz-content');
  if(!container) return;
  
  if(quizState.step >= QUIZ_QUESTIONS.length){
    showQuizResult();
    return;
  }
  
  const q = QUIZ_QUESTIONS[quizState.step];
  container.innerHTML = `
    <div class="quiz-progress">ç¬¬ ${quizState.step+1}/${QUIZ_QUESTIONS.length} é¡Œ</div>
    <div class="quiz-progress-bar"><div class="quiz-fill" style="width:${(quizState.step/QUIZ_QUESTIONS.length)*100}%"></div></div>
    <h4 class="quiz-question">${q.q}</h4>
    <div class="quiz-options">${q.opts.map((o,i)=>`
      <button class="quiz-option" onclick="answerQuiz(${i})">
        <span>${o.t}</span>
      </button>`).join('')}
    </div>`;
}

function answerQuiz(idx){
  const q = QUIZ_QUESTIONS[quizState.step];
  quizState.answers.push(q.opts[idx]);
  quizState.step++;
  renderQuizStep();
}

function showQuizResult(){
  const container = document.getElementById('crystal-quiz-content');
  if(!container) return;
  
  // Count elements
  const elCount = {};
  quizState.answers.forEach(a=>{
    elCount[a.el] = (elCount[a.el]||0) + 1;
  });
  const topEl = Object.entries(elCount).sort((a,b)=>b[1]-a[1])[0][0];
  const traits = quizState.answers.map(a=>a.trait);
  
  // Find best matching crystal
  const candidates = REAL_PRODUCTS[topEl] || REAL_PRODUCTS['åœŸ'];
  const pick = candidates[Math.floor(Math.random()*Math.min(3,candidates.length))];
  
  container.innerHTML = `
    <div class="quiz-result" style="animation:scaleIn 0.5s">
      <div class="quiz-result-icon">${pick.icon}</div>
      <h3 class="quiz-result-title">ä½ çš„å‘½å®šæ°´æ™¶æ˜¯</h3>
      <div class="quiz-result-crystal">${pick.n}</div>
      <div class="quiz-result-el">
        <span class="el-tag el-${pick.el}">${pick.el}è¡Œ</span>
        <span class="tag tag-gold">${pick.cat}</span>
      </div>
      <p class="quiz-result-desc">${pick.d}</p>
      <p class="quiz-result-traits text-sm text-dim">ä½ çš„ç‰¹è³ªï¼š${traits.join(' Â· ')}</p>
      <div class="quiz-result-actions mt-md">
        <a href="${pick.shopee}" target="_blank" rel="noopener" class="btn btn-gold"><i class="fas fa-shopping-cart"></i> å»è¦çš®æ“æœ‰å®ƒ</a>
        <button class="btn btn-outline" onclick="startCrystalQuiz()"><i class="fas fa-redo"></i> å†æ¸¬ä¸€æ¬¡</button>
      </div>
      <button class="btn btn-outline btn-sm mt-md" onclick="shareQuizResult('${pick.n}','${traits.join('Â·')}')">
        <i class="fas fa-share-alt"></i> åˆ†äº«æˆ‘çš„å‘½å®šæ°´æ™¶
      </button>
    </div>`;
}

function shareQuizResult(crystal, traits){
  const text = `æˆ‘çš„å‘½å®šæ°´æ™¶æ˜¯ã€Œ${crystal}ã€ï¼ç‰¹è³ªï¼š${traits}ã€‚ä½ çš„å‘¢ï¼Ÿå¿«ä¾†æ¸¬ ğŸ‘‰ `;
  const url = window.location.href.split('?')[0];
  if(navigator.share){
    navigator.share({title:'æˆ‘çš„å‘½å®šæ°´æ™¶',text:text,url:url}).catch(()=>{});
  } else {
    navigator.clipboard.writeText(text+url).then(()=>alert('å·²è¤‡è£½ï¼è²¼åˆ° LINE/IG åˆ†äº«çµ¦æœ‹å‹'));
  }
  incrementAchievement('shares',1);
}

/* =============================================================
   FEATURE 5: å¥½è©•è¼ªæ’­
   ============================================================= */
const REVIEWS = [
  {name:'å°é›¨',city:'å°åŒ—',crystal:'ç²‰æ™¶æ‰‹éˆ',stars:5,text:'æˆ´äº†ç²‰æ™¶ä¹‹å¾ŒçœŸçš„æœ‰äººè·Ÿæˆ‘æ­è©±ï¼é›–ç„¶ä¸ç¢ºå®šæ˜¯ä¸æ˜¯æ°´æ™¶çš„åŠŸå‹ï¼Œä½†å¿ƒæƒ…è®Šå¥½æ˜¯çœŸçš„ ğŸ’•',time:'2é€±å‰'},
  {name:'é˜¿å‡±',city:'é«˜é›„',crystal:'éˆ¦æ™¶æ‰‹æ’',stars:5,text:'é¢è©¦å‰ç‰¹åœ°æˆ´ä¸Šï¼Œçµæœé‚£å¤©è¶…æœ‰è‡ªä¿¡ï¼Œé †åˆ©æ‹¿åˆ° offerï¼å·²ç¶“å›è³¼ç¬¬äºŒæ¢é€è€çˆ¸ã€‚',time:'1å€‹æœˆå‰'},
  {name:'Mei',city:'å°ä¸­',crystal:'é»ƒæ°´æ™¶',stars:5,text:'æœ‹å‹æ¨è–¦çš„æ‹›è²¡æ°´æ™¶ï¼Œæˆ´äº†ä¸€å€‹æœˆå¾Œä¸­äº†ç™¼ç¥¨ 200 å…ƒå“ˆå“ˆï¼Œå°ç¢ºå¹¸ï¼',time:'3é€±å‰'},
  {name:'æ›‰æ›‰',city:'æ–°ç«¹',crystal:'ç´«æ°´æ™¶',stars:5,text:'ç¡çœ çœŸçš„æœ‰æ”¹å–„ï¼ä»¥å‰ç¿»ä¾†è¦†å»ï¼Œç¾åœ¨æ”¾æ•é ­æ—å¾ˆå¿«å°±å…¥ç¡äº†ã€‚',time:'5å¤©å‰'},
  {name:'å¤§ç¶­',city:'æ¡ƒåœ’',crystal:'ç¶ å¹½éˆ',stars:5,text:'è€é—†çªç„¶çµ¦åŠ è–ªï¼Œé›–ç„¶å¯èƒ½è·Ÿæ°´æ™¶æ²’æœ‰ç›´æ¥é—œä¿‚ï¼Œä½†æ„Ÿè¦ºé‹æ°£è®Šå¥½äº†ã€‚',time:'2é€±å‰'},
  {name:'å°ç¾½',city:'å°å—',crystal:'æµ·è—å¯¶',stars:5,text:'å ±å‘Šç°¡å ±é‚£å¤©æˆ´è‘—ï¼Œè¬›å¾—æ¯”å¹³æ™‚æµåˆ©å¾ˆå¤šï¼ŒåŒäº‹éƒ½å•æˆ‘åƒäº†ä»€éº¼ã€‚',time:'1é€±å‰'},
  {name:'Vivian',city:'å˜‰ç¾©',crystal:'å½©è¶…ä¸ƒ',stars:5,text:'é€è‡ªå·±çš„ç”Ÿæ—¥ç¦®ç‰©ï¼Œè¶…ç¾çš„ï¼è€Œä¸”æœ€è¿‘å¥½åƒä»€éº¼äº‹éƒ½æ¯”è¼ƒé †ã€‚',time:'4å¤©å‰'},
  {name:'é˜¿ç¿”',city:'å±æ±',crystal:'é»‘æ›œçŸ³å¿ƒç¶“',stars:5,text:'å»å»Ÿè£¡æ‹œæ‹œç‰¹åœ°æˆ´ï¼Œå®‰å¿ƒæ„Ÿå¾ˆå¤ ã€‚ç£¨ç ‚è³ªæ„Ÿæ‘¸èµ·ä¾†ä¹Ÿå¾ˆèˆ’æœã€‚',time:'10å¤©å‰'}
];

let reviewIdx = 0;
function initReviewCarousel(){
  const el = document.getElementById('review-carousel');
  if(!el) return;
  function show(){
    const r = REVIEWS[reviewIdx % REVIEWS.length];
    el.style.opacity = '0';
    setTimeout(()=>{
      el.innerHTML = `
        <div class="review-card">
          <div class="review-header">
            <span class="review-stars">${'â­'.repeat(r.stars)}</span>
            <span class="review-meta">${r.name} Â· ${r.city} Â· ${r.time}</span>
          </div>
          <p class="review-text">ã€Œ${r.text}ã€</p>
          <div class="review-product">
            <span class="tag tag-gold text-xs">è³¼è²·ï¼š${r.crystal}</span>
          </div>
        </div>`;
      el.style.opacity = '1';
      reviewIdx++;
    }, 300);
  }
  show();
  setInterval(show, 6000);
}

/* =============================================================
   FEATURE 6: å•†å“å¯¦æ‹è¼ªæ’­ï¼ˆæ¡†æ¶ï¼Œç­‰æ›¿æ›ç…§ç‰‡ï¼‰
   ============================================================= */
const PRODUCT_PHOTOS = {
  // æ ¼å¼: 'å•†å“å': ['photo1_url', 'photo2_url', ...]
  // ç›®å‰ç”¨ placeholderï¼Œåº—å®¶æä¾›ç…§ç‰‡å¾Œæ›¿æ› URL
  'éˆ¦æ™¶æ‰‹æ’': [],
  'ç²‰æ™¶': [],
  'ç¶ å¹½éˆ': [],
  'æµ·è—å¯¶': [],
  'ç´«æ°´æ™¶': [],
  'é»ƒæ°´æ™¶': []
};

function initPhotoCarousel(cardEl, productName){
  const photos = PRODUCT_PHOTOS[productName];
  if(!photos || !photos.length) return; // No photos yet, skip
  
  const wrapper = document.createElement('div');
  wrapper.className = 'photo-carousel';
  let pIdx = 0;
  
  function render(){
    wrapper.innerHTML = `
      <img src="${photos[pIdx]}" alt="${productName}" class="photo-slide">
      <div class="photo-dots">${photos.map((_,i)=>`<span class="photo-dot ${i===pIdx?'active':''}"></span>`).join('')}</div>`;
  }
  
  wrapper.addEventListener('click', ()=>{
    pIdx = (pIdx + 1) % photos.length;
    render();
  });
  
  render();
  const iconEl = cardEl.querySelector('.product-icon');
  if(iconEl) iconEl.replaceWith(wrapper);
}

/* =============================================================
   Track divination for achievements
   ============================================================= */
const _origLoadResults = typeof loadResults === 'function' ? loadResults : null;
if(_origLoadResults){
  const __origLR = loadResults;
  loadResults = function(){
    __origLR.apply(this, arguments);
    incrementAchievement('divination');
    if(S.form && S.form.type) incrementAchievement('types_asked', S.form.type);
  };
}

/* =============================================================
   Init all engagement features
   ============================================================= */
document.addEventListener('DOMContentLoaded', function(){
  renderDailyFortune();
  renderAchievements();
  renderCrystalEncyclopedia();
  initReviewCarousel();
  
  // Nav tab switching for new sections
  document.querySelectorAll('.nav-extra-tab').forEach(tab=>{
    tab.addEventListener('click', function(){
      const target = this.dataset.target;
      document.querySelectorAll('.extra-section').forEach(s=>s.classList.add('hidden'));
      const section = document.getElementById(target);
      if(section) section.classList.remove('hidden');
      document.querySelectorAll('.nav-extra-tab').forEach(t=>t.classList.remove('active'));
      this.classList.add('active');
      section.scrollIntoView({behavior:'smooth',block:'start'});
    });
  });
});
</script></body></html>
