<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes,viewport-fit=cover">
<meta name="description" content="éœæœˆä¹‹å…‰èƒ½é‡å åœå„€ï¼šæ•´åˆå…«å­—ã€ç´«å¾®æ–—æ•¸ã€æ¢…èŠ±æ˜“æ•¸ã€å¡”ç¾…ç‰Œçš„å¤šç¶­åº¦å‘½ç†åˆ†æç³»çµ±">
<meta name="theme-color" content="#1a0a0a">
<title>éœæœˆä¹‹å…‰èƒ½é‡å åœå„€ v3.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* ================================================================
   éœæœˆä¹‹å…‰ v3.0 â€” Complete Design System
   Aesthetic: Chinese Traditional Luxury (ç´…é‡‘å‚³çµ±å¥¢è¯)
   ================================================================ */
:root{
  --c-bg-deep:#0d0404;--c-bg:#1a0808;--c-bg-card:#1e0c0c;--c-bg-card-alt:#251010;
  --c-surface:rgba(255,255,255,0.04);--c-border:rgba(212,175,55,0.18);--c-border-hi:rgba(212,175,55,0.45);
  --c-gold:#d4af37;--c-gold-light:#e8c968;--c-gold-pale:#f5e6b8;
  --c-crimson:#8b0000;--c-crimson-hi:#b22222;
  --c-text:#f5e6d3;--c-text-dim:rgba(245,230,211,0.65);--c-text-muted:rgba(245,230,211,0.4);
  --c-success:#4ade80;--c-warn:#fbbf24;--c-danger:#f87171;--c-info:#60a5fa;
  --el-metal:#c0c0c0;--el-wood:#22c55e;--el-water:#3b82f6;--el-fire:#ef4444;--el-earth:#a78b5a;
  --f-display:'Noto Serif TC',serif;--f-body:'Noto Sans TC',sans-serif;
  --sp-xs:0.25rem;--sp-sm:0.5rem;--sp-md:1rem;--sp-lg:1.5rem;--sp-xl:2.5rem;
  --r-sm:8px;--r-md:14px;--r-lg:20px;--r-pill:999px;
  --sh-card:0 4px 24px rgba(0,0,0,0.4),0 0 0 1px var(--c-border);
  --t-fast:0.2s cubic-bezier(0.4,0,0.2,1);--t-smooth:0.4s cubic-bezier(0.4,0,0.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{
  font-family:var(--f-body);color:var(--c-text);
  background:var(--c-bg-deep);
  background-image:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(139,0,0,0.25) 0%,transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 100%,rgba(139,0,0,0.15) 0%,transparent 50%);
  background-attachment:fixed;min-height:100vh;line-height:1.6;
  -webkit-font-smoothing:antialiased;overflow-x:hidden;
}
a{color:var(--c-gold);text-decoration:none;transition:color var(--t-fast)}
a:hover{color:var(--c-gold-light)}
button,input,select,textarea{font-family:inherit;font-size:inherit;color:inherit}
::selection{background:rgba(212,175,55,0.3);color:#fff}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--c-bg)}
::-webkit-scrollbar-thumb{background:rgba(212,175,55,0.3);border-radius:3px}

/* â€” Layout â€” */
.app{max-width:960px;margin:0 auto;padding:0 var(--sp-md);padding-bottom:calc(env(safe-area-inset-bottom,0px) + 1rem)}

/* â€” Navigation â€” */
.nav{position:sticky;top:0;z-index:100;background:rgba(13,4,4,0.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--c-border);padding:0.75rem var(--sp-md)}
.nav-inner{max-width:960px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:var(--sp-md)}
.nav-brand{display:flex;align-items:center;gap:var(--sp-sm);font-family:var(--f-display);font-weight:700;font-size:1.1rem;color:var(--c-gold)}
.nav-brand i{font-size:1.3rem}
.nav-links{display:flex;gap:var(--sp-xs);flex-wrap:wrap}
.nav-link{padding:0.4rem 0.75rem;border-radius:var(--r-pill);font-size:0.8rem;font-weight:500;color:var(--c-text-dim);border:1px solid transparent;transition:all var(--t-fast);cursor:pointer;background:none;white-space:nowrap}
.nav-link:hover,.nav-link.active{color:var(--c-gold);border-color:var(--c-border-hi);background:rgba(212,175,55,0.08)}

/* â€” Step Sections â€” */
.step{display:none;animation:fadeIn .45s ease both}
.step.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
@keyframes slideInLeft{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}

.result-verdict{animation:scaleIn .6s ease .1s both}
.card{animation:fadeIn .5s ease both}
.card:nth-child(2){animation-delay:.1s}
.card:nth-child(3){animation-delay:.2s}
.card:nth-child(4){animation-delay:.3s}
.verdict-prob{
  background-size:200% 100%;
  animation:shimmer 3s ease-in-out infinite;
  background-image:linear-gradient(90deg,var(--c-gold),var(--c-gold-light),#fff,var(--c-gold-light),var(--c-gold));
  -webkit-background-clip:text;background-clip:text;
}
.hero-icon{animation:pulse 3s ease-in-out infinite}
.dy-item{animation:slideInLeft .3s ease both}
.dy-item:nth-child(2){animation-delay:.05s}
.dy-item:nth-child(3){animation-delay:.1s}
.dy-item:nth-child(4){animation-delay:.15s}
.dy-item:nth-child(5){animation-delay:.2s}

/* â€” Cards â€” */
.card{background:var(--c-bg-card);border:1px solid var(--c-border);border-radius:var(--r-lg);padding:var(--sp-lg);margin-bottom:var(--sp-lg);box-shadow:var(--sh-card);transition:border-color var(--t-fast)}
.card:hover{border-color:var(--c-border-hi)}
.card-title{font-family:var(--f-display);font-weight:700;font-size:1.15rem;color:var(--c-gold);margin-bottom:var(--sp-md);display:flex;align-items:center;gap:var(--sp-sm)}
.card-title i{font-size:1rem;opacity:.8}

/* â€” Buttons â€” */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:var(--sp-sm);padding:.75rem 1.25rem;border-radius:var(--r-md);font-weight:600;font-size:.95rem;cursor:pointer;border:1px solid var(--c-border-hi);transition:all var(--t-fast);white-space:nowrap}
.btn-primary{background:linear-gradient(135deg,var(--c-crimson),#6b0000);color:var(--c-gold-pale);border-color:var(--c-gold);box-shadow:0 2px 12px rgba(139,0,0,.4)}
.btn-primary:hover{background:linear-gradient(135deg,var(--c-crimson-hi),var(--c-crimson));box-shadow:0 4px 20px rgba(139,0,0,.6);transform:translateY(-1px)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-outline{background:transparent;color:var(--c-text-dim);border-color:rgba(255,255,255,.15)}
.btn-outline:hover{color:var(--c-gold);border-color:var(--c-border-hi);background:rgba(212,175,55,.06)}
.btn-gold{background:linear-gradient(135deg,var(--c-gold),#b8941f);color:var(--c-bg-deep);border:none;font-weight:700}
.btn-gold:hover{box-shadow:0 4px 20px rgba(212,175,55,.4);transform:translateY(-1px)}
.btn-sm{padding:.5rem .85rem;font-size:.85rem}
.btn-tab-active{background:linear-gradient(135deg,var(--c-crimson),#6b0000)!important;color:var(--c-gold-pale)!important;border-color:var(--c-gold)!important}
.btn-lg{padding:1rem 2rem;font-size:1.05rem}
.btn-block{width:100%}

/* â€” Form â€” */
.form-group{margin-bottom:var(--sp-lg)}
.form-label{display:block;font-size:.9rem;font-weight:600;color:var(--c-text);margin-bottom:var(--sp-xs)}
.form-label .req{color:var(--c-danger);margin-left:2px}
.form-hint{font-size:.8rem;color:var(--c-text-muted);margin-top:var(--sp-xs)}
.form-input,.form-select,.form-textarea{width:100%;padding:.75rem 1rem;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:var(--r-sm);color:var(--c-text);font-size:1rem;transition:border-color var(--t-fast),box-shadow var(--t-fast)}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--c-gold);box-shadow:0 0 0 3px rgba(212,175,55,.15)}
.form-textarea{resize:vertical;min-height:80px}
.radio-pills{display:flex;gap:var(--sp-sm);flex-wrap:wrap}
.radio-pill{position:relative}
.radio-pill input{position:absolute;opacity:0;pointer-events:none}
.radio-pill span{display:inline-block;padding:.6rem 1.2rem;border:1px solid rgba(255,255,255,.12);border-radius:var(--r-pill);cursor:pointer;font-size:.9rem;transition:all var(--t-fast)}
.radio-pill input:checked+span{border-color:var(--c-gold);color:var(--c-gold);background:rgba(212,175,55,.12)}

/* â€” Stepper â€” */
.stepper{display:flex;align-items:center;justify-content:center;padding:var(--sp-md) 0;margin-bottom:var(--sp-md)}
.stepper-item{display:flex;align-items:center;gap:.4rem;font-size:.8rem;color:var(--c-text-muted);transition:color var(--t-fast)}
.stepper-item.active{color:var(--c-gold);font-weight:600}
.stepper-item.done{color:var(--c-success)}
.stepper-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.15);font-size:.75rem;font-weight:700;transition:all var(--t-fast)}
.stepper-item.active .stepper-dot{border-color:var(--c-gold);background:rgba(212,175,55,.15);color:var(--c-gold)}
.stepper-item.done .stepper-dot{border-color:var(--c-success);background:rgba(74,222,128,.15);color:var(--c-success)}
.stepper-line{width:30px;height:2px;background:rgba(255,255,255,.1);margin:0 .3rem}

/* â€” Hero â€” */
.hero{text-align:center;padding:var(--sp-xl) 0 var(--sp-lg)}
.hero-icon{font-size:2.5rem;color:var(--c-gold);margin-bottom:var(--sp-md);text-shadow:0 0 40px rgba(212,175,55,.4)}
.hero h1{font-family:var(--f-display);font-weight:900;font-size:clamp(1.5rem,5vw,2.2rem);color:var(--c-gold-light);margin-bottom:var(--sp-sm);letter-spacing:.05em}
.hero p{color:var(--c-text-dim);font-size:.95rem;max-width:500px;margin:0 auto}

/* â€” BaZi Grid â€” */
.bazi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;background:var(--c-border);border-radius:var(--r-md);overflow:hidden;margin:var(--sp-md) 0}
.bazi-cell{background:var(--c-bg-card);padding:var(--sp-sm) var(--sp-xs);text-align:center}
.bazi-cell.header{background:rgba(212,175,55,.08);font-size:.75rem;color:var(--c-text-dim);font-weight:600}
.bazi-cell .gz{font-family:var(--f-display);font-size:1.3rem;font-weight:700;display:block;margin-bottom:2px}
.bazi-cell .gz-sub{font-size:.7rem;color:var(--c-text-muted)}
.el-tag{display:inline-block;padding:1px 6px;border-radius:var(--r-pill);font-size:.65rem;font-weight:600;margin-top:2px}
.el-é‡‘{background:rgba(192,192,192,.15);color:var(--el-metal)}
.el-æœ¨{background:rgba(34,197,94,.15);color:var(--el-wood)}
.el-æ°´{background:rgba(59,130,246,.15);color:var(--el-water)}
.el-ç«{background:rgba(239,68,68,.15);color:var(--el-fire)}
.el-åœŸ{background:rgba(167,139,90,.15);color:var(--el-earth)}

/* â€” Five Element Bar â€” */
.el-bar{margin:var(--sp-sm) 0}
.el-row{display:flex;align-items:center;gap:var(--sp-sm);margin-bottom:6px}
.el-lbl{width:28px;text-align:center;font-weight:700;font-size:.85rem}
.el-track{flex:1;height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden}
.el-fill{height:100%;border-radius:4px;transition:width .8s ease}
.el-val{width:36px;text-align:right;font-size:.8rem;color:var(--c-text-dim)}

/* â€” DaYun Timeline â€” */
.dayun-tl{display:flex;overflow-x:auto;gap:2px;padding:var(--sp-sm) 0;-webkit-overflow-scrolling:touch}
.dy-item{flex:0 0 auto;min-width:72px;padding:var(--sp-sm);text-align:center;border-radius:var(--r-sm);border:1px solid var(--c-border);background:var(--c-bg-card);cursor:pointer;transition:all var(--t-fast);font-size:.8rem}
.dy-item.current{border-color:var(--c-gold);background:rgba(212,175,55,.1)}
.dy-item .dy-gz{font-family:var(--f-display);font-weight:700;font-size:1rem;display:block}
.dy-item .dy-age{color:var(--c-text-muted);font-size:.7rem}
.dy-item .dy-lv{display:inline-block;padding:1px 6px;border-radius:var(--r-pill);font-size:.65rem;font-weight:600;margin-top:4px}
.lv-dj{background:rgba(74,222,128,.15);color:var(--c-success)}
.lv-zj{background:rgba(96,165,250,.15);color:var(--c-info)}
.lv-xj{background:rgba(212,175,55,.15);color:var(--c-gold)}
.lv-p{background:rgba(255,255,255,.08);color:var(--c-text-dim)}
.lv-xk{background:rgba(251,191,36,.15);color:var(--c-warn)}
.lv-zk{background:rgba(248,113,113,.15);color:var(--c-danger)}
.lv-dk{background:rgba(180,40,40,.2);color:#ff6b6b}

/* â€” Hexagram â€” */
.hex-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp-md);margin:var(--sp-md) 0}
.hex-card{text-align:center;padding:var(--sp-md);background:rgba(0,0,0,.2);border:1px solid var(--c-border);border-radius:var(--r-md)}
.hex-card h4{color:var(--c-text-dim);font-size:.8rem;margin-bottom:var(--sp-sm)}
.hex-sym{font-size:2.5rem;line-height:1;margin-bottom:var(--sp-xs)}
.hex-name{font-family:var(--f-display);font-weight:700;color:var(--c-gold)}

/* â€” Tarot â€” */
.tarot-hand{display:flex;justify-content:center;gap:var(--sp-sm);flex-wrap:wrap;padding:var(--sp-lg) 0}
.t-card{width:76px;height:114px;perspective:600px;cursor:pointer}
.t-card-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .6s ease}
.t-card.flipped .t-card-inner{transform:rotateY(180deg)}
.t-card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:.7rem;text-align:center;padding:4px}
.t-back{background:linear-gradient(135deg,#2a1a3e,#1a0a2e);border:2px solid var(--c-gold);color:var(--c-gold)}
.t-back::after{content:'âœ¦';font-size:1.5rem;opacity:.6}
.t-front{transform:rotateY(180deg);background:var(--c-bg-card-alt);border:2px solid var(--c-border-hi);color:var(--c-text);gap:2px}
.t-front .tc-name{font-family:var(--f-display);font-weight:700;font-size:.72rem;color:var(--c-gold)}
.t-front .tc-dir{font-size:.6rem;color:var(--c-text-dim)}

/* â€” Result â€” */
.result-verdict{text-align:center;padding:var(--sp-lg);border:2px solid var(--c-gold);border-radius:var(--r-lg);background:linear-gradient(180deg,rgba(212,175,55,.08),rgba(139,0,0,.08));margin-bottom:var(--sp-lg)}
.verdict-label{font-family:var(--f-display);font-weight:900;font-size:1.8rem;color:var(--c-gold-light);margin-bottom:var(--sp-xs)}
.verdict-prob{font-size:2.5rem;font-weight:900;background:linear-gradient(135deg,var(--c-gold),var(--c-gold-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.verdict-note{color:var(--c-text-dim);font-size:.9rem;margin-top:var(--sp-sm)}
.prob-meter{margin:var(--sp-md) 0}
.prob-bar{height:12px;background:rgba(255,255,255,.06);border-radius:6px;overflow:hidden}
.prob-fill{height:100%;border-radius:6px;background:linear-gradient(90deg,var(--c-crimson),var(--c-gold),var(--c-success));transition:width 1.2s cubic-bezier(.4,0,.2,1)}
.prob-labels{display:flex;justify-content:space-between;font-size:.7rem;color:var(--c-text-muted);margin-top:4px}

/* â€” Dimension Tabs â€” */
.dim-tabs{display:flex;gap:2px;margin-bottom:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.dim-tab{flex:0 0 auto;padding:.6rem 1rem;border-radius:var(--r-sm) var(--r-sm) 0 0;background:rgba(255,255,255,.04);border:1px solid var(--c-border);border-bottom:none;font-size:.85rem;font-weight:500;color:var(--c-text-dim);cursor:pointer;transition:all var(--t-fast);white-space:nowrap}
.dim-tab.active{background:var(--c-bg-card);color:var(--c-gold);border-color:var(--c-border-hi)}
.dim-pane{display:none;padding:var(--sp-lg);background:var(--c-bg-card);border:1px solid var(--c-border);border-radius:0 var(--r-md) var(--r-md) var(--r-md)}
.dim-pane.active{display:block;animation:fadeIn .3s ease}

/* â€” Conclusion â€” */
.conclusion{background:linear-gradient(135deg,rgba(139,0,0,.15),rgba(212,175,55,.08));border:1px solid var(--c-border-hi);border-radius:var(--r-lg);padding:var(--sp-lg);margin-top:var(--sp-lg)}
.conclusion h3{font-family:var(--f-display);color:var(--c-gold);margin-bottom:var(--sp-md)}

/* â€” Actions â€” */
.actions{display:flex;gap:var(--sp-sm);justify-content:space-between;margin-top:var(--sp-lg);flex-wrap:wrap}
.actions-center{justify-content:center}

/* â€” Utilities â€” */
.text-gold{color:var(--c-gold)}.text-dim{color:var(--c-text-dim)}.text-muted{color:var(--c-text-muted)}
.text-success{color:var(--c-success)}.text-warn{color:var(--c-warn)}.text-danger{color:var(--c-danger)}
.text-center{text-align:center}.text-sm{font-size:.85rem}.text-xs{font-size:.75rem}
.mt-sm{margin-top:var(--sp-sm)}.mt-md{margin-top:var(--sp-md)}.mt-lg{margin-top:var(--sp-lg)}
.mb-sm{margin-bottom:var(--sp-sm)}.mb-md{margin-bottom:var(--sp-md)}.mb-lg{margin-bottom:var(--sp-lg)}
.hidden{display:none!important}
.serif{font-family:var(--f-display)}
.tag{display:inline-block;padding:2px 8px;border-radius:var(--r-pill);font-size:.75rem;font-weight:600}
.tag-gold{background:rgba(212,175,55,.15);color:var(--c-gold)}
.tag-red{background:rgba(239,68,68,.15);color:var(--c-danger)}
.tag-green{background:rgba(74,222,128,.15);color:var(--c-success)}
.tag-blue{background:rgba(96,165,250,.15);color:var(--c-info)}
.divider{height:1px;background:linear-gradient(90deg,transparent,var(--c-border-hi),transparent);margin:var(--sp-lg) 0}

/* â€” ZiWei Grid â€” */
.zw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;background:var(--c-border);border-radius:var(--r-md);overflow:hidden;margin:var(--sp-md) 0}
.zw-cell{background:var(--c-bg-card);padding:var(--sp-sm);min-height:85px;font-size:.75rem;position:relative}
.zw-cell.zw-center{grid-column:2/4;grid-row:2/4;display:flex;align-items:center;justify-content:center;flex-direction:column;background:var(--c-bg-card-alt);text-align:center;min-height:170px}
.zw-palace{font-weight:700;color:var(--c-gold);font-size:.8rem;margin-bottom:2px}
.zw-branch{font-size:.65rem;color:var(--c-text-muted)}
.zw-stars{margin-top:3px;line-height:1.5}
.zw-star{display:inline;margin-right:3px}
.zw-star.major{color:var(--c-gold-light);font-weight:600}
.zw-star.minor{color:var(--c-text-dim)}
.zw-hua{font-size:.55rem;padding:0 2px;border-radius:2px;background:rgba(212,175,55,.2);color:var(--c-gold);vertical-align:super;margin-left:1px}
.zw-cell.active-palace{border:1px solid var(--c-gold);background:rgba(212,175,55,.06)}

/* â€” Crystal â€” */
.crystal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:var(--sp-md);margin:var(--sp-md) 0}
.crystal-card{padding:var(--sp-md);border-radius:var(--r-md);border:1px solid var(--c-border);background:var(--c-bg-card);text-align:center;transition:all var(--t-fast)}
.crystal-card:hover{border-color:var(--c-gold);transform:translateY(-2px)}
.crystal-icon{font-size:2rem;margin-bottom:var(--sp-sm)}
.crystal-name{font-family:var(--f-display);font-weight:700;color:var(--c-gold);margin-bottom:var(--sp-xs)}

/* â€” Responsive â€” */
@media(max-width:640px){
  .bazi-cell .gz{font-size:1.1rem}
  .nav-links{display:none}
  .stepper{flex-wrap:wrap;gap:.3rem}
  .stepper-line{width:16px}
  .hex-grid{gap:var(--sp-sm)}
}
@media(max-width:380px){
  .hero h1{font-size:1.3rem}
  .card{padding:var(--sp-md)}
}

/* â€” Shop Buttons â€” */
.shop-btns{display:flex;flex-direction:column;gap:var(--sp-sm)}
.shop-btn-card{display:flex;align-items:center;gap:var(--sp-md);padding:.85rem 1rem;border-radius:var(--r-md);border:1px solid var(--c-border);background:var(--c-bg-card-alt);color:var(--c-text);text-decoration:none;transition:all var(--t-fast);cursor:pointer;font-family:inherit;font-size:inherit;text-align:left;width:100%}
.shop-btn-card:hover{border-color:var(--c-gold);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.shop-btn-card i{font-size:1.3rem;width:32px;text-align:center;flex:0 0 auto}
.shop-btn-card div{display:flex;flex-direction:column;gap:1px}
.shop-btn-card.shopee i{color:#ee4d2d}
.shop-btn-card.seven i{color:#00a040}
.shop-btn-card.custom i{color:var(--c-gold)}
.shop-btn-card strong{color:var(--c-text)}
.shop-card{border-color:rgba(212,175,55,.3);background:linear-gradient(135deg,rgba(139,0,0,.08),rgba(212,175,55,.05))}

/* â€” Nav Shop â€” */
.nav-shop{display:flex;gap:var(--sp-xs);align-items:center}
.nav-shop a{font-size:.75rem;padding:.35rem .6rem;border-radius:var(--r-pill);border:1px solid rgba(255,255,255,.12);color:var(--c-text-dim);transition:all var(--t-fast);white-space:nowrap}
.nav-shop a:hover{border-color:var(--c-gold);color:var(--c-gold)}

/* â€” Modal â€” */
.modal-overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:var(--sp-md)}
.modal-box{background:var(--c-bg-card);border:1px solid var(--c-border-hi);border-radius:var(--r-lg);padding:var(--sp-lg);max-width:480px;width:100%;max-height:90vh;overflow-y:auto;position:relative;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:scaleIn .3s ease}
.modal-close{position:absolute;top:var(--sp-sm);right:var(--sp-md);background:none;border:none;color:var(--c-text-dim);font-size:1.5rem;cursor:pointer;padding:4px 8px;border-radius:var(--r-sm);transition:color var(--t-fast)}
.modal-close:hover{color:var(--c-gold)}

/* â€” Floating Buttons â€” */
.floating-root{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 20px);right:16px;z-index:900;display:flex;flex-direction:column-reverse;align-items:flex-end;gap:var(--sp-sm)}
.fab{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(212,175,55,.5);cursor:pointer;transition:all var(--t-fast);text-decoration:none;font-family:inherit;flex-direction:column;gap:2px;font-size:.6rem;color:var(--c-text)}
.fab i{font-size:1rem}
.fab span{font-size:.5rem;line-height:1}
.fab-toggle{background:linear-gradient(135deg,var(--c-crimson),#6b0000);color:var(--c-gold-pale);box-shadow:0 4px 16px rgba(139,0,0,.5)}
.fab-toggle:hover{transform:scale(1.1)}
.fab-shopee{background:rgba(238,77,45,.15);color:#ee4d2d;border-color:rgba(238,77,45,.4)}
.fab-711{background:rgba(0,160,64,.15);color:#00a040;border-color:rgba(0,160,64,.4)}
.fab-custom{background:rgba(212,175,55,.12);color:var(--c-gold);border-color:rgba(212,175,55,.4)}
.fab-menu{display:flex;flex-direction:column-reverse;gap:var(--sp-sm)}
.fab-menu.hidden{display:none}
@media(max-width:640px){
  .fab{width:44px;height:44px}
  .fab span{display:none}
}

/* â€” Print (after all shop/fab styles) â€” */
@media print{
  .nav,.stepper,.actions,.btn,.floating-root,.shop-card,.modal-overlay{display:none!important}
  body{background:#fff!important;color:#000!important}
  .card,.dim-pane,.conclusion{border:1px solid #ccc!important;background:#fff!important;box-shadow:none!important}
  .text-gold,.card-title,.verdict-label,.hex-name,.zw-palace{color:#8b0000!important}
  .tag{border:1px solid #ccc}
  .prob-fill{background:#8b0000!important}
  .step{display:none!important}
  #step-3{display:block!important}
  .dim-pane{display:block!important;margin-bottom:1rem}
  .dim-tabs{display:none!important}
}
</style>
</head>
<body>
<nav class="nav"><div class="nav-inner">
  <div class="nav-brand"><i class="fas fa-moon"></i><span>éœæœˆä¹‹å…‰ v3.0</span></div>
  <div class="nav-links">
    <button class="nav-link active" onclick="goStep(0)">è¼¸å…¥</button>
    <button class="nav-link" onclick="goStep(1)">æ¢…èŠ±</button>
    <button class="nav-link" onclick="goStep(2)">å¡”ç¾…</button>
    <button class="nav-link" onclick="goStep(3)">çµæœ</button>
  </div>
  <div class="nav-shop">
    <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer">ğŸ›’ è¦çš®</a>
    <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer">ğŸ“¦ 7-11</a>
  </div>
</div></nav>

<div class="app">

<!-- ========== STEP 0: INPUT ========== -->
<section class="step active" id="step-0">
  <div class="hero">
    <div class="hero-icon">â˜½</div>
    <h1>éœæœˆä¹‹å…‰èƒ½é‡å åœå„€</h1>
    <p>æ•´åˆå…«å­— Â· ç´«å¾®æ–—æ•¸ Â· æ¢…èŠ±æ˜“æ•¸ Â· å¡”ç¾…ç‰Œçš„å¤šç¶­åº¦å‘½ç†åˆ†æ</p>
  </div>
  <div class="stepper" id="main-stepper">
    <div class="stepper-item active"><div class="stepper-dot">1</div><span>è¼¸å…¥</span></div><div class="stepper-line"></div>
    <div class="stepper-item"><div class="stepper-dot">2</div><span>æ¢…èŠ±</span></div><div class="stepper-line"></div>
    <div class="stepper-item"><div class="stepper-dot">3</div><span>å¡”ç¾…</span></div><div class="stepper-line"></div>
    <div class="stepper-item"><div class="stepper-dot">4</div><span>çµæœ</span></div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-question-circle"></i> ä½ çš„å•é¡Œ</div>
    <div class="form-group">
      <label class="form-label">å•é¡Œé¡å‹ <span class="req">*</span></label>
      <select class="form-select" id="f-type"><option value="">è«‹é¸æ“‡</option>
        <option value="love">æ„›æƒ…</option><option value="career">äº‹æ¥­</option><option value="wealth">è²¡é‹</option>
        <option value="health">å¥åº·</option><option value="general">ç¶œåˆé‹å‹¢</option><option value="relationship">äººéš›</option>
        <option value="family">å®¶åº­</option><option value="other">å…¶ä»–</option></select>
    </div>
    <div class="form-group">
      <label class="form-label">ä½ ç¾åœ¨æœ€æƒ³å•çš„ä¸€ä»¶äº‹ <span class="req">*</span></label>
      <textarea class="form-textarea" id="f-question" placeholder="ä¾‹ï¼šæˆ‘ä»Šå¹´é©åˆè½‰è·å—ï¼Ÿ" maxlength="500"></textarea>
      <div class="form-hint"><span id="f-char">0</span>/500</div>
    </div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-user"></i> å‡ºç”Ÿè³‡æ–™</div>
    <div class="form-group">
      <label class="form-label">æ€§åˆ¥ <span class="req">*</span></label>
      <div class="radio-pills">
        <label class="radio-pill"><input type="radio" name="gender" value="male"><span>ç”·</span></label>
        <label class="radio-pill"><input type="radio" name="gender" value="female"><span>å¥³</span></label>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">å‡ºç”Ÿæ—¥æœŸï¼ˆåœ‹æ›†ï¼‰<span class="req">*</span></label>
      <input type="date" class="form-input" id="f-bdate">
    </div>
    <div class="form-group">
      <label class="form-label">å‡ºç”Ÿæ™‚é–“</label>
      <input type="time" class="form-input" id="f-btime">
      <div class="form-hint">ä¸ç¢ºå®šå¯ç•™ç©ºï¼Œç³»çµ±ä»¥ 12:00 ä¼°ç®—</div>
    </div>
    <div class="form-group">
      <label class="form-label">å§“åï¼ˆé¸å¡«ï¼‰</label>
      <input type="text" class="form-input" id="f-name" placeholder="ç”¨æ–¼å§“åå­¸åˆ†æ">
    </div>
  </div>
  <div class="actions actions-center">
    <button class="btn btn-primary btn-lg" onclick="submitStep0()"><i class="fas fa-arrow-right"></i> ä¸‹ä¸€æ­¥ï¼šæ¢…èŠ±æ˜“æ•¸</button>
  </div>
</section>

<!-- ========== STEP 1: MEIHUA ========== -->
<section class="step" id="step-1">
  <div class="card">
    <div class="card-title"><i class="fas fa-yin-yang"></i> æ¢…èŠ±æ˜“æ•¸èµ·å¦</div>
    <div style="display:flex;gap:var(--sp-sm);flex-wrap:wrap;margin-bottom:var(--sp-md)">
      <button class="btn btn-sm btn-tab-active" id="mh-m-time" onclick="setMhMethod('time')"><i class="fas fa-clock"></i> æ™‚é–“</button>
      <button class="btn btn-sm btn-outline" id="mh-m-number" onclick="setMhMethod('number')"><i class="fas fa-sort-numeric-up"></i> æ•¸å­—</button>
      <button class="btn btn-sm btn-outline" id="mh-m-char" onclick="setMhMethod('char')"><i class="fas fa-font"></i> æ¼¢å­—</button>
      <button class="btn btn-sm btn-outline" id="mh-m-random" onclick="setMhMethod('random')"><i class="fas fa-dice"></i> éš¨æ©Ÿ</button>
    </div>
    <div id="mhf-time"><p class="text-dim text-sm mb-md">æŒ‰ä¸‹æŒ‰éˆ•è‡ªå‹•ä»¥ç•¶å‰æ™‚é–“èµ·å¦</p><button class="btn btn-primary" onclick="calcMhTime()"><i class="fas fa-calculator"></i> æ™‚é–“èµ·å¦</button></div>
    <div id="mhf-number" class="hidden">
      <div class="form-group"><label class="form-label">ä¸Šå¦æ•¸å­— (1-999)</label><input type="number" class="form-input" id="mh-n1" min="1" max="999"></div>
      <div class="form-group"><label class="form-label">ä¸‹å¦æ•¸å­— (1-999)</label><input type="number" class="form-input" id="mh-n2" min="1" max="999"></div>
      <div class="form-group"><label class="form-label">å‹•çˆ» (1-6)</label><input type="number" class="form-input" id="mh-n3" min="1" max="6"></div>
      <button class="btn btn-primary" onclick="calcMhNumber()"><i class="fas fa-calculator"></i> æ•¸å­—èµ·å¦</button>
    </div>
    <div id="mhf-char" class="hidden">
      <div class="form-group"><label class="form-label">è¼¸å…¥æ¼¢å­— (1-3å€‹)</label><input type="text" class="form-input" id="mh-char" placeholder="å¦‚ï¼šæ„Ÿæƒ…" maxlength="3"></div>
      <button class="btn btn-primary" onclick="calcMhChar()"><i class="fas fa-calculator"></i> æ¼¢å­—èµ·å¦</button>
    </div>
    <div id="mhf-random" class="hidden"><p class="text-dim text-sm mb-md">å¿ƒèª å‰‡éˆï¼Œéš¨æ©Ÿç”¢ç”Ÿå¦è±¡</p><button class="btn btn-primary" onclick="calcMhRandom()"><i class="fas fa-dice"></i> éš¨æ©Ÿèµ·å¦</button></div>
  </div>
  <div id="mh-result" class="hidden">
    <div class="card">
      <div class="hex-grid">
        <div class="hex-card"><h4>æœ¬å¦</h4><div class="hex-sym" id="mh-ben-s"></div><div class="hex-name" id="mh-ben-n"></div></div>
        <div class="hex-card"><h4>äº’å¦</h4><div class="hex-sym" id="mh-hu-s"></div><div class="hex-name" id="mh-hu-n"></div></div>
        <div class="hex-card"><h4>è®Šå¦</h4><div class="hex-sym" id="mh-bian-s"></div><div class="hex-name" id="mh-bian-n"></div></div>
      </div>
      <div class="divider"></div>
      <div id="mh-detail" class="text-sm"></div>
    </div>
  </div>
  <div class="actions">
    <button class="btn btn-outline" onclick="goStep(0)"><i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥</button>
    <button class="btn btn-outline" onclick="goStep(2)"><i class="fas fa-forward"></i> è·³é</button>
    <button class="btn btn-primary" onclick="goStep(2)"><i class="fas fa-arrow-right"></i> ä¸‹ä¸€æ­¥ï¼šå¡”ç¾…ç‰Œ</button>
  </div>
</section>

<!-- ========== STEP 2: TAROT ========== -->
<section class="step" id="step-2">
  <div class="card">
    <div class="card-title"><i class="fas fa-star"></i> é‡‘è‰²é»æ˜å¡”ç¾…ç‰Œ</div>
    <p class="text-dim text-sm mb-md">é»æ“ŠæŠ½ç‰Œï¼Œå…±éœ€ 10 å¼µã€‚å‰©é¤˜ï¼š<strong id="t-remain">10</strong> å¼µ</p>
    <div class="text-center">
      <button class="btn btn-gold btn-lg" id="btn-draw" onclick="drawCard()"><i class="fas fa-hand-pointer"></i> æŠ½ä¸€å¼µç‰Œ</button>
      <button class="btn btn-outline btn-sm" onclick="autoDraw()" style="margin-left:var(--sp-sm)"><i class="fas fa-bolt"></i> å¿«é€Ÿå…¨æŠ½</button>
    </div>
    <div class="tarot-hand" id="t-hand"></div>
  </div>
  <div id="t-spread-sec" class="hidden"><div class="card"><div class="card-title"><i class="fas fa-cross"></i> å‡±çˆ¾ç‰¹åå­—ç‰Œé™£</div><div id="t-spread"></div></div></div>
  <div class="actions">
    <button class="btn btn-outline" onclick="goStep(1)"><i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥</button>
    <button class="btn btn-outline" onclick="skipToResult()"><i class="fas fa-forward"></i> è·³éå¡”ç¾…</button>
    <button class="btn btn-primary" id="btn-analyze" onclick="goStep(3)" disabled><i class="fas fa-chart-bar"></i> é€²è¡Œåˆ†æ</button>
  </div>
</section>

<!-- ========== STEP 3: RESULT ========== -->
<section class="step" id="step-3">
  <div class="result-verdict" id="r-verdict">
    <div class="verdict-label" id="r-vlabel">åˆ†æä¸­â€¦</div>
    <div class="verdict-prob" id="r-vprob">0%</div>
    <div class="verdict-note" id="r-vnote"></div>
  </div>
  <div class="card"><div class="card-title"><i class="fas fa-bullseye"></i> ç›´æ¥å›ç­”</div>
    <div id="r-question" class="text-dim mb-md"></div>
    <div id="r-answer" class="serif" style="font-size:1.05rem;line-height:1.8"></div>
    <div class="divider"></div><div id="r-factors"></div><div id="r-suggest" class="mt-md"></div>
  </div>
  <div class="card"><div class="card-title"><i class="fas fa-chart-line"></i> å¯èƒ½æ€§è©•ä¼°</div>
    <div class="prob-meter"><div class="prob-bar"><div class="prob-fill" id="r-pfill" style="width:0%"></div></div>
    <div class="prob-labels"><span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span></div></div>
    <div id="r-pbreak" class="mt-md text-sm"></div>
  </div>
  <div class="card" style="padding:0;overflow:visible">
    <div class="dim-tabs">
      <button class="dim-tab active" onclick="showDim('bazi')">å…«å­—å‘½ç†</button>
      <button class="dim-tab" onclick="showDim('ziwei')">ç´«å¾®æ–—æ•¸</button>
      <button class="dim-tab" onclick="showDim('meihua')">æ¢…èŠ±æ˜“æ•¸</button>
      <button class="dim-tab" onclick="showDim('tarot')">å¡”ç¾…ç‰Œé™£</button>
      <button class="dim-tab" onclick="showDim('name')">å§“åå­¸</button>
    </div>
    <div class="dim-pane active" id="pane-bazi">
      <h4 class="text-gold mb-md serif">å››æŸ±å…«å­—å‘½ç›¤</h4><div id="d-bazi"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">äº”è¡Œåˆ†ä½ˆ</h4><div id="d-elbar"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">åç¥åˆ†æ</h4><div id="d-gods" class="text-sm"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">è—å¹²è©³è§£</h4><div id="d-canggan" class="text-sm"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">å–œç”¨ç¥èˆ‡å¿Œç¥</h4><div id="d-xiyong" class="text-sm"></div>
      <div class="divider"></div><h4 class="text-gold mb-md serif">å¤§é‹æµå¹´</h4><div id="d-dayun"></div>
    </div>
    <div class="dim-pane" id="pane-ziwei">
      <h4 class="text-gold mb-md serif">ç´«å¾®æ–—æ•¸å‘½ç›¤</h4>
      <div id="d-ziwei-info" class="text-sm mb-md"></div>
      <div id="d-ziwei-grid"></div>
      <div class="divider"></div>
      <h4 class="text-gold mb-md serif">å››åŒ–é£›æ˜Ÿ</h4>
      <div id="d-ziwei-sihua" class="text-sm"></div>
      <div class="divider"></div>
      <h4 class="text-gold mb-md serif">å‘½ç›¤è§£è®€</h4>
      <div id="d-ziwei-reading" class="text-sm"></div>
    </div>
    <div class="dim-pane" id="pane-meihua"><div id="r-meihua"></div></div>
    <div class="dim-pane" id="pane-tarot"><div id="r-tarot"></div></div>
    <div class="dim-pane" id="pane-name">
      <h4 class="text-gold mb-md serif">å§“åå­¸åˆ†æï¼ˆä¸‰æ‰äº”æ ¼ï¼‰</h4>
      <div id="d-name"></div>
    </div>
  </div>
  <div class="card"><div class="card-title"><i class="fas fa-gem"></i> ã€è™•æ–¹ã€‘æ°´æ™¶æ ¡æº–å»ºè­°</div><div id="r-crystal"></div></div>

  <!-- å•†åŸæ¨è–¦å¡ -->
  <div class="card shop-card">
    <div class="card-title"><i class="fas fa-shopping-bag"></i> æƒ³æŠŠçµæœåšæˆã€Œå°ˆå±¬äº”è¡Œæ‰‹éˆã€ï¼Ÿæˆ‘å¹«ä½ é…åˆ°ä½</div>
    <p class="text-sm text-dim mb-md">ä¾ä½ çµæœçš„å–œç”¨ç¥ï¼Œçµ¦ä½  3 å€‹å¯¦ç”¨æ­é…ï¼ˆå¯ç›´æ¥ä¸‹å–®ï¼‰</p>
    <div class="shop-btns">
      <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer" class="shop-btn-card shopee">
        <i class="fas fa-shopping-cart"></i>
        <div><strong>ğŸ›’ è¦çš®é€›é€›</strong><span class="text-xs">å…¨é¤¨å…é‹ + é—œæ³¨9æŠ˜</span></div>
      </a>
      <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer" class="shop-btn-card seven">
        <i class="fas fa-box"></i>
        <div><strong>ğŸ“¦ è³£è²¨ä¾¿</strong><span class="text-xs">æ»¿åƒå…é‹ / å¤šä»¶åˆä½µ</span></div>
      </a>
      <button class="shop-btn-card custom" onclick="openCustomModal()">
        <i class="fas fa-magic"></i>
        <div><strong>âœ¨ æˆ‘è¦å®¢è£½</strong><span class="text-xs">å¡«è³‡æ–™ / é ç®—ç‰ˆ</span></div>
      </button>
    </div>
    <p class="text-xs text-muted mt-md"><i class="fas fa-info-circle"></i> é ç®—ç‰ˆ / åŠ å¼·ç‰ˆ / æ”¶è—ç‰ˆï¼šé¸ä¸€å€‹å°±å¥½</p>
  </div>

  <div class="conclusion"><h3><i class="fas fa-moon"></i> éœæœˆåˆ†æå¸«ç¸½çµ</h3><div id="r-conclusion" class="text-sm" style="line-height:1.8"></div></div>
  <div class="actions actions-center mt-lg">
    <button class="btn btn-outline" onclick="printResult()"><i class="fas fa-print"></i> åˆ—å°</button>
    <button class="btn btn-outline" onclick="shareResult()"><i class="fas fa-share-alt"></i> åˆ†äº«</button>
    <button class="btn btn-outline" onclick="resetAll()"><i class="fas fa-redo"></i> é‡æ–°é–‹å§‹</button>
  </div>
</section>

</div><!-- /app -->

<!-- å®¢è£½è¡¨å–® Modal -->
<div class="modal-overlay" id="custom-modal" style="display:none">
  <div class="modal-box">
    <button class="modal-close" onclick="closeCustomModal()">&times;</button>
    <h3 class="serif text-gold mb-md"><i class="fas fa-magic"></i> èƒ½é‡æ‰‹éˆå®¢è£½æœå‹™</h3>
    <form id="custom-form" action="https://formsubmit.co/onerkk@gmail.com" method="POST" onsubmit="return prepareCustomSubmit()">
      <!-- formsubmit.co config -->
      <input type="hidden" name="_subject" id="cf-subject-hidden" value="ã€å®¢è£½è©¢å•ã€‘èƒ½é‡æ‰‹éˆ">
      <input type="hidden" name="_captcha" value="false">
      <input type="hidden" name="_template" value="table">
      <input type="hidden" name="_next" id="cf-next-url" value="">
      <input type="text" name="_honey" style="display:none">
      <input type="hidden" name="å åœåˆ†ææ‘˜è¦" id="cf-analysis-hidden" value="">
      <div class="form-group">
        <label class="form-label">å§“å <span class="req">*</span></label>
        <input type="text" class="form-input" id="cf-name" name="å§“å" required placeholder="æ‚¨çš„å§“å">
      </div>
      <div class="form-group">
        <label class="form-label">å‡ºç”Ÿæ—¥æœŸ <span class="req">*</span></label>
        <input type="date" class="form-input" id="cf-bday" name="å‡ºç”Ÿæ—¥æœŸ" required>
      </div>
      <div class="form-group">
        <label class="form-label">æƒ³è§£æ±ºçš„å•é¡Œ <span class="req">*</span></label>
        <textarea class="form-textarea" id="cf-question" name="æƒ³è§£æ±ºçš„å•é¡Œ" required placeholder="ä¾‹ï¼šæƒ³æå‡äº‹æ¥­é‹ã€æ”¹å–„æ„Ÿæƒ…ã€æ‹›è²¡ç­‰..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">é ç®—ç¯„åœ <span class="req">*</span></label>
        <select class="form-select" id="cf-budget" name="é ç®—ç¯„åœ" required>
          <option value="">è«‹é¸æ“‡</option>
          <option value="é ç®—ç‰ˆï¼ˆ$1,000-$3,000ï¼‰">é ç®—ç‰ˆï¼ˆ$1,000 - $3,000ï¼‰</option>
          <option value="åŠ å¼·ç‰ˆï¼ˆ$3,000-$6,000ï¼‰">åŠ å¼·ç‰ˆï¼ˆ$3,000 - $6,000ï¼‰</option>
          <option value="æ”¶è—ç‰ˆï¼ˆ$6,000ä»¥ä¸Šï¼‰">æ”¶è—ç‰ˆï¼ˆ$6,000 ä»¥ä¸Šï¼‰</option>
        </select>
      </div>
      <div class="actions" style="margin-top:var(--sp-lg)">
        <button type="button" class="btn btn-outline" onclick="closeCustomModal()">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-gold" id="cf-submit-btn"><i class="fas fa-paper-plane"></i> é€å‡ºè©¢å•</button>
      </div>
      <p class="text-xs text-muted mt-md"><i class="fas fa-lock"></i> è¡¨å–®ç›´æ¥å¯„åˆ°åº—å®¶ä¿¡ç®±ï¼Œä¸ç¶“ç¬¬ä¸‰æ–¹å„²å­˜ã€‚é¦–æ¬¡é€å‡ºå¾Œæœƒæ”¶åˆ°ç¢ºèªä¿¡ã€‚</p>
    </form>
    <div id="cf-sent" class="hidden mt-lg text-center">
      <div style="font-size:2rem;margin-bottom:var(--sp-sm)">âœ…</div>
      <h4 class="text-gold mb-sm">è©¢å•å·²é€å‡ºï¼</h4>
      <p class="text-sm text-dim mb-md">æˆ‘å€‘æœƒç›¡å¿«é€é Email å›è¦†æ‚¨ã€‚</p>
      <button class="btn btn-outline" onclick="closeCustomModal()"><i class="fas fa-check"></i> é—œé–‰</button>
    </div>
  </div>
</div>

<!-- æµ®å‹•æŒ‰éˆ• -->
<div class="floating-root" id="floating-root">
  <button class="fab fab-toggle" onclick="toggleFab()" aria-label="é¸å–®"><i class="fas fa-ellipsis-v"></i></button>
  <div class="fab-menu hidden" id="fab-menu">
    <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer" class="fab fab-shopee" title="è¦çš®é€›é€›"><i class="fas fa-shopping-cart"></i><span>è¦çš®</span></a>
    <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer" class="fab fab-711" title="è³£è²¨ä¾¿"><i class="fas fa-box"></i><span>7-11</span></a>
    <button class="fab fab-custom" onclick="openCustomModal()" title="å®¢è£½"><i class="fas fa-magic"></i><span>å®¢è£½</span></button>
  </div>
</div>
<script>
/* =============================================================
   GLOBAL STATE
   ============================================================= */
const S = { step:0, form:{}, bazi:null, meihua:null, tarot:{drawn:[],spread:[]}, ziwei:null };

/* =============================================================
   NAVIGATION
   ============================================================= */
function goStep(n){
  if(n===3 && !S.bazi){alert('è«‹å…ˆå¡«å¯«åŸºæœ¬è³‡æ–™');return}
  document.querySelectorAll('.step').forEach((s,i)=>s.classList.toggle('active',i===n));
  document.querySelectorAll('.nav-link').forEach((l,i)=>l.classList.toggle('active',i===n));
  document.querySelectorAll('.stepper-item').forEach((s,i)=>{s.classList.remove('active','done');if(i<n)s.classList.add('done');if(i===n)s.classList.add('active')});
  S.step=n; window.scrollTo({top:0,behavior:'smooth'});
  if(n===3) runAnalysis();
}
function resetAll(){S.bazi=null;S.meihua=null;S.tarot={drawn:[],spread:[]};S.ziwei=null;goStep(0);document.getElementById('mh-result').classList.add('hidden');document.getElementById('t-hand').innerHTML='';document.getElementById('t-remain').textContent='10';document.getElementById('btn-draw').disabled=false;document.getElementById('btn-analyze').disabled=true;document.getElementById('t-spread-sec').classList.add('hidden')}
function skipToResult(){goStep(3)}

/* â€” Char counter â€” */
document.getElementById('f-question').addEventListener('input',function(){document.getElementById('f-char').textContent=this.value.length});

/* =============================================================
   å¤©å¹²åœ°æ”¯ CORE DATA
   ============================================================= */
const TG=['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
const DZ=['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
const WX_G={ç”²:'æœ¨',ä¹™:'æœ¨',ä¸™:'ç«',ä¸:'ç«',æˆŠ:'åœŸ',å·±:'åœŸ',åºš:'é‡‘',è¾›:'é‡‘',å£¬:'æ°´',ç™¸:'æ°´'};
const WX_Z={å­:'æ°´',ä¸‘:'åœŸ',å¯…:'æœ¨',å¯:'æœ¨',è¾°:'åœŸ',å·³:'ç«',åˆ:'ç«',æœª:'åœŸ',ç”³:'é‡‘',é…‰:'é‡‘',æˆŒ:'åœŸ',äº¥:'æ°´'};
const YY_G={ç”²:'é™½',ä¹™:'é™°',ä¸™:'é™½',ä¸:'é™°',æˆŠ:'é™½',å·±:'é™°',åºš:'é™½',è¾›:'é™°',å£¬:'é™½',ç™¸:'é™°'};
const SHENG={æœ¨:'ç«',ç«:'åœŸ',åœŸ:'é‡‘',é‡‘:'æ°´',æ°´:'æœ¨'};
const KE={æœ¨:'åœŸ',ç«:'é‡‘',åœŸ:'æ°´',é‡‘:'æœ¨',æ°´:'ç«'};
const BE_SHENG={æœ¨:'æ°´',ç«:'æœ¨',åœŸ:'ç«',é‡‘:'åœŸ',æ°´:'é‡‘'}; // ç”Ÿæˆ‘
const BE_KE={æœ¨:'é‡‘',ç«:'æ°´',åœŸ:'æœ¨',é‡‘:'ç«',æ°´:'åœŸ'};   // å…‹æˆ‘

/* è—å¹² */
const CG={
  å­:['ç™¸'],ä¸‘:['å·±','ç™¸','è¾›'],å¯…:['ç”²','ä¸™','æˆŠ'],å¯:['ä¹™'],
  è¾°:['æˆŠ','ä¹™','ç™¸'],å·³:['ä¸™','åºš','æˆŠ'],åˆ:['ä¸','å·±'],æœª:['å·±','ä¸','ä¹™'],
  ç”³:['åºš','å£¬','æˆŠ'],é…‰:['è¾›'],æˆŒ:['æˆŠ','è¾›','ä¸'],äº¥:['å£¬','ç”²']
};

/* åç¥ */
function tenGod(dm,tgt){
  if(!WX_G[dm]||!WX_G[tgt])return'â€”';
  const d=WX_G[dm],t=WX_G[tgt],s=YY_G[dm]===YY_G[tgt];
  if(d===t)return s?'æ¯”è‚©':'åŠ«è²¡';
  if(SHENG[d]===t)return s?'é£Ÿç¥':'å‚·å®˜';
  if(KE[d]===t)return s?'åè²¡':'æ­£è²¡';
  if(KE[t]===d)return s?'ä¸ƒæ®º':'æ­£å®˜';
  if(SHENG[t]===d)return s?'åå°':'æ­£å°';
  return'â€”';
}

/* åäºŒé•·ç”Ÿ */
const CHANG_SHENG_ORDER=['é•·ç”Ÿ','æ²æµ´','å† å¸¶','è‡¨å®˜','å¸æ—º','è¡°','ç—…','æ­»','å¢“','çµ•','èƒ','é¤Š'];
const CS_START={ç”²:DZ.indexOf('äº¥'),ä¸™:DZ.indexOf('å¯…'),æˆŠ:DZ.indexOf('å¯…'),åºš:DZ.indexOf('å·³'),å£¬:DZ.indexOf('ç”³'),
                ä¹™:DZ.indexOf('åˆ'),ä¸:DZ.indexOf('é…‰'),å·±:DZ.indexOf('é…‰'),è¾›:DZ.indexOf('å­'),ç™¸:DZ.indexOf('å¯')};
function changSheng(dm,zhi){
  const start=CS_START[dm]; if(start===undefined)return'â€”';
  const zhiIdx=DZ.indexOf(zhi); if(zhiIdx<0)return'â€”';
  const isYang=YY_G[dm]==='é™½';
  let diff=isYang?(zhiIdx-start+12)%12:(start-zhiIdx+12)%12;
  return CHANG_SHENG_ORDER[diff];
}

/* ç¥ç… (ç°¡åŒ–ç‰ˆ â€” å¸¸ç”¨15å€‹) */
function getShenSha(pillars){
  const ss=[];
  const yZ=pillars.year.zhi, dG=pillars.day.gan, dZ=pillars.day.zhi;
  // å¤©ä¹™è²´äºº
  const TIYI={ç”²:['ä¸‘','æœª'],æˆŠ:['ä¸‘','æœª'],åºš:['ä¸‘','æœª'],ä¸™:['äº¥','é…‰'],ä¸:['äº¥','é…‰'],
              ä¹™:['å­','ç”³'],å·±:['å­','ç”³'],å£¬:['å¯','å·³'],ç™¸:['å¯','å·³'],è¾›:['åˆ','å¯…']};
  if(TIYI[dG]){[yZ,pillars.month.zhi,pillars.hour.zhi].forEach(z=>{if(TIYI[dG].includes(z))ss.push('å¤©ä¹™è²´äºº')})}
  // æ–‡æ˜Œ
  const WC={ç”²:'å·³',ä¹™:'åˆ',ä¸™:'ç”³',ä¸:'é…‰',æˆŠ:'ç”³',å·±:'é…‰',åºš:'äº¥',è¾›:'å­',å£¬:'å¯…',ç™¸:'å¯'};
  if(WC[dG]){[yZ,pillars.month.zhi,pillars.hour.zhi].forEach(z=>{if(z===WC[dG])ss.push('æ–‡æ˜Œ')})}
  // é©›é¦¬
  const YM={å¯…:'ç”³',å·³:'äº¥',ç”³:'å¯…',äº¥:'å·³',å­:'åˆ',åˆ:'å­',å¯:'é…‰',é…‰:'å¯',è¾°:'æˆŒ',æˆŒ:'è¾°',ä¸‘:'æœª',æœª:'ä¸‘'};
  if(YM[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===YM[yZ])ss.push('é©›é¦¬')})}
  // æ¡ƒèŠ±
  const TH_MAP={å­:'é…‰',ä¸‘:'åˆ',å¯…:'å¯',å¯:'å­',è¾°:'é…‰',å·³:'åˆ',åˆ:'å¯',æœª:'å­',ç”³:'é…‰',é…‰:'åˆ',æˆŒ:'å¯',äº¥:'å­'};
  if(TH_MAP[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===TH_MAP[yZ])ss.push('æ¡ƒèŠ±')})}
  // è¯è“‹
  const HG_MAP={å­:'è¾°',ä¸‘:'ä¸‘',å¯…:'æˆŒ',å¯:'æœª',è¾°:'è¾°',å·³:'ä¸‘',åˆ:'æˆŒ',æœª:'æœª',ç”³:'è¾°',é…‰:'ä¸‘',æˆŒ:'æˆŒ',äº¥:'æœª'};
  if(HG_MAP[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===HG_MAP[yZ])ss.push('è¯è“‹')})}
  return[...new Set(ss)];
}

/* =============================================================
   BAZI COMPUTATION (å®Œæ•´ç‰ˆ)
   ============================================================= */
function submitStep0(){
  const type=document.getElementById('f-type').value;
  const question=document.getElementById('f-question').value.trim();
  const gender=document.querySelector('input[name="gender"]:checked');
  const bdate=document.getElementById('f-bdate').value;
  if(!type||!question||!gender||!bdate){alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');return}
  const btime=document.getElementById('f-btime').value||'12:00';
  const name=document.getElementById('f-name').value.trim();
  S.form={type,question,gender:gender.value,bdate,btime,name};
  const[y,m,d]=bdate.split('-').map(Number);
  const[hh,mm]=btime.split(':').map(Number);
  S.bazi=computeBazi(y,m,d,hh,mm,gender.value);
  S.ziwei=computeZiwei(y,m,d,hh,gender.value);
  goStep(1);
}

function computeBazi(year,month,day,hour,minute,gender){
  // â”€â”€ å¹´æŸ± â”€â”€
  let ly=year;
  if(month<2||(month===2&&day<4))ly--;
  const yGi=((ly-4)%10+10)%10;
  const yZi=((ly-4)%12+12)%12;
  const yG=TG[yGi], yZ=DZ[yZi];

  // â”€â”€ æœˆæŸ± â”€â”€
  // ç¯€æ°£è¿‘ä¼¼æ—¥
  const JIE=[0,6,4,6,5,6,6,7,8,8,8,7,7]; // index 1-12
  let mi=month;
  if(day<(JIE[month]||6))mi=mi===1?12:mi-1;
  const mZi=((mi+1)%12+12)%12; // æ­£æœˆ=å¯…(2)
  const mGBase=(yGi%5)*2;
  const mGi=(mGBase+(mi-1))%10;
  const mG=TG[(mGi+10)%10], mZ=DZ[mZi];

  // â”€â”€ æ—¥æŸ± â”€â”€
  const base=new Date(1900,0,1);
  const tgt=new Date(year,month-1,day);
  const diff=Math.floor((tgt-base)/864e5);
  const adj=diff+10;
  const dGi=((adj%10)+10)%10;
  const dZi=((adj%12)+12)%12;
  const dG=TG[dGi], dZ=DZ[dZi];

  // â”€â”€ æ™‚æŸ± â”€â”€
  const shi=Math.floor(((hour+1)%24)/2);
  const hZi=shi%12;
  const hGBase=(dGi%5)*2;
  const hGi=(hGBase+hZi)%10;
  const hG=TG[hGi], hZ=DZ[hZi];

  const pillars={year:{gan:yG,zhi:yZ},month:{gan:mG,zhi:mZ},day:{gan:dG,zhi:dZ},hour:{gan:hG,zhi:hZ}};
  const dm=dG, dmEl=WX_G[dm];

  // â”€â”€ äº”è¡Œçµ±è¨ˆï¼ˆå«è—å¹²æ¬Šé‡ï¼‰â”€â”€
  const ec={é‡‘:0,æœ¨:0,æ°´:0,ç«:0,åœŸ:0};
  const allG=[yG,mG,dG,hG], allZ=[yZ,mZ,dZ,hZ];
  allG.forEach(g=>ec[WX_G[g]]+=1.0);
  allZ.forEach(z=>{
    ec[WX_Z[z]]+=1.0;
    const cg=CG[z]||[];
    if(cg[0])ec[WX_G[cg[0]]]+=0.6; // æœ¬æ°£
    if(cg[1])ec[WX_G[cg[1]]]+=0.3; // ä¸­æ°£
    if(cg[2])ec[WX_G[cg[2]]]+=0.1; // é¤˜æ°£
  });
  const tot=Object.values(ec).reduce((a,b)=>a+b,0);
  const ep={}; for(const k of Object.keys(ec))ep[k]=Math.round(ec[k]/tot*100);

  // â”€â”€ èº«å¼·èº«å¼± â”€â”€
  const selfScore=(ec[dmEl]||0)+(ec[BE_SHENG[dmEl]]||0)*0.6;
  const strong=selfScore>tot*0.42;

  // â”€â”€ å–œç”¨ç¥ / å¿Œç¥ â”€â”€
  let fav,unfav;
  if(strong){
    fav=[BE_KE[dmEl],SHENG[dmEl]]; // å…‹æˆ‘(å®˜æ®º)ã€æˆ‘ç”Ÿ(é£Ÿå‚·)
    if(ec[KE[dmEl]]<1.5)fav.push(KE[dmEl]); // æˆ‘å…‹(è²¡)ä¹Ÿå¯ç”¨
    unfav=[dmEl,BE_SHENG[dmEl]];
  }else{
    fav=[dmEl,BE_SHENG[dmEl]]; // åŒæˆ‘(æ¯”åŠ«)ã€ç”Ÿæˆ‘(å°)
    unfav=[BE_KE[dmEl],SHENG[dmEl]];
  }

  // â”€â”€ åç¥ â”€â”€
  const gods={};
  ['year','month','day','hour'].forEach(p=>{
    const g=pillars[p].gan, z=pillars[p].zhi;
    gods[p]={
      gan: p==='day'?'æ—¥ä¸»':tenGod(dm,g),
      zhi: CG[z]?CG[z].map(c=>tenGod(dm,c)):['â€”']
    };
  });

  // â”€â”€ åäºŒé•·ç”Ÿ â”€â”€
  const cs={};
  ['year','month','day','hour'].forEach(p=>{
    cs[p]=changSheng(dm,pillars[p].zhi);
  });

  // â”€â”€ ç¥ç… â”€â”€
  const shensha=getShenSha(pillars);

  // â”€â”€ ç´éŸ³ â”€â”€
  const nayin=getNaYin(yGi,yZi);

  // â”€â”€ å¤§é‹ â”€â”€
  const isFwd=(gender==='male'&&YY_G[yG]==='é™½')||(gender==='female'&&YY_G[yG]==='é™°');
  const dir=isFwd?1:-1;
  const startAge=computeStartAge(year,month,day,dir);
  const dayun=[];
  for(let i=0;i<10;i++){
    const gI=((TG.indexOf(mG)+(i+1)*dir)%10+10)%10;
    const zI=((DZ.indexOf(mZ)+(i+1)*dir)%12+12)%12;
    const as=startAge+i*10, ae=as+9;
    const curAge=new Date().getFullYear()-year;
    const isCur=curAge>=as&&curAge<=ae;
    const dyG=TG[gI],dyZ=DZ[zI],dyEl=WX_G[dyG];
    let lv='å¹³';
    if(fav.includes(dyEl)){
      const god=tenGod(dm,dyG);
      lv=(['æ­£å°','åå°','æ­£å®˜'].includes(god))?'å¤§å‰':'ä¸­å‰';
    }else if(unfav.includes(dyEl)){
      const god=tenGod(dm,dyG);
      lv=(['ä¸ƒæ®º'].includes(god))?'ä¸­å‡¶':'å°å‡¶';
    }
    // æµå¹´
    const liuNian=[];
    for(let j=0;j<10;j++){
      const lnYear=year+as+j;
      const lnGI=((lnYear-4)%10+10)%10;
      const lnZI=((lnYear-4)%12+12)%12;
      const lnG=TG[lnGI],lnZ=DZ[lnZI],lnEl=WX_G[lnG];
      let lnLv='å¹³';
      if(fav.includes(lnEl))lnLv='å‰';
      if(unfav.includes(lnEl))lnLv='å‡¶';
      liuNian.push({year:lnYear,gz:lnG+lnZ,el:lnEl,level:lnLv,god:tenGod(dm,lnG)});
    }
    dayun.push({gz:dyG+dyZ,el:dyEl,ageStart:as,ageEnd:ae,isCurrent:isCur,level:lv,god:tenGod(dm,dyG),liuNian});
  }

  return{pillars,dm,dmEl,strong,ec,ep,fav,unfav,gods,cs,shensha,nayin,dayun,cangGan:{year:CG[yZ],month:CG[mZ],day:CG[dZ],hour:CG[hZ]}};
}

function computeStartAge(y,m,d,dir){
  // ç°¡åŒ–ï¼šé †è¡Œæ‰¾ä¸‹ä¸€å€‹ç¯€æ°£ï¼Œé€†è¡Œæ‰¾ä¸Šä¸€å€‹ï¼Œæ¯3å¤©æŠ˜1æ­²
  // é€™è£¡ç”¨è¿‘ä¼¼å€¼
  const JIE_DAYS=[0,6,4,6,5,6,6,7,8,8,8,7,7];
  const jd=JIE_DAYS[m]||6;
  let diff=dir>0?(jd<=d?30-d+JIE_DAYS[(m%12)+1]:jd-d):(d<=jd?d+30-JIE_DAYS[((m-2+12)%12)+1]:d-jd);
  return Math.max(1,Math.round(diff/3));
}

/* ç´éŸ³ */
function getNaYin(gi,zi){
  const NY=['æµ·ä¸­é‡‘','çˆä¸­ç«','å¤§æ—æœ¨','è·¯æ—åœŸ','åŠé‹’é‡‘','å±±é ­ç«','æ¾—ä¸‹æ°´','åŸé ­åœŸ','ç™½è Ÿé‡‘','æ¥ŠæŸ³æœ¨',
            'æ³‰ä¸­æ°´','å±‹ä¸ŠåœŸ','éœ¹é‚ç«','æ¾æŸæœ¨','é•·æµæ°´','ç ‚ä¸­é‡‘','å±±ä¸‹ç«','å¹³åœ°æœ¨','å£ä¸ŠåœŸ','é‡‘ç®”é‡‘',
            'è¦†ç‡ˆç«','å¤©æ²³æ°´','å¤§é©›åœŸ','é‡µé‡§é‡‘','æ¡‘æŸ˜æœ¨','å¤§æºªæ°´','ç ‚ä¸­åœŸ','å¤©ä¸Šç«','çŸ³æ¦´æœ¨','å¤§æµ·æ°´'];
  const idx=Math.floor(((gi*12+zi)/2)%30);
  return NY[idx]||'';
}
/* =============================================================
   æ¢…èŠ±æ˜“æ•¸ MEIHUA YISHU â€” å®Œæ•´64å¦
   ============================================================= */
const BG=[
  {name:'ä¹¾',sym:'â˜°',nat:'å¤©',el:'é‡‘',n:1,li:[1,1,1]},
  {name:'å…Œ',sym:'â˜±',nat:'æ¾¤',el:'é‡‘',n:2,li:[1,1,0]},
  {name:'é›¢',sym:'â˜²',nat:'ç«',el:'ç«',n:3,li:[1,0,1]},
  {name:'éœ‡',sym:'â˜³',nat:'é›·',el:'æœ¨',n:4,li:[1,0,0]},
  {name:'å·½',sym:'â˜´',nat:'é¢¨',el:'æœ¨',n:5,li:[0,1,1]},
  {name:'å',sym:'â˜µ',nat:'æ°´',el:'æ°´',n:6,li:[0,1,0]},
  {name:'è‰®',sym:'â˜¶',nat:'å±±',el:'åœŸ',n:7,li:[0,0,1]},
  {name:'å¤',sym:'â˜·',nat:'åœ°',el:'åœŸ',n:8,li:[0,0,0]}
];
const G64={
'11':{n:'ä¹¾ç‚ºå¤©',u:'ä·€',j:'å…ƒäº¨åˆ©è²ã€‚',m:'å‰›å¥ä¸­æ­£ï¼Œè¬äº‹äº¨é€šï¼Œæˆ’é©•å‚²ã€‚'},
'12':{n:'å¤©æ¾¤å±¥',u:'ä·‰',j:'å±¥è™å°¾ï¼Œä¸å’¥äººï¼Œäº¨ã€‚',m:'å°å¿ƒè¬¹æ…å‰è¡Œï¼Œåˆç¦®å‰‡å‰ã€‚'},
'13':{n:'å¤©ç«åŒäºº',u:'ä·Œ',j:'åŒäººäºé‡ï¼Œäº¨ã€‚',m:'å¿—åŒé“åˆè€…èšé›†ï¼Œåˆ©æ¶‰å¤§å·ã€‚'},
'14':{n:'å¤©é›·ç„¡å¦„',u:'ä·˜',j:'å…ƒäº¨åˆ©è²ã€‚',m:'è‡³èª ç„¡å¦„ï¼Œé †å¤©è€Œè¡Œã€‚'},
'15':{n:'å¤©é¢¨å§¤',u:'ä·«',j:'å¥³å£¯ï¼Œå‹¿ç”¨å–å¥³ã€‚',m:'å¶ç„¶ç›¸é‡ï¼Œä¸å¯æ€¥é€²ã€‚'},
'16':{n:'å¤©æ°´è¨Ÿ',u:'ä·…',j:'æœ‰å­šï¼Œçª’ã€‚',m:'çˆ­è¨Ÿä¹‹è±¡ï¼Œå®œå’Œè§£é€€è®“ã€‚'},
'17':{n:'å¤©å±±é',u:'ä· ',j:'äº¨ï¼Œå°åˆ©è²ã€‚',m:'é€€é¿ä¿èº«ï¼Œä»¥é€€ç‚ºé€²ã€‚'},
'18':{n:'å¤©åœ°å¦',u:'ä·‹',j:'å¦ä¹‹åŒªäººã€‚',m:'é–‰å¡ä¸é€šï¼Œå®ˆéœå¾…æ™‚ã€‚'},
'21':{n:'æ¾¤å¤©å¤¬',u:'ä·ª',j:'æšäºç‹åº­ã€‚',m:'æ±ºæ–·æœæ•¢ï¼Œä»¥å‰›æ±ºæŸ”ã€‚'},
'22':{n:'å…Œç‚ºæ¾¤',u:'ä·¹',j:'äº¨ï¼Œåˆ©è²ã€‚',m:'å–œæ‚…äº¤æµï¼Œè¨€èªå¾—å®œã€‚'},
'23':{n:'æ¾¤ç«é©',u:'ä·°',j:'å·±æ—¥ä¹ƒå­šã€‚',m:'è®Šé©é™¤èˆŠï¼Œæ™‚æ©Ÿæˆç†Ÿæ–¹å¯è¡Œã€‚'},
'24':{n:'æ¾¤é›·éš¨',u:'ä·',j:'å…ƒäº¨åˆ©è²ï¼Œç„¡å’ã€‚',m:'é †å‹¢è€Œè¡Œï¼Œéš¨æ©Ÿæ‡‰è®Šã€‚'},
'25':{n:'æ¾¤é¢¨å¤§é',u:'ä·›',j:'æ£Ÿæ’“ï¼Œåˆ©æœ‰æ”¸å¾€ã€‚',m:'åŠ›é‡éå¤§ï¼Œéœ€è¬¹æ…ã€‚'},
'26':{n:'æ¾¤æ°´å›°',u:'ä·®',j:'äº¨ï¼Œè²ï¼Œå¤§äººå‰ã€‚',m:'å›°å¢ƒä¸­å …å®ˆæ­£é“ï¼Œçµ‚å°‡é€šé”ã€‚'},
'27':{n:'æ¾¤å±±å’¸',u:'ä·',j:'äº¨ï¼Œåˆ©è²ã€‚',m:'æ„Ÿæ‡‰ä¹‹é“ï¼Œå¿ƒæ„ç›¸é€šã€‚'},
'28':{n:'æ¾¤åœ°èƒ',u:'ä·¬',j:'äº¨ï¼Œç‹å‡æœ‰å»Ÿã€‚',m:'èšé›†åŒ¯èƒï¼Œåˆ©è¦‹å¤§äººã€‚'},
'31':{n:'ç«å¤©å¤§æœ‰',u:'ä·',j:'å…ƒäº¨ã€‚',m:'è±æ”¶å¤§æœ‰ï¼Œå…‰æ˜æ­£å¤§ã€‚'},
'32':{n:'ç«æ¾¤ç½',u:'ä·¥',j:'å°äº‹å‰ã€‚',m:'ä¹–é›¢èƒŒåï¼Œæ±‚åŒå­˜ç•°ã€‚'},
'33':{n:'é›¢ç‚ºç«',u:'ä·',j:'åˆ©è²ï¼Œäº¨ã€‚',m:'å…‰æ˜é™„éº—ï¼Œä¾é™„æ­£é“ã€‚'},
'34':{n:'ç«é›·å™¬å—‘',u:'ä·”',j:'äº¨ï¼Œåˆ©ç”¨ç„ã€‚',m:'æ˜è¾¨æ˜¯éï¼Œæœæ–·è™•ç†ã€‚'},
'35':{n:'ç«é¢¨é¼',u:'ä·±',j:'å…ƒå‰ï¼Œäº¨ã€‚',m:'é¼æ–°é™¤èˆŠï¼Œè®Šé©å‰µæ–°ã€‚'},
'36':{n:'ç«æ°´æœªæ¿Ÿ',u:'ä·¿',j:'äº¨ï¼Œå°ç‹æ±”æ¿Ÿã€‚',m:'å°šæœªå®Œæˆï¼Œä»éœ€åŠªåŠ›ã€‚'},
'37':{n:'ç«å±±æ—…',u:'ä··',j:'å°äº¨ã€‚',m:'å®¢å±…åœ¨å¤–ï¼Œè¬¹æ…è™•ä¸–ã€‚'},
'38':{n:'ç«åœ°æ™‰',u:'ä·¢',j:'åº·ä¾¯ç”¨éŒ«é¦¬è•ƒåº¶ã€‚',m:'å…‰æ˜ä¸Šé€²ï¼Œæ­¥æ­¥æ™‰å‡ã€‚'},
'41':{n:'é›·å¤©å¤§å£¯',u:'ä·¡',j:'åˆ©è²ã€‚',m:'æ°£å‹¢å£¯ç››ï¼Œå®ˆæ­£æ–¹å‰ã€‚'},
'42':{n:'é›·æ¾¤æ­¸å¦¹',u:'ä·µ',j:'å¾å‡¶ï¼Œç„¡æ”¸åˆ©ã€‚',m:'å®‰åˆ†å®ˆå·±ï¼Œä¸å¯å¦„å‹•ã€‚'},
'43':{n:'é›·ç«è±',u:'ä·¶',j:'äº¨ï¼Œç‹å‡ä¹‹ã€‚',m:'è±ç››ä¹‹æ™‚ï¼Œå±…å®‰æ€å±ã€‚'},
'44':{n:'éœ‡ç‚ºé›·',u:'ä·²',j:'äº¨ã€‚',m:'éœ‡å‹•å¥®ç™¼ï¼Œå…ˆé©šå¾Œå–œã€‚'},
'45':{n:'é›·é¢¨æ†',u:'ä·Ÿ',j:'äº¨ï¼Œç„¡å’ï¼Œåˆ©è²ã€‚',m:'æ†ä¹…ä¸è®Šï¼Œå®ˆæŒæ­£é“ã€‚'},
'46':{n:'é›·æ°´è§£',u:'ä·§',j:'åˆ©è¥¿å—ã€‚',m:'å±é›£è§£é™¤ï¼Œå®œé€Ÿè¡Œå‹•ã€‚'},
'47':{n:'é›·å±±å°é',u:'ä·½',j:'äº¨ï¼Œåˆ©è²ã€‚',m:'å°æœ‰éè¶Šï¼Œä½èª¿è¡Œäº‹ã€‚'},
'48':{n:'é›·åœ°è±«',u:'ä·',j:'åˆ©å»ºä¾¯è¡Œå¸«ã€‚',m:'æ­¡æ¨‚è±«æ‚…ï¼Œæº–å‚™å……åˆ†ã€‚'},
'51':{n:'é¢¨å¤©å°ç•œ',u:'ä·ˆ',j:'äº¨ï¼Œå¯†é›²ä¸é›¨ã€‚',m:'åŠ›é‡ä¸è¶³ï¼Œæš«æ™‚è“„ç©ã€‚'},
'52':{n:'é¢¨æ¾¤ä¸­å­š',u:'ä·¼',j:'è±šé­šå‰ã€‚',m:'èª ä¿¡ç‚ºæœ¬ï¼Œä¿¡å‰‡éˆé©—ã€‚'},
'53':{n:'é¢¨ç«å®¶äºº',u:'ä·¤',j:'åˆ©å¥³è²ã€‚',m:'å®¶é“æ˜Œæ˜ï¼Œå„å®‰å…¶ä½ã€‚'},
'54':{n:'é¢¨é›·ç›Š',u:'ä·©',j:'åˆ©æœ‰æ”¸å¾€ã€‚',m:'æä¸Šç›Šä¸‹ï¼Œåˆ©æ–¼é€²å–ã€‚'},
'55':{n:'å·½ç‚ºé¢¨',u:'ä·¸',j:'å°äº¨ï¼Œåˆ©æœ‰æ”¸å¾€ã€‚',m:'æŸ”é †æ¼¸é€²ï¼Œä»¥é€€ç‚ºé€²ã€‚'},
'56':{n:'é¢¨æ°´æ¸™',u:'ä·º',j:'äº¨ï¼Œç‹å‡æœ‰å»Ÿã€‚',m:'é›¢æ•£æ¸™æ•£ï¼Œéœ€å‡èšäººå¿ƒã€‚'},
'57':{n:'é¢¨å±±æ¼¸',u:'ä·´',j:'å¥³æ­¸å‰ï¼Œåˆ©è²ã€‚',m:'å¾ªåºæ¼¸é€²ï¼Œç©©æ­¥å‰è¡Œã€‚'},
'58':{n:'é¢¨åœ°è§€',u:'ä·“',j:'ç›¥è€Œä¸è–¦ã€‚',m:'è§€å¯Ÿå¯©è¦–ï¼Œä»¥èº«ä½œå‰‡ã€‚'},
'61':{n:'æ°´å¤©éœ€',u:'ä·„',j:'æœ‰å­šï¼Œå…‰äº¨ã€‚',m:'ç­‰å¾…æ™‚æ©Ÿï¼Œè€å¿ƒå®ˆå€™ã€‚'},
'62':{n:'æ°´æ¾¤ç¯€',u:'ä·»',j:'äº¨ï¼Œè‹¦ç¯€ä¸å¯è²ã€‚',m:'é©åº¦ç¯€åˆ¶ï¼Œä¸å¯éåº¦ã€‚'},
'63':{n:'æ°´ç«æ—¢æ¿Ÿ',u:'ä·¾',j:'äº¨å°ï¼Œåˆ©è²ã€‚',m:'äº‹å·²æˆï¼Œå±…å®‰æ€å±ã€‚'},
'64':{n:'æ°´é›·å±¯',u:'ä·‚',j:'å…ƒäº¨åˆ©è²ã€‚',m:'å‰µå§‹ä¹‹é›£ï¼Œå …æŒçµ‚æœ‰æˆã€‚'},
'65':{n:'æ°´é¢¨äº•',u:'ä·¯',j:'æ”¹é‚‘ä¸æ”¹äº•ã€‚',m:'é¤Šæ°‘ä¹‹æºï¼Œä¸å¯è’å»¢ã€‚'},
'66':{n:'åç‚ºæ°´',u:'ä·œ',j:'æœ‰å­šï¼Œç¶­å¿ƒäº¨ã€‚',m:'é‡é‡éšªé›£ï¼Œä»¥ä¿¡å¿ƒè¡Œéšªã€‚'},
'67':{n:'æ°´å±±è¹‡',u:'ä·¦',j:'åˆ©è¥¿å—ã€‚',m:'å‰è·¯è‰±éšªï¼Œé€€å®ˆåçœã€‚'},
'68':{n:'æ°´åœ°æ¯”',u:'ä·‡',j:'å‰ï¼ŒåŸç­®å…ƒæ°¸è²ã€‚',m:'è¦ªé™„æ¯”å’Œï¼Œåœ˜çµäº’åŠ©ã€‚'},
'71':{n:'å±±å¤©å¤§ç•œ',u:'ä·™',j:'åˆ©è²ï¼Œä¸å®¶é£Ÿå‰ã€‚',m:'è“„ç©åŠ›é‡ï¼Œåšç©è–„ç™¼ã€‚'},
'72':{n:'å±±æ¾¤æ',u:'ä·¨',j:'æœ‰å­šï¼Œå…ƒå‰ã€‚',m:'æ¸›æè‡ªå·±ï¼Œåˆ©ç›Šä»–äººã€‚'},
'73':{n:'å±±ç«è³',u:'ä·•',j:'äº¨ï¼Œå°åˆ©æœ‰æ”¸å¾€ã€‚',m:'æ–‡é£¾å¤–è¡¨ï¼Œä¸å¿˜æœ¬è³ªã€‚'},
'74':{n:'å±±é›·é ¤',u:'ä·š',j:'è²å‰ï¼Œè§€é ¤ã€‚',m:'é¤Šç”Ÿä¹‹é“ï¼Œæ…è¨€ç¯€é£Ÿã€‚'},
'75':{n:'å±±é¢¨è ±',u:'ä·‘',j:'å…ƒäº¨ï¼Œåˆ©æ¶‰å¤§å·ã€‚',m:'æ•´æ²»è…æ•—ï¼Œæ’¥äº‚åæ­£ã€‚'},
'76':{n:'å±±æ°´è’™',u:'ä·ƒ',j:'äº¨ï¼ŒåŒªæˆ‘æ±‚ç«¥è’™ã€‚',m:'å•Ÿè’™ä¹‹åˆï¼Œè™›å¿ƒå­¸ç¿’ã€‚'},
'77':{n:'è‰®ç‚ºå±±',u:'ä·³',j:'è‰®å…¶èƒŒï¼Œä¸ç²å…¶èº«ã€‚',m:'é©å¯è€Œæ­¢ï¼Œéœæ­¢å®ˆåˆ†ã€‚'},
'78':{n:'å±±åœ°å‰',u:'ä·–',j:'ä¸åˆ©æœ‰æ”¸å¾€ã€‚',m:'è¡°è½å‰è•ï¼Œéœå¾…å¾©ç”¦ã€‚'},
'81':{n:'åœ°å¤©æ³°',u:'ä·Š',j:'å°å¾€å¤§ä¾†ï¼Œå‰äº¨ã€‚',m:'é€šæ³°å’Œé †ï¼Œè¬äº‹äº¨é€šã€‚'},
'82':{n:'åœ°æ¾¤è‡¨',u:'ä·’',j:'å…ƒäº¨åˆ©è²ã€‚',m:'å±…é«˜è‡¨ä¸‹ï¼Œæ•™åŒ–è¬æ°‘ã€‚'},
'83':{n:'åœ°ç«æ˜å¤·',u:'ä·£',j:'åˆ©è‰±è²ã€‚',m:'å…‰æ˜å—å‚·ï¼ŒéŸœå…‰é¤Šæ™¦ã€‚'},
'84':{n:'åœ°é›·å¾©',u:'ä·—',j:'äº¨ï¼Œå‡ºå…¥ç„¡ç–¾ã€‚',m:'ä¸€é™½å¾©å§‹ï¼Œå¦æ¥µæ³°ä¾†ã€‚'},
'85':{n:'åœ°é¢¨å‡',u:'ä·­',j:'å…ƒäº¨ã€‚',m:'é€æ­¥ä¸Šå‡ï¼Œç©å°æˆå¤§ã€‚'},
'86':{n:'åœ°æ°´å¸«',u:'ä·†',j:'è²ï¼Œä¸ˆäººå‰ã€‚',m:'çµ±ç‡çœ¾äººï¼Œä»¥æ­£ç‚ºè¦ã€‚'},
'87':{n:'åœ°å±±è¬™',u:'ä·',j:'äº¨ï¼Œå›å­æœ‰çµ‚ã€‚',m:'è¬™è™›è‡ªç‰§ï¼Œå‰ç„¡ä¸åˆ©ã€‚'},
'88':{n:'å¤ç‚ºåœ°',u:'ä·',j:'å…ƒäº¨ï¼Œåˆ©ç‰é¦¬ä¹‹è²ã€‚',m:'æŸ”é †æ‰¿è¼‰ï¼Œåšå¾·åŒ…å®¹ã€‚'}
};

function gByN(n){return BG[((n-1)%8+8)%8]}
function g64(un,ln){return G64[''+un+ln]||{n:'æœªçŸ¥',u:'?',j:'',m:''}}
function gByL(l1,l2,l3){return BG.find(g=>g.li[0]===l3&&g.li[1]===l2&&g.li[2]===l1)||BG[7]}

function tiYong(ti,yo){
  if(ti===yo)return{r:'æ¯”å’Œ',f:'å‰',d:'é«”ç”¨ç›¸åŒï¼Œäº‹æƒ…é †åˆ©ã€‚'};
  if(SHENG[yo]===ti)return{r:'ç”¨ç”Ÿé«”',f:'å¤§å‰',d:'å¤–åŠ›åŠ©ç›Šï¼Œäº‹åŠåŠŸå€ã€‚'};
  if(SHENG[ti]===yo)return{r:'é«”ç”Ÿç”¨',f:'å°å‡¶',d:'è€—è²»ç²¾åŠ›ï¼Œä»˜å‡ºå¤šå›å ±å°‘ã€‚'};
  if(KE[yo]===ti)return{r:'ç”¨å…‹é«”',f:'å‡¶',d:'å¤–åŠ›é˜»ç¤™ï¼Œå›°é›£é‡é‡ã€‚'};
  if(KE[ti]===yo)return{r:'é«”å…‹ç”¨',f:'å°å‰',d:'å¯æŒæ§å±€é¢ï¼Œä½†éœ€è²»åŠ›ã€‚'};
  return{r:'â€”',f:'å¹³',d:''};
}

function calcMH(un,ln,dy){
  const up=gByN(un),lo=gByN(ln),dong=((dy-1)%6)+1;
  const ben=g64(up.n==='ä¹¾'?1:up.n==='å…Œ'?2:up.n==='é›¢'?3:up.n==='éœ‡'?4:up.n==='å·½'?5:up.n==='å'?6:up.n==='è‰®'?7:8,
               lo.n==='ä¹¾'?1:lo.n==='å…Œ'?2:lo.n==='é›¢'?3:lo.n==='éœ‡'?4:lo.n==='å·½'?5:lo.n==='å'?6:lo.n==='è‰®'?7:8);
  const benL=[...lo.li,...up.li];
  const huLo=gByL(benL[1],benL[2],benL[3]);
  const huUp=gByL(benL[2],benL[3],benL[4]);
  const hu=g64(huUp.n==='ä¹¾'?1:huUp.n==='å…Œ'?2:huUp.n==='é›¢'?3:huUp.n==='éœ‡'?4:huUp.n==='å·½'?5:huUp.n==='å'?6:huUp.n==='è‰®'?7:8,
               huLo.n==='ä¹¾'?1:huLo.n==='å…Œ'?2:huLo.n==='é›¢'?3:huLo.n==='éœ‡'?4:huLo.n==='å·½'?5:huLo.n==='å'?6:huLo.n==='è‰®'?7:8);
  const biL=[...benL]; biL[dong-1]=biL[dong-1]?0:1;
  const biLo=gByL(biL[0],biL[1],biL[2]);
  const biUp=gByL(biL[3],biL[4],biL[5]);
  const bian=g64(biUp.n==='ä¹¾'?1:biUp.n==='å…Œ'?2:biUp.n==='é›¢'?3:biUp.n==='éœ‡'?4:biUp.n==='å·½'?5:biUp.n==='å'?6:biUp.n==='è‰®'?7:8,
                 biLo.n==='ä¹¾'?1:biLo.n==='å…Œ'?2:biLo.n==='é›¢'?3:biLo.n==='éœ‡'?4:biLo.n==='å·½'?5:biLo.n==='å'?6:biLo.n==='è‰®'?7:8);
  const tiG=dong<=3?up:lo, yoG=dong<=3?lo:up;
  const ty=tiYong(tiG.el,yoG.el);
  return{up,lo,dong,ben,hu,bian,tiG,yoG,ty};
}

function guaNum(g){return g.n==='ä¹¾'?1:g.n==='å…Œ'?2:g.n==='é›¢'?3:g.n==='éœ‡'?4:g.n==='å·½'?5:g.n==='å'?6:g.n==='è‰®'?7:8}

function showMH(r){
  S.meihua=r;
  document.getElementById('mh-ben-s').textContent=r.ben.u;
  document.getElementById('mh-ben-n').textContent=r.ben.n;
  document.getElementById('mh-hu-s').textContent=r.hu.u;
  document.getElementById('mh-hu-n').textContent=r.hu.n;
  document.getElementById('mh-bian-s').textContent=r.bian.u;
  document.getElementById('mh-bian-n').textContent=r.bian.n;
  document.getElementById('mh-detail').innerHTML=`
    <p><strong>é«”å¦ï¼š</strong>${r.tiG.name}ï¼ˆ${r.tiG.el}ï¼‰ï½œ<strong>ç”¨å¦ï¼š</strong>${r.yoG.name}ï¼ˆ${r.yoG.el}ï¼‰</p>
    <p><strong>é«”ç”¨ï¼š</strong><span class="tag tag-gold">${r.ty.r}</span> <span class="tag ${r.ty.f.includes('å‰')?'tag-green':'tag-red'}">${r.ty.f}</span></p>
    <p class="mt-sm">${r.ty.d}</p><div class="divider"></div>
    <p><strong>å¦è¾­ï¼š</strong>${r.ben.j}</p><p><strong>è§£è®€ï¼š</strong>${r.ben.m}</p>
    <p><strong>å‹•çˆ»ï¼š</strong>ç¬¬ ${r.dong} çˆ»</p><p class="mt-sm"><strong>è®Šå¦ï¼š</strong>${r.bian.m}</p>`;
  document.getElementById('mh-result').classList.remove('hidden');
}

/* æ¼¢å­—ç­†ç•«æ•¸ï¼ˆç°¡è¡¨ï¼‰ */
const BIHUA_MAP={'æ„›':13,'æƒ…':11,'éŒ¢':16,'è²¡':10,'å·¥':3,'ä½œ':7,'äº‹':8,'æ¥­':13,'å¥':11,'åº·':11,'å®¶':10,'åº­':10,'äºº':2,'éš›':14,'é‹':12,'å‹¢':13,'æ„Ÿ':13,'å©š':11,'å§»':9,'å­¸':16,'ç¿’':11,'è€ƒ':6,'è©¦':13,'å‡':4,'è·':18,'è½‰':18};
function bihua(ch){return BIHUA_MAP[ch]||((ch.charCodeAt(0)%20)+2)}

function setMhMethod(m){
  ['time','number','char','random'].forEach(id=>{
    document.getElementById('mhf-'+id).classList.toggle('hidden',id!==m);
    const btn=document.getElementById('mh-m-'+id);
    if(id===m){btn.classList.remove('btn-outline');btn.classList.add('btn-tab-active')}
    else{btn.classList.add('btn-outline');btn.classList.remove('btn-tab-active')}
  });
}
function calcMhTime(){
  const now=new Date();
  const y=now.getFullYear(),m=now.getMonth()+1,d=now.getDate(),h=now.getHours();
  // è¾²æ›†è¿‘ä¼¼
  const un=(y+m+d)%8||8, ln=(y+m+d+h)%8||8, dy=(y+m+d+h)%6||6;
  showMH(calcMH(un,ln,dy));
}
function calcMhNumber(){
  const n1=parseInt(document.getElementById('mh-n1').value)||1;
  const n2=parseInt(document.getElementById('mh-n2').value)||1;
  const n3=parseInt(document.getElementById('mh-n3').value)||1;
  showMH(calcMH(n1,n2,Math.min(6,Math.max(1,n3))));
}
function calcMhChar(){
  const ch=document.getElementById('mh-char').value.trim();
  if(!ch){alert('è«‹è¼¸å…¥æ¼¢å­—');return}
  const chars=[...ch];
  let un,ln,dy;
  if(chars.length===1){un=bihua(chars[0]);ln=un;dy=(un*2)%6||6}
  else if(chars.length===2){un=bihua(chars[0]);ln=bihua(chars[1]);dy=(un+ln)%6||6}
  else{un=bihua(chars[0])+bihua(chars[1]);ln=bihua(chars[chars.length-1]);dy=(un+ln)%6||6}
  showMH(calcMH(un,ln,dy));
}
function calcMhRandom(){
  showMH(calcMH(Math.ceil(Math.random()*8),Math.ceil(Math.random()*8),Math.ceil(Math.random()*6)));
}
/* =============================================================
   å¡”ç¾…ç‰Œ TAROT â€” 22å¤§ç‰Œ + å‡±çˆ¾ç‰¹åå­—ç‰Œé™£
   ============================================================= */
const TAROT=[
  {id:0,n:'æ„šè€…',el:'é¢¨',up:'å……æ»¿ç„¡é™å¯èƒ½ï¼Œå‹‡æ•¢è¸å‡ºç¬¬ä¸€æ­¥ã€‚',rv:'é­¯è½è¡Œäº‹ï¼Œç¼ºä¹è¨ˆç•«ã€‚'},
  {id:1,n:'é­”è¡“å¸«',el:'æ°´æ˜Ÿ',up:'æ“æœ‰æˆåŠŸæ‰€éœ€çš„ä¸€åˆ‡è³‡æºã€‚',rv:'æ‰èƒ½æœªç™¼æ®ï¼Œæ³¨æ„æ¬ºé¨™ã€‚'},
  {id:2,n:'å¥³ç¥­å¸',el:'æœˆäº®',up:'å‚¾è½ç›´è¦ºï¼Œéœå¾…æ™‚æ©Ÿã€‚',rv:'éæ–¼å°é–‰ï¼Œå¿½è¦–å…§å¿ƒè²éŸ³ã€‚'},
  {id:3,n:'çš‡å',el:'é‡‘æ˜Ÿ',up:'è±æ”¶èˆ‡æ»‹é¤Šï¼Œå‰µé€ åŠ›æ—ºç››ã€‚',rv:'ä¾è³´ä»–äººï¼Œéåº¦æ”¾ç¸±ã€‚'},
  {id:4,n:'çš‡å¸',el:'ç™½ç¾Š',up:'æŒæ§å±€é¢ï¼Œå»ºç«‹ç§©åºã€‚',rv:'æ§åˆ¶æ¬²å¼·ï¼Œéæ–¼åƒµåŒ–ã€‚'},
  {id:5,n:'æ•™çš‡',el:'é‡‘ç‰›',up:'éµå¾ªæ­£é“ï¼Œå°‹æ±‚æ™ºè€…æŒ‡å¼•ã€‚',rv:'æ•™æ¢ä¸»ç¾©ï¼Œä¸çŸ¥è®Šé€šã€‚'},
  {id:6,n:'æˆ€äºº',el:'é›™å­',up:'åšå‡ºé‡è¦é¸æ“‡ï¼ŒçœŸæ„›é™è‡¨ã€‚',rv:'é—œä¿‚ä¸å’Œï¼Œåƒ¹å€¼è§€è¡çªã€‚'},
  {id:7,n:'æˆ°è»Š',el:'å·¨èŸ¹',up:'å …å®šæ„å¿—ï¼Œå…‹æœå›°é›£å‰é€²ã€‚',rv:'å¤±æ§ï¼Œæ–¹å‘ä¸æ˜ã€‚'},
  {id:8,n:'åŠ›é‡',el:'ç…å­',up:'ä»¥æŸ”å…‹å‰›ï¼Œå…§åœ¨åŠ›é‡å¼·å¤§ã€‚',rv:'è‡ªæˆ‘æ‡·ç–‘ï¼Œç¼ºä¹ä¿¡å¿ƒã€‚'},
  {id:9,n:'éš±è€…',el:'è™•å¥³',up:'ç¨è™•åçœï¼Œå°‹æ‰¾å…§åœ¨æ™ºæ…§ã€‚',rv:'éåº¦å­¤ç«‹ï¼Œé€ƒé¿ç¾å¯¦ã€‚'},
  {id:10,n:'å‘½é‹ä¹‹è¼ª',el:'æœ¨æ˜Ÿ',up:'å‘½é‹è½‰æŠ˜ï¼Œå¥½é‹é™è‡¨ã€‚',rv:'é€†å¢ƒï¼ŒæŠ—æ‹’æ”¹è®Šã€‚'},
  {id:11,n:'æ­£ç¾©',el:'å¤©ç§¤',up:'å…¬æ­£çš„çµæœï¼Œå› æœå ±æ‡‰ã€‚',rv:'ä¸å…¬ã€åè¦‹ã€‚'},
  {id:12,n:'åŠäºº',el:'æ°´',up:'æ›è§’åº¦çœ‹å•é¡Œï¼Œæš«æ™‚çŠ§ç‰²ã€‚',rv:'ä¸å¿…è¦çš„çŠ§ç‰²ï¼Œæ‹–å»¶ã€‚'},
  {id:13,n:'æ­»ç¥',el:'å¤©è ',up:'èˆŠçš„çµæŸï¼Œæ–°çš„é–‹å§‹ã€‚',rv:'æŠ—æ‹’æ”¹è®Šï¼Œåœæ»¯ä¸å‰ã€‚'},
  {id:14,n:'ç¯€åˆ¶',el:'å°„æ‰‹',up:'ä¿æŒä¸­åº¸ï¼Œèª¿å’Œå„æ–¹ã€‚',rv:'å¤±è¡¡ï¼Œéåº¦ã€‚'},
  {id:15,n:'æƒ¡é­”',el:'æ‘©ç¾¯',up:'é¢å°é™°æš—é¢ï¼Œç‰©è³ªèª˜æƒ‘ã€‚',rv:'æ™è„«æŸç¸›ï¼Œé‡ç²è‡ªç”±ã€‚'},
  {id:16,n:'å¡”',el:'ç«æ˜Ÿ',up:'çªç„¶æ”¹è®Šï¼ŒèˆŠçµæ§‹å´©å¡Œã€‚',rv:'é¿é–‹ç½é›£ï¼Œæ‹’çµ•æ”¹è®Šã€‚'},
  {id:17,n:'æ˜Ÿæ˜Ÿ',el:'æ°´ç“¶',up:'å¸Œæœ›ä¹‹å…‰ï¼Œéˆæ„Ÿæ¹§ç¾ã€‚',rv:'å¤±æœ›ï¼Œç¼ºä¹ä¿¡å¿ƒã€‚'},
  {id:18,n:'æœˆäº®',el:'é›™é­š',up:'é¢å°ææ‡¼ï¼Œç©¿è¶Šè¿·éœ§ã€‚',rv:'èµ°å‡ºè¿·æƒ˜ï¼ŒçœŸç›¸é¡¯ç¾ã€‚'},
  {id:19,n:'å¤ªé™½',el:'å¤ªé™½',up:'ä¸€åˆ‡å…‰æ˜æ­£å¤§ï¼Œå–œæ‚…æˆåŠŸã€‚',rv:'çŸ­æš«é™°éœ¾ï¼Œä¿¡å¿ƒä¸è¶³ã€‚'},
  {id:20,n:'å¯©åˆ¤',el:'å†¥ç‹æ˜Ÿ',up:'éˆé­‚è¦ºé†’ï¼Œé‡æ–°è©•ä¼°ã€‚',rv:'è‡ªæˆ‘æ‡·ç–‘ï¼Œæ‹’çµ•æˆé•·ã€‚'},
  {id:21,n:'ä¸–ç•Œ',el:'åœŸæ˜Ÿ',up:'é”æˆç›®æ¨™ï¼Œåœ“æ»¿å®Œæˆã€‚',rv:'æœªå®Œæˆï¼Œç¼ºä¹åœ“æ»¿ã€‚'},
  // å°é˜¿çˆ¾å¡ç´ â€” æ¬Šæ–
  {id:22,n:'æ¬Šæ–ç‹ç‰Œ',el:'ç«',up:'æ–°è¨ˆç•«å•Ÿå‹•ï¼Œå‰µé€ åŠ›è¿¸ç™¼ã€‚',rv:'å»¶é²ï¼ŒçŒ¶è±«ä¸æ±ºã€‚'},
  {id:23,n:'æ¬Šæ–äºŒ',el:'ç«',up:'è¨ˆç•«ä¸­ï¼Œç­‰å¾…æ™‚æ©Ÿã€‚',rv:'ææ‡¼æ”¹è®Šï¼Œç¼ºä¹é è¦‹ã€‚'},
  {id:24,n:'æ¬Šæ–ä¸‰',el:'ç«',up:'æ‹“å±•è¦–é‡ï¼Œåˆä½œé †åˆ©ã€‚',rv:'ç¼ºä¹é è¦‹ï¼Œè¨ˆç•«å—é˜»ã€‚'},
  {id:25,n:'æ¬Šæ–å››',el:'ç«',up:'æ…¶ç¥æˆå°±ï¼Œå’Œè«§ç©©å®šã€‚',rv:'ä¸å®‰å®šï¼Œç¼ºä¹æ­¸å±¬æ„Ÿã€‚'},
  {id:26,n:'æ¬Šæ–äº”',el:'ç«',up:'ç«¶çˆ­æ¿€çƒˆï¼Œéœ€å …æŒç«‹å ´ã€‚',rv:'é€ƒé¿è¡çªï¼Œå…§è€—ã€‚'},
  {id:27,n:'æ¬Šæ–å…­',el:'ç«',up:'å‹åˆ©èˆ‡èªå¯ï¼Œå…¬é–‹æˆåŠŸã€‚',rv:'è‡ªè² ï¼Œç¼ºä¹èªå¯ã€‚'},
  {id:28,n:'æ¬Šæ–ä¸ƒ',el:'ç«',up:'å …å®ˆç«‹å ´ï¼Œé¢å°æŒ‘æˆ°ã€‚',rv:'åŠ›ä¸å¾å¿ƒï¼Œè¢«å£“å€’ã€‚'},
  {id:29,n:'æ¬Šæ–å…«',el:'ç«',up:'å¿«é€Ÿç™¼å±•ï¼Œæ¶ˆæ¯åˆ°ä¾†ã€‚',rv:'å»¶é²ï¼Œæ€¥èºã€‚'},
  {id:30,n:'æ¬Šæ–ä¹',el:'ç«',up:'å …æŒåˆ°åº•ï¼Œæœ€å¾Œé˜²ç·šã€‚',rv:'ç–²æ†Šï¼Œå›ºåŸ·ã€‚'},
  {id:31,n:'æ¬Šæ–å',el:'ç«',up:'è²¬ä»»æ²‰é‡ï¼Œå …æŒå‰è¡Œã€‚',rv:'æ”¾ä¸‹é‡æ“”ï¼Œå§”æ´¾ä»–äººã€‚'},
  {id:32,n:'æ¬Šæ–ä¾è€…',el:'ç«',up:'å¥½æ¶ˆæ¯ï¼Œæ–°å†’éšªã€‚',rv:'ä¸åˆ‡å¯¦éš›çš„è¨ˆç•«ã€‚'},
  {id:33,n:'æ¬Šæ–é¨å£«',el:'ç«',up:'è¡Œå‹•åŠ›å¼·ï¼Œè¿½æ±‚ç†±æƒ…ã€‚',rv:'è¡å‹•ï¼Œé­¯è½ã€‚'},
  {id:34,n:'æ¬Šæ–çš‡å',el:'ç«',up:'è‡ªä¿¡ã€é­…åŠ›ï¼Œæ¿€å‹µä»–äººã€‚',rv:'å«‰å¦’ï¼Œè‡ªæˆ‘ä¸­å¿ƒã€‚'},
  {id:35,n:'æ¬Šæ–åœ‹ç‹',el:'ç«',up:'é ˜å°åŠ›å¼·ï¼Œé¡˜æ™¯å®å¤§ã€‚',rv:'å‚²æ…¢ï¼Œåš´è‹›ã€‚'},
  // è–æ¯
  {id:36,n:'è–æ¯ç‹ç‰Œ',el:'æ°´',up:'æ–°æ„Ÿæƒ…é–‹å§‹ï¼Œæƒ…æ„Ÿå……æ²›ã€‚',rv:'æ„Ÿæƒ…å°é–‰ï¼ŒéŒ¯å¤±æ©Ÿæœƒã€‚'},
  {id:37,n:'è–æ¯äºŒ',el:'æ°´',up:'ä¼´ä¾¶é—œä¿‚ï¼Œç›¸äº’å¸å¼•ã€‚',rv:'å¤±è¡¡ï¼Œæºé€šä¸è‰¯ã€‚'},
  {id:38,n:'è–æ¯ä¸‰',el:'æ°´',up:'æ­¡æ…¶å‹èª¼ï¼Œç¤¾äº¤æ´»å‹•ã€‚',rv:'éåº¦æ”¾ç¸±ï¼Œå­¤ç«‹ã€‚'},
  {id:39,n:'è–æ¯å››',el:'æ°´',up:'å°ç¾ç‹€ä¸æ»¿ï¼ŒéŒ¯å¤±æ©Ÿæœƒã€‚',rv:'é‡æ–°å¯©è¦–ï¼Œç™¼ç¾æ–°å¯èƒ½ã€‚'},
  {id:40,n:'è–æ¯äº”',el:'æ°´',up:'å¤±è½èˆ‡æ‚²å‚·ï¼Œä½†ä»æœ‰å¸Œæœ›ã€‚',rv:'èµ°å‡ºæ‚²å‚·ï¼Œæ¥å—ç¾å¯¦ã€‚'},
  {id:41,n:'è–æ¯å…­',el:'æ°´',up:'æ‡·èˆŠï¼Œç«¥å¹´å›æ†¶ã€‚',rv:'æ´»åœ¨éå»ï¼Œç„¡æ³•å‰é€²ã€‚'},
  {id:42,n:'è–æ¯ä¸ƒ',el:'æ°´',up:'å¤ªå¤šé¸æ“‡ï¼Œéœ€åˆ†è¾¨å¹»è±¡ã€‚',rv:'åšå‡ºæ±ºå®šï¼Œé¢å°ç¾å¯¦ã€‚'},
  {id:43,n:'è–æ¯å…«',el:'æ°´',up:'é›¢é–‹ä¸å†é©åˆçš„ï¼Œå°‹æ‰¾æ›´æ·±ã€‚',rv:'ææ‡¼æ”¹è®Šï¼Œç•™åœ¨èˆ’é©å€ã€‚'},
  {id:44,n:'è–æ¯ä¹',el:'æ°´',up:'é¡˜æœ›å¯¦ç¾ï¼Œæ»¿è¶³æ„Ÿã€‚',rv:'ä¸æ»¿ï¼Œç‰©è³ªä¸»ç¾©ã€‚'},
  {id:45,n:'è–æ¯å',el:'æ°´',up:'æƒ…æ„Ÿåœ“æ»¿ï¼Œå®¶åº­å¹¸ç¦ã€‚',rv:'å®¶åº­å•é¡Œï¼Œä¸å’Œè«§ã€‚'},
  {id:46,n:'è–æ¯ä¾è€…',el:'æ°´',up:'æµªæ¼«è¨Šæ¯ï¼Œç›´è¦ºç™¼å±•ã€‚',rv:'æƒ…ç·’ä¸ç©©ï¼Œä¸æˆç†Ÿã€‚'},
  {id:47,n:'è–æ¯é¨å£«',el:'æ°´',up:'æµªæ¼«è¿½æ±‚è€…ï¼Œæ„Ÿæ€§è¡Œå‹•ã€‚',rv:'æƒ…ç·’åŒ–ï¼Œä¸åˆ‡å¯¦éš›ã€‚'},
  {id:48,n:'è–æ¯çš‡å',el:'æ°´',up:'æ…ˆæ„›ï¼Œæƒ…æ„Ÿè±å¯Œï¼Œç›´è¦ºå¼·ã€‚',rv:'æƒ…ç·’åŒ–ï¼Œéåº¦ä»˜å‡ºã€‚'},
  {id:49,n:'è–æ¯åœ‹ç‹',el:'æ°´',up:'æƒ…æ„Ÿæˆç†Ÿï¼Œæ…·æ…¨æ™ºæ…§ã€‚',rv:'æƒ…æ„Ÿå£“æŠ‘ï¼Œæ“æ§ã€‚'},
  // å¯¶åŠ
  {id:50,n:'å¯¶åŠç‹ç‰Œ',el:'é¢¨',up:'çœŸç›¸èˆ‡çªç ´ï¼Œæ–°æƒ³æ³•ã€‚',rv:'æ··äº‚æ€ç·’ï¼ŒéŒ¯èª¤åˆ¤æ–·ã€‚'},
  {id:51,n:'å¯¶åŠäºŒ',el:'é¢¨',up:'æŠ‰æ“‡å›°é›£ï¼Œéœ€å¹³è¡¡æ€è€ƒã€‚',rv:'è³‡è¨Šéè¼‰ï¼Œé€ƒé¿æ±ºå®šã€‚'},
  {id:52,n:'å¯¶åŠä¸‰',el:'é¢¨',up:'å¿ƒç¢ï¼Œæ‚²ç—›ï¼Œéœ€è¦ç™‚ç™’ã€‚',rv:'èµ°å‡ºå‚·ç—›ï¼Œé–‹å§‹å¾©åŸã€‚'},
  {id:53,n:'å¯¶åŠå››',el:'é¢¨',up:'ä¼‘æ¯æ¢å¾©ï¼Œéœé¤Šã€‚',rv:'ç„¦èºä¸å®‰ï¼Œä¸é¡˜ä¼‘æ¯ã€‚'},
  {id:54,n:'å¯¶åŠäº”',el:'é¢¨',up:'è¡çªèˆ‡å¤±æ•—ï¼Œè‡ªç§è¡Œç‚ºã€‚',rv:'å’Œè§£ï¼Œå­¸æœƒèªè¼¸ã€‚'},
  {id:55,n:'å¯¶åŠå…­',el:'é¢¨',up:'é›¢é–‹å›°å¢ƒï¼Œéæ¸¡æœŸã€‚',rv:'å›°ä½ï¼Œç„¡æ³•é›¢é–‹ã€‚'},
  {id:56,n:'å¯¶åŠä¸ƒ',el:'é¢¨',up:'ç­–ç•¥è¡Œå‹•ï¼Œä½†éœ€æ³¨æ„æ¬ºé¨™ã€‚',rv:'çœŸç›¸æ­éœ²ï¼Œè‰¯å¿ƒä¸å®‰ã€‚'},
  {id:57,n:'å¯¶åŠå…«',el:'é¢¨',up:'è‡ªæˆ‘é™åˆ¶ï¼Œå›°å¢ƒæ˜¯å¿ƒé€ ã€‚',rv:'è§£è„«æŸç¸›ï¼Œçœ‹æ¸…çœŸç›¸ã€‚'},
  {id:58,n:'å¯¶åŠä¹',el:'é¢¨',up:'ç„¦æ…®ã€ææ‡¼ã€å¤±çœ ã€‚',rv:'é¢å°ææ‡¼ï¼Œèµ°å‡ºç„¦æ…®ã€‚'},
  {id:59,n:'å¯¶åŠå',el:'é¢¨',up:'çµæŸèˆ‡æ”¾ä¸‹ï¼Œè§¸åº•åå½ˆã€‚',rv:'æœ€å£å·²éï¼Œé–‹å§‹æ¢å¾©ã€‚'},
  {id:60,n:'å¯¶åŠä¾è€…',el:'é¢¨',up:'å¥½å¥‡å¿ƒï¼Œæ–°æƒ³æ³•ã€‚',rv:'å…«å¦ï¼Œå†·æ¼ ã€‚'},
  {id:61,n:'å¯¶åŠé¨å£«',el:'é¢¨',up:'æ€è·¯æ¸…æ™°ï¼Œå¿«é€Ÿè¡Œå‹•ã€‚',rv:'è¡å‹•ç™¼è¨€ï¼Œç¼ºä¹åŒç†ã€‚'},
  {id:62,n:'å¯¶åŠçš‡å',el:'é¢¨',up:'ç¨ç«‹æ€è€ƒï¼ŒçœŸç›¸ã€‚',rv:'å†·é…·ï¼Œéæ–¼ç†æ€§ã€‚'},
  {id:63,n:'å¯¶åŠåœ‹ç‹',el:'é¢¨',up:'ç†æ€§æ¬Šå¨ï¼Œå…¬æ­£åˆ¤æ–·ã€‚',rv:'ç¨è£ï¼Œå†·é…·ç„¡æƒ…ã€‚'},
  // é‡‘å¹£
  {id:64,n:'é‡‘å¹£ç‹ç‰Œ',el:'åœŸ',up:'æ–°è²¡å‹™æ©Ÿæœƒï¼Œç‰©è³ªè±ç››ã€‚',rv:'éŒ¯å¤±è‰¯æ©Ÿï¼Œè²ªå©ªã€‚'},
  {id:65,n:'é‡‘å¹£äºŒ',el:'åœŸ',up:'å¹³è¡¡ï¼Œé©æ‡‰è®ŠåŒ–ã€‚',rv:'å¤±è¡¡ï¼Œå„ªå…ˆé †åºæ··äº‚ã€‚'},
  {id:66,n:'é‡‘å¹£ä¸‰',el:'åœŸ',up:'åœ˜éšŠåˆä½œï¼ŒæŠ€èƒ½æå‡ã€‚',rv:'ç¼ºä¹å”ä½œï¼Œå“è³ªä¸ä½³ã€‚'},
  {id:67,n:'é‡‘å¹£å››',el:'åœŸ',up:'å®ˆè²¡ï¼Œå®‰å…¨æ„Ÿã€‚',rv:'éåº¦åå—‡ï¼Œææ‡¼å¤±å»ã€‚'},
  {id:68,n:'é‡‘å¹£äº”',el:'åœŸ',up:'å›°é›£æ™‚æœŸï¼Œç‰©è³ªåŒ±ä¹ã€‚',rv:'èµ°å‡ºå›°å¢ƒï¼Œæ´åŠ©åˆ°ä¾†ã€‚'},
  {id:69,n:'é‡‘å¹£å…­',el:'åœŸ',up:'æ…·æ…¨ï¼Œæ–½èˆ‡å—çš„å¹³è¡¡ã€‚',rv:'å‚µå‹™ï¼Œå–®æ–¹é¢ä»˜å‡ºã€‚'},
  {id:70,n:'é‡‘å¹£ä¸ƒ',el:'åœŸ',up:'è€å¿ƒç­‰å¾…æ”¶ç©«ã€‚',rv:'æ€¥èºï¼Œç¼ºä¹è€å¿ƒã€‚'},
  {id:71,n:'é‡‘å¹£å…«',el:'åœŸ',up:'ç²¾é€²æŠ€è—ï¼Œå°ˆæ³¨æŠ•å…¥ã€‚',rv:'ç¼ºä¹ç†±æƒ…ï¼Œæ•·è¡äº†äº‹ã€‚'},
  {id:72,n:'é‡‘å¹£ä¹',el:'åœŸ',up:'è±æ”¶ï¼Œè‡ªçµ¦è‡ªè¶³ã€‚',rv:'éåº¦è‡ªè¶³ï¼Œè²¡å‹™é¢¨éšªã€‚'},
  {id:73,n:'é‡‘å¹£å',el:'åœŸ',up:'å®¶æ—è²¡å¯Œï¼Œé•·ä¹…ç©©å®šã€‚',rv:'å®¶åº­è²¡å‹™å•é¡Œã€‚'},
  {id:74,n:'é‡‘å¹£ä¾è€…',el:'åœŸ',up:'å­¸ç¿’æ©Ÿæœƒï¼Œå‹™å¯¦ç›®æ¨™ã€‚',rv:'ç¼ºä¹æ–¹å‘ï¼Œæµªè²»è³‡æºã€‚'},
  {id:75,n:'é‡‘å¹£é¨å£«',el:'åœŸ',up:'ç©©å¥å‰é€²ï¼Œæœ‰æ•ˆç‡ã€‚',rv:'å›ºåŸ·ï¼Œéåº¦ä¿å®ˆã€‚'},
  {id:76,n:'é‡‘å¹£çš‡å',el:'åœŸ',up:'å¯Œè¶³ï¼Œå®‰å…¨ï¼Œå¯¦éš›ã€‚',rv:'ä¸å®‰å…¨æ„Ÿï¼Œéåº¦ç‰©è³ªã€‚'},
  {id:77,n:'é‡‘å¹£åœ‹ç‹',el:'åœŸ',up:'è²¡å‹™æˆåŠŸï¼Œé ˜å°åŠ›ã€‚',rv:'è²ªå©ªï¼Œéåº¦æ§åˆ¶ã€‚'}
];

const CELTIC_POS=['æ ¸å¿ƒç¾ç‹€','é˜»ç¤™å› ç´ ','éå»åŸºç¤','æœªä¾†ç™¼å±•','å¯èƒ½çµæœ','è¿‘æœŸæœªä¾†','è‡ªæˆ‘æ…‹åº¦','ç’°å¢ƒå½±éŸ¿','å¸Œæœ›ææ‡¼','æœ€çµ‚çµæœ'];

let drawnCards=[];
function drawCard(){
  if(drawnCards.length>=10)return;
  const avail=TAROT.filter(c=>!drawnCards.find(d=>d.id===c.id));
  const card=avail[Math.floor(Math.random()*avail.length)];
  const isUp=Math.random()>0.35;
  drawnCards.push({...card,isUp,pos:CELTIC_POS[drawnCards.length]});
  renderDrawn();
  if(drawnCards.length>=10){
    document.getElementById('btn-draw').disabled=true;
    document.getElementById('btn-analyze').disabled=false;
    showSpread();
  }
}
function autoDraw(){while(drawnCards.length<10)drawCard()}

function renderDrawn(){
  const el=document.getElementById('t-hand');
  document.getElementById('t-remain').textContent=10-drawnCards.length;
  el.innerHTML=drawnCards.map((c,i)=>`
    <div class="t-card flipped" title="${c.n}">
      <div class="t-card-inner">
        <div class="t-card-face t-back"></div>
        <div class="t-card-face t-front ${c.isUp?'':''}">
          <span class="tc-name" style="${c.isUp?'':'transform:rotate(180deg)'}">${c.n}</span>
          <span class="tc-dir">${c.isUp?'æ­£ä½':'é€†ä½'}</span>
        </div>
      </div>
    </div>`).join('');
}

function showSpread(){
  S.tarot.drawn=drawnCards;
  S.tarot.spread=drawnCards;
  document.getElementById('t-spread-sec').classList.remove('hidden');
  const el=document.getElementById('t-spread');
  el.innerHTML=drawnCards.map((c,i)=>`
    <div class="card" style="padding:var(--sp-md);margin-bottom:var(--sp-sm)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-xs)">
        <span class="tag tag-gold">${i+1}. ${c.pos}</span>
        <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'æ­£ä½':'é€†ä½'}</span>
      </div>
      <strong class="text-gold serif">${c.n}</strong>
      <p class="text-sm text-dim mt-sm">${c.isUp?c.up:c.rv}</p>
    </div>`).join('');
}
/* =============================================================
   RENDER FUNCTIONS â€” çµæœé æ¸²æŸ“
   ============================================================= */
function showDim(id){
  const map={bazi:'å…«å­—',ziwei:'ç´«å¾®',meihua:'æ¢…èŠ±',tarot:'å¡”ç¾…',name:'å§“å'};
  document.querySelectorAll('.dim-tab').forEach(t=>{
    const match=Object.entries(map).find(([k,v])=>t.textContent.includes(v));
    t.classList.toggle('active',match&&match[0]===id);
  });
  document.querySelectorAll('.dim-pane').forEach(p=>p.classList.toggle('active',p.id==='pane-'+id));
}

function renderBazi(){
  const b=S.bazi; if(!b)return;
  const p=b.pillars;
  const labels=['æ™‚æŸ±','æ—¥æŸ±','æœˆæŸ±','å¹´æŸ±'];
  const cols=['hour','day','month','year'];

  // å››æŸ±è¡¨æ ¼
  let html='<div class="bazi-grid">';
  html+=cols.map((_,i)=>`<div class="bazi-cell header">${labels[i]}</div>`).join('');
  // å¤©å¹²è¡Œ
  html+=cols.map(c=>{
    const g=p[c].gan;
    return`<div class="bazi-cell"><span class="gz">${g}</span><span class="el-tag el-${WX_G[g]}">${WX_G[g]}</span><div class="gz-sub">${c==='day'?'æ—¥ä¸»':b.gods[c].gan}</div></div>`;
  }).join('');
  // åœ°æ”¯è¡Œ
  html+=cols.map(c=>{
    const z=p[c].zhi;
    return`<div class="bazi-cell"><span class="gz">${z}</span><span class="el-tag el-${WX_Z[z]}">${WX_Z[z]}</span><div class="gz-sub">${b.cs[c]}</div></div>`;
  }).join('');
  // è—å¹²è¡Œ
  html+=cols.map(c=>{
    const cg=b.cangGan[c]||[];
    return`<div class="bazi-cell"><div class="gz-sub">è—å¹²</div>${cg.map(g=>`<span class="el-tag el-${WX_G[g]}" style="margin:1px">${g}</span>`).join('')}</div>`;
  }).join('');
  html+='</div>';

  // ç´éŸ³
  html+=`<p class="text-sm text-dim mt-sm">ç´éŸ³ï¼š${b.nayin} ï½œ èº«${b.strong?'<span class="text-success">å¼·</span>':'<span class="text-danger">å¼±</span>'} ï½œ æ—¥ä¸»ï¼š${b.dm}ï¼ˆ${b.dmEl}ï¼‰</p>`;
  document.getElementById('d-bazi').innerHTML=html;

  // äº”è¡ŒæŸ±ç‹€åœ–
  const els=['é‡‘','æœ¨','æ°´','ç«','åœŸ'];
  const colors={é‡‘:'var(--el-metal)',æœ¨:'var(--el-wood)',æ°´:'var(--el-water)',ç«:'var(--el-fire)',åœŸ:'var(--el-earth)'};
  document.getElementById('d-elbar').innerHTML='<div class="el-bar">'+els.map(e=>`
    <div class="el-row"><span class="el-lbl" style="color:${colors[e]}">${e}</span>
    <div class="el-track"><div class="el-fill" style="width:${b.ep[e]}%;background:${colors[e]}"></div></div>
    <span class="el-val">${b.ep[e]}%</span></div>`).join('')+'</div>';

  // åç¥
  document.getElementById('d-gods').innerHTML=`
    <div class="bazi-grid" style="margin:0">
      ${cols.map((_,i)=>`<div class="bazi-cell header">${labels[i]}</div>`).join('')}
      ${cols.map(c=>`<div class="bazi-cell"><strong>${b.gods[c].gan}</strong></div>`).join('')}
      ${cols.map(c=>`<div class="bazi-cell">${(b.gods[c].zhi||[]).join('<br>')}</div>`).join('')}
    </div>`;

  // è—å¹²
  document.getElementById('d-canggan').innerHTML=cols.map(c=>{
    const cg=b.cangGan[c]||[];
    return`<p><strong>${labels[cols.indexOf(c)]}ï¼ˆ${p[c].zhi}ï¼‰ï¼š</strong>${cg.map(g=>`${g}(${WX_G[g]}/${tenGod(b.dm,g)})`).join('ã€')||'â€”'}</p>`;
  }).join('');

  // å–œç”¨å¿Œç¥ + ç¥ç…
  document.getElementById('d-xiyong').innerHTML=`
    <p><strong>å–œç”¨ç¥ï¼š</strong>${b.fav.map(e=>`<span class="tag tag-green">${e}</span>`).join(' ')}</p>
    <p class="mt-sm"><strong>å¿Œã€€ç¥ï¼š</strong>${b.unfav.map(e=>`<span class="tag tag-red">${e}</span>`).join(' ')}</p>
    ${b.shensha.length?`<p class="mt-sm"><strong>ç¥ã€€ç…ï¼š</strong>${b.shensha.map(s=>`<span class="tag tag-gold">${s}</span>`).join(' ')}</p>`:''}`;

  // å¤§é‹
  document.getElementById('d-dayun').innerHTML='<div class="dayun-tl">'+b.dayun.map(d=>{
    const lvClass=d.level==='å¤§å‰'?'lv-dj':d.level==='ä¸­å‰'?'lv-zj':d.level==='å°å‰'?'lv-xj':d.level==='å¹³'?'lv-p':d.level==='å°å‡¶'?'lv-xk':d.level==='ä¸­å‡¶'?'lv-zk':'lv-dk';
    return`<div class="dy-item ${d.isCurrent?'current':''}">
      <span class="dy-gz">${d.gz}</span><span class="dy-age">${d.ageStart}-${d.ageEnd}æ­²</span>
      <span class="dy-lv ${lvClass}">${d.level}</span><div class="gz-sub">${d.god}</div></div>`;
  }).join('')+'</div>';
}

function renderMeihua(){
  if(!S.meihua){document.getElementById('r-meihua').innerHTML='<p class="text-dim">æœªé€²è¡Œæ¢…èŠ±æ˜“æ•¸èµ·å¦</p>';return}
  const r=S.meihua;
  document.getElementById('r-meihua').innerHTML=`
    <div class="hex-grid">
      <div class="hex-card"><h4>æœ¬å¦</h4><div class="hex-sym">${r.ben.u}</div><div class="hex-name">${r.ben.n}</div></div>
      <div class="hex-card"><h4>äº’å¦</h4><div class="hex-sym">${r.hu.u}</div><div class="hex-name">${r.hu.n}</div></div>
      <div class="hex-card"><h4>è®Šå¦</h4><div class="hex-sym">${r.bian.u}</div><div class="hex-name">${r.bian.n}</div></div>
    </div>
    <p class="mt-md"><strong>é«”ç”¨ï¼š</strong><span class="tag tag-gold">${r.ty.r}</span> <span class="tag ${r.ty.f.includes('å‰')?'tag-green':'tag-red'}">${r.ty.f}</span> â€” ${r.ty.d}</p>
    <p class="mt-sm"><strong>å¦è¾­ï¼š</strong>${r.ben.j}</p>
    <p><strong>è§£è®€ï¼š</strong>${r.ben.m}</p>
    <p><strong>è®Šå¦ï¼š</strong>${r.bian.m}</p>`;
}

function renderTarot(){
  if(!S.tarot.drawn.length){document.getElementById('r-tarot').innerHTML='<p class="text-dim">æœªé€²è¡Œå¡”ç¾…æŠ½ç‰Œ</p>';return}
  document.getElementById('r-tarot').innerHTML=S.tarot.drawn.map((c,i)=>`
    <div style="display:flex;gap:var(--sp-sm);align-items:flex-start;padding:var(--sp-sm) 0;border-bottom:1px solid var(--c-border)">
      <span class="tag tag-gold" style="flex:0 0 auto">${i+1}</span>
      <div><strong class="text-gold">${c.pos}</strong>ï¼š${c.n} <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'æ­£':'é€†'}</span>
      <p class="text-sm text-dim">${c.isUp?c.up:c.rv}</p></div>
    </div>`).join('');
}

/* =============================================================
   ANALYSIS ENGINE â€” ç¶œåˆè©•åˆ†
   ============================================================= */
function _runAnalysisV1_unused(){
  renderBazi(); renderMeihua(); renderTarot();

  const b=S.bazi; if(!b)return;
  const type=S.form.type;
  const question=S.form.question;

  // â€” å…«å­—è©•åˆ† (0-100) â€”
  let baziScore=50;
  // èº«å¼·+æœ‰è²¡å®˜ = é«˜åˆ†ï¼›èº«å¼±+æœ‰å°æ¯” = ä¸­åˆ†
  if(b.strong){
    if(b.ep[KE[b.dmEl]]>15)baziScore+=15; // æœ‰è²¡
    if(b.ep[BE_KE[b.dmEl]]>10)baziScore+=10; // æœ‰å®˜
  }else{
    if(b.ep[BE_SHENG[b.dmEl]]>15)baziScore+=15; // æœ‰å°
    if(b.ep[b.dmEl]>15)baziScore+=10;
  }
  // ç•¶å‰å¤§é‹åŠ åˆ†
  const curDy=b.dayun.find(d=>d.isCurrent);
  if(curDy){
    if(curDy.level.includes('å‰'))baziScore+=10;
    if(curDy.level.includes('å‡¶'))baziScore-=10;
  }
  // ç¥ç…
  if(b.shensha.includes('å¤©ä¹™è²´äºº'))baziScore+=5;
  if(b.shensha.includes('æ–‡æ˜Œ'))baziScore+=3;
  baziScore=Math.max(10,Math.min(90,baziScore));

  // â€” æ¢…èŠ±è©•åˆ† â€”
  let mhScore=50;
  if(S.meihua){
    const f=S.meihua.ty.f;
    if(f==='å¤§å‰')mhScore=80;
    else if(f==='å‰')mhScore=70;
    else if(f==='å°å‰')mhScore=60;
    else if(f==='å°å‡¶')mhScore=35;
    else if(f==='å‡¶')mhScore=20;
  }

  // â€” å¡”ç¾…è©•åˆ† â€”
  let tarotScore=50;
  if(S.tarot.drawn.length){
    let pos=0,neg=0;
    S.tarot.drawn.forEach(c=>{
      // æ­£ä½çš„æ­£é¢ç‰Œ +1ï¼Œé€†ä½çš„è² é¢ç‰Œ -1
      const goodCards=[0,1,3,6,8,10,14,17,19,21];
      const badCards=[13,15,16,18];
      if(c.isUp&&goodCards.includes(c.id))pos++;
      if(!c.isUp&&badCards.includes(c.id))neg++;
      if(c.isUp&&!badCards.includes(c.id))pos+=0.5;
      if(!c.isUp)neg+=0.3;
    });
    tarotScore=Math.round(50+pos*5-neg*5);
    tarotScore=Math.max(10,Math.min(90,tarotScore));
  }

  // â€” ç¶œåˆ â€”
  const weights={bazi:0.4,meihua:S.meihua?0.3:0,tarot:S.tarot.drawn.length?0.3:0};
  const totalW=weights.bazi+weights.meihua+weights.tarot;
  const finalProb=Math.round((baziScore*weights.bazi+mhScore*weights.meihua+tarotScore*weights.tarot)/totalW);

  // Verdict
  let vlabel,vnote;
  if(finalProb>=70){vlabel='åå‘å¯è¡Œ âœ…';vnote='å¤šç¶­åº¦æŒ‡æ¨™åä¸€è‡´ï¼Œé©åˆæ¨é€²ï¼Œä½†ä»éœ€æŒ‰å»ºè­°æ§é¢¨éšªã€‚'}
  else if(finalProb>=45){vlabel='ä¸­æ€§åå¯è¡Œ âš–ï¸';vnote='æœ‰åˆ©èˆ‡é˜»åŠ›ä¸¦å­˜ï¼›ç…§å»ºè­°èª¿æ•´åšæ³•ï¼Œå‹ç‡æœƒä¸Šå‡ã€‚'}
  else if(finalProb>=25){vlabel='åä¿å®ˆ âš ï¸';vnote='é˜»åŠ›è¨Šè™Ÿè¼ƒå¤šï¼Œå»ºè­°å…ˆé™ä½æˆæœ¬/è©¦æ°´æº«ï¼Œå†è«‡æ”¾å¤§ã€‚'}
  else{vlabel='ä¸å»ºè­°ç¡¬æ¨ â›”';vnote='ç›®å‰è±¡å¾µåé€†é¢¨ï¼›è‹¥è¦åšï¼Œå‹™å¿…è¨­åœæèˆ‡æ›¿ä»£æ–¹æ¡ˆã€‚'}

  document.getElementById('r-vlabel').textContent=vlabel;
  document.getElementById('r-vprob').textContent=finalProb+'%';
  document.getElementById('r-vnote').textContent=vnote;
  document.getElementById('r-pfill').style.width=finalProb+'%';
  document.getElementById('r-question').innerHTML=`<strong>å•é¡Œï¼š</strong>${question}<br><span class="tag tag-gold">${getTypeLabel(type)}</span>`;

  // Direct answer
  const answer=generateAnswer(type,finalProb,b,S.meihua,S.tarot);
  document.getElementById('r-answer').innerHTML=answer.text;
  document.getElementById('r-factors').innerHTML=answer.factors?`<h4 class="text-gold serif mt-md mb-sm">å½±éŸ¿å› å­</h4><ul class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.factors.map(f=>'<li style="margin:.3rem 0">'+f+'</li>').join('')}</ul>`:'';
  document.getElementById('r-suggest').innerHTML=answer.suggestions?`<h4 class="text-gold serif mt-md mb-sm">è¡Œå‹•å»ºè­°</h4><ol class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.suggestions.map(s=>'<li style="margin:.3rem 0">'+s+'</li>').join('')}</ol>`:'';

  // Probability breakdown
  document.getElementById('r-pbreak').innerHTML=`
    <p>å…«å­—å‘½ç†ï¼š${baziScore}% (æ¬Šé‡${Math.round(weights.bazi/totalW*100)}%)</p>
    ${S.meihua?`<p>æ¢…èŠ±æ˜“æ•¸ï¼š${mhScore}% (æ¬Šé‡${Math.round(weights.meihua/totalW*100)}%)</p>`:''}
    ${S.tarot.drawn.length?`<p>å¡”ç¾…ç‰Œé™£ï¼š${tarotScore}% (æ¬Šé‡${Math.round(weights.tarot/totalW*100)}%)</p>`:''}`;

  // Crystal recommendation
  renderCrystal(b);

  // Conclusion
  document.getElementById('r-conclusion').innerHTML=generateConclusion(type,finalProb,b,S.meihua,S.tarot);
}

function getTypeLabel(t){return{love:'æ„›æƒ…',career:'äº‹æ¥­',wealth:'è²¡é‹',health:'å¥åº·',general:'ç¶œåˆé‹å‹¢',relationship:'äººéš›',family:'å®¶åº­',other:'å…¶ä»–'}[t]||t}

function generateAnswer(type,prob,bazi,mh,tarot){
  const dm=bazi.dm,el=bazi.dmEl,strong=bazi.strong;
  const curDy=bazi.dayun.find(d=>d.isCurrent);
  const dyInfo=curDy?`ç•¶å‰å¤§é‹${curDy.gz}ï¼ˆ${curDy.level}ï¼‰`:'';
  const mhInfo=mh?`æ¢…èŠ±é«”ç”¨${mh.ty.r}ï¼ˆ${mh.ty.f}ï¼‰`:'';

  const factors=[];
  factors.push(`æ—¥ä¸»${dm}ï¼ˆ${el}ï¼‰ï¼Œèº«${strong?'å¼·':'å¼±'}ï¼Œå–œç”¨${bazi.fav.join('ã€')}`);
  if(dyInfo)factors.push(dyInfo);
  if(mhInfo)factors.push(mhInfo);
  if(bazi.shensha.length)factors.push('ç¥ç…ï¼š'+bazi.shensha.join('ã€'));
  if(tarot.drawn.length){
    const key=tarot.drawn[0];
    factors.push(`æ ¸å¿ƒç‰Œï¼š${key.n}ï¼ˆ${key.isUp?'æ­£ä½':'é€†ä½'}ï¼‰`);
  }

  const suggestions=[];
  if(strong){
    suggestions.push(`èº«å¼·å®œæ´©ç§€ï¼šå¤šç™¼æ®${SHENG[el]}è¡Œèƒ½é‡ï¼ˆé£Ÿå‚·ç”Ÿè²¡è·¯ç·šï¼‰`);
    suggestions.push(`ç©¿æˆ´${bazi.fav[0]}è¡Œé¡è‰²/é£¾å“ï¼Œå¼•å°å¤šé¤˜èƒ½é‡`);
  }else{
    suggestions.push(`èº«å¼±å®œæ‰¶åŠ©ï¼šåŠ å¼·${el}èˆ‡${BE_SHENG[el]}è¡Œèƒ½é‡`);
    suggestions.push(`ä½©æˆ´${bazi.fav[0]}è¡Œæ°´æ™¶æˆ–é£¾å“å¢å¼·è‡ªèº«èƒ½é‡`);
  }
  if(type==='love')suggestions.push('æ¡ƒèŠ±æ–¹ä½åœ¨æ­£'+(bazi.shensha.includes('æ¡ƒèŠ±')?'æ¡ƒèŠ±å·²å‹•ï¼Œç•™æ„èº«é‚Šäºº':'æ±/å—æ–¹ï¼Œå¯å¤šå¾€è©²æ–¹å‘ç¤¾äº¤'));
  if(type==='career')suggestions.push('äº‹æ¥­å®œå¾€'+(strong?'é£Ÿå‚·ç”Ÿè²¡æ–¹å‘ç™¼å±•ï¼Œé©åˆå‰µæ¥­æˆ–è‡ªç”±æ¥­':'å°æ˜Ÿæ–¹å‘ç™¼å±•ï¼Œå®œè€ƒå–è­‰ç…§æˆ–ä¾é™„å¤§æ©Ÿæ§‹'));
  if(type==='wealth')suggestions.push('è²¡é‹'+(bazi.ep[KE[el]]>15?'å‘½ä¸­è²¡æ˜Ÿæ—ºï¼Œåè²¡é‹ä½³':'å‘½ä¸­è²¡æ˜Ÿå¼±ï¼Œå®œç©©å¥æŠ•è³‡'));

  let text;
  if(prob>=65) text=`<p>ç¶œåˆå¤šç¶­åº¦åˆ†æï¼Œä½ æ‰€å•ä¹‹äº‹<strong class="text-success">è¶¨å‹¢åå‘æœ‰åˆ©</strong>ã€‚${dyInfo?dyInfo+'ç‚ºä½ æä¾›åŠ©åŠ›ã€‚':''}${mhInfo?mhInfo+'äº¦æ”¯æŒæ­£é¢ç™¼å±•ã€‚':''}</p><p class="mt-sm">å»ºè­°æŠŠæ¡ç•¶ä¸‹æ™‚æ©Ÿï¼Œç©æ¥µè¡Œå‹•ï¼Œä½†ä»éœ€æ³¨æ„æ§åˆ¶é¢¨éšªã€‚</p>`;
  else if(prob>=40) text=`<p>ç¶œåˆåˆ†æé¡¯ç¤ºï¼Œä½ æ‰€å•ä¹‹äº‹<strong class="text-warn">åˆ©å¼ŠåƒåŠ</strong>ã€‚${dyInfo?dyInfo+'ï¼Œ':''} æœ‰ç™¼å±•ç©ºé–“ä½†ä¹Ÿå­˜åœ¨é˜»åŠ›ã€‚</p><p class="mt-sm">å»ºè­°å¾ªåºæ¼¸é€²ï¼Œå…ˆå°ç¯„åœå˜—è©¦ï¼Œè§€å¯Ÿåé¥‹å¾Œå†æ“´å¤§ã€‚</p>`;
  else text=`<p>å¤šç¶­åº¦åˆ†æé¡¯ç¤ºï¼Œç›®å‰<strong class="text-danger">æ™‚æ©Ÿå°šæœªæˆç†Ÿ</strong>ã€‚${dyInfo?dyInfo+'ï¼Œ':''}é˜»åŠ›è¼ƒå¤§ã€‚</p><p class="mt-sm">å»ºè­°æš«ç·©è¡Œå‹•ï¼Œå…ˆåšå¥½æº–å‚™åŠŸå¤«ï¼Œç­‰å¾…æ›´ä½³æ™‚æ©Ÿã€‚</p>`;

  return{text,factors,suggestions};
}

function renderCrystal(b){
  const CRYSTALS={
    é‡‘:[{n:'ç™½æ°´æ™¶',icon:'ğŸ’',d:'æ·¨åŒ–èƒ½é‡ï¼Œå¢å¼·æ€ç¶­æ¸…æ™°åº¦'},{n:'é»ƒéµç¤¦',icon:'âœ¨',d:'å¢å¼·è²¡é‹ï¼Œæå‡è‡ªä¿¡'}],
    æœ¨:[{n:'ç¶ å¹½éˆ',icon:'ğŸ’š',d:'æ‹›æ­£è²¡ï¼Œäº‹æ¥­ç©©æ­¥ä¸Šå‡'},{n:'æ±é™µç‰',icon:'ğŸŒ¿',d:'èˆ’ç·©å£“åŠ›ï¼Œå¸¶ä¾†å¥½é‹'}],
    æ°´:[{n:'æµ·è—å¯¶',icon:'ğŸ’™',d:'å¢å¼·æºé€šåŠ›ï¼Œå¹³éœæƒ…ç·’'},{n:'è—ç´‹ç‘ªç‘™',icon:'ğŸ”µ',d:'ç©©å®šæƒ…ç·’ï¼Œå¢å¼·è¡¨é”'}],
    ç«:[{n:'ç´…ç‘ªç‘™',icon:'â¤ï¸',d:'æ¿€ç™¼ç†±æƒ…ï¼Œå¢å¼·è¡Œå‹•åŠ›'},{n:'çŸ³æ¦´çŸ³',icon:'ğŸ”´',d:'æå‡æ´»åŠ›ï¼Œå¢å¼·æ„å¿—'}],
    åœŸ:[{n:'é»ƒæ°´æ™¶',icon:'ğŸ’›',d:'æ‹›åè²¡ï¼Œæå‡è‡ªä¿¡'},{n:'è™çœ¼çŸ³',icon:'ğŸŸ¤',d:'å¢å¼·æ±ºæ–·åŠ›ï¼Œæ‹›è²¡è¾Ÿé‚ª'}]
  };
  const need=b.fav[0];
  const recs=CRYSTALS[need]||CRYSTALS['åœŸ'];
  document.getElementById('r-crystal').innerHTML=`
    <p class="mb-md">æ ¹æ“šå‘½ç›¤åˆ†æï¼Œå»ºè­°è£œå¼· <span class="tag tag-gold">${need}è¡Œ</span> èƒ½é‡ï¼š</p>
    <div class="crystal-grid">${recs.map(c=>`
      <div class="crystal-card">
        <div class="crystal-icon">${c.icon}</div>
        <div class="crystal-name">${c.n}</div>
        <p class="text-sm text-dim">${c.d}</p>
      </div>`).join('')}</div>
    <p class="text-xs text-muted mt-md"><i class="fas fa-info-circle"></i> æœ¬å»ºè­°åƒ…ä¾›èƒ½é‡æ ¡æº–åƒè€ƒï¼Œä¸å…·é†«ç™‚æˆ–å‘½é‹ä¿è­‰æ•ˆåŠ›ã€‚</p>`;
}

function generateConclusion(type,prob,bazi,mh,tarot){
  const el=bazi.dmEl,strong=bazi.strong;
  const curDy=bazi.dayun.find(d=>d.isCurrent);
  let html=`<p>ã€Œ${bazi.dm}${bazi.pillars.day.zhi}ã€æ—¥ä¸»ï¼Œäº”è¡Œå±¬${el}ï¼Œèº«${strong?'å¼·':'å¼±'}ã€‚`;
  if(curDy)html+=`ç•¶å‰è¡Œ${curDy.gz}å¤§é‹ï¼ˆ${curDy.level}ï¼‰ï¼Œ${curDy.level.includes('å‰')?'é‹å‹¢åŠ©åŠ›æ˜é¡¯':'éœ€è¬¹æ…æ‡‰å°æŒ‘æˆ°'}ã€‚`;
  html+=`</p>`;
  if(mh)html+=`<p class="mt-sm">æ¢…èŠ±æ˜“æ•¸å¾—${mh.ben.n}ï¼Œé«”ç”¨${mh.ty.r}ï¼Œ${mh.ty.d}</p>`;
  if(tarot.drawn.length){
    const first=tarot.drawn[0],last=tarot.drawn[9];
    html+=`<p class="mt-sm">å¡”ç¾…æ ¸å¿ƒç‰Œã€Œ${first.n}ã€${first.isUp?'æ­£ä½':'é€†ä½'}ï¼Œæœ€çµ‚ç‰Œã€Œ${last?last.n:''}ã€${last?(last.isUp?'æ­£ä½':'é€†ä½'):''}ï¼Œ`;
    html+=prob>=50?'æ•´é«”ç‰Œé¢åå‘ç©æ¥µã€‚':'æ•´é«”ç‰Œé¢æç¤ºéœ€è¦æ›´å¤šæº–å‚™ã€‚';
    html+=`</p>`;
  }
  html+=`<div class="divider"></div>`;
  html+=`<p class="serif text-gold">ç¶œåˆå»ºè­°ï¼š${prob>=60?'æŠŠæ¡æ©Ÿæœƒï¼Œç©æ¥µè¡Œå‹•ï¼Œé †å‹¢è€Œç‚ºã€‚':prob>=40?'ç©©ä¸­æ±‚é€²ï¼Œå¾ªåºæ¼¸é€²ï¼Œæ³¨æ„ç¯€å¥ã€‚':'éŸœå…‰é¤Šæ™¦ï¼Œå„²å‚™èƒ½é‡ï¼Œéœå¾…èŠ±é–‹ã€‚'}</p>`;
  return html;
}
/* =============================================================
   ç´«å¾®æ–—æ•¸ ZIWEI DOUSHU â€” æ ¸å¿ƒé‚è¼¯ï¼ˆè‡ªå¯«ï¼Œä¸ä¾è³´ iztroï¼‰
   ============================================================= */
const ZW_PALACES=['å‘½å®®','å…„å¼Ÿ','å¤«å¦»','å­å¥³','è²¡å¸›','ç–¾å„','é·ç§»','äº¤å‹','å®˜ç¥¿','ç”°å®…','ç¦å¾·','çˆ¶æ¯'];

// 14 ä¸»æ˜Ÿ
const ZW_MAJOR=[
  {id:0,name:'ç´«å¾®',el:'åœŸ',yin:true,bright:['å»Ÿ','æ—º','å¾—åœ°','åˆ©','å¹³','ä¸å¾—','è½é™·'],nature:'å¸æ˜Ÿï¼Œå°Šè²´ï¼Œé ˜å°åŠ›'},
  {id:1,name:'å¤©æ©Ÿ',el:'æœ¨',yin:true,nature:'æ™ºæ…§ï¼Œç­–åŠƒï¼Œå–„è®Š'},
  {id:2,name:'å¤ªé™½',el:'ç«',yin:false,nature:'å…‰æ˜æ­£å¤§ï¼Œè²´äººï¼Œç”·æ€§'},
  {id:3,name:'æ­¦æ›²',el:'é‡‘',yin:false,nature:'è²¡æ˜Ÿï¼Œå‰›æ¯…ï¼Œæœæ–·'},
  {id:4,name:'å¤©åŒ',el:'æ°´',yin:true,nature:'ç¦æ˜Ÿï¼Œå®‰é€¸ï¼Œæº«å’Œ'},
  {id:5,name:'å»‰è²',el:'ç«',yin:false,nature:'å›šæ˜Ÿï¼Œæ¡ƒèŠ±ï¼Œè¤‡é›œ'},
  {id:6,name:'å¤©åºœ',el:'åœŸ',yin:true,nature:'è²¡åº«ï¼Œç©©é‡ï¼Œä¿å®ˆ'},
  {id:7,name:'å¤ªé™°',el:'æ°´',yin:true,nature:'è²¡æ˜Ÿï¼Œå¥³æ€§ï¼Œç´°è†©'},
  {id:8,name:'è²ªç‹¼',el:'æœ¨',yin:false,nature:'æ¡ƒèŠ±ï¼Œæ‰è—ï¼Œæ…¾æœ›'},
  {id:9,name:'å·¨é–€',el:'æ°´',yin:true,nature:'å£èˆŒï¼Œæš—æ˜Ÿï¼Œæ˜¯é'},
  {id:10,name:'å¤©ç›¸',el:'æ°´',yin:true,nature:'å°æ˜Ÿï¼Œè¼”ä½ï¼Œè¡£é£Ÿ'},
  {id:11,name:'å¤©æ¢',el:'åœŸ',yin:true,nature:'è”­æ˜Ÿï¼Œæ¸…é«˜ï¼ŒåŒ–è§£'},
  {id:12,name:'ä¸ƒæ®º',el:'é‡‘',yin:false,nature:'å°‡æ˜Ÿï¼Œè¡å‹ï¼Œè®Šå‹•'},
  {id:13,name:'ç ´è»',el:'æ°´',yin:false,nature:'è€—æ˜Ÿï¼Œé–‹å‰µï¼Œç ´å£'}
];

// 6 å‰æ˜Ÿ
const ZW_LUCKY=['æ–‡æ˜Œ','æ–‡æ›²','å·¦è¼”','å³å¼¼','å¤©é­','å¤©é‰'];
// 4 ç…æ˜Ÿ
const ZW_SHA=['æ“ç¾Š','é™€ç¾…','ç«æ˜Ÿ','éˆ´æ˜Ÿ'];
// 4 åŒ–
const ZW_HUA=['åŒ–ç¥¿','åŒ–æ¬Š','åŒ–ç§‘','åŒ–å¿Œ'];

// å››åŒ–è¡¨ (ä¾å¹´å¹²)
const SIHUA_TABLE={
  ç”²:{ç¥¿:'å»‰è²',æ¬Š:'ç ´è»',ç§‘:'æ­¦æ›²',å¿Œ:'å¤ªé™½'},
  ä¹™:{ç¥¿:'å¤©æ©Ÿ',æ¬Š:'å¤©æ¢',ç§‘:'ç´«å¾®',å¿Œ:'å¤ªé™°'},
  ä¸™:{ç¥¿:'å¤©åŒ',æ¬Š:'å¤©æ©Ÿ',ç§‘:'æ–‡æ˜Œ',å¿Œ:'å»‰è²'},
  ä¸:{ç¥¿:'å¤ªé™°',æ¬Š:'å¤©åŒ',ç§‘:'å¤©æ©Ÿ',å¿Œ:'å·¨é–€'},
  æˆŠ:{ç¥¿:'è²ªç‹¼',æ¬Š:'å¤ªé™°',ç§‘:'å³å¼¼',å¿Œ:'å¤©æ©Ÿ'},
  å·±:{ç¥¿:'æ­¦æ›²',æ¬Š:'è²ªç‹¼',ç§‘:'å¤©æ¢',å¿Œ:'æ–‡æ›²'},
  åºš:{ç¥¿:'å¤ªé™½',æ¬Š:'æ­¦æ›²',ç§‘:'å¤ªé™°',å¿Œ:'å¤©åŒ'},
  è¾›:{ç¥¿:'å·¨é–€',æ¬Š:'å¤ªé™½',ç§‘:'æ–‡æ›²',å¿Œ:'æ–‡æ˜Œ'},
  å£¬:{ç¥¿:'å¤©æ¢',æ¬Š:'ç´«å¾®',ç§‘:'å·¦è¼”',å¿Œ:'æ­¦æ›²'},
  ç™¸:{ç¥¿:'ç ´è»',æ¬Š:'å·¨é–€',ç§‘:'å¤ªé™°',å¿Œ:'è²ªç‹¼'}
};

// ç´«å¾®æ˜Ÿå®‰æ˜Ÿæ³•ï¼ˆç°¡åŒ–ç‰ˆï¼šä¾è¾²æ›†æ—¥æ±ºå®šç´«å¾®æ‰€åœ¨å®®ä½ï¼‰
function getZiweiPalaceIdx(lunarDay){
  // çœŸå¯¦è¨ˆç®—éœ€è¦äº”è¡Œå±€ï¼Œé€™è£¡ç”¨ç°¡åŒ–æ˜ å°„
  // ç´«å¾®æ˜Ÿä½ç½® = (è¾²æ›†æ—¥æ•¸ - 1) % 12
  return (lunarDay - 1) % 12;
}

// å¤©åºœæ˜Ÿä½ç½®ï¼ˆèˆ‡ç´«å¾®å°ç¨±ï¼‰
function getTianfuIdx(ziweiIdx){
  return (12 - ziweiIdx + 2) % 12; // ç°¡åŒ–å°ç¨±
}

// è¾²æ›†è½‰æ›ï¼ˆç°¡åŒ–ï¼šç”¨åœ°æ”¯æ¨ç®—è¿‘ä¼¼è¾²æ›†æœˆæ—¥ï¼‰
function approxLunar(y,m,d){
  // ç°¡åŒ–ï¼šå– solar æ—¥æ¸›å»è¿‘ä¼¼å€¼
  const lunarMonth = ((m + 10) % 12) + 1; // ç²—ç•¥
  const lunarDay = ((d + 28) % 30) + 1;
  return {month: lunarMonth, day: lunarDay};
}

function computeZiwei(year,month,day,hour,gender){
  const lunar = approxLunar(year,month,day);
  const yGan = TG[((year-4)%10+10)%10];
  const yZhi = DZ[((year-4)%12+12)%12];

  // å‘½å®®åœ°æ”¯ï¼šä»¥æœˆã€æ™‚æ¨ç®—
  // å‘½å®® = (å¯… + æœˆæ•¸ - 1 - æ™‚è¾°) mod 12
  const shi = Math.floor(((hour+1)%24)/2);
  const mingIdx = ((2 + lunar.month - 1 - shi) % 12 + 12) % 12;
  const shenIdx = (mingIdx + 6) % 12; // èº«å®®

  // äº”è¡Œå±€ (ç°¡åŒ–ï¼šä¾å‘½å®®å¤©å¹²åœ°æ”¯çµ„åˆ)
  const mingGanIdx = ((((year-4)%10+10)%10 % 5) * 2 + mingIdx) % 10;
  const mingGan = TG[mingGanIdx];
  const wuxingJu = getWuxingJu(mingGan, DZ[mingIdx]);

  // å®‰ç´«å¾®æ˜Ÿ
  const ziweiIdx = getZiweiPalaceByJu(wuxingJu, lunar.day);
  const tianfuIdx = (12 - ziweiIdx + 4) % 12;

  // å»ºç«‹12å®®
  const palaces = [];
  for(let i=0;i<12;i++){
    const pIdx = (mingIdx + i) % 12;
    palaces.push({
      name: ZW_PALACES[i],
      branch: DZ[pIdx],
      stars: [],
      isMing: i===0,
      isShen: pIdx === shenIdx
    });
  }

  // å®‰14ä¸»æ˜Ÿï¼ˆç°¡åŒ–æ’åˆ—ï¼‰
  const ziweiOrder = [0,1,null,2,3,4,5]; // ç´«å¾®ç³»
  const tianfuOrder = [6,7,8,9,10,11,12,13]; // å¤©åºœç³»

  // ç´«å¾®ç³»å®‰æ˜Ÿ
  const zwStarMap = [
    {star:0, offset:0},  // ç´«å¾®
    {star:1, offset:-1}, // å¤©æ©Ÿ
    {star:2, offset:-3}, // å¤ªé™½
    {star:3, offset:-4}, // æ­¦æ›²
    {star:4, offset:-5}, // å¤©åŒ
    {star:5, offset:1}   // å»‰è²ï¼ˆåœ¨ç´«å¾®å¾Œä¸€ä½ï¼‰
  ];
  zwStarMap.forEach(({star,offset})=>{
    const pos = ((ziweiIdx + offset) % 12 + 12) % 12;
    const palaceIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === pos);
    if(palaceIdx>=0) palaces[palaceIdx].stars.push({...ZW_MAJOR[star], type:'major'});
  });

  // å¤©åºœç³»å®‰æ˜Ÿ
  const tfStarMap = [
    {star:6, offset:0},   // å¤©åºœ
    {star:7, offset:1},   // å¤ªé™°
    {star:8, offset:2},   // è²ªç‹¼
    {star:9, offset:3},   // å·¨é–€
    {star:10, offset:4},  // å¤©ç›¸
    {star:11, offset:5},  // å¤©æ¢
    {star:12, offset:6},  // ä¸ƒæ®º
    {star:13, offset:10}  // ç ´è»
  ];
  tfStarMap.forEach(({star,offset})=>{
    const pos = ((tianfuIdx + offset) % 12 + 12) % 12;
    const palaceIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === pos);
    if(palaceIdx>=0) palaces[palaceIdx].stars.push({...ZW_MAJOR[star], type:'major'});
  });

  // å®‰å‰æ˜Ÿï¼ˆç°¡åŒ–ï¼‰
  const wcIdx = ((year-4)%12+12)%12;
  addStarToPalace(palaces,'æ–‡æ˜Œ','minor',(10-shi+12)%12);
  addStarToPalace(palaces,'æ–‡æ›²','minor',(shi+4)%12);
  addStarToPalace(palaces,'å·¦è¼”','minor',(lunar.month+3)%12);
  addStarToPalace(palaces,'å³å¼¼','minor',(11-lunar.month+12)%12);

  // å®‰ç…æ˜Ÿï¼ˆç°¡åŒ–ï¼‰
  const yZhiIdx = DZ.indexOf(yZhi);
  addStarToPalace(palaces,'æ“ç¾Š','sha',(yZhiIdx+1)%12);
  addStarToPalace(palaces,'é™€ç¾…','sha',(yZhiIdx-1+12)%12);
  addStarToPalace(palaces,'ç«æ˜Ÿ','sha',(yZhiIdx+2)%12);
  addStarToPalace(palaces,'éˆ´æ˜Ÿ','sha',(yZhiIdx+10)%12);

  // å››åŒ–
  const sihua = SIHUA_TABLE[yGan] || SIHUA_TABLE['ç”²'];
  const huaMap = [];
  [{type:'ç¥¿',label:'åŒ–ç¥¿'},{type:'æ¬Š',label:'åŒ–æ¬Š'},{type:'ç§‘',label:'åŒ–ç§‘'},{type:'å¿Œ',label:'åŒ–å¿Œ'}].forEach(h=>{
    const starName = sihua[h.type];
    palaces.forEach(p=>{
      const found = p.stars.find(s=>s.name===starName);
      if(found){
        found.hua = h.label;
        huaMap.push({star:starName, hua:h.label, palace:p.name});
      }
    });
  });

  return {palaces, mingIdx, shenIdx, yGan, yZhi, wuxingJu, sihua: huaMap, lunar};
}

function addStarToPalace(palaces, name, type, zhiIdx){
  const pIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === zhiIdx);
  if(pIdx>=0) palaces[pIdx].stars.push({name, type});
}

function getWuxingJu(gan, zhi){
  // ç´éŸ³äº”è¡Œå±€ï¼ˆç°¡åŒ–ï¼‰
  const juMap = {
    'ç”²å­':2,'ç”²ä¸‘':2,'ä¹™ä¸‘':2,'ä¹™å­':2,'ä¸™å¯…':3,'ä¸™å¯':3,'ä¸å¯':3,'ä¸å¯…':3,
    'æˆŠè¾°':5,'æˆŠå·³':5,'å·±å·³':5,'å·±è¾°':5,'åºšåˆ':4,'åºšæœª':4,'è¾›æœª':4,'è¾›åˆ':4,
    'å£¬ç”³':6,'å£¬é…‰':6,'ç™¸é…‰':6,'ç™¸ç”³':6
  };
  return juMap[gan+zhi] || (((gan.charCodeAt(0)+zhi.charCodeAt(0))%5)+2);
}

function getZiweiPalaceByJu(ju, lunarDay){
  // ç´«å¾®å®‰æ˜Ÿï¼šå±€æ•¸é™¤æ—¥æ•¸çš„é¤˜æ•¸æ±ºå®šä½ç½®
  const base = Math.ceil(lunarDay / ju);
  const remainder = lunarDay % ju;
  let idx;
  if(remainder === 0) idx = base - 1;
  else idx = base + (ju - remainder > remainder ? 0 : 1);
  return ((idx + 1) % 12 + 12) % 12;
}

function renderZiwei(){
  const zw = S.ziwei;
  if(!zw){document.getElementById('d-ziwei-info').innerHTML='<p class="text-dim">è«‹å…ˆå¡«å¯«å‡ºç”Ÿè³‡æ–™</p>';return}

  // Info
  document.getElementById('d-ziwei-info').innerHTML=`
    <p>å‘½å®®ï¼š${DZ[zw.mingIdx]}å®® ï½œ èº«å®®ï¼š${DZ[zw.shenIdx]}å®® ï½œ å¹´å¹²ï¼š${zw.yGan} ï½œ äº”è¡Œå±€ï¼š${zw.wuxingJu}å±€</p>`;

  // 12å®®æ ¼ï¼ˆ4x4, ä¸­é–“2x2ç©ºï¼‰
  // æ’åˆ—é †åº: è¾°å·³åˆæœª / å¯[ç©º][ç©º]ç”³ / å¯…[ç©º][ç©º]é…‰ / ä¸‘å­äº¥æˆŒ
  const order = [
    [3,4,5,6],   // è¾°å·³åˆæœª
    [2,-1,-1,7],  // å¯ center center ç”³
    [1,-1,-1,8],  // å¯… center center é…‰
    [0,11,10,9]   // ä¸‘å­äº¥æˆŒ
  ];

  let html = '<div class="zw-grid">';
  for(let row=0;row<4;row++){
    for(let col=0;col<4;col++){
      const idx = order[row][col];
      if(idx===-1){
        if(row===1&&col===1){
          // Center cell spans 2x2
          html+=`<div class="zw-cell zw-center" style="grid-column:2/4;grid-row:2/4">
            <div class="serif text-gold" style="font-size:1.1rem;margin-bottom:var(--sp-sm)">ç´«å¾®æ–—æ•¸</div>
            <p class="text-dim text-xs">å‘½å®®ï¼š${DZ[zw.mingIdx]}</p>
            <p class="text-dim text-xs">å¹´å¹²ï¼š${zw.yGan}${zw.yZhi}</p>
          </div>`;
        }
        continue;
      }
      const palace = zw.palaces.find(p => DZ.indexOf(p.branch) === idx);
      if(!palace){html+=`<div class="zw-cell"><span class="zw-palace">${DZ[idx]}</span></div>`;continue}

      const isMing = palace.isMing;
      html+=`<div class="zw-cell${isMing?' active-palace':''}">
        <div class="zw-palace">${palace.name}${isMing?' â­':''}</div>
        <div class="zw-branch">${palace.branch}</div>
        <div class="zw-stars">`;
      palace.stars.forEach(s=>{
        const cls = s.type==='major'?'major':s.type==='sha'?'text-danger':'minor';
        html+=`<span class="zw-star ${cls}">${s.name}</span>`;
        if(s.hua)html+=`<span class="zw-hua">${s.hua}</span>`;
      });
      html+=`</div></div>`;
    }
  }
  html+='</div>';
  document.getElementById('d-ziwei-grid').innerHTML=html;

  // å››åŒ–
  document.getElementById('d-ziwei-sihua').innerHTML = zw.sihua.length?
    zw.sihua.map(h=>`<p><span class="tag ${h.hua.includes('ç¥¿')?'tag-green':h.hua.includes('å¿Œ')?'tag-red':'tag-gold'}">${h.hua}</span> ${h.star} â†’ ${h.palace}</p>`).join('')
    :'<p class="text-dim">å››åŒ–è³‡è¨Šè¨ˆç®—ä¸­</p>';

  // è§£è®€
  const mingPalace = zw.palaces[0];
  const mingStars = mingPalace.stars.filter(s=>s.type==='major');
  let reading = '';
  if(mingStars.length){
    reading+=`<p><strong>å‘½å®®ä¸»æ˜Ÿï¼š</strong>${mingStars.map(s=>s.name).join('ã€')}</p>`;
    mingStars.forEach(s=>{
      const info = ZW_MAJOR.find(m=>m.name===s.name);
      if(info)reading+=`<p class="text-dim">â†’ ${info.name}ï¼š${info.nature}</p>`;
    });
  }else{
    reading+=`<p>å‘½å®®ç„¡ä¸»æ˜Ÿï¼Œå€Ÿå°å®®ï¼ˆé·ç§»å®®ï¼‰æ˜Ÿæ›œåˆ¤æ–·ã€‚æ€§æ ¼è¼ƒç‚ºè¢«å‹•ï¼Œéœ€ä¸»å‹•å‡ºæ“Šã€‚</p>`;
  }
  // è²¡å¸›å®®
  const caiPalace = zw.palaces[4];
  const caiStars = caiPalace.stars.filter(s=>s.type==='major');
  if(caiStars.length)reading+=`<p class="mt-sm"><strong>è²¡å¸›å®®ï¼š</strong>${caiStars.map(s=>s.name).join('ã€')} â€” ${caiStars.some(s=>['æ­¦æ›²','å¤©åºœ','å¤ªé™°'].includes(s.name))?'è²¡é‹åŸºç¤ä½³':'è²¡é‹éœ€é åŠªåŠ›ç©ç´¯'}</p>`;

  // å®˜ç¥¿å®®
  const guanPalace = zw.palaces[8];
  const guanStars = guanPalace.stars.filter(s=>s.type==='major');
  if(guanStars.length)reading+=`<p class="mt-sm"><strong>å®˜ç¥¿å®®ï¼š</strong>${guanStars.map(s=>s.name).join('ã€')} â€” ${guanStars.some(s=>['ç´«å¾®','å¤©åºœ','å¤ªé™½'].includes(s.name))?'äº‹æ¥­æ ¼å±€å¤§ï¼Œé©åˆç®¡ç†è·':'é©åˆå°ˆæ¥­æŠ€è¡“æˆ–è‡ªç”±æ¥­'}</p>`;

  // ç…æ˜Ÿæé†’
  const shaStars = [];
  zw.palaces.forEach(p=>p.stars.filter(s=>s.type==='sha').forEach(s=>shaStars.push(s.name+'('+p.name+')')));
  if(shaStars.length)reading+=`<p class="mt-sm text-warn"><strong>ç…æ˜Ÿï¼š</strong>${shaStars.join('ã€')} â€” æ³¨æ„ç›¸é—œå®®ä½çš„æŒ‘æˆ°</p>`;

  document.getElementById('d-ziwei-reading').innerHTML=reading||'<p class="text-dim">è§£è®€ç”Ÿæˆä¸­â€¦</p>';
}
/* =============================================================
   å§“åå­¸ NAMEOLOGYï¼ˆä¸‰æ‰äº”æ ¼ï¼‰
   ============================================================= */
const STROKE_OVERRIDE={
  // å¸¸è¦‹å­—çš„åº·ç†™ç­†ç•«æ•¸ï¼ˆéƒ¨åˆ†ï¼‰
  'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10,
  'å¤§':3,'å°':3,'ä¸­':4,'ä¸Š':3,'ä¸‹':3,'äºº':2,'å¤©':4,'åœ°':6,'æ°´':4,'ç«':4,
  'æœ¨':4,'é‡‘':8,'åœŸ':3,'æ—¥':4,'æœˆ':4,'å¹´':6,'æ˜':8,'å…‰':6,'è¯':14,'åœ‹':11,
  'å®¶':10,'åº­':10,'å¿ƒ':4,'æ€':9,'æ„›':13,'ç¾':9,'ç‰':5,'é¾':16,'é³³':14,
  'æ—':8,'é™³':16,'ç‹':4,'æ':7,'å¼µ':11,'åŠ‰':15,'é»ƒ':12,'å³':7,'è¶™':14,
  'æ¥Š':13,'å‘¨':8,'å¾':10,'å­«':10,'é¦¬':10,'æœ±':6,'èƒ¡':11,'éƒ­':15,'ä½•':7,
  'é«˜':10,'ç¾…':20,'é„­':19,'è”¡':17,'è¬':17,'è•­':18,'è¨±':11,'æ›¾':12,'å½­':12,
  'å‘‚':7,'è˜‡':22,'ç›§':16,'è”£':17,'æ²ˆ':8,'éŸ“':17,'å”':10,'é¦®':12,'æ½˜':16,
  'å¿—':7,'å‰':11,'å¼·':12,'å»º':9,'æ–‡':4,'æ­¦':8,'å¾·':15,'ä»':4,'ç¾©':13,
  'ç¦®':18,'ä¿¡':9,'æ™º':12,'å‹‡':9,'å¿ ':8,'å­':7,'ä¿Š':9,'å‚‘':12,'å®':7,
  'é›…':12,'éœ':16,'æ…§':15,'æ•':11,'å©·':12,'ç§€':7,'èŠ³':10,'éº—':19,'è‹±':11,
  'æ˜¥':9,'å¤':10,'ç§‹':9,'å†¬':5,'æ±':8,'è¥¿':6,'å—':9,'åŒ—':5,'æˆ':7,'åŠŸ':5,
  'å®‰':6,'å¹³':5,'ç¦':14,'å£½':14,'å–œ':12,'æ¨‚':15,'å’Œ':8,'é †':12,'å‰':6,
  'ç¥¥':11,'ç‘':14,'é”':16,'æ˜Œ':8,'ç››':12,'æ¦®':14,'å¯Œ':12,'è²´':12,'åº·':11
};

function kangxiStroke(ch){
  if(STROKE_OVERRIDE[ch])return STROKE_OVERRIDE[ch];
  // éƒ¨é¦–ä¿®æ­£ï¼ˆå¸¸è¦‹å·®ç•°ï¼‰
  const code=ch.charCodeAt(0);
  // ç²—ç•¥ä¼°ç®—ï¼šCJKå­—çš„ Unicode ç¢¼ % 25 + 2
  return (code % 23) + 3;
}

function analyzeName(fullName){
  if(!fullName||fullName.length<2)return null;
  const chars=[...fullName];
  const strokes=chars.map(c=>kangxiStroke(c));

  let tianGe,renGe,diGe,waiGe,zongGe;

  if(chars.length===2){
    // å–®å§“å–®å
    tianGe=strokes[0]+1;
    renGe=strokes[0]+strokes[1];
    diGe=strokes[1]+1;
    zongGe=strokes[0]+strokes[1];
    waiGe=2;
  }else if(chars.length===3){
    // å–®å§“é›™åï¼ˆæœ€å¸¸è¦‹ï¼‰
    tianGe=strokes[0]+1;
    renGe=strokes[0]+strokes[1];
    diGe=strokes[1]+strokes[2];
    zongGe=strokes[0]+strokes[1]+strokes[2];
    waiGe=strokes[0]+strokes[2];
  }else if(chars.length===4){
    // è¤‡å§“é›™å
    tianGe=strokes[0]+strokes[1];
    renGe=strokes[1]+strokes[2];
    diGe=strokes[2]+strokes[3];
    zongGe=strokes.reduce((a,b)=>a+b,0);
    waiGe=strokes[0]+strokes[3];
  }else{
    return null;
  }

  // äº”è¡Œ
  function geWuxing(ge){
    const tail=ge%10;
    if(tail===1||tail===2)return'æœ¨';
    if(tail===3||tail===4)return'ç«';
    if(tail===5||tail===6)return'åœŸ';
    if(tail===7||tail===8)return'é‡‘';
    return'æ°´';
  }

  // å‰å‡¶ï¼ˆç°¡åŒ–81æ•¸ç†ï¼‰
  function geFortune(ge){
    const n=((ge-1)%80)+1;
    const ji=[1,3,5,6,7,8,11,13,15,16,17,18,21,23,24,25,29,31,32,33,35,37,39,41,45,47,48,52,57,61,63,65,67,68];
    const dj=[1,3,5,8,11,13,15,16,21,23,24,25,31,32,33,35,37,41,45,47,48,52,57,61,63,67,68];
    if(dj.includes(n))return{level:'å¤§å‰',cls:'text-success'};
    if(ji.includes(n))return{level:'å‰',cls:'text-success'};
    const xiong=[2,4,9,10,12,14,19,20,22,26,27,28,30,34,36,38,40,42,43,44,46,49,50,51,53,54,55,56,58,59,60,62,64,66,69,70,71,72,73,74,75,76,77,78,79,80];
    if(xiong.includes(n))return{level:'å‡¶',cls:'text-danger'};
    return{level:'å¹³',cls:'text-dim'};
  }

  // ä¸‰æ‰é…ç½®
  const sanCai=[geWuxing(tianGe),geWuxing(renGe),geWuxing(diGe)];
  // ä¸‰æ‰å‰å‡¶ï¼ˆç°¡åŒ–åˆ¤æ–·ï¼‰
  let sanCaiLevel='å‰';
  const [t,r,d]=sanCai;
  // ç›¸ç”Ÿç‚ºå‰
  if(SHENG[t]===r&&SHENG[r]===d)sanCaiLevel='å¤§å‰';
  else if(SHENG[t]===r||SHENG[r]===d)sanCaiLevel='å‰';
  else if(KE[t]===r||KE[r]===d)sanCaiLevel='å‡¶';
  else sanCaiLevel='å¹³';

  return{
    name:fullName, strokes,
    tianGe:{num:tianGe,el:geWuxing(tianGe),fortune:geFortune(tianGe)},
    renGe:{num:renGe,el:geWuxing(renGe),fortune:geFortune(renGe)},
    diGe:{num:diGe,el:geWuxing(diGe),fortune:geFortune(diGe)},
    waiGe:{num:waiGe,el:geWuxing(waiGe),fortune:geFortune(waiGe)},
    zongGe:{num:zongGe,el:geWuxing(zongGe),fortune:geFortune(zongGe)},
    sanCai,sanCaiLevel
  };
}

/* =============================================================
   æ°´æ™¶æ¨è–¦ç³»çµ± CRYSTAL â€” æ“´å……ç‰ˆ
   ============================================================= */
const CRYSTAL_DB={
  é‡‘:[
    {n:'ç™½æ°´æ™¶',icon:'ğŸ’',el:'é‡‘',d:'æ·¨åŒ–èƒ½é‡å ´ï¼Œå¢å¼·æ€ç¶­æ¸…æ™°åº¦ï¼Œè¬èƒ½èª¿å’ŒçŸ³ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œæˆ–æ”¾æ›¸æ¡Œ/è¾¦å…¬æ¡Œã€‚',taboo:'é¿å…ç¢°æ’ï¼Œå®šæœŸæ·¨åŒ–ã€‚'},
    {n:'é»ƒéµç¤¦',icon:'âœ¨',el:'é‡‘',d:'å¢å¼·è²¡é‹ï¼Œæå‡è‡ªä¿¡èˆ‡è¡Œå‹•åŠ›ã€‚',wear:'æ”¾åœ¨éŒ¢åŒ…æˆ–è¾¦å…¬æ¡Œå·¦ä¸Šè§’ã€‚',taboo:'æ€•æ°´ï¼Œé¿å…æ¥è§¸æ¶²é«”ã€‚'},
    {n:'ç™½å¹½éˆ',icon:'ğŸ¤',el:'é‡‘',d:'æ·¨åŒ–ç£å ´ï¼Œæå‡éˆæ€§ç›´è¦ºã€‚',wear:'å†¥æƒ³æ™‚æ‰‹æŒæˆ–ä½©æˆ´ã€‚',taboo:'é¿å…é™½å…‰ç›´å°„ã€‚'},
    {n:'éˆ¦æ™¶',icon:'âš¡',el:'é‡‘',d:'æ‹›æ­£è²¡åè²¡ï¼Œå¢å¼·é ˜å°åŠ›èˆ‡æ°£é­„ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œé¢è©¦/ç°½ç´„æ™‚ç‰¹åˆ¥æœ‰æ•ˆã€‚',taboo:'ç£å ´å¼·ï¼Œç¡çœ æ™‚å»ºè­°å–ä¸‹ã€‚'}
  ],
  æœ¨:[
    {n:'ç¶ å¹½éˆ',icon:'ğŸ’š',el:'æœ¨',d:'æ‹›æ­£è²¡ï¼Œäº‹æ¥­ç©©æ­¥ä¸Šå‡ï¼Œé©åˆä¸Šç­æ—ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œæ”¾è¾¦å…¬æ¡Œå¢äº‹æ¥­é‹ã€‚',taboo:'é¿å…é«˜æº«èˆ‡åŒ–å­¸å“ã€‚'},
    {n:'æ±é™µç‰',icon:'ğŸŒ¿',el:'æœ¨',d:'èˆ’ç·©å£“åŠ›ï¼Œå¸¶ä¾†å¥½é‹èˆ‡æ¨‚è§€å¿ƒæ…‹ã€‚',wear:'éš¨èº«ä½©æˆ´æˆ–æ”¾æ•é ­ä¸‹åŠ©çœ ã€‚',taboo:'å®šæœŸç”¨æœˆå…‰æ·¨åŒ–ã€‚'},
    {n:'ç¿¡ç¿ ',icon:'ğŸŸ¢',el:'æœ¨',d:'è­·èº«è¾Ÿé‚ªï¼Œå¢å¼·å¥åº·èˆ‡äººç·£ã€‚',wear:'ä½©æˆ´åœ¨é è¿‘å¿ƒè‡Ÿè™•ã€‚',taboo:'é¿å…ç¢°æ’èˆ‡é«˜æº«ã€‚'},
    {n:'æ©„æ¬–çŸ³',icon:'ğŸŒ±',el:'æœ¨',d:'ç™‚ç™’å¿ƒè¼ªï¼Œå¸¶ä¾†æ­£èƒ½é‡èˆ‡å¥½é‹ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œå¯é…åˆå†¥æƒ³ã€‚',taboo:'è³ªåœ°è¼ƒè»Ÿï¼Œæ³¨æ„ä¿è­·ã€‚'}
  ],
  æ°´:[
    {n:'æµ·è—å¯¶',icon:'ğŸ’™',el:'æ°´',d:'å¢å¼·æºé€šåŠ›ï¼Œå¹³éœæƒ…ç·’ï¼Œé©åˆè«‡åˆ¤ã€‚',wear:'ä½©æˆ´åœ¨å–‰è¼ªé™„è¿‘ï¼ˆé …éŠï¼‰æ•ˆæœæœ€ä½³ã€‚',taboo:'é¿å…é•·æ™‚é–“æ—¥æ›¬ã€‚'},
    {n:'è—ç´‹ç‘ªç‘™',icon:'ğŸ”µ',el:'æ°´',d:'ç©©å®šæƒ…ç·’ï¼Œå¢å¼·èªè¨€è¡¨é”èƒ½åŠ›ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œæˆ–åšç‚ºé …éŠã€‚',taboo:'å®šæœŸæµæ°´æ·¨åŒ–ã€‚'},
    {n:'æœˆå…‰çŸ³',icon:'ğŸŒ™',el:'æ°´',d:'å¢å¼·ç›´è¦ºï¼ŒåŠ©æ„Ÿæƒ…é‹ï¼ŒæŸ”åŒ–å€‹æ€§ã€‚',wear:'æ»¿æœˆæ™‚ä½©æˆ´æ•ˆæœæ›´ä½³ã€‚',taboo:'ç¡¬åº¦ä¸é«˜ï¼Œé¿å…ç¢°æ’ã€‚'},
    {n:'æ‹‰é•·çŸ³',icon:'ğŸŒŠ',el:'æ°´',d:'æå‡æ´å¯ŸåŠ›ï¼Œä¿è­·èƒ½é‡å ´ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œå‡ºå…¥è¤‡é›œå ´æ‰€æ™‚æ•ˆæœå¥½ã€‚',taboo:'é¿å…è¶…è²æ³¢æ¸…æ´—ã€‚'}
  ],
  ç«:[
    {n:'ç´…ç‘ªç‘™',icon:'â¤ï¸',el:'ç«',d:'æ¿€ç™¼ç†±æƒ…ï¼Œå¢å¼·è¡Œå‹•åŠ›èˆ‡å‹‡æ°£ã€‚',wear:'å³æ‰‹ä½©æˆ´å¢å¼·è¡Œå‹•åŠ›ã€‚',taboo:'é¿å…é«˜æº«ç’°å¢ƒã€‚'},
    {n:'çŸ³æ¦´çŸ³',icon:'ğŸ”´',el:'ç«',d:'æå‡æ´»åŠ›ï¼Œå¢å¼·æ„å¿—åŠ›èˆ‡æ¡ƒèŠ±é‹ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œè²¼èº«æ•ˆæœå¥½ã€‚',taboo:'å®šæœŸç”¨æ°´æ™¶ç°‡æ·¨åŒ–ã€‚'},
    {n:'ç´…ç¢§ç’½',icon:'ğŸ’—',el:'ç«',d:'å¼·åŠ›æ‹›æ¡ƒèŠ±ï¼Œå¢å¼·äººéš›é­…åŠ›ã€‚',wear:'ä½©æˆ´åœ¨å¿ƒè¼ªé™„è¿‘ã€‚',taboo:'ç£å ´æ•æ„Ÿï¼Œé¿å…èˆ‡å…¶ä»–å¼·ç£å ´æ°´æ™¶æ··æˆ´ã€‚'},
    {n:'å¤ªé™½çŸ³',icon:'â˜€ï¸',el:'ç«',d:'å¸¶ä¾†æ­£èƒ½é‡ï¼Œå¢å¼·è‡ªä¿¡èˆ‡é ˜å°åŠ›ã€‚',wear:'æ—¥é–“ä½©æˆ´æ•ˆæœä½³ã€‚',taboo:'é¿å…é•·æ™‚é–“æ³¡æ°´ã€‚'}
  ],
  åœŸ:[
    {n:'é»ƒæ°´æ™¶',icon:'ğŸ’›',el:'åœŸ',d:'æ‹›åè²¡ï¼Œæå‡è‡ªä¿¡èˆ‡å€‹äººé­…åŠ›ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œæ”¾éŒ¢åŒ…ä¹Ÿå¯ã€‚',taboo:'é¿å…é™½å…‰é•·æ™‚é–“ç›´å°„ï¼Œæœƒè¤ªè‰²ã€‚'},
    {n:'è™çœ¼çŸ³',icon:'ğŸŸ¤',el:'åœŸ',d:'å¢å¼·æ±ºæ–·åŠ›ï¼Œæ‹›è²¡è¾Ÿé‚ªï¼Œç©©å®šå¿ƒæ€§ã€‚',wear:'å³æ‰‹ä½©æˆ´å¢å¼·æ°£å ´ã€‚',taboo:'å®šæœŸæ—¥å…‰æµ´æ·¨åŒ–ï¼ˆçŸ­æ™‚é–“ï¼‰ã€‚'},
    {n:'èŒ¶æ™¶',icon:'ğŸ«–',el:'åœŸ',d:'æ’é™¤è² èƒ½é‡ï¼Œå¢å¼·ç©©å®šæ„Ÿã€‚',wear:'ä½©æˆ´æˆ–æ”¾åœ¨å®¶ä¸­å®¢å»³ã€‚',taboo:'é¿å…åŒ–å­¸å“ã€‚'},
    {n:'ç‘ªç‘™',icon:'ğŸŸ ',el:'åœŸ',d:'ä¿è­·ã€ç©©å®šã€å¢å¼·è€åŠ›ã€‚',wear:'å¯éš¨èº«ä½©æˆ´ï¼Œé©åˆå„å ´åˆã€‚',taboo:'è³ªåœ°å …ç¡¬ä½†ä»éœ€å°å¿ƒç¢°æ’ã€‚'}
  ]
};

// å•é¡Œé¡å‹ â†’ ç‰¹æ®Šæ¨è–¦
const CRYSTAL_BY_TYPE={
  love:[{n:'ç²‰æ™¶',icon:'ğŸ’•',el:'åœŸ',d:'æ‹›æ¡ƒèŠ±é¦–é¸ï¼Œå¢å¼·æ„Ÿæƒ…é‹èˆ‡äººéš›é­…åŠ›ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œç¡å‰æ”¾æ•é ­ä¸‹ã€‚',taboo:'éœ€å®šæœŸæ·¨åŒ–ï¼Œå¸æ”¶è² èƒ½é‡å¾Œæœƒè®Šæš—ã€‚'},
        {n:'è‰è“æ™¶',icon:'ğŸ“',el:'ç«',d:'å¢å¼·ç•°æ€§ç·£ï¼Œå¸¶ä¾†ç”œèœœçš„æˆ€æ„›æ©Ÿæœƒã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œç´„æœƒæ™‚æ•ˆæœå€å¢ã€‚',taboo:'é¿å…ç¢°æ’ã€‚'}],
  career:[{n:'éˆ¦æ™¶',icon:'âš¡',el:'é‡‘',d:'äº‹æ¥­æ™‰å‡é¦–é¸ï¼Œå¢å¼·é ˜å°åŠ›èˆ‡æ±ºæ–·åŠ›ã€‚',wear:'é¢è©¦/é‡è¦æœƒè­°æ™‚ä½©æˆ´ã€‚',taboo:'ç£å ´å¼·ï¼Œç¡çœ æ™‚å–ä¸‹ã€‚'}],
  wealth:[{n:'é»ƒæ°´æ™¶',icon:'ğŸ’›',el:'åœŸ',d:'åè²¡é‹é¦–é¸ï¼Œæå‡æŠ•è³‡çœ¼å…‰ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ï¼Œæ”¾æ”¶éŠ€å°ä¹Ÿå¯ã€‚',taboo:'é¿å…æ—¥æ›¬ã€‚'},
          {n:'ç¶ å¹½éˆ',icon:'ğŸ’š',el:'æœ¨',d:'æ­£è²¡é‹é¦–é¸ï¼Œé©åˆç©©å¥ç†è²¡ã€‚',wear:'å·¦æ‰‹ä½©æˆ´ã€‚',taboo:'é¿å…é«˜æº«ã€‚'}],
  health:[{n:'ç´«æ°´æ™¶',icon:'ğŸ’œ',el:'ç«',d:'å®‰ç¥åŠ©çœ ï¼Œç©©å®šæƒ…ç·’ï¼Œä¿ƒé€²èº«å¿ƒå¹³è¡¡ã€‚',wear:'æ”¾æ•é ­ä¸‹åŠ©çœ ï¼Œæˆ–ä½©æˆ´åœ¨ç¬¬ä¸‰çœ¼è™•å†¥æƒ³ã€‚',taboo:'é¿å…æ—¥æ›¬æœƒè¤ªè‰²ã€‚'}]
};

function renderCrystalExpanded(bazi, type){
  const need = bazi.fav[0];
  const baseCrystals = CRYSTAL_DB[need] || CRYSTAL_DB['åœŸ'];
  const typeCrystals = CRYSTAL_BY_TYPE[type] || [];

  // å»é‡åˆä½µ
  const allCrystals = [...typeCrystals];
  baseCrystals.forEach(c=>{if(!allCrystals.find(a=>a.n===c.n))allCrystals.push(c)});
  const display = allCrystals.slice(0,4);

  document.getElementById('r-crystal').innerHTML=`
    <p class="mb-md">æ ¹æ“šå‘½ç›¤ï¼ˆå–œç”¨ <span class="tag tag-gold">${need}è¡Œ</span>ï¼‰èˆ‡å•é¡Œé¡å‹ï¼ˆ<span class="tag tag-blue">${getTypeLabel(type)}</span>ï¼‰ï¼Œæ¨è–¦ï¼š</p>
    <div class="crystal-grid">${display.map(c=>`
      <div class="crystal-card">
        <div class="crystal-icon">${c.icon}</div>
        <div class="crystal-name">${c.n}</div>
        <div class="text-xs mb-sm"><span class="el-tag el-${c.el}">${c.el}è¡Œ</span></div>
        <p class="text-sm text-dim">${c.d}</p>
        <p class="text-xs text-muted mt-sm"><i class="fas fa-hand-holding-heart"></i> ${c.wear}</p>
        <p class="text-xs text-warn mt-sm"><i class="fas fa-exclamation-triangle"></i> ${c.taboo}</p>
      </div>`).join('')}</div>
    <p class="text-xs text-muted mt-md"><i class="fas fa-info-circle"></i> æœ¬å»ºè­°åƒ…ä¾›èƒ½é‡æ ¡æº–åƒè€ƒï¼Œä¸å…·é†«ç™‚æˆ–å‘½é‹ä¿è­‰æ•ˆåŠ›ã€‚æ°´æ™¶æ•ˆæœå› äººè€Œç•°ï¼Œè«‹ä¾è‡ªèº«æ„Ÿå—èª¿æ•´ã€‚</p>`;
}

/* =============================================================
   FUSION ENGINE v2 â€” äº”ç¶­åº¦åŠ æ¬Šèåˆ
   ============================================================= */
function runAnalysisV2(){
  renderBazi(); renderMeihua(); renderTarot(); renderZiwei(); renderName();

  const b=S.bazi; if(!b)return;
  const type=S.form.type;
  const question=S.form.question;

  // â”€â”€ 1. å…«å­—è©•åˆ† (0-100) â”€â”€
  let baziScore=50;
  if(b.strong){
    if(b.ep[KE[b.dmEl]]>15)baziScore+=12;
    if(b.ep[BE_KE[b.dmEl]]>10)baziScore+=8;
  }else{
    if(b.ep[BE_SHENG[b.dmEl]]>15)baziScore+=12;
    if(b.ep[b.dmEl]>15)baziScore+=8;
  }
  const curDy=b.dayun.find(d=>d.isCurrent);
  if(curDy){
    if(curDy.level==='å¤§å‰')baziScore+=15;
    else if(curDy.level==='ä¸­å‰')baziScore+=10;
    else if(curDy.level.includes('å‡¶'))baziScore-=10;
  }
  if(b.shensha.includes('å¤©ä¹™è²´äºº'))baziScore+=5;
  if(b.shensha.includes('æ–‡æ˜Œ')&&(type==='career'))baziScore+=5;
  if(b.shensha.includes('æ¡ƒèŠ±')&&(type==='love'))baziScore+=8;
  if(b.shensha.includes('é©›é¦¬')&&(type==='career'))baziScore+=3;
  baziScore=Math.max(10,Math.min(95,baziScore));

  // â”€â”€ 2. æ¢…èŠ±è©•åˆ† â”€â”€
  let mhScore=50;
  if(S.meihua){
    const fMap={'å¤§å‰':82,'å‰':70,'å°å‰':60,'å¹³':50,'å°å‡¶':35,'å‡¶':20};
    mhScore=fMap[S.meihua.ty.f]||50;
  }

  // â”€â”€ 3. å¡”ç¾…è©•åˆ† â”€â”€
  let tarotScore=50;
  if(S.tarot.drawn.length>=10){
    let pos=0,neg=0;
    S.tarot.drawn.forEach(c=>{
      if(c.isUp)pos+=1;else neg+=0.8;
      // ç‰¹å®šç‰ŒåŠ æ¬Š
      if(c.id===19&&c.isUp)pos+=2; // å¤ªé™½æ­£ä½
      if(c.id===21&&c.isUp)pos+=2; // ä¸–ç•Œæ­£ä½
      if(c.id===10&&c.isUp)pos+=1.5; // å‘½é‹ä¹‹è¼ªæ­£ä½
      if(c.id===16&&c.isUp)neg+=2; // å¡”æ­£ä½
      if(c.id===13&&!c.isUp)neg+=1; // æ­»ç¥é€†ä½
      if(c.id===15&&c.isUp)neg+=1.5; // æƒ¡é­”æ­£ä½
    });
    tarotScore=Math.round(50+(pos-neg)*3);
    tarotScore=Math.max(10,Math.min(90,tarotScore));
  }

  // â”€â”€ 4. ç´«å¾®è©•åˆ† â”€â”€
  let ziweiScore=50;
  if(S.ziwei){
    const mingStars=S.ziwei.palaces[0].stars;
    // å‘½å®®æœ‰å‰æ˜ŸåŠ åˆ†
    const goodStars=['ç´«å¾®','å¤©åºœ','å¤©åŒ','å¤©æ¢','å¤©ç›¸','å¤ªé™½','å¤ªé™°','æ–‡æ˜Œ','æ–‡æ›²','å·¦è¼”','å³å¼¼'];
    const badStars=['æ“ç¾Š','é™€ç¾…','ç«æ˜Ÿ','éˆ´æ˜Ÿ','ä¸ƒæ®º','ç ´è»'];
    mingStars.forEach(s=>{
      if(goodStars.includes(s.name))ziweiScore+=5;
      if(badStars.includes(s.name))ziweiScore-=3;
      if(s.hua==='åŒ–ç¥¿')ziweiScore+=8;
      if(s.hua==='åŒ–æ¬Š')ziweiScore+=5;
      if(s.hua==='åŒ–å¿Œ')ziweiScore-=8;
    });
    // å•é¡Œå°æ‡‰å®®ä½
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7};
    const gongIdx=typeToGong[type];
    if(gongIdx!==undefined){
      const gongStars=S.ziwei.palaces[gongIdx].stars;
      gongStars.forEach(s=>{
        if(goodStars.includes(s.name))ziweiScore+=4;
        if(s.hua==='åŒ–ç¥¿')ziweiScore+=6;
        if(s.hua==='åŒ–å¿Œ')ziweiScore-=6;
      });
    }
    ziweiScore=Math.max(10,Math.min(90,ziweiScore));
  }

  // â”€â”€ 5. å§“åå­¸è©•åˆ† â”€â”€
  let nameScore=50;
  let nameResult=null;
  if(S.form.name&&S.form.name.length>=2){
    nameResult=analyzeName(S.form.name);
    if(nameResult){
      [nameResult.tianGe,nameResult.renGe,nameResult.diGe,nameResult.waiGe,nameResult.zongGe].forEach(g=>{
        if(g.fortune.level==='å¤§å‰')nameScore+=6;
        else if(g.fortune.level==='å‰')nameScore+=3;
        else if(g.fortune.level==='å‡¶')nameScore-=4;
      });
      if(nameResult.sanCaiLevel==='å¤§å‰')nameScore+=10;
      else if(nameResult.sanCaiLevel==='å‰')nameScore+=5;
      else if(nameResult.sanCaiLevel==='å‡¶')nameScore-=8;
      nameScore=Math.max(10,Math.min(90,nameScore));
    }
  }

  // â”€â”€ åŠ æ¬Šç¶œåˆ â”€â”€
  const w={bazi:0.30, meihua:S.meihua?0.20:0, tarot:S.tarot.drawn.length>=10?0.20:0, ziwei:S.ziwei?0.20:0, name:nameResult?0.10:0};
  const totalW=Object.values(w).reduce((a,b)=>a+b,0);
  const scores={bazi:baziScore,meihua:mhScore,tarot:tarotScore,ziwei:ziweiScore,name:nameScore};
  let finalProb=0;
  for(const k of Object.keys(w))finalProb+=scores[k]*(w[k]/totalW);
  finalProb=Math.round(finalProb);

  // â”€â”€ Verdict â”€â”€
  let vlabel,vnote;
  if(finalProb>=70){vlabel='åå‘å¯è¡Œ âœ…';vnote='å¤šç¶­åº¦æŒ‡æ¨™åä¸€è‡´ï¼Œé©åˆæ¨é€²ï¼Œä»éœ€æŒ‰å»ºè­°æ§é¢¨éšªã€‚'}
  else if(finalProb>=45){vlabel='ä¸­æ€§åå¯è¡Œ âš–ï¸';vnote='æœ‰åˆ©èˆ‡é˜»åŠ›ä¸¦å­˜ï¼›ç…§å»ºè­°èª¿æ•´åšæ³•ï¼Œå‹ç‡æœƒä¸Šå‡ã€‚'}
  else if(finalProb>=25){vlabel='åä¿å®ˆ âš ï¸';vnote='é˜»åŠ›è¨Šè™Ÿè¼ƒå¤šï¼Œå»ºè­°å…ˆé™ä½æˆæœ¬/è©¦æ°´æº«ã€‚'}
  else{vlabel='ä¸å»ºè­°ç¡¬æ¨ â›”';vnote='ç›®å‰è±¡å¾µåé€†é¢¨ï¼›è‹¥è¦åšï¼Œå‹™å¿…è¨­åœæã€‚'}

  document.getElementById('r-vlabel').textContent=vlabel;
  document.getElementById('r-vprob').textContent=finalProb+'%';
  document.getElementById('r-vnote').textContent=vnote;
  document.getElementById('r-pfill').style.width=finalProb+'%';
  document.getElementById('r-question').innerHTML=`<strong>å•é¡Œï¼š</strong>${question}<br><span class="tag tag-gold">${getTypeLabel(type)}</span>`;

  // â”€â”€ Answer â”€â”€
  const answer=generateAnswer(type,finalProb,b,S.meihua,S.tarot);
  document.getElementById('r-answer').innerHTML=answer.text;
  document.getElementById('r-factors').innerHTML=answer.factors?`<h4 class="text-gold serif mt-md mb-sm">å½±éŸ¿å› å­</h4><ul class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.factors.map(f=>'<li style="margin:.3rem 0">'+f+'</li>').join('')}</ul>`:'';
  document.getElementById('r-suggest').innerHTML=answer.suggestions?`<h4 class="text-gold serif mt-md mb-sm">è¡Œå‹•å»ºè­°</h4><ol class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.suggestions.map(s=>'<li style="margin:.3rem 0">'+s+'</li>').join('')}</ol>`:'';

  // â”€â”€ Breakdown â”€â”€
  const dimLabels={bazi:'å…«å­—å‘½ç†',meihua:'æ¢…èŠ±æ˜“æ•¸',tarot:'å¡”ç¾…ç‰Œé™£',ziwei:'ç´«å¾®æ–—æ•¸',name:'å§“åå­¸'};
  document.getElementById('r-pbreak').innerHTML=Object.keys(w).filter(k=>w[k]>0).map(k=>
    `<div class="el-row"><span class="el-lbl text-sm">${dimLabels[k]}</span><div class="el-track"><div class="el-fill" style="width:${scores[k]}%;background:var(--c-gold)"></div></div><span class="el-val">${scores[k]}%<span class="text-xs text-muted"> (${Math.round(w[k]/totalW*100)}%)</span></span></div>`
  ).join('');

  // â”€â”€ Crystal â”€â”€
  renderCrystalExpanded(b, type);

  // â”€â”€ Conclusion â”€â”€
  let concl=generateConclusion(type,finalProb,b,S.meihua,S.tarot);
  // åŠ å…¥ç´«å¾®
  if(S.ziwei){
    const mp=S.ziwei.palaces[0];
    const ms=mp.stars.filter(s=>s.type==='major').map(s=>s.name).join('ã€');
    if(ms)concl+=`<p class="mt-sm">ç´«å¾®å‘½å®®ä¸»æ˜Ÿï¼š${ms}ï¼Œ${ziweiScore>=60?'å‘½æ ¼åå‘æœ‰åˆ©':'éœ€æ³¨æ„ç›¸é—œå®®ä½æŒ‘æˆ°'}ã€‚</p>`;
  }
  // åŠ å…¥å§“åå­¸
  if(nameResult){
    concl+=`<p class="mt-sm">å§“åå­¸ï¼šä¸‰æ‰ ${nameResult.sanCai.join('â†’')}ï¼ˆ${nameResult.sanCaiLevel}ï¼‰ï¼Œäººæ ¼${nameResult.renGe.num}ï¼ˆ${nameResult.renGe.fortune.level}ï¼‰ã€‚</p>`;
  }
  document.getElementById('r-conclusion').innerHTML=concl;
}

// Override runAnalysis to use V2
function runAnalysis(){ runAnalysisV2(); }

function renderName(){
  const el=document.getElementById('d-name');
  if(!S.form.name||S.form.name.length<2){el.innerHTML='<p class="text-dim">æœªè¼¸å…¥å§“åï¼Œç„¡æ³•é€²è¡Œå§“åå­¸åˆ†æã€‚</p>';return}
  const r=analyzeName(S.form.name);
  if(!r){el.innerHTML='<p class="text-dim">å§“åæ ¼å¼ä¸æ”¯æ´ï¼ˆéœ€2-4å€‹å­—ï¼‰ã€‚</p>';return}

  const geData=[
    {label:'å¤©æ ¼',data:r.tianGe,desc:'å…ˆå¤©é‹ï¼Œå§“æ°æ±ºå®š'},
    {label:'äººæ ¼',data:r.renGe,desc:'ä¸»é‹ï¼Œå½±éŸ¿ä¸­å¹´'},
    {label:'åœ°æ ¼',data:r.diGe,desc:'å‰é‹ï¼Œå½±éŸ¿é’å¹´'},
    {label:'å¤–æ ¼',data:r.waiGe,desc:'å‰¯é‹ï¼Œäººéš›é—œä¿‚'},
    {label:'ç¸½æ ¼',data:r.zongGe,desc:'å¾Œé‹ï¼Œå½±éŸ¿æ™šå¹´'}
  ];

  el.innerHTML=`
    <p class="mb-md">å§“åï¼š<strong class="text-gold serif">${r.name}</strong> ï½œ ç­†ç•«ï¼š${r.strokes.join('ã€')}</p>
    <div class="bazi-grid" style="grid-template-columns:repeat(5,1fr);margin:var(--sp-md) 0">
      ${geData.map(g=>`<div class="bazi-cell header">${g.label}</div>`).join('')}
      ${geData.map(g=>`<div class="bazi-cell">
        <span class="gz">${g.data.num}</span>
        <span class="el-tag el-${g.data.el}">${g.data.el}</span>
        <div class="gz-sub ${g.data.fortune.cls}">${g.data.fortune.level}</div>
      </div>`).join('')}
      ${geData.map(g=>`<div class="bazi-cell"><div class="gz-sub">${g.desc}</div></div>`).join('')}
    </div>
    <div class="mt-md">
      <p><strong>ä¸‰æ‰é…ç½®ï¼š</strong>${r.sanCai.join(' â†’ ')} <span class="tag ${r.sanCaiLevel.includes('å‰')?'tag-green':r.sanCaiLevel==='å‡¶'?'tag-red':'tag-gold'}">${r.sanCaiLevel}</span></p>
      <p class="text-sm text-dim mt-sm">ä¸‰æ‰ä»£è¡¨å¤©æ ¼â†’äººæ ¼â†’åœ°æ ¼çš„äº”è¡Œæµé€šé—œä¿‚ï¼Œ${r.sanCaiLevel.includes('å‰')?'ç›¸ç”Ÿç›¸åŠ©ç‚ºä½³è±¡':'å­˜åœ¨ç›¸å‰‹ï¼Œéœ€æ³¨æ„å¥åº·èˆ‡äººéš›'}ã€‚</p>
    </div>`;
}
/* =============================================================
   ENHANCEMENT 1: æµå¹´è©³ç´°å±•é–‹ï¼ˆé»æ“Šå¤§é‹å±•é–‹10æµå¹´ï¼‰
   ============================================================= */
function renderDayunEnhanced(){
  const b=S.bazi; if(!b)return;
  let html='<div class="dayun-tl">';
  b.dayun.forEach((d,i)=>{
    const lvCls=d.level==='å¤§å‰'?'lv-dj':d.level==='ä¸­å‰'?'lv-zj':d.level==='å°å‰'?'lv-xj':d.level==='å¹³'?'lv-p':d.level==='å°å‡¶'?'lv-xk':d.level==='ä¸­å‡¶'?'lv-zk':'lv-dk';
    html+=`<div class="dy-item ${d.isCurrent?'current':''}" onclick="toggleLiuNian(${i})" title="é»æ“Šå±•é–‹æµå¹´">
      <span class="dy-gz">${d.gz}</span><span class="dy-age">${d.ageStart}-${d.ageEnd}æ­²</span>
      <span class="dy-lv ${lvCls}">${d.level}</span><div class="gz-sub">${d.god}</div></div>`;
  });
  html+='</div>';
  html+='<div id="liunian-detail" class="mt-md hidden"></div>';
  document.getElementById('d-dayun').innerHTML=html;
}

function toggleLiuNian(dyIdx){
  const el=document.getElementById('liunian-detail');
  const b=S.bazi; if(!b||!b.dayun[dyIdx])return;
  const dy=b.dayun[dyIdx];
  if(el.dataset.openIdx===String(dyIdx)&&!el.classList.contains('hidden')){
    el.classList.add('hidden');return;
  }
  el.dataset.openIdx=dyIdx;
  el.classList.remove('hidden');
  const curYear=new Date().getFullYear();
  let html=`<div class="card" style="padding:var(--sp-md);margin:0"><div class="card-title text-sm"><i class="fas fa-calendar"></i> ${dy.gz}å¤§é‹ï¼ˆ${dy.ageStart}-${dy.ageEnd}æ­²ï¼‰æµå¹´æ˜ç´°</div>`;
  html+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:4px">';
  dy.liuNian.forEach(ln=>{
    const isCur=ln.year===curYear;
    const cls=ln.level==='å‰'?'tag-green':ln.level==='å‡¶'?'tag-red':'tag-gold';
    html+=`<div style="padding:6px;border:1px solid ${isCur?'var(--c-gold)':'var(--c-border)'};border-radius:var(--r-sm);background:${isCur?'rgba(212,175,55,.08)':'var(--c-bg-card)'};font-size:.8rem;text-align:center">
      <strong>${ln.year}</strong><br>
      <span class="serif">${ln.gz}</span><br>
      <span class="el-tag el-${ln.el}">${ln.el}</span>
      <span class="tag ${cls}" style="font-size:.6rem">${ln.level}</span><br>
      <span class="text-xs text-muted">${ln.god}</span>
      ${isCur?'<br><span class="text-xs text-gold">â† ä»Šå¹´</span>':''}
    </div>`;
  });
  html+='</div></div>';
  el.innerHTML=html;
}

/* =============================================================
   ENHANCEMENT 2: æ¢…èŠ±å…­çˆ»çˆ»è¾­ï¼ˆç°¡åŒ–ç‰ˆï¼šæœ¬å¦å‹•çˆ»çˆ»è¾­ï¼‰
   ============================================================= */
const YAO_CI={
  'ä¹¾ç‚ºå¤©':['æ½›é¾å‹¿ç”¨','è¦‹é¾åœ¨ç”°ï¼Œåˆ©è¦‹å¤§äºº','å›å­çµ‚æ—¥ä¹¾ä¹¾ï¼Œå¤•æƒ•è‹¥å²ï¼Œç„¡å’','æˆ–èºåœ¨æ·µï¼Œç„¡å’','é£›é¾åœ¨å¤©ï¼Œåˆ©è¦‹å¤§äºº','äº¢é¾æœ‰æ‚”'],
  'å¤ç‚ºåœ°':['å±¥éœœï¼Œå …å†°è‡³','ç›´æ–¹å¤§ï¼Œä¸ç¿’ç„¡ä¸åˆ©','å«ç« å¯è²ï¼Œæˆ–å¾ç‹äº‹ï¼Œç„¡æˆæœ‰çµ‚','æ‹¬å›Šï¼Œç„¡å’ç„¡è­½','é»ƒè£³ï¼Œå…ƒå‰','é¾æˆ°äºé‡ï¼Œå…¶è¡€ç„é»ƒ'],
  'åœ°å¤©æ³°':['æ‹”èŒ…èŒ¹ï¼Œä»¥å…¶å½™ï¼Œå¾å‰','åŒ…è’ï¼Œç”¨é¦®æ²³ï¼Œä¸ééº','ç„¡å¹³ä¸é™‚ï¼Œç„¡å¾€ä¸å¾©ï¼Œè‰±è²ç„¡å’','ç¿©ç¿©ä¸å¯Œï¼Œä»¥å…¶é„°ï¼Œä¸æˆ’ä»¥å­š','å¸ä¹™æ­¸å¦¹ï¼Œä»¥ç¥‰å…ƒå‰','åŸå¾©äºéšï¼Œå‹¿ç”¨å¸«ï¼Œè‡ªé‚‘å‘Šå‘½'],
  'å¤©åœ°å¦':['æ‹”èŒ…èŒ¹ï¼Œä»¥å…¶å½™ï¼Œè²å‰äº¨','åŒ…æ‰¿ï¼Œå°äººå‰ï¼Œå¤§äººå¦äº¨','åŒ…ç¾','æœ‰å‘½ç„¡å’ï¼Œç–‡é›¢ç¥‰','ä¼‘å¦ï¼Œå¤§äººå‰','å‚¾å¦ï¼Œå…ˆå¦å¾Œå–œ'],
};

function getYaoCi(guaName, yaoNum){
  const ci=YAO_CI[guaName];
  if(ci&&ci[yaoNum-1])return ci[yaoNum-1];
  return'ï¼ˆçˆ»è¾­è³‡æ–™åº«æ“´å……ä¸­ï¼‰';
}

/* =============================================================
   ENHANCEMENT 3: å¡”ç¾…å•é¡Œé¡å‹äº¤å‰è§£è®€
   ============================================================= */
const TAROT_TYPE_MEANING={
  love:{
    0:{up:'æ„›æƒ…ä¸­éœ€è¦å‹‡æ°£è¸å‡ºèˆ’é©åœˆï¼Œæ–°æˆ€æƒ…å³å°‡é–‹å§‹ã€‚',rv:'æ„Ÿæƒ…ä¸Šå¤ªééš¨æ„ï¼Œéœ€è¦èªçœŸçœ‹å¾…ã€‚'},
    6:{up:'çœŸæ„›é™è‡¨ï¼Œé‡è¦çš„æ„Ÿæƒ…æŠ‰æ“‡å°‡å¸¶ä¾†å¹¸ç¦ã€‚',rv:'æ„Ÿæƒ…åƒ¹å€¼è§€è¡çªï¼Œéœ€è¦æºé€šã€‚'},
    8:{up:'ç”¨è€å¿ƒå’Œæº«æŸ”ç¶“ç‡Ÿæ„Ÿæƒ…ï¼Œä»¥æŸ”å…‹å‰›ã€‚',rv:'åœ¨æ„Ÿæƒ…ä¸­ç¼ºä¹å®‰å…¨æ„Ÿã€‚'},
    19:{up:'æ„Ÿæƒ…æ˜æœ—åŒ–ï¼Œé›™æ–¹é—œä¿‚é€²å…¥ç”œèœœæœŸã€‚',rv:'æ„Ÿæƒ…ä¸­æœ‰çŸ­æš«çš„é™°éœ¾ï¼Œä½†çµ‚æœƒéå»ã€‚'}
  },
  career:{
    1:{up:'ä½ æ“æœ‰æˆåŠŸæ‰€éœ€çš„æ‰€æœ‰èƒ½åŠ›ï¼Œå¤§è†½ç™¼æ®ã€‚',rv:'è·å ´æŠ€èƒ½éœ€è¦ç²¾é€²ï¼Œé¿å…æµ®èª‡ã€‚'},
    4:{up:'äº‹æ¥­ä¸Šç²å¾—æ¬Šå¨åœ°ä½ï¼Œé©åˆç®¡ç†è·ã€‚',rv:'å·¥ä½œä¸­æ§åˆ¶æ¬²å¤ªå¼·ï¼Œè¦å­¸æœƒæˆæ¬Šã€‚'},
    7:{up:'äº‹æ¥­çªç ´ï¼Œé å …å®šæ„å¿—å…‹æœå›°é›£ã€‚',rv:'å·¥ä½œæ–¹å‘ä¸æ˜ï¼Œéœ€é‡æ–°å®šä½ã€‚'},
    10:{up:'äº‹æ¥­è¿ä¾†è½‰æŠ˜é»ï¼Œå¥½é‹é™è‡¨ã€‚',rv:'äº‹æ¥­é‡åˆ°ç“¶é ¸ï¼Œéœ€è€å¿ƒç­‰å¾…ã€‚'}
  },
  wealth:{
    3:{up:'è²¡é‹è±é¥’ï¼ŒæŠ•è³‡å›å ±è‰¯å¥½ã€‚',rv:'èŠ±è²»éåº¦ï¼Œéœ€è¦ç¯€åˆ¶ã€‚'},
    9:{up:'æ·±æ€ç†Ÿæ…®å¾Œåšè²¡å‹™æ±ºå®šï¼Œç©©å¥ç²åˆ©ã€‚',rv:'æŠ•è³‡åˆ¤æ–·åŠ›ä¸‹é™ï¼Œæš«ç·©å¤§é¡æ”¯å‡ºã€‚'},
    21:{up:'è²¡å‹™ç›®æ¨™é”æˆï¼Œåœ“æ»¿è±æ”¶ã€‚',rv:'æ”¶å…¥ä¸ç©©å®šï¼Œèª¿æ•´ç†è²¡ç­–ç•¥ã€‚'}
  }
};

function getTarotTypeMeaning(cardId, isUp, type){
  const tm=TAROT_TYPE_MEANING[type];
  if(tm&&tm[cardId]){
    return isUp?tm[cardId].up:tm[cardId].rv;
  }
  return null;
}

/* =============================================================
   ENHANCEMENT 4: ç´«å¾®äº®åº¦ï¼ˆå»Ÿæ—ºåˆ©å¹³é™·ï¼‰
   ============================================================= */
const ZW_BRIGHTNESS={
  // ç°¡åŒ–ï¼šç´«å¾®åœ¨å„åœ°æ”¯çš„å»Ÿæ—ºï¼ˆå­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥ï¼‰
  'ç´«å¾®':['å»Ÿ','æ—º','å¾—åœ°','å¹³','æ—º','å¾—åœ°','å»Ÿ','æ—º','å¾—åœ°','å¹³','å¾—åœ°','æ—º'],
  'å¤©æ©Ÿ':['å¹³','å»Ÿ','æ—º','å»Ÿ','å¾—åœ°','å¹³','é™·','å¾—åœ°','æ—º','å¾—åœ°','å¹³','å»Ÿ'],
  'å¤ªé™½':['é™·','é™·','å¹³','æ—º','å»Ÿ','å»Ÿ','å»Ÿ','æ—º','å¹³','é™·','é™·','é™·'],
  'æ­¦æ›²':['æ—º','å»Ÿ','å¾—åœ°','é™·','å¹³','æ—º','å¾—åœ°','å¾—åœ°','å»Ÿ','æ—º','å¾—åœ°','å¹³'],
  'å¤©åŒ':['æ—º','å¹³','é™·','å¹³','å¾—åœ°','å¾—åœ°','é™·','å¹³','å¾—åœ°','æ—º','å»Ÿ','æ—º'],
  'å»‰è²':['å¾—åœ°','å¹³','æ—º','é™·','å¾—åœ°','å¹³','å¾—åœ°','æ—º','å»Ÿ','å¾—åœ°','å¹³','æ—º'],
  'å¤©åºœ':['å»Ÿ','å¾—åœ°','æ—º','å¾—åœ°','å¹³','å»Ÿ','æ—º','å¾—åœ°','æ—º','å»Ÿ','å¾—åœ°','æ—º'],
  'å¤ªé™°':['å»Ÿ','å»Ÿ','æ—º','æ—º','å¾—åœ°','å¹³','é™·','é™·','é™·','å¹³','å¾—åœ°','æ—º'],
  'è²ªç‹¼':['æ—º','å¹³','å»Ÿ','æ—º','å¾—åœ°','å¾—åœ°','é™·','å¹³','å¾—åœ°','æ—º','å»Ÿ','æ—º'],
  'å·¨é–€':['æ—º','å»Ÿ','å¾—åœ°','å¹³','é™·','æ—º','å¾—åœ°','å¹³','å»Ÿ','æ—º','å¾—åœ°','å¹³'],
  'å¤©ç›¸':['å»Ÿ','å¾—åœ°','æ—º','æ—º','å¹³','å¾—åœ°','æ—º','å¾—åœ°','å»Ÿ','å¾—åœ°','æ—º','å¾—åœ°'],
  'å¤©æ¢':['å»Ÿ','æ—º','å¾—åœ°','å¹³','å¾—åœ°','æ—º','å»Ÿ','å¾—åœ°','æ—º','å¹³','å¾—åœ°','æ—º'],
  'ä¸ƒæ®º':['å»Ÿ','æ—º','å¹³','å¾—åœ°','æ—º','å¾—åœ°','å»Ÿ','å¾—åœ°','æ—º','å¹³','å¾—åœ°','æ—º'],
  'ç ´è»':['å¹³','æ—º','å»Ÿ','å¾—åœ°','æ—º','å¾—åœ°','å¹³','æ—º','å¾—åœ°','æ—º','å»Ÿ','å¾—åœ°']
};

function getStarBrightness(starName, zhiBranch){
  const idx=DZ.indexOf(zhiBranch);
  if(idx<0)return'';
  const arr=ZW_BRIGHTNESS[starName];
  if(!arr)return'';
  return arr[idx]||'';
}

/* =============================================================
   ENHANCEMENT 5: å¢å¼· renderZiwei åŠ å…¥äº®åº¦
   ============================================================= */
const _origRenderZiwei = renderZiwei;
renderZiwei = function(){
  _origRenderZiwei();
  // Post-process: add brightness tags
  if(!S.ziwei)return;
  S.ziwei.palaces.forEach(p=>{
    p.stars.forEach(s=>{
      if(s.type==='major'){
        s.brightness=getStarBrightness(s.name, p.branch);
      }
    });
  });
  // Re-render grid with brightness
  const zw=S.ziwei;
  const order=[[3,4,5,6],[2,-1,-1,7],[1,-1,-1,8],[0,11,10,9]];
  let html='<div class="zw-grid">';
  for(let row=0;row<4;row++){
    for(let col=0;col<4;col++){
      const idx=order[row][col];
      if(idx===-1){
        if(row===1&&col===1){
          html+=`<div class="zw-cell zw-center" style="grid-column:2/4;grid-row:2/4">
            <div class="serif text-gold" style="font-size:1.1rem;margin-bottom:var(--sp-sm)">ç´«å¾®æ–—æ•¸</div>
            <p class="text-dim text-xs">å‘½å®®ï¼š${DZ[zw.mingIdx]}</p>
            <p class="text-dim text-xs">${zw.yGan}${zw.yZhi}å¹´ ï½œ ${zw.wuxingJu}å±€</p></div>`;
        }
        continue;
      }
      const palace=zw.palaces.find(p=>DZ.indexOf(p.branch)===idx);
      if(!palace){html+=`<div class="zw-cell"><span class="zw-palace">${DZ[idx]}</span></div>`;continue}
      const isMing=palace.isMing;
      html+=`<div class="zw-cell${isMing?' active-palace':''}">
        <div class="zw-palace">${palace.name}${isMing?' â­':''}</div>
        <div class="zw-branch">${palace.branch}</div><div class="zw-stars">`;
      palace.stars.forEach(s=>{
        const cls=s.type==='major'?'major':s.type==='sha'?'text-danger':'minor';
        const bright=s.brightness?`<span class="text-xs text-muted">(${s.brightness})</span>`:'';
        html+=`<span class="zw-star ${cls}">${s.name}${bright}</span>`;
        if(s.hua)html+=`<span class="zw-hua">${s.hua}</span>`;
      });
      html+=`</div></div>`;
    }
  }
  html+='</div>';
  document.getElementById('d-ziwei-grid').innerHTML=html;
};

/* =============================================================
   ENHANCEMENT 6: å¢å¼· renderBazi ä½¿ç”¨æ–°å¤§é‹
   ============================================================= */
const _origRenderBazi = renderBazi;
renderBazi = function(){
  _origRenderBazi();
  renderDayunEnhanced();
};

/* =============================================================
   ENHANCEMENT 7: å¢å¼· renderTarot åŠ å…¥é¡å‹äº¤å‰è§£è®€
   ============================================================= */
const _origRenderTarot = renderTarot;
renderTarot = function(){
  if(!S.tarot.drawn.length){document.getElementById('r-tarot').innerHTML='<p class="text-dim">æœªé€²è¡Œå¡”ç¾…æŠ½ç‰Œ</p>';return}
  const type=S.form.type;
  document.getElementById('r-tarot').innerHTML=S.tarot.drawn.map((c,i)=>{
    const typeMeaning=getTarotTypeMeaning(c.id,c.isUp,type);
    return`<div style="display:flex;gap:var(--sp-sm);align-items:flex-start;padding:var(--sp-sm) 0;border-bottom:1px solid var(--c-border)">
      <span class="tag tag-gold" style="flex:0 0 auto">${i+1}</span>
      <div><strong class="text-gold">${c.pos}</strong>ï¼š${c.n} <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'æ­£':'é€†'}</span>
      <p class="text-sm text-dim">${c.isUp?c.up:c.rv}</p>
      ${typeMeaning?`<p class="text-sm mt-sm" style="color:var(--c-gold-light)"><i class="fas fa-star" style="font-size:.6rem"></i> ${getTypeLabel(type)}è§£è®€ï¼š${typeMeaning}</p>`:''}</div>
    </div>`;
  }).join('');
};

/* =============================================================
   ENHANCEMENT 8: å¢å¼·æ¢…èŠ±çµæœåŠ å…¥çˆ»è¾­
   ============================================================= */
const _origShowMH = showMH;
showMH = function(r){
  _origShowMH(r);
  // Append yao ci
  const yaoCi=getYaoCi(r.ben.n, r.dong);
  const detailEl=document.getElementById('mh-detail');
  if(detailEl){
    detailEl.innerHTML+=`<div class="divider"></div><p><strong>å‹•çˆ»çˆ»è¾­ï¼ˆç¬¬${r.dong}çˆ»ï¼‰ï¼š</strong><span class="serif text-gold">${yaoCi}</span></p>`;
  }
};

/* =============================================================
   ENHANCEMENT 9: åˆ—å° / åˆ†äº«
   ============================================================= */
function printResult(){
  window.print();
}

function shareResult(){
  const prob=document.getElementById('r-vprob').textContent;
  const label=document.getElementById('r-vlabel').textContent;
  const text=`éœæœˆä¹‹å…‰å åœçµæœï¼š${label} ${prob}\nå•é¡Œï¼š${S.form.question}\n\nï¼ˆæ›´å¤šè©³æƒ…è«‹ä½¿ç”¨éœæœˆä¹‹å…‰èƒ½é‡å åœå„€ï¼‰`;
  if(navigator.share){
    navigator.share({title:'éœæœˆä¹‹å…‰å åœçµæœ',text}).catch(()=>{});
  }else{
    navigator.clipboard.writeText(text).then(()=>alert('çµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼')).catch(()=>{});
  }
}
/* =============================================================
   CUSTOM ORDER MODAL + FLOATING BUTTONS
   ============================================================= */
function openCustomModal(){
  document.getElementById('custom-modal').style.display='flex';
  document.getElementById('custom-form').style.display='block';
  document.getElementById('cf-sent').classList.add('hidden');
  // Pre-fill from analysis if available
  if(S.form.name)document.getElementById('cf-name').value=S.form.name;
  if(S.form.bdate)document.getElementById('cf-bday').value=S.form.bdate;
  if(S.form.question)document.getElementById('cf-question').value=S.form.question;
  document.body.style.overflow='hidden';
}
function closeCustomModal(){
  document.getElementById('custom-modal').style.display='none';
  document.body.style.overflow='';
}
// Close on overlay click
document.addEventListener('click',function(e){
  if(e.target.id==='custom-modal')closeCustomModal();
});

function submitCustomForm(e){e.preventDefault()} // deprecated, kept for safety

function prepareCustomSubmit(){
  const name=document.getElementById('cf-name').value.trim();
  if(!name)return false;

  // Set subject with name
  document.getElementById('cf-subject-hidden').value='ã€å®¢è£½è©¢å•ã€‘'+name+' - èƒ½é‡æ‰‹éˆ';

  // Set _next to current page so user returns after submit
  document.getElementById('cf-next-url').value=window.location.href;

  // Build analysis summary
  let summary='';
  if(S.bazi){
    summary+='æ—¥ä¸»ï¼š'+S.bazi.dm+'ï¼ˆ'+S.bazi.dmEl+'ï¼‰| èº«'+(S.bazi.strong?'å¼·':'å¼±')+'\n';
    summary+='å–œç”¨ç¥ï¼š'+S.bazi.fav.join('ã€')+'\n';
    summary+='å¿Œç¥ï¼š'+S.bazi.unfav.join('ã€')+'\n';
    const curDy=S.bazi.dayun.find(d=>d.isCurrent);
    if(curDy)summary+='ç•¶å‰å¤§é‹ï¼š'+curDy.gz+'ï¼ˆ'+curDy.level+'ï¼‰\n';
    if(S.bazi.shensha.length)summary+='ç¥ç…ï¼š'+S.bazi.shensha.join('ã€')+'\n';
    if(S.meihua)summary+='æ¢…èŠ±ï¼š'+S.meihua.ben.n+'ï¼Œé«”ç”¨'+S.meihua.ty.r+'ï¼ˆ'+S.meihua.ty.f+'ï¼‰\n';
    if(S.tarot.drawn.length)summary+='å¡”ç¾…æ ¸å¿ƒç‰Œï¼š'+S.tarot.drawn[0].n+'ï¼ˆ'+(S.tarot.drawn[0].isUp?'æ­£ä½':'é€†ä½')+'ï¼‰\n';
    const prob=document.getElementById('r-vprob');
    if(prob&&prob.textContent!=='0%')summary+='ç¶œåˆæ©Ÿç‡ï¼š'+prob.textContent+'\n';
  }
  document.getElementById('cf-analysis-hidden').value=summary||'ï¼ˆä½¿ç”¨è€…æœªå®Œæˆå åœåˆ†æï¼‰';

  // Change button to loading
  const btn=document.getElementById('cf-submit-btn');
  btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> é€å‡ºä¸­...';
  btn.disabled=true;

  return true; // allow form submission to formsubmit.co
}

function copyCfContent(){} // no longer needed but kept for safety

function toggleFab(){
  document.getElementById('fab-menu').classList.toggle('hidden');
}

/* =============================================================
   PWA: Inline Manifest + Service Worker Registration
   ============================================================= */
(function(){
  // Inline manifest as blob
  const manifest={
    name:'éœæœˆä¹‹å…‰èƒ½é‡å åœå„€',
    short_name:'éœæœˆå åœ',
    description:'æ•´åˆå…«å­—ã€ç´«å¾®æ–—æ•¸ã€æ¢…èŠ±æ˜“æ•¸ã€å¡”ç¾…ç‰Œçš„å¤šç¶­åº¦å‘½ç†åˆ†æ',
    start_url:'./',
    display:'standalone',
    background_color:'#0d0404',
    theme_color:'#0d0404',
    orientation:'portrait-primary',
    lang:'zh-TW',
    icons:[{src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">â˜½</text></svg>',sizes:'any',type:'image/svg+xml'}]
  };
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const link=document.createElement('link');
  link.rel='manifest';
  link.href=URL.createObjectURL(blob);
  document.head.appendChild(link);
})();

/* =============================================================
   KEYBOARD: Escape closes modal
   ============================================================= */
document.addEventListener('keydown',function(e){
  if(e.key==='Escape'){
    closeCustomModal();
    const fabMenu=document.getElementById('fab-menu');
    if(fabMenu&&!fabMenu.classList.contains('hidden'))fabMenu.classList.add('hidden');
  }
});
</script></body></html>
