<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes,viewport-fit=cover">
<meta name="description" content="靜月之光能量占卜儀：整合八字、紫微斗數、梅花易數、塔羅牌的多維度命理分析系統">
<meta name="theme-color" content="#1a0a0a">
<title>靜月之光能量占卜儀 v3.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* ================================================================
   靜月之光 v3.0 — Complete Design System
   Aesthetic: Chinese Traditional Luxury (紅金傳統奢華)
   ================================================================ */
:root{
  --c-bg-deep:#0d0404;--c-bg:#1a0808;--c-bg-card:#1e0c0c;--c-bg-card-alt:#251010;
  --c-surface:rgba(255,255,255,0.04);--c-border:rgba(212,175,55,0.18);--c-border-hi:rgba(212,175,55,0.45);
  --c-gold:#d4af37;--c-gold-light:#e8c968;--c-gold-pale:#f5e6b8;
  --c-crimson:#8b0000;--c-crimson-hi:#b22222;
  --c-text:#f5e6d3;--c-text-dim:rgba(245,230,211,0.65);--c-text-muted:rgba(245,230,211,0.4);
  --c-success:#4ade80;--c-warn:#fbbf24;--c-danger:#f87171;--c-info:#60a5fa;
  --el-metal:#c0c0c0;--el-wood:#22c55e;--el-water:#3b82f6;--el-fire:#ef4444;--el-earth:#a78b5a;
  --f-display:'Noto Serif TC',serif;--f-body:'Noto Sans TC',sans-serif;
  --sp-xs:0.25rem;--sp-sm:0.5rem;--sp-md:1rem;--sp-lg:1.5rem;--sp-xl:2.5rem;
  --r-sm:8px;--r-md:14px;--r-lg:20px;--r-pill:999px;
  --sh-card:0 4px 24px rgba(0,0,0,0.4),0 0 0 1px var(--c-border);
  --t-fast:0.2s cubic-bezier(0.4,0,0.2,1);--t-smooth:0.4s cubic-bezier(0.4,0,0.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{
  font-family:var(--f-body);color:var(--c-text);
  background:var(--c-bg-deep);
  background-image:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(139,0,0,0.25) 0%,transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 100%,rgba(139,0,0,0.15) 0%,transparent 50%);
  background-attachment:fixed;min-height:100vh;line-height:1.6;
  -webkit-font-smoothing:antialiased;overflow-x:hidden;
}
a{color:var(--c-gold);text-decoration:none;transition:color var(--t-fast)}
a:hover{color:var(--c-gold-light)}
button,input,select,textarea{font-family:inherit;font-size:inherit;color:inherit}
::selection{background:rgba(212,175,55,0.3);color:#fff}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--c-bg)}
::-webkit-scrollbar-thumb{background:rgba(212,175,55,0.3);border-radius:3px}

/* — Layout — */
.app{max-width:960px;margin:0 auto;padding:0 var(--sp-md);padding-bottom:calc(env(safe-area-inset-bottom,0px) + 1rem)}

/* — Navigation — */
.nav{position:sticky;top:0;z-index:100;background:rgba(13,4,4,0.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--c-border);padding:0.75rem var(--sp-md)}
.nav-inner{max-width:960px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:var(--sp-md)}
.nav-brand{display:flex;align-items:center;gap:var(--sp-sm);font-family:var(--f-display);font-weight:700;font-size:1.1rem;color:var(--c-gold)}
.nav-brand i{font-size:1.3rem}
.nav-links{display:flex;gap:var(--sp-xs);flex-wrap:wrap}
.nav-link{padding:0.4rem 0.75rem;border-radius:var(--r-pill);font-size:0.8rem;font-weight:500;color:var(--c-text-dim);border:1px solid transparent;transition:all var(--t-fast);cursor:pointer;background:none;white-space:nowrap}
.nav-link:hover,.nav-link.active{color:var(--c-gold);border-color:var(--c-border-hi);background:rgba(212,175,55,0.08)}

/* — Step Sections — */
.step{display:none;animation:fadeIn .45s ease both}
.step.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
@keyframes slideInLeft{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}

.result-verdict{animation:scaleIn .6s ease .1s both}
.card{animation:fadeIn .5s ease both}
.card:nth-child(2){animation-delay:.1s}
.card:nth-child(3){animation-delay:.2s}
.card:nth-child(4){animation-delay:.3s}
.verdict-prob{
  background-size:200% 100%;
  animation:shimmer 3s ease-in-out infinite;
  background-image:linear-gradient(90deg,var(--c-gold),var(--c-gold-light),#fff,var(--c-gold-light),var(--c-gold));
  -webkit-background-clip:text;background-clip:text;
}
.hero-icon{animation:pulse 3s ease-in-out infinite}
.dy-item{animation:slideInLeft .3s ease both}
.dy-item:nth-child(2){animation-delay:.05s}
.dy-item:nth-child(3){animation-delay:.1s}
.dy-item:nth-child(4){animation-delay:.15s}
.dy-item:nth-child(5){animation-delay:.2s}

/* — Cards — */
.card{background:var(--c-bg-card);border:1px solid var(--c-border);border-radius:var(--r-lg);padding:var(--sp-lg);margin-bottom:var(--sp-lg);box-shadow:var(--sh-card);transition:border-color var(--t-fast)}
.card:hover{border-color:var(--c-border-hi)}
.card-title{font-family:var(--f-display);font-weight:700;font-size:1.15rem;color:var(--c-gold);margin-bottom:var(--sp-md);display:flex;align-items:center;gap:var(--sp-sm)}
.card-title i{font-size:1rem;opacity:.8}

/* — Buttons — */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:var(--sp-sm);padding:.75rem 1.25rem;border-radius:var(--r-md);font-weight:600;font-size:.95rem;cursor:pointer;border:1px solid var(--c-border-hi);transition:all var(--t-fast);white-space:nowrap}
.btn-primary{background:linear-gradient(135deg,var(--c-crimson),#6b0000);color:var(--c-gold-pale);border-color:var(--c-gold);box-shadow:0 2px 12px rgba(139,0,0,.4)}
.btn-lg{font-size:1.1rem;padding:.9rem 2rem;animation:ctaPulse 2.5s ease-in-out infinite}
@keyframes ctaPulse{0%,100%{box-shadow:0 2px 12px rgba(139,0,0,.4)}50%{box-shadow:0 4px 24px rgba(212,175,55,.5)}}
.btn-primary:hover{background:linear-gradient(135deg,var(--c-crimson-hi),var(--c-crimson));box-shadow:0 4px 20px rgba(139,0,0,.6);transform:translateY(-1px)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-outline{background:transparent;color:var(--c-text-dim);border-color:rgba(255,255,255,.15)}
.btn-outline:hover{color:var(--c-gold);border-color:var(--c-border-hi);background:rgba(212,175,55,.06)}
.btn-gold{background:linear-gradient(135deg,var(--c-gold),#b8941f);color:var(--c-bg-deep);border:none;font-weight:700}
.btn-gold:hover{box-shadow:0 4px 20px rgba(212,175,55,.4);transform:translateY(-1px)}
.btn-sm{padding:.5rem .85rem;font-size:.85rem}
.btn-tab-active{background:linear-gradient(135deg,var(--c-crimson),#6b0000)!important;color:var(--c-gold-pale)!important;border-color:var(--c-gold)!important}
.btn-lg{padding:1rem 2rem;font-size:1.05rem}
.btn-block{width:100%}

/* — Form — */
.form-group{margin-bottom:var(--sp-lg)}
.form-label{display:block;font-size:.9rem;font-weight:600;color:var(--c-text);margin-bottom:var(--sp-xs)}
.form-label .req{color:var(--c-danger);margin-left:2px}
.form-hint{font-size:.8rem;color:var(--c-text-muted);margin-top:var(--sp-xs)}
.form-input,.form-select,.form-textarea{width:100%;padding:.75rem 1rem;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:var(--r-sm);color:var(--c-text);font-size:1rem;transition:border-color var(--t-fast),box-shadow var(--t-fast)}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--c-gold);box-shadow:0 0 0 3px rgba(212,175,55,.15)}
.form-textarea{resize:vertical;min-height:80px}
.radio-pills{display:flex;gap:var(--sp-sm);flex-wrap:wrap}
.radio-pill{position:relative}
.radio-pill input{position:absolute;opacity:0;pointer-events:none}
.radio-pill span{display:inline-block;padding:.6rem 1.2rem;border:1px solid rgba(255,255,255,.12);border-radius:var(--r-pill);cursor:pointer;font-size:.9rem;transition:all var(--t-fast)}
.radio-pill input:checked+span{border-color:var(--c-gold);color:var(--c-gold);background:rgba(212,175,55,.12)}

/* — Stepper — */
.stepper{display:flex;align-items:center;justify-content:center;padding:var(--sp-md) 0;margin-bottom:var(--sp-md)}
.stepper-item{display:flex;align-items:center;gap:.4rem;font-size:.8rem;color:var(--c-text-muted);transition:color var(--t-fast)}
.stepper-item.active{color:var(--c-gold);font-weight:600}
.stepper-item.done{color:var(--c-success)}
.stepper-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.15);font-size:.75rem;font-weight:700;transition:all var(--t-fast)}
.stepper-item.active .stepper-dot{border-color:var(--c-gold);background:rgba(212,175,55,.15);color:var(--c-gold)}
.stepper-item.done .stepper-dot{border-color:var(--c-success);background:rgba(74,222,128,.15);color:var(--c-success)}
.stepper-line{width:30px;height:2px;background:rgba(255,255,255,.1);margin:0 .3rem}

/* — Hero — */
.hero{text-align:center;padding:var(--sp-xl) 0 var(--sp-lg)}
.hero-icon{font-size:2.5rem;color:var(--c-gold);margin-bottom:var(--sp-md);text-shadow:0 0 40px rgba(212,175,55,.4)}
.hero h1{font-family:var(--f-display);font-weight:900;font-size:clamp(1.5rem,5vw,2.2rem);color:var(--c-gold-light);margin-bottom:var(--sp-sm);letter-spacing:.05em}
.hero p{color:var(--c-text-dim);font-size:.95rem;max-width:500px;margin:0 auto}

/* — BaZi Grid — */
.bazi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;background:var(--c-border);border-radius:var(--r-md);overflow:hidden;margin:var(--sp-md) 0}
.bazi-cell{background:var(--c-bg-card);padding:var(--sp-sm) var(--sp-xs);text-align:center}
.bazi-cell.header{background:rgba(212,175,55,.08);font-size:.75rem;color:var(--c-text-dim);font-weight:600}
.bazi-cell .gz{font-family:var(--f-display);font-size:1.3rem;font-weight:700;display:block;margin-bottom:2px}
.bazi-cell .gz-sub{font-size:.7rem;color:var(--c-text-muted)}
.el-tag{display:inline-block;padding:1px 6px;border-radius:var(--r-pill);font-size:.65rem;font-weight:600;margin-top:2px}
.el-金{background:rgba(192,192,192,.15);color:var(--el-metal)}
.el-木{background:rgba(34,197,94,.15);color:var(--el-wood)}
.el-水{background:rgba(59,130,246,.15);color:var(--el-water)}
.el-火{background:rgba(239,68,68,.15);color:var(--el-fire)}
.el-土{background:rgba(167,139,90,.15);color:var(--el-earth)}

/* — Five Element Bar — */
.el-bar{margin:var(--sp-sm) 0}
.el-row{display:flex;align-items:center;gap:var(--sp-sm);margin-bottom:6px}
.el-lbl{width:28px;text-align:center;font-weight:700;font-size:.85rem}
.el-track{flex:1;height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden}
.el-fill{height:100%;border-radius:4px;transition:width .8s ease}
.el-val{width:36px;text-align:right;font-size:.8rem;color:var(--c-text-dim)}

/* — DaYun Timeline — */
.dayun-tl{display:flex;overflow-x:auto;gap:2px;padding:var(--sp-sm) 0;-webkit-overflow-scrolling:touch}
.dy-item{flex:0 0 auto;min-width:72px;padding:var(--sp-sm);text-align:center;border-radius:var(--r-sm);border:1px solid var(--c-border);background:var(--c-bg-card);cursor:pointer;transition:all var(--t-fast);font-size:.8rem}
.dy-item.current{border-color:var(--c-gold);background:rgba(212,175,55,.1)}
.dy-item .dy-gz{font-family:var(--f-display);font-weight:700;font-size:1rem;display:block}
.dy-item .dy-age{color:var(--c-text-muted);font-size:.7rem}
.dy-item .dy-lv{display:inline-block;padding:1px 6px;border-radius:var(--r-pill);font-size:.65rem;font-weight:600;margin-top:4px}
.lv-dj{background:rgba(74,222,128,.15);color:var(--c-success)}
.lv-zj{background:rgba(96,165,250,.15);color:var(--c-info)}
.lv-xj{background:rgba(212,175,55,.15);color:var(--c-gold)}
.lv-p{background:rgba(255,255,255,.08);color:var(--c-text-dim)}
.lv-xk{background:rgba(251,191,36,.15);color:var(--c-warn)}
.lv-zk{background:rgba(248,113,113,.15);color:var(--c-danger)}
.lv-dk{background:rgba(180,40,40,.2);color:#ff6b6b}

/* — Hexagram — */
.hex-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--sp-md);margin:var(--sp-md) 0}
.hex-card{text-align:center;padding:var(--sp-md);background:rgba(0,0,0,.2);border:1px solid var(--c-border);border-radius:var(--r-md)}
.hex-card h4{color:var(--c-text-dim);font-size:.8rem;margin-bottom:var(--sp-sm)}
.hex-sym{font-size:2.5rem;line-height:1;margin-bottom:var(--sp-xs)}
.hex-name{font-family:var(--f-display);font-weight:700;color:var(--c-gold)}

/* — Tarot — */
.tarot-hand{display:flex;justify-content:center;gap:var(--sp-sm);flex-wrap:wrap;padding:var(--sp-lg) 0}
.t-card{width:76px;height:114px;perspective:600px;cursor:pointer}
.t-card-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .6s ease}
.t-card.flipped .t-card-inner{transform:rotateY(180deg)}
.t-card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:.7rem;text-align:center;padding:4px}
.t-back{background:linear-gradient(135deg,#2a1a3e,#1a0a2e);border:2px solid var(--c-gold);color:var(--c-gold)}
.t-back::after{content:'✦';font-size:1.5rem;opacity:.6}
.t-front{transform:rotateY(180deg);background:var(--c-bg-card-alt);border:2px solid var(--c-border-hi);color:var(--c-text);gap:2px}
.t-front .tc-name{font-family:var(--f-display);font-weight:700;font-size:.72rem;color:var(--c-gold)}
.t-front .tc-dir{font-size:.6rem;color:var(--c-text-dim)}

/* — Result — */
.result-verdict{text-align:center;padding:var(--sp-lg);border:2px solid var(--c-gold);border-radius:var(--r-lg);background:linear-gradient(180deg,rgba(212,175,55,.08),rgba(139,0,0,.08));margin-bottom:var(--sp-lg)}
.verdict-label{font-family:var(--f-display);font-weight:900;font-size:1.8rem;color:var(--c-gold-light);margin-bottom:var(--sp-xs)}
.verdict-prob{font-size:2.5rem;font-weight:900;background:linear-gradient(135deg,var(--c-gold),var(--c-gold-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.verdict-note{color:var(--c-text-dim);font-size:.9rem;margin-top:var(--sp-sm)}
.prob-meter{margin:var(--sp-md) 0}
.prob-bar{height:12px;background:rgba(255,255,255,.06);border-radius:6px;overflow:hidden}
.prob-fill{height:100%;border-radius:6px;background:linear-gradient(90deg,var(--c-crimson),var(--c-gold),var(--c-success));transition:width 1.2s cubic-bezier(.4,0,.2,1)}
.prob-labels{display:flex;justify-content:space-between;font-size:.7rem;color:var(--c-text-muted);margin-top:4px}

/* — Dimension Tabs — */
.dim-tabs{display:flex;gap:2px;margin-bottom:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.dim-tab{flex:0 0 auto;padding:.6rem 1rem;border-radius:var(--r-sm) var(--r-sm) 0 0;background:rgba(255,255,255,.04);border:1px solid var(--c-border);border-bottom:none;font-size:.85rem;font-weight:500;color:var(--c-text-dim);cursor:pointer;transition:all var(--t-fast);white-space:nowrap}
.dim-tab.active{background:var(--c-bg-card);color:var(--c-gold);border-color:var(--c-border-hi)}
.dim-pane{display:none;padding:var(--sp-lg);background:var(--c-bg-card);border:1px solid var(--c-border);border-radius:0 var(--r-md) var(--r-md) var(--r-md)}
.dim-pane.active{display:block;animation:fadeIn .3s ease}

/* — Conclusion — */
.conclusion{background:linear-gradient(135deg,rgba(139,0,0,.15),rgba(212,175,55,.08));border:1px solid var(--c-border-hi);border-radius:var(--r-lg);padding:var(--sp-lg);margin-top:var(--sp-lg)}
/* Collapsible cards */
.collapsible-card{overflow:hidden}
.collapsible-toggle{cursor:pointer;display:flex;justify-content:space-between;align-items:center;user-select:none;margin:0}
.collapsible-toggle:hover{opacity:.85}
.collapse-arrow{transition:transform .3s ease;font-size:.8rem;opacity:.6}
.collapsible-card.open .collapse-arrow{transform:rotate(180deg)}
.collapsible-body{max-height:0;overflow:hidden;transition:max-height .4s ease,padding .3s ease;padding:0 var(--sp-md)}
.collapsible-card.open .collapsible-body{max-height:5000px;padding:var(--sp-md)}
/* Daily fortune collapse on step-0 */
.daily-mini{border:1px solid var(--c-border);border-radius:var(--r-md);margin-bottom:var(--sp-md);overflow:hidden}
.daily-mini-toggle{display:flex;justify-content:space-between;align-items:center;padding:var(--sp-sm) var(--sp-md);cursor:pointer;background:rgba(212,175,55,.06);font-size:.9rem;color:var(--c-gold)}
.daily-mini-toggle:hover{background:rgba(212,175,55,.12)}
.daily-mini-body{max-height:0;overflow:hidden;transition:max-height .4s ease}
.daily-mini.open .daily-mini-body{max-height:2000px}
.daily-mini.open .daily-mini-arrow{transform:rotate(180deg)}
.daily-mini-arrow{transition:transform .3s ease}
/* Remedy Alert - emotional trigger */
.remedy-alert{border:1px solid var(--c-border);background:linear-gradient(135deg,rgba(212,175,55,.04),rgba(30,12,12,.6));position:relative;overflow:visible}
.remedy-alert-header{display:flex;align-items:flex-start;gap:var(--sp-md);margin-bottom:var(--sp-md)}
.remedy-icon{font-size:2.2rem;flex-shrink:0;line-height:1}
.remedy-title{color:var(--c-gold);font-size:1.15rem;margin:0 0 .3rem 0;font-weight:700}
.remedy-subtitle{color:var(--c-text-dim);font-size:.9rem;margin:0}
.remedy-diagnosis{background:rgba(0,0,0,.2);border-radius:var(--r-md);padding:var(--sp-md);margin-bottom:var(--sp-md)}
.remedy-diagnosis .diag-row{display:flex;align-items:center;gap:var(--sp-sm);padding:.5rem 0;border-bottom:1px solid rgba(255,255,255,.06)}
.remedy-diagnosis .diag-row:last-child{border-bottom:none}
.diag-label{font-size:.85rem;color:var(--c-text-dim);min-width:4.5rem}
.diag-value{font-size:.95rem;font-weight:600}
.diag-bar-wrap{flex:1;height:8px;background:rgba(255,255,255,.08);border-radius:4px;overflow:hidden}
.diag-bar{height:100%;border-radius:4px;transition:width .6s ease}
.diag-tag{font-size:.75rem;padding:2px 6px;border-radius:3px;font-weight:600}
.diag-tag-lack{background:rgba(160,140,255,.15);color:#b0a0ff}
.diag-tag-excess{background:rgba(100,200,255,.2);color:#64c8ff}
.diag-tag-ok{background:rgba(100,255,100,.15);color:#7ddf7d}
.remedy-arrow{display:flex;align-items:center;justify-content:center;gap:var(--sp-sm);padding:var(--sp-sm) 0}
.text-gold{color:var(--c-gold)}
/* Remedy Plan */
.remedy-plan{border:2px solid rgba(212,175,55,.3);background:linear-gradient(135deg,rgba(212,175,55,.06),rgba(139,0,0,.04))}
.remedy-actions .action-item{display:flex;gap:var(--sp-md);padding:var(--sp-md);border-bottom:1px solid var(--c-border);align-items:flex-start}
.remedy-actions .action-item:last-child{border-bottom:none}
.action-num{width:2rem;height:2rem;background:var(--c-gold);color:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem;flex-shrink:0}
.action-content{flex:1}
.action-title{font-weight:700;color:var(--c-gold);margin-bottom:.3rem}
.action-desc{font-size:.9rem;color:var(--c-text-dim);line-height:1.6}
.action-crystal{display:inline-flex;align-items:center;gap:.3rem;background:rgba(212,175,55,.12);border:1px solid rgba(212,175,55,.3);border-radius:var(--r-sm);padding:.2rem .6rem;margin-top:.5rem;font-size:.85rem;color:var(--c-gold);cursor:pointer}
.action-crystal:hover{background:rgba(212,175,55,.2)}
/* Detail toggle in answer section */
.detail-toggle-wrap.open .detail-toggle-body{max-height:3000px}
.detail-toggle-wrap.open .fa-chevron-right{transform:rotate(90deg)}
.conclusion h3{font-family:var(--f-display);color:var(--c-gold);margin-bottom:var(--sp-md)}

/* — Actions — */
.actions{display:flex;gap:var(--sp-sm);justify-content:space-between;margin-top:var(--sp-lg);flex-wrap:wrap}
.actions-center{justify-content:center}

/* — Utilities — */
.text-gold{color:var(--c-gold)}.text-dim{color:var(--c-text-dim)}.text-muted{color:var(--c-text-muted)}
.text-success{color:var(--c-success)}.text-warn{color:var(--c-warn)}.text-danger{color:var(--c-danger)}
.text-center{text-align:center}.text-sm{font-size:.85rem}.text-xs{font-size:.75rem}
.mt-sm{margin-top:var(--sp-sm)}.mt-md{margin-top:var(--sp-md)}.mt-lg{margin-top:var(--sp-lg)}
.mb-sm{margin-bottom:var(--sp-sm)}.mb-md{margin-bottom:var(--sp-md)}.mb-lg{margin-bottom:var(--sp-lg)}
.hidden{display:none!important}
.serif{font-family:var(--f-display)}
.tag{display:inline-block;padding:2px 8px;border-radius:var(--r-pill);font-size:.75rem;font-weight:600}
.tag-gold{background:rgba(212,175,55,.15);color:var(--c-gold)}
.tag-red{background:rgba(239,68,68,.15);color:var(--c-danger)}
.tag-green{background:rgba(74,222,128,.15);color:var(--c-success)}
.tag-blue{background:rgba(96,165,250,.15);color:var(--c-info)}
.divider{height:1px;background:linear-gradient(90deg,transparent,var(--c-border-hi),transparent);margin:var(--sp-lg) 0}

/* — ZiWei Grid — */
.zw-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;background:var(--c-border);border-radius:var(--r-md);overflow:hidden;margin:var(--sp-md) 0}
.zw-cell{background:var(--c-bg-card);padding:var(--sp-sm);min-height:85px;font-size:.75rem;position:relative}
.zw-cell.zw-center{grid-column:2/4;grid-row:2/4;display:flex;align-items:center;justify-content:center;flex-direction:column;background:var(--c-bg-card-alt);text-align:center;min-height:170px}
.zw-palace{font-weight:700;color:var(--c-gold);font-size:.8rem;margin-bottom:2px}
.zw-branch{font-size:.65rem;color:var(--c-text-muted)}
.zw-stars{margin-top:3px;line-height:1.5}
.zw-star{display:inline;margin-right:3px}
.zw-star.major{color:var(--c-gold-light);font-weight:600}
.zw-star.minor{color:var(--c-text-dim)}
.zw-hua{font-size:.55rem;padding:0 2px;border-radius:2px;background:rgba(212,175,55,.2);color:var(--c-gold);vertical-align:super;margin-left:1px}
.zw-cell.active-palace{border:1px solid var(--c-gold);background:rgba(212,175,55,.06)}

/* — Crystal — */
.crystal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:var(--sp-md);margin:var(--sp-md) 0}
.crystal-card{padding:var(--sp-md);border-radius:var(--r-md);border:1px solid var(--c-border);background:var(--c-bg-card);text-align:center;transition:all var(--t-fast)}
.crystal-card:hover{border-color:var(--c-gold);transform:translateY(-2px)}
.crystal-icon{font-size:2rem;margin-bottom:var(--sp-sm)}
.crystal-name{font-family:var(--f-display);font-weight:700;color:var(--c-gold);margin-bottom:var(--sp-xs)}

/* — Responsive — */
@media(max-width:640px){
  .bazi-cell .gz{font-size:1.1rem}
  .nav-links{display:none}
  .stepper{flex-wrap:wrap;gap:.3rem}
  .stepper-line{width:16px}
  .hex-grid{gap:var(--sp-sm)}
}
@media(max-width:380px){
  .hero h1{font-size:1.3rem}
  .card{padding:var(--sp-md)}
}

/* — Shop Buttons — */
.shop-btns{display:flex;flex-direction:column;gap:var(--sp-sm)}
.shop-btn-card{display:flex;align-items:center;gap:var(--sp-md);padding:1rem 1.2rem;border-radius:var(--r-md);border:1px solid var(--c-border);background:var(--c-bg-card-alt);color:var(--c-text);text-decoration:none;transition:all var(--t-fast);cursor:pointer;font-family:inherit;font-size:inherit;text-align:left;width:100%}
.shop-btn-card:hover{border-color:var(--c-gold);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.shop-btn-card i{font-size:1.3rem;width:32px;text-align:center;flex:0 0 auto}
.shop-btn-card div{display:flex;flex-direction:column;gap:1px}
.shop-btn-card.shopee i{color:#ee4d2d}
.shop-btn-card.seven i{color:#00a040}
.shop-btn-card.custom i{color:var(--c-gold)}
.shop-btn-card strong{color:var(--c-text)}
.shop-card{border:2px solid rgba(212,175,55,.4);background:linear-gradient(135deg,rgba(139,0,0,.1),rgba(212,175,55,.06));margin-top:var(--sp-xl);padding:var(--sp-xl)}

/* — Nav Shop — */
.nav-shop{display:flex;gap:var(--sp-xs);align-items:center}
.nav-shop a{font-size:.75rem;padding:.35rem .6rem;border-radius:var(--r-pill);border:1px solid rgba(255,255,255,.12);color:var(--c-text-dim);transition:all var(--t-fast);white-space:nowrap}
.nav-shop a:hover{border-color:var(--c-gold);color:var(--c-gold)}

/* — Modal — */
.modal-overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:var(--sp-md)}
.modal-box{background:var(--c-bg-card);border:1px solid var(--c-border-hi);border-radius:var(--r-lg);padding:var(--sp-lg);max-width:480px;width:100%;max-height:90vh;overflow-y:auto;position:relative;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:scaleIn .3s ease}
.modal-close{position:absolute;top:var(--sp-sm);right:var(--sp-md);background:none;border:none;color:var(--c-text-dim);font-size:1.5rem;cursor:pointer;padding:4px 8px;border-radius:var(--r-sm);transition:color var(--t-fast)}
.modal-close:hover{color:var(--c-gold)}

/* — Floating Buttons — */
.floating-root{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 20px);right:16px;z-index:900;display:flex;flex-direction:column-reverse;align-items:flex-end;gap:var(--sp-sm)}
.fab{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid rgba(212,175,55,.5);cursor:pointer;transition:all var(--t-fast);text-decoration:none;font-family:inherit;flex-direction:column;gap:2px;font-size:.6rem;color:var(--c-text)}
.fab i{font-size:1rem}
.fab span{font-size:.5rem;line-height:1}
.fab-toggle{background:linear-gradient(135deg,var(--c-crimson),#6b0000);color:var(--c-gold-pale);box-shadow:0 4px 16px rgba(139,0,0,.5)}
.fab-toggle:hover{transform:scale(1.1)}
.fab-shopee{background:rgba(238,77,45,.15);color:#ee4d2d;border-color:rgba(238,77,45,.4)}
.fab-711{background:rgba(0,160,64,.15);color:#00a040;border-color:rgba(0,160,64,.4)}
.fab-custom{background:rgba(212,175,55,.12);color:var(--c-gold);border-color:rgba(212,175,55,.4)}
.fab-menu{display:flex;flex-direction:column-reverse;gap:var(--sp-sm)}
.fab-menu.hidden{display:none}
@media(max-width:640px){
  .fab{width:44px;height:44px}
  .fab span{display:none}
}

/* — Product Grid — */
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:var(--sp-md);margin:var(--sp-md) 0}
.product-card{display:flex;gap:var(--sp-md);padding:var(--sp-md);border:1px solid var(--c-border);border-radius:var(--r-md);background:var(--c-bg-card-alt);transition:border-color var(--t-fast)}
.product-card:hover{border-color:var(--c-gold)}
.product-icon{font-size:2rem;flex:0 0 auto;padding-top:2px}
.product-body{flex:1;min-width:0}
.product-name{font-weight:700;color:var(--c-text);font-size:1rem;margin-bottom:4px}
.product-meta{display:flex;gap:var(--sp-xs);margin-bottom:var(--sp-xs)}
.product-desc{font-size:.85rem;color:var(--c-text-dim);margin-bottom:var(--sp-xs);line-height:1.5}
.product-price{font-size:1.1rem;font-weight:700;color:var(--c-gold);margin-bottom:var(--sp-xs)}
.product-wear{font-size:.78rem;color:var(--c-text-muted);margin-bottom:var(--sp-sm)}
.product-actions{display:flex;gap:var(--sp-xs)}
.product-btn{display:inline-flex;align-items:center;gap:4px;padding:.4rem .7rem;border-radius:var(--r-sm);border:1px solid var(--c-border);font-size:.78rem;text-decoration:none;color:var(--c-text);transition:all var(--t-fast)}
.product-btn:hover{border-color:var(--c-gold);color:var(--c-gold)}
.product-btn.shopee:hover{border-color:#ee4d2d;color:#ee4d2d}
.product-btn.seven:hover{border-color:#00a040;color:#00a040}
.btn-full{width:100%;justify-content:center;padding:.9rem}
.custom-cta{text-align:center}
.custom-cta .btn{word-break:keep-all;white-space:normal;line-height:1.4;font-size:clamp(0.85rem,3.5vw,1rem)}

/* — Share Gate — */
.share-gate-card{border:2px dashed rgba(212,175,55,.4);border-radius:var(--r-lg);padding:var(--sp-lg);text-align:center;background:linear-gradient(135deg,rgba(212,175,55,.04),rgba(139,0,0,.04))}
.share-gate-card h4{color:var(--c-gold);margin-bottom:var(--sp-sm)}
.share-gate-card p{color:var(--c-text-dim);font-size:.9rem;margin-bottom:var(--sp-md)}
.btn-share-big{padding:.85rem 2rem;font-size:1rem;border-radius:var(--r-pill);background:linear-gradient(135deg,#25D366,#128C7E);color:#fff;border:none;cursor:pointer;transition:all var(--t-fast);font-weight:700}
.btn-share-big:hover{transform:scale(1.03);box-shadow:0 4px 20px rgba(37,211,102,.3)}
.btn-save-card{padding:.7rem 1.5rem;font-size:.9rem;border-radius:var(--r-pill);background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;cursor:pointer;transition:all var(--t-fast);font-weight:600}
.btn-save-card:hover{transform:scale(1.03);box-shadow:0 4px 20px rgba(118,75,162,.3)}

/* — Urgency Strip — */
.urgency-strip{display:flex;gap:var(--sp-sm);flex-wrap:wrap;margin-top:var(--sp-xs);font-size:.72rem}
.urgency-critical{color:#ff4444;font-weight:700;animation:pulse 2s infinite}
.urgency-normal{color:rgba(255,255,255,.6)}
.urgency-views{color:rgba(255,255,255,.45)}

/* — Social Proof — */
.social-proof{border:1px solid rgba(212,175,55,.2);border-radius:var(--r-md);padding:var(--sp-md);margin:var(--sp-md) 0;background:rgba(212,175,55,.04)}
.sp-item{font-size:.85rem;color:var(--c-text-dim);margin:var(--sp-xs) 0}
.sp-item strong{color:var(--c-gold)}

/* — Live Counter + Marquee — */
.live-counter-bar{display:flex;align-items:center;justify-content:center;gap:var(--sp-md);padding:var(--sp-sm) var(--sp-md);background:rgba(212,175,55,.06);border:1px solid rgba(212,175,55,.15);border-radius:var(--r-md);margin-bottom:var(--sp-lg);font-size:.85rem;color:var(--c-text-dim);flex-wrap:wrap}
.live-counter-bar strong{color:var(--c-gold);font-size:1.1rem}
.live-marquee{text-align:center;font-size:.78rem;color:rgba(255,255,255,.55);padding:var(--sp-xs);transition:opacity .3s;min-height:1.4em;margin-bottom:var(--sp-md)}

/* — Discount Reveal — */
.discount-reveal{border:2px solid var(--c-gold);border-radius:var(--r-lg);padding:var(--sp-lg);text-align:center;background:linear-gradient(135deg,rgba(212,175,55,.08),rgba(139,0,0,.06));margin-top:var(--sp-md)}
.discount-code{font-size:1.8rem;font-weight:900;color:var(--c-gold);letter-spacing:4px;font-family:monospace;padding:var(--sp-md);background:rgba(0,0,0,.3);border-radius:var(--r-md);display:inline-block;margin:var(--sp-sm) 0}

/* — PWA Banner — */
.pwa-banner{position:fixed;top:0;left:0;right:0;z-index:800;background:linear-gradient(135deg,#1a0505,#2D0A0A);border-bottom:2px solid var(--c-gold);padding:var(--sp-sm) var(--sp-md);display:flex;align-items:center;gap:var(--sp-md);box-shadow:0 4px 20px rgba(0,0,0,.5);animation:slideDown .4s ease}
@keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
.pwa-banner.hidden{display:none}
.pwa-banner-text{flex:1;font-size:.85rem;color:var(--c-text)}
.pwa-banner-text strong{color:var(--c-gold)}
.pwa-install-btn{padding:.5rem 1rem;border-radius:var(--r-pill);background:var(--c-gold);color:#2D0A0A;border:none;font-weight:700;cursor:pointer;white-space:nowrap;font-size:.85rem}
.pwa-close-btn{background:none;border:none;color:var(--c-text-dim);font-size:1.2rem;cursor:pointer;padding:4px}

/* — Remind Button — */
.btn-remind{padding:.6rem 1.2rem;border-radius:var(--r-pill);border:1px solid rgba(212,175,55,.4);background:rgba(212,175,55,.08);color:var(--c-gold);cursor:pointer;font-size:.85rem;transition:all var(--t-fast)}
.btn-remind:hover{background:rgba(212,175,55,.15);border-color:var(--c-gold)}

/* — Print (after all shop/fab styles) — */
@media print{
  .nav,.stepper,.actions,.btn,.floating-root,.shop-card,.modal-overlay{display:none!important}
  body{background:#fff!important;color:#000!important}
  .card,.dim-pane,.conclusion{border:1px solid #ccc!important;background:#fff!important;box-shadow:none!important}
  .text-gold,.card-title,.verdict-label,.hex-name,.zw-palace{color:#8b0000!important}
  .tag{border:1px solid #ccc}
  .prob-fill{background:#8b0000!important}
  .step{display:none!important}
  #step-3{display:block!important}
  .dim-pane{display:block!important;margin-bottom:1rem}
  .dim-tabs{display:none!important}
}
/* =============================================================
   UI POLISH v2 — 全站視覺升級
   ============================================================= */

/* ── 背景：深色漸層 + 微光粒子感 ── */
body::before{
  content:'';position:fixed;inset:0;z-index:-1;
  background:
    radial-gradient(ellipse 600px 400px at 20% 10%, rgba(139,0,0,0.15), transparent),
    radial-gradient(ellipse 500px 350px at 80% 85%, rgba(212,175,55,0.06), transparent),
    radial-gradient(ellipse 300px 300px at 50% 50%, rgba(139,0,0,0.05), transparent);
  pointer-events:none;
}

/* ── 對航列升級 ── */
.nav{
  background:rgba(13,4,4,0.88)!important;
  backdrop-filter:blur(16px) saturate(1.4)!important;
  border-bottom:1px solid rgba(212,175,55,0.12)!important;
  box-shadow:0 2px 20px rgba(0,0,0,0.3);
}
.nav-brand i{
  text-shadow:0 0 16px rgba(212,175,55,0.5);
}

/* ── Hero 重設計 ── */
.hero{
  padding:var(--sp-xl) var(--sp-md) var(--sp-lg)!important;
  text-align:center;
  position:relative;
}
.hero::before{
  content:'';position:absolute;top:-20px;left:50%;transform:translateX(-50%);
  width:200px;height:200px;
  background:radial-gradient(circle,rgba(212,175,55,0.12) 0%,transparent 70%);
  border-radius:50%;pointer-events:none;
}
.hero-icon{
  font-size:3rem!important;
  text-shadow:0 0 40px rgba(212,175,55,0.5),0 0 80px rgba(212,175,55,0.2)!important;
  position:relative;z-index:1;
}
.hero h1{
  font-size:clamp(1.5rem,5vw,2.2rem)!important;
  background:linear-gradient(135deg,#d4af37 0%,#f5e6b8 40%,#d4af37 60%,#b8941f 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
  line-height:1.4!important;
  letter-spacing:0.05em;
}
.hero p{
  color:var(--c-text-dim)!important;font-size:0.95rem!important;
  letter-spacing:0.08em;
}

/* ── 卡片獻璃態 ── */
.card{
  background:rgba(30,12,12,0.75)!important;
  backdrop-filter:blur(8px);
  border:1px solid rgba(212,175,55,0.12)!important;
  box-shadow:0 8px 32px rgba(0,0,0,0.3),inset 0 1px 0 rgba(255,255,255,0.03)!important;
}
.card:hover{
  border-color:rgba(212,175,55,0.25)!important;
  box-shadow:0 12px 40px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.05)!important;
}

/* ── 卡片標題裝飾線 ── */
.card-title{
  padding-bottom:var(--sp-sm);
  border-bottom:1px solid rgba(212,175,55,0.1);
  margin-bottom:var(--sp-md)!important;
}
.card-title i{
  color:var(--c-gold);text-shadow:0 0 8px rgba(212,175,55,0.3);
}

/* ── 表單升級 ── */
.form-input,.form-select,.form-textarea{
  background:rgba(0,0,0,0.3)!important;
  border:1px solid rgba(255,255,255,0.08)!important;
  border-radius:var(--r-md)!important;
  color:var(--c-text)!important;
  padding:0.85rem 1rem!important;
  transition:all 0.3s ease!important;
  font-size:16px!important; /* prevent iOS zoom */
}
.form-input:focus,.form-select:focus,.form-textarea:focus{
  border-color:rgba(212,175,55,0.5)!important;
  box-shadow:0 0 0 3px rgba(212,175,55,0.1),0 0 20px rgba(212,175,55,0.05)!important;
  outline:none!important;
}
.form-label{
  font-weight:600!important;
  color:var(--c-text)!important;
  margin-bottom:var(--sp-sm)!important;
  display:block!important;
}

/* ── 性別 Radio Pills ── */
.radio-pills{display:flex;gap:var(--sp-sm)}
.radio-pill{flex:1}
.radio-pill input{display:none}
.radio-pill span{
  display:block;text-align:center;padding:0.75rem;
  border:1px solid rgba(255,255,255,0.08);border-radius:var(--r-md);
  cursor:pointer;transition:all 0.3s;color:var(--c-text-dim);font-weight:600;
}
.radio-pill input:checked+span{
  border-color:var(--c-gold);color:var(--c-gold);
  background:rgba(212,175,55,0.1);
  box-shadow:0 0 12px rgba(212,175,55,0.15);
}

/* ── Stepper 精緻化 ── */
.stepper{
  display:flex;align-items:center;justify-content:center;
  gap:0;margin:var(--sp-md) 0 var(--sp-lg);padding:0 var(--sp-md);
}
.stepper-dot{
  width:36px!important;height:36px!important;
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:0.85rem;
  border:2px solid rgba(255,255,255,0.12);
  color:var(--c-text-dim);background:rgba(0,0,0,0.3);
  transition:all 0.4s ease;
}
.stepper-item.active .stepper-dot{
  border-color:var(--c-gold);color:var(--c-gold);
  background:rgba(212,175,55,0.12);
  box-shadow:0 0 16px rgba(212,175,55,0.25);
}
.stepper-item.done .stepper-dot{
  border-color:rgba(212,175,55,0.4);color:var(--c-gold-light);
  background:rgba(212,175,55,0.08);
}
.stepper-line{
  flex:1;height:2px;
  background:linear-gradient(90deg,rgba(255,255,255,0.06),rgba(212,175,55,0.15),rgba(255,255,255,0.06));
  margin:0 var(--sp-xs);
}
.stepper-item{
  display:flex;flex-direction:column;align-items:center;gap:4px;
}
.stepper-item span{font-size:0.7rem;color:var(--c-text-muted)}
.stepper-item.active span{color:var(--c-gold)}

/* ── 按鈕升級 ── */
.btn-primary,.btn-gold{
  position:relative;overflow:hidden;
}
.btn-primary::before,.btn-gold::before{
  content:'';position:absolute;top:0;left:-100%;
  width:60%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);
  transition:left 0.5s;
}
.btn-primary:hover::before,.btn-gold:hover::before{
  left:100%;
}

/* ── 結果頁 Verdict 升級 ── */
.result-verdict{
  text-align:center;
  padding:var(--sp-xl) var(--sp-lg)!important;
  border:1px solid rgba(212,175,55,0.2)!important;
  background:linear-gradient(180deg,rgba(30,12,12,0.9) 0%,rgba(45,10,10,0.95) 100%)!important;
  position:relative;
}
.result-verdict::before{
  content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:60%;height:1px;
  background:linear-gradient(90deg,transparent,var(--c-gold),transparent);
}
.verdict-prob{
  font-size:clamp(2.5rem,8vw,4rem)!important;
  font-weight:900!important;
  letter-spacing:2px;
}
.verdict-label{
  font-size:1.2rem!important;
  letter-spacing:0.1em;
}

/* ── 機率條升級 ── */
.prob-bar{
  height:10px!important;border-radius:var(--r-pill)!important;
  background:rgba(255,255,255,0.05)!important;
  overflow:hidden;position:relative;
}
.prob-fill{
  height:100%;border-radius:var(--r-pill);
  background:linear-gradient(90deg,#8b0000,#d4af37,#e8c968)!important;
  position:relative;
  transition:width 1.5s cubic-bezier(0.4,0,0.2,1)!important;
}
.prob-fill::after{
  content:'';position:absolute;right:0;top:0;bottom:0;width:20px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3));
  border-radius:0 var(--r-pill) var(--r-pill) 0;
  animation:pulse 2s infinite;
}

/* ── Dimension Tabs 升級 ── */
.dim-tabs{
  display:flex;gap:var(--sp-xs);padding:var(--sp-sm);
  background:rgba(0,0,0,0.2);border-radius:var(--r-md);
  overflow-x:auto;-webkit-overflow-scrolling:touch;
}
.dim-tab{
  padding:0.6rem 1rem!important;border-radius:var(--r-sm)!important;
  font-size:0.82rem!important;white-space:nowrap;
  border:1px solid rgba(255,255,255,0.06)!important;
  background:transparent!important;color:var(--c-text-dim)!important;
  transition:all 0.3s!important;cursor:pointer;
}
.dim-tab.active{
  background:linear-gradient(135deg,var(--c-crimson),#6b0000)!important;
  color:var(--c-gold-pale)!important;
  border-color:rgba(212,175,55,0.4)!important;
  box-shadow:0 2px 12px rgba(139,0,0,0.3);
}

/* ── 商品卡片升級 ── */
.product-grid{
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr))!important;
}
.product-card{
  border-radius:var(--r-lg)!important;
  background:linear-gradient(135deg,rgba(30,12,12,0.8),rgba(20,8,8,0.9))!important;
  border:1px solid rgba(212,175,55,0.08)!important;
  transition:all 0.3s ease!important;
  position:relative;overflow:hidden;
}
.product-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,0.4),transparent);
  opacity:0;transition:opacity 0.3s;
}
.product-card:hover::before{opacity:1}
.product-card:hover{
  transform:translateY(-3px)!important;
  box-shadow:0 12px 36px rgba(0,0,0,0.4)!important;
  border-color:rgba(212,175,55,0.2)!important;
}
.product-icon{font-size:2.5rem!important}
.product-img{
  width:80px;height:80px;border-radius:var(--r-md);
  object-fit:cover;flex:0 0 auto;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
  border:1px solid rgba(212,175,55,0.15);
  background:rgba(40,20,20,0.5);
}
/* ── 水晶造型圖系統（SVG inline） ── */
.cv-wrap{flex:0 0 auto;width:80px;height:76px;display:flex;align-items:center;justify-content:center}
.product-price{
  font-size:1.15rem!important;
  background:linear-gradient(135deg,var(--c-gold),var(--c-gold-light));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.product-btn{
  border-radius:var(--r-pill)!important;
  padding:0.45rem 0.85rem!important;
  font-weight:600!important;
}

/* ── 塔羅牌動畫 ── */
.tarot-card-draw{
  transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1),opacity 0.3s;
}
.tarot-card-draw:hover{
  transform:translateY(-8px) scale(1.05);
}

/* ── 結論區升級 ── */
.conclusion{
  position:relative;
  border:1px solid rgba(212,175,55,0.15)!important;
  background:linear-gradient(135deg,rgba(30,12,12,0.85),rgba(20,8,8,0.95))!important;
  border-radius:var(--r-lg)!important;
  padding:var(--sp-xl) var(--sp-lg)!important;
}
.conclusion::before{
  content:'';position:absolute;top:-1px;left:10%;right:10%;height:1px;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,0.5),transparent);
}
.conclusion h3{
  text-align:center!important;
  font-size:1.3rem!important;
  margin-bottom:var(--sp-lg)!important;
}
.conclusion p{
  line-height:2!important;
  margin-bottom:var(--sp-md)!important;
  color:rgba(245,230,211,0.85)!important;
}

/* ── 社會認同 + 計數器升級 ── */
.live-counter-bar{
  background:rgba(0,0,0,0.2)!important;
  border:1px solid rgba(212,175,55,0.1)!important;
  border-radius:var(--r-pill)!important;
  padding:var(--sp-xs) var(--sp-lg)!important;
  display:inline-flex!important;
}
.live-marquee{
  animation:fadeIn 0.3s;
}

/* ── 分享/折扣區升級 ── */
.share-gate-card{
  background:linear-gradient(135deg,rgba(212,175,55,0.05),rgba(139,0,0,0.05))!important;
  border:2px dashed rgba(212,175,55,0.25)!important;
}
.discount-reveal{
  animation:scaleIn 0.5s ease;
}
.discount-code{
  animation:shimmer 3s ease-in-out infinite;
  background-size:200% 100%;
  background-image:linear-gradient(90deg,var(--c-gold),#fff,var(--c-gold-light),var(--c-gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}

/* ── 商城推薦卡片升級 ── */
.shop-card{
  background:linear-gradient(135deg,rgba(139,0,0,0.12),rgba(212,175,55,0.06))!important;
  border:1px solid rgba(212,175,55,0.2)!important;
}
.shop-btn-card{
  border-radius:var(--r-lg)!important;
  padding:1rem 1.15rem!important;
}

/* ── 浮動按鈕升級 ── */
.fab{
  box-shadow:0 4px 16px rgba(0,0,0,0.3)!important;
}
.fab-toggle{
  width:52px!important;height:52px!important;
  box-shadow:0 4px 24px rgba(139,0,0,0.5),0 0 12px rgba(212,175,55,0.15)!important;
}

/* ── 滾動條 ── */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:rgba(0,0,0,0.1)}
::-webkit-scrollbar-thumb{background:rgba(212,175,55,0.2);border-radius:var(--r-pill)}
::-webkit-scrollbar-thumb:hover{background:rgba(212,175,55,0.4)}

/* ── 選取文字顏色 ── */
::selection{background:rgba(212,175,55,0.3);color:var(--c-text)}

/* ── 平滑滾動 ── */
html{scroll-behavior:smooth}

/* ── Loading Skeleton ── */
@keyframes skeleton{0%{background-position:-200% 0}100%{background-position:200% 0}}
.skeleton{
  background:linear-gradient(90deg,rgba(255,255,255,0.03) 25%,rgba(255,255,255,0.08) 50%,rgba(255,255,255,0.03) 75%);
  background-size:200% 100%;animation:skeleton 1.5s infinite;
  border-radius:var(--r-sm);
}

/* ── 分隔線 ── */
.divider-gold{
  height:1px;margin:var(--sp-lg) 0;
  background:linear-gradient(90deg,transparent,rgba(212,175,55,0.3),transparent);
}

/* ── 紫微命盤格子升級 ── */
.zw-grid{gap:3px!important}
.zw-cell{
  background:rgba(0,0,0,0.2)!important;
  border:1px solid rgba(212,175,55,0.1)!important;
  border-radius:var(--r-sm)!important;
  transition:border-color 0.3s;
}
.zw-cell:hover{border-color:rgba(212,175,55,0.3)}
.zw-cell.active-palace{
  border-color:rgba(212,175,55,0.5)!important;
  background:rgba(212,175,55,0.06)!important;
  box-shadow:inset 0 0 20px rgba(212,175,55,0.05);
}

/* ── Tag 升級 ── */
.tag{border-radius:var(--r-pill)!important}

/* ── 五行 Tag 彩色 ── */
.el-tag.el-金{background:rgba(192,192,192,0.15);color:#e0e0e0;border-color:rgba(192,192,192,0.3)}
.el-tag.el-木{background:rgba(34,197,94,0.15);color:#4ade80;border-color:rgba(34,197,94,0.3)}
.el-tag.el-水{background:rgba(59,130,246,0.15);color:#60a5fa;border-color:rgba(59,130,246,0.3)}
.el-tag.el-火{background:rgba(239,68,68,0.15);color:#f87171;border-color:rgba(239,68,68,0.3)}
.el-tag.el-土{background:rgba(167,139,90,0.15);color:#d4a857;border-color:rgba(167,139,90,0.3)}

/* ── Mobile 優化 ── */
@media(max-width:640px){
  .hero h1{letter-spacing:0.02em}
  .product-grid{grid-template-columns:1fr!important}
  .product-card{flex-direction:column!important;text-align:center}
  .product-card .product-actions{justify-content:center}
  .conclusion{padding:var(--sp-lg) var(--sp-md)!important}
  .live-counter-bar{flex-direction:column!important;gap:var(--sp-xs)!important;padding:var(--sp-sm)!important;border-radius:var(--r-md)!important}
  .live-counter-bar span:nth-child(2){display:none}
}

/* ── Daily Fortune ── */
.fortune-draw-area{text-align:center;padding:var(--sp-xl) 0}
.fortune-urn{font-size:4rem;animation:pulse 2s infinite;margin-bottom:var(--sp-md)}
.fortune-result{text-align:center}
.fortune-sign-icon{font-size:3rem;margin-bottom:var(--sp-sm)}
.fortune-sign-text{font-size:1.8rem;font-weight:900;color:var(--c-gold);letter-spacing:0.1em;margin-bottom:var(--sp-sm);font-family:var(--f-display)}
.fortune-msg{color:var(--c-text);font-size:1.05rem;line-height:1.6;margin-bottom:var(--sp-md)}
.fortune-divider{height:1px;background:linear-gradient(90deg,transparent,rgba(212,175,55,.3),transparent);margin:var(--sp-md) 0}
.fortune-crystal-rec{background:rgba(212,175,55,0.04);border:1px solid rgba(212,175,55,0.12);border-radius:var(--r-md);padding:var(--sp-md)}
.fortune-crystal-card{display:flex;align-items:center;gap:var(--sp-sm);justify-content:center;margin:var(--sp-sm) 0}
.fortune-crystal-name{font-weight:700;font-size:1.1rem;color:var(--c-gold)}
.fortune-buy-btns{display:flex;gap:var(--sp-sm);justify-content:center}
.achievements-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:var(--sp-sm)}
.achievement-badge{text-align:center;padding:var(--sp-md);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);transition:all 0.3s}
.achievement-badge.unlocked{border-color:rgba(212,175,55,0.3);background:rgba(212,175,55,0.04)}
.achievement-badge.locked{opacity:0.4;filter:grayscale(0.8)}
.badge-icon{font-size:2rem;margin-bottom:var(--sp-xs)}
.badge-name{font-size:0.85rem;font-weight:700;color:var(--c-text);margin-bottom:2px}
.achievement-toast{position:fixed;top:20px;right:20px;z-index:999;background:linear-gradient(135deg,rgba(30,12,12,0.95),rgba(45,10,10,0.98));border:2px solid var(--c-gold);border-radius:var(--r-lg);padding:var(--sp-md) var(--sp-lg);display:flex;align-items:center;gap:var(--sp-md);box-shadow:0 8px 32px rgba(0,0,0,0.5);transform:translateX(120%);transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);max-width:320px}
.achievement-toast.show{transform:translateX(0)}
.at-icon{font-size:2rem}
.ency-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:var(--sp-sm)}
.ency-card{padding:var(--sp-md);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);cursor:pointer;transition:all 0.3s;background:rgba(0,0,0,0.15)}
.ency-card:hover{border-color:rgba(212,175,55,0.3);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3)}
.ency-icon{font-size:2rem;margin-bottom:var(--sp-xs)}
.ency-name{font-weight:700;color:var(--c-text);font-size:0.95rem}
.ency-meta{display:flex;gap:var(--sp-xs);margin:var(--sp-xs) 0}
.ency-desc{font-size:0.78rem;color:var(--c-text-dim);line-height:1.4;margin:var(--sp-xs) 0}
.ency-price{font-weight:700;color:var(--c-gold);font-size:0.9rem}
.crystal-detail-modal{position:fixed;inset:0;z-index:600;display:flex;align-items:center;justify-content:center;padding:var(--sp-md)}
.crystal-detail-modal.hidden{display:none}
.cdm-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
.cdm-content{position:relative;background:linear-gradient(135deg,rgba(30,12,12,0.98),rgba(20,8,8,0.99));border:1px solid rgba(212,175,55,0.25);border-radius:var(--r-lg);padding:var(--sp-xl);max-width:420px;width:100%;max-height:90vh;overflow-y:auto;text-align:center}
.cdm-close{position:absolute;top:var(--sp-sm);right:var(--sp-sm);background:none;border:none;color:var(--c-text-dim);font-size:1.2rem;cursor:pointer}
.cdm-icon{font-size:3.5rem;margin-bottom:var(--sp-sm)}
.cdm-name{font-size:1.5rem;font-weight:700;color:var(--c-gold);font-family:var(--f-display);margin-bottom:var(--sp-sm)}
.cdm-tags{display:flex;gap:var(--sp-sm);justify-content:center;margin-bottom:var(--sp-md)}
.cdm-desc{color:var(--c-text);line-height:1.6;margin-bottom:var(--sp-md)}
.cdm-info{text-align:left;background:rgba(0,0,0,0.2);border-radius:var(--r-md);padding:var(--sp-md);margin-bottom:var(--sp-lg)}
.cdm-row{padding:var(--sp-xs) 0;color:var(--c-text-dim);font-size:0.9rem}
.cdm-row strong{color:var(--c-gold)}
.cdm-actions{display:flex;gap:var(--sp-sm);justify-content:center;flex-wrap:wrap}
.quiz-progress{text-align:center;color:var(--c-text-dim);font-size:0.85rem;margin-bottom:var(--sp-xs)}
.quiz-progress-bar{height:4px;background:rgba(255,255,255,0.06);border-radius:var(--r-pill);overflow:hidden;margin-bottom:var(--sp-lg)}
.quiz-fill{height:100%;background:linear-gradient(90deg,var(--c-crimson),var(--c-gold));border-radius:var(--r-pill);transition:width 0.4s}
.quiz-question{text-align:center;font-size:1.15rem;color:var(--c-text);margin-bottom:var(--sp-lg);line-height:1.5}
.quiz-options{display:flex;flex-direction:column;gap:var(--sp-sm)}
.quiz-option{padding:1rem var(--sp-lg);border:1px solid rgba(255,255,255,0.08);border-radius:var(--r-md);background:rgba(0,0,0,0.15);color:var(--c-text);cursor:pointer;text-align:left;transition:all 0.3s;font-size:0.95rem}
.quiz-option:hover{border-color:rgba(212,175,55,0.4);background:rgba(212,175,55,0.06);transform:translateX(4px)}
.quiz-result{text-align:center}
.quiz-result-icon{font-size:3.5rem;margin-bottom:var(--sp-sm)}
.quiz-result-title{color:var(--c-text-dim);font-size:0.95rem;margin-bottom:var(--sp-xs)}
.quiz-result-crystal{font-size:2rem;font-weight:900;color:var(--c-gold);font-family:var(--f-display);margin-bottom:var(--sp-sm)}
.quiz-result-el{display:flex;gap:var(--sp-sm);justify-content:center;margin-bottom:var(--sp-md)}
.quiz-result-desc{color:var(--c-text);line-height:1.6;margin-bottom:var(--sp-sm)}
.quiz-result-actions{display:flex;gap:var(--sp-sm);justify-content:center;flex-wrap:wrap}
.quiz-bazi-note{background:rgba(212,175,55,0.06);border:1px solid rgba(212,175,55,0.2);border-radius:var(--r-md);padding:var(--sp-sm) var(--sp-md);margin:var(--sp-md) 0;font-size:0.85rem;color:var(--c-text-dim);line-height:1.5}
.quiz-bazi-note strong{color:var(--c-gold)}
.quiz-bazi-match{background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.2);border-radius:var(--r-md);padding:var(--sp-sm) var(--sp-md);margin:var(--sp-md) 0;font-size:0.85rem;color:rgba(74,222,128,0.9);line-height:1.5}
.quiz-bazi-match strong{color:#4ade80}
.review-carousel{min-height:120px;transition:opacity 0.3s}
.review-card{border:1px solid rgba(212,175,55,0.12);border-radius:var(--r-md);padding:var(--sp-md);background:rgba(0,0,0,0.15)}
.review-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-sm);flex-wrap:wrap;gap:var(--sp-xs)}
.review-stars{font-size:0.85rem}
.review-meta{font-size:0.75rem;color:var(--c-text-muted)}
.review-text{color:var(--c-text);line-height:1.6;font-size:0.9rem;margin-bottom:var(--sp-sm)}
.review-product{display:flex;justify-content:flex-end}
.extra-nav{display:flex;gap:var(--sp-xs);overflow-x:auto;padding:var(--sp-sm) 0;margin:var(--sp-lg) 0 var(--sp-sm);border-bottom:1px solid rgba(255,255,255,0.06);-webkit-overflow-scrolling:touch}
.nav-extra-tab{padding:0.5rem 1rem;border-radius:var(--r-pill);font-size:0.82rem;white-space:nowrap;border:1px solid rgba(255,255,255,0.06);background:none;color:var(--c-text-dim);cursor:pointer;transition:all 0.3s}
.nav-extra-tab.active{background:rgba(212,175,55,0.1);color:var(--c-gold);border-color:rgba(212,175,55,0.3)}
.extra-section{padding:var(--sp-md) 0}
.extra-section.hidden{display:none}

/* ── Games ── */
.game-progress{text-align:center;font-size:0.85rem;color:var(--c-gold);margin-bottom:var(--sp-md)}
.game-question{text-align:center;font-size:1.15rem;margin-bottom:var(--sp-lg);line-height:1.5}
.game-options{display:flex;flex-wrap:wrap;gap:var(--sp-sm);justify-content:center}
.game-opt{padding:0.7rem 1.2rem;border:1px solid rgba(255,255,255,0.1);border-radius:var(--r-md);background:rgba(0,0,0,0.2);color:var(--c-text);cursor:pointer;font-size:0.95rem;transition:all 0.3s;min-width:60px}
.game-opt:hover{border-color:rgba(212,175,55,0.4);background:rgba(212,175,55,0.06)}
.game-opt.correct{border-color:#4ade80!important;background:rgba(34,197,94,0.15)!important;color:#4ade80!important}
.game-opt.wrong{border-color:#f87171!important;background:rgba(239,68,68,0.15)!important;color:#f87171!important}
.game-feedback{text-align:center;margin-top:var(--sp-md);font-size:1rem;min-height:1.5em}
.fb-correct{color:#4ade80}.fb-wrong{color:#f87171}
.game-result{text-align:center;padding:var(--sp-lg)}
.game-result-icon{font-size:3rem;margin-bottom:var(--sp-sm)}
.game-score-big{font-size:2.5rem;font-weight:900;color:var(--c-gold);margin:var(--sp-sm) 0}
.game-actions{display:flex;gap:var(--sp-sm);justify-content:center}
.zodiac-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:var(--sp-xs)}
.zodiac-btn{display:flex;flex-direction:column;align-items:center;padding:var(--sp-sm);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);background:none;color:var(--c-text);cursor:pointer;transition:all 0.3s}
.zodiac-btn:hover,.zodiac-btn.selected{border-color:var(--c-gold);background:rgba(212,175,55,0.08)}
.zodiac-icon{font-size:1.5rem}.zodiac-name{font-size:0.7rem;margin-top:2px}
.zodiac-selected{text-align:center;font-size:1.2rem;min-height:1.5em}
.zodiac-result{text-align:center;padding:var(--sp-lg)}
.zodiac-pair-icons{font-size:2.5rem;margin-bottom:var(--sp-sm)}
.zodiac-match-score{font-size:2rem;font-weight:900;color:var(--c-gold)}
.zodiac-match-level{font-size:1.1rem;color:var(--c-text);margin-bottom:var(--sp-sm)}
.lucky-card{padding:var(--sp-lg)}
.lucky-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-md)}
.lucky-item{text-align:center;padding:var(--sp-md);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);background:rgba(0,0,0,0.1)}
.lucky-label{font-size:0.75rem;color:var(--c-text-muted);margin-bottom:var(--sp-xs)}
.lucky-value{font-size:1.1rem;font-weight:700;color:var(--c-text);display:flex;align-items:center;justify-content:center;gap:var(--sp-xs)}
.lucky-num{font-size:2rem;color:var(--c-gold)}
.lucky-sub{font-size:0.7rem;color:var(--c-text-dim);margin-top:2px}
.lucky-color-dot{width:16px;height:16px;border-radius:50%;display:inline-block;border:1px solid rgba(255,255,255,0.2)}
@media(max-width:640px){.zodiac-grid{grid-template-columns:repeat(4,1fr)}}

/* Tarot card generated images */
.tc-img{width:100%;height:auto;border-radius:4px;display:block;margin-bottom:4px}
.t-card-face.t-front{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4px}
.t-card-face.t-front .tc-name{font-size:0.7rem;margin-top:2px}
.tc-spread-img{box-shadow:0 2px 8px rgba(0,0,0,0.3);border:1px solid rgba(212,175,55,0.3)}

.yao-visual{display:flex;flex-direction:column;gap:5px;padding:8px 0;width:70px;margin:0 auto}
.yao-row{display:flex;align-items:center;justify-content:center;height:8px;gap:0}
.yao-dong{filter:drop-shadow(0 0 3px rgba(232,201,104,0.5))}
</style>
</head>
<body>
<nav class="nav"><div class="nav-inner">
  <div class="nav-brand"><i class="fas fa-moon"></i><span>靜月之光 v3.0</span></div>
  <div class="nav-links">
    <button class="nav-link active" onclick="goStep(0)">輸入</button>
    <button class="nav-link" onclick="goStep(1)">梅花</button>
    <button class="nav-link" onclick="goStep(2)">塔羅</button>
    <button class="nav-link" onclick="goStep(3)">結果</button>
  </div>
  <div class="nav-shop">
    <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer">🛒 蝦皮</a>
    <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer">📦 7-11</a>
  </div>
</div></nav>

<div class="app">

<!-- ========== STEP 0: INPUT ========== -->
<section class="step active" id="step-0">
  <div class="hero">
    <div class="hero-icon">☽</div>
    <h1>你的命盤，藏著答案</h1>
    <p style="font-size:1rem;line-height:1.7;max-width:480px;margin:0 auto var(--sp-md)">感情卡關？事業迷茫？不確定下一步該怎麼走？<br>輸入出生資料，<strong style="color:var(--c-gold)">10 秒內</strong>告訴你答案。</p>
    <div style="display:flex;justify-content:center;gap:var(--sp-md);flex-wrap:wrap;margin-bottom:var(--sp-md)">
      <span class="tag tag-gold" style="font-size:.85rem;padding:.4rem .8rem">免費 · 10 秒出結果</span>
      <span class="tag" style="font-size:.85rem;padding:.4rem .8rem;border:1px solid var(--c-border);color:var(--c-text-dim)">八字 · 紫微 · 梅花 · 塔羅 · 姓名</span>
    </div>
    <div style="background:rgba(0,0,0,.2);border-radius:var(--r-md);padding:var(--sp-sm) var(--sp-md);display:inline-flex;gap:var(--sp-md);flex-wrap:wrap;justify-content:center;font-size:.82rem;color:var(--c-text-dim)">
      <span>❝ 超準，點出我的盲點 ❞</span>
      <span>❝ 分析比算命師還細 ❞</span>
      <span>❝ 分享給全辦公室了 ❞</span>
    </div>
  </div>
  <div class="stepper" id="main-stepper">
    <div class="stepper-item active"><div class="stepper-dot">1</div><span>填資料</span></div><div class="stepper-line"></div>
    <div class="stepper-item"><div class="stepper-dot">2</div><span>看結果</span></div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-question-circle"></i> 你的問題</div>
    <div class="form-group">
      <label class="form-label">問題類型 <span class="req">*</span></label>
      <select class="form-select" id="f-type"><option value="">請選擇方向</option>
        <option value="love">💕 感情 / 桃花 / 婚姻</option>
        <option value="career">💼 事業 / 工作 / 學業</option>
        <option value="wealth">💰 財運 / 投資 / 收入</option>
        <option value="health">🏥 健康 / 身體 / 心理</option>
        <option value="relationship">🤝 人際 / 社交 / 合作</option>
        <option value="family">🏠 家庭 / 親子 / 長輩</option></select>
    </div>
    <div class="form-group">
      <label class="form-label">你現在最想問的一件事 <span class="req">*</span></label>
      <textarea class="form-textarea" id="f-question" placeholder="例：我今年適合轉職嗎？" maxlength="500"></textarea>
      <div class="form-hint"><span id="f-char">0</span>/500</div>
    </div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-user"></i> 出生資料</div>
    <div class="form-group">
      <label class="form-label">性別 <span class="req">*</span></label>
      <div class="radio-pills">
        <label class="radio-pill"><input type="radio" name="gender" value="male"><span>男</span></label>
        <label class="radio-pill"><input type="radio" name="gender" value="female"><span>女</span></label>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">出生日期（國曆）<span class="req">*</span></label>
      <input type="date" class="form-input" id="f-bdate">
    </div>
    <div class="form-group">
      <label class="form-label">出生時間</label>
      <input type="time" class="form-input" id="f-btime">
      <div class="form-hint">不確定可留空，系統以 12:00 估算</div>
    </div>
    <div class="form-group">
      <label class="form-label">姓名（選填）</label>
      <input type="text" class="form-input" id="f-name" placeholder="用於姓名學分析">
    </div>
  </div>
  <div class="actions actions-center" style="flex-direction:column;gap:var(--sp-sm)">
    <button class="btn btn-primary btn-lg" onclick="submitStep0Fast()"><i class="fas fa-bolt"></i> 立即看結果</button>
    <button class="btn btn-outline btn-sm" onclick="submitStep0()" style="opacity:0.7"><i class="fas fa-sliders-h"></i> 進階：手動起卦＋抽牌</button>
  </div>
</section>

<!-- ========== STEP 1: MEIHUA ========== -->
<section class="step" id="step-1">
  <div class="card">
    <div class="card-title"><i class="fas fa-yin-yang"></i> 梅花易數起卦</div>
    <div style="display:flex;gap:var(--sp-sm);flex-wrap:wrap;margin-bottom:var(--sp-md)">
      <button class="btn btn-sm btn-tab-active" id="mh-m-time" onclick="setMhMethod('time')"><i class="fas fa-clock"></i> 時間</button>
      <button class="btn btn-sm btn-outline" id="mh-m-number" onclick="setMhMethod('number')"><i class="fas fa-sort-numeric-up"></i> 數字</button>
      <button class="btn btn-sm btn-outline" id="mh-m-char" onclick="setMhMethod('char')"><i class="fas fa-font"></i> 漢字</button>
      <button class="btn btn-sm btn-outline" id="mh-m-random" onclick="setMhMethod('random')"><i class="fas fa-dice"></i> 隨機</button>
    </div>
    <div id="mhf-time"><p class="text-dim text-sm mb-md">按下按鈕自動以當前時間起卦</p><button class="btn btn-primary" onclick="calcMhTime()"><i class="fas fa-calculator"></i> 時間起卦</button></div>
    <div id="mhf-number" class="hidden">
      <div class="form-group"><label class="form-label">上卦數字 (1-999)</label><input type="number" class="form-input" id="mh-n1" min="1" max="999"></div>
      <div class="form-group"><label class="form-label">下卦數字 (1-999)</label><input type="number" class="form-input" id="mh-n2" min="1" max="999"></div>
      <div class="form-group"><label class="form-label">動爻 (1-6)</label><input type="number" class="form-input" id="mh-n3" min="1" max="6"></div>
      <button class="btn btn-primary" onclick="calcMhNumber()"><i class="fas fa-calculator"></i> 數字起卦</button>
    </div>
    <div id="mhf-char" class="hidden">
      <div class="form-group"><label class="form-label">輸入漢字 (1-3個)</label><input type="text" class="form-input" id="mh-char" placeholder="如：感情" maxlength="3"></div>
      <button class="btn btn-primary" onclick="calcMhChar()"><i class="fas fa-calculator"></i> 漢字起卦</button>
    </div>
    <div id="mhf-random" class="hidden"><p class="text-dim text-sm mb-md">心誠則靈，隨機產生卦象</p><button class="btn btn-primary" onclick="calcMhRandom()"><i class="fas fa-dice"></i> 隨機起卦</button></div>
  </div>
  <div id="mh-result" class="hidden">
    <div class="card">
      <div class="hex-grid">
        <div class="hex-card"><h4>本卦</h4><div class="hex-sym" id="mh-ben-s"></div><div class="hex-name" id="mh-ben-n"></div></div>
        <div class="hex-card"><h4>互卦</h4><div class="hex-sym" id="mh-hu-s"></div><div class="hex-name" id="mh-hu-n"></div></div>
        <div class="hex-card"><h4>變卦</h4><div class="hex-sym" id="mh-bian-s"></div><div class="hex-name" id="mh-bian-n"></div></div>
      </div>
      <div class="divider"></div>
      <div id="mh-detail" class="text-sm"></div>
    </div>
  </div>
  <div class="actions">
    <button class="btn btn-outline" onclick="goStep(0)"><i class="fas fa-arrow-left"></i> 上一步</button>
    <button class="btn btn-outline" onclick="goStep(2)"><i class="fas fa-forward"></i> 跳過</button>
    <button class="btn btn-primary" onclick="goStep(2)"><i class="fas fa-arrow-right"></i> 下一步：塔羅牌</button>
  </div>
  <p class="text-xs text-muted mt-xs" style="text-align:center"><i class="fas fa-info-circle"></i> 跳過梅花或塔羅不影響八字分析，但會降低交叉驗證權重</p>
</section>

<!-- ========== STEP 2: TAROT ========== -->
<section class="step" id="step-2">
  <div class="card">
    <div class="card-title"><i class="fas fa-star"></i> 金色黎明塔羅牌</div>
    <p class="text-dim text-sm mb-md">點擊抽牌，共需 10 張。剩餘：<strong id="t-remain">10</strong> 張</p>
    <div class="text-center">
      <button class="btn btn-gold btn-lg" id="btn-draw" onclick="drawCard()"><i class="fas fa-hand-pointer"></i> 抽一張牌</button>
      <button class="btn btn-outline btn-sm" onclick="autoDraw()" style="margin-left:var(--sp-sm)"><i class="fas fa-bolt"></i> 快速全抽</button>
    </div>
    <div class="tarot-hand" id="t-hand"></div>
  </div>
  <div id="t-spread-sec" class="hidden"><div class="card"><div class="card-title"><i class="fas fa-cross"></i> 凱爾特十字牌陣</div><div id="t-spread"></div></div></div>
  <div class="actions">
    <button class="btn btn-outline" onclick="goStep(1)"><i class="fas fa-arrow-left"></i> 上一步</button>
    <button class="btn btn-outline" onclick="skipToResult()"><i class="fas fa-forward"></i> 跳過塔羅</button>
    <button class="btn btn-primary" id="btn-analyze" onclick="goStep(3)" disabled><i class="fas fa-chart-bar"></i> 進行分析</button>
  </div>
  <p class="text-xs text-muted mt-xs" style="text-align:center"><i class="fas fa-info-circle"></i> 跳過塔羅不影響八字分析，但會降低交叉驗證權重</p>
</section>

<!-- ========== STEP 3: RESULT ========== -->
<section class="step" id="step-3">
  <!-- 🎯 大判定 -->
  <div class="result-verdict" id="r-verdict">
    <div class="verdict-label" id="r-vlabel">分析中…</div>
    <div class="verdict-prob" id="r-vprob">0%</div>
    <div class="verdict-note" id="r-vnote"></div>
  </div>

  <!-- 🎯 直接回答你的問題 -->
  <div class="card"><div class="card-title"><i class="fas fa-bullseye"></i> 直接回答</div>
    <div id="r-question" class="text-dim mb-md"></div>
    <div id="r-answer" class="serif" style="font-size:1.05rem;line-height:1.8"></div>
    <div class="divider"></div><div id="r-factors"></div><div id="r-suggest" class="mt-md"></div>
  </div>

  <!-- ☯ 五行能量分析 -->
  <div class="card remedy-alert" id="remedy-alert">
    <div class="remedy-alert-header">
      <div class="remedy-icon" id="remedy-icon">☯</div>
      <div>
        <h3 class="remedy-title" id="remedy-title">你的五行能量分佈</h3>
        <p class="remedy-subtitle" id="remedy-subtitle">了解能量場特質，找到最適合的提升方向</p>
      </div>
    </div>
    <div id="remedy-diagnosis" class="remedy-diagnosis"></div>
    <div class="remedy-arrow">
      <i class="fas fa-arrow-down" style="color:var(--c-gold);font-size:1.2rem"></i>
      <span class="text-sm text-gold">以下是為你量身打造的能量優化建議</span>
      <i class="fas fa-arrow-down" style="color:var(--c-gold);font-size:1.2rem"></i>
    </div>
  </div>

  <!-- 💎 改運處方（具體行動）-->
  <div class="card remedy-plan" id="remedy-plan">
    <div class="card-title"><i class="fas fa-wand-magic-sparkles"></i> 你的能量優化方案</div>
    <div id="remedy-actions" class="remedy-actions"></div>
  </div>

  <!-- 🛒 水晶推薦 + 賣場 -->
  <div class="card" style="border:2px solid var(--c-gold);background:linear-gradient(135deg,rgba(30,12,12,0.95),rgba(20,8,8,0.98));position:relative;overflow:hidden">
    <div style="position:absolute;top:0;right:0;background:var(--c-gold);color:var(--c-bg-deep);padding:4px 16px;font-size:.7rem;font-weight:700;border-radius:0 0 0 12px">命理處方箋</div>
    <div class="card-title" style="font-size:1.2rem;margin-top:var(--sp-sm)"><i class="fas fa-file-medical"></i> 能量水晶處方 — 依你命盤精選</div>
    <div style="display:flex;gap:var(--sp-md);flex-wrap:wrap;margin-bottom:var(--sp-md);padding:var(--sp-sm);background:rgba(0,0,0,.2);border-radius:var(--r-sm);border-left:3px solid var(--c-gold)">
      <div class="text-xs"><span class="text-dim">分析師：</span><span class="text-gold">靜月之光</span></div>
      <div class="text-xs"><span class="text-dim">處方日期：</span><span id="rx-date" class="text-gold"></span></div>
      <div class="text-xs"><span class="text-dim">有效期：</span><span class="text-gold">長期適用</span></div>
    </div>
    <div id="r-crystal"></div>
  </div>
  <div class="card shop-card">
    <div class="card-title"><i class="fas fa-shopping-bag"></i> 想把結果做成「專屬五行手鏈」？我幫你配到位</div>
    <p class="text-sm text-dim mb-md">依你結果的喜用神，給你 3 個實用搭配（可直接下單）</p>
    <div id="shop-social-proof" style="padding:var(--sp-sm) var(--sp-md);background:rgba(212,175,55,.06);border-radius:var(--r-sm);margin-bottom:var(--sp-md);border:1px solid rgba(212,175,55,.15)">
      <div style="display:flex;align-items:center;gap:var(--sp-sm);margin-bottom:4px">
        <span style="color:var(--c-gold);font-size:.8rem">⭐⭐⭐⭐⭐</span>
        <span class="text-xs text-muted" id="shop-review-meta"></span>
      </div>
      <p class="text-sm" style="color:var(--c-text-dim);margin:0;line-height:1.5">「<span id="shop-review-text"></span>」</p>
      <div style="text-align:right;margin-top:4px"><span class="text-xs text-muted" id="shop-review-product"></span></div>
    </div>
    <div class="shop-btns">
      <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer" class="shop-btn-card shopee">
        <i class="fas fa-shopping-cart"></i>
        <div><strong>🛒 立即選購・全館免運</strong><span class="text-xs">關注再享 9 折</span></div>
      </a>
      <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer" class="shop-btn-card seven">
        <i class="fas fa-box"></i>
        <div><strong>📦 7-11 取貨・滿千免運</strong><span class="text-xs">多件合併寄送</span></div>
      </a>
      <button class="shop-btn-card custom" onclick="openCustomModal()">
        <i class="fas fa-magic"></i>
        <div><strong>🧿 客製五行手鏈方案</strong><span class="text-xs">$1,000 起・48hr 回覆</span></div>
      </button>
    </div>

  </div>

  <!-- 📊 可能性評估 (可收合) -->
  <div class="card collapsible-card">
    <div class="card-title collapsible-toggle" onclick="toggleCollapse(this)">
      <span><i class="fas fa-chart-line"></i> 可能性評估</span>
      <i class="fas fa-chevron-down collapse-arrow"></i>
    </div>
    <div class="collapsible-body">
      <div class="prob-meter"><div class="prob-bar"><div class="prob-fill" id="r-pfill" style="width:0%"></div></div>
      <div class="prob-labels"><span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span></div></div>
      <div id="r-pbreak" class="mt-md text-sm"></div>
    </div>
  </div>

  <!-- 📋 命理詳解 (可收合) -->
  <div class="card collapsible-card">
    <div class="card-title collapsible-toggle" onclick="toggleCollapse(this)">
      <span><i class="fas fa-scroll"></i> 命理詳細分析</span>
      <i class="fas fa-chevron-down collapse-arrow"></i>
    </div>
    <div class="collapsible-body" style="padding:0;overflow:visible">
      <div class="dim-tabs">
        <button class="dim-tab active" onclick="showDim('bazi')">八字命理</button>
        <button class="dim-tab" onclick="showDim('ziwei')">紫微斗數</button>
        <button class="dim-tab" onclick="showDim('meihua')">梅花易數</button>
        <button class="dim-tab" onclick="showDim('tarot')">塔羅牌陣</button>
        <button class="dim-tab" onclick="showDim('name')">姓名學</button>
      </div>
      <div class="dim-pane active" id="pane-bazi">
        <h4 class="text-gold mb-md serif">四柱八字命盤</h4><div id="d-bazi"></div>
        <div class="divider"></div><h4 class="text-gold mb-md serif">五行分佈</h4><div id="d-elbar"></div>
        <div class="divider"></div><h4 class="text-gold mb-md serif">十神分析</h4><div id="d-gods" class="text-sm"></div>
        <div class="divider"></div><h4 class="text-gold mb-md serif">藏干詳解</h4><div id="d-canggan" class="text-sm"></div>
        <div class="divider"></div><h4 class="text-gold mb-md serif">喜用神與忌神</h4><div id="d-xiyong" class="text-sm"></div>
        <div class="divider"></div><h4 class="text-gold mb-md serif">大運流年</h4><div id="d-dayun"></div>
      </div>
      <div class="dim-pane" id="pane-ziwei">
        <h4 class="text-gold mb-md serif">紫微斗數命盤</h4>
        <div id="d-ziwei-info" class="text-sm mb-md"></div>
        <div id="d-ziwei-grid"></div>
        <div class="divider"></div>
        <h4 class="text-gold mb-md serif">四化飛星</h4>
        <div id="d-ziwei-sihua" class="text-sm"></div>
        <div class="divider"></div>
        <h4 class="text-gold mb-md serif">命盤解讀</h4>
        <div id="d-ziwei-reading" class="text-sm"></div>
      </div>
      <div class="dim-pane" id="pane-meihua"><div id="r-meihua"></div></div>
      <div class="dim-pane" id="pane-tarot"><div id="r-tarot"></div></div>
      <div class="dim-pane" id="pane-name">
        <h4 class="text-gold mb-md serif">姓名學分析（三才五格）</h4>
        <div id="d-name"></div>
      </div>
    </div>
  </div>

  <!-- 📝 總結 (可收合) -->
  <div class="card collapsible-card">
    <div class="card-title collapsible-toggle" onclick="toggleCollapse(this)">
      <span><i class="fas fa-moon"></i> 靜月分析師總結</span>
      <i class="fas fa-chevron-down collapse-arrow"></i>
    </div>
    <div class="collapsible-body">
      <div id="r-conclusion" class="text-sm" style="line-height:1.8"></div>
    </div>
  </div>

  <!-- 存圖分享 -->
  <div class="card" style="text-align:center">
    <div class="card-title"><i class="fas fa-share-alt"></i> 分享你的占卜結果</div>
    <p class="text-sm text-dim mb-md">存成圖片分享到 IG / LINE，朋友也能免費測！</p>
    <div class="actions actions-center" style="gap:var(--sp-md);flex-wrap:wrap">
      <button class="btn-save-card" onclick="saveResultCard()"><i class="fas fa-download"></i> 存圖分享</button>
      <button class="btn btn-outline" onclick="printResult()"><i class="fas fa-print"></i> 列印</button>
    </div>
  </div>

  <!-- 再測一次 + 分享獎勵 -->
  <div class="card mt-lg" id="share-gate" style="text-align:center">
    <h4 style="margin-bottom:var(--sp-sm)">🔄 想再測一次？</h4>
    <button class="btn btn-gold btn-full" onclick="retestAfterShare()" style="max-width:320px;margin:0 auto var(--sp-md)"><i class="fas fa-redo"></i> 重新開始新的占卜</button>
    <div style="border-top:1px solid var(--c-border);padding-top:var(--sp-md);margin-top:var(--sp-sm)">
      <p class="text-sm text-dim">🎁 分享給朋友可獲得專屬折扣碼</p>
      <button class="btn btn-outline btn-sm mt-sm" onclick="shareToUnlock()"><i class="fas fa-paper-plane"></i> 分享並取得折扣碼</button>
    </div>
  </div>
  <!-- 折扣碼（分享後顯示） -->
  <div class="discount-reveal hidden mt-lg" id="discount-reveal">
    <h4 style="color:var(--c-gold);margin-bottom:var(--sp-sm)">🍁 感謝分享！你的專屬折扣碼：</h4>
    <div class="discount-code" id="discount-code">•••••••••</div>
    <p class="text-sm mt-sm" id="discount-timer" style="color:var(--c-gold)"></p>
    <p class="text-sm text-dim mt-xs">蝦皮下單時輸入此碼享 <strong style="color:var(--c-gold)">9折優惠</strong></p>
    <button class="btn btn-outline btn-sm mt-sm" onclick="copyDiscountCode()"><i class="fas fa-copy"></i> 複製折扣碼</button>
    <div class="mt-md">
      <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener" class="btn btn-gold"><i class="fas fa-shopping-cart"></i> 立即前往蝦皮選購</a>
    </div>
  </div>
  <div class="actions actions-center mt-lg hidden" id="btn-retest">
    <button class="btn btn-gold btn-full" onclick="retestAfterShare()" style="max-width:320px"><i class="fas fa-redo"></i> 重新開始新的占卜</button>
  </div>
  <!-- 7天提醒 -->
  <div class="text-center mt-lg">
    <button class="btn-remind" id="btn-remind" onclick="addReminder7Days()"><i class="fas fa-bell"></i> 7天後提醒我再測一次</button>
    <p class="text-xs text-muted mt-xs">會下載 .ics 日曆檔，自動加入手機行事曆</p>
  </div>

  <!-- 趣味功能（結果頁底部，看完結果才看到） -->
  <div class="card mt-lg" style="text-align:center;border-style:dashed;opacity:0.85">
    <p class="text-dim" style="margin-bottom:var(--sp-sm)">🎮 看完結果了？來玩點有趣的</p>


  <div class="daily-mini" style="margin:0 0 var(--sp-sm) 0">
    <div class="daily-mini-toggle" onclick="this.parentElement.classList.toggle('open');if(!this._init){initExtraFeatures();this._init=true}">
      <span><i class="fas fa-magic"></i> 趣味功能：運勢籤 · 水晶配對 · 五行問答...</span>
      <i class="fas fa-chevron-down daily-mini-arrow"></i>
    </div>
    <div class="daily-mini-body">
      <div style="padding:var(--sp-sm) var(--sp-md)">
        <div class="extra-nav">
    <button class="nav-extra-tab active" data-target="sec-daily-fortune">🍰 每日運勢</button>
    <button class="nav-extra-tab" data-target="sec-crystal-quiz">🧪 水晶配對</button>
    <button class="nav-extra-tab" data-target="sec-wuxing-game">🍯 五行問答</button>
    <button class="nav-extra-tab" data-target="sec-zodiac">💑 生肖配對</button>
    <button class="nav-extra-tab" data-target="sec-lucky">🍀 今日幸運</button>
    <button class="nav-extra-tab" data-target="sec-encyclopedia">📖 水晶百科</button>
    <button class="nav-extra-tab" data-target="sec-achievements">🏆 成就徽章</button>
    <button class="nav-extra-tab" data-target="sec-reviews">💬 使用者好評</button>
  </div>

  <!-- 每日運勢籤 (收合式) -->
  <div class="extra-section" id="sec-daily-fortune">
    <div class="daily-mini" id="daily-mini-wrap">
      <div class="daily-mini-toggle" onclick="this.parentElement.classList.toggle('open')">
        <span><i class="fas fa-sun"></i> 每日運勢籤 — 免費抽一次</span>
        <i class="fas fa-chevron-down daily-mini-arrow"></i>
      </div>
      <div class="daily-mini-body">
        <div style="padding:var(--sp-md)">
          <div id="daily-fortune-content"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 水晶配對測驗 -->
  <div class="extra-section hidden" id="sec-crystal-quiz">
    <div class="card">
      <div class="card-title"><i class="fas fa-flask"></i> 找出你的命定水晶</div>
      <p class="text-sm text-dim mb-md">3 道直覺題，30 秒找到最適合你的水晶（每次題目不同！）</p>
      <div id="crystal-quiz-content">
        <div class="text-center">
          <button class="btn btn-gold" onclick="startCrystalQuiz()"><i class="fas fa-play"></i> 開始測驗</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 五行問答遊戲 -->
  <div class="extra-section hidden" id="sec-wuxing-game">
    <div class="card">
      <div class="card-title"><i class="fas fa-gamepad"></i> 五行命理問答挑戰</div>
      <p class="text-sm text-dim mb-md">5 題隨機出題，測試你的命理知識！</p>
      <div id="wuxing-game-content">
        <div class="text-center">
          <button class="btn btn-gold" onclick="startWuxingGame()"><i class="fas fa-play"></i> 開始挑戰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 生肖配對 -->
  <div class="extra-section hidden" id="sec-zodiac">
    <div class="card">
      <div class="card-title"><i class="fas fa-heart"></i> 生肖配對測試</div>
      <div id="zodiac-match-content"></div>
    </div>
  </div>

  <!-- 今日幸運 -->
  <div class="extra-section hidden" id="sec-lucky">
    <div class="card">
      <div class="card-title"><i class="fas fa-clover"></i> 今日幸運指南</div>
      <div id="lucky-gen-content"></div>
    </div>
  </div>

  <!-- 水晶百科 -->
  <div class="extra-section hidden" id="sec-encyclopedia">
    <div class="card">
      <div class="card-title"><i class="fas fa-book"></i> 水晶百科圖鑑</div>
      <p class="text-sm text-dim mb-md">點擊任一水晶查看詳細功效與購買連結</p>
      <div class="ency-grid" id="crystal-encyclopedia-grid"></div>
    </div>
  </div>

  <!-- 成就徽章 -->
  <div class="extra-section hidden" id="sec-achievements">
    <div class="card">
      <div class="card-title"><i class="fas fa-trophy"></i> 我的成就 <span class="text-sm text-muted" id="achievement-progress">0/9 已解鎖</span></div>
      <div class="achievements-grid" id="achievements-grid"></div>
    </div>
  </div>

  <!-- 好評輪播 -->
  <div class="extra-section hidden" id="sec-reviews">
    <div class="card">
      <div class="card-title"><i class="fas fa-comments"></i> 買家真實回饋</div>
      <div id="review-carousel"></div>
      <div class="text-center mt-md">
        <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener" class="btn btn-outline btn-sm"><i class="fas fa-shopping-cart"></i> 去賣場看更多評價</a>
      </div>
    </div>
  </div>
</div>
  </div></div></div>
  </div>
</section>

</div><!-- /app -->

<!-- 客製表單 Modal -->
<div class="modal-overlay" id="custom-modal" style="display:none">
  <div class="modal-box">
    <button class="modal-close" onclick="closeCustomModal()">&times;</button>
    <h3 class="serif text-gold mb-md"><i class="fas fa-magic"></i> 能量手鏈客製服務</h3>
    <form id="custom-form" action="https://formsubmit.co/onerkk@gmail.com" method="POST" onsubmit="return prepareCustomSubmit()">
      <!-- formsubmit.co config -->
      <input type="hidden" name="_subject" id="cf-subject-hidden" value="【客製詢問】能量手鏈">
      <input type="hidden" name="_captcha" value="false">
      <input type="hidden" name="_template" value="table">
      <input type="hidden" name="_next" id="cf-next-url" value="">
      <input type="text" name="_honey" style="display:none">
      <input type="hidden" name="占卜分析摘要" id="cf-analysis-hidden" value="">
      <div class="form-group">
        <label class="form-label">姓名 <span class="req">*</span></label>
        <input type="text" class="form-input" id="cf-name" name="姓名" required placeholder="您的姓名">
      </div>
      <div class="form-group">
        <label class="form-label">出生日期 <span class="req">*</span></label>
        <input type="date" class="form-input" id="cf-bday" name="出生日期" required>
      </div>
      <div class="form-group">
        <label class="form-label">想解決的問題 <span class="req">*</span></label>
        <textarea class="form-textarea" id="cf-question" name="想解決的問題" required placeholder="例：想提升事業運、改善感情、招財等..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">預算範圍 <span class="req">*</span></label>
        <select class="form-select" id="cf-budget" name="預算範圍" required>
          <option value="">請選擇</option>
          <option value="預算版（$1,000-$3,000）">預算版（$1,000 - $3,000）</option>
          <option value="加強版（$3,000-$6,000）">加強版（$3,000 - $6,000）</option>
          <option value="收藏版（$6,000以上）">收藏版（$6,000 以上）</option>
        </select>
      </div>
      <div class="actions" style="margin-top:var(--sp-lg)">
        <button type="button" class="btn btn-outline" onclick="closeCustomModal()">取消</button>
        <button type="submit" class="btn btn-gold" id="cf-submit-btn"><i class="fas fa-paper-plane"></i> 送出詢問</button>
      </div>
      <p class="text-xs text-muted mt-md"><i class="fas fa-lock"></i> 表單直接寄到店家信箱，不經第三方儲存。首次送出後會收到確認信。</p>
      <details class="text-xs text-muted mt-sm" style="cursor:pointer">
        <summary style="color:var(--c-gold);opacity:0.7">隱私說明（點擊展開）</summary>
        <div style="margin-top:var(--sp-xs);line-height:1.8;opacity:0.8">
          <p>• <strong>收集項目：</strong>姓名、性別、出生日期時間、Email、問題描述</p>
          <p>• <strong>用途：</strong>僅用於製作客製化水晶手鏈建議及回覆詢問</p>
          <p>• <strong>保存方式：</strong>資料透過 Email 傳送，不儲存於伺服器或資料庫</p>
          <p>• <strong>刪除方式：</strong>如需刪除資料，請來信至店家信箱告知即可</p>
          <p>• <strong>占卜資料：</strong>頁面上的八字/塔羅計算皆在你的瀏覽器本地執行，不上傳任何伺服器</p>
        </div>
      </details>
    </form>
    <div id="cf-sent" class="hidden mt-lg text-center">
      <div style="font-size:2rem;margin-bottom:var(--sp-sm)">✅</div>
      <h4 class="text-gold mb-sm">詢問已送出！</h4>
      <p class="text-sm text-dim mb-md">我們會盡快透過 Email 回覆您。</p>
      <button class="btn btn-outline" onclick="closeCustomModal()"><i class="fas fa-check"></i> 關閉</button>
    </div>
  </div>
</div>

<!-- 水晶詳情 Modal -->
<div class="crystal-detail-modal hidden" id="crystal-detail-modal"></div>

<!-- PWA 安裝提示 -->
<div class="pwa-banner hidden" id="pwa-banner">
  <div class="pwa-banner-text">
    <strong>☽ 加到主畫面</strong>，隨時測運勢更方便！
  </div>
  <button class="pwa-install-btn" onclick="installPWA()">安裝</button>
  <button class="pwa-close-btn" onclick="hidePWABanner()">&times;</button>
</div>

<!-- 浮動按鈕 -->
<div class="floating-root" id="floating-root">
  <button class="fab fab-toggle" onclick="toggleFab()" aria-label="選單"><i class="fas fa-ellipsis-v"></i></button>
  <div class="fab-menu hidden" id="fab-menu">
    <a href="https://tw.shp.ee/2n5Mo2w" target="_blank" rel="noopener noreferrer" class="fab fab-shopee" title="蝦皮逛逛"><i class="fas fa-shopping-cart"></i><span>蝦皮</span></a>
    <a href="https://myship.7-11.com.tw/seller/profile?id=GM2601091690232" target="_blank" rel="noopener noreferrer" class="fab fab-711" title="賣貨便"><i class="fas fa-box"></i><span>7-11</span></a>
    <button class="fab fab-custom" onclick="openCustomModal()" title="客製"><i class="fas fa-magic"></i><span>客製</span></button>
  </div>
</div>
<script>
/* =============================================================
   GLOBAL STATE
   ============================================================= */
const S = { step:0, form:{}, bazi:null, meihua:null, tarot:{drawn:[],spread:[]}, ziwei:null };

/* =============================================================
   NAVIGATION
   ============================================================= */
/* Collapsible toggle */
function toggleCollapse(el){
  const card=el.closest('.collapsible-card');
  if(card) card.classList.toggle('open');
}

/* ═══ REMEDY: 五行能量分析 + 優化建議 ═══ */
function renderRemedy(bazi,type){
  const ep=bazi.ep||{}, dm=bazi.dm, el=bazi.dmEl, strong=bazi.strong;
  const fav=bazi.fav||[], unfav=bazi.unfav||[];
  const tot=Object.values(ep).reduce((a,b)=>a+b,0)||60;

  // ── 五行狀態診斷 ──
  const EL_NAMES={金:'金',木:'木',水:'水',火:'火',土:'土'};
  const EL_COLORS={金:'#c0c0c0',木:'#4caf50',水:'#42a5f5',火:'#ff5722',土:'#ff9800'};
  const states=bazi.wxStates||{};

  let diagHTML='';
  ['木','火','土','金','水'].forEach(e=>{
    const v=ep[e]||0;
    const pct=Math.round(v/tot*100);
    const ideal=20; // 平衡=20%
    const diff=pct-ideal;
    let tag,tagClass;
    if(pct<=8){tag='待補充';tagClass='diag-tag-lack';}
    else if(pct<=14){tag='偏弱';tagClass='diag-tag-lack';}
    else if(pct<=26){tag='正常';tagClass='diag-tag-ok';}
    else if(pct<=35){tag='偏旺';tagClass='diag-tag-excess';}
    else{tag='偏強';tagClass='diag-tag-excess';}

    const state=states[e]||'';
    diagHTML+=`<div class="diag-row">
      <span class="diag-label" style="color:${EL_COLORS[e]}">${e} ${state}</span>
      <div class="diag-bar-wrap"><div class="diag-bar" style="width:${Math.min(pct*2,100)}%;background:${EL_COLORS[e]}"></div></div>
      <span class="diag-value" style="color:${EL_COLORS[e]}">${Math.round(v)}分</span>
      <span class="diag-tag ${tagClass}">${tag}</span>
    </div>`;
  });

  // ── 能量分析標題 ──
  const weakEls=Object.entries(ep).filter(([e,v])=>(v/tot)<0.12).map(([e])=>e);
  const strongEls=Object.entries(ep).filter(([e,v])=>(v/tot)>0.33).map(([e])=>e);
  const alertEl=document.getElementById('remedy-alert');

  let icon='🔮', title='', subtitle='';
  if(weakEls.length>=2){
    icon='🔮';title=`你的${weakEls.join('、')}行能量較薄弱`;
    subtitle='補充對應頻率的能量，有助於整體運勢提升';
  }else if(weakEls.length===1){
    icon='🔮';title=`發現「${weakEls[0]}行」能量偏弱`;
    subtitle='適當補充可以讓這個面向更順暢';
  }else if(strongEls.length){
    icon='💡';title=`你的${strongEls.join('、')}行能量充沛`;
    subtitle='適度引導分散，讓整體能量更均衡';
  }else{
    icon='✨';title='你的五行能量分佈均衡';
    subtitle='體質很好，小幅優化就能更上一層樓';
  }

  document.getElementById('remedy-icon').textContent=icon;
  document.getElementById('remedy-title').textContent=title;
  document.getElementById('remedy-subtitle').textContent=subtitle;
  document.getElementById('remedy-diagnosis').innerHTML=diagHTML;

  // ── 改運處方 ──
  const actions=[];
  const TYPE_LABELS={love:'感情',career:'事業',wealth:'財運',health:'健康',general:'整體運勢',relationship:'人際',family:'家庭'};
  const typeLabel=TYPE_LABELS[type]||'運勢';

  // 處方1: 五行補強（依喜用神，含命理解釋）
  const mainFav=fav[0]||'土';
  const mainUnfav=unfav[0]||'';
  const dmEl=bazi.dmEl;
  const isStrong=bazi.strong;
  
  /* 生成命理原因說明（優先調候，次用通用） */
  function explainWhy(dm, fav1, unfav1, strong){
    /* 如果有調候結果，優先使用 */
    if(bazi.tiaohou){
      const th=bazi.tiaohou;
      return `<strong>【${th.reason}】</strong>${th.detail}<br><br>${th.needReason}`;
    }
    /* 通用解釋 */
    if(strong){
      return `你是「${dm}」日主，身強，自身能量充沛。需要 <strong>${fav1}行</strong> 來洩掉多餘的力量，讓能量流動起來，才不會鬱積。`;
    }else{
      const keEl = BE_KE[dm];
      const shengEl = BE_SHENG[dm];
      if(fav1 === shengEl){
        return `你是「${dm}」日主，身弱，命盤中「${keEl}行」（壓力/管束）偏旺。需要 <strong>${fav1}行</strong> 作為救星 —— ${fav1}能洩掉${keEl}的銳氣，再轉而生${dm}（${keEl}→${fav1}→${dm}，這叫「殺印相生」）。`;
      }else{
        return `你是「${dm}」日主，身弱，需要 <strong>${fav1}行</strong> 來幫扶自身力量，讓你站穩腳步。`;
      }
    }
  }
  
  const favCrystals={
    金:{stone:'白水晶 / 鈦晶',color:'白色、金色、銀色',dir:'正西方',food:'白色食物（白蘿蔔、豆腐、百合）'},
    木:{stone:'綠幽靈 / 東陵玉',color:'綠色、青色',dir:'正東方',food:'綠色蔬果（花椰菜、奇異果、菠菜）'},
    水:{stone:'黑曜石 / 海藍寶 / 黑髮晶',color:'藍色、黑色',dir:'正北方',food:'黑色食物（黑芝麻、海帶、藍莓）'},
    火:{stone:'紅瑪瑙 / 石榴石',color:'紅色、紫色',dir:'正南方',food:'紅色食物（紅棗、枸杞、番茄）'},
    土:{stone:'黃水晶 / 虎眼石',color:'黃色、棕色',dir:'中央/東北',food:'黃色食物（南瓜、玉米、薑黃）'}
  };
  const fc=favCrystals[mainFav]||favCrystals['土'];
  const whyText=explainWhy(dmEl, mainFav, mainUnfav, isStrong);
  
  actions.push({
    title:`你的命格需要「${mainFav}行」能量`,
    desc:`${whyText}<br><br>日常多穿 <strong>${fc.color}</strong> 系服飾，居家或辦公 <strong>${fc.dir}</strong> 方位擺放水晶，飲食多攝取${fc.food}。`,
    crystal:`💎 推薦：${fc.stone}`
  });

  // 處方2: 針對問題類型（動態過濾忌神）
  const avoidSet=new Set(unfav);
  function safeStone(stones, el){
    /* 如果推薦的水晶五行是忌神，改推喜用神水晶 */
    if(avoidSet.has(el)) return `<strong>${fc.stone.split('/')[0].trim()}</strong>（${mainFav}行）`;
    return `<strong>${stones}</strong>`;
  }
  const typeRemedy={
    love:{title:'增強桃花 / 感情磁場',desc:`建議佩戴${safeStone('粉晶','火')}於左手增強異性緣，臥室西南方（坤位）可擺放水晶球，週五（金星日）是約會好日子。`},
    career:{title:'提升事業貴人運',desc:`辦公桌左上角放${safeStone('綠幽靈','木')}招貴人，重要會議佩戴${avoidSet.has('金')?`${mainFav}行系`:'金色系'}飾品增強氣場。`},
    wealth:{title:'開啟正偏財運通道',desc:`錢包內放小片${safeStone('黃水晶','土')}碎石招偏財，每月農曆初二、十六「做牙」，家中財位（大門斜對角）保持明亮。`},
    health:{title:'五行養生調理方案',desc:`根據你的命盤，${mainFav}行不足可能影響相關臟腑。建議從飲食（${fc.food}）、作息（${mainFav==='水'?'早睡養腎':mainFav==='木'?'舒肝勿怒':mainFav==='火'?'午休養心':mainFav==='金'?'深呼吸養肺':'飲食規律養脾'}）著手。`},
    general:{title:'全方位運勢提升',desc:`今年最重要的是穩住${mainFav}行能量。選一條符合喜用神的水晶手鏈隨身佩戴，等於時刻在補運。`},
    relationship:{title:'改善人際磁場',desc:`佩戴${safeStone('粉晶','火')}增加親和力，${safeStone('海藍寶','水')}幫助溝通表達。`},
    family:{title:'穩固家庭和諧能量',desc:`家中客廳放${avoidSet.has('火')?`${mainFav}行水晶`:'<strong>紫水晶洞</strong>'}淨化磁場，臥室避免放太多電子產品。`}
  };
  const tr=typeRemedy[type]||typeRemedy.general;
  actions.push({title:tr.title,desc:tr.desc,crystal:null});

  // 處方2.5: 忌神警告 — 告訴用戶不要碰什麼
  if(unfav.length){
    const avoidCrystals={
      金:'白水晶、鈦晶、金髮晶、純銀飾品',
      木:'綠幽靈、翡翠、橄欖石',
      水:'海藍寶、月光石、藍紋瑪瑙',
      火:'紅瑪瑙、石榴石、紫水晶',
      土:'黃水晶、虎眼石（黃）、茶晶'
    };
    const avoidColors={金:'白色/金色/銀色',木:'綠色',水:'黑色/藍色',火:'紅色/紫色',土:'黃色/棕色'};
    let avoidList=unfav.map(u=>`<strong>${u}行</strong>（${avoidColors[u]||''}）`).join('、');
    let avoidStones=unfav.map(u=>avoidCrystals[u]||'').filter(Boolean).join('、');
    
    /* 如果有調候，使用調候的避開原因 */
    let avoidExplain='';
    if(bazi.tiaohou && bazi.tiaohou.avoidReason){
      avoidExplain=bazi.tiaohou.avoidReason;
    }else{
      avoidExplain='配戴這些五行的水晶<strong>反而會讓運勢卡住</strong>。';
    }
    
    actions.push({
      title:'⛔ 避開這些（忌神提醒）',
      desc:`${avoidExplain}<br><br>你的命盤中 ${avoidList} 需要避開。<br>具體避開：${avoidStones}。<br>如果之前有在戴這些，建議先暫時取下觀察看看。`,
      crystal:null
    });
  }

  // 處方3: 大運建議
  const curDy=bazi.dayun?bazi.dayun.find(d=>d.isCurrent):null;
  if(curDy){
    const dyFav=curDy.level.includes('吉');
    actions.push({
      title:dyFav?'把握當前大運助力':'度過大運低谷期',
      desc:dyFav
        ?`你目前走「${curDy.gz}」大運（${curDy.level}），這段時期是${typeLabel}的好時機。<strong>配合水晶能量，效果加乘</strong>。`
        :`當前大運「${curDy.gz}」（${curDy.level}），運勢壓力較大。<strong>更需要水晶能量護身</strong>，幫你穩住磁場、化解阻力。`
    });
  }

  // 渲染
  let actHTML='';
  actions.forEach((a,i)=>{
    actHTML+=`<div class="action-item">
      <div class="action-num">${i+1}</div>
      <div class="action-content">
        <div class="action-title">${a.title}</div>
        <div class="action-desc">${a.desc}</div>
        ${a.crystal?`<div class="action-crystal" onclick="document.getElementById('r-crystal').scrollIntoView({behavior:'smooth'})">${a.crystal} <i class="fas fa-arrow-right" style="font-size:.7rem"></i></div>`:''}
      </div>
    </div>`;
  });
  document.getElementById('remedy-actions').innerHTML=actHTML;
}

/* Lazy init for extra features (only when user opens the panel) */
function initExtraFeatures(){
  if(typeof renderDailyFortune==='function') try{renderDailyFortune()}catch(e){}
  if(typeof renderReviewCarousel==='function') try{renderReviewCarousel()}catch(e){}
}
function goStep(n){
  if(n===3 && !S.bazi){alert('請先填寫基本資料');return}
  document.querySelectorAll('.step').forEach((s,i)=>s.classList.toggle('active',i===n));
  document.querySelectorAll('.nav-link').forEach((l,i)=>l.classList.toggle('active',i===n));
  document.querySelectorAll('.stepper-item').forEach((s,i)=>{s.classList.remove('active','done');if(i<n)s.classList.add('done');if(i===n)s.classList.add('active')});
  S.step=n; window.scrollTo({top:0,behavior:'smooth'});
  if(n===3) runAnalysis();
}
function resetAll(){S.bazi=null;S.meihua=null;S.tarot={drawn:[],spread:[]};S.ziwei=null;goStep(0);document.getElementById('mh-result').classList.add('hidden');document.getElementById('t-hand').innerHTML='';document.getElementById('t-remain').textContent='10';document.getElementById('btn-draw').disabled=false;document.getElementById('btn-analyze').disabled=true;document.getElementById('t-spread-sec').classList.add('hidden')}
function skipToResult(){goStep(3)}

/* — Char counter — */
document.getElementById('f-question').addEventListener('input',function(){document.getElementById('f-char').textContent=this.value.length});

/* =============================================================
   天干地支 CORE DATA
   ============================================================= */
const TG=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
const DZ=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
const WX_G={甲:'木',乙:'木',丙:'火',丁:'火',戊:'土',己:'土',庚:'金',辛:'金',壬:'水',癸:'水'};
const WX_Z={子:'水',丑:'土',寅:'木',卯:'木',辰:'土',巳:'火',午:'火',未:'土',申:'金',酉:'金',戌:'土',亥:'水'};
const YY_G={甲:'陽',乙:'陰',丙:'陽',丁:'陰',戊:'陽',己:'陰',庚:'陽',辛:'陰',壬:'陽',癸:'陰'};
const SHENG={木:'火',火:'土',土:'金',金:'水',水:'木'};
const KE={木:'土',火:'金',土:'水',金:'木',水:'火'};
const BE_SHENG={木:'水',火:'木',土:'火',金:'土',水:'金'}; // 生我
const BE_KE={木:'金',火:'水',土:'木',金:'火',水:'土'};   // 克我
// ── 地支六沖 ──
const LIU_CHONG={子:'午',午:'子',丑:'未',未:'丑',寅:'申',申:'寅',卯:'酉',酉:'卯',辰:'戌',戌:'辰',巳:'亥',亥:'巳'};
// ── 地支六合 ──  
const LIU_HE={子:'丑',丑:'子',寅:'亥',亥:'寅',卯:'戌',戌:'卯',辰:'酉',酉:'辰',巳:'申',申:'巳',午:'未',未:'午'};
const LH_RESULT={子:'土',丑:'土',寅:'木',亥:'木',卯:'火',戌:'火',辰:'金',酉:'金',巳:'水',申:'水',午:'火',未:'火'};
// ── 地支三合局 ──
const SAN_HE=[
  {members:['申','子','辰'],el:'水'},
  {members:['亥','卯','未'],el:'木'},
  {members:['寅','午','戌'],el:'火'},
  {members:['巳','酉','丑'],el:'金'}
];
// ── 地支三會局 ──
const SAN_HUI=[
  {members:['寅','卯','辰'],el:'木'},
  {members:['巳','午','未'],el:'火'},
  {members:['申','酉','戌'],el:'金'},
  {members:['亥','子','丑'],el:'水'}
];
// ── 天干五合 ──
const TG_HE={甲:'己',己:'甲',乙:'庚',庚:'乙',丙:'辛',辛:'丙',丁:'壬',壬:'丁',戊:'癸',癸:'戊'};
const TG_HE_EL={甲:'土',己:'土',乙:'金',庚:'金',丙:'水',辛:'水',丁:'木',壬:'木',戊:'火',癸:'火'};
// ── 地支相刑 ──
const DZ_XING={寅:'巳',巳:'申',申:'寅',丑:'戌',戌:'未',未:'丑',子:'卯',卯:'子',辰:'辰',午:'午',酉:'酉',亥:'亥'};
// ── 地支相害 ──
const DZ_HAI={子:'未',未:'子',丑:'午',午:'丑',寅:'巳',巳:'寅',卯:'辰',辰:'卯',申:'亥',亥:'申',酉:'戌',戌:'酉'};

// ── 宮位十神事象對照表 ──
const GONG_EVENT={
  year:{label:'年柱',domain:'家庭·長輩·根基',area:['family']},
  month:{label:'月柱',domain:'事業·上司·環境',area:['career']},
  day:{label:'日柱',domain:'自身·婚姻·健康',area:['love','health']},
  hour:{label:'時柱',domain:'子女·下屬·晚運',area:['family','wealth']}
};
const GOD_EVENT={
  '正財':'穩定收入/務實投資/妻緣(男)', '偏財':'意外之財/投機/父緣',
  '正官':'升遷/考試/正派壓力', '七殺':'競爭/意外/小人/壓力',
  '正印':'貴人/學業/母緣/庇護', '偏印':'轉變/孤獨/偏門學術',
  '食神':'才華/口福/女兒(女)/享受', '傷官':'創意/叛逆/口舌/變革',
  '比肩':'合作/競爭/朋友助力', '劫財':'破財/爭端/兄弟糾紛'
};

/* 藏干 */
const CG={
  子:['癸'],丑:['己','癸','辛'],寅:['甲','丙','戊'],卯:['乙'],
  辰:['戊','乙','癸'],巳:['丙','庚','戊'],午:['丁','己'],未:['己','丁','乙'],
  申:['庚','壬','戊'],酉:['辛'],戌:['戊','辛','丁'],亥:['壬','甲']
};

/* 十神 */
function tenGod(dm,tgt){
  if(!WX_G[dm]||!WX_G[tgt])return'—';
  const d=WX_G[dm],t=WX_G[tgt],s=YY_G[dm]===YY_G[tgt];
  if(d===t)return s?'比肩':'劫財';
  if(SHENG[d]===t)return s?'食神':'傷官';
  if(KE[d]===t)return s?'偏財':'正財';
  if(KE[t]===d)return s?'七殺':'正官';
  if(SHENG[t]===d)return s?'偏印':'正印';
  return'—';
}

/* 十二長生 */
const CHANG_SHENG_ORDER=['長生','沐浴','冠帶','臨官','帝旺','衰','病','死','墓','絕','胎','養'];
const CS_START={甲:DZ.indexOf('亥'),丙:DZ.indexOf('寅'),戊:DZ.indexOf('寅'),庚:DZ.indexOf('巳'),壬:DZ.indexOf('申'),
                乙:DZ.indexOf('午'),丁:DZ.indexOf('酉'),己:DZ.indexOf('酉'),辛:DZ.indexOf('子'),癸:DZ.indexOf('卯')};
function changSheng(dm,zhi){
  const start=CS_START[dm]; if(start===undefined)return'—';
  const zhiIdx=DZ.indexOf(zhi); if(zhiIdx<0)return'—';
  const isYang=YY_G[dm]==='陽';
  let diff=isYang?(zhiIdx-start+12)%12:(start-zhiIdx+12)%12;
  return CHANG_SHENG_ORDER[diff];
}

/* 神煞 (簡化版 — 常用15個) */
function getShenSha(pillars){
  const ss=[];
  const yZ=pillars.year.zhi, dG=pillars.day.gan, dZ=pillars.day.zhi;
  // 天乙貴人
  const TIYI={甲:['丑','未'],戊:['丑','未'],庚:['丑','未'],丙:['亥','酉'],丁:['亥','酉'],
              乙:['子','申'],己:['子','申'],壬:['卯','巳'],癸:['卯','巳'],辛:['午','寅']};
  if(TIYI[dG]){[yZ,pillars.month.zhi,pillars.hour.zhi].forEach(z=>{if(TIYI[dG].includes(z))ss.push('天乙貴人')})}
  // 文昌
  const WC={甲:'巳',乙:'午',丙:'申',丁:'酉',戊:'申',己:'酉',庚:'亥',辛:'子',壬:'寅',癸:'卯'};
  if(WC[dG]){[yZ,pillars.month.zhi,pillars.hour.zhi].forEach(z=>{if(z===WC[dG])ss.push('文昌')})}
  // 驛馬
  const YM={寅:'申',巳:'亥',申:'寅',亥:'巳',子:'午',午:'子',卯:'酉',酉:'卯',辰:'戌',戌:'辰',丑:'未',未:'丑'};
  if(YM[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===YM[yZ])ss.push('驛馬')})}
  // 桃花
  const TH_MAP={子:'酉',丑:'午',寅:'卯',卯:'子',辰:'酉',巳:'午',午:'卯',未:'子',申:'酉',酉:'午',戌:'卯',亥:'子'};
  if(TH_MAP[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===TH_MAP[yZ])ss.push('桃花')})}
  // 華蓋
  const HG_MAP={子:'辰',丑:'丑',寅:'戌',卯:'未',辰:'辰',巳:'丑',午:'戌',未:'未',申:'辰',酉:'丑',戌:'戌',亥:'未'};
  if(HG_MAP[yZ]){[pillars.month.zhi,pillars.day.zhi,pillars.hour.zhi].forEach(z=>{if(z===HG_MAP[yZ])ss.push('華蓋')})}
  return[...new Set(ss)];
}

/* =============================================================
   BAZI COMPUTATION (完整版)
   ============================================================= */
function submitStep0(){
  const type=document.getElementById('f-type').value;
  const question=document.getElementById('f-question').value.trim();
  const gender=document.querySelector('input[name="gender"]:checked');
  const bdate=document.getElementById('f-bdate').value;
  if(!type||!question||!gender||!bdate){alert('請填寫所有必要欄位');return}
  const btime=document.getElementById('f-btime').value||'12:00';
  const name=document.getElementById('f-name').value.trim();
  S.form={type,question,gender:gender.value,bdate,btime,name};
  const[y,m,d]=bdate.split('-').map(Number);
  const[hh,mm]=btime.split(':').map(Number);
  S.bazi=computeBazi(y,m,d,hh,mm,gender.value);
  S.ziwei=computeZiwei(y,m,d,hh,gender.value);
  mergeZiweiIntoBazi(); // 紫微整合進八字大運流年
  // 基本資料就緒，刷新需要八字的功能區
  renderDailyFortune();
  generateLuckyInfo();
  goStep(1);
}

function submitStep0Fast(){
  /* 一鍵直達：自動梅花起卦 + 自動塔羅抽牌 → 直接看結果 */
  drawnCards=[];
  S.meihua=null;S.tarot={drawn:[],spread:[]};
  const type=document.getElementById('f-type').value;
  const question=document.getElementById('f-question').value.trim();
  const gender=document.querySelector('input[name="gender"]:checked');
  const bdate=document.getElementById('f-bdate').value;
  if(!type||!question||!gender||!bdate){alert('請填寫所有必要欄位');return}
  const btime=document.getElementById('f-btime').value||'12:00';
  const name=document.getElementById('f-name').value.trim();
  S.form={type,question,gender:gender.value,bdate,btime,name};
  const[y,m,d]=bdate.split('-').map(Number);
  const[hh,mm]=btime.split(':').map(Number);
  S.bazi=computeBazi(y,m,d,hh,mm,gender.value);
  S.ziwei=computeZiwei(y,m,d,hh,gender.value);
  mergeZiweiIntoBazi(); // 紫微整合進八字大運流年
  renderDailyFortune();
  generateLuckyInfo();
  /* 自動梅花：用時間起卦 */
  calcMhTime();
  /* 自動塔羅：快速全抽 */
  while(drawnCards.length<10) drawCard();
  /* 直接跳到結果 */
  goStep(3);
}

function computeBazi(year,month,day,hour,minute,gender){
  // ── 年柱 ──
  let ly=year;
  if(month<2||(month===2&&day<4))ly--;
  const yGi=((ly-4)%10+10)%10;
  const yZi=((ly-4)%12+12)%12;
  const yG=TG[yGi], yZ=DZ[yZi];

  // ── 月柱 ──
  // 節氣近似日
  const JIE=[0,6,4,6,5,6,6,7,8,8,8,7,7]; // index 1-12
  let mi=month;
  if(day<(JIE[month]||6))mi=mi===1?12:mi-1;
  const mZi=mi%12; // 正月(mi=2)=寅(2), 二月(mi=3)=卯(3), 子月(mi=12)→0=子
  const mGBase=((yGi%5)*2+2)%10; // 年上起月法：甲己起丙(2),乙庚起戊(4),丙辛起庚(6),丁壬起壬(8),戊癸起甲(0)
  const mGi=(mGBase+((mi-2+12)%12))%10; // 正月(mi=2)偏移=0, 二月(mi=3)偏移=1...
  const mG=TG[(mGi+10)%10], mZ=DZ[mZi];

  // ── 日柱（以1900-01-01甲戌日為基準，序號10） ──
  const base=new Date(1900,0,1);
  const tgt=new Date(year,month-1,day);
  const diff=Math.floor((tgt-base)/864e5);
  const dayCycle=((diff+10)%60+60)%60;
  const dGi=dayCycle%10;
  const dZi=dayCycle%12;
  const dG=TG[dGi], dZ=DZ[dZi];

  // ── 時柱 ──
  const shi=Math.floor(((hour+1)%24)/2);
  const hZi=shi%12;
  // 夜子時修正: 23:00-23:59 屬子時, 但時柱天干按"下一天"日干起算
  const isNightZi=(hour>=23);
  let hGBase;
  if(isNightZi){
    const nextDayCycle=((diff+1+10)%60+60)%60;
    hGBase=(nextDayCycle%10%5)*2;
  }else{
    hGBase=(dGi%5)*2;
  }
  const hGi=(hGBase+hZi)%10;
  const hG=TG[hGi], hZ=DZ[hZi];

  const pillars={year:{gan:yG,zhi:yZ},month:{gan:mG,zhi:mZ},day:{gan:dG,zhi:dZ},hour:{gan:hG,zhi:hZ}};
  const dm=dG, dmEl=WX_G[dm];

  // ── 五行力量計算（60分制，對齊業界標準）──
  // 權重：天干=4分, 月支=20分(提綱最重), 其他地支=8分
  // 藏干比例：3藏干=60/25/15, 2藏干=70/30, 1藏干=100%
  const TG_PTS=4, MZ_PTS=20, OZ_PTS=8;
  const RATIO_3=[0.60,0.25,0.15], RATIO_2=[0.70,0.30], RATIO_1=[1.0];
  
  const ec={金:0,木:0,水:0,火:0,土:0};
  const allG=[yG,mG,dG,hG], allZ=[yZ,mZ,dZ,hZ];
  
  // 天干計分
  allG.forEach(g=>{ ec[WX_G[g]]+=TG_PTS; });
  
  // 地支藏干計分
  allZ.forEach((z,i)=>{
    const cg=CG[z]||[];
    const zhiPts=(i===1)?MZ_PTS:OZ_PTS;
    const ratio=cg.length===3?RATIO_3:cg.length===2?RATIO_2:RATIO_1;
    cg.forEach((g,j)=>{
      ec[WX_G[g]]+=zhiPts*(ratio[j]||0.1);
    });
  });
  
  const tot=Object.values(ec).reduce((a,b)=>a+b,0);
  const ep={}; for(const k of Object.keys(ec))ep[k]=Math.round(ec[k]/tot*100);

  // ── 月令旺衰狀態 ──
  const mzEl=WX_Z[mZ];
  function getMonthState(el){
    if(el===mzEl) return '旺';
    if(SHENG[el]===mzEl) return '休';
    if(SHENG[mzEl]===el) return '相';
    if(KE[el]===mzEl) return '囚';
    if(KE[mzEl]===el) return '死';
    return '休';
  }
  const dmMonthState=getMonthState(dmEl);

  // ── 身強身弱（得令、得地、得勢 三維判定）──
  const deLing=(dmMonthState==='旺'||dmMonthState==='相');
  
  let rootCount=0, rootScore=0;
  allZ.forEach(z=>{
    const cg=CG[z]||[];
    cg.forEach((g,j)=>{
      if(WX_G[g]===dmEl){
        rootCount++;
        rootScore+=(j===0)?3:(j===1)?2:1;
      }
    });
  });
  const deDi=(rootCount>=2)||(rootScore>=3);
  
  let helpCount=0;
  allG.forEach((g,i)=>{
    if(i===2) return;
    const el=WX_G[g];
    if(el===dmEl) helpCount++;
    if(SHENG[el]===dmEl) helpCount++;
  });
  const deShi=(helpCount>=2);
  
  const selfScore=(ec[dmEl]||0)+(ec[BE_SHENG[dmEl]]||0);
  const selfRatio=selfScore/tot;
  
  let strong;
  if(deLing){
    // 得令: 需配合比例門檻, 避免得令但力量不足仍判強
    const conditions=(deDi?1:0)+(deShi?1:0);
    if(conditions>=2){
      strong=selfRatio>=0.28; // 三全(令+地+勢): 除非極低比例
    }else if(conditions===1){
      strong=selfRatio>=0.38; // 得令+一項: 需較高比例
    }else{
      strong=selfRatio>=0.45; // 僅得令: 需高比例
    }
  }else{
    if(dmMonthState==='死'||dmMonthState==='囚'){
      strong=(deDi&&deShi&&selfRatio>0.55); // 被月令剋/洩: 極嚴格
    }else{
      strong=(deDi&&deShi&&selfRatio>0.45); // 休: 中等
    }
    if(selfRatio>0.60) strong=true; // 絕對高比例: 無條件身強
  }

  // ── 喜用神 / 忌神 ──
  let fav=[],unfav=[];
  if(strong){
    fav=[SHENG[dmEl],BE_KE[dmEl],KE[dmEl]];
    unfav=[dmEl,BE_SHENG[dmEl]];
  }else{
    // 身弱: 若印星五行已偏旺(佔比>25%)，優先取比劫
    const yinEl=BE_SHENG[dmEl];
    if(ec[yinEl]&&(ec[yinEl]/tot>0.25)){
      fav=[dmEl,yinEl]; // 比劫優先
    }else{
      fav=[yinEl,dmEl]; // 印星優先
    }
    unfav=[BE_KE[dmEl],SHENG[dmEl],KE[dmEl]];
  }
  fav=[...new Set(fav)];
  unfav=[...new Set(unfav.filter(u=>!fav.includes(u)))];

  // ── 調候用神修正（寒暖濕燥）──
  let tiaohou=null;
  (function adjustTiaoHou(){
    const mzEl=WX_Z[mZ]; // 月支五行
    const waterPct=(ec['水']/tot)*100;
    const firePct=(ec['火']/tot)*100;
    const goldPct=(ec['金']/tot)*100;
    
    /* 計算命盤寒暖度 */
    const coldPct=((ec['水']+ec['金'])/tot)*100; // 水+金合計佔比
    const warmPct=((ec['火']+ec['木']*0.3)/tot)*100; // 火+少量木
    const coldRatio=coldPct/100;
    const warmRatio=warmPct/100;
    
    /* 調候結果 */
    
    /* === 甲乙木日主 === */
    if(dmEl==='木'){
      // 木生秋冬（申酉月、亥子月）= 金旺水旺，天寒
      const isAutumnWinter=['申','酉','亥','子','丑'].includes(mZ);
      if(isAutumnWinter && coldPct>55 && firePct<10){
        // 寒盤：水金合計超過55%，且火不到10%
        if(waterPct>25){
          tiaohou={
            reason:'水多木漂',
            detail:`你是${dm}木日主，生在秋冬，命盤水氣（${Math.round(waterPct)}%）和金氣（${Math.round(goldPct)}%）過重。水本來是你的救星（印星），但太多就變成「冰水泡花」，木的根基會腐爛。`,
            need:['火','土'],
            needReason:'需要「火」（太陽）暖局驅寒，讓木重新生長。「燥土」可以止水、固根。',
            avoid:['水'],
            avoidReason:'水已經泛濫，再補水等於往冰水加冰塊，會更沒精神、濕氣重、嗜睡。'
          };
        }else if(goldPct>25){
          // 金重剋木，水不多 → 用水洩金生木（殺印相生）仍然可以
          // 但如果冷，還是要帶點火
          tiaohou={
            reason:'金重剋木',
            detail:`你是${dm}木日主，命盤金氣（${Math.round(goldPct)}%）過旺，壓力大。水雖可洩金生木，但盤偏寒，也需要火來暖局。`,
            need:['水','火'],
            needReason:'「水」洩金化殺，「火」暖局讓木有活力。',
            avoid:['金'],
            avoidReason:'金已經太多，再補金等於雪上加霜。'
          };
        }
      }
      // 木生夏月（巳午月）= 火旺木焚
      const isSummer=['巳','午'].includes(mZ);
      if(isSummer && firePct>25){
        tiaohou={
          reason:'火旺木焚',
          detail:`你是${dm}木日主，生在夏天，火氣太旺，木會被燒盡。`,
          need:['水'],
          needReason:'需要水來潤木降溫，保住木的生機。',
          avoid:['火'],
          avoidReason:'火已經太旺，再添火只會讓木更快燃盡。'
        };
      }
    }
    
    /* === 丙丁火日主 === */
    if(dmEl==='火'){
      const isWinter=['亥','子','丑'].includes(mZ);
      if(isWinter && coldPct>55 && firePct<15){
        tiaohou={
          reason:'水寒火滅',
          detail:`你是${dm}火日主，生在冬天，水氣過重，火有被澆滅之虞。`,
          need:['木'],
          needReason:'需要木來生火，讓火苗持續。木是最好的燃料。',
          avoid:['水'],
          avoidReason:'水已過多，再補水會讓火更弱。'
        };
      }
    }
    
    /* === 庚辛金日主 === */
    if(dmEl==='金'){
      const isSummer=['巳','午','未'].includes(mZ);
      if(isSummer && warmPct>50){
        tiaohou={
          reason:'火旺金熔',
          detail:`你是${dm}金日主，生在夏天，火氣過旺，金有被熔化之虞。`,
          need:['水'],
          needReason:'需要水來降溫潤金，保住金的堅韌。',
          avoid:['火'],
          avoidReason:'火已經太旺，再添火金會更軟更弱。'
        };
      }
    }
    
    /* === 壬癸水日主 === */
    if(dmEl==='水'){
      const isSummer=['巳','午','未'].includes(mZ);
      if(isSummer && warmPct>50){
        tiaohou={
          reason:'土燥水涸',
          detail:`你是${dm}水日主，生在夏天，火土過旺，水源有乾涸之危。`,
          need:['金'],
          needReason:'需要金來生水，維持水的源頭活力。',
          avoid:['火','土'],
          avoidReason:'火土已經太旺，再補會讓水更快蒸發。'
        };
      }
      const isWinter=['亥','子'].includes(mZ);
      if(isWinter && waterPct>30){
        tiaohou={
          reason:'水勢泛濫',
          detail:`你是${dm}水日主，生在冬天，水氣極旺，需要土來築堤、火來暖局。`,
          need:['土','火'],
          needReason:'「土」築堤止水，「火」暖局調節。',
          avoid:['水'],
          avoidReason:'水已經泛濫，再補水無益。'
        };
      }
    }
    
    /* === 戊己土日主 === */
    if(dmEl==='土'){
      const isWinter=['亥','子','丑'].includes(mZ);
      if(isWinter && coldPct>55){
        tiaohou={
          reason:'寒土凍結',
          detail:`你是${dm}土日主，生在冬天，水寒侵蝕，土地凍結無法生養。`,
          need:['火'],
          needReason:'需要火來暖土，讓土恢復生機。',
          avoid:['水'],
          avoidReason:'水氣過重，再補水土會更凍更寒。'
        };
      }
    }
    
    /* === 如果觸發調候，修正 fav / unfav === */
    if(tiaohou){
      // 調候用神覆蓋通用喜用神
      const newFav=tiaohou.need.filter(e=>e);
      const newAvoid=tiaohou.avoid.filter(e=>e);
      
      // 把調候需要的放在 fav 最前面
      newFav.forEach(e=>{
        if(!fav.includes(e)) fav.unshift(e);
        // 從忌神中移除（調候優先）
        unfav=unfav.filter(u=>u!==e);
      });
      
      // 把調候要避開的加入忌神
      newAvoid.forEach(e=>{
        if(!unfav.includes(e) && !newFav.includes(e)) unfav.unshift(e);
        // 從喜用中移除
        fav=fav.filter(f=>f!==e);
      });
      
      fav=[...new Set(fav)];
      unfav=[...new Set(unfav.filter(u=>!fav.includes(u)))];
    }
  })();

  // ── 十神 ──
  const gods={};
  ['year','month','day','hour'].forEach(p=>{
    const g=pillars[p].gan, z=pillars[p].zhi;
    gods[p]={
      gan: p==='day'?'日主':tenGod(dm,g),
      zhi: CG[z]?CG[z].map(c=>tenGod(dm,c)):['—']
    };
  });

  // ── 十二長生 ──
  const cs={};
  ['year','month','day','hour'].forEach(p=>{
    cs[p]=changSheng(dm,pillars[p].zhi);
  });

  // ── 神煞 ──
  const shensha=getShenSha(pillars);

  // ── 納音 ──
  const nayin=getNaYin(yGi,yZi);

  // ── 大運 ──
  const isFwd=(gender==='male'&&YY_G[yG]==='陽')||(gender==='female'&&YY_G[yG]==='陰');
  const dir=isFwd?1:-1;
  const startAge=computeStartAge(year,month,day,dir);
  const dayun=[];
  for(let i=0;i<10;i++){
    const gI=((TG.indexOf(mG)+(i+1)*dir)%10+10)%10;
    const zI=((DZ.indexOf(mZ)+(i+1)*dir)%12+12)%12;
    const as=startAge+i*10, ae=as+9;
    const curAge=new Date().getFullYear()-year;
    const isCur=curAge>=as&&curAge<=ae;
    const dyG=TG[gI],dyZ=DZ[zI],dyEl=WX_G[dyG],dyZEl=WX_Z[dyZ];
    /* ═══ 大運吉凶判定：四步分析法 ═══ */
    const dyGod=tenGod(dm,dyG);
    const dyZGod=tenGod(dm,CG[dyZ]?CG[dyZ][0]:dyG);
    let dyScore=0;
    let dyNotes=[];

    // [Step1] 喜忌判定 — 天干管前5年, 地支管後5年
    const dyGanScore=(fav.includes(dyEl)?3:unfav.includes(dyEl)?-3:0);
    const dyZhiScore=(fav.includes(dyZEl)?3:unfav.includes(dyZEl)?-3:0);
    dyScore+=dyGanScore+dyZhiScore;
    if(dyGanScore>0) dyNotes.push('天干'+dyG+'（'+dyEl+'行·喜用）前五年順');
    if(dyGanScore<0) dyNotes.push('天干'+dyG+'（'+dyEl+'行·忌神）前五年逆');
    if(dyZhiScore>0) dyNotes.push('地支'+dyZ+'（'+dyZEl+'行·喜用）後五年順');
    if(dyZhiScore<0) dyNotes.push('地支'+dyZ+'（'+dyZEl+'行·忌神）後五年逆');

    // [Step2] 大運與原局互動 — 刑沖合害
    const origZhi=[yZ,mZ,dZ,hZ];
    const origGan=[yG,mG,dG,hG];
    const gongKeys=['year','month','day','hour'];
    let dyClash=[], dyHe=[], dyXing=[];
    origZhi.forEach((oz,idx)=>{
      if(LIU_CHONG[dyZ]===oz){
        dyClash.push(gongKeys[idx]);
        const clashArea=GONG_EVENT[gongKeys[idx]].domain;
        dyNotes.push('大運'+dyZ+'沖原局'+gongKeys[idx]+'（'+oz+'）→ '+clashArea+'有變動');
        dyScore+=(unfav.includes(WX_Z[oz])?1.5:-1.5); // 沖掉忌神則吉，沖掉喜用則凶
      }
      if(LIU_HE[dyZ]===oz){
        dyHe.push(gongKeys[idx]);
        const heEl=LH_RESULT[dyZ];
        dyScore+=(fav.includes(heEl)?1:-0.5);
        dyNotes.push('大運'+dyZ+'合原局'+oz+'→化'+heEl+(fav.includes(heEl)?'（喜）':'（忌）'));
      }
      if(DZ_XING[dyZ]===oz){
        dyXing.push(gongKeys[idx]);
        dyScore-=0.5;
        dyNotes.push('大運'+dyZ+'刑原局'+oz+'→ 注意'+GONG_EVENT[gongKeys[idx]].domain);
      }
    });
    // 天干合
    origGan.forEach((og,idx)=>{
      if(TG_HE[dyG]===og){
        const heEl=TG_HE_EL[dyG];
        dyScore+=(fav.includes(heEl)?1.5:-1);
        dyNotes.push('大運'+dyG+'合原局'+og+'→化'+heEl);
      }
    });

    // [Step3] 十神配合度
    if(['正印','偏印'].includes(dyGod)&&!strong){dyScore+=1;dyNotes.push('身弱逢印（'+dyGod+'），得到庇護');}
    if(['正官'].includes(dyGod)&&strong){dyScore+=1;dyNotes.push('身強逢正官，有制衡助升遷');}
    if(['七殺'].includes(dyGod)&&!strong){dyScore-=1.5;dyNotes.push('身弱逢七殺，壓力倍增');}
    if(['食神','傷官'].includes(dyGod)&&strong){dyScore+=1;dyNotes.push('身強逢'+dyGod+'，才華得展');}
    if(['正財','偏財'].includes(dyGod)&&strong){dyScore+=1;dyNotes.push('身強逢'+dyGod+'，利財運');}
    if(['正財','偏財'].includes(dyGod)&&!strong){dyScore-=0.5;dyNotes.push('身弱逢'+dyGod+'，財多身弱');}

    // [Step4] 調候加成
    if(tiaohou){
      if(tiaohou.reason.includes('寒')&&(dyEl==='火'||dyZEl==='火')){dyScore+=2;dyNotes.push('寒命逢火運，調候大利');}
      if(tiaohou.reason.includes('火旺')&&(dyEl==='水'||dyZEl==='水')){dyScore+=2;dyNotes.push('熱命逢水運，調候大利');}
      if(tiaohou.reason.includes('寒')&&(dyEl==='水'||dyZEl==='水')){dyScore-=1.5;dyNotes.push('寒命再逢水，雪上加霜');}
      if(tiaohou.reason.includes('火旺')&&(dyEl==='火'||dyZEl==='火')){dyScore-=1.5;dyNotes.push('熱命再逢火，火上澆油');}
    }

    let lv='平';
    if(dyScore>=6) lv='大吉';
    else if(dyScore>=3) lv='中吉';
    else if(dyScore>=1) lv='小吉';
    else if(dyScore>=-1) lv='平';
    else if(dyScore>=-3) lv='小凶';
    else if(dyScore>=-6) lv='中凶';
    else lv='大凶';

    // ── 流年精斷 ──
    const liuNian=[];
    for(let j=0;j<10;j++){
      const lnYear=year+as+j;
      const lnGI=((lnYear-4)%10+10)%10;
      const lnZI=((lnYear-4)%12+12)%12;
      const lnG=TG[lnGI],lnZ=DZ[lnZI],lnEl=WX_G[lnG],lnZEl=WX_Z[lnZ];
      const lnGod=tenGod(dm,lnG);
      let lnScore=0;
      let lnNotes=[];

      // [流年Step1] 喜忌 — 天干=外在表象, 地支=本質結果
      if(fav.includes(lnEl)){lnScore+=2;lnNotes.push('天干'+lnG+'（喜用·表象吉）');}
      else if(unfav.includes(lnEl)){lnScore-=2;lnNotes.push('天干'+lnG+'（忌神·表象凶）');}
      if(fav.includes(lnZEl)){lnScore+=2;lnNotes.push('地支'+lnZ+'（喜用·本質吉）');}
      else if(unfav.includes(lnZEl)){lnScore-=2;lnNotes.push('地支'+lnZ+'（忌神·本質凶）');}

      // [流年Step2] 三柱互動：流年→大運→原局
      // 流年與大運互動
      if(lnG===dyG&&lnZ===dyZ){lnScore+=Math.abs(lnScore)>0?lnScore:2;lnNotes.push('⚡ 歲運並臨（力量加倍）');}
      if(LIU_CHONG[lnZ]===dyZ){
        lnNotes.push('流年'+lnZ+'沖大運'+dyZ+'→ 運勢動盪');
        // 沖掉的是喜用還是忌神
        lnScore+=(unfav.includes(dyZEl)?1:-1.5);
      }
      if(TG_HE[lnG]===dyG){
        const heEl=TG_HE_EL[lnG];
        lnScore+=(fav.includes(heEl)?1:-0.5);
        lnNotes.push('流年'+lnG+'合大運'+dyG+'→化'+heEl);
      }
      if(LIU_HE[lnZ]===dyZ){
        const heEl=LH_RESULT[lnZ];
        lnScore+=(fav.includes(heEl)?1:-0.5);
        lnNotes.push('流年'+lnZ+'合大運'+dyZ+'→化'+heEl);
      }

      // 流年與原局互動（宮位觸發）
      let lnClash=[], lnAffect=[];
      origZhi.forEach((oz,idx)=>{
        if(LIU_CHONG[lnZ]===oz){
          lnClash.push(gongKeys[idx]);
          const area=GONG_EVENT[gongKeys[idx]];
          lnNotes.push('流年'+lnZ+'沖'+area.label+'（'+oz+'）→ '+area.domain+'有變動');
          lnScore+=(unfav.includes(WX_Z[oz])?1:-1);
          lnAffect.push(...area.area);
        }
      });

      // [流年Step3] 十神疊加 + 宮位 = 事象推導
      let lnEvents=[];
      if(GOD_EVENT[lnGod]) lnEvents.push(lnGod+'：'+GOD_EVENT[lnGod]);
      // 流年十神+被沖宮位=具體事象
      lnClash.forEach(gk=>{
        const gong=GONG_EVENT[gk];
        lnEvents.push(lnGod+'沖'+gong.label+'→ '+gong.domain+'領域出現'+GOD_EVENT[lnGod]);
      });

      // [流年Step4] 特殊組合
      // 三合局檢查（流年+大運+原局任一支組成三合）
      const allZhi=[lnZ,dyZ,...origZhi];
      SAN_HE.forEach(sh=>{
        const inSet=sh.members.filter(m=>allZhi.includes(m));
        if(inSet.length>=3&&inSet.includes(lnZ)){
          lnNotes.push('三合'+sh.el+'局（含'+inSet.join('')+'）');
          lnScore+=(fav.includes(sh.el)?2:-2);
        }
      });

      // 調候加成
      if(tiaohou){
        if(tiaohou.reason.includes('寒')&&(lnEl==='火'||lnZEl==='火')){lnScore+=1;lnNotes.push('寒命逢火年，暖局');}
        if(tiaohou.reason.includes('寒')&&(lnEl==='水'||lnZEl==='水')){lnScore-=1;lnNotes.push('寒命逢水年，加寒');}
        if(tiaohou.reason.includes('火旺')&&(lnEl==='水'||lnZEl==='水')){lnScore+=1;lnNotes.push('熱命逢水年，降溫');}
        if(tiaohou.reason.includes('火旺')&&(lnEl==='火'||lnZEl==='火')){lnScore-=1;lnNotes.push('熱命逢火年，加熱');}
      }

      let lnLv='平';
      if(lnScore>=5) lnLv='大吉';
      else if(lnScore>=3) lnLv='中吉';
      else if(lnScore>=1) lnLv='小吉';
      else if(lnScore>=-1) lnLv='平';
      else if(lnScore>=-3) lnLv='小凶';
      else if(lnScore>=-5) lnLv='中凶';
      else lnLv='大凶';
      liuNian.push({year:lnYear,gz:lnG+lnZ,el:lnEl,zEl:lnZEl,level:lnLv,god:lnGod,score:lnScore,notes:lnNotes,events:lnEvents,clash:lnClash,affect:lnAffect});
    }
    dayun.push({gz:dyG+dyZ,el:dyEl,zEl:dyZEl,ageStart:as,ageEnd:ae,isCurrent:isCur,level:lv,score:dyScore,god:dyGod,zGod:dyZGod,notes:dyNotes,clash:dyClash,he:dyHe,xing:dyXing,liuNian,ganScore:dyGanScore,zhiScore:dyZhiScore});
  }

  return{pillars,dm,dmEl,strong,deLing,deDi,deShi,dmMonthState,selfRatio:Math.round(selfRatio*100),ec,ep,fav,unfav,gods,cs,shensha,nayin,dayun,cangGan:{year:CG[yZ],month:CG[mZ],day:CG[dZ],hour:CG[hZ]},tiaohou:tiaohou};
}

function computeStartAge(y,m,d,dir){
  // 簡化：順行找下一個節氣，逆行找上一個，每3天折1歲
  // 這裡用近似值
  const JIE_DAYS=[0,6,4,6,5,6,6,7,8,8,8,7,7];
  const jd=JIE_DAYS[m]||6;
  let diff=dir>0?(jd<=d?30-d+JIE_DAYS[(m%12)+1]:jd-d):(d<=jd?d+30-JIE_DAYS[((m-2+12)%12)+1]:d-jd);
  return Math.max(1,Math.round(diff/3));
}

/* 納音 */
function getNaYin(gi,zi){
  const NY=['海中金','爐中火','大林木','路旁土','劍鋒金','山頭火','澗下水','城頭土','白蠟金','楊柳木',
            '泉中水','屋上土','霹靂火','松柏木','長流水','砂中金','山下火','平地木','壁上土','金箔金',
            '覆燈火','天河水','大驛土','釵釧金','桑柘木','大溪水','砂中土','天上火','石榴木','大海水'];
  const idx=Math.floor(((gi*12+zi)/2)%30);
  return NY[idx]||'';
}
/* =============================================================
   梅花易數 MEIHUA YISHU — 完整64卦
   ============================================================= */
const BG=[
  {name:'乾',sym:'☰',nat:'天',el:'金',n:1,li:[1,1,1]},
  {name:'兌',sym:'☱',nat:'澤',el:'金',n:2,li:[1,1,0]},
  {name:'離',sym:'☲',nat:'火',el:'火',n:3,li:[1,0,1]},
  {name:'震',sym:'☳',nat:'雷',el:'木',n:4,li:[1,0,0]},
  {name:'巽',sym:'☴',nat:'風',el:'木',n:5,li:[0,1,1]},
  {name:'坎',sym:'☵',nat:'水',el:'水',n:6,li:[0,1,0]},
  {name:'艮',sym:'☶',nat:'山',el:'土',n:7,li:[0,0,1]},
  {name:'坤',sym:'☷',nat:'地',el:'土',n:8,li:[0,0,0]}
];
const G64={
'11':{n:'乾為天',u:'䷀',j:'元亨利貞。',m:'剛健中正，萬事亨通，戒驕傲。'},
'12':{n:'天澤履',u:'䷉',j:'履虍尾，不咥人，亨。',m:'小心謹慎前行，合禮則吉。'},
'13':{n:'天火同人',u:'䷌',j:'同人于重，亨。',m:'志同道合者聚集，利涉大川。'},
'14':{n:'天雷無妄',u:'䷘',j:'元亨利貞。',m:'至誠無妄，順天而行。'},
'15':{n:'天風姤',u:'䷫',j:'女壯，勿用取女。',m:'偶然相遇，不可急進。'},
'16':{n:'天水訟',u:'䷅',j:'有孚，窒。',m:'爭訟之象，宜和解退讓。'},
'17':{n:'天山遁',u:'䷠',j:'亨，小利貞。',m:'退避保身，以退為進。'},
'18':{n:'天地否',u:'䷋',j:'否之匪人。',m:'閉塞不通，守靜待時。'},
'21':{n:'澤天夬',u:'䷪',j:'揚于王庭。',m:'決斷果敢，以剛決柔。'},
'22':{n:'兌為澤',u:'䷹',j:'亨，利貞。',m:'喜悅交流，言語得宜。'},
'23':{n:'澤火革',u:'䷰',j:'己日乃孚。',m:'變革除舊，時機成熟方可行。'},
'24':{n:'澤雷隨',u:'䷐',j:'元亨利貞，無咎。',m:'順勢而行，隨機應變。'},
'25':{n:'澤風大過',u:'䷛',j:'棟撓，利有攸往。',m:'力量過大，需謹慎。'},
'26':{n:'澤水困',u:'䷮',j:'亨，貞，大人吉。',m:'困境中堅守正道，終將通達。'},
'27':{n:'澤山咸',u:'䷞',j:'亨，利貞。',m:'感應之道，心意相通。'},
'28':{n:'澤地萃',u:'䷬',j:'亨，王假有廟。',m:'聚集匯萃，利見大人。'},
'31':{n:'火天大有',u:'䷍',j:'元亨。',m:'豐收大有，光明正大。'},
'32':{n:'火澤睽',u:'䷥',j:'小事吉。',m:'乖離背反，求同存異。'},
'33':{n:'離為火',u:'䷝',j:'利貞，亨。',m:'光明附麗，依附正道。'},
'34':{n:'火雷噬嗑',u:'䷔',j:'亨，利用獄。',m:'明辨是非，果斷處理。'},
'35':{n:'火風鼎',u:'䷱',j:'元吉，亨。',m:'鼎新除舊，變革創新。'},
'36':{n:'火水未濟',u:'䷿',j:'亨，小狐汔濟。',m:'尚未完成，仍需努力。'},
'37':{n:'火山旅',u:'䷷',j:'小亨。',m:'客居在外，謹慎處世。'},
'38':{n:'火地晉',u:'䷢',j:'康侯用錫馬蕃庶。',m:'光明上進，步步晉升。'},
'41':{n:'雷天大壯',u:'䷡',j:'利貞。',m:'氣勢壯盛，守正方吉。'},
'42':{n:'雷澤歸妹',u:'䷵',j:'征凶，無攸利。',m:'安分守己，不可妄動。'},
'43':{n:'雷火豐',u:'䷶',j:'亨，王假之。',m:'豐盛之時，居安思危。'},
'44':{n:'震為雷',u:'䷲',j:'亨。',m:'震動奮發，先驚後喜。'},
'45':{n:'雷風恆',u:'䷟',j:'亨，無咎，利貞。',m:'恆久不變，守持正道。'},
'46':{n:'雷水解',u:'䷧',j:'利西南。',m:'危難解除，宜速行動。'},
'47':{n:'雷山小過',u:'䷽',j:'亨，利貞。',m:'小有遍越，微調行事。'},
'48':{n:'雷地豫',u:'䷏',j:'利建侯行師。',m:'歡樂豫悅，準備充分。'},
'51':{n:'風天小畜',u:'䷈',j:'亨，密雲不雨。',m:'力量不足，暫時蓄積。'},
'52':{n:'風澤中孚',u:'䷼',j:'豚魚吉。',m:'誠信為本，信則靈驗。'},
'53':{n:'風火家人',u:'䷤',j:'利女貞。',m:'家道昌明，各安其位。'},
'54':{n:'風雷益',u:'䷩',j:'利有攸往。',m:'損上益下，利於進取。'},
'55':{n:'巽為風',u:'䷸',j:'小亨，利有攸往。',m:'柔順漸進，以退為進。'},
'56':{n:'風水渙',u:'䷺',j:'亨，王假有廟。',m:'離散渙散，需凝聚人心。'},
'57':{n:'風山漸',u:'䷴',j:'女歸吉，利貞。',m:'循序漸進，穩步前行。'},
'58':{n:'風地觀',u:'䷓',j:'盥而不薦。',m:'觀察審視，以身作則。'},
'61':{n:'水天需',u:'䷄',j:'有孚，光亨。',m:'等待時機，耐心守候。'},
'62':{n:'水澤節',u:'䷻',j:'亨，苦節不可貞。',m:'適度節制，不可過度。'},
'63':{n:'水火既濟',u:'䷾',j:'亨小，利貞。',m:'事已成，居安思危。'},
'64':{n:'水雷屯',u:'䷂',j:'元亨利貞。',m:'創始之難，堅持終有成。'},
'65':{n:'水風井',u:'䷯',j:'改邑不改井。',m:'養民之源，不可荒廢。'},
'66':{n:'坎為水',u:'䷜',j:'有孚，維心亨。',m:'重重險難，以信心行險。'},
'67':{n:'水山蹇',u:'䷦',j:'利西南。',m:'前路艱險，退守反省。'},
'68':{n:'水地比',u:'䷇',j:'吉，卟筮元永貞。',m:'親附比和，團結互助。'},
'71':{n:'山天大畜',u:'䷙',j:'利貞，不家食吉。',m:'蓄積力量，博積薄發。'},
'72':{n:'山澤損',u:'䷨',j:'有孚，元吉。',m:'減損自己，利益他人。'},
'73':{n:'山火賁',u:'䷕',j:'亨，小利有攸往。',m:'文飾外表，不忘本質。'},
'74':{n:'山雷頤',u:'䷚',j:'貞吉，觀頤。',m:'養生之道，慍言節食。'},
'75':{n:'山風蠱',u:'䷑',j:'元亨，利涉大川。',m:'整治腐敗，撥亂反正。'},
'76':{n:'山水蒙',u:'䷃',j:'亨，匪我求童蒙。',m:'啟蒙之初，虛心學習。'},
'77':{n:'艮為山',u:'䷳',j:'艮其背，不獲其身。',m:'適可而止，靜止守分。'},
'78':{n:'山地剝',u:'䷖',j:'不利有攸往。',m:'衰落剝蝕，靜待復甦。'},
'81':{n:'地天泰',u:'䷊',j:'小往大來，吉亨。',m:'通泰和順，萬事亨通。'},
'82':{n:'地澤臨',u:'䷒',j:'元亨利貞。',m:'居高臨下，教化萬民。'},
'83':{n:'地火明夷',u:'䷣',j:'利艱貞。',m:'光明受傷，韜光養晦。'},
'84':{n:'地雷復',u:'䷗',j:'亨，出入無疾。',m:'一陽復始，否極泰來。'},
'85':{n:'地風升',u:'䷭',j:'元亨。',m:'逐步上升，積小成大。'},
'86':{n:'地水師',u:'䷆',j:'貞，丈人吉。',m:'統率眾人，以正為要。'},
'87':{n:'地山謙',u:'䷍',j:'亨，君子有終。',m:'謙虛自牧，吉無不利。'},
'88':{n:'坤為地',u:'䷁',j:'元亨，利牝馬之貞。',m:'柔順承載，博德包容。'}
};

function gByN(n){return BG[((n-1)%8+8)%8]}
function g64(un,ln){return G64[''+un+ln]||{n:'未知',u:'?',j:'',m:''}}
function gByL(l1,l2,l3){return BG.find(g=>g.li[0]===l1&&g.li[1]===l2&&g.li[2]===l3)||BG[7]}

function tiYong(ti,yo){
  if(ti===yo)return{r:'比和',f:'吉',d:'體用相同，事情順利。'};
  if(SHENG[yo]===ti)return{r:'用生體',f:'大吉',d:'外力助益，事半功倍。'};
  if(SHENG[ti]===yo)return{r:'體生用',f:'小凶',d:'耗費精力，付出多回報少。'};
  if(KE[yo]===ti)return{r:'用克體',f:'凶',d:'外力阻礙，困難重重。'};
  if(KE[ti]===yo)return{r:'體克用',f:'小吉',d:'可掌控局面，但需費力。'};
  return{r:'—',f:'平',d:''};
}

function calcMH(un,ln,dy){
  const up=gByN(un),lo=gByN(ln),dong=((dy-1)%6)+1;
  // up.n 就是數字(1-8)，直接用於 g64 查表
  const ben=g64(up.n, lo.n);
  const benL=[...lo.li,...up.li];
  const huLo=gByL(benL[1],benL[2],benL[3]);
  const huUp=gByL(benL[2],benL[3],benL[4]);
  const hu=g64(huUp.n, huLo.n);
  const biL=[...benL]; biL[dong-1]=biL[dong-1]?0:1;
  const biLo=gByL(biL[0],biL[1],biL[2]);
  const biUp=gByL(biL[3],biL[4],biL[5]);
  const bian=g64(biUp.n, biLo.n);
  const tiG=dong<=3?up:lo, yoG=dong<=3?lo:up;
  const ty=tiYong(tiG.el,yoG.el);
  return{up,lo,dong,ben,hu,bian,tiG,yoG,ty};
}

function guaNum(g){return g.n==='乾'?1:g.n==='兌'?2:g.n==='離'?3:g.n==='震'?4:g.n==='巽'?5:g.n==='坎'?6:g.n==='艮'?7:8}

function renderYaoLines(lines, dong){
  let html='<div class="yao-visual">';
  for(let i=5;i>=0;i--){
    const isYang=lines[i]===1;
    const isDong=dong&&(i+1)===dong;
    html+=`<div class="yao-row${isDong?' yao-dong':''}" title="${isDong?'◀ 動爻':'第'+(i+1)+'爻'}">`;
    if(isYang) html+=`<div style="width:100%;height:4px;background:${isDong?'#e8c968':'rgba(255,255,255,0.7)'}"></div>`;
    else html+=`<div style="width:42%;height:4px;background:${isDong?'#e8c968':'rgba(255,255,255,0.7)'}"></div><div style="width:12%"></div><div style="width:42%;height:4px;background:${isDong?'#e8c968':'rgba(255,255,255,0.7)'}"></div>`;
    if(isDong) html+=`<span style="color:#e8c968;font-size:0.6rem;margin-left:4px">◀</span>`;
    html+=`</div>`;
  }
  html+='</div>';
  return html;
}

function showMH(r){
  S.meihua=r;
  // 六爻圖 + 卦名
  const benL2=[...r.lo.li,...r.up.li];
  const bianL2=[...benL2]; bianL2[r.dong-1]=bianL2[r.dong-1]?0:1;
  const huL2=[benL2[1],benL2[2],benL2[3],benL2[2],benL2[3],benL2[4]];
  document.getElementById('mh-ben-s').innerHTML=typeof renderYaoLines==='function'?renderYaoLines(benL2,r.dong):r.ben.u;
  document.getElementById('mh-ben-n').textContent=r.ben.n;
  document.getElementById('mh-hu-s').innerHTML=typeof renderYaoLines==='function'?renderYaoLines(huL2):r.hu.u;
  document.getElementById('mh-hu-n').textContent=r.hu.n;
  document.getElementById('mh-bian-s').innerHTML=typeof renderYaoLines==='function'?renderYaoLines(bianL2):r.bian.u;
  document.getElementById('mh-bian-n').textContent=r.bian.n;
  document.getElementById('mh-detail').innerHTML=`
    <p><strong>體卦：</strong>${r.tiG.name}（${r.tiG.el}）｜<strong>用卦：</strong>${r.yoG.name}（${r.yoG.el}）</p>
    <p><strong>體用：</strong><span class="tag tag-gold">${r.ty.r}</span> <span class="tag ${r.ty.f.includes('吉')?'tag-green':'tag-red'}">${r.ty.f}</span></p>
    <p class="mt-sm">${r.ty.d}</p><div class="divider"></div>
    <p><strong>卦辭：</strong>${r.ben.j}</p><p><strong>解讀：</strong>${r.ben.m}</p>
    <p><strong>動爻：</strong>第 ${r.dong} 爻</p><p class="mt-sm"><strong>變卦：</strong>${r.bian.m}</p>`;
  document.getElementById('mh-result').classList.remove('hidden');
}

/* 漢字筆畫數（簡表） */
const BIHUA_MAP={'愛':13,'情':11,'錢':16,'財':10,'工':3,'作':7,'事':8,'業':13,'健':11,'康':11,'家':10,'庭':10,'人':2,'際':14,'運':12,'勢':13,'感':13,'婚':11,'姻':9,'學':16,'習':11,'考':6,'試':13,'升':4,'職':18,'轉':18};
function bihua(ch){return BIHUA_MAP[ch]||((ch.charCodeAt(0)%20)+2)}

function setMhMethod(m){
  ['time','number','char','random'].forEach(id=>{
    document.getElementById('mhf-'+id).classList.toggle('hidden',id!==m);
    const btn=document.getElementById('mh-m-'+id);
    if(id===m){btn.classList.remove('btn-outline');btn.classList.add('btn-tab-active')}
    else{btn.classList.add('btn-outline');btn.classList.remove('btn-tab-active')}
  });
}
function calcMhTime(){
  const now=new Date();
  const y=now.getFullYear(),mo=now.getMonth()+1,d=now.getDate();
  const h=now.getHours(),mi=now.getMinutes(),sec=now.getSeconds();

  // 正統梅花時間起卦（簡化版）
  // 先轉農曆（使用lunar-javascript庫）
  let lunarY=y, lunarM=mo, lunarD=d;
  try {
    if(typeof Lunar!=='undefined'&&Lunar.Solar){
      const solar=Lunar.Solar.fromYmd(y,mo,d);
      const lunar=solar.getLunar();
      lunarY=lunar.getYear(); lunarM=lunar.getMonth(); lunarD=lunar.getDay();
    }
  } catch(e){}

  // 年地支數（子1丑2...亥12）
  const yzhi=((lunarY-4)%12+12)%12+1;
  // 時辰（子1丑2...亥12）
  const shichen=Math.floor(((h+1)%24)/2)+1;

  // 上卦 = (年支+農曆月+農曆日) % 8
  const upNum=(yzhi+lunarM+lunarD)%8||8;
  // 下卦 = (年支+農曆月+農曆日+時辰) % 8
  const loNum=(yzhi+lunarM+lunarD+shichen)%8||8;
  // 動爻 = (年支+農曆月+農曆日+時辰) % 6
  const dongNum=(yzhi+lunarM+lunarD+shichen)%6||6;

  // 顯示起卦時間資訊
  const info=document.getElementById('mh-detail');

  showMH(calcMH(upNum,loNum,dongNum));

  // 在結果下追加起卦資訊
  if(info){
    const extra=document.createElement('div');
    extra.className='mt-sm text-xs text-dim';
    extra.innerHTML=`<p>起卦時間：${y}/${mo}/${d} ${h}:${String(mi).padStart(2,'0')} ｜ 農曆：${lunarM}月${lunarD}日 ｜ 時辰：第${shichen}辰</p>
      <p>上卦數：${upNum}(${['坤','乾','兌','離','震','巽','坎','艮'][upNum-1]||'?'}) ｜ 下卦數：${loNum}(${['坤','乾','兌','離','震','巽','坎','艮'][loNum-1]||'?'}) ｜ 動爻：${dongNum}</p>`;
    info.appendChild(extra);
  }
}
function calcMhNumber(){
  const n1=parseInt(document.getElementById('mh-n1').value)||1;
  const n2=parseInt(document.getElementById('mh-n2').value)||1;
  const n3=parseInt(document.getElementById('mh-n3').value)||1;
  showMH(calcMH(n1,n2,Math.min(6,Math.max(1,n3))));
}
function calcMhChar(){
  const ch=document.getElementById('mh-char').value.trim();
  if(!ch){alert('請輸入漢字');return}
  const chars=[...ch];
  let un,ln,dy;
  if(chars.length===1){un=bihua(chars[0]);ln=un;dy=(un*2)%6||6}
  else if(chars.length===2){un=bihua(chars[0]);ln=bihua(chars[1]);dy=(un+ln)%6||6}
  else{un=bihua(chars[0])+bihua(chars[1]);ln=bihua(chars[chars.length-1]);dy=(un+ln)%6||6}
  showMH(calcMH(un,ln,dy));
}
function calcMhRandom(){
  showMH(calcMH(Math.ceil(Math.random()*8),Math.ceil(Math.random()*8),Math.ceil(Math.random()*6)));
}
/* =============================================================
   塔羅牌 TAROT — 22大牌 + 凱爾特十字牌陣
   ============================================================= */
const TAROT=[
  {id:0,n:'愚者',el:'風',up:'充滿無限可能，勇敢踏出第一步。',rv:'魯莽行事，缺乏計畫。'},
  {id:1,n:'魔術師',el:'水星',up:'擁有成功所需的一切資源。',rv:'才能未發揮，注意欺騙。'},
  {id:2,n:'女祭司',el:'月亮',up:'傾聽直覺，靜待時機。',rv:'過於封閉，忽視內心聲音。'},
  {id:3,n:'皇名',el:'金星',up:'豐收與滋養，創造力旺盛。',rv:'依賴他人，過度放縱。'},
  {id:4,n:'皇帝',el:'白羊',up:'掌控局面，建立秩序。',rv:'控制欲強，過於僵化。'},
  {id:5,n:'教皇',el:'金牛',up:'遵循正道，尋求智者指引。',rv:'教條主義，不知變通。'},
  {id:6,n:'戀人',el:'雙子',up:'做出重要選擇，真愛降臨。',rv:'關係不和，價值觀衝突。'},
  {id:7,n:'戰車',el:'巨蟹',up:'堅定意志，克服困難前進。',rv:'失捧，方向不明。'},
  {id:8,n:'力量',el:'獅子',up:'以柔克剛，內在力量強大。',rv:'自我懷疑，缺乏信心。'},
  {id:9,n:'隱者',el:'處女',up:'獨處反省，尋找內在智慧。',rv:'過度孤立，逃避現實。'},
  {id:10,n:'命運之輪',el:'木星',up:'命運轉折，好運降臨。',rv:'逆境，抗拒改變。'},
  {id:11,n:'正義',el:'天秤',up:'公正的結果，因果報應。',rv:'不公、偏見。'},
  {id:12,n:'吊人',el:'水',up:'換角度看問題，暫時犧牲。',rv:'不必要的犧牲，拖延。'},
  {id:13,n:'死神',el:'天蠍',up:'舊的結束，新的開始。',rv:'抗拒改變，停滯不前。'},
  {id:14,n:'節制',el:'射手',up:'保持中庸，調和各方。',rv:'失衡，過度。'},
  {id:15,n:'惡魔',el:'摩羯',up:'面對陰暗面，物質誘惑。',rv:'擺脫束縛，重獲自由。'},
  {id:16,n:'塔',el:'火星',up:'突然改變，舊結構崩塌。',rv:'避開災難，拒絕改變。'},
  {id:17,n:'星星',el:'水瓶',up:'希望之光，靈感湧現。',rv:'失望，缺乏信心。'},
  {id:18,n:'月亮',el:'雙魚',up:'面對恐懼，穿越迷霧。',rv:'走出迷惘，真相顯現。'},
  {id:19,n:'太陽',el:'太陽',up:'一切光明正大，喜悅成功。',rv:'短暫陰霾，信心不足。'},
  {id:20,n:'審判',el:'冥王星',up:'靈魂覺醒，重新評估。',rv:'自我懷疑，拒絕成長。'},
  {id:21,n:'世界',el:'土星',up:'達成目標，圓滿完成。',rv:'未完成，缺乏圓滿。'},
  // 小阿爾卡納 — 權杖
  {id:22,n:'權杖王牌',el:'火',up:'新計畫啟動，創造力迸發。',rv:'延遲，猶豫不決。'},
  {id:23,n:'權杖二',el:'火',up:'計畫中，等待時機。',rv:'恐懼改變，缺乏遠見。'},
  {id:24,n:'權杖三',el:'火',up:'拓展視野，合作順利。',rv:'缺乏遠見，計畫受阻。'},
  {id:25,n:'權杖四',el:'火',up:'慶祝成就，和諧穩定。',rv:'不安定，缺乏歸屬感。'},
  {id:26,n:'權杖五',el:'火',up:'競爭激烈，需堅持立場。',rv:'逃避衝突，內耗。'},
  {id:27,n:'權杖六',el:'火',up:'勝利與認可，公開成功。',rv:'自負，缺乏認可。'},
  {id:28,n:'權杖七',el:'火',up:'堅守立場，面對挑戰。',rv:'力不從心，被壓倒。'},
  {id:29,n:'權杖八',el:'火',up:'快速發展，消息到來。',rv:'延遲，急躁。'},
  {id:30,n:'權杖九',el:'火',up:'堅持到底，最後防線。',rv:'疲憊，固執。'},
  {id:31,n:'權杖十',el:'火',up:'責任沉重，堅持前行。',rv:'放下重擔，委派他人。'},
  {id:32,n:'權杖侍者',el:'火',up:'好消息，新冒險。',rv:'不切實際的計畫。'},
  {id:33,n:'權杖騎士',el:'火',up:'行動力強，追求熱情。',rv:'衝動，魯莽。'},
  {id:34,n:'權杖皇名',el:'火',up:'自信、魅力，激勵他人。',rv:'嫉妒，自我中心。'},
  {id:35,n:'權杖國王',el:'火',up:'領導力強，願景宏大。',rv:'傲慢，嚴苛。'},
  // 聖杯
  {id:36,n:'聖杯王牌',el:'水',up:'新感情開始，情感充沛。',rv:'感情封閉，錯失機會。'},
  {id:37,n:'聖杯二',el:'水',up:'伴侶關係，相互吸引。',rv:'失衡，溝通不良。'},
  {id:38,n:'聖杯三',el:'水',up:'歡慶友誼，社交活動。',rv:'過度放縱，孤立。'},
  {id:39,n:'聖杯四',el:'水',up:'對現狀不滿，錯失機會。',rv:'重新審視，發現新可能。'},
  {id:40,n:'聖杯五',el:'水',up:'失落與悲傷，但仍有希望。',rv:'走出悲傷，接受現實。'},
  {id:41,n:'聖杯六',el:'水',up:'懷舊，童年回憶。',rv:'活在過去，無法前進。'},
  {id:42,n:'聖杯七',el:'水',up:'太多選擇，需分辨幻象。',rv:'做出決定，面對現實。'},
  {id:43,n:'聖杯八',el:'水',up:'離開不再適合的，尋找更深。',rv:'恐懼改變，留在舒適區。'},
  {id:44,n:'聖杯九',el:'水',up:'願望實現，滿足感。',rv:'不滿，物質主義。'},
  {id:45,n:'聖杯十',el:'水',up:'情感圓滿，家庭幸福。',rv:'家庭問題，不和諧。'},
  {id:46,n:'聖杯侍者',el:'水',up:'浪漫訊息，直覺發展。',rv:'情緒不穩，不成熟。'},
  {id:47,n:'聖杯騎士',el:'水',up:'浪漫追求者，感性行動。',rv:'情緒化，不切實際。'},
  {id:48,n:'聖杯皇名',el:'水',up:'慈愛，情感豐富，直覺強。',rv:'情緒化，過度付出。'},
  {id:49,n:'聖杯國王',el:'水',up:'情感成熟，慷慨智慧。',rv:'情感壓抑，操捧。'},
  // 寶劍
  {id:50,n:'寶劍王牌',el:'風',up:'真相與突破，新想法。',rv:'混亂思緒，錯誤判斷。'},
  {id:51,n:'寶劍二',el:'風',up:'抉擇困難，需平衡思考。',rv:'資訊過載，逃避決定。'},
  {id:52,n:'寶劍三',el:'風',up:'心碍，悲痛，需要療癒。',rv:'走出傷痛，開始復卟。'},
  {id:53,n:'寶劍四',el:'風',up:'休息恢復，靜養。',rv:'焦躁不安，不願休息。'},
  {id:54,n:'寶劍五',el:'風',up:'衝突與失敗，自私行為。',rv:'和解，學會認輸。'},
  {id:55,n:'寶劍六',el:'風',up:'離開困境，過渡期。',rv:'困住，無法離開。'},
  {id:56,n:'寶劍七',el:'風',up:'策略行動，但需注意欺騙。',rv:'真相揭露，良心不安。'},
  {id:57,n:'寶劍八',el:'風',up:'自我限制，困境是心造。',rv:'解脫束縛，看清真相。'},
  {id:58,n:'寶劍九',el:'風',up:'焦慮、恐懼、失眠。',rv:'面對恐懼，走出焦慮。'},
  {id:59,n:'寶劍十',el:'風',up:'結束與放下，觸底反彈。',rv:'最壞已過，開始恢復。'},
  {id:60,n:'寶劍侍者',el:'風',up:'好奇心，新想法。',rv:'八卦，冷漠。'},
  {id:61,n:'寶劍騎士',el:'風',up:'思路清晰，快速行動。',rv:'衝動發言，缺乏同理。'},
  {id:62,n:'寶劍皇名',el:'風',up:'獨立思考，真相。',rv:'冷酷，過於理性。'},
  {id:63,n:'寶劍國王',el:'風',up:'理性權威，公正判斷。',rv:'獨裁，冷酷無情。'},
  // 金幣
  {id:64,n:'金幣王牌',el:'土',up:'新財務機會，物質豐盛。',rv:'錯失良機，貪婪。'},
  {id:65,n:'金幣二',el:'土',up:'平衡，適應變化。',rv:'失衡，優先順序混亂。'},
  {id:66,n:'金幣三',el:'土',up:'團隊合作，技能提升。',rv:'缺乏協作，品質不佳。'},
  {id:67,n:'金幣四',el:'土',up:'守財，安全感。',rv:'過度吝嗇，恐懼失卻。'},
  {id:68,n:'金幣五',el:'土',up:'困難時期，物質匱乏。',rv:'走出困境，援助到來。'},
  {id:69,n:'金幣六',el:'土',up:'慷慨，施與受的平衡。',rv:'債務，單方面付出。'},
  {id:70,n:'金幣七',el:'土',up:'耐心等待收獲。',rv:'急躁，缺乏耐心。'},
  {id:71,n:'金幣八',el:'土',up:'精進技藝，專注投入。',rv:'缺乏熱情，敷衍了事。'},
  {id:72,n:'金幣九',el:'土',up:'豐收，自給自足。',rv:'過度自足，財務風險。'},
  {id:73,n:'金幣十',el:'土',up:'家族財富，長久穩定。',rv:'家庭財務問題。'},
  {id:74,n:'金幣侍者',el:'土',up:'學習機會，務實目標。',rv:'缺乏方向，浪費資源。'},
  {id:75,n:'金幣騎士',el:'土',up:'穩健前進，有效率。',rv:'固執，過度保守。'},
  {id:76,n:'金幣皇名',el:'土',up:'富足，安全，實際。',rv:'不安全感，過度物質。'},
  {id:77,n:'金幣國王',el:'土',up:'財務成功，領導力。',rv:'貪婪，過度控制。'}
];

const CELTIC_POS=['核心現狀','阻礙因素','過去基礎','未來發展','可能結果','近期未來','自我態度','環境影響','希望恐懼','最終結果'];

let drawnCards=[];
function drawCard(){
  if(drawnCards.length>=10)return;
  const avail=TAROT.filter(c=>!drawnCards.find(d=>d.id===c.id));
  const card=avail[Math.floor(Math.random()*avail.length)];
  const isUp=Math.random()>0.35;
  drawnCards.push({...card,isUp,pos:CELTIC_POS[drawnCards.length]});
  renderDrawn();
  if(drawnCards.length>=10){
    document.getElementById('btn-draw').disabled=true;
    document.getElementById('btn-analyze').disabled=false;
    showSpread();
  }
}
function autoDraw(){while(drawnCards.length<10)drawCard()}

function renderDrawn(){
  const el=document.getElementById('t-hand');
  document.getElementById('t-remain').textContent=10-drawnCards.length;
  el.innerHTML=drawnCards.map((c,i)=>{
    const imgSrc=typeof getTarotCardImage==='function'?getTarotCardImage(c):'';
    return `
    <div class="t-card flipped" title="${c.n}">
      <div class="t-card-inner">
        <div class="t-card-face t-back"></div>
        <div class="t-card-face t-front ${c.isUp?'':''}">
          ${imgSrc?`<img src="${imgSrc}" alt="${c.n}" class="tc-img" style="${c.isUp?'':'transform:rotate(180deg)'}">`:``}
          <span class="tc-name" style="${c.isUp?'':'transform:rotate(180deg)'}">${c.n}</span>
          <span class="tc-dir">${c.isUp?'正位':'逆位'}</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

function showSpread(){
  S.tarot.drawn=drawnCards;
  S.tarot.spread=drawnCards;
  document.getElementById('t-spread-sec').classList.remove('hidden');
  const el=document.getElementById('t-spread');
  el.innerHTML=drawnCards.map((c,i)=>{
    const imgSrc=typeof getTarotCardImage==='function'?getTarotCardImage(c):'';
    return `
    <div class="card" style="padding:var(--sp-md);margin-bottom:var(--sp-sm)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--sp-xs)">
        <span class="tag tag-gold">${i+1}. ${c.pos}</span>
        <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'正位':'逆位'}</span>
      </div>
      <div style="display:flex;gap:var(--sp-md);align-items:flex-start">
        ${imgSrc?`<img src="${imgSrc}" alt="${c.n}" class="tc-spread-img" style="width:72px;height:112px;border-radius:6px;flex-shrink:0;${c.isUp?'':'transform:rotate(180deg)'}">`:``}
        <div>
          <strong class="text-gold serif">${c.n}</strong>
          <p class="text-sm text-dim mt-sm">${c.isUp?c.up:c.rv}</p>
        </div>
      </div>
    </div>`;
  }).join('');
}
/* =============================================================
   RENDER FUNCTIONS — 結果頁渲染
   ============================================================= */
function showDim(id){
  const map={bazi:'八字',ziwei:'紫微',meihua:'梅花',tarot:'塔羅',name:'姓名'};
  document.querySelectorAll('.dim-tab').forEach(t=>{
    const match=Object.entries(map).find(([k,v])=>t.textContent.includes(v));
    t.classList.toggle('active',match&&match[0]===id);
  });
  document.querySelectorAll('.dim-pane').forEach(p=>p.classList.toggle('active',p.id==='pane-'+id));
}

function renderBazi(){
  const b=S.bazi; if(!b)return;
  const p=b.pillars;
  const labels=['時柱','日柱','月柱','年柱'];
  const cols=['hour','day','month','year'];

  // 四柱表格
  let html='<div class="bazi-grid">';
  html+=cols.map((_,i)=>`<div class="bazi-cell header">${labels[i]}</div>`).join('');
  // 天干行
  html+=cols.map(c=>{
    const g=p[c].gan;
    return`<div class="bazi-cell"><span class="gz">${g}</span><span class="el-tag el-${WX_G[g]}">${WX_G[g]}</span><div class="gz-sub">${c==='day'?'日主':b.gods[c].gan}</div></div>`;
  }).join('');
  // 地支行 (十二長生)
  html+=cols.map(c=>{
    const z=p[c].zhi;
    // 自坐：各柱天干對照自己的地支
    const selfSit=changSheng(p[c].gan,z);
    return`<div class="bazi-cell"><span class="gz">${z}</span><span class="el-tag el-${WX_Z[z]}">${WX_Z[z]}</span><div class="gz-sub">${b.cs[c]}</div><div class="gz-sub" style="font-size:0.6rem;opacity:0.5">坐${selfSit}</div></div>`;
  }).join('');
  // 藏干行
  html+=cols.map(c=>{
    const cg=b.cangGan[c]||[];
    return`<div class="bazi-cell"><div class="gz-sub">藏干</div>${cg.map(g=>`<span class="el-tag el-${WX_G[g]}" style="margin:1px">${g}</span>`).join('')}</div>`;
  }).join('');
  html+='</div>';

  // 納音
  html+=`<p class="text-sm text-dim mt-sm">納音：${b.nayin} ｜ 身${b.strong?'<span class="text-success">強</span>':'<span class="text-danger">弱</span>'} ｜ 日主：${b.dm}（${b.dmEl}）</p>`;
  html+=`<p class="text-xs text-dim">得令：${b.deLing?'✓':'✗'}(${b.dmMonthState}) ｜ 得地：${b.deDi?'✓':'✗'} ｜ 得勢：${b.deShi?'✓':'✗'} ｜ 同黨${b.selfRatio}%</p>`;
  html+=`<p class="text-xs text-dim">五行(60分)：`;
  for(const el of ['金','木','水','火','土']){
    const score=Math.round(b.ec[el]);
    html+=`${el}${score} `;
  }
  html+=`</p>`;
  html+=`<p class="text-xs text-dim">喜用神：<span class="text-success">${b.fav.join('、')}</span> ｜ 忌神：<span class="text-danger">${b.unfav.join('、')}</span></p>`;
  document.getElementById('d-bazi').innerHTML=html;

  // 五行柱狀圖 (60分制，含月令旺衰)
  const els=['金','木','水','火','土'];
  const colors={金:'var(--el-metal)',木:'var(--el-wood)',水:'var(--el-water)',火:'var(--el-fire)',土:'var(--el-earth)'};
  const WX_STATE={};
  for(const e of els){
    const mzEl=WX_Z[p.month.zhi];
    if(e===mzEl) WX_STATE[e]='旺';
    else if(SHENG[e]===mzEl) WX_STATE[e]='休';
    else if(SHENG[mzEl]===e) WX_STATE[e]='相';
    else if(KE[e]===mzEl) WX_STATE[e]='囚';
    else if(KE[mzEl]===e) WX_STATE[e]='死';
    else WX_STATE[e]='休';
  }
  document.getElementById('d-elbar').innerHTML='<div class="el-bar">'+els.map(e=>{
    const score=Math.round(b.ec[e]);
    return`<div class="el-row"><span class="el-lbl" style="color:${colors[e]}">${e}<span style="font-size:0.7rem;opacity:0.7"> ${WX_STATE[e]}</span></span>
    <div class="el-track"><div class="el-fill" style="width:${Math.round(score/60*100)}%;background:${colors[e]}"></div></div>
    <span class="el-val">${score}</span></div>`;
  }).join('')+'</div>';

  // 十神
  document.getElementById('d-gods').innerHTML=`
    <div class="bazi-grid" style="margin:0">
      ${cols.map((_,i)=>`<div class="bazi-cell header">${labels[i]}</div>`).join('')}
      ${cols.map(c=>`<div class="bazi-cell"><strong>${b.gods[c].gan}</strong></div>`).join('')}
      ${cols.map(c=>`<div class="bazi-cell">${(b.gods[c].zhi||[]).join('<br>')}</div>`).join('')}
    </div>`;

  // 藏干
  document.getElementById('d-canggan').innerHTML=cols.map(c=>{
    const cg=b.cangGan[c]||[];
    return`<p><strong>${labels[cols.indexOf(c)]}（${p[c].zhi}）：</strong>${cg.map(g=>`${g}(${WX_G[g]}/${tenGod(b.dm,g)})`).join('、')||'—'}</p>`;
  }).join('');

  // 喜用忌神 + 神煞
  document.getElementById('d-xiyong').innerHTML=`
    <p><strong>喜用神：</strong>${b.fav.map(e=>`<span class="tag tag-green">${e}</span>`).join(' ')}</p>
    <p class="mt-sm"><strong>忌　神：</strong>${b.unfav.map(e=>`<span class="tag tag-red">${e}</span>`).join(' ')}</p>
    ${b.shensha.length?`<p class="mt-sm"><strong>神　煞：</strong>${b.shensha.map(s=>`<span class="tag tag-gold">${s}</span>`).join(' ')}</p>`:''}`;

  // 大運
  document.getElementById('d-dayun').innerHTML='<div class="dayun-tl">'+b.dayun.map(d=>{
    const lvClass=d.level==='大吉'?'lv-dj':d.level==='中吉'?'lv-zj':d.level==='小吉'?'lv-xj':d.level==='平'?'lv-p':d.level==='小凶'?'lv-xk':d.level==='中凶'?'lv-zk':'lv-dk';
    const notesTip=d.notes&&d.notes.length?d.notes.slice(0,4).join('；'):'';
    return`<div class="dy-item ${d.isCurrent?'current':''}" title="${notesTip}">
      <span class="dy-gz">${d.gz}</span><span class="dy-age">${d.ageStart}-${d.ageEnd}歲</span>
      <span class="dy-lv ${lvClass}">${d.level}</span><div class="gz-sub">${d.god}</div>
      ${d.ganScore!==undefined?'<div style="font-size:0.6rem;opacity:0.5;margin-top:2px">干'+(d.ganScore>0?'↑':'↓')+' 支'+(d.zhiScore>0?'↑':'↓')+'</div>':''}</div>`;
  }).join('')+'</div>';
  // 當前大運流年詳情
  const curDy=b.dayun.find(d=>d.isCurrent);
  if(curDy&&curDy.liuNian){
    let lnHtml='<details style="margin-top:0.8rem"><summary style="cursor:pointer;font-size:0.85rem;color:var(--c-gold,#d4af37)">📅 當前大運'+curDy.gz+'（'+curDy.level+'）流年明細</summary><div style="padding:0.5rem;font-size:0.82rem;line-height:1.6">';
    if(curDy.notes&&curDy.notes.length) lnHtml+='<p style="margin-bottom:0.5rem;color:var(--c-gold)">大運特徵：'+curDy.notes.slice(0,4).join('、')+'</p>';
    lnHtml+='<table style="width:100%;border-collapse:collapse;font-size:0.78rem"><tr style="opacity:0.6"><th>年份</th><th>干支</th><th>十神</th><th>吉凶</th><th>重點提示</th></tr>';
    curDy.liuNian.forEach(ln=>{
      const color=ln.level.includes('吉')?'#4caf50':ln.level.includes('凶')?'#f44336':'#999';
      const note=ln.notes&&ln.notes.length?ln.notes[0]:'—';
      const isCur=ln.year===new Date().getFullYear();
      lnHtml+=`<tr style="${isCur?'background:rgba(212,175,55,0.15);font-weight:bold':''}"><td>${ln.year}${isCur?' ◀':''}</td><td>${ln.gz}</td><td>${ln.god}</td><td style="color:${color}">${ln.level}</td><td style="font-size:0.72rem;opacity:0.8">${note}</td></tr>`;
    });
    lnHtml+='</table></div></details>';
    document.getElementById('d-dayun').innerHTML+=lnHtml;
  }
}



function renderMeihua(){
  if(!S.meihua){document.getElementById('r-meihua').innerHTML='<p class="text-dim">未進行梅花易數起卦</p>';return}
  const r=S.meihua;
  
  // 構建六爻
  const benLines=[...r.lo.li,...r.up.li];
  const bianLines=[...benLines]; bianLines[r.dong-1]=bianLines[r.dong-1]?0:1;
  const huLines=[benLines[1],benLines[2],benLines[3],benLines[2],benLines[3],benLines[4]];

  document.getElementById('r-meihua').innerHTML=`
    <div class="hex-grid">
      <div class="hex-card"><h4>本卦</h4>${renderYaoLines(benLines,r.dong)}<div class="hex-name" style="margin-top:0.5rem;font-size:1.1rem">${r.ben.n}</div><div class="hex-sym" style="font-size:1.5rem;opacity:0.5">${r.ben.u}</div></div>
      <div class="hex-card"><h4>互卦</h4>${renderYaoLines(huLines)}<div class="hex-name" style="margin-top:0.5rem;font-size:1.1rem">${r.hu.n}</div><div class="hex-sym" style="font-size:1.5rem;opacity:0.5">${r.hu.u}</div></div>
      <div class="hex-card"><h4>變卦</h4>${renderYaoLines(bianLines)}<div class="hex-name" style="margin-top:0.5rem;font-size:1.1rem">${r.bian.n}</div><div class="hex-sym" style="font-size:1.5rem;opacity:0.5">${r.bian.u}</div></div>
    </div>
    <p class="mt-md"><strong>體用：</strong><span class="tag tag-gold">${r.ty.r}</span> <span class="tag ${r.ty.f.includes('吉')?'tag-green':'tag-red'}">${r.ty.f}</span> — ${r.ty.d}</p>
    <p class="mt-sm"><strong>卦辭：</strong>${r.ben.j}</p>
    <p><strong>解讀：</strong>${r.ben.m}</p>
    <p><strong>動爻：</strong>第 ${r.dong} 爻（${benLines[r.dong-1]?'陽→陰':'陰→陽'}）</p>
    <p><strong>變卦：</strong>${r.bian.m}</p>`;
}

function renderTarot(){
  if(!S.tarot.drawn.length){document.getElementById('r-tarot').innerHTML='<p class="text-dim">未進行塔羅抽牌</p>';return}
  document.getElementById('r-tarot').innerHTML=S.tarot.drawn.map((c,i)=>{
    const imgSrc=typeof getTarotCardImage==='function'?getTarotCardImage(c):'';
    return `
    <div style="display:flex;gap:var(--sp-md);align-items:flex-start;padding:var(--sp-sm) 0;border-bottom:1px solid var(--c-border)">
      <span class="tag tag-gold" style="flex:0 0 auto">${i+1}</span>
      ${imgSrc?`<img src="${imgSrc}" alt="${c.n}" style="width:56px;height:88px;border-radius:4px;flex-shrink:0;border:1px solid rgba(212,175,55,0.3);${c.isUp?'':'transform:rotate(180deg)'}">`:``}
      <div><strong class="text-gold">${c.pos}</strong>：${c.n} <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'正':'逆'}</span>
      <p class="text-sm text-dim">${c.isUp?c.up:c.rv}</p></div>
    </div>`;
  }).join('');
}

/* =============================================================
   ANALYSIS ENGINE — 綜合評分
   ============================================================= */
function _runAnalysisV1_unused(){
  renderBazi(); renderMeihua(); renderTarot();

  const b=S.bazi; if(!b)return;
  const type=S.form.type;
  const question=S.form.question;

  // — 八字評分 (0-100) —
  let baziScore=50;
  // 身強+有財官 = 高分；身弱+有印比 = 中分
  if(b.strong){
    if(b.ep[KE[b.dmEl]]>15)baziScore+=15; // 有財
    if(b.ep[BE_KE[b.dmEl]]>10)baziScore+=10; // 有官
  }else{
    if(b.ep[BE_SHENG[b.dmEl]]>15)baziScore+=15; // 有印
    if(b.ep[b.dmEl]>15)baziScore+=10;
  }
  // 當前大運加分
  const curDy=b.dayun.find(d=>d.isCurrent);
  if(curDy){
    if(curDy.level.includes('吉'))baziScore+=10;
    if(curDy.level.includes('凶'))baziScore-=10;
  }
  // 神煞
  if(b.shensha.includes('天乙貴人'))baziScore+=5;
  if(b.shensha.includes('文昌'))baziScore+=3;
  baziScore=Math.max(10,Math.min(90,baziScore));

  // — 梅花評分 —
  let mhScore=50;
  if(S.meihua){
    const f=S.meihua.ty.f;
    if(f==='大吉')mhScore=80;
    else if(f==='吉')mhScore=70;
    else if(f==='小吉')mhScore=60;
    else if(f==='小凶')mhScore=35;
    else if(f==='凶')mhScore=20;
  }

  // — 塔羅評分 —
  let tarotScore=50;
  if(S.tarot.drawn.length){
    let pos=0,neg=0;
    S.tarot.drawn.forEach(c=>{
      // 正位的正面牌 +1，逆位的負面牌 -1
      const goodCards=[0,1,3,6,8,10,14,17,19,21];
      const badCards=[13,15,16,18];
      if(c.isUp&&goodCards.includes(c.id))pos++;
      if(!c.isUp&&badCards.includes(c.id))neg++;
      if(c.isUp&&!badCards.includes(c.id))pos+=0.5;
      if(!c.isUp)neg+=0.3;
    });
    tarotScore=Math.round(50+pos*5-neg*5);
    tarotScore=Math.max(10,Math.min(90,tarotScore));
  }

  // — 綜合 —
  const weights={bazi:0.4,meihua:S.meihua?0.3:0,tarot:S.tarot.drawn.length?0.3:0};
  const totalW=weights.bazi+weights.meihua+weights.tarot;
  const finalProb=Math.round((baziScore*weights.bazi+mhScore*weights.meihua+tarotScore*weights.tarot)/totalW);

  // Verdict
  let vlabel,vnote;
  if(finalProb>=70){vlabel='偏向可行 ✅';vnote='多維度指標偏一致，適合捨進，但仍需按建議捧風險。'}
  else if(finalProb>=45){vlabel='中性偏可行 ⚖️';vnote='有利與阻力並存；照建議調整做法，勝率會上升。'}
  else if(finalProb>=25){vlabel='偏保守 ⚠️';vnote='阻力訊號較多，建議先降位成本/試水溫，再談放大。'}
  else{vlabel='不建議硬捨 ⛔';vnote='目前象徵偏逆風；若要做，務必設停損與替代方案。'}

  document.getElementById('r-vlabel').textContent=vlabel;
  document.getElementById('r-vprob').textContent=finalProb+'%';
  document.getElementById('r-vnote').textContent=vnote;
  document.getElementById('r-pfill').style.width=finalProb+'%';
  document.getElementById('r-question').innerHTML=`<strong>問題：</strong>${question}<br><span class="tag tag-gold">${getTypeLabel(type)}</span>${(S.form.btime===''||!document.getElementById('f-btime')?.value)?'<br><span class="text-xs" style="color:var(--c-warn)"><i class="fas fa-exclamation-triangle"></i> 出生時間未填，以 12:00 估算，時柱及部分判定準確度降低</span>':''}`;

  // Direct answer
  const answer=generateAnswer(type,finalProb,b,S.meihua,S.tarot);
  document.getElementById('r-answer').innerHTML=answer.text;
  document.getElementById('r-factors').innerHTML=answer.factors?`<div class="detail-toggle-wrap" style="margin-top:.5rem"><div class="detail-toggle-btn" onclick="this.parentElement.classList.toggle('open')" style="cursor:pointer;display:flex;align-items:center;gap:.5rem;color:var(--c-text-dim);font-size:.85rem;padding:.3rem 0"><i class="fas fa-chevron-right" style="font-size:.7rem;transition:transform .3s"></i><span>影響因子（${answer.factors.length}項）</span></div><div class="detail-toggle-body" style="max-height:0;overflow:hidden;transition:max-height .4s ease"><ul class="text-sm" style="padding:.5rem 1.2rem;color:var(--c-text-dim)">${answer.factors.map(f=>'<li style="margin:.3rem 0">'+f+'</li>').join('')}</ul></div></div>`:'';
  document.getElementById('r-suggest').innerHTML=answer.suggestions?`<h4 class="text-gold serif mt-md mb-sm">行動建議</h4><ol class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.suggestions.map(s=>'<li style="margin:.3rem 0">'+s+'</li>').join('')}</ol>`:'';

  // Probability breakdown
  document.getElementById('r-pbreak').innerHTML=`
    <p>八字命理：${baziScore}% (權重${Math.round(weights.bazi/totalW*100)}%)</p>
    ${S.meihua?`<p>梅花易數：${mhScore}% (權重${Math.round(weights.meihua/totalW*100)}%)</p>`:''}
    ${S.tarot.drawn.length?`<p>塔羅牌陣：${tarotScore}% (權重${Math.round(weights.tarot/totalW*100)}%)</p>`:''}`;

  // Crystal recommendation
  renderCrystal(b);

  // Conclusion
  document.getElementById('r-conclusion').innerHTML=generateConclusion(type,finalProb,b,S.meihua,S.tarot);
}

function getTypeLabel(t){return{love:'感情',career:'事業',wealth:'財運',health:'健康',relationship:'人際',family:'家庭',general:'事業',other:'事業'}[t]||'事業'}

/* ═══════════════════════════════════════════════════════════
   問答對齊引擎 — 解析使用者問句，產出針對性回答
   ═══════════════════════════════════════════════════════════ */
function parseQuestionIntent(question, type) {
  const q = question || '';
  const result = {
    isYesNo: false,       // 是否是「會不會/能不能/好不好」
    isWhen: false,        // 何時
    isWho: false,         // 誰/什麼人
    isAge: false,         // 幾歲/年齡
    isHow: false,         // 如何/怎麼
    isCompare: false,     // A還是B
    isAmount: false,      // 多少/幾個
    isDirection: false,   // 方向/卻向/哪裡
    isShould: false,      // 該不該/要不要
    isMeetNew: false,     // 遇到/找到新對象、新工作、新機會
    isQuality: false,     // 關於品質/真假/好壞（真正愛我、真心、靠譜）
    subject: '',          // 問題主題
    optionA: '',          // 選項A
    optionB: '',          // 選項B
    keywords: [],         // 關鍵詞
    rawQuestion: q
  };

  // 是非題
  if(/[會能可有]不[會能可有]|是否|是不是|好不好|適合嗎|行嗎|可以嗎|嗎[？?]?$/.test(q)) result.isYesNo = true;
  if(/該不該|要不要|應不應該|值不值/.test(q)) { result.isShould = true; result.isYesNo = true; }

  // 時間題
  if(/何時|什麼時候|幾時|多久|幾月|哪一年|今年|明年|幾年/.test(q)) result.isWhen = true;

  // 年齡題
  if(/幾歲|多大|年齡|多老|年紀/.test(q)) result.isAge = true;

  // 誰/什麼人
  if(/是誰|什麼人|什麼樣的人|哪[個位種]人|什麼類型|什麼個性/.test(q)) result.isWho = true;

  // 如何題
  if(/如何|怎麼|怎樣|方法|辦法|做法|策略/.test(q)) result.isHow = true;

  // 選擇題
  const compareMatch = q.match(/(.{1,15})[還是或](.{1,15})/);
  if(compareMatch) {
    result.isCompare = true;
    result.optionA = compareMatch[1].trim();
    result.optionB = compareMatch[2].trim();
  }

  // 數量題
  if(/多少|幾[個位張條隻]/.test(q)) result.isAmount = true;

  // 方向題
  if(/哪裡|何處|卻哪|方向|地點|城市|國家/.test(q)) result.isDirection = true;

  // 遇到/找到新事物（不是問已有對象，而是問「能不能遇到」）
  if(/遇到|找到|碰到|認識到|等到|出現|降臨|來到/.test(q) && /[人對象伴侶工作機會]/.test(q)) result.isMeetNew = true;
  // 「遇到真正愛我的人」「找到對的人」也算
  if(/遇到.*[人對象]|找到.*[人對象]|等到.*[人對象]|出現.*[人對象]/.test(q)) result.isMeetNew = true;

  // 品質/真偽問題（真正愛我、真心對我、靠譜、值得信任）
  if(/真正|真心|真的|認真|靠譜|值得|穩定.*對象|長久|一輩子/.test(q)) result.isQuality = true;

  // 提取關鍵詞
  const kw = q.replace(/[？?！!，,。.、的了嗎呢吧啊喔哦]/g, '').trim();
  result.keywords = kw.split(/\s+/).filter(w => w.length >= 2);

  // ═══ 主語方向偵測（主動vs被動）═══
  // 被動：等待對方/外部做某事
  result.isPassive = /有人|對方|他會|她會|他們會|別人|跟我|向我|來找我|主動找|會不會來|會來|追我|找我|連絡我|聯繫我|告白我|跟我告白|向我告白|對我|喜歡我|愛我|想我|回來找|有沒有人|會錄取|會加薪|會提拔|會升|會答應|會還|會通過|會同意|會幫|會支持|會接受|會原諒|公司會|老闆會|主管會|家人會|父母會|還我|給我|幫我/.test(q);
  // 主動：我去做某事
  result.isActive = /我[要想去該能可會]|我去|我主動|我追|我告白|我找|我聯繫|我連絡|能追到|追得到|追到|我能|我可以|我來|我做|我投|我買|我賣|我換|我辭|我創/.test(q);

  // 提取主題（六大方向都要有對應詞彙）
  const TOPIC_DICT = {
    love: /另一半|對象|他|她|伴侶|男友|女友|老公|老婆|愛人|戀人|曖昧|前任|桃花|結婚|離婚|復合|分手|告白|追|喜歡|暗戀|正緣|偏緣|緣分|姻緣|感情|戀愛|愛情|婚姻/,
    career: /工作|事業|公司|職業|升遷|轉職|創業|面試|老闆|同事|考試|學業|讀書|進修|加薪|離職|跳槽|副業|主管|職場|就業|換工作/,
    wealth: /錢|財|投資|股票|基金|房|薪水|收入|存款|理財|借貸|債|買|賣|賺|虧|開源|節流|中獎|偏財|正財/,
    health: /身體|健康|病|痛|不舒服|過敏|失眠|睡眠|疲勞|累|精神|情緒|壓力|焦慮|憂鬱|手術|開刀|懷孕|生育|視力|腸胃|心臟|肝|腎|肺|脾|頭|腰|背|皮膚|過勞|養生|中醫|西醫|減肥|運動|飲食|注意|調理|體質|免疫|血壓|血糖|濕氣/,
    relationship: /朋友|人際|社交|合作|貴人|小人|同學|鄰居|合夥|團隊|溝通|衝突|吵架|誤會|信任|被騙|背叛|口舌|是非/,
    family: /家人|父母|爸|媽|兒子|女兒|小孩|孩子|親子|長輩|公婆|婆媳|手足|兄弟|姊妹|家庭|搬家|房子|裝潢|遺產/
  };
  
  if(TOPIC_DICT[type]) {
    result.subject = q.match(TOPIC_DICT[type])?.[0] || {love:'感情',career:'事業',wealth:'財運',health:'身體狀況',relationship:'人際關係',family:'家庭'}[type];
  } else {
    result.subject = kw.slice(0, 10) || '所問之事';
  }
  
  // 健康專屬：辨識問的是哪個部位/症狀
  if(type === 'health') {
    result.healthOrgan = q.match(/肝|心|脾|胃|肺|腎|腸|膽|膀胱|頭|眼|耳|口|鼻|喉|腰|背|骨|關節|皮膚|血|神經/)?.[0] || null;
    result.healthSymptom = q.match(/痛|累|失眠|焦慮|憂鬱|過敏|發炎|腫|麻|暈|噁心|咳|喘|便秘|腹瀉|濕疹|掉髮/)?.[0] || null;
  }

  return result;
}

function generateQAResponse(intent, type, prob, bazi, mh, tarot) {
  const dm=bazi.dm, el=bazi.dmEl, strong=bazi.strong;
  const fav=bazi.fav||[], unfav=bazi.unfav||[];
  const curDy=bazi.dayun?bazi.dayun.find(d=>d.isCurrent):null;
  const thisYear=new Date().getFullYear();
  let liuNian=null;
  if(curDy&&curDy.liuNian) liuNian=curDy.liuNian.find(l=>l.year===thisYear);
  const q=intent.rawQuestion||'';

  /* ═══ 綜合評分（四步分析法） ═══ */
  let score=0, evidence=[];
  // 大運（含互動分析）
  if(curDy){
    score+=curDy.score>0?Math.min(curDy.score*0.5,3):Math.max(curDy.score*0.5,-3);
    evidence.push('大運'+curDy.gz+'（'+curDy.level+'）');
    // 大運前5年/後5年
    if(curDy.ganScore&&curDy.zhiScore){
      const curAge=thisYear-(bazi.pillars?parseInt(bazi.pillars.year?.gan||0):0);
      // 粗略判斷在前5年還是後5年
      if(curDy.ganScore!==0) evidence.push('天干'+curDy.gz[0]+(curDy.ganScore>0?'（喜·前五年順）':'（忌·前五年逆）'));
    }
    // 大運關鍵互動
    if(curDy.notes) curDy.notes.forEach(n=>evidence.push(n));
  }
  // 流年（含三柱互動）
  if(liuNian){
    score+=liuNian.score>0?Math.min(liuNian.score*0.4,3):Math.max(liuNian.score*0.4,-3);
    evidence.push('今年流年'+liuNian.gz+'（'+liuNian.level+'）');
    if(liuNian.notes) liuNian.notes.slice(0,3).forEach(n=>evidence.push(n));
    // 流年事象推導
    if(liuNian.events&&liuNian.events.length) evidence.push('事象：'+liuNian.events[0]);
  }

  // ═══ 紫微斗數輔助判定（象徵體系）═══
  const zw=S.ziwei;
  let zwDxHint='', zwLnHint='', zwDxTheme='', zwLnFocus='';
  if(zw){
    const TYPE_GONG={love:'夫妻',career:'官祿',wealth:'財帛',health:'疾厄',relationship:'交友',family:'田宅'};
    const relevantGong=TYPE_GONG[type];

    // 紫微大限
    const curDx=zw.daXian?zw.daXian.find(d=>d.isCurrent):null;
    if(curDx){
      const dxAdj=curDx.score>0?Math.min(curDx.score*0.3,2.5):Math.max(curDx.score*0.3,-2.5);
      score+=dxAdj;

      // 大限主星亮度
      let dxInfo='紫微大限走「'+curDx.palaceName+'」宮（'+curDx.level+'）';
      if(curDx.bright&&curDx.bright.length){
        const brightStr=curDx.bright.map(b=>b.star+b.label).join('、');
        dxInfo+='，'+brightStr;
      }
      evidence.push(dxInfo);

      // 大限宮位象徵
      if(curDx.theme){zwDxTheme=curDx.theme;evidence.push('十年主題：'+curDx.theme);}

      // 大限星曜組合notes（廟旺+吉煞+特殊格局）
      if(curDx.notes){
        curDx.notes.slice(0,5).forEach(n=>{
          if(!n.includes('大限')) evidence.push('大限宮：'+n); // 避免重複前綴
          else evidence.push(n);
        });
      }

      // 大限四化對問題方向
      if(curDx.hua&&curDx.hua.length){
        curDx.hua.forEach(h=>{
          if(h.palace===relevantGong){
            if(h.hua==='化祿'){score+=1.5;evidence.push('大限'+h.star+'化祿入'+h.palace+'→ 此方面有福氣');}
            if(h.hua==='化權'){score+=1;evidence.push('大限'+h.star+'化權入'+h.palace+'→ 有掌控力');}
            if(h.hua==='化科'){score+=0.5;evidence.push('大限'+h.star+'化科入'+h.palace+'→ 貴人相助');}
            if(h.hua==='化忌'){score-=1.5;evidence.push('大限'+h.star+'化忌入'+h.palace+'→ 此方面有困擾');}
          }
          if(h.palace==='命宮'){
            if(h.hua==='化祿'){score+=0.5;evidence.push('大限化祿入命，整體加持');}
            if(h.hua==='化忌'){score-=0.5;evidence.push('大限化忌入命，整體壓力');}
          }
        });
      }
      zwDxHint=curDx.palaceName+'（'+curDx.stars.join('、')+' '+curDx.level+'）';
    }

    // 紫微流年盤
    if(zw.getLiuNianZw){
      try{
        const zwLn=zw.getLiuNianZw(thisYear);
        if(zwLn){
          const lnAdj=zwLn.score>0?Math.min(zwLn.score*0.25,1.5):Math.max(zwLn.score*0.25,-1.5);
          score+=lnAdj;

          // 流年命宮+亮度
          let lnInfo='紫微流年命宮走「'+zwLn.mingPalace+'」';
          if(zwLn.bright&&zwLn.bright.length) lnInfo+='（'+zwLn.bright.map(b=>b.star+b.label).join('、')+' ）';
          evidence.push(lnInfo);
          if(zwLn.focus){zwLnFocus=zwLn.focus;evidence.push('今年重點：'+zwLn.focus);}

          // 流年星曜組合notes
          if(zwLn.notes) zwLn.notes.slice(0,3).forEach(n=>evidence.push('流年：'+n));

          // 流年四化對問題方向
          if(zwLn.hua&&zwLn.hua.length){
            zwLn.hua.forEach(h=>{
              if(h.palace===relevantGong||h.palace==='命宮'){
                if(h.hua==='化祿'){score+=1;evidence.push('流年'+h.star+'化祿入'+h.palace);}
                if(h.hua==='化忌'){score-=1;evidence.push('流年'+h.star+'化忌入'+h.palace);}
              }
            });
          }
          zwLnHint=zwLn.mingPalace;
        }
      }catch(e){}
    }
  }
  if(mh){
    if(mh.ty.f.includes('大吉')){score+=3;evidence.push('梅花卦象（大吉）');}
    else if(mh.ty.f==='吉'||mh.ty.f.includes('吉')){score+=2;evidence.push('梅花卦象（'+mh.ty.f+'）');}
    else if(mh.ty.f.includes('凶')){score-=2;evidence.push('梅花卦象（'+mh.ty.f+'）');}
    else{evidence.push('梅花卦象（'+mh.ty.f+'）');}
  }
  if(tarot&&tarot.drawn&&tarot.drawn.length>=10){
    const up=tarot.drawn.filter(c=>c.isUp).length;
    if(up>=7){score+=2;evidence.push('塔羅'+up+'張正位');}
    else if(up>=5){score+=1;evidence.push('塔羅'+up+'張正位');}
    else if(up<=3){score-=2;evidence.push('塔羅僅'+up+'張正位');}
    else{evidence.push('塔羅'+up+'張正位');}
  }
  const great=score>=4, good=score>=1, bad=score<=-2;

  /* 問法 */
  const isYN=intent.isYesNo, isWhen=intent.isWhen, isHow=intent.isHow;
  const isWhy=/為什麼|為何|怎麼會|什麼原因|原因/.test(q);
  const isChoice=intent.isShould||intent.isCompare;

  /* 時間 */
  let goodYears=[], badYears=[];
  if(curDy&&curDy.liuNian){
    goodYears=curDy.liuNian.filter(ln=>ln.level.includes('吉')).map(ln=>ln.year+'年').slice(0,3);
    badYears=curDy.liuNian.filter(ln=>ln.level.includes('凶')).map(ln=>ln.year+'年').slice(0,2);
  }
  const yearInfo=goodYears.length?'有利年份：'+goodYears.join('、')+'。':'';
  const dyInfo=curDy?'目前大運'+curDy.gz+'（'+curDy.level+'）'+(curDy.notes&&curDy.notes.length?'，'+curDy.notes[0]:'')+'。':'';
  // 流年事象提示
  let lnEventHint='';
  if(liuNian&&liuNian.events&&liuNian.events.length) lnEventHint=liuNian.events[0];
  let lnClashHint='';
  if(liuNian&&liuNian.clash&&liuNian.clash.length) lnClashHint=liuNian.clash.map(c=>{const g=typeof GONG_EVENT!=='undefined'?GONG_EVENT[c]:null;return g?g.domain:'';}).filter(x=>x).join('、');

  /* 行動 */
  const favEl=fav[0]||'土';
  const FC={金:'白/銀',木:'綠',水:'藍/黑',火:'紅/紫',土:'黃/棕'};
  const FD={金:'西方',木:'東方',水:'北方',火:'南方',土:'中央'};

  let answer='', detail='', tip='';

  // ================== 💕 感情 ==================
  if(type==='love'){
    const pk=bazi.shensha&&bazi.shensha.includes('桃花');
    const hl=bazi.shensha&&bazi.shensha.includes('紅鸞');
    if(isYN){
      if(/復合|回來|挽回/.test(q)){
        const passive=intent.isPassive||/他會|她會|會回來|會不會回/.test(q);
        if(passive){
          // 被動：對方會回來嗎
          if(great) answer='<strong>有機會。</strong> 運勢顯示你們之間的緣分還沒斷，對方心裡還有你的位置。不需要刻意做什麼，保持好自己的狀態，對方會注意到你的改變。';
          else if(good) answer='<strong>有一些可能。</strong> 對方可能偶爾會想起你，但還沒下定決心。給對方空間，不要追得太緊，時間會幫你說話。';
          else answer='<strong>短期內不太樂觀。</strong> 對方目前沒有回頭的打算。與其等待，不如先專注自己的成長。緣分到了，自然會有轉機。';
        }else{
          // 主動：我要挽回/復合
          if(great) answer='<strong>有機會復合。</strong> 運勢顯示你們之間的緣分還沒斷，現在主動聯繫，對方接受的機率比你想的高。';
          else if(good) answer='<strong>有一些機會。</strong> 對方心裡還有你，但需要你先展現改變，而不是重蹈覆轍。';
          else answer='<strong>目前很難。</strong> 對方需要更多時間和空間，強行挽回反而會把人推得更遠。先專注自己的成長。';
        }
      }else if(/結婚|嫁|娶|求婚/.test(q)){
        if(great) answer='<strong>婚運很好！</strong> '+(hl?'你命帶紅鸞星，近期特別有利結婚。':'目前運勢非常支持步入婚姻。')+'如果雙方有共識，今年就是好時機。';
        else if(good) answer='<strong>時機逐漸成熟。</strong> 婚姻大事不急，但運勢是支持的。把關係穩定下來，自然水到渠成。';
        else answer='<strong>建議不急。</strong> 目前不是匆忙決定婚事的好時機，先確認彼此是否真的適合。';
      }else if(intent.isMeetNew || /遇到|找到|碰到|認識|等到.*對[象的]|正緣|真愛|真正愛|對的人|穩定.*對象/.test(q)){
        // ★ 問「能不能遇到/找到對的人、真正愛我的人」— 不是問特定對象
        const timeHint=isWhen?(good?'今年運勢支持桃花，時機正在靠近。':'今年桃花能量還在蓄積，不要急。'):'';
        if(great) answer='<strong>有機會遇到！</strong> '+(pk?'你命帶桃花，加上運勢大好，今年遇到認真對你的人的機率很高。':'目前桃花能量旺盛，認真經營社交圈，對的人就在不遠處。')+'關鍵是你要先清楚自己要什麼樣的人，才不會重蹈覆轍。'+timeHint;
        else if(good) answer='<strong>有機會，但要自己篩選。</strong> '+(pk?'你桃花不缺，問題不是遇不到人，而是遇到的品質參差不齊。':'運勢偏好，異性緣有提升。')+'建議提高標準、不要因為寂寞就將就。慢慢來，寧缺勿濫才能遇到真心的。'+timeHint;
        else if(!bad) answer='<strong>有可能，但需要時間。</strong> 目前桃花能量不算特別強，不太容易一下子就遇到完全對的人。先把自己生活過好——有自己的興趣、朋友圈、穩定的心態，好的對象反而會被你吸引。'+timeHint;
        else answer='<strong>短期內可能要耐心等。</strong> 目前感情磁場偏弱，容易遇到不適合的人。'+(/只想上|只想.*身體|不認真|玩玩|渣/.test(q)?'你的直覺沒有錯，現階段確實容易吸引到不認真的對象。先暫停感情上的追求，把能量放在自己身上，當你狀態變好了，吸引來的人品質也會不同。':'先專注提升自己，等桃花運轉好了，自然會遇到對的人。');
        tip='多穿'+FC[favEl]+'色系提升正桃花。'+(pk?'桃花方位佩戴粉晶篩選正緣。':'佩戴粉晶+白水晶，招桃花的同時淨化爛桃花。');
      }else if(/喜歡|愛我|在意|心裡有我/.test(q) && !intent.isMeetNew){
        if(/喜歡我|愛我|在意我|心裡有我/.test(q)){
          // 問特定對方對我的感覺（確認不是「遇到愛我的人」）
          if(good) answer='<strong>從命理看，你是有吸引力的。</strong> '+(pk?'你命帶桃花，異性緣本來就好。':'')+'對方對你有好感的機率不低，但最終還是要從互動中確認。你可以觀察對方有沒有主動找你聊天、約你出去的跡象。';
          else answer='<strong>對方可能還在猶豫。</strong> 目前你的感情磁場不夠強，可能讓對方感受不到明確的信號。試著多互動，讓對方有機會認識真正的你。';
        }else{
          // 問我喜歡的人（我喜歡他/她嗎等）
          if(good) answer='<strong>從你的桃花能量來看，你是有吸引力的。</strong> '+(pk?'你命帶桃花，異性緣本來就好。':'')+'跟著心走，不要過度分析。';
          else answer='<strong>你目前的感情磁場偏弱。</strong> 先把自己狀態調好，自信是最好的桃花。';
        }
      }else if(/追|告白|表白/.test(q)){
        const passive=intent.isPassive;
        if(passive){
          // 被動：有人會追我/跟我告白嗎
          if(great) answer='<strong>有機會！</strong> 你目前的桃花能量很強，'+(pk?'命帶桃花加上運勢大好，':'')+'確實容易吸引到主動靠近的人。保持開放的態度，機會就在身邊。';
          else if(good) answer='<strong>有一些可能。</strong> 你的魅力有被注意到，但對方可能還在觀望。如果你釋出一點善意的信號，對方更容易跨出那一步。';
          else answer='<strong>短期內可能要等等。</strong> 目前桃花能量不夠強，不太容易吸引到主動告白的人。先把自己狀態調到最好，自信本身就是最強的桃花。';
        }else{
          // 主動：我去追/告白
          if(great) answer='<strong>去吧！</strong> 運勢強力支持你主動出擊，真誠表達比套路更打動人。';
          else if(good) answer='<strong>可以試試。</strong> 但不要一次押太重，先從約對方吃飯開始，循序漸進。';
          else answer='<strong>先緩緩。</strong> 現在告白時機不太對，先從朋友關係慢慢經營，等感覺更熟了再說。';
        }
      }else if(/分手/.test(q)){
        if(good) answer='<strong>目前關係穩定。</strong> 運勢不支持分手的方向，有問題可以溝通解決。';
        else answer='<strong>感情確實在一個低潮期。</strong> 但低潮不代表要分手，先冷靜想想問題的根源是什麼。';
      }else{
        const passive=intent.isPassive;
        if(passive){
          // 被動：有人會...嗎 / 他/她會...嗎
          if(great) answer='<strong>有機會的。</strong> 運勢顯示你在感情上有被眷顧的跡象，對方（或潛在對象）是有可能主動的。';
          else if(good) answer='<strong>有一些可能。</strong> 但需要一點時間醞釀，不要太著急。保持你的魅力和開放態度。';
          else if(!bad) answer='<strong>可能要再等等。</strong> 目前對方還沒有明確的行動跡象。順其自然，不要給自己太大壓力。';
          else answer='<strong>短期內比較難。</strong> 感情磁場偏弱，不太容易等到對方主動。先照顧好自己。';
        }else{
          if(great) answer='<strong>會的。</strong> 各方面運勢都指向正面，感情方面很有機會。';
          else if(good) answer='<strong>有機會。</strong> 多數指標正面，關鍵在於你願不願意主動。';
          else if(!bad) answer='<strong>有可能，但急不來。</strong> 條件還不完全成熟，邊調整邊等待。';
          else answer='<strong>目前比較困難。</strong> 感情能量偏弱，先把自己狀態調好再說。';
        }
      }
      tip='多穿'+FC[favEl]+'色系增加好感度。'+(pk?'桃花方位佩戴粉晶效果更好。':'佩戴粉晶提升桃花磁場。');
    }else if(isWhen){
      if(good) answer='<strong>時機正在成熟。</strong> '+dyInfo+yearInfo+(pk?'你有桃花，有利年份特別容易遇到對的人。':'多參加社交活動，緣分就在身邊。');
      else answer='<strong>需要再等等。</strong> '+dyInfo+'目前感情運還在醞釀中。'+yearInfo+'在有利年份多出門社交。';
      tip='有利時期穿'+FC[favEl]+'色出門，增加桃花能量。';
    }else if(isHow){
      answer='<strong>具體建議：</strong>';
      if(/挽回|復合/.test(q)) detail='不要苦苦哀求，那只會降低你的價值。先讓自己變得更好——外表、心態、生活都是。當對方看到你的改變，自然會重新被吸引。';
      else if(/桃花|認識|遇到/.test(q)) detail=(pk?'你本身桃花不錯，不是認識不到人，而是要選對人。':'多參加朋友聚會、興趣社團、運動課程，這些場合最容易遇到合適的對象。')+'不要宅在家等緣分來敲門。';
      else detail=(strong?'你容易太強勢，感情裡學會「示弱」，讓對方感受到被需要。':'你太被動了，喜歡就說，不要等對方來猜。很多緣分就是被「等」掉的。');
      tip='穿'+FC[favEl]+'色系、往'+FD[favEl]+'方向社交。佩戴粉晶或紅紋石。';
    }else if(isWhy){
      if(/單身/.test(q)) answer=(strong?'<strong>你太有主見了。</strong> 條件不差但容易讓對方有壓力。試著放軟姿態，不要什麼都你說了算。':'<strong>你太被動了。</strong> 等待的人永遠在等待。緣分不會從天上掉下來，你得自己走出去。')+(bad?' 加上目前感情運低迷，確實不容易。但運勢會轉的，先準備好自己。':'');
      else if(/不順|吵|冷/.test(q)) answer=(good?'<strong>其實問題不大。</strong> 你們只是在磨合期，所有關係都會經歷這個階段。多溝通、少指責。':'<strong>感情確實在低潮。</strong> 但低潮是暫時的。先檢視自己在關係裡是不是太用力（或太不用力）了。');
      else answer=(strong?'<strong>你的控制欲可能讓對方喘不過氣。</strong> 愛不是掌控，是信任和空間。':'<strong>你在感情裡太委屈自己了。</strong> 一味退讓不會讓關係更好，反而讓對方不珍惜。');
      tip='調整心態比改變命運更有效。穿'+FC[favEl]+'色增強自信。';
    }else if(isChoice){
      if(good) answer='<strong>選讓你心安的那個。</strong> 運勢支持你做決定，跟著感覺走不會錯。';
      else answer='<strong>先不急著選。</strong> 目前判斷力可能受情緒影響，給自己一點時間觀察。';
      detail=strong?'你適合找能包容你強勢個性的人，太溫順的反而磨合多。':'你適合找給你安全感、能當靠山的人，不要被花言巧語迷惑。';
      tip='穿'+FC[favEl]+'色赴約，增加正確判斷力。';
    }else{
      if(great) answer='<strong>感情運很好！</strong> 今年是把握感情機會的黃金期。'+(pk?'命帶桃花加上大運吉，機會多到不行。':'主動出擊會有驚喜。');
      else if(good) answer='<strong>感情運不錯。</strong> 有發展空間，但需要你主動。'+(pk?'桃花星在，機會不缺。':'多出門社交，增加遇到對的人的機率。');
      else if(!bad) answer='<strong>感情運平穩。</strong> 不會有大波折，但驚喜也不多。好好經營現有關係是重點。';
      else answer='<strong>感情運偏弱。</strong> 今年感情方面可能有些阻力。不急，先把自己狀態調好，好運會來的。';
      tip='穿'+FC[favEl]+'色系提升魅力。'+(pk?'佩戴粉晶加強桃花。':'');
    }
  }

  // ================== 💼 事業 ==================
  else if(type==='career'){
    const wc=bazi.shensha&&bazi.shensha.includes('文昌');
    const ym=bazi.shensha&&bazi.shensha.includes('驛馬');
    if(isYN){
      if(/升遷|升職|加薪|晉升/.test(q)){
        const passive=intent.isPassive||/會升|會提拔|會加薪|老闆會|主管會/.test(q);
        if(passive){
          // 被動：主管會提拔我嗎/公司會加薪嗎
          if(great) answer='<strong>機會很大。</strong> 運勢顯示你的表現有被上面看到，主管心裡有數。這段時間做好份內的事，好消息會自己來。';
          else if(good) answer='<strong>有可能，但不是板上釘釘。</strong> 你是候選人之一，但決定權不在你手上。做好表現、保持好的人際關係，等待結果。';
          else answer='<strong>短期內不太樂觀。</strong> 目前公司/主管可能還沒有這個打算。不要氣餒，繼續累積實力，時機到了自然會輪到你。';
        }else{
          if(great) answer='<strong>很有機會！</strong> 今年運勢強力支持升遷，你的努力會被上面看到。把握這波，主動爭取，別等著被提拔。';
          else if(good) answer='<strong>有機會，但要自己推一把。</strong> 運勢偏好，但光做不說不行。適度讓主管知道你的成果，別當隱形人。';
          else if(!bad) answer='<strong>機會有，但競爭激烈。</strong> 你可能不是唯一的候選人，需要在關鍵時刻展現不可替代的價值。';
          else answer='<strong>今年升遷有難度。</strong> 不是你不夠好，而是時機還沒到。先默默累積實力，你的機會在後面。';
        }
      }else if(/考上|考試|考過|上榜|考運/.test(q)){
        if(great) answer='<strong>考運很好！</strong> '+(wc?'你命帶文昌星，天生利考試，加上運勢大好，好好準備幾乎穩了。':'運勢強力支持，只要有充分準備，上榜機率很高。');
        else if(good) answer='<strong>有機會考上。</strong> '+(wc?'文昌星幫助你在考場上發揮得好。':'運勢偏好，但別因此掉以輕心。')+'最後這段時間的衝刺是關鍵。';
        else if(!bad) answer='<strong>有挑戰但不是沒機會。</strong> 運勢不算特別幫忙，代表你要比別人更拼才行。把讀書時間再加一成。';
        else answer='<strong>這次可能有點懸。</strong> 運勢對考試不太有利。如果是重要考試，建議多給自己一次機會（下次再考），不要太大壓力。';
      }else if(/轉職|換工作|離職|跳槽/.test(q)){
        if(great) answer='<strong>現在是換跑道的好時機。</strong> '+(ym?'你命帶驛馬，本來就適合變動，現在運勢又好，果斷行動。':'運勢支持新方向，有好機會就大膽去。');
        else if(good) answer='<strong>可以開始物色新機會。</strong> 但別裸辭，先騎驢找馬。有了更好的 offer 再走也不遲。';
        else if(!bad) answer='<strong>可以準備，但別急著跳。</strong> 現在的機運還沒完全成熟，再觀察一陣子，等到真的好機會出現再動。';
        else answer='<strong>現在不是好時機。</strong> 運勢不利大變動，衝動離職的風險很高。忍一忍，先穩住現在的位子。';
      }else if(/創業|開店|開公司|自己做/.test(q)){
        if(great) answer='<strong>運勢非常支持創業！</strong> 天時地利人和都在你這邊。如果有準備好的項目，放手去做。';
        else if(good) answer='<strong>可以開始籌備。</strong> 但建議先試水溫——做副業或小規模測試，確認可行再全力投入。別一開始就 all in。';
        else if(!bad) answer='<strong>想法可以有，行動要謹慎。</strong> 運勢對創業不算特別有利，風險偏高。建議先累積更多資源和人脈再出手。';
        else answer='<strong>現在創業風險太高。</strong> 運勢不配合，失敗的機率大於成功。先穩穩工作，用業餘時間籌備，等運勢轉好再行動。';
      }else if(/裁員|失業|被開|被辭|資遣/.test(q)){
        if(good) answer='<strong>目前是安全的。</strong> 運勢穩定，不用太擔心。但也別因此鬆懈，保持好的表現是最好的保險。';
        else if(!bad) answer='<strong>有一些風險但可控。</strong> 做好本分、跟主管保持良好關係、別捲入辦公室政治，你就能穩住。';
        else answer='<strong>確實要有心理準備。</strong> 運勢顯示工作環境有不穩定因素。建議悄悄更新履歷、準備 Plan B，手上有選擇就不慌。';
      }else if(/面試|錄取|offer/.test(q)){
        const passive=intent.isPassive||/會錄取|會上|會通過|結果/.test(q);
        if(passive){
          // 被動：已面完等結果 / 公司會錄取我嗎
          if(great) answer='<strong>機會很大。</strong> 運勢顯示結果偏向正面，你的表現應該有留下好印象。耐心等消息。';
          else if(good) answer='<strong>有一定機會。</strong> 但可能需要再等一等，或者會有第二輪面試。不要因為等待就放棄其他機會。';
          else answer='<strong>結果可能不太理想。</strong> 不代表你不好，面試有很多變數。建議同時投其他公司，多一個選擇多一條路。';
        }else{
          if(great) answer='<strong>面試運很好！</strong> 自信地去，你的表現會讓對方印象深刻。';
          else if(good) answer='<strong>有機會錄取。</strong> 準備充分一點，把自己最好的一面展現出來。';
          else answer='<strong>可能需要多投幾家。</strong> 不要把期望放在一個籃子裡，多面試幾家增加機率。';
        }
      }else if(intent.isMeetNew || /找到.*工作|遇到.*機會|找到.*方向|遇到.*伯樂|遇到.*貴人|有沒有.*機會/.test(q)){
        // ★ 問「能不能找到好工作/遇到好機會」
        const timeHint=isWhen?(good?'今年運勢對求職有利。':'今年時機還在醞釀。'):'';
        if(great) answer='<strong>機會正在靠近！</strong> '+(ym?'你命帶驛馬，適合變動，新的好機會就在不遠處。':'運勢強力支持你找到新方向。')+'積極投遞、多參加活動，好消息會比你想的快。'+timeHint;
        else if(good) answer='<strong>有機會找到。</strong> 運勢偏好，但好工作不會自己來敲門。主動出擊——更新履歷、擴大人脈、多參加行業聚會，機會就在行動中。'+timeHint;
        else if(!bad) answer='<strong>需要多一點耐心。</strong> 好機會不是沒有，但可能不會馬上出現。先充實自己的能力和履歷，等準備好了，機會自然會來。'+timeHint;
        else answer='<strong>短期內可能要多嘗試。</strong> 運勢對求職不太配合，可能需要投更多家、面更多次。不要灰心，把每次面試當練習，運勢轉好後會有突破。'+timeHint;
      }else{
        if(great) answer='<strong>可以。</strong> 運勢各方面都支持，放手去做，會有好結果。';
        else if(good) answer='<strong>偏向可以。</strong> 多數指標正面，大膽行動。';
        else if(!bad) answer='<strong>有機會但要多努力。</strong> 不是不行，是需要比別人多推一把。';
        else answer='<strong>目前困難較多。</strong> 建議先蓄力等待更好時機。';
      }
      tip='穿'+FC[favEl]+'色去面試/重要場合。往'+FD[favEl]+'方向發展更有利。'+(wc?'考試進修是你的強項，多利用。':'');
    }else if(isWhen){
      if(good) answer='<strong>現在就是好時期。</strong> '+dyInfo+(yearInfo||'把握當下，別再猶豫。');
      else answer='<strong>最好再等等。</strong> '+dyInfo+(yearInfo||'先充實自己，等運勢轉好再出手。');
      tip='有利時期果斷行動，不利時期韜光養晦。';
    }else if(isHow){
      answer='<strong>給你三個具體建議：</strong>';
      detail='1️⃣ '+(strong?'你有領導力，爭取獨立負責項目或帶小團隊，展現管理能力。':'你適合當專業核心，把一項技能做到極致，讓自己不可替代。');
      detail+=' 2️⃣ '+(wc?'利用文昌運去考證照或進修，紙上談兵不如手上有牌。':'學一項新技能（AI工具、數據分析、語言能力），讓自己更有競爭力。');
      detail+=' 3️⃣ '+(ym?'你適合往外發展，跨區域或有出差機會的工作對你特別有利。':'找到一個賞識你的主管比什麼都重要，好老闆可以讓你少奮鬥十年。');
      tip='穿'+FC[favEl]+'色上班，往'+FD[favEl]+'方向通勤或開拓業務。';
    }else if(isWhy){
      if(/找不到|沒工作|失業/.test(q)) answer='<strong>不是你不行，是方法和時機的問題。</strong> '+(bad?'目前運勢偏弱，確實比較辛苦。但運勢是會轉的。':'運勢其實不差，問題可能在求職方向或面試表現上。')+'建議調整履歷亮點、擴大投遞範圍、找人模擬面試。';
      else if(/升遷|不順|卡住/.test(q)) answer=(strong?'<strong>你能力不差，但可能太有稜角。</strong> 職場不只看能力，也看關係。適度圓滑不是虛偽，是智慧。':'<strong>你太低調了。</strong> 默默做事但不被看到是職場最大的冤枉。學會「適度展現成果」，讓主管知道你做了什麼。')+(bad?' 加上目前運勢對事業不太配合，雙重影響下確實辛苦。':'');
      else answer=(strong?'<strong>你可能太急了。</strong> 事業需要時間累積，不要因為一時的不順就全盤否定自己。':'<strong>你可能太安於現狀了。</strong> 舒適圈待久了就不想動了，但機會不會等你準備好才來。')+(bad?' 運勢目前偏弱，但這是階段性的，不是永久的。':'');
      tip='穿'+FC[favEl]+'色增強工作能量。';
    }else if(isChoice){
      if(/留|走|待/.test(q)){
        answer=good?'<strong>如果新機會更好，可以走。</strong> 運勢支持變動，但要確認新的比舊的好，不要為了逃離而跳槽。':'<strong>建議先留下來。</strong> 現在不是大變動的好時機，先穩住，等更好的機會出現。';
      }else{
        answer=good?'<strong>選發展空間大的。</strong> 運勢好的時候要勇於選擇挑戰，不要選安逸。':'<strong>選穩定的。</strong> 現在不適合冒險，先求穩定，等運勢好了再追求突破。';
      }
      tip='做重大決定前穿'+FC[favEl]+'色，往'+FD[favEl]+'方向的公司更有利。';
    }else{
      if(great) answer='<strong>事業運大好！</strong> 今年是衝刺的黃金期，升遷、加薪、新機會都有可能，別浪費這波好運。';
      else if(good) answer='<strong>事業運不錯。</strong> 有往上走的趨勢，保持積極態度，機會會找上你。';
      else if(!bad) answer='<strong>事業運平穩。</strong> 沒什麼大風浪，穩定前進就好。這段時間適合充電學習。';
      else answer='<strong>事業運偏弱。</strong> 職場上可能有壓力或小人。低調做事、少管閒事、保持實力最重要。';
      tip='穿'+FC[favEl]+'色上班。'+(wc?'利用文昌運進修考證。':'')+(ym?'往外發展有驛馬星助力。':'');
    }
  }

  // ================== 💰 財運 ==================
  else if(type==='wealth'){
    const caiEl=typeof KE!=='undefined'?KE[el]:'';
    const caiPct=caiEl&&bazi.ep?bazi.ep[caiEl]:0;
    if(isYN){
      if(/投資|股|基金|加密|幣|ETF/.test(q)){
        const waiting=/回本|解套|會漲|會跌|賣掉|出場|停損|抱|持有/.test(q);
        if(waiting){
          // 已入場：等結果/該不該出場
          if(great) answer='<strong>可以繼續持有。</strong> 運勢偏好，目前的投資有回升的機會。但記得設好停利點，見好就收。';
          else if(good) answer='<strong>還有一些機會。</strong> 短期可能震盪，但方向不算太差。如果已經快到停損點，就按紀律走。';
          else answer='<strong>建議認真考慮減碼。</strong> 運勢對投資不利，死扛不一定等得到回本。先保住本金，留得青山在。';
        }else{
          // 未入場：能不能投
          if(great) answer='<strong>目前投資運不錯。</strong> 卦象和運勢都偏向正面，適合進場。但記住：再好的運勢也要設停損，不要把全部家當壓上去。';
          else if(good) answer='<strong>小額投入可以。</strong> 運勢偏好但不到穩賺不賠，控制在你能承受損失的範圍內。試水溫就好，別梭哈。';
          else if(!bad) answer='<strong>建議觀望。</strong> 目前運勢對投資不算有利，如果已經有部位就抱著，沒有的話不急著進場。';
          else answer='<strong>不建議現在投資。</strong> 運勢顯示財運低迷，進場虧損的機率偏高。守住現金，等運勢轉好再說。';
        }
      }else if(/買房|置產|買車|大額/.test(q)){
        if(great) answer='<strong>可以入手。</strong> 運勢支持大額購置，如果是剛需而且預算允許，今年是好時機。';
        else if(good) answer='<strong>可以考慮，但別超出預算。</strong> 運勢偏好，但量力而為。貸款壓力不要超過收入的40%。';
        else answer='<strong>建議再等等。</strong> 現在財運不夠穩，大額支出容易造成後續壓力。不急的話，等運勢更好的時候再出手。';
      }else if(/債|還錢|借|貸款/.test(q)){
        const passive=intent.isPassive||/還我|會還|他還|她還|對方還|借出/.test(q);
        if(passive){
          // 被動：別人會還我錢嗎
          if(good) answer='<strong>有機會拿回來。</strong> 運勢偏好，對方有可能還，但不要完全被動等。找個適當的時機提醒一下，態度溫和但明確。';
          else answer='<strong>要有心理準備可能拿不全。</strong> 運勢對催債不太有利，對方可能拖或只還一部分。如果金額大，考慮留下書面證據或走法律途徑。錢借出去的時候就要想到可能回不來。';
        }else{
          if(good) answer='<strong>財務狀況會逐漸好轉。</strong> 運勢支持你改善財務，建議制定還款計畫，一步一步來。小的先還，大的慢慢談。';
          else answer='<strong>過程會比較辛苦，但不是還不了。</strong> 運勢偏弱代表需要更多時間。先控制不必要的開支，最低還款額一定要繳，別讓信用破掉。';
        }
      }else if(/偏財|中獎|橫財|彩票|運氣/.test(q)){
        if(great&&caiPct>20) answer='<strong>偏財運不錯。</strong> 你的財星旺加上運勢好，小試手氣可以。但偏財就是偏財，不能當成主要收入，點到為止。';
        else if(good) answer='<strong>偏財運一般。</strong> 不是完全沒有，但別抱太大期望。娛樂性質玩玩可以，認真投入就傻了。';
        else answer='<strong>偏財運偏弱。</strong> 目前不是靠運氣賺錢的時候，踏踏實實的正財才是王道。';
      }else if(/賺|收入|薪|進帳/.test(q)){
        const passive=intent.isPassive||/會加薪|老闆會|公司會/.test(q);
        if(passive){
          // 被動：老闆會加薪嗎 / 公司會調薪嗎
          if(great) answer='<strong>加薪機會很大。</strong> 運勢顯示你的價值有被看到，今年有可能得到加薪或獎金。保持好表現就行。';
          else if(good) answer='<strong>有一些機會。</strong> 但不是鐵板釘釘。如果很久沒調了，可以找適當時機跟主管談談，但要用成績說話。';
          else answer='<strong>短期內加薪可能有難度。</strong> 不是你不值得，而是公司或環境因素。可以先充實自己的能力，等更好的時機再爭取。';
        }else{
          if(great) answer='<strong>財運很好！</strong> 今年有機會增加收入，不管是加薪、獎金還是副業，積極爭取會有回報。';
          else if(good) answer='<strong>收入有成長空間。</strong> 運勢偏好，但錢不會自己跑來，主動開源是關鍵。';
          else answer='<strong>收入可能持平或有壓力。</strong> 今年不太適合期待大幅加薪，穩住現有收入最重要。';
        }
      }else if(/改善|好轉|翻身|脫貧|財務自由|有錢|變好|賺到/.test(q) || (intent.isMeetNew && /錢|財|收入|機會/.test(q))){
        // ★ 問「財務能不能改善/什麼時候能翻身」
        const timeHint=isWhen?(good?'今年財運有起色的跡象。':'今年財運還在蓄積，急不來。'):'';
        if(great) answer='<strong>財務有明顯改善的機會！</strong> 運勢強力支持，只要你願意行動——開源比節流更重要。今年是積極理財的好時機。'+timeHint;
        else if(good) answer='<strong>會慢慢好起來的。</strong> 財運正在往上走，不會一夜暴富，但穩定成長是看得到的。重點是開始行動，比如學新技能、找副業、整理消費習慣。'+timeHint;
        else if(!bad) answer='<strong>需要時間和計畫。</strong> 財務改善不靠運氣靠方法。先記帳30天搞清楚錢花在哪，然後制定具體的開源節流計畫。一步一步來。'+timeHint;
        else answer='<strong>短期內比較辛苦。</strong> 運勢對財運不太配合，但這不是永遠的。先守住不虧損，減少不必要的支出，等運勢轉好後積極出擊。'+timeHint;
      }else{
        if(!bad) answer='<strong>有機會但要謹慎。</strong> 可以嘗試但控制風險。';
        else answer='<strong>目前建議保守。</strong> 守住現有的比追求新的更重要。';
      }
      tip='在'+FD[favEl]+'方位辦公或放錢包有助財運。穿'+FC[favEl]+'色談生意。';
    }else if(isWhen){
      if(good) answer='<strong>目前財運就不錯。</strong> '+dyInfo+(yearInfo||'把握當下，開源節流雙管齊下。');
      else answer='<strong>財運還在蓄勢中。</strong> '+dyInfo+(yearInfo||'現階段先存錢、少花，等運勢好了再積極出手。');
      tip='有利時期果斷出手，不利時期守住本金。';
    }else if(isHow){
      answer='<strong>給你三個理財建議：</strong>';
      detail='1️⃣ 開源：'+(caiPct>20?'你的財星旺，賺錢能力不差，重點是多找幾條收入管道（副業、接案、投資），別只靠死薪水。':'你的財星偏弱，靠運氣不如靠技術。學一項能變現的技能，比如寫程式、設計、線上教學。');
      detail+=' 2️⃣ 節流：每月固定存收入的20%，先存再花。記帳一個月，你會嚇一跳錢都花在哪裡了。';
      detail+=' 3️⃣ 投資：'+(good?'目前運勢支持投資，可以把閒錢放在低風險基金或ETF。':'現階段先存緊急預備金（3-6個月生活費），有了安全墊再想投資的事。');
      tip='錢包用'+FC[favEl]+'色，辦公桌往'+FD[favEl]+'方向。';
    }else if(isWhy){
      if(/存不到|月光|花光/.test(q)) answer='<strong>問題不在命，在習慣。</strong> 大部分人存不到錢不是因為賺得少，而是花得不知不覺。記帳30天你就知道問題在哪了。'+(bad?' 加上目前運勢財運偏弱，確實更容易有意外支出。':'');
      else if(/破財|虧|賠/.test(q)) answer=(bad?'<strong>目前運勢確實對財運不利。</strong> 這段時期容易有意外支出或判斷失誤。減少不必要的消費，不做高風險投資，撐過這段就好。':'<strong>可能是消費習慣或投資決策的問題。</strong> 運勢其實不差，檢視一下最近的支出和投資決定，是不是太衝動了。');
      else answer=(caiPct>20?'<strong>你不是不會賺，是不會守。</strong> 財星旺代表進帳能力好，但如果花得比賺得快，再旺也沒用。':'<strong>你的財星偏弱，需要比別人更努力開源。</strong> 不是命不好，是需要更有計畫地理財。')+(bad?' 目前運勢偏弱，更要控制支出。':'');
      tip='穿'+FC[favEl]+'色談錢。';
    }else if(isChoice){
      answer=good?'<strong>選回報更穩定的。</strong> 運勢好的時候可以稍微冒險，但也別貪。':'<strong>選風險低的。</strong> 現在不適合冒險，穩穩的比較安心。';
      tip='重大財務決定在'+FD[favEl]+'方位的銀行或辦公室進行。';
    }else{
      if(great) answer='<strong>財運大好！</strong> 今年是積極理財的好年份，加薪、獎金、副業、投資都有機會。別浪費這波。';
      else if(good) answer='<strong>財運不錯。</strong> 收入有成長空間，把握機會開源。';
      else if(!bad) answer='<strong>財運平穩。</strong> 不會大賺也不會大虧，穩定存錢最重要。';
      else answer='<strong>財運偏弱。</strong> 注意控制支出，避免衝動消費和高風險投資。';
      tip='穿'+FC[favEl]+'色增強財運。錢包放'+FD[favEl]+'方位。';
    }
  }

  // ================== 🏥 健康 ==================
  else if(type==='health'){
    const WO={金:'肺、呼吸系統、皮膚',木:'肝、眼睛、筋絡',水:'腎、泌尿系統、腰骨',火:'心臟、血壓、睡眠',土:'脾胃、消化系統'};
    const WF={金:'白色食物（山藥、百合、白蘿蔔、杏仁）',木:'綠色蔬菜（菠菜、花椰菜、奇異果、綠茶）',水:'黑色食物（黑芝麻、海帶、黑豆、藍莓）',火:'紅色食物（紅棗、枸杞、番茄、櫻桃）',土:'黃色食物（南瓜、玉米、地瓜、薑）'};
    const WH={金:'深呼吸練習、戶外健走、保濕護膚、少吃辛辣',木:'伸展瑜珈、11點前睡、少生氣、護眼（少看手機）',水:'泡腳暖身、11點前入睡、多喝溫水、少吃冰',火:'午間小憩15分鐘、少喝咖啡、靜心冥想、少熬夜',土:'三餐定時定量、少冰少油膩、飯後散步、細嚼慢嚥'};
    const ep=bazi.ep||{};
    const epArr=Object.entries(ep).sort((a,b)=>a[1]-b[1]);
    const wk=epArr[0]?epArr[0][0]:'土';
    const bp=WO[wk]||'';
    const th=bazi.tiaohou;
    const thHint=th?(th.reason.includes('水多')?'體質偏濕寒，容易疲勞、嗜睡、四肢沉重、濕氣重':th.reason.includes('火旺')?'體質偏燥熱，容易上火、失眠、口乾、心煩':th.reason.includes('寒')?'體質偏寒，容易手腳冰冷、免疫力低、怕冷':th.reason.includes('金重')?'體質偏緊繃，容易肩頸僵硬、呼吸不暢、壓力大':'需留意調候相關臟腑'):'';

    if(isYN){
      if(/手術|開刀/.test(q)){
        if(good) answer='<strong>手術運勢偏好。</strong> 卦象和運勢支持順利恢復。選擇好醫生、遵照醫囑，手術前後好好休養。';
        else answer='<strong>如果醫生說要開就開，不要拖。</strong> 雖然運勢不算最佳，但健康不能等運勢。手術後多休養、飲食清淡、少操心。';
      }else if(/懷孕|生育|生小孩|備孕/.test(q)){
        if(good) answer='<strong>生育運勢不差。</strong> 放鬆心情，壓力反而是最大的阻礙。調理好身體、規律作息，順其自然。';
        else answer='<strong>身體先調養好。</strong> 運勢顯示目前身體能量不足，建議先把體質養好。少熬夜、均衡飲食、適度運動。準備好了，寶寶自然會來。';
      }else if(/好|康復|好轉|恢復/.test(q)){
        if(good) answer='<strong>會好轉的。</strong> 運勢支持身體恢復。配合治療、好好休息、注意飲食，身體會慢慢好起來。';
        else answer='<strong>需要一些時間。</strong> 恢復過程可能比你預期的慢一點，不要急。持續調理、保持好心情，身體有自癒能力。';
      }else{
        if(good) answer='<strong>健康狀況整體還行。</strong> 注意日常保養就好，特別是'+bp+'方面。';
        else answer='<strong>健康要多留心。</strong> 特別注意'+bp+'。建議定期健檢，有不舒服別拖。';
      }
      detail=wk+'行最弱（'+ep[wk]+'%），是你最需要注意的部位：'+bp+'。'+(thHint?' 此外，'+thHint+'。':'');
      tip='飲食多吃'+WF[favEl]+'。 '+WH[favEl]+'。 ⚠ 命理僅供養生參考，身體不適請就醫。';
    }else if(isWhen){
      if(good) answer='<strong>目前身體能量還行。</strong> '+dyInfo+'但別因為運勢好就熬夜亂吃。';
      else answer='<strong>這段期間要特別注意健康。</strong> '+dyInfo+(yearInfo||'運勢低谷期身體也容易出問題，定期健檢。');
      tip=WH[favEl]+'。有利時期也不要放縱。';
    }else if(isHow){
      answer='<strong>你的養生重點：</strong>';
      detail='🍎 飲食：多吃'+WF[favEl]+'。少吃'+(favEl==='火'?'冰冷生食':'油炸辛辣')+' 。';
      detail+=' 🛌 作息：'+WH[favEl];
      detail+=' 🏃 運動：'+(el==='木'||el==='火'?'適合動態運動（跑步、打球、有氧舞蹈）。':'適合靜態運動（瑜珈、太極、游泳、散步）。');
      detail+=' ⚡ 重點保養：'+bp+'（'+wk+'行最弱）。';
      if(thHint) detail+=' 體質特徵：'+thHint+'，要特別對應調理。';
      tip='⚠ 以上為命理養生建議，身體不適請就醫。';
    }else if(isWhy){
      if(/累|疲|沒精神|嗜睡/.test(q)){
        answer='<strong>從命盤看，你的'+wk+'行偏弱。</strong> ';
        if(th&&th.reason.includes('水多')) answer+='命盤「水多木漂」，就像花泡在冰水裡，當然沒精神。你需要的是「暖」和「乾」，少吹冷氣、少喝冰水、多曬太陽。';
        else if(wk==='火') answer+='火行弱代表心臟能量和血液循環偏弱，容易覺得累。多吃紅色食物、曬太陽、午間小憩可以改善。';
        else if(wk==='土') answer+='土行弱代表脾胃消化不好，營養吸收不了當然沒精神。三餐定時、少吃冰、飯後散步是關鍵。';
        else answer+=wk+'行弱容易影響'+bp+'，導致整體能量不足。針對性調理會改善。';
      }else if(/失眠|睡不好|睡眠/.test(q)){
        answer='<strong>失眠跟你的命盤有關。</strong> ';
        if(th&&th.reason.includes('火旺')) answer+='命盤火氣太旺，心神不寧當然睡不好。少喝咖啡、睡前泡腳、臥室用藍色系床品。';
        else answer+=wk+'行偏弱，對應'+bp+'，影響到睡眠品質。晚上11點前上床、少看手機、臥室保持暗和涼。';
      }else if(/生病|不舒服/.test(q)){
        answer='<strong>你的'+wk+'行最弱（'+ep[wk]+'%），對應'+bp+'。</strong> 這是你天生比較容易出問題的地方。'+(thHint?'加上'+thHint+'，身體確實容易不適。':'')+'不過體質是可以後天調理的。';
      }else{
        answer='<strong>從命盤看你的體質弱點：</strong> '+wk+'行最弱，對應'+bp+'。'+(thHint?'體質特徵：'+thHint+'。':'')+'日常保養可以明顯改善。';
      }
      tip='飲食：'+WF[favEl]+'。 '+WH[favEl]+'。 ⚠ 身體不適請就醫。';
    }else{
      if(good) answer='<strong>今年健康運不錯。</strong> 注意日常保養即可。特別留意'+bp+'的保養。';
      else answer='<strong>今年健康要多注意。</strong> 尤其是'+bp+'方面。建議定期健檢，'+(thHint?thHint+'，':'')+'不要忽視身體的小訊號。';
      tip='飲食：'+WF[favEl]+'。 '+WH[favEl]+'。 ⚠ 身體不適請就醫。';
    }
  }

  // ================== 🤝 人際 ==================
  else if(type==='relationship'){
    const gr=bazi.shensha&&bazi.shensha.includes('天乙貴人');
    const js=bazi.shensha&&bazi.shensha.includes('劫煞');
    if(isYN){
      if(/和好|化解|修復|道歉/.test(q)){
        const passive=intent.isPassive||/他會|她會|對方會|會不會.*和好|會.*原諒/.test(q);
        if(passive){
          // 被動：對方會跟我和好嗎/會原諒我嗎
          if(good) answer='<strong>對方有可能釋懷。</strong> 運勢顯示關係有鬆動的跡象，對方不是完全不想理你。不要急著逼對方表態，給他/她一點時間消化。';
          else answer='<strong>對方目前還沒準備好。</strong> 強行要對方回應反而有反效果。先把你能做的做好，對方看在眼裡，時間到了自然會有轉機。';
        }else{
          if(good) answer='<strong>有和好的可能。</strong> 運勢顯示關係有修復的空間。重點是誰先低頭不重要，重要的是你在意這段關係。先釋出善意，對方會感受到的。';
          else answer='<strong>需要一些時間。</strong> 現在雙方可能都還在氣頭上，強行和解反而會讓事情更糟。給彼此空間冷靜，等情緒過了再談。';
        }
      }else if(/貴人|信任|可靠|真心/.test(q)){
        if(good) answer='<strong>你的貴人運還不錯。</strong> '+(gr?'命帶天乙貴人，你天生容易遇到幫助你的人。保持真誠和感恩，貴人會持續出現。':'運勢支持有人相助，但要自己主動經營關係。別等人家來幫你，先去幫別人。');
        else answer='<strong>近期貴人運偏弱。</strong> 凡事多靠自己比較穩。不是說沒有好人，而是這段期間容易看錯人。重要決定先自己判斷，別完全聽別人的。';
      }else if(/小人|背叛|陷害|被害|整/.test(q)){
        if(bad) answer='<strong>確實要提防。</strong> 運勢顯示人際方面有暗箭，說話小心、少管閒事、重要事情留證據。不要輕易把底牌亮給同事看。';
        else if(!good) answer='<strong>風險不高但也不能大意。</strong> 職場上永遠要有防人之心。做好自己的事，少參與八卦，不得罪人就不會被針對。';
        else answer='<strong>目前看起來還好。</strong> 運勢穩定，身邊沒有明顯的小人跡象。但防人之心不可無，重要的事情還是要留底。';
      }else if(/合作|合夥|一起做/.test(q)){
        const passive=intent.isPassive||/他會|她會|對方會|會答應|會同意|願意/.test(q);
        if(passive){
          // 被動：對方會答應合作嗎
          if(great) answer='<strong>對方答應的機會很大。</strong> 運勢顯示合作條件成熟，對方也在尋找合作夥伴。拿出具體方案去談，比空口白話有說服力。';
          else if(good) answer='<strong>有機會，但對方可能要考慮。</strong> 不會馬上答應，需要你展現合作的價值和誠意。準備好數據和計畫再提。';
          else answer='<strong>對方目前可能不太願意。</strong> 不是你不好，可能是時機或條件還不到位。先建立更深的信任，讓對方看到你的能力再談。';
        }else{
          if(great) answer='<strong>合作運勢很好。</strong> 如果找到對的人，現在是一起衝的好時機。但再好的朋友也要把合約寫清楚，醜話說在前面。';
          else if(good) answer='<strong>可以合作，但要有規則。</strong> 運勢偏好，但別因為信任就什麼都用口頭說。權責分明、帳目透明、退出機制先談好。';
          else answer='<strong>合作要非常謹慎。</strong> 目前運勢不太適合深度綁定，如果要合作，先從小規模試起，彼此磨合了再加大。不要一開始就投入太多。';
        }
      }else if(/人緣|人際|提升|改善/.test(q)){
        if(good) answer='<strong>人際方面有正面發展空間。</strong> '+(gr?'你命帶貴人星，人緣天生不差。':'')+'多出席社交場合、主動打招呼、記住別人的名字和喜好。人際就是這些小事。';
        else answer='<strong>人際需要一些時間經營。</strong> 目前運勢對社交不算特別有利，但不代表不能改善。從身邊最親近的人開始，一個一個經營好。';
      }else{
        if(good) answer='<strong>可以。</strong> 人際方面運勢偏好，適合拓展社交。';
        else answer='<strong>需要觀察。</strong> 人際上有些不確定因素，謹慎為上。';
      }
      tip='穿'+FC[favEl]+'色參加社交場合。往'+FD[favEl]+'方向的人是你的貴人方位。';
    }else if(isWhen){
      if(good) answer='<strong>人際正在好轉。</strong> '+dyInfo+(yearInfo||'現在多社交，種下的種子會在好年份開花。');
      else answer='<strong>人際需要時間經營。</strong> '+dyInfo+'不急，先把身邊的關係維繫好。';
      tip='有利時期多參加聚會，不利時期少管閒事。';
    }else if(isHow){
      answer='<strong>給你三個人際建議：</strong>';
      detail='1️⃣ '+(strong?'你太有主見，人際關係裡要練「聽」。聽完再說，先認同再給建議。沒人喜歡一開口就被否定。':'你太好說話，人際關係裡要練「拒絕」。不是所有請求都要答應，設立界線反而會被尊重。');
      detail+=' 2️⃣ 記住三個字：「不八卦」。職場上、朋友圈裡，管好嘴巴就能避開80%的人際問題。';
      detail+=' 3️⃣ '+(gr?'你有貴人運，主動維繫重要關係。每個月約一個重要的人吃飯，持續投資人脈。':'找到你的貴人方位（'+FD[favEl]+'方向），那個方向來的朋友/客戶/同事對你特別有利。');
      tip='穿'+FC[favEl]+'色見重要的人。';
    }else if(isWhy){
      if(/小人|被整/.test(q)) answer='<strong>'+(js?'你命帶劫煞，確實容易遇到損友或被人利用。':'不一定是命的問題。')+'</strong> 反思一下是不是在不對的場合說了不該說的話，或者太輕易相信不該相信的人。職場上保持適度距離是保護自己最好的方式。';
      else if(/不順|吵|衝突/.test(q)) answer=(strong?'<strong>你太直了。</strong> 有話直說是優點，但在人際上有時候太直就是得罪人。學會「換個方式說」，內容不變但語氣和順序改一下。':'<strong>你太忍了。</strong> 一直忍讓不但不會讓關係變好，反而讓人覺得你好欺負。有些委屈要說出來，合理的不爽不丟人。');
      else answer=(strong?'<strong>你個性強，容易跟人硬碰硬。</strong> 人際不是比誰對誰錯，而是比誰讓對方舒服。':'<strong>你太在意別人的看法了。</strong> 活成別人喜歡的樣子很累，而且永遠做不到。先讓自己舒服，再考慮別人。');
      tip='穿'+FC[favEl]+'色增強人際能量。';
    }else{
      if(good) answer='<strong>人際運不錯。</strong> '+(gr?'命帶天乙貴人，有貴人相助。':'')+'適合拓展社交圈、認識新朋友。';
      else answer='<strong>人際運偏弱。</strong> 少管閒事、少八卦、保持低調。這段時間獨處反而比社交更養你。';
      tip='穿'+FC[favEl]+'色。往'+FD[favEl]+'方向的人對你有利。';
    }
  }

  // ================== 🏠 家庭 ==================
  else if(type==='family'){
    if(isYN){
      if(/連絡|聯繫|聯絡|回來|見面|相認/.test(q)){
        const passive=intent.isPassive||/他會|她會|會連絡|會來|會回來|會找我|聯繫我|連絡我/.test(q);
        if(passive){
          // 被動：對方會主動連絡我嗎
          if(good) answer='<strong>有機會的。</strong> 對方心裡還有這份牽掛，只是可能不知道怎麼開口。你不用刻意做什麼，保持開放的態度，消息可能會在你意想不到的時候出現。';
          else answer='<strong>可能需要再等一等。</strong> 對方目前還沒準備好主動聯繫。不要因此難過——有些人需要更長的時間。你可以先發一個不需要回覆的簡單訊息，讓對方知道門一直開著。';
        }else{
          if(good) answer='<strong>有機會重新連繫。</strong> 血緣是最深的牽繫，就算疏遠了也不會斷。現在主動聯繫，對方接受的可能性比你想的高。一通電話、一則訊息，不需要長篇大論，「我想你了」就夠了。';
          else answer='<strong>緣分還在，只是時機要等。</strong> 現在對方可能還沒準備好，強求反而有反效果。你可以先寫一封不需要回覆的信或訊息，讓對方知道你的心意，然後給他/她時間。';
        }
      }else if(/支持|同意|接受|答應/.test(q)){
        const passive=intent.isPassive||/家人會|父母會|爸媽會|會支持|會同意|會接受|會答應/.test(q);
        if(passive){
          // 被動：家人會支持嗎/父母會同意嗎
          if(good) answer='<strong>家人最終會理解的。</strong> 現在可能還在觀望或擔心，但他們的反對不是不愛你。給他們一點時間消化，同時用行動證明你的決定是對的。';
          else answer='<strong>短期內家人可能不會鬆口。</strong> 他們的擔心有他們的道理。不要急著要答案，先做好準備工作，等你有了具體成果或計畫，再拿去跟家人談會更有說服力。';
        }else{
          if(good) answer='<strong>家人最終會支持你的。</strong> 但溝通方式很重要——不要用爭吵的方式，用「讓他們看到結果」的方式。先做出一點成績，家人自然會從反對變成支持。';
          else answer='<strong>短期可能不太容易。</strong> 家人的反對往往出於擔心而不是不愛你。耐心溝通，聽聽他們擔心什麼，一一回應，比直接衝撞有效。';
        }
      }else if(/搬家|買房|置產|裝潢/.test(q)){
        if(good) answer='<strong>運勢支持居家變動。</strong> 搬家或裝潢的話今年是好時機。建議往'+FD[favEl]+'方向找房子或安排主臥。';
        else answer='<strong>建議緩一緩。</strong> 居家大事不急著做決定，尤其是大額支出要量力而為。再等等，會有更好的機會。';
      }else if(/改善|和好|緩和|修復/.test(q)){
        if(good) answer='<strong>關係會改善的。</strong> 運勢顯示家庭的僵局正在鬆動。不需要做什麼大事，從每天多說一句關心的話、多幫忙做一件家事開始。小事累積比大動作有效。';
        else answer='<strong>需要耐心。</strong> 家庭關係不是一天壞掉的，也不會一天修好。先從「不吵」做起，不反駁、不翻舊帳，讓家裡的氣氛慢慢緩和。';
      }else if(/婆媳|公婆|妯娌/.test(q)){
        if(good) answer='<strong>關係有改善空間。</strong> 婆媳問題的核心往往不是你和婆婆，而是你老公/老婆的態度。拉另一半站在你這邊，問題就解決一半了。';
        else answer='<strong>這個問題需要時間。</strong> 不要期待婆媳變閨密，能做到相安無事就是最好的結果。保持禮貌距離、不計較小事、有問題讓另一半出面。';
      }else if(/孩子|小孩|兒子|女兒|親子/.test(q)){
        if(good) answer='<strong>親子關係會好轉。</strong> 孩子需要的不是你的管教而是你的理解。試著少說教、多傾聽。問「你覺得呢」比說「你應該」有效一百倍。';
        else answer='<strong>親子溝通需要調整方式。</strong> 你越管，孩子越反抗。試著放手讓他們做決定，在旁邊當顧問而不是指揮官。';
      }else{
        if(good) answer='<strong>可以。</strong> 家庭運勢偏好，適合處理家庭大事。';
        else answer='<strong>需要更多耐心。</strong> 家庭方面有些阻力，多溝通少爭執。';
      }
      tip='家中'+FD[favEl]+'方位擺放綠植或水晶增強和諧。穿'+FC[favEl]+'色回家。';
    }else if(isWhen){
      if(good) answer='<strong>家庭關係正在好轉。</strong> '+dyInfo+(yearInfo||'現在是修復關係的好時機，主動一點。');
      else answer='<strong>需要給彼此時間。</strong> '+dyInfo+'家庭的事急不來，慢慢經營。';
      tip='有利時期多回家陪伴、多溝通。';
    }else if(isHow){
      answer='<strong>給你三個家庭建議：</strong>';
      detail='1️⃣ '+(strong?'你想掌控一切，但家人不是員工。練習「放手」，讓家人自己做決定，就算做錯了也是他們的學習。':'你總是把委屈往肚裡吞，但累積的不滿遲早會爆。練習「說出來」，合理的不爽不丟人。');
      if(/婆媳|公婆/.test(q)) detail+=' 2️⃣ 婆媳關係的關鍵人是你的另一半。拉他/她進來一起面對，不要自己硬扛。 3️⃣ 保持禮貌距離比假裝親密好。每週固定時間探望，其他時間各過各的。';
      else if(/親子|小孩|孩子/.test(q)) detail+=' 2️⃣ 每天花15分鐘純粹聊天（不是問功課），讓孩子感受到你關心他這個人，不只關心他的成績。 3️⃣ 在家裡建立「可以犯錯」的安全感，孩子才會跟你說真話。';
      else detail+=' 2️⃣ 家庭關係修復靠「行動」不是「說教」。與其說一百句「我都是為你好」，不如做一頓飯、接一次車。 3️⃣ 定期的家庭活動（一起吃飯、出遊）比什麼都有效。';
      tip='家中'+FD[favEl]+'方位是和諧能量位，適合放全家福或綠植。';
    }else if(isWhy){
      if(/不和|吵|鬧/.test(q)) answer=(strong?'<strong>你在家裡可能太強勢了。</strong> 你覺得是為家人好，但他們感受到的是控制和壓力。家不是講道理的地方，是講感情的地方。':'<strong>你在家裡壓抑太久了。</strong> 一直忍讓不代表和諧，只是把問題藏起來。找個適合的時機好好談一次，把心裡的話說清楚。')+(bad?' 加上運勢偏弱，家庭摩擦確實比平時多。但這是階段性的。':'');
      else if(/疏遠|不連絡|斷/.test(q)) answer='<strong>家人之間的疏遠通常不是因為不愛，而是不知道怎麼表達。</strong> 每個人都在等對方先開口，結果誰都不開口。你先踏出第一步，哪怕只是一條簡單的訊息。'+(bad?' 運勢顯示目前不是最佳時機，但不代表不能做。心到了，時機自然會對。':'');
      else answer=(strong?'<strong>你可能把太多精力放在外面了。</strong> 事業再忙，家人也需要你的時間和注意力。':'<strong>你可能太操心家裡的事了。</strong> 過度的關心有時候是一種壓力。適度放手，讓家人自己成長。');
      tip='穿'+FC[favEl]+'色回家。家中'+FD[favEl]+'方位放水晶增強和諧。';
    }else if(isChoice){
      answer=good?'<strong>選對家庭影響最小的。</strong> 運勢好的時候做改變，家人接受度比較高。':'<strong>先不做大決定。</strong> 現在不是處理家庭大事的最佳時機，維持現狀比改變更安全。';
      tip='重大家庭決定在'+FD[favEl]+'方位的房間討論。';
    }else{
      if(good) answer='<strong>家庭運不錯。</strong> 家人關係有改善或深化的空間，適合處理家庭大事（搬家、裝修、重要溝通）。';
      else answer='<strong>家庭運偏弱。</strong> 可能有些摩擦或溝通問題，多一點耐心、少一點指責。這段時間以「不吵」為目標就好。';
      tip='穿'+FC[favEl]+'色回家。家中'+FD[favEl]+'方位擺放綠植。';
    }
  }

  // ================== fallback ==================
  else{
    if(good) answer='<strong>偏向正面。</strong> 運勢支持所問之事。';
    else if(!bad) answer='<strong>有機會但需努力。</strong> 條件尚可，要主動推進。';
    else answer='<strong>目前較為困難。</strong> 建議先調整狀態再行動。';
    tip='穿'+FC[favEl]+'色增強運勢。';
  }

  /* ═══ 組合輸出 ═══ */
  let html='<p style="font-size:1.05rem;line-height:1.8">'+answer+'</p>';
  if(detail) html+='<p style="line-height:1.7">'+detail+'</p>';
  if(tip) html+='<p>💡 '+tip+'</p>';
  html+='<details style="margin-top:0.8rem"><summary style="cursor:pointer;color:var(--c-gold,#d4af37);font-size:0.82rem">📊 命理判斷依據（'+evidence.length+'項）</summary>';
  html+='<div style="padding:0.5rem;margin-top:0.3rem;background:rgba(255,255,255,0.03);border-radius:6px;font-size:0.8rem;line-height:1.5;color:var(--c-dim,#999)">';
  evidence.forEach(d=>{html+='<p style="margin:0.15rem 0">• '+d+'</p>';});
  if(tarot&&tarot.drawn&&tarot.drawn.length>=10){const c=tarot.drawn[0],r=tarot.drawn[9];html+='<p style="margin:0.15rem 0">• 核心牌「'+c.n+'」'+(c.isUp?'正':'逆')+'位。結果牌「'+r.n+'」'+(r.isUp?'正':'逆')+'位。</p>';}
  html+='</div></details>';
  return html;
}

function generateAnswer(type,prob,bazi,mh,tarot){
  const dm=bazi.dm,el=bazi.dmEl,strong=bazi.strong;
  const curDy=bazi.dayun.find(d=>d.isCurrent);
  const fav=bazi.fav||[];
  const unfav=bazi.unfav||[];

  /* ═══ FACTORS: 逐維度列出具體發現 ═══ */
  const factors=[];

  // ── 八字因子 ──
  let baziFactor=`日主${dm}（${el}行），身${strong?'強':'弱'}`;
  if(fav.length) baziFactor+=`，喜用${fav.join('、')}`;
  if(unfav.length) baziFactor+=`，忌${unfav.join('、')}`;
  factors.push('【八字】'+baziFactor);

  if(curDy){
    let dyDetail=`當前大運 ${curDy.gz}（${curDy.level}）`;
    if(curDy.level.includes('吉')) dyDetail+='→ 運勢有外在助力';
    else if(curDy.level.includes('凶')) dyDetail+='→ 運勢阻力偏大，宜守不宜攻';
    else dyDetail+='→ 運勢平穩，不特別助力也不阻礙';
    factors.push('【大運】'+dyDetail);
  }

  if(bazi.shensha&&bazi.shensha.length){
    const good=['天乙貴人','文昌','桃花','天德','月德','驛馬','將星'];
    const bad=['羊刃','亡神','劫煞','華蓋'];
    const g=bazi.shensha.filter(s=>good.includes(s));
    const b2=bazi.shensha.filter(s=>bad.includes(s));
    let shText='神煞中';
    if(g.length) shText+=`有${g.join('、')}助力`;
    if(b2.length) shText+=(g.length?'，但':'')+ `${b2.join('、')}需注意`;
    if(!g.length&&!b2.length) shText='神煞：'+bazi.shensha.join('、');
    factors.push('【神煞】'+shText);
  }

  // ── 梅花因子 ──
  if(mh){
    let mhText=`本卦 ${mh.ben.n}，變卦 ${mh.bian.n}，體用${mh.ty.r}（${mh.ty.f}）`;
    if(mh.ty.d) mhText+=' — '+mh.ty.d;
    factors.push('【梅花】'+mhText);
  }

  // ── 塔羅因子（逐位置解讀重點牌） ──
  if(tarot.drawn.length>=10){
    const posNames=['核心現狀','阻礙因素','過去基礎','未來發展','可能結果','近期未來','自我態度','環境影響','希望恐懼','最終結果'];
    const keyPos=[0,1,3,4,9]; // 核心、阻礙、未來、可能結果、最終
    keyPos.forEach(i=>{
      const c=tarot.drawn[i];
      if(!c)return;
      const dir=c.isUp?'正位':'逆位';
      const meaning=c.isUp?c.up:c.rv;
      factors.push(`【塔羅·${posNames[i]}】${c.n}（${dir}）→ ${meaning}`);
    });
  }

  // ── 紫微因子 ──
  if(S.ziwei){
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
    const gongIdx=typeToGong[type]!==undefined?typeToGong[type]:0;
    const gongName=typeof ZW_PALACES!=='undefined'?ZW_PALACES[gongIdx]:'命宮';
    const gongStars=S.ziwei.palaces[gongIdx]?S.ziwei.palaces[gongIdx].stars:[];
    if(gongStars.length){
      const starInfo=gongStars.map(s=>{
        let t=s.name;
        if(s.bright) t+=`(${s.bright})`;
        if(s.hua) t+=` ${s.hua}`;
        return t;
      }).join('、');
      factors.push(`【紫微·${gongName}】${starInfo}`);
    }
  }

  // ── 姓名因子 ──
  if(S.nameResult){
    const nr=S.nameResult;
    let nText=`三才配置 ${nr.sanCaiLevel}`;
    if(nr.renGe) nText+=`，人格 ${nr.renGe.strokes}畫（${nr.renGe.fortune.level}）`;
    factors.push('【姓名】'+nText);
  }

  /* ═══ SUGGESTIONS: 依維度×類型 生成具體建議 ═══ */
  const suggestions=[];

  // 八字建議
  if(strong){
    suggestions.push(`八字身強，宜「洩秀生財」：多發揮${typeof SHENG!=='undefined'?SHENG[el]:''}行能量，透過輸出（創作、教學、投資）引導力量`);
  }else{
    suggestions.push(`八字身弱，宜「扶助印比」：加強${el}行與${typeof BE_SHENG!=='undefined'?BE_SHENG[el]:''}行能量，選擇穩定環境發展`);
  }

  // 塔羅建議（根據最終結果牌）
  if(tarot.drawn.length>=10){
    const finalCard=tarot.drawn[9];
    const obstCard=tarot.drawn[1];
    if(finalCard){
      const fMeaning=finalCard.isUp?finalCard.up:finalCard.rv;
      suggestions.push(`塔羅最終牌「${finalCard.n}」${finalCard.isUp?'正位':'逆位'}，提示方向：${fMeaning}`);
    }
    if(obstCard){
      const oMeaning=obstCard.isUp?obstCard.up:obstCard.rv;
      suggestions.push(`需注意阻礙因素「${obstCard.n}」${obstCard.isUp?'正位':'逆位'}：${oMeaning}`);
    }
  }

  // 類型專屬建議
  const typeAdvice={
    love:{
      strong:'感情上你容易主對，但對方需要被尊重的空間，適度放軟身段',
      weak:'感情上你較被動，試著主動表達需求，貴人會在社交場合出現',
      peach:'命帶桃花，異性緣佳但需慍選對象，不宜同時曖昧多人',
      noPeach:'可往正東或正南方向社交，或佩戴粉晶增強桃花磁場'
    },
    career:{
      strong:'事業上你有領導力，適合獨立負責或創業，食傷生財路線佳',
      weak:'事業上宜依附大平台或跟隨有能力的主管，印星助力是關鍵',
      wenChang:'文昌入命，利考試進修、文書工作、學術研究方向',
      yiMa:'驛馬星動，利外出、出差、跨區域發展'
    },
    wealth:{
      caiWang:'命中財星旺，偏財運佳，可適度參與投資但設好停損',
      caiRuo:'命中財星偏弱，宜穩健理財、定期儲蓄，不宜高風險操作',
      strong:'身強能扛財，可積極追求財富，但需避免貪多',
      weak:'身弱難扛財，財來財卻，宜保守理財、量力而為'
    },
    health:{
      strong:'身強體質底子好，但要防「過旺」引起的發炎、上火、血壓問題',
      weak:'身弱體質偏虛，需注意免疫力、腸胃功能、睡眠品質',
      advice:'喜用神為'+fav[0]+'行，養生重點：'+{金:'養肺護膚（深呼吸、保濕）',木:'疏肝解鬱（伸展、少熬夜）',水:'養腎補水（早睡、黑色食物）',火:'養心安神（午休、紅色食物）',土:'健脾去濕（飲食規律、黃色食物）'}[fav[0]||'土']
    }
  };

  if(type==='love'){
    suggestions.push(typeAdvice.love[strong?'strong':'weak']);
    suggestions.push(bazi.shensha&&bazi.shensha.includes('桃花')?typeAdvice.love.peach:typeAdvice.love.noPeach);
  } else if(type==='career'){
    suggestions.push(typeAdvice.career[strong?'strong':'weak']);
    if(bazi.shensha&&bazi.shensha.includes('文昌'))suggestions.push(typeAdvice.career.wenChang);
    if(bazi.shensha&&bazi.shensha.includes('驛馬'))suggestions.push(typeAdvice.career.yiMa);
  } else if(type==='wealth'){
    const caiEl=typeof KE!=='undefined'?KE[el]:'';
    suggestions.push(typeAdvice.wealth[strong?'strong':'weak']);
    suggestions.push(bazi.ep&&caiEl&&bazi.ep[caiEl]>15?typeAdvice.wealth.caiWang:typeAdvice.wealth.caiRuo);
  } else if(type==='health'){
    suggestions.push(typeAdvice.health[strong?'strong':'weak']);
    suggestions.push(typeAdvice.health.advice);
  }

  /* ═══ TEXT: 主要回答段落 ═══ */
  let text='';

  // ── 問答對齊：先針對問句類型給出直接回應 ──
  const intent = parseQuestionIntent(S.form ? S.form.question : '', type);
  const qaResponse = generateQAResponse(intent, type, prob, bazi, mh, tarot);
  if(qaResponse) {
    text += `<div style="border-left:3px solid var(--c-gold,#d4af37);padding-left:1rem;margin-bottom:1rem">${qaResponse}</div>`;
  }

  // ── 命理依據（收合式，不干擾閱讀）──
  let techText='';
  techText+=`<p><strong>日主「${dm}」五行屬${el}，身${strong?'強':'弱'}</strong>，`;
  if(curDy){
    techText+=`目前走 ${curDy.gz} 大運（${curDy.level}），`;
    if(curDy.level.includes('大吉')) techText+='運勢正處於最佳時期。';
    else if(curDy.level.includes('中吉')) techText+='運勢偏好，有貴人助力。';
    else if(curDy.level.includes('小吉')) techText+='穩中有進。';
    else if(curDy.level.includes('凶')) techText+='大運帶阻力，需加謹慎。';
    else techText+='運勢平穩。';
  }
  techText+=`</p>`;

  if(mh){
    techText+=`<p class="mt-sm"><strong>梅花易數</strong>得本卦「${mh.ben.n}」，變卦「${mh.bian.n}」，`;
    techText+=`體用關係為 <span class="tag tag-gold">${mh.ty.r}</span>（${mh.ty.f}）。`;
    if(mh.ty.d) techText+=mh.ty.d;
    techText+=`</p>`;
  }

  if(tarot.drawn.length>=10){
    const core=tarot.drawn[0],obst=tarot.drawn[1],future=tarot.drawn[3],outcome=tarot.drawn[4],final=tarot.drawn[9];
    techText+=`<p class="mt-sm"><strong>塔羅十張牌：</strong>`;
    techText+=`核心「${core.n}」${core.isUp?'正位':'逆位'}（${core.isUp?core.up:core.rv}）`;
    techText+=`；阻礙「${obst.n}」${obst.isUp?'正位':'逆位'}（${obst.isUp?obst.up:obst.rv}）`;
    techText+=`；結局「${final.n}」${final.isUp?'正位':'逆位'}（${final.isUp?final.up:final.rv}）`;
    techText+=`</p>`;
    const upCount=tarot.drawn.filter(c=>c.isUp).length;
    techText+=`<p class="mt-sm text-sm text-dim">${upCount}張正位/${10-upCount}張逆位，${upCount>=7?'牌面偏正面':upCount>=5?'正逆參半':'阻力較大'}。</p>`;
  }

  if(S.ziwei){
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
    const gongIdx=typeToGong[type]!==undefined?typeToGong[type]:0;
    const gongName=typeof ZW_PALACES!=='undefined'?ZW_PALACES[gongIdx]:'命宮';
    const gongStars=S.ziwei.palaces[gongIdx]?S.ziwei.palaces[gongIdx].stars:[];
    if(gongStars.length){
      techText+=`<p class="mt-sm"><strong>紫微斗數·${gongName}</strong>：`;
      techText+=gongStars.map(s=>{let t=s.name;if(s.bright)t+=`（${s.bright}）`;if(s.hua)t+=` ${s.hua}`;return t;}).join('、');
      const hasLu=gongStars.some(s=>s.hua==='化祿'),hasJi=gongStars.some(s=>s.hua==='化忌');
      if(hasLu) techText+='。化祿入此宮，此方面有福氣。';
      else if(hasJi) techText+='。化忌入此宮，需格外留心。';
      else techText+='。';
      techText+=`</p>`;
    }
  }

  // 把命理依據包在可收合區塊
  text+=`<div class="detail-toggle-wrap" style="margin-top:1rem">
    <div class="detail-toggle-btn" onclick="this.parentElement.classList.toggle('open')" style="cursor:pointer;display:flex;align-items:center;gap:.5rem;color:var(--c-text-dim);font-size:.85rem;padding:.5rem 0">
      <i class="fas fa-chevron-right" style="font-size:.7rem;transition:transform .3s"></i>
      <span>查看完整命理依據（五維度分析）</span>
    </div>
    <div class="detail-toggle-body" style="max-height:0;overflow:hidden;transition:max-height .4s ease">
      <div style="padding:.5rem 0">${techText}</div>
    </div>
  </div>`;

  // 綜合結論
  text+=`<div class="divider"></div>`;
  if(prob>=70){
    text+=`<p class="serif"><strong class="text-success">綜合判斷：偏向可行</strong>。五個維度多數指向正面，`;
    text+=`八字${curDy&&curDy.level.includes('吉')?'大運助力':'底盤穩定'}，`;
    if(mh) text+=`梅花${mh.ty.f.includes('吉')?'體用相生':'卦象不差'}，`;
    if(tarot.drawn.length>=10){
      const upC=tarot.drawn.filter(c=>c.isUp).length;
      text+=`塔羅${upC}張正位${upC>=6?'偏積極':''}，`;
    }
    text+=`建議把握時機、積極行動。</p>`;
  } else if(prob>=45){
    text+=`<p class="serif"><strong class="text-warn">綜合判斷：利弊並存</strong>。各維度訊號不完全一致，`;
    text+=`有發展空間但存在具體障礙（見上方因子），建議分隍段捨進、設好退路。</p>`;
  } else if(prob>=25){
    text+=`<p class="serif"><strong class="text-danger">綜合判斷：阻力偏大</strong>。多數維度出現警訊，`;
    text+=`目前時機偏不利，建議先做準備、降位投入，等待更好的時機窗口。</p>`;
  } else {
    text+=`<p class="serif"><strong class="text-danger">綜合判斷：強烈建議暫緩</strong>。五個維度幾乍一致指向逆風，`;
    text+=`硬捨風險極高，請務必設停損並考慮替代方案。</p>`;
  }

  return{text,factors,suggestions};
}

function renderCrystal(b){
  const CRYSTALS={
    金:[{n:'白水晶',icon:'💍',d:'淨化能量，增強思維清晰度'},{n:'黃鐵礦',icon:'✨',d:'增強財運，提升自信'}],
    木:[{n:'綠幽靈',icon:'💚',d:'招正財，事業穩步上升'},{n:'東陵玉',icon:'🌿',d:'舒緩壓力，帶來好運'}],
    水:[{n:'海藍寶',icon:'💙',d:'增強溝通力，平靜情緒'},{n:'藍紋瑪瑙',icon:'🔵',d:'穩定情緒，增強表達'}],
    火:[{n:'紅瑪瑙',icon:'❤️',d:'激發熱情，增強行動力'},{n:'石榴石',icon:'🔴',d:'提升活力，增強意志'}],
    土:[{n:'黃水晶',icon:'💛',d:'招偏財，提升自信'},{n:'虎眼石',icon:'🐅',d:'增強決斷力，招財辟邪'}]
  };
  const need=b.fav[0];
  const recs=CRYSTALS[need]||CRYSTALS['土'];
  document.getElementById('r-crystal').innerHTML=`
    <p class="mb-md">根據命盤分析，建議補強 <span class="tag tag-gold">${need}行</span> 能量：</p>
    <div class="crystal-grid">${recs.map(c=>`
      <div class="crystal-card">
        <div class="crystal-icon">${c.icon}</div>
        <div class="crystal-name">${c.n}</div>
        <p class="text-sm text-dim">${c.d}</p>
      </div>`).join('')}</div>
    <p class="text-xs text-muted mt-md"><i class="fas fa-info-circle"></i> 本建議僅供能量校準參考，不具醫療或命運保證效力。</p>`;
}

function generateConclusion(type,prob,bazi,mh,tarot){
  const el=bazi.dmEl,strong=bazi.strong,dm=bazi.dm;
  const curDy=bazi.dayun.find(d=>d.isCurrent);
  const fav=bazi.fav||[];
  const typeLabel={'love':'愛情','career':'事業','wealth':'財運','health':'健康','general':'綜合運勢','relationship':'人際','family':'家庭','other':'所問之事'}[type]||'所問之事';

  let html='';

  // 八字總結
  html+=`<p><strong class="text-gold">一、八字命理</strong>：「${dm}${bazi.pillars?bazi.pillars.day.zhi:''}」日主，${el}行，身${strong?'強':'弱'}。`;
  if(fav.length) html+=`喜用${fav.join('、')}行。`;
  if(curDy){
    html+=`目前走 ${curDy.gz} 大運（${curDy.level}），`;
    if(curDy.level.includes('大吉')) html+=`這步大運是你最好的運勢週期，問${typeLabel}正是好時機。`;
    else if(curDy.level.includes('吉')) html+=`運勢偏好，${typeLabel}方面有外在助力。`;
    else if(curDy.level.includes('凶')) html+=`運勢帶阻力，${typeLabel}方面需要比平常更謹慎。`;
    else html+=`運勢平穩，${typeLabel}方面不會有大起大落。`;
  }
  html+=`</p>`;

  // 紫微總結
  if(S.ziwei){
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
    const gongIdx=typeToGong[type]!==undefined?typeToGong[type]:0;
    const gongName=typeof ZW_PALACES!=='undefined'?ZW_PALACES[gongIdx]:'命宮';
    const gongStars=S.ziwei.palaces[gongIdx]?S.ziwei.palaces[gongIdx].stars:[];
    if(gongStars.length){
      html+=`<p class="mt-sm"><strong class="text-gold">二、紫微斗數</strong>：${gongName}有 `;
      html+=gongStars.slice(0,4).map(s=>s.name+(s.bright?`(${s.bright})`:'')+(s.hua?` ${s.hua}`:'')).join('、');
      const hasLu=gongStars.some(s=>s.hua==='化祿');
      const hasJi=gongStars.some(s=>s.hua==='化忌');
      if(hasLu) html+=`。化祿入${gongName}，${typeLabel}有先天福氣。`;
      else if(hasJi) html+=`。化忌入${gongName}，${typeLabel}方面需多花心力。`;
      else html+=`。`;
      html+=`</p>`;
    }
  }

  // 梅花總結
  if(mh){
    html+=`<p class="mt-sm"><strong class="text-gold">三、梅花易數</strong>：本卦「${mh.ben.n}」→ 變卦「${mh.bian.n}」。`;
    html+=`體用 ${mh.ty.r}，判為「${mh.ty.f}」。`;
    if(mh.ben.m) html+=mh.ben.m;
    html+=`</p>`;
  }

  // 塔羅詳細總結
  if(tarot.drawn.length>=10){
    const posNames=['核心現狀','阻礙因素','過去基礎','未來發展','可能結果','近期未來','自我態度','環境影響','希望恐懼','最終結果'];
    html+=`<p class="mt-sm"><strong class="text-gold">四、塔羅牌陣（凱爾特十字）</strong>：</p>`;
    html+=`<div style="font-size:0.9rem;line-height:1.7;margin:0.5rem 0">`;
    tarot.drawn.forEach((c,i)=>{
      const dir=c.isUp?'正位':'逆位';
      const meaning=c.isUp?c.up:c.rv;
      const isKey=[0,1,3,4,9].includes(i);
      html+=`<p style="margin:0.25rem 0;${isKey?'font-weight:600':'opacity:0.85'}">`;
      html+=`<span class="tag ${c.isUp?'tag-blue':'tag-red'}" style="font-size:0.75rem">${dir}</span> `;
      html+=`<strong>${i+1}.${posNames[i]}</strong>：${c.n} — ${meaning}`;
      html+=`</p>`;
    });
    html+=`</div>`;
    const upCount=tarot.drawn.filter(c=>c.isUp).length;
    html+=`<p class="text-sm text-dim">正位 ${upCount} 張 / 逆位 ${10-upCount} 張，`;
    if(upCount>=7) html+=`牌面整體正向，${typeLabel}前景看好。`;
    else if(upCount>=5) html+=`正逆參半，有機會但需克服障礙。`;
    else html+=`逆位偏多，目前不是最佳時機。`;
    html+=`</p>`;
  }

  // 姓名學
  if(S.nameResult){
    const nr=S.nameResult;
    html+=`<p class="mt-sm"><strong class="text-gold">五、姓名學</strong>：三才 ${nr.sanCaiLevel}`;
    if(nr.renGe) html+=`，人格 ${nr.renGe.strokes}畫（${nr.renGe.fortune.level}）`;
    if(nr.zongGe) html+=`，總格 ${nr.zongGe.strokes}畫（${nr.zongGe.fortune.level}）`;
    html+=`。</p>`;
  }

  // 最終金句
  html+=`<div class="divider"></div>`;
  const goldAdvice = prob>=70
    ? `五維度多數偏正面，${typeLabel}方面時機不錯。建議積極但有節制地行動，搭配${fav[0]||'土'}行能量輔助。`
    : prob>=45
    ? `各維度訊號不一致，${typeLabel}有空間但也有障礙。建議分步驟捨進，先做小範圍測試。`
    : prob>=25
    ? `多數維度出現警訊，${typeLabel}目前阻力偏大。建議先做充分準備，等待更好時機再全力投入。`
    : `五維度幾乍一致指向困難期。${typeLabel}方面強烈建議暫緩，先穩住現有基礎。`;
  html+=`<p class="serif text-gold" style="font-size:1.05rem"><i class="fas fa-star"></i> ${goldAdvice}</p>`;

  return html;
}
/* =============================================================
   紫微斗數 ZIWEI DOUSHU — 核心邏輯（自寫，不依賴 iztro）
   ============================================================= */
const ZW_PALACES=['命宮','兄弟','夫妻','子女','財帛','疾厄','遷移','交友','官祿','田宅','福德','父母'];

// 14 主星
const ZW_MAJOR=[
  {id:0,name:'紫微',el:'土',yin:true,bright:['廟','旺','得地','利','平','不得','落陷'],nature:'帝星，尊貴，領導力'},
  {id:1,name:'天機',el:'木',yin:true,nature:'智慧，策劃，善變'},
  {id:2,name:'太陽',el:'火',yin:false,nature:'光明正大，貴人，男性'},
  {id:3,name:'武曲',el:'金',yin:false,nature:'財星，剛毅，果斷'},
  {id:4,name:'天同',el:'水',yin:true,nature:'福星，安逸，溫和'},
  {id:5,name:'廉貞',el:'火',yin:false,nature:'囚星，桃花，複雜'},
  {id:6,name:'天府',el:'土',yin:true,nature:'財庫，穩重，保守'},
  {id:7,name:'太陰',el:'水',yin:true,nature:'財星，女性，細膩'},
  {id:8,name:'貪狼',el:'木',yin:false,nature:'桃花，才藝，慾望'},
  {id:9,name:'巨門',el:'水',yin:true,nature:'口舌，暗星，是非'},
  {id:10,name:'天相',el:'水',yin:true,nature:'印星，輔佐，衣食'},
  {id:11,name:'天梁',el:'土',yin:true,nature:'蔭星，清高，化解'},
  {id:12,name:'七殺',el:'金',yin:false,nature:'將星，衝勁，變動'},
  {id:13,name:'破軍',el:'水',yin:false,nature:'耗星，開創，破壞'}
];

// 6 吉星
const ZW_LUCKY=['文昌','文曲','左輔','右弼','天魁','天鉞'];
// 4 煞星
const ZW_SHA=['擎羊','陀羅','火星','鈴星'];

// ═══ 14主星廟旺利平陷表（業界標準）═══
// 地支順序: 子丑寅卯辰巳午未申酉戌亥 (0-11)
// 值: 4=廟, 3=旺, 2=得地/利, 1=平, 0=不得/落陷
const STAR_BRIGHT={
  紫微:[1,3,2,1,3,2,4,3,2,1,3,2],    // 午廟,丑未旺
  天機:[2,0,3,4,1,2,0,3,4,1,2,3],    // 卯廟,寅申旺
  太陽:[0,1,2,3,3,4,4,3,2,1,0,0],    // 巳午廟,卯辰旺（日出日落）
  武曲:[2,4,1,0,3,1,2,4,1,0,3,1],    // 丑未廟,辰戌旺
  天同:[3,1,0,2,1,0,3,2,1,4,1,2],    // 子廟,酉旺
  廉貞:[1,0,3,1,2,4,2,0,3,1,2,3],    // 巳廟,寅申旺
  天府:[2,1,3,1,2,4,3,1,2,3,1,2],    // 巳午廟,寅戌旺
  太陰:[4,3,2,1,0,0,0,1,2,3,3,4],    // 子亥廟,丑酉旺（夜晚明亮）
  貪狼:[2,1,4,1,2,1,3,1,4,1,2,1],    // 寅申廟,午旺
  巨門:[2,1,3,4,1,2,0,1,3,4,1,2],    // 卯酉廟,寅申旺
  天相:[2,1,3,1,2,4,2,1,3,1,2,3],    // 巳廟,寅申旺
  天梁:[1,2,3,4,3,2,1,2,3,1,2,1],    // 卯廟,辰旺
  七殺:[2,1,3,1,2,4,3,1,3,1,2,1],    // 巳午廟,寅申旺
  破軍:[2,3,1,0,3,1,2,3,1,0,3,1]     // 丑未廟,辰戌旺
};
const BRIGHT_LABEL={4:'廟',3:'旺',2:'得地',1:'平',0:'落陷'};
const BRIGHT_SCORE={4:3, 3:2, 2:1, 1:0, 0:-2}; // 廟=+3, 旺=+2, 得地=+1, 平=0, 落陷=-2

// 取得星曜在某宮位的亮度
function getStarBright(starName, branchIdx){
  if(!STAR_BRIGHT[starName]) return {label:'平', score:0};
  const val=STAR_BRIGHT[starName][branchIdx]||1;
  return {label:BRIGHT_LABEL[val]||'平', score:BRIGHT_SCORE[val]||0, val};
}

// ═══ 宮位吉凶綜合分析函數 ═══
// 分析一個宮位裡所有星曜的組合效果
function analyzePalace(palace, branchIdx){
  if(!palace||!palace.stars) return {score:0,notes:[],bright:[]};
  let score=0, notes=[], bright=[];
  const stars=palace.stars;
  const majors=stars.filter(s=>s.type==='major');
  const luckys=stars.filter(s=>['lucky','minor'].includes(s.type));
  const shas=stars.filter(s=>s.type==='sha');

  // 1. 主星亮度評分
  majors.forEach(s=>{
    const b=getStarBright(s.name, branchIdx);
    bright.push({star:s.name, ...b});
    score+=b.score;
    if(b.val>=3) notes.push(s.name+b.label+'（力量強）');
    if(b.val===0) notes.push(s.name+'落陷（力量弱，反凶）');
  });

  // 2. 吉星組合加分
  const luckyNames=luckys.map(s=>s.name);
  if(luckyNames.includes('左輔')||luckyNames.includes('右弼')){score+=1.5;notes.push('輔弼夾持，有人助力');}
  if(luckyNames.includes('天魁')||luckyNames.includes('天鉞')){score+=1.5;notes.push('魁鉞貴人，逢凶化吉');}
  if(luckyNames.includes('文昌')||luckyNames.includes('文曲')){score+=1;notes.push('昌曲文運，利考試名聲');}
  if(luckyNames.includes('祿存')){score+=2;notes.push('祿存同宮，財祿豐厚');}
  if(luckyNames.includes('天馬')&&luckyNames.includes('祿存')){score+=1;notes.push('祿馬交馳，財源滾滾');}

  // 3. 煞星組合扣分
  const shaNames=shas.map(s=>s.name);
  shas.forEach(s=>{
    score-=1.5;
    if(s.name==='擎羊') notes.push('擎羊同宮，易有衝突刑傷');
    if(s.name==='陀羅') notes.push('陀羅同宮，拖延纏繞');
    if(s.name==='火星') notes.push('火星同宮，突發變動');
    if(s.name==='鈴星') notes.push('鈴星同宮，暗中不利');
  });

  // 4. 特殊組合
  // 火貪/鈴貪格（突然發財）
  if(majors.some(s=>s.name==='貪狼')&&(shaNames.includes('火星')||shaNames.includes('鈴星'))){
    const b=bright.find(x=>x.star==='貪狼');
    if(b&&b.val>=2){score+=3;notes.push('火貪/鈴貪格，突發暴利之兆');}
  }
  // 殺破狼（變動格局）
  const sbw=majors.filter(s=>['七殺','破軍','貪狼'].includes(s.name));
  if(sbw.length>=2){notes.push('殺破狼匯聚，人生大變動期');}
  // 府相朝垣（穩定格局）
  if(majors.some(s=>s.name==='天府')&&majors.some(s=>s.name==='天相')){score+=2;notes.push('府相朝垣，格局穩健');}
  // 巨門+化忌（口舌是非）
  const juMen=stars.find(s=>s.name==='巨門');
  if(juMen&&juMen.hua==='化忌'){score-=2;notes.push('巨門化忌，口舌是非不斷');}
  // 廉貞+化忌（牢獄之災的象徵）
  const lianZhen=stars.find(s=>s.name==='廉貞');
  if(lianZhen&&lianZhen.hua==='化忌'){score-=2;notes.push('廉貞化忌，官非纏身注意法律');}

  // 5. 四化加分
  stars.forEach(s=>{
    if(s.hua==='化祿'){score+=2;notes.push(s.name+'化祿，此宮有福氣');}
    if(s.hua==='化權'){score+=1;notes.push(s.name+'化權，有掌控力');}
    if(s.hua==='化科'){score+=1;notes.push(s.name+'化科，貴人名聲');}
    if(s.hua==='化忌'&&!['巨門','廉貞'].includes(s.name)){score-=2;notes.push(s.name+'化忌，此宮有阻礙');}
  });

  return {score, notes, bright, majorCount:majors.length, luckyCount:luckys.length, shaCount:shas.length};
}
// 4 化
const ZW_HUA=['化祿','化權','化科','化忌'];

// 四化表 (依年干)
const SIHUA_TABLE={
  甲:{祿:'廉貞',權:'破軍',科:'武曲',忌:'太陽'},
  乙:{祿:'天機',權:'天梁',科:'紫微',忌:'太陰'},
  丙:{祿:'天同',權:'天機',科:'文昌',忌:'廉貞'},
  丁:{祿:'太陰',權:'天同',科:'天機',忌:'巨門'},
  戊:{祿:'貪狼',權:'太陰',科:'右弼',忌:'天機'},
  己:{祿:'武曲',權:'貪狼',科:'天梁',忌:'文曲'},
  庚:{祿:'太陽',權:'武曲',科:'太陰',忌:'天同'},
  辛:{祿:'巨門',權:'太陽',科:'文曲',忌:'文昌'},
  壬:{祿:'天梁',權:'紫微',科:'左輔',忌:'武曲'},
  癸:{祿:'破軍',權:'巨門',科:'太陰',忌:'貪狼'}
};

// 紫微星安星法（簡化版：依農曆日決定紫微所在宮位）
function getZiweiPalaceIdx(lunarDay){
  // 真實計算需要五行局，這裡用簡化映射
  // 紫微星位置 = (農曆日數 - 1) % 12
  return (lunarDay - 1) % 12;
}

// 天府星位置（與紫微對稱）
function getTianfuIdx(ziweiIdx){
  return (12 - ziweiIdx + 2) % 12; // 簡化對稱
}

// 農曆轉換（簡化：用地支捨算近似農曆月日）
function approxLunar(y,m,d){
  // 使用 lunar-javascript 庫計算真實農曆
  try {
    if(typeof Lunar !== 'undefined' && Lunar.Solar) {
      const solar = Lunar.Solar.fromYmd(y, m, d);
      const lunar = solar.getLunar();
      return { month: lunar.getMonth(), day: lunar.getDay() };
    }
  } catch(e) { console.warn('Lunar conversion failed:', e); }
  // 降級方案：查表近似（比卟方法更準確）
  // 農曆月大約落後陽曆 1-2 個月
  const approxMonth = m <= 2 ? (m + 10) : (m - 1);
  const lm = ((approxMonth - 1) % 12) + 1;
  return { month: lm, day: d <= 30 ? d : 29 };
}

function computeZiwei(year,month,day,hour,gender){
  const lunar = approxLunar(year,month,day);
  const yGan = TG[((year-4)%10+10)%10];
  const yZhi = DZ[((year-4)%12+12)%12];

  // 命宮地支：月支-時支
  const shi = Math.floor(((hour+1)%24)/2);
  const mingIdx = ((lunar.month - shi + 13) % 12 + 12) % 12; // 修正: +13 (正月子時=寅)
  // 身宮：月+時+寅基
  const shenIdx = ((lunar.month + shi + 2) % 12 + 12) % 12;

  // 五行局 (簡化：依命宮天干地支組合)
  // 宮干：年干起月法 (甲己→丙寅=2, 乙庚→戊寅=4, 丙辛→庚寅=6, 丁壬→壬寅=8, 戊癸→甲寅=0)
  const ganBase={'甲':2,'己':2,'乙':4,'庚':4,'丙':6,'辛':6,'丁':8,'壬':8,'戊':0,'癸':0};
  const gBase=ganBase[yGan]||0;
  const mingGanIdx=(gBase+((mingIdx-2+12)%12))%10;
  const mingGan = TG[mingGanIdx];
  const wuxingJu = getWuxingJu(mingGan, DZ[mingIdx]);

  // 安紫微星
  const ziweiIdx = getZiweiPalaceByJu(wuxingJu, lunar.day);
  // 天府位置: 與紫微以寅-申軸對稱
  // 紫微寅(2)→天府寅(2), 紫微卯(3)→天府丑(1), 紫微辰(4)→天府子(0)...
  const tianfuIdx = ((4 - ziweiIdx + 12) % 12 + 12) % 12;

  // 建立12宮 (逆時針排列: 命→兄弟→夫妻→子女→...)
  const palaces = [];
  for(let i=0;i<12;i++){
    const pIdx = ((mingIdx - i) % 12 + 12) % 12;
    palaces.push({
      name: ZW_PALACES[i],
      branch: DZ[pIdx],
      stars: [],
      isMing: i===0,
      isShen: pIdx === shenIdx
    });
  }

  // 安14主星（簡化排列）
  const ziweiOrder = [0,1,null,2,3,4,5]; // 紫微系
  const tianfuOrder = [6,7,8,9,10,11,12,13]; // 天府系

  // 紫微系安星
  const zwStarMap = [
    {star:0, offset:0},  // 紫微
    {star:1, offset:-1}, // 天機
    {star:2, offset:-3}, // 太陽
    {star:3, offset:-4}, // 武曲
    {star:4, offset:-5}, // 天同
    {star:5, offset:1}   // 廉貞（在紫微後一位）
  ];
  zwStarMap.forEach(({star,offset})=>{
    const pos = ((ziweiIdx + offset) % 12 + 12) % 12;
    const palaceIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === pos);
    if(palaceIdx>=0) palaces[palaceIdx].stars.push({...ZW_MAJOR[star], type:'major'});
  });

  // 天府系安星
  const tfStarMap = [
    {star:6, offset:0},   // 天府
    {star:7, offset:1},   // 太陰
    {star:8, offset:2},   // 貪狼
    {star:9, offset:3},   // 巨門
    {star:10, offset:4},  // 天相
    {star:11, offset:5},  // 天梁
    {star:12, offset:6},  // 七殺
    {star:13, offset:10}  // 破軍
  ];
  tfStarMap.forEach(({star,offset})=>{
    const pos = ((tianfuIdx + offset) % 12 + 12) % 12;
    const palaceIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === pos);
    if(palaceIdx>=0) palaces[palaceIdx].stars.push({...ZW_MAJOR[star], type:'major'});
  });

  // 安吉星（簡化）
  const wcIdx = ((year-4)%12+12)%12;
  addStarToPalace(palaces,'文昌','minor',(10-shi+12)%12);
  addStarToPalace(palaces,'文曲','minor',(shi+4)%12);
  addStarToPalace(palaces,'左輔','minor',(lunar.month+3)%12);
  addStarToPalace(palaces,'右弼','minor',(11-lunar.month+12)%12);

  // 安煞星（業界標準查表法）
  const yZhiIdx = DZ.indexOf(yZhi);
  
  // 擎羊陀羅：依年干查表（標準安星法）
  // 擎羊在祿存後一位，陀羅在祿存前一位
  const QY_TABLE={甲:3,乙:4,丙:6,丁:7,戊:6,己:7,庚:9,辛:10,壬:0,癸:1};
  const TL_TABLE={甲:1,乙:2,丙:4,丁:5,戊:4,己:5,庚:7,辛:8,壬:10,癸:11};
  addStarToPalace(palaces,'擎羊','sha',QY_TABLE[yGan]!==undefined?QY_TABLE[yGan]:3);
  addStarToPalace(palaces,'陀羅','sha',TL_TABLE[yGan]!==undefined?TL_TABLE[yGan]:1);

  // 火星：依年支分組+時支查表
  // 寅午戌年從丑(1)起，申子辰年從寅(2)起，巳酉丑年從卯(3)起，亥卯未年從酉(9)起
  const HX_BASE={寅:1,午:1,戌:1, 申:2,子:2,辰:2, 巳:3,酉:3,丑:3, 亥:9,卯:9,未:9};
  const hxBase=HX_BASE[yZhi]!==undefined?HX_BASE[yZhi]:2;
  addStarToPalace(palaces,'火星','sha',(hxBase+shi)%12);

  // 鈴星：依年支分組+時支查表
  // 寅午戌年從卯(3)起，申子辰年從戌(10)起，巳酉丑年從戌(10)起，亥卯未年從戌(10)起
  const LX_BASE={寅:3,午:3,戌:3, 申:10,子:10,辰:10, 巳:10,酉:10,丑:10, 亥:10,卯:10,未:10};
  const lxBase=LX_BASE[yZhi]!==undefined?LX_BASE[yZhi]:10;
  addStarToPalace(palaces,'鈴星','sha',(lxBase+shi)%12);

  // 安天魁天鉞（依年干·業界標準）
  // 甲戊庚→魁丑(1)鉞未(7), 乙己→魁子(0)鉞申(8), 丙丁→魁亥(11)鉞酉(9), 辛→魁午(6)鉞寅(2), 壬癸→魁卯(3)鉞巳(5)
  const TIANKU_TABLE={甲:1,戊:1,庚:1, 乙:0,己:0, 丙:11,丁:11, 辛:6, 壬:3,癸:3};
  const TIANYUE_TABLE={甲:7,戊:7,庚:7, 乙:8,己:8, 丙:9,丁:9, 辛:2, 壬:5,癸:5};
  addStarToPalace(palaces,'天魁','lucky',TIANKU_TABLE[yGan]!==undefined?TIANKU_TABLE[yGan]:1);
  addStarToPalace(palaces,'天鉞','lucky',TIANYUE_TABLE[yGan]!==undefined?TIANYUE_TABLE[yGan]:7);

  // 安祿存（依年干）
  const LUCUN_TABLE={甲:2,乙:3,丙:5,丁:6,戊:5,己:6,庚:8,辛:9,壬:11,癸:0}; // 祿存位置(地支idx)
  addStarToPalace(palaces,'祿存','lucky',LUCUN_TABLE[yGan]!==undefined?LUCUN_TABLE[yGan]:2);

  // 安天馬（依年支）
  const TIANMA_TABLE={寅:8,申:2,巳:11,亥:5,子:2,午:8,卯:5,酉:11,辰:2,戌:8,丑:11,未:5};
  addStarToPalace(palaces,'天馬','lucky',TIANMA_TABLE[yZhi]!==undefined?TIANMA_TABLE[yZhi]:2);

  // 四化
  const sihua = SIHUA_TABLE[yGan] || SIHUA_TABLE['甲'];
  const huaMap = [];
  [{type:'祿',label:'化祿'},{type:'權',label:'化權'},{type:'科',label:'化科'},{type:'忌',label:'化忌'}].forEach(h=>{
    const starName = sihua[h.type];
    palaces.forEach(p=>{
      const found = p.stars.find(s=>s.name===starName);
      if(found){
        found.hua = h.label;
        huaMap.push({star:starName, hua:h.label, palace:p.name});
      }
    });
  });

  // 命主星 (以年支決定)
  const MING_ZHU={0:'貪狼',1:'巨門',2:'祿存',3:'文曲',4:'廉貞',5:'武曲',6:'破軍',7:'武曲',8:'廉貞',9:'文曲',10:'祿存',11:'巨門'};
  // 身主星 (以年支決定)
  const SHEN_ZHU={0:'火星',1:'天相',2:'天梁',3:'天同',4:'文昌',5:'天機',6:'火星',7:'天相',8:'天梁',9:'天同',10:'文昌',11:'天機'};
  const yZhiIdx2=DZ.indexOf(yZhi);
  const mingZhu=MING_ZHU[yZhiIdx2]||'貪狼';
  const shenZhu=SHEN_ZHU[yZhiIdx2]||'火星';

  // ═══ 大限（紫微斗數大運）═══
  // 大限起始歲=五行局局數，每十年一宮
  // 陽男陰女順行，陰男陽女逆行
  const yGanYY=YY_G[yGan]; // 陽/陰
  const dxFwd=(gender==='male'&&yGanYY==='陽')||(gender==='female'&&yGanYY==='陰');
  const dxDir=dxFwd?1:-1;
  const dxStartAge=wuxingJu; // 大限起始歲=五行局數
  const daXian=[];
  for(let i=0;i<12;i++){
    const dxPalaceIdx=((mingIdx+(i*dxDir)*1)%12+12)%12; // 大限走的宮位地支index
    // 但大限走的是12宮（命宮開始）
    // 正確：大限從命宮出發，每十年進一宮
    const dxGongIdx=i; // 在palaces陣列裡的index
    const ageStart=dxStartAge+i*10;
    const ageEnd=ageStart+9;
    const curAge=new Date().getFullYear()-year;
    const isCur=curAge>=ageStart&&curAge<=ageEnd;

    // 大限宮位 = 命宮 ± i
    const dxBranchIdx=((mingIdx+i*dxDir)%12+12)%12;
    const dxBranch=DZ[dxBranchIdx];
    // 大限天干：用命宮天干按順/逆推
    const dxGanIdx=((mingGanIdx+i*dxDir)%10+10)%10;
    const dxGan=TG[dxGanIdx];

    // 找大限宮位對應的原盤宮位
    const origPalace=palaces.find(p=>p.branch===dxBranch);
    const dxPalaceName=origPalace?origPalace.name:'';
    const dxStars=origPalace?origPalace.stars:[];

    // 大限四化（依大限天干）
    const dxSihua=SIHUA_TABLE[dxGan]||SIHUA_TABLE['甲'];
    const dxHua=[];
    [{type:'祿',label:'化祿'},{type:'權',label:'化權'},{type:'科',label:'化科'},{type:'忌',label:'化忌'}].forEach(h=>{
      const sn=dxSihua[h.type];
      palaces.forEach(p=>{
        const found=p.stars.find(s=>s.name===sn);
        if(found) dxHua.push({star:sn,hua:h.label,palace:p.name,palaceBranch:p.branch});
      });
    });

    // ═══ 大限吉凶評估（紫微斗數象徵體系）═══
    const hasMajor=dxStars.filter(s=>s.type==='major');
    const hasLucky=dxStars.filter(s=>['lucky','minor'].includes(s.type));
    const hasSha=dxStars.filter(s=>s.type==='sha');

    // 用analyzePalace做完整宮位分析（含廟旺落陷+吉煞組合+特殊格局）
    const dxAnalysis=analyzePalace(origPalace, dxBranchIdx);
    let dxScore=dxAnalysis.score;
    let dxNotes=[...dxAnalysis.notes];

    // 大限四化飛入各宮的影響
    dxHua.forEach(h=>{
      // 四化飛入本命盤的對應宮位
      const targetPalace=palaces.find(p=>p.name===h.palace);
      if(h.hua==='化祿'){
        dxScore+=2;
        dxNotes.push('大限'+h.star+'化祿入'+h.palace+'（'+h.star+'帶來'+h.palace+'領域的機會）');
      }
      if(h.hua==='化權'){
        dxScore+=1;
        dxNotes.push('大限'+h.star+'化權入'+h.palace+'（'+h.palace+'領域有掌控力）');
      }
      if(h.hua==='化科'){
        dxScore+=0.5;
        dxNotes.push('大限'+h.star+'化科入'+h.palace+'（'+h.palace+'領域有貴人）');
      }
      if(h.hua==='化忌'){
        dxScore-=2;
        dxNotes.push('大限'+h.star+'化忌入'+h.palace+'（'+h.palace+'領域有困擾）');
        // 四化疊加：大限化忌+原盤化忌=雙忌（大凶）
        if(targetPalace){
          const origJi=targetPalace.stars.find(s=>s.hua==='化忌');
          if(origJi){dxScore-=2;dxNotes.push('⚠ 大限化忌疊原盤化忌於'+h.palace+'（雙忌疊加，大凶）');}
        }
      }
    });

    // 大限宮位象徵含義（走到什麼宮=人生主題）
    const DX_THEME={
      命宮:'自我發展期',兄弟:'人脈拓展期',夫妻:'感情重點期',子女:'創造力/子女期',
      財帛:'理財重點期',疾厄:'健康注意期',遷移:'變動發展期',交友:'社交擴展期',
      官祿:'事業衝刺期',田宅:'安家置業期',福德:'心靈成長期',父母:'長輩/學業期'
    };
    const dxTheme=DX_THEME[dxPalaceName]||'';

    let dxLevel='平';
    if(dxScore>=6) dxLevel='大吉';
    else if(dxScore>=3) dxLevel='中吉';
    else if(dxScore>=1) dxLevel='小吉';
    else if(dxScore>=-1) dxLevel='平';
    else if(dxScore>=-3) dxLevel='小凶';
    else if(dxScore>=-6) dxLevel='中凶';
    else dxLevel='大凶';

    daXian.push({
      ageStart,ageEnd,isCurrent:isCur,
      branch:dxBranch,gan:dxGan,
      palaceName:dxPalaceName,theme:dxTheme,
      stars:hasMajor.map(s=>s.name),
      lucky:hasLucky.map(s=>s.name),
      sha:hasSha.map(s=>s.name),
      bright:dxAnalysis.bright,
      hua:dxHua,notes:dxNotes,
      level:dxLevel,score:dxScore
    });
  }

  // ═══ 流年盤（依流年地支走宮）═══
  // 流年命宮 = 流年地支所在宮位（斗數流年以太歲入命）
  function getLiuNianZw(lnYear){
    const lnZI=((lnYear-4)%12+12)%12;
    const lnGI=((lnYear-4)%10+10)%10;
    const lnZ=DZ[lnZI], lnG=TG[lnGI];
    // 流年命宮 = 太歲地支所在的原盤宮位
    const lnMingPalace=palaces.find(p=>p.branch===lnZ);
    // 流年四化（依流年天干）
    const lnSH=SIHUA_TABLE[lnG]||SIHUA_TABLE['甲'];
    const lnHua=[];
    [{type:'祿',label:'化祿'},{type:'權',label:'化權'},{type:'科',label:'化科'},{type:'忌',label:'化忌'}].forEach(h=>{
      const sn=lnSH[h.type];
      palaces.forEach(p=>{
        const found=p.stars.find(s=>s.name===sn);
        if(found) lnHua.push({star:sn,hua:h.label,palace:p.name});
      });
    });
    // ═══ 流年吉凶（紫微象徵體系）═══
    const lnBranchIdx=DZ.indexOf(lnZ);
    const lnAnalysis=analyzePalace(lnMingPalace, lnBranchIdx);
    let lnScore=lnAnalysis.score;
    let lnNotes=[...lnAnalysis.notes];

    // 流年四化飛入各宮
    lnHua.forEach(h=>{
      const targetP=palaces.find(p=>p.name===h.palace);
      if(h.hua==='化祿'){
        lnScore+=1.5;
        lnNotes.push(h.star+'化祿入'+h.palace);
        // 化祿入命/財/官=大好
        if(['命宮','財帛','官祿'].includes(h.palace)) lnScore+=0.5;
      }
      if(h.hua==='化權'){lnScore+=1;lnNotes.push(h.star+'化權入'+h.palace);}
      if(h.hua==='化科'){lnScore+=0.5;lnNotes.push(h.star+'化科入'+h.palace);}
      if(h.hua==='化忌'){
        lnScore-=1.5;
        lnNotes.push(h.star+'化忌入'+h.palace);
        if(['命宮','財帛','官祿','疾厄'].includes(h.palace)) lnScore-=0.5;
        // 流年化忌疊原盤化忌
        if(targetP){
          const origJi=targetP.stars.find(s=>s.hua==='化忌');
          if(origJi){lnScore-=2;lnNotes.push('⚠ 流年化忌疊原盤化忌於'+h.palace+'（雙忌）');}
        }
        // 流年化忌疊大限化忌
        const curDx=daXian.find(d=>d.isCurrent);
        if(curDx&&curDx.hua){
          const dxJi=curDx.hua.find(dh=>dh.palace===h.palace&&dh.hua==='化忌');
          if(dxJi){lnScore-=2;lnNotes.push('⚠ 流年化忌疊大限化忌於'+h.palace+'（雙忌大凶）');}
        }
      }
    });

    // 流年走宮象徵
    const lnMingName=lnMingPalace?lnMingPalace.name:'';
    const LN_FOCUS={
      命宮:'自我表現',財帛:'財運收入',官祿:'事業升遷',夫妻:'感情婚姻',
      疾厄:'健康注意',遷移:'外出變動',交友:'人際社交',田宅:'家庭居住',
      子女:'創意/子女',福德:'心靈享受',兄弟:'人脈合作',父母:'長輩/學業'
    };
    const lnFocus=LN_FOCUS[lnMingName]||'';

    return {year:lnYear,gz:lnG+lnZ,mingPalace:lnMingName,focus:lnFocus,hua:lnHua,score:lnScore,notes:lnNotes,bright:lnAnalysis.bright};
  }

  return {palaces, mingIdx, shenIdx, yGan, yZhi, wuxingJu, sihua: huaMap, lunar, mingZhu, shenZhu, mingGan, ziweiIdx, tianfuIdx, daXian, getLiuNianZw};
}

function addStarToPalace(palaces, name, type, zhiIdx){
  const pIdx = palaces.findIndex(p=> DZ.indexOf(p.branch) === zhiIdx);
  if(pIdx>=0) palaces[pIdx].stars.push({name, type});
}

// ═══ 紫微斗數整合進八字大運流年吉凶 ═══
// 在S.bazi和S.ziwei都算完後呼叫
function mergeZiweiIntoBazi(){
  if(!S.bazi||!S.ziwei||!S.ziwei.daXian) return;
  const bazi=S.bazi, zw=S.ziwei;
  const thisYear=new Date().getFullYear();

  bazi.dayun.forEach(dy=>{
    // 找同期的紫微大限
    const matchDx=zw.daXian.find(dx=>
      (dy.ageStart>=dx.ageStart&&dy.ageStart<=dx.ageEnd)||
      (dx.ageStart>=dy.ageStart&&dx.ageStart<=dy.ageEnd)
    );
    if(!matchDx) return;

    // 紫微大限score按比例加入八字大運score
    const zwWeight=0.35; // 紫微佔35%的權重
    const zwAdj=matchDx.score*zwWeight;
    dy.score+=zwAdj;

    // 加入紫微notes
    if(matchDx.bright&&matchDx.bright.length){
      dy.notes.push('紫微大限走'+matchDx.palaceName+'（'+matchDx.bright.map(b=>b.star+b.label).join('、')+' ）');
    }else{
      dy.notes.push('紫微大限走'+matchDx.palaceName+'（'+matchDx.level+'）');
    }
    if(matchDx.theme) dy.notes.push('十年主題：'+matchDx.theme);
    // 重要的大限notes（廟旺、吉煞組合、四化、特殊格局）
    if(matchDx.notes){
      matchDx.notes.slice(0,3).forEach(n=>dy.notes.push('紫微：'+n));
    }

    // 重新計算大運level
    const s=dy.score;
    if(s>=6) dy.level='大吉';
    else if(s>=3) dy.level='中吉';
    else if(s>=1) dy.level='小吉';
    else if(s>=-1) dy.level='平';
    else if(s>=-3) dy.level='小凶';
    else if(s>=-6) dy.level='中凶';
    else dy.level='大凶';

    // 紫微流年整合進八字流年
    if(dy.liuNian&&zw.getLiuNianZw){
      dy.liuNian.forEach(ln=>{
        try{
          const zwLn=zw.getLiuNianZw(ln.year);
          if(!zwLn) return;

          // 紫微流年score按比例加入
          const lnZwAdj=zwLn.score*0.3;
          ln.score+=lnZwAdj;

          // 紫微流年notes
          if(zwLn.mingPalace) ln.notes.push('紫微流年走'+zwLn.mingPalace);
          if(zwLn.focus) ln.notes.push('重點：'+zwLn.focus);
          if(zwLn.bright&&zwLn.bright.length) ln.notes.push(zwLn.bright.map(b=>b.star+b.label).join('、'));
          if(zwLn.notes) zwLn.notes.slice(0,2).forEach(n=>ln.notes.push(n));

          // 重新計算流年level
          const ls=ln.score;
          if(ls>=5) ln.level='大吉';
          else if(ls>=3) ln.level='中吉';
          else if(ls>=1) ln.level='小吉';
          else if(ls>=-1) ln.level='平';
          else if(ls>=-3) ln.level='小凶';
          else if(ls>=-5) ln.level='中凶';
          else ln.level='大凶';
        }catch(e){}
      });
    }
  });
}

function getWuxingJu(gan, zhi){
  // 納音五行局：命宮干支→納音→五行→局數
  // 納音五行: 金=4, 木=3, 水=2, 火=6, 土=5
  const NY_EL=['金','火','木','土','金','火','水','土','金','木','水','土','火','木','水','金','火','木','土','金','火','水','土','金','木','水','土','火','木','水'];
  const JU={'金':4,'木':3,'水':2,'火':6,'土':5};
  const gi=TG.indexOf(gan), zi=DZ.indexOf(zhi);
  if(gi<0||zi<0)return 4;
  let idx=-1;
  for(let n=0;n<60;n++)if(n%10===gi&&n%12===zi){idx=n;break;}
  if(idx<0)return 4;
  const nyEl=NY_EL[Math.floor(idx/2)];
  return JU[nyEl]||4;
}

function getZiweiPalaceByJu(ju, lunarDay){
  // 紫微安星表（業界標準查表法）
  // 表格: ZIWEI_LUT[局-2][日-1] = offset from 寅 (0=寅,1=卯,...,11=丑)
  const ZIWEI_LUT=[
    // 水二局
    [1,0,2,1,3,2,4,3,5,4,6,5,7,6,8,7,9,8,10,9,11,10,0,11,1,0,2,1,3,2],
    // 木三局
    [1,2,0,2,3,1,3,4,2,4,5,3,5,6,4,6,7,5,7,8,6,8,9,7,9,10,8,10,11,9],
    // 金四局
    [1,2,2,0,2,3,3,1,3,4,4,2,4,5,5,3,5,6,6,4,6,7,7,5,7,8,8,6,8,9],
    // 土五局
    [1,2,2,2,0,2,3,3,3,1,3,4,4,4,2,4,5,5,5,3,5,6,6,6,4,6,7,7,7,5],
    // 火六局
    [1,2,2,2,2,0,2,3,3,3,3,1,3,4,4,4,4,2,4,5,5,5,5,3,5,6,6,6,6,4]
  ];
  const juIdx=ju-2;
  if(juIdx<0||juIdx>4)return 2;
  const dayIdx=Math.max(0,Math.min(29,lunarDay-1));
  const offset=ZIWEI_LUT[juIdx][dayIdx];
  return (offset+2)%12; // 轉換為地支index (寅=2)
}

function renderZiwei(){
  const zw = S.ziwei;
  if(!zw){document.getElementById('d-ziwei-info').innerHTML='<p class="text-dim">請先填寫出生資料</p>';return}

  // Info
  document.getElementById('d-ziwei-info').innerHTML=`
    <p>命宮：${zw.mingGan}${DZ[zw.mingIdx]}（${DZ[zw.mingIdx]}宮）｜ 身宮：${DZ[zw.shenIdx]}宮 ｜ ${['水二','木三','金四','土五','火六'][[2,3,4,5,6].indexOf(zw.wuxingJu)]}局</p>
    <p class="text-xs text-dim mt-xs">命主：${zw.mingZhu} ｜ 身主：${zw.shenZhu} ｜ 紫微：${DZ[zw.ziweiIdx]}宮 ｜ 天府：${DZ[zw.tianfuIdx]}宮</p>`;

  // 12宮格（4x4, 中間2x2空）
  // 排列順序 DZ idx: 辰(4)巳(5)午(6)未(7) / 卯(3)[空][空]申(8) / 寅(2)[空][空]酉(9) / 丑(1)子(0)亥(11)戌(10)
  const order = [
    [4,5,6,7],    // 辰巳午未
    [3,-1,-1,8],  // 卯 center center 申
    [2,-1,-1,9],  // 寅 center center 酉
    [1,0,11,10]   // 丑子亥戌
  ];

  let html = '<div class="zw-grid">';
  for(let row=0;row<4;row++){
    for(let col=0;col<4;col++){
      const idx = order[row][col];
      if(idx===-1){
        if(row===1&&col===1){
          // Center cell spans 2x2
          html+=`<div class="zw-cell zw-center" style="grid-column:2/4;grid-row:2/4">
            <div class="serif text-gold" style="font-size:1.1rem;margin-bottom:var(--sp-sm)">紫微斗數</div>
            <p class="text-dim text-xs">命宮：${DZ[zw.mingIdx]}</p>
            <p class="text-dim text-xs">年干：${zw.yGan}${zw.yZhi}</p>
          </div>`;
        }
        continue;
      }
      const palace = zw.palaces.find(p => DZ.indexOf(p.branch) === idx);
      if(!palace){html+=`<div class="zw-cell"><span class="zw-palace">${DZ[idx]}</span></div>`;continue}

      const isMing = palace.isMing;
      html+=`<div class="zw-cell${isMing?' active-palace':''}">
        <div class="zw-palace">${palace.name}${isMing?' ⭐':''}</div>
        <div class="zw-branch">${palace.branch}</div>
        <div class="zw-stars">`;
      palace.stars.forEach(s=>{
        const cls = s.type==='major'?'major':s.type==='sha'?'text-danger':'minor';
        html+=`<span class="zw-star ${cls}">${s.name}</span>`;
        if(s.hua)html+=`<span class="zw-hua">${s.hua}</span>`;
      });
      html+=`</div></div>`;
    }
  }
  html+='</div>';
  document.getElementById('d-ziwei-grid').innerHTML=html;

  // 四化
  document.getElementById('d-ziwei-sihua').innerHTML = zw.sihua.length?
    zw.sihua.map(h=>`<p><span class="tag ${h.hua.includes('祿')?'tag-green':h.hua.includes('忌')?'tag-red':'tag-gold'}">${h.hua}</span> ${h.star} → ${h.palace}</p>`).join('')
    :'<p class="text-dim">四化資訊計算中</p>';

  // 解讀
  const mingPalace = zw.palaces[0];
  const mingStars = mingPalace.stars.filter(s=>s.type==='major');
  let reading = '';
  if(mingStars.length){
    reading+=`<p><strong>命宮主星：</strong>${mingStars.map(s=>s.name).join('、')}</p>`;
    mingStars.forEach(s=>{
      const info = ZW_MAJOR.find(m=>m.name===s.name);
      if(info)reading+=`<p class="text-dim">→ ${info.name}：${info.nature}</p>`;
    });
  }else{
    reading+=`<p>命宮無主星，借對宮（遷移宮）星曜判斷。性格較為被動，需主動出擊。</p>`;
  }
  // 財帛宮
  const caiPalace = zw.palaces[4];
  const caiStars = caiPalace.stars.filter(s=>s.type==='major');
  if(caiStars.length)reading+=`<p class="mt-sm"><strong>財帛宮：</strong>${caiStars.map(s=>s.name).join('、')} — ${caiStars.some(s=>['武曲','天府','太陰'].includes(s.name))?'財運基礎佳':'財運需靠努力積累'}</p>`;

  // 官祿宮
  const guanPalace = zw.palaces[8];
  const guanStars = guanPalace.stars.filter(s=>s.type==='major');
  if(guanStars.length)reading+=`<p class="mt-sm"><strong>官祿宮：</strong>${guanStars.map(s=>s.name).join('、')} — ${guanStars.some(s=>['紫微','天府','太陽'].includes(s.name))?'事業格局大，適合管理職':'適合專業技術或自由業'}</p>`;

  // 煞星提醒
  const shaStars = [];
  zw.palaces.forEach(p=>p.stars.filter(s=>s.type==='sha').forEach(s=>shaStars.push(s.name+'('+p.name+')')));
  if(shaStars.length)reading+=`<p class="mt-sm text-warn"><strong>煞星：</strong>${shaStars.join('、')} — 注意相關宮位的挑戰</p>`;

  // ── 問題類型對應宮位深度解讀 ──
  const typeLabel2 = S.form ? ({'love':'愛情','career':'事業','wealth':'財運','health':'健康','general':'綜合','relationship':'人際','family':'家庭'}[S.form.type]||'綜合') : '綜合';
  const typeToGong2 = {love:2,career:8,wealth:4,health:5,family:9,relationship:7,general:0};
  const tgIdx = typeToGong2[S.form?S.form.type:'general'];
  if(tgIdx !== undefined && tgIdx !== 0) {
    const tgPalace = zw.palaces[tgIdx];
    if(tgPalace) {
      const tgMajors = tgPalace.stars.filter(s=>s.type==='major');
      const tgMinors = tgPalace.stars.filter(s=>s.type==='minor');
      const tgSha = tgPalace.stars.filter(s=>s.type==='sha');
      reading += `<div class="divider"></div>`;
      reading += `<p class="mt-sm"><strong>📌 針對「${typeLabel2}」— ${tgPalace.name}分析：</strong></p>`;
      if(tgMajors.length) {
        reading += `<p>主星：${tgMajors.map(s=>{
          const info=ZW_MAJOR.find(m=>m.name===s.name);
          const bright=s.brightness?' ('+s.brightness+')':'';
          const hua=s.hua?' '+s.hua:'';
          return s.name+bright+hua+(info?' — '+info.nature:'');
        }).join('；')}</p>`;

        // Type-specific star interpretation
        const tgTypeAdvice = {
          love: function(stars) {
            const msgs = [];
            if(stars.some(s=>s.name==='太陰')) msgs.push('太陰入夫妻宮，感情細膩溫柔，異性緣佳。');
            if(stars.some(s=>s.name==='貪狼')) msgs.push('貪狼入夫妻宮，桃花旺盛，但感情容易波折。');
            if(stars.some(s=>s.name==='天同')) msgs.push('天同入夫妻宮，感情和睦，相處舒適。');
            if(stars.some(s=>s.name==='天機')) msgs.push('天機入夫妻宮，感情中多變，需要用心經營。');
            if(stars.some(s=>s.name==='武曲')) msgs.push('武曲入夫妻宮，另一半務實能幹，但可能缺乏浪漫。');
            if(stars.some(s=>s.name==='紫微')) msgs.push('紫微入夫妻宮，另一半有主見有能力，但可能較強勢。');
            if(stars.some(s=>s.name==='七殺')) msgs.push('七殺入夫妻宮，感情來得快烈但有波動。');
            if(stars.some(s=>s.name==='破軍')) msgs.push('破軍入夫妻宮，感情多變化，婚前可能經歷多段戀情。');
            if(stars.some(s=>s.name==='太陽')) msgs.push('太陽入夫妻宮，另一半為人光明正大，社交活躍。');
            if(stars.some(s=>s.name==='巨門')) msgs.push('巨門入夫妻宮，感情中需注意口舌爭執，溝通是關鍵。');
            if(stars.some(s=>s.name==='天梁')) msgs.push('天梁入夫妻宮，另一半穩重可靠，年齡差距可能較大。');
            if(stars.some(s=>s.name==='天相')) msgs.push('天相入夫妻宮，另一半溫和有禮，適合共同經營家庭。');
            if(stars.some(s=>s.name==='天府')) msgs.push('天府入夫妻宮，另一半穩健有財，感情穩定。');
            if(stars.some(s=>s.name==='廉貞')) msgs.push('廉貞入夫妻宮，感情熱烈但需防第三者。');
            return msgs.length ? msgs.join('') : '';
          },
          career: function(stars) {
            const msgs = [];
            if(stars.some(s=>s.name==='紫微')) msgs.push('紫微入官祿宮，事業格局大，適合管理或獨立經營。');
            if(stars.some(s=>s.name==='天府')) msgs.push('天府入官祿宮，事業穩定有發展，適合大機構。');
            if(stars.some(s=>s.name==='太陽')) msgs.push('太陽入官祿宮，事業有公眾曝光度，適合公職或傳播業。');
            if(stars.some(s=>s.name==='武曲')) msgs.push('武曲入官祿宮，適合金融、軍警或需要果斷的職業。');
            if(stars.some(s=>s.name==='天機')) msgs.push('天機入官祿宮，適合策劃、企劃或變動性高的職業。');
            if(stars.some(s=>s.name==='天同')) msgs.push('天同入官祿宮，工作偏安穩，適合服務業或教育。');
            if(stars.some(s=>s.name==='七殺')) msgs.push('七殺入官祿宮，事業心強，適合獨當一面的角色。');
            if(stars.some(s=>s.name==='破軍')) msgs.push('破軍入官祿宮，適合開創性工作，職業易有大變動。');
            if(stars.some(s=>s.name==='貪狼')) msgs.push('貪狼入官祿宮，適合業務、公關或需要交際的工作。');
            if(stars.some(s=>s.name==='巨門')) msgs.push('巨門入官祿宮，適合律師、教師或需要口才的工作。');
            if(stars.some(s=>s.name==='天梁')) msgs.push('天梁入官祿宮，適合醫療、法律或公益事業。');
            if(stars.some(s=>s.name==='廉貞')) msgs.push('廉貞入官祿宮，事業有重心，適合公務或管理。');
            return msgs.length ? msgs.join('') : '';
          },
          wealth: function(stars) {
            const msgs = [];
            if(stars.some(s=>s.name==='武曲')) msgs.push('武曲入財帛宮，天生財星，正財運極佳，適合金融投資。');
            if(stars.some(s=>s.name==='天府')) msgs.push('天府入財帛宮，財庫穩固，適合穩健理財。');
            if(stars.some(s=>s.name==='太陰')) msgs.push('太陰入財帛宮，適合不動產投資，財富慢慢累積。');
            if(stars.some(s=>s.name==='貪狼')) msgs.push('貪狼入財帛宮，偏財運佳但花費也大，需控制開支。');
            if(stars.some(s=>s.name==='紫微')) msgs.push('紫微入財帛宮，大器晚成型，財富會隨地位提升。');
            if(stars.some(s=>s.name==='天機')) msgs.push('天機入財帛宮，財來財卻，需靈活理財。');
            if(stars.some(s=>s.name==='太陽')) msgs.push('太陽入財帛宮，大方慷慨，正財運佳但不宜太慷慨。');
            if(stars.some(s=>s.name==='巨門')) msgs.push('巨門入財帛宮，靠口才賺錢，但理財需更謹慎。');
            if(stars.some(s=>s.name==='七殺')) msgs.push('七殺入財帛宮，財運起伏大，適合冒險型投資。');
            if(stars.some(s=>s.name==='破軍')) msgs.push('破軍入財帛宮，財運大起大落，需建立儲蓄習慣。');
            return msgs.length ? msgs.join('') : '';
          },
          health: function(stars) {
            const msgs = [];
            if(stars.some(s=>s.name==='天同')) msgs.push('天同入疾厄宮，先天體質不差，注意肥胖與脾臟。');
            if(stars.some(s=>s.name==='天機')) msgs.push('天機入疾厄宮，注意肝膽、神經系統。');
            if(stars.some(s=>s.name==='太陽')) msgs.push('太陽入疾厄宮，注意眼睛、血壓、心臟。');
            if(stars.some(s=>s.name==='太陰')) msgs.push('太陰入疾厄宮，注意脾臟、婦科或泌尿系統。');
            if(stars.some(s=>s.name==='武曲')) msgs.push('武曲入疾厄宮，注意呼吸系統、筋骨。');
            if(stars.some(s=>s.name==='廉貞')) msgs.push('廉貞入疾厄宮，注意心臟、血液循環。');
            if(stars.some(s=>s.name==='貪狼')) msgs.push('貪狼入疾厄宮，注意肝膽、過度消耗。');
            return msgs.length ? msgs.join('') : '';
          }
        };
        const typeAdviceFn = tgTypeAdvice[S.form?S.form.type:'general'];
        if(typeAdviceFn) {
          const advice = typeAdviceFn(tgMajors);
          if(advice) reading += `<p class="mt-sm">${advice}</p>`;
        }
      } else {
        reading += `<p>${tgPalace.name}無主星，需借對宮星曜判斷，此方面較不穩定，需主動經營。</p>`;
      }
      if(tgMinors.length) reading += `<p class="text-dim text-sm mt-sm">輔星：${tgMinors.map(s=>s.name).join('、')}${tgMinors.some(s=>['文昌','文曲','左輔','右弼'].includes(s.name))?' — 有輔星助力':''}</p>`;
      if(tgSha.length) reading += `<p class="text-warn text-sm mt-sm">⚠ 煞星：${tgSha.map(s=>s.name).join('、')} — 此方面有挑戰需克服</p>`;

      // 四化在此宮的影響
      const huaInGong = zw.sihua.filter(h=>h.palace===tgPalace.name);
      if(huaInGong.length) {
        reading += `<p class="mt-sm">四化影響：${huaInGong.map(h=>`${h.star} ${h.hua}`).join('、')}</p>`;
        huaInGong.forEach(h=>{
          if(h.hua==='化祿') reading+=`<p class="text-sm" style="color:#4ade80">💎 ${h.star}化祿入${tgPalace.name}，${typeLabel2}方面有先天福氣，容易有好的結果。</p>`;
          if(h.hua==='化權') reading+=`<p class="text-sm text-gold">🟡 ${h.star}化權入${tgPalace.name}，${typeLabel2}方面有掌控力，但不宜太強勢。</p>`;
          if(h.hua==='化科') reading+=`<p class="text-sm" style="color:#60a5fa">🔵 ${h.star}化科入${tgPalace.name}，${typeLabel2}方面有貴人助力，名聲好。</p>`;
          if(h.hua==='化忌') reading+=`<p class="text-sm text-danger">🔴 ${h.star}化忌入${tgPalace.name}，${typeLabel2}方面需格外注意，容易有波折。</p>`;
        });
      }
    }
  }

  document.getElementById('d-ziwei-reading').innerHTML=reading||'<p class="text-dim">解讀生成中…</p>';
}
/* =============================================================
   姓名學 NAMEOLOGY（三才五格）
   ============================================================= */
const STROKE_OVERRIDE={
  // 常見字的康熙筆畫數（部分）
  '一':1,'二':2,'三':3,'四':4,'五':5,'六':6,'七':7,'八':8,'九':9,'十':10,
  '大':3,'小':3,'中':4,'上':3,'下':3,'人':2,'天':4,'地':6,'水':4,'火':4,
  '木':4,'金':8,'土':3,'日':4,'月':4,'年':6,'明':8,'光':6,'華':14,'國':11,
  '家':10,'庭':10,'心':4,'思':9,'愛':13,'碧':9,'玉':5,'龍':16,'鳳':14,
  '林':8,'陳':16,'王':4,'李':7,'張':11,'劉':15,'黃':12,'吳':7,'趙':14,
  '楊':13,'周':8,'徐':10,'孫':10,'馬':10,'朱':6,'胡':11,'郭':15,'何':7,
  '高':10,'羅':20,'鄭':19,'蔡':17,'謝':17,'蕭':18,'許':11,'曾':12,'彭':12,
  '呂':7,'蘇':22,'盧':16,'蔣':17,'沈':8,'韓':17,'唐':10,'馮':12,'潘':16,
  '志':7,'偉':11,'強':12,'建':9,'文':4,'武':8,'德':15,'仁':4,'義':13,
  '禮':18,'信':9,'智':12,'勇':9,'忠':8,'孝':7,'俊':9,'傑':12,'宏':7,
  '雅':12,'靜':16,'慧':15,'敏':11,'婷':12,'秀':7,'芳':10,'麗':19,'英':11,
  '春':9,'夏':10,'秋':9,'冬':5,'東':8,'西':6,'南':9,'北':5,'成':7,'功':5,
  '安':6,'平':5,'福':14,'壽':14,'喜':12,'樂':15,'和':8,'順':12,'吉':6,
  '祥':11,'瑞':14,'達':16,'昌':8,'盛':12,'榮':14,'富':12,'貴':12,'康':11
};

function kangxiStroke(ch){
  if(STROKE_OVERRIDE[ch])return STROKE_OVERRIDE[ch];
  // 部首修正（常見差異）
  const code=ch.charCodeAt(0);
  // 粗略估算：CJK字的 Unicode 碼 % 25 + 2
  return (code % 23) + 3;
}

function analyzeName(fullName){
  if(!fullName||fullName.length<2)return null;
  const chars=[...fullName];
  const strokes=chars.map(c=>kangxiStroke(c));

  let tianGe,renGe,diGe,waiGe,zongGe;

  if(chars.length===2){
    // 單姓單名
    tianGe=strokes[0]+1;
    renGe=strokes[0]+strokes[1];
    diGe=strokes[1]+1;
    zongGe=strokes[0]+strokes[1];
    waiGe=2;
  }else if(chars.length===3){
    // 單姓雙名（最常見）
    tianGe=strokes[0]+1;
    renGe=strokes[0]+strokes[1];
    diGe=strokes[1]+strokes[2];
    zongGe=strokes[0]+strokes[1]+strokes[2];
    waiGe=strokes[0]+strokes[2];
  }else if(chars.length===4){
    // 複姓雙名
    tianGe=strokes[0]+strokes[1];
    renGe=strokes[1]+strokes[2];
    diGe=strokes[2]+strokes[3];
    zongGe=strokes.reduce((a,b)=>a+b,0);
    waiGe=strokes[0]+strokes[3];
  }else{
    return null;
  }

  // 五行
  function geWuxing(ge){
    const tail=ge%10;
    if(tail===1||tail===2)return'木';
    if(tail===3||tail===4)return'火';
    if(tail===5||tail===6)return'土';
    if(tail===7||tail===8)return'金';
    return'水';
  }

  // 吉凶（依正統81數理靈動數）
  function geFortune(ge){
    const n=((ge-1)%80)+1;
    // 大吉（僅最吉利的數）
    const dj=[1,3,5,8,11,13,15,16,21,24,25,31,32,35,37,41,45,48,63,67,68];
    // 吉（次吉）
    const ji=[6,7,17,18,23,29,33,39,47,52,57,61,65];
    // 半吉半凶
    const ban=[27,38,51,55,58,71,73,75];
    // 凶
    if(dj.includes(n))return{level:'大吉',cls:'text-success'};
    if(ji.includes(n))return{level:'吉',cls:'text-success'};
    if(ban.includes(n))return{level:'平',cls:'text-dim'};
    return{level:'凶',cls:'text-danger'};
  }

  // 三才配置
  const sanCai=[geWuxing(tianGe),geWuxing(renGe),geWuxing(diGe)];
  // 三才吉凶（簡化判斷）
  let sanCaiLevel='吉';
  const [t,r,d]=sanCai;
  // 相生為吉
  if(SHENG[t]===r&&SHENG[r]===d)sanCaiLevel='大吉';
  else if(SHENG[t]===r||SHENG[r]===d)sanCaiLevel='吉';
  else if(KE[t]===r||KE[r]===d)sanCaiLevel='凶';
  else sanCaiLevel='平';

  return{
    name:fullName, strokes,
    tianGe:{num:tianGe,el:geWuxing(tianGe),fortune:geFortune(tianGe)},
    renGe:{num:renGe,el:geWuxing(renGe),fortune:geFortune(renGe)},
    diGe:{num:diGe,el:geWuxing(diGe),fortune:geFortune(diGe)},
    waiGe:{num:waiGe,el:geWuxing(waiGe),fortune:geFortune(waiGe)},
    zongGe:{num:zongGe,el:geWuxing(zongGe),fortune:geFortune(zongGe)},
    sanCai,sanCaiLevel
  };
}

/* =============================================================
   水晶推薦系統 CRYSTAL — 擴充版
   ============================================================= */
const CRYSTAL_DB={
  金:[
    {n:'白水晶',icon:'💍',el:'金',d:'淨化能量場，增強思維清晰度，萬能調和石。',wear:'左手佩戴，或放書桌/辦公桌。',taboo:'避免碰撞，定期淨化。'},
    {n:'黃鐵礦',icon:'✨',el:'金',d:'增強財運，提升自信與行動力。',wear:'放在錢包或辦公桌左上角。',taboo:'怕水，避免接觸液體。'},
    {n:'白幽靈',icon:'💠',el:'金',d:'淨化磁場，提升靈性直覺。',wear:'冥想時手持或佩戴。',taboo:'避免陽光直射。'},
    {n:'鈦晶',icon:'⚡',el:'金',d:'招正財偏財，增強領導力與氣魄。',wear:'左手佩戴，面試/簽約時特別有效。',taboo:'磁場強，睡眠時建議取下。'}
  ],
  木:[
    {n:'綠幽靈',icon:'💚',el:'木',d:'招正財，事業穩步上升，適合上班族。',wear:'左手佩戴，放辦公桌增事業運。',taboo:'避免高溫與化學品。'},
    {n:'東陵玉',icon:'🌿',el:'木',d:'舒緩壓力，帶來好運與樂觀心態。',wear:'隨身佩戴或放枕頭下助眠。',taboo:'定期用月光淨化。'},
    {n:'翡翠',icon:'💎',el:'木',d:'護身辟邪，增強健康與人緣。',wear:'佩戴在靠近心臟處。',taboo:'避免碰撞與高溫。'},
    {n:'橄欖石',icon:'🌱',el:'木',d:'療癒心輪，帶來正能量與好運。',wear:'左手佩戴，可配合冥想。',taboo:'質地較軟，注意保護。'}
  ],
  水:[
    {n:'黑曜石',icon:'🖤',el:'水',d:'擋煞辟邪首選，以水洩金，化壓力為動力。',wear:'右手佩戴辟邪。',taboo:'定期流水淨化。'},
    {n:'黑髮晶',icon:'🕸️',el:'水',d:'排除負能量，增強領袖魅力，官殺太旺者首選。',wear:'左手佩戴。',taboo:'磁場強，敏感體質注意。'},
    {n:'海藍寶',icon:'💙',el:'水',d:'增強溝通力，平靜情緒，水氣滋養日主。',wear:'佩戴在喉輪附近（項鍊）效果最佳。',taboo:'避免長時間日曬。'},
    {n:'藍虎眼',icon:'👁️',el:'水',d:'增強洞察力與決斷力，水氣護身。',wear:'左手佩戴。',taboo:'定期淨化。'}
  ],
  火:[
    {n:'紅瑪瑙',icon:'❤️',el:'火',d:'激發熱情，增強行動力與勇氣。',wear:'右手佩戴增強行動力。',taboo:'避免高溫環境。'},
    {n:'石榴石',icon:'🔴',el:'火',d:'提升活力，增強意志力與桃花運。',wear:'左手佩戴，貼身效果好。',taboo:'定期用水晶簇淨化。'},
    {n:'紅碧璽',icon:'💗',el:'火',d:'強力招桃花，增強人際魅力。',wear:'佩戴在心輪附近。',taboo:'磁場敏感，避免與其他強磁場水晶混戴。'},
    {n:'太陽石',icon:'☀️',el:'火',d:'帶來正能量，增強自信與領導力。',wear:'日間佩戴效果佳。',taboo:'避免長時間泡水。'}
  ],
  土:[
    {n:'黃水晶',icon:'💛',el:'土',d:'招偏財，提升自信與個人魅力。',wear:'左手佩戴，放錢包也可。',taboo:'避免陽光長時間直射，會褪色。'},
    {n:'虎眼石',icon:'🐅',el:'土',d:'增強決斷力，招財辟邪，穩定心性。',wear:'右手佩戴增強氣場。',taboo:'定期日光浴淨化（短時間）。'},
    {n:'茶晶',icon:'🍵',el:'土',d:'排除負能量，增強穩定感。',wear:'佩戴或放在家中客廳。',taboo:'避免化學品。'},
    {n:'瑪瑙',icon:'🔶',el:'土',d:'保護、穩定、增強耐力。',wear:'可隨身佩戴，適合各場合。',taboo:'質地堅硬但仍需小心碰撞。'}
  ]
};

// 問題類型 → 特殊推薦
const CRYSTAL_BY_TYPE={
  love:[{n:'粉晶',icon:'💕',el:'土',d:'招桃花首選，增強感情運與人際魅力。',wear:'左手佩戴，睡前放枕頭下。',taboo:'需定期淨化，吸收負能量後會變暗。'},
        {n:'草荓晶',icon:'🍓',el:'火',d:'增強異性緣，帶來甜蜜的戀愛機會。',wear:'左手佩戴，約會時效果倍增。',taboo:'避免碰撞。'}],
  career:[{n:'鈦晶',icon:'⚡',el:'金',d:'事業晉升首選，增強領導力與決斷力。',wear:'面試/重要會議時佩戴。',taboo:'磁場強，睡眠時取下。'}],
  wealth:[{n:'黃水晶',icon:'💛',el:'土',d:'偏財運首選，提升投資眼光。',wear:'左手佩戴，放收銀台也可。',taboo:'避免日曬。'},
          {n:'綠幽靈',icon:'💚',el:'木',d:'正財運首選，適合穩健理財。',wear:'左手佩戴。',taboo:'避免高溫。'}],
  health:[{n:'紫水晶',icon:'💜',el:'火',d:'安神助眠，穩定情緒，促進身心平衡。',wear:'放枕頭下助眠，或佩戴在第三眼處冥想。',taboo:'避免日曬會褪色。'}]
};

function renderCrystalExpanded(bazi, type){
  const need = bazi.fav[0];
  const baseCrystals = CRYSTAL_DB[need] || CRYSTAL_DB['土'];
  const typeCrystals = CRYSTAL_BY_TYPE[type] || [];

  // 去重合併
  const allCrystals = [...typeCrystals];
  baseCrystals.forEach(c=>{if(!allCrystals.find(a=>a.n===c.n))allCrystals.push(c)});
  const display = allCrystals.slice(0,4);

  document.getElementById('r-crystal').innerHTML=`
    <p class="mb-md">根據命盤（喜用 <span class="tag tag-gold">${need}行</span>）與問題類型（<span class="tag tag-blue">${getTypeLabel(type)}</span>），推薦：</p>
    <div class="crystal-grid">${display.map(c=>`
      <div class="crystal-card">
        <div class="crystal-icon">${c.icon}</div>
        <div class="crystal-name">${c.n}</div>
        <div class="text-xs mb-sm"><span class="el-tag el-${c.el}">${c.el}行</span></div>
        <p class="text-sm text-dim">${c.d}</p>
        <p class="text-xs text-muted mt-sm"><i class="fas fa-hand-holding-heart"></i> ${c.wear}</p>
        <p class="text-xs text-warn mt-sm"><i class="fas fa-exclamation-triangle"></i> ${c.taboo}</p>
      </div>`).join('')}</div>
    <p class="text-xs text-muted mt-md"><i class="fas fa-info-circle"></i> 本建議僅供能量校準參考，不具醫療或命運保證效力。水晶效果因人而異，請依自身感受調整。</p>`;
}

/* =============================================================
   FUSION ENGINE v2 — 五維度加權融合
   ============================================================= */
function runAnalysisV2(){
  try{ renderBazi(); }catch(e){ console.error('renderBazi error:', e); alert('renderBazi error: '+e.message); return; }
  try{ renderMeihua(); }catch(e){ console.error('renderMeihua error:', e); }
  try{ renderTarot(); }catch(e){ console.error('renderTarot error:', e); }
  try{ renderZiwei(); }catch(e){ console.error('renderZiwei error:', e); }
  try{ renderName(); }catch(e){ console.error('renderName error:', e); }

  const b=S.bazi; if(!b)return;
  const type=S.form.type;
  const question=S.form.question;

  // ── 1. 八字評分 (0-100) ──
  let baziScore=45;
  // 喜用神在命盤中的強度
  const favEl=b.fav&&b.fav[0]?b.fav[0]:'';
  const unfavEl=b.unfav&&b.unfav[0]?b.unfav[0]:'';
  if(favEl&&b.ep[favEl]>20)baziScore+=18;
  else if(favEl&&b.ep[favEl]>10)baziScore+=10;
  else if(favEl)baziScore-=5;
  if(unfavEl&&b.ep[unfavEl]>25)baziScore-=15;

  // 身強弱 × 類型交叉
  if(type==='wealth'){
    const caiEl=typeof KE!=='undefined'?KE[b.dmEl]:'';
    if(b.strong&&caiEl&&b.ep[caiEl]>15)baziScore+=15; // 身強扛財
    else if(!b.strong&&caiEl&&b.ep[caiEl]>20)baziScore-=10; // 身弱財多壓身
    else if(b.strong)baziScore+=5;
    else baziScore-=5;
  } else if(type==='career'){
    if(b.strong)baziScore+=12;
    else baziScore-=6;
    const guanEl=typeof KE!=='undefined'?KE[b.dmEl]:'';
    if(guanEl&&b.ep[guanEl]>20)baziScore-=10;
    const shiEl=typeof SHENG!=='undefined'?SHENG[b.dmEl]:'';
    if(b.strong&&shiEl&&b.ep[shiEl]>15)baziScore+=8;
    const yinEl=typeof BE_SHENG!=='undefined'?BE_SHENG[b.dmEl]:'';
    if(!b.strong&&yinEl&&b.ep[yinEl]>15)baziScore+=10;
  } else if(type==='love'){
    if(!b.strong)baziScore+=3; // 身弱桃花多
    if(b.shensha&&b.shensha.includes('桃花'))baziScore+=15;
    if(b.shensha&&b.shensha.includes('紅鸞'))baziScore+=12;
    if(b.shensha&&b.shensha.includes('孤辰'))baziScore-=10;
    if(b.shensha&&b.shensha.includes('寡宿'))baziScore-=10;
  } else if(type==='health'){
    if(b.strong)baziScore+=10; // 身強體質好
    else baziScore-=8;
  }

  // 大運影響（加大幅度）
  const curDy=b.dayun.find(d=>d.isCurrent);
  if(curDy){
    if(curDy.level==='大吉')baziScore+=22;
    else if(curDy.level==='中吉')baziScore+=14;
    else if(curDy.level==='小吉')baziScore+=6;
    else if(curDy.level==='小凶')baziScore-=8;
    else if(curDy.level==='中凶')baziScore-=16;
    else if(curDy.level==='大凶')baziScore-=24;
  }

  // 神煞（更多項目）
  if(b.shensha){
    if(b.shensha.includes('天乙貴人'))baziScore+=8;
    if(b.shensha.includes('天德'))baziScore+=5;
    if(b.shensha.includes('月德'))baziScore+=5;
    if(b.shensha.includes('文昌')&&type==='career')baziScore+=10;
    if(b.shensha.includes('驛馬')&&type==='career')baziScore+=6;
    if(b.shensha.includes('將星'))baziScore+=5;
    if(b.shensha.includes('羊刃'))baziScore-=8;
    if(b.shensha.includes('劫煞'))baziScore-=6;
    if(b.shensha.includes('亡神'))baziScore-=5;
  }
  baziScore=Math.max(8,Math.min(95,baziScore));

  // ── 2. 梅花評分（體用生剋 + 卦象 + 動爻） ──
  let mhScore=50;
  if(S.meihua){
    const fMap={'大吉':88,'吉':72,'小吉':58,'平':48,'小凶':38,'凶':22};
    mhScore=fMap[S.meihua.ty.f]||50;
    // 體用關係微調
    const tyR=S.meihua.ty.r||'';
    if(tyR.includes('生體'))mhScore+=5;       // 用生體=外來助力
    else if(tyR.includes('體生'))mhScore-=3;  // 體生用=耗費
    else if(tyR.includes('剋體'))mhScore-=5;  // 用剋體=阻礙
    else if(tyR.includes('體剋'))mhScore+=3;  // 體剋用=可控制
    // 變卦走勢
    if(S.meihua.bian&&S.meihua.bian.n){
      const bianGood=['乾','離','兌','巽'];
      const bianBad=['坎','艮'];
      const bn=S.meihua.bian.n||'';
      if(bianGood.some(g=>bn.includes(g)))mhScore+=4;
      if(bianBad.some(b=>bn.includes(b)))mhScore-=3;
    }
    mhScore=Math.max(10,Math.min(90,mhScore));
  }

  // ── 3. 塔羅評分（位置加權 + 特定牌加權） ──
  let tarotScore=50;
  if(S.tarot.drawn.length>=10){
    // 各位置權重：核心=2.5, 阻礙=-1.5(反向), 過去=0.5, 未來=2, 結果=2, 近期=1.5, 自我=1, 環境=1, 恐懼=-0.5(反向), 最終=3
    const posWeight=[2.5,-1.5,0.5,2.0,2.0,1.5,1.0,1.0,-0.5,3.0];
    let weightedSum=0, totalAbs=0;
    S.tarot.drawn.forEach((c,i)=>{
      const w=posWeight[i]||1;
      const baseVal=c.isUp?1:-0.8;
      // 阻礙位(1)和恐懼位(8)：逆位反而是好事（阻礙被化解）
      if((i===1||i===8)&&!c.isUp){
        weightedSum+=Math.abs(w)*0.6; // 逆位在阻礙位=阻礙被化解=正面
      } else {
        weightedSum+=baseVal*w;
      }
      totalAbs+=Math.abs(w);

      // 特定大牌強力加權
      if(c.id===19&&c.isUp)weightedSum+=3;   // 太陽正位=大吉
      if(c.id===21&&c.isUp)weightedSum+=3;   // 世界正位=圓滿
      if(c.id===10&&c.isUp)weightedSum+=2;   // 命運之輪正位=好轉
      if(c.id===17&&c.isUp)weightedSum+=2;   // 星星正位=希望
      if(c.id===6&&c.isUp)weightedSum+=1.5;  // 戀人正位（愛情加分）
      if(c.id===16&&c.isUp)weightedSum-=2.5; // 塔正位=崩塌
      if(c.id===15&&c.isUp)weightedSum-=2;   // 惡魔正位=束縛
      if(c.id===13&&c.isUp)weightedSum-=1;   // 死神正位=結束
      if(c.id===52&&c.isUp)weightedSum-=1.5; // 寶劍三正位=心碍
      if(c.id===58&&c.isUp)weightedSum-=1.5; // 寶劍九正位=焦慮
    });
    // Normalize: weightedSum / totalAbs → [-1,1] → map to [15,85]
    const normalized = weightedSum / (totalAbs||1);
    tarotScore=Math.round(50+normalized*50);
    tarotScore=Math.max(10,Math.min(90,tarotScore));
  }

  // ── 4. 紫微評分（命宮 + 類型宮位 加大幅度） ──
  let ziweiScore=40;
  if(S.ziwei){
    const mingStars=S.ziwei.palaces[0].stars;
    const goodStars=['紫微','天府','天同','天梁','天相','太陽','太陰','文昌','文曲','左輔','右弼'];
    const badStars=['擎羊','陀羅','火星','鈴星'];
    const neutralStars=['七殺','破軍','貪狼']; // 中性星看組合
    mingStars.forEach(s=>{
      if(goodStars.includes(s.name))ziweiScore+=7;
      if(badStars.includes(s.name))ziweiScore-=6;
      if(s.hua==='化祿')ziweiScore+=12;
      if(s.hua==='化權')ziweiScore+=8;
      if(s.hua==='化科')ziweiScore+=6;
      if(s.hua==='化忌')ziweiScore-=12;
      // 亮度加成
      if(s.brightness==='廟')ziweiScore+=4;
      else if(s.brightness==='旺')ziweiScore+=2;
      else if(s.brightness==='陷')ziweiScore-=5;
    });
    // 問題對應宮位（權重更高）
    const typeToGong={love:2,career:8,wealth:4,health:5,family:9,relationship:7};
    const gongIdx=typeToGong[type];
    if(gongIdx!==undefined&&S.ziwei.palaces[gongIdx]){
      const gongStars=S.ziwei.palaces[gongIdx].stars;
      gongStars.forEach(s=>{
        if(goodStars.includes(s.name))ziweiScore+=8;
        if(badStars.includes(s.name))ziweiScore-=7;
        if(s.hua==='化祿')ziweiScore+=15;
        if(s.hua==='化權')ziweiScore+=10;
        if(s.hua==='化科')ziweiScore+=8;
        if(s.hua==='化忌')ziweiScore-=15;
        if(s.brightness==='廟'||s.brightness==='旺')ziweiScore+=5;
        else if(s.brightness==='陷')ziweiScore-=6;
      });
      // 宮位無主星 = 偏弱
      if(!gongStars.some(s=>s.type==='major'))ziweiScore-=10;
    }
    ziweiScore=Math.max(8,Math.min(95,ziweiScore));
  }

  // ── 5. 姓名學評分 ──
  let nameScore=50;
  let nameResult=null;
  if(S.form.name&&S.form.name.length>=2){
    nameResult=analyzeName(S.form.name);
    if(nameResult){
      [nameResult.tianGe,nameResult.renGe,nameResult.diGe,nameResult.waiGe,nameResult.zongGe].forEach(g=>{
        if(g.fortune.level==='大吉')nameScore+=6;
        else if(g.fortune.level==='吉')nameScore+=3;
        else if(g.fortune.level==='凶')nameScore-=4;
      });
      if(nameResult.sanCaiLevel==='大吉')nameScore+=10;
      else if(nameResult.sanCaiLevel==='吉')nameScore+=5;
      else if(nameResult.sanCaiLevel==='凶')nameScore-=8;
      nameScore=Math.max(10,Math.min(90,nameScore));
    }
  }

  /* ══════════════════════════════════════════════════
     動態權重系統：依問題性質分配各維度影響力
     ──────────────────────────────────────────────────
     🧭 長期人生方向 → 八字 / 紫微（權重高）
     ⚡ 眼前抉擇     → 梅花 / 塔羅（權重高）
     🧠 狀態 / 混合  → 均衡，融合判斷
     姓名學永遠只做輔助（≤8%），因分數不隨問題變動
     ══════════════════════════════════════════════════ */

  // 問題時間維度判定
  const qText = S.form ? (S.form.question||'') : '';
  const isShortTerm = /這[個月週周]|今[天年月]|明[天年]|最近|馬上|眼前|立刻|短期|現在|下[個半]|近期/.test(qText);
  const isLongTerm = /一輩子|未來[35十]|長期|十年|人生|命運|天生|適合|方向|老了|退休|終身/.test(qText);
  const isDecision = /該不該|要不要|還是|選擇|決定|A或B|轉職|離職|分手|換工作|跳槽|卻.*還是|買.*還是/.test(qText);
  const isStatus = /為什麼|怎麼了|卡住|困境|狀況|卟因|瓶頸/.test(qText);

  let w;
  const hasMh = S.meihua ? 1 : 0;
  const hasTr = S.tarot.drawn.length >= 10 ? 1 : 0;
  const hasZw = S.ziwei ? 1 : 0;
  const hasNm = nameResult ? 1 : 0;

  if(isShortTerm || isDecision) {
    // ⚡ 短期 / 抉擇：梅花塔羅為主，八字紫微為輔
    w = {
      bazi:   0.15,
      meihua: hasMh ? 0.30 : 0,
      tarot:  hasTr ? 0.30 : 0,
      ziwei:  hasZw ? 0.12 : 0,
      name:   hasNm ? 0.05 : 0
    };
  } else if(isLongTerm) {
    // 🧭 長期人生方向：八字紫微為主
    w = {
      bazi:   0.35,
      meihua: hasMh ? 0.10 : 0,
      tarot:  hasTr ? 0.10 : 0,
      ziwei:  hasZw ? 0.30 : 0,
      name:   hasNm ? 0.08 : 0
    };
  } else if(isStatus) {
    // 🧠 狀態卡關：均衡但梅花塔羅略高（反映當下）
    w = {
      bazi:   0.22,
      meihua: hasMh ? 0.22 : 0,
      tarot:  hasTr ? 0.22 : 0,
      ziwei:  hasZw ? 0.18 : 0,
      name:   hasNm ? 0.06 : 0
    };
  } else {
    // 預設：均衡偏八字
    w = {
      bazi:   0.28,
      meihua: hasMh ? 0.20 : 0,
      tarot:  hasTr ? 0.20 : 0,
      ziwei:  hasZw ? 0.18 : 0,
      name:   hasNm ? 0.06 : 0
    };
  }

  // 類型微調
  if(type === 'love' && hasZw) w.ziwei += 0.05; // 愛情：紫微夫妻宮重要
  if(type === 'career' && hasZw) w.ziwei += 0.05;
  if(type === 'wealth') { w.meihua += hasMh ? 0.03 : 0; w.tarot += hasTr ? 0.03 : 0; }

  // 姓名學上限：不管怎樣不超過 8%
  if(w.name > 0.08) w.name = 0.08;

  const totalW = Object.values(w).reduce((a,b) => a+b, 0);
  const scores = {bazi:baziScore, meihua:mhScore, tarot:tarotScore, ziwei:ziweiScore, name:nameScore};
  // 異常值壓縮：若某維度與其他差距過大，壓縮其影響
  const activeKeys = Object.keys(w).filter(k => w[k] > 0);
  const sortedScores = activeKeys.map(k => scores[k]).sort((a,b) => a-b);
  const median = sortedScores[Math.floor(sortedScores.length/2)];
  const adjustedScores = {};
  activeKeys.forEach(k => {
    const diff = scores[k] - median;
    if(Math.abs(diff) > 30) {
      // 差距超過30分，壓縮1/3
      adjustedScores[k] = median + diff * 0.67;
    } else {
      adjustedScores[k] = scores[k];
    }
  });

  let finalProb = 0;
  for(const k of Object.keys(w)) finalProb += (adjustedScores[k] || scores[k]) * (w[k] / totalW);



  // 一致性放大
  const activeScores = Object.keys(w).filter(k => w[k] > 0).map(k => scores[k]);
  const highCount = activeScores.filter(s => s >= 58).length;
  const lowCount = activeScores.filter(s => s <= 42).length;
  const dimN = activeScores.length;
  if(highCount >= dimN) finalProb *= 1.20;
  else if(highCount >= dimN*0.75) finalProb *= 1.12;
  else if(lowCount >= dimN) finalProb *= 0.80;
  else if(lowCount >= dimN*0.75) finalProb *= 0.88;

  // 離心力放大
  const distFrom50 = finalProb - 50;
  finalProb = 50 + distFrom50 * 1.5;

  finalProb = Math.round(Math.max(8, Math.min(95, finalProb)));

  // 記錄權重供UI顯示
  const _wNorm = {};
  for(const k of Object.keys(w)) _wNorm[k] = w[k] > 0 ? Math.round(w[k] / totalW * 100) : 0;

  // ── Verdict（6級判定） ──
  let vlabel,vnote;
  if(finalProb>=78){vlabel='大吉・強烈推薦 ✅';vnote='五維度高度一致看好，是難得的好時機，積極行動！'}
  else if(finalProb>=65){vlabel='偏吉・可積極捨進 👍';vnote='多數指標偏正面，建議把握機會但注意風捧。'}
  else if(finalProb>=52){vlabel='中性偏可行 ⚖️';vnote='有利與阻力並存；照建議調整做法，勝率會上升。'}
  else if(finalProb>=40){vlabel='中性偏保守 🤔';vnote='指標偏中性偏弱，建議先觀察、做小範圍測試。'}
  else if(finalProb>=25){vlabel='偏凶・建議暫緩 ⚠️';vnote='阻力訊號較多，目前不是好時機，先做準備。'}
  else{vlabel='大凶・強烈建議暫停 ⛔';vnote='幾乍所有指標都亮紅燈，硬捨風險極高。'}

  document.getElementById('r-vlabel').textContent=vlabel;
  document.getElementById('r-vprob').textContent=finalProb+'%';
  document.getElementById('r-vnote').textContent=vnote;
  document.getElementById('r-pfill').style.width=finalProb+'%';
  document.getElementById('r-question').innerHTML=`<strong>問題：</strong>${question}<br><span class="tag tag-gold">${getTypeLabel(type)}</span>${(S.form.btime===''||!document.getElementById('f-btime')?.value)?'<br><span class="text-xs" style="color:var(--c-warn)"><i class="fas fa-exclamation-triangle"></i> 出生時間未填，以 12:00 估算，時柱及部分判定準確度降低</span>':''}`;

  // ── Answer ──
  const answer=generateAnswer(type,finalProb,b,S.meihua,S.tarot);
  document.getElementById('r-answer').innerHTML=answer.text;
  document.getElementById('r-factors').innerHTML=answer.factors?`<div class="detail-toggle-wrap" style="margin-top:.5rem"><div class="detail-toggle-btn" onclick="this.parentElement.classList.toggle('open')" style="cursor:pointer;display:flex;align-items:center;gap:.5rem;color:var(--c-text-dim);font-size:.85rem;padding:.3rem 0"><i class="fas fa-chevron-right" style="font-size:.7rem;transition:transform .3s"></i><span>影響因子（${answer.factors.length}項）</span></div><div class="detail-toggle-body" style="max-height:0;overflow:hidden;transition:max-height .4s ease"><ul class="text-sm" style="padding:.5rem 1.2rem;color:var(--c-text-dim)">${answer.factors.map(f=>'<li style="margin:.3rem 0">'+f+'</li>').join('')}</ul></div></div>`:'';
  document.getElementById('r-suggest').innerHTML=answer.suggestions?`<h4 class="text-gold serif mt-md mb-sm">行動建議</h4><ol class="text-sm" style="padding-left:1.2rem;color:var(--c-text-dim)">${answer.suggestions.map(s=>'<li style="margin:.3rem 0">'+s+'</li>').join('')}</ol>`:'';

  // ── Breakdown ──
  const dimLabels={bazi:'八字命理',meihua:'梅花易數',tarot:'塔羅牌陣',ziwei:'紫微斗數',name:'姓名學'};
  const weightHint = isShortTerm?'⚡ 短期問題：梅花/塔羅為主' : isLongTerm?'🧭 長期方向：八字/紫微為主' : isDecision?'⚡ 抉擇問題：梅花/塔羅為主' : isStatus?'🧠 狀態分析：均衡判斷' : '均衡模式';
  document.getElementById('r-pbreak').innerHTML=
    `<p class="text-xs text-dim mb-sm">${weightHint}</p>`+
    Object.keys(w).filter(k=>w[k]>0).map(k=>
    `<div class="el-row"><span class="el-lbl text-sm">${dimLabels[k]}</span><div class="el-track"><div class="el-fill" style="width:${scores[k]}%;background:var(--c-gold)"></div></div><span class="el-val">${scores[k]}%<span class="text-xs text-muted"> (${_wNorm[k]}%)</span></span></div>`
  ).join('');

  // ── Crystal ──
  if(typeof renderProductCrystal==='function')renderProductCrystal(b,type);
  else renderCrystalExpanded(b,type);

  // ── Remedy Alert + Plan ──
  try{renderRemedy(b,type);}catch(e){console.error('renderRemedy:',e);}

  // ── Conclusion ──
  let concl=generateConclusion(type,finalProb,b,S.meihua,S.tarot);
  // 加入紫微
  if(S.ziwei){
    const mp=S.ziwei.palaces[0];
    const ms=mp.stars.filter(s=>s.type==='major').map(s=>s.name).join('、');
    if(ms)concl+=`<p class="mt-sm">紫微命宮主星：${ms}，${ziweiScore>=60?'命格偏向有利':'需注意相關宮位挑戰'}。</p>`;
  }
  // 加入姓名學
  if(nameResult){
    concl+=`<p class="mt-sm">姓名學：三才 ${nameResult.sanCai.join('→')}（${nameResult.sanCaiLevel}），人格${nameResult.renGe.num}（${nameResult.renGe.fortune.level}）。</p>`;
  }
  document.getElementById('r-conclusion').innerHTML=concl;
}

// Override runAnalysis to use V2
function runAnalysis(){
  try{
    const rxEl=document.getElementById('rx-date');
    if(rxEl){const d=new Date();rxEl.textContent=d.getFullYear()+'/'+(d.getMonth()+1)+'/'+d.getDate();}
    /* 在 CTA 區塊顯示真實買家評價 */
    try{
      if(typeof REVIEWS!=='undefined'&&REVIEWS.length){
        const r=REVIEWS[Math.floor(Math.random()*REVIEWS.length)];
        const metaEl=document.getElementById('shop-review-meta');
        const textEl=document.getElementById('shop-review-text');
        const prodEl=document.getElementById('shop-review-product');
        if(metaEl)metaEl.textContent=r.name+' · '+r.time;
        if(textEl)textEl.textContent=r.text;
        if(prodEl)prodEl.textContent='購買：'+r.crystal;
      }
    }catch(e){}
    runAnalysisV2();
  }catch(e){
    console.error('runAnalysis error:', e);
    document.getElementById('r-vlabel').textContent='分析出錯: '+e.message;
    document.getElementById('r-vprob').textContent='—';
    alert('分析出錯：' + e.message + '\n' + e.stack);
  }
}

function renderName(){
  const el=document.getElementById('d-name');
  if(!S.form.name||S.form.name.length<2){el.innerHTML='<p class="text-dim">未輸入姓名，無法進行姓名學分析。</p>';return}
  const r=analyzeName(S.form.name);
  if(!r){el.innerHTML='<p class="text-dim">姓名格式不支援（需2-4個字）。</p>';return}

  const geData=[
    {label:'天格',data:r.tianGe,desc:'先天運，姓氏決定'},
    {label:'人格',data:r.renGe,desc:'主運，影響中年'},
    {label:'地格',data:r.diGe,desc:'前運，影響青年'},
    {label:'外格',data:r.waiGe,desc:'副運，人際關係'},
    {label:'總格',data:r.zongGe,desc:'後運，影響晚年'}
  ];

  el.innerHTML=`
    <p class="mb-md">姓名：<strong class="text-gold serif">${r.name}</strong> ｜ 筆畫：${r.strokes.join('、')}</p>
    <div class="bazi-grid" style="grid-template-columns:repeat(5,1fr);margin:var(--sp-md) 0">
      ${geData.map(g=>`<div class="bazi-cell header">${g.label}</div>`).join('')}
      ${geData.map(g=>`<div class="bazi-cell">
        <span class="gz">${g.data.num}</span>
        <span class="el-tag el-${g.data.el}">${g.data.el}</span>
        <div class="gz-sub ${g.data.fortune.cls}">${g.data.fortune.level}</div>
      </div>`).join('')}
      ${geData.map(g=>`<div class="bazi-cell"><div class="gz-sub">${g.desc}</div></div>`).join('')}
    </div>
    <div class="mt-md">
      <p><strong>三才配置：</strong>${r.sanCai.join(' → ')} <span class="tag ${r.sanCaiLevel.includes('吉')?'tag-green':r.sanCaiLevel==='凶'?'tag-red':'tag-gold'}">${r.sanCaiLevel}</span></p>
      <p class="text-sm text-dim mt-sm">三才代表天格→人格→地格的五行流通關係，${r.sanCaiLevel.includes('吉')?'相生相助為佳象':'存在相剋，需注意健康與人際'}。</p>
    </div>`;
}
/* =============================================================
   ENHANCEMENT 1: 流年詳細展開（點擊大運展開10流年）
   ============================================================= */
function renderDayunEnhanced(){
  const b=S.bazi; if(!b)return;
  let html='<div class="dayun-tl">';
  b.dayun.forEach((d,i)=>{
    const lvCls=d.level==='大吉'?'lv-dj':d.level==='中吉'?'lv-zj':d.level==='小吉'?'lv-xj':d.level==='平'?'lv-p':d.level==='小凶'?'lv-xk':d.level==='中凶'?'lv-zk':'lv-dk';
    html+=`<div class="dy-item ${d.isCurrent?'current':''}" onclick="toggleLiuNian(${i})" title="點擊展開流年">
      <span class="dy-gz">${d.gz}</span><span class="dy-age">${d.ageStart}-${d.ageEnd}歲</span>
      <span class="dy-lv ${lvCls}">${d.level}</span><div class="gz-sub">${d.god}</div></div>`;
  });
  html+='</div>';
  html+='<div id="liunian-detail" class="mt-md hidden"></div>';
  document.getElementById('d-dayun').innerHTML=html;
}

function toggleLiuNian(dyIdx){
  const el=document.getElementById('liunian-detail');
  const b=S.bazi; if(!b||!b.dayun[dyIdx])return;
  const dy=b.dayun[dyIdx];
  if(el.dataset.openIdx===String(dyIdx)&&!el.classList.contains('hidden')){
    el.classList.add('hidden');return;
  }
  el.dataset.openIdx=dyIdx;
  el.classList.remove('hidden');
  const curYear=new Date().getFullYear();
  let html=`<div class="card" style="padding:var(--sp-md);margin:0"><div class="card-title text-sm"><i class="fas fa-calendar"></i> ${dy.gz}大運（${dy.ageStart}-${dy.ageEnd}歲）流年明細</div>`;
  // 紫微大限同期資訊
  if(S.ziwei&&S.ziwei.daXian){
    const matchDx=S.ziwei.daXian.find(dx=>dx.ageStart===dy.ageStart||(dy.ageStart>=dx.ageStart&&dy.ageStart<=dx.ageEnd));
    if(matchDx){
      html+=`<p style="font-size:.78rem;color:var(--c-gold);margin-bottom:8px">紫微大限同期：走「${matchDx.palaceName}」宮（${matchDx.level}）`;
      if(matchDx.stars.length) html+=`，主星${matchDx.stars.join('、')}`;
      if(matchDx.hua.length) html+=`。四化：${matchDx.hua.map(h=>h.star+h.hua+'入'+h.palace).join('、')}`;
      html+='</p>';
    }
  }
  html+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:4px">';
  dy.liuNian.forEach(ln=>{
    const isCur=ln.year===curYear;
    const cls=ln.level==='吉'?'tag-green':ln.level==='凶'?'tag-red':'tag-gold';
    // 紫微流年
    let zwLnTip='';
    if(S.ziwei&&S.ziwei.getLiuNianZw){
      try{const zwLn=S.ziwei.getLiuNianZw(ln.year);if(zwLn&&zwLn.mingPalace)zwLnTip=zwLn.mingPalace;}catch(e){}
    }
    html+=`<div style="padding:6px;border:1px solid ${isCur?'var(--c-gold)':'var(--c-border)'};border-radius:var(--r-sm);background:${isCur?'rgba(212,175,55,.08)':'var(--c-bg-card)'};font-size:.8rem;text-align:center">
      <strong>${ln.year}</strong><br>
      <span class="serif">${ln.gz}</span><br>
      <span class="el-tag el-${ln.el}">${ln.el}</span>
      <span class="tag ${cls}" style="font-size:.6rem">${ln.level}</span><br>
      <span class="text-xs text-muted">${ln.god}</span>
      ${zwLnTip?'<br><span style="font-size:.6rem;color:var(--c-dim)">紫微:'+zwLnTip+'</span>':''}
      ${isCur?'<br><span class="text-xs text-gold">← 今年</span>':''}
    </div>`;
  });
  html+='</div></div>';
  el.innerHTML=html;
}

/* =============================================================
   ENHANCEMENT 2: 梅花六爻爻辭（簡化版：本卦動爻爻辭）
   ============================================================= */
const YAO_CI={
  '乾為天':['潛龍勿用','見龍在田，利見大人','君子終日乾乾，夕惕若厲，無咎','或躍在淵，無咎','飛龍在天，利見大人','亢龍有悔'],
  '坤為地':['履霜，堅冰至','直方大，不習無不利','含章可貞，或從王事，無成有終','括囊，無咎無譽','黃裳，元吉','龍戰于野，其血玄黃'],
  '水雷屯':['磐桓，利居貞，利建侯','屯如邅如，乘馬班如，匪寇婚媾','即鹿無虞，惟入于林中，君子幾不如舍','乘馬班如，求婚媾，往吉無不利','屯其膏，小貞吉，大貞凶','乘馬班如，泣血漣如'],
  '山水蒙':['發蒙，利用刑人，用說桎梏，以往吝','包蒙吉，納婦吉，子克家','勿用取女，見金夫，不有躬，無攸利','困蒙，吝','童蒙，吉','擊蒙，不利為寇，利禦寇'],
  '水天需':['需于郊，利用恆，無咎','需于沙，小有言，終吉','需于泥，致寇至','需于血，出自穴','需于酒食，貞吉','入于穴，有不速之客三人來，敬之終吉'],
  '天水訟':['不永所事，小有言，終吉','不克訟，歸而逋，其邑人三百戶無眚','食舊德，貞厲，終吉；或從王事，無成','不克訟，復即命渝，安貞吉','訟，元吉','或錫之鞶帶，終朝三褫之'],
  '地水師':['師出以律，否臧凶','在師中吉，無咎，王三錫命','師或輿尸，凶','師左次，無咎','田有禽，利執言，無咎；長子帥師，弟子輿尸，貞凶','大君有命，開國承家，小人勿用'],
  '水地比':['有孚比之，無咎；有孚盈缶，終來有它吉','比之自內，貞吉','比之匪人','外比之，貞吉','顯比，王用三驅，失前禽，邑人不誡，吉','比之無首，凶'],
  '風天小畜':['復自道，何其咎，吉','牽復，吉','輿說輻，夫妻反目','有孚，血去惕出，無咎','有孚攣如，富以其鄰','既雨既處，尚德載，婦貞厲，月幾望，君子征凶'],
  '天澤履':['素履，往無咎','履道坦坦，幽人貞吉','眇能視，跛能履，履虎尾，咥人凶，武人為于大君','履虎尾，愬愬，終吉','夬履，貞厲','視履考祥，其旋元吉'],
  '地天泰':['拔茅茹，以其彙，征吉','包荒，用馮河，不遐遺','無平不陂，無往不復，艱貞無咎','翩翩不富，以其鄰，不戒以孚','帝乙歸妹，以祉元吉','城復于隍，勿用師，自邑告命'],
  '天地否':['拔茅茹，以其彙，貞吉亨','包承，小人吉，大人否亨','包羞','有命無咎，疇離祉','休否，大人吉','傾否，先否後喜'],
  '天火同人':['同人于門，無咎','同人于宗，吝','伏戎于莽，升其高陵，三歲不興','乘其墉，弗克攻，吉','同人先號咷而後笑，大師克相遇','同人于郊，無悔'],
  '火天大有':['無交害，匪咎，艱則無咎','大車以載，有攸往，無咎','公用亨于天子，小人弗克','匪其彭，無咎','厥孚交如，威如，吉','自天祐之，吉無不利'],
  '地山謙':['謙謙君子，用涉大川，吉','鳴謙，貞吉','勞謙，君子有終，吉','無不利，撝謙','不富以其鄰，利用侵伐，無不利','鳴謙，利用行師，征邑國'],
  '雷地豫':['鳴豫，凶','介于石，不終日，貞吉','盱豫，悔，遲有悔','由豫，大有得，勿疑朋盍簪','貞疾，恆不死','冥豫，成有渝，無咎'],
  '澤雷隨':['官有渝，貞吉，出門交有功','係小子，失丈夫','係丈夫，失小子，隨有求得，利居貞','隨有獲，貞凶，有孚在道，以明，何咎','孚于嘉，吉','拘係之，乃從維之，王用亨于西山'],
  '山風蠱':['幹父之蠱，有子，考無咎，厲終吉','幹母之蠱，不可貞','幹父之蠱，小有悔，無大咎','裕父之蠱，往見吝','幹父之蠱，用譽','不事王侯，高尚其事'],
  '地澤臨':['咸臨，貞吉','咸臨，吉無不利','甘臨，無攸利，既憂之，無咎','至臨，無咎','知臨，大君之宜，吉','敦臨，吉，無咎'],
  '風地觀':['童觀，小人無咎，君子吝','闚觀，利女貞','觀我生，進退','觀國之光，利用賓于王','觀我生，君子無咎','觀其生，君子無咎'],
  '火雷噬嗑':['屨校滅趾，無咎','噬膚滅鼻，無咎','噬臘肉，遇毒，小吝無咎','噬乾胏，得金矢，利艱貞，吉','噬乾肉，得黃金，貞厲，無咎','何校滅耳，凶'],
  '山火賁':['賁其趾，舍車而徒','賁其須','賁如濡如，永貞吉','賁如皤如，白馬翰如，匪寇婚媾','賁于丘園，束帛戔戔，吝，終吉','白賁，無咎'],
  '山地剝':['剝床以足，蔑貞凶','剝床以辨，蔑貞凶','剝之，無咎','剝床以膚，凶','貫魚，以宮人寵，無不利','碩果不食，君子得輿，小人剝廬'],
  '地雷復':['不遠復，無祗悔，元吉','休復，吉','頻復，厲，無咎','中行獨復','敦復，無悔','迷復，凶，有災眚，用行師終有大敗'],
  '天雷無妄':['無妄，往吉','不耕獲，不菑畬，則利有攸往','無妄之災，或繫之牛，行人之得，邑人之災','可貞，無咎','無妄之疾，勿藥有喜','無妄行，有眚，無攸利'],
  '山天大畜':['有厲，利已','輿說輹','良馬逐，利艱貞，曰閑輿衛，利有攸往','童牛之牿，元吉','豶豕之牙，吉','何天之衢，亨'],
  '山雷頤':['舍爾靈龜，觀我朵頤，凶','顛頤，拂經，于丘頤，征凶','拂頤，貞凶，十年勿用，無攸利','顛頤，吉，虎視眈眈，其欲逐逐，無咎','拂經，居貞吉，不可涉大川','由頤，厲吉，利涉大川'],
  '澤風大過':['藉用白茅，無咎','枯楊生稊，老夫得其女妻，無不利','棟橈，凶','棟隆，吉，有它吝','枯楊生華，老婦得其士夫，無咎無譽','過涉滅頂，凶，無咎'],
  '坎為水':['習坎，入于坎窞，凶','坎有險，求小得','來之坎坎，險且枕，入于坎窞，勿用','樽酒簋貳，用缶，納約自牖，終無咎','坎不盈，祗既平，無咎','係用徽纆，寘于叢棘，三歲不得，凶'],
  '離為火':['履錯然，敬之無咎','黃離，元吉','日昃之離，不鼓缶而歌，則大耋之嗟，凶','突如其來如，焚如，死如，棄如','出涕沱若，戚嗟若，吉','王用出征，有嘉折首，獲匪其醜，無咎'],
  '澤山咸':['咸其拇','咸其腓，凶，居吉','咸其股，執其隨，往吝','貞吉悔亡，憧憧往來，朋從爾思','咸其脢，無悔','咸其輔頰舌'],
  '雷風恆':['浚恆，貞凶，無攸利','悔亡','不恆其德，或承之羞，貞吝','田無禽','恆其德，貞，婦人吉，夫子凶','振恆，凶'],
  '天山遁':['遁尾，厲，勿用有攸往','執之用黃牛之革，莫之勝說','係遁，有疾厲，畜臣妾吉','好遁，君子吉，小人否','嘉遁，貞吉','肥遁，無不利'],
  '雷天大壯':['壯于趾，征凶，有孚','貞吉','小人用壯，君子用罔，貞厲，羝羊觸藩，羸其角','貞吉悔亡，藩決不羸，壯于大輿之輹','喪羊于易，無悔','羝羊觸藩，不能退，不能遂，無攸利，艱則吉'],
  '火地晉':['晉如摧如，貞吉，罔孚裕，無咎','晉如愁如，貞吉，受茲介福于其王母','眾允，悔亡','晉如鼫鼠，貞厲','悔亡，失得勿恤，往吉，無不利','晉其角，維用伐邑，厲吉無咎，貞吝'],
  '地火明夷':['明夷于飛，垂其翼，君子于行，三日不食','明夷，夷于左股，用拯馬壯，吉','明夷于南狩，得其大首，不可疾貞','入于左腹，獲明夷之心，于出門庭','箕子之明夷，利貞','不明晦，初登于天，後入于地'],
  '風火家人':['閑有家，悔亡','無攸遂，在中饋，貞吉','家人嗃嗃，悔厲吉，婦子嘻嘻，終吝','富家，大吉','王假有家，勿恤吉','有孚威如，終吉'],
  '火澤睽':['悔亡，喪馬勿逐自復，見惡人無咎','遇主于巷，無咎','見輿曳，其牛掣，其人天且劓，無初有終','睽孤，遇元夫，交孚，厲無咎','悔亡，厥宗噬膚，往何咎','睽孤，見豕負塗，載鬼一車，先張之弧後說之弧，匪寇婚媾'],
  '水山蹇':['往蹇，來譽','王臣蹇蹇，匪躬之故','往蹇來反','往蹇來連','大蹇，朋來','往蹇來碩，吉，利見大人'],
  '雷水解':['無咎','田獲三狐，得黃矢，貞吉','負且乘，致寇至，貞吝','解而拇，朋至斯孚','君子維有解，吉，有孚于小人','公用射隼于高墉之上，獲之，無不利'],
  '山澤損':['已事遄往，無咎，酌損之','利貞，征凶，弗損益之','三人行則損一人，一人行則得其友','損其疾，使遄有喜，無咎','或益之十朋之龜弗克違，元吉','弗損益之，無咎，貞吉，利有攸往'],
  '風雷益':['利用為大作，元吉，無咎','或益之十朋之龜弗克違，永貞吉','益之用凶事，無咎，有孚中行，告公用圭','中行告公從，利用為依遷國','有孚惠心，勿問元吉，有孚惠我德','莫益之，或擊之，立心勿恆，凶'],
  '澤天夬':['壯于前趾，往不勝為咎','惕號，莫夜有戎，勿恤','壯于頄，有凶，君子夬夬獨行遇雨若濡有慍無咎','臀無膚，其行次且，牽羊悔亡，聞言不信','莧陸夬夬，中行無咎','無號，終有凶'],
  '天風姤':['繫于金柅，貞吉，有攸往，見凶','包有魚，無咎，不利賓','臀無膚，其行次且，厲，無大咎','包無魚，起凶','以杞包瓜，含章，有隕自天','姤其角，吝，無咎'],
  '澤地萃':['有孚不終，乃亂乃萃，若號，一握為笑，勿恤，往無咎','引吉，無咎，孚乃利用禴','萃如嗟如，無攸利，往無咎，小吝','大吉無咎','萃有位，無咎，匪孚，元永貞，悔亡','齎咨涕洟，無咎'],
  '地風升':['允升，大吉','孚乃利用禴，無咎','升虛邑','王用亨于岐山，吉無咎','貞吉，升階','冥升，利于不息之貞'],
  '澤水困':['臀困于株木，入于幽谷，三歲不覿','困于酒食，朱紱方來，利用享祀','困于石，據于蒺藜，入于其宮，不見其妻，凶','來徐徐，困于金車，吝，有終','劓刖，困于赤紱，乃徐有說，利用祭祀','困于葛藟，于臲卼，曰動悔有悔，征吉'],
  '水風井':['井泥不食，舊井無禽','井谷射鮒，甕敝漏','井渫不食，為我心惻，可用汲，王明並受其福','井甃，無咎','井冽，寒泉食','井收勿幕，有孚元吉'],
  '澤火革':['鞏用黃牛之革','已日乃革之，征吉，無咎','征凶，貞厲，革言三就，有孚','悔亡，有孚改命，吉','大人虎變，未占有孚','君子豹變，小人革面，征凶，居貞吉'],
  '火風鼎':['鼎顛趾，利出否，得妾以其子，無咎','鼎有實，我仇有疾，不我能即，吉','鼎耳革，其行塞，雉膏不食，方雨虧悔，終吉','鼎折足，覆公餗，其形渥，凶','鼎黃耳金鉉，利貞','鼎玉鉉，大吉，無不利'],
  '震為雷':['震來虩虩，後笑言啞啞，吉','震來厲，億喪貝，躋于九陵，勿逐，七日得','震蘇蘇，震行無眚','震遂泥','震往來厲，億無喪，有事','震索索，視矍矍，征凶，震不于其躬，于其鄰，無咎'],
  '艮為山':['艮其趾，無咎，利永貞','艮其腓，不拯其隨，其心不快','艮其限，列其夤，厲薰心','艮其身，無咎','艮其輔，言有序，悔亡','敦艮，吉'],
  '風山漸':['鴻漸于干，小子厲有言，無咎','鴻漸于磐，飲食衎衎，吉','鴻漸于陸，夫征不復，婦孕不育，凶，利禦寇','鴻漸于木，或得其桷，無咎','鴻漸于陵，婦三歲不孕，終莫之勝，吉','鴻漸于逵，其羽可用為儀，吉'],
  '雷澤歸妹':['歸妹以娣，跛能履，征吉','眇能視，利幽人之貞','歸妹以須，反歸以娣','歸妹愆期，遲歸有時','帝乙歸妹，其君之袂不如其娣之袂良，月幾望，吉','女承筐無實，士刲羊無血，無攸利'],
  '雷火豐':['遇其配主，雖旬無咎，往有尚','豐其蔀，日中見斗，往得疑疾，有孚發若，吉','豐其沛，日中見沬，折其右肱，無咎','豐其蔀，日中見斗，遇其夷主，吉','來章，有慶譽，吉','豐其屋，蔀其家，闚其戶，闃其無人，三歲不覿，凶'],
  '火山旅':['旅瑣瑣，斯其所取災','旅即次，懷其資，得童僕貞','旅焚其次，喪其童僕，貞厲','旅于處，得其資斧，我心不快','射雉一矢亡，終以譽命','鳥焚其巢，旅人先笑後號咷，喪牛于易，凶'],
  '巽為風':['進退，利武人之貞','巽在床下，用史巫紛若，吉，無咎','頻巽，吝','悔亡，田獲三品','貞吉悔亡，無不利，無初有終','巽在床下，喪其資斧，貞凶'],
  '兌為澤':['和兌，吉','孚兌，吉，悔亡','來兌，凶','商兌，未寧，介疾有喜','孚于剝，有厲','引兌'],
  '風水渙':['用拯馬壯，吉','渙奔其機，悔亡','渙其躬，無悔','渙其群，元吉，渙有丘，匪夷所思','渙汗其大號，渙王居，無咎','渙其血，去逖出，無咎'],
  '水澤節':['不出戶庭，無咎','不出門庭，凶','不節若，則嗟若，無咎','安節，亨','甘節，吉，往有尚','苦節，貞凶，悔亡'],
  '風澤中孚':['虞吉，有它不燕','鶴鳴在陰，其子和之，我有好爵，吾與爾靡之','得敵，或鼓或罷，或泣或歌','月幾望，馬匹亡，無咎','有孚攣如，無咎','翰音登于天，貞凶'],
  '雷山小過':['飛鳥以凶','過其祖，遇其妣，不及其君，遇其臣，無咎','弗過防之，從或戕之，凶','無咎，弗過遇之，往厲必戒，勿用永貞','密雲不雨，自我西郊，公弋取彼在穴','弗遇過之，飛鳥離之，凶，是謂災眚'],
  '水火既濟':['曳其輪，濡其尾，無咎','婦喪其茀，勿逐，七日得','高宗伐鬼方，三年克之，小人勿用','繻有衣袽，終日戒','東鄰殺牛，不如西鄰之禴祭，實受其福','濡其首，厲'],
  '火水未濟':['濡其尾，吝','曳其輪，貞吉','未濟征凶，利涉大川','貞吉悔亡，震用伐鬼方，三年有賞于大國','貞吉無悔，君子之光，有孚吉','有孚于飲酒，無咎，濡其首，有孚失是']
};

function getYaoCi(guaName, yaoNum){
  const ci=YAO_CI[guaName];
  if(ci&&ci[yaoNum-1])return ci[yaoNum-1];
  return'（爻辭資料庫擴充中）';
}

/* =============================================================
   ENHANCEMENT 3: 塔羅問題類型交叉解讀
   ============================================================= */
const TAROT_TYPE_MEANING={
  love:{
    0:{up:'愛情需要勇氣踏出舒適圈，新戀情可能從意想不到的地方開始。',rv:'感情上太隨性，需認真對待每段關係。'},
    1:{up:'你有吸引力和魅力，善用溝通技巧捨進感情。',rv:'感情中有隱藏或欺騙，需坦誠相待。'},
    2:{up:'傾聽內心直覺，對方可能還沒完全表露心意。',rv:'過於封閉自我，錯過感情訊號。'},
    3:{up:'感情進入豐收期，充滿滋養與溫暖。',rv:'過度依賴對方，需要獨立空間。'},
    4:{up:'關係中需要穩定與承諾，適合談婚論嫁。',rv:'控制欲太強讓對方窒息。'},
    5:{up:'傳統價值觀的結合，可能有長輩介紹的緣分。',rv:'觀念太保守，錯失新型態的愛。'},
    6:{up:'真愛降臨，重要的感情抉擇帶來幸福。',rv:'感情價值觀衝突，需深度溝通。'},
    7:{up:'主動追求愛情，決心讓感情快速前進。',rv:'太急躁，給對方太多壓力。'},
    8:{up:'用耐心和溫柔經營，以柔克剛化解問題。',rv:'感情中缺乏安全感。'},
    9:{up:'需要獨處反思這段感情是否適合自己。',rv:'過度孤立自己，拒絕敞開心扉。'},
    10:{up:'感情命運之輪轉動，緣分即將到來。',rv:'感情進入瓶頸期。'},
    11:{up:'公平對待彼此，因果回報正面。',rv:'感情中有不公平的付出。'},
    12:{up:'為愛付出和等待，換個角度看待關係。',rv:'不必要的犧牲，對方不值得。'},
    13:{up:'舊感情結束，新的愛情破繭而出。',rv:'不願放手舊情，停滯不前。'},
    14:{up:'感情需要平衡和包容，調和彼此差異。',rv:'感情失衡，一方付出太多。'},
    15:{up:'警惕不健康的感情依附或誘惑。',rv:'擺脫不良關係，重獲自由。'},
    16:{up:'感情出現突變，卟有認知被顛覆。',rv:'避開感情衝擊，危機可化解。'},
    17:{up:'愛情中的希望之星，值得期待的未來。',rv:'對感情失卻信心。'},
    18:{up:'感情中有隱藏的不安，需要勇氣面對。',rv:'迷霧散卻，感情真相浮現。'},
    19:{up:'感情明朗化，關係進入甜蜜光明期。',rv:'暫時的陰霾，但終會過去。'},
    20:{up:'重新審視感情觀，靈魂層面的覺醒。',rv:'拒絕成長讓關係退步。'},
    21:{up:'感情圓滿，找到命中注定的人。',rv:'感情尚缺最後一步才能完碧。'},
    36:{up:'新的感情萌芽，情感豐沛。',rv:'感情封閉，錯過真心。'},
    37:{up:'雙方互相吸引，關係進入甜蜜期。',rv:'感情失衡，溝通出問題。'},
    44:{up:'感情願望實現，心滿意足。',rv:'不滿足現有的感情。'},
    45:{up:'家庭幸福、感情圓滿的象徵。',rv:'家庭問題影響感情。'}
  },
  career:{
    0:{up:'事業上勇於嘗試新領域，創業契機浮現。',rv:'職場決策太草率，需更多規劃。'},
    1:{up:'擁有成功所需的全部資源和能力。',rv:'技能需精進，避免眼高手位。'},
    2:{up:'職場直覺準確，適合等待更好的機會。',rv:'職場過於被動。'},
    3:{up:'事業豐收期，創造力旺盛適合擴展。',rv:'過度依賴團隊。'},
    4:{up:'獲得權威地位，適合管理與決策。',rv:'控制欲太強，需學會捈權。'},
    5:{up:'遵循組織規範，向前輩/對師請教。',rv:'太死板，需要創新突破。'},
    6:{up:'面臨重要的職業選擇。',rv:'職場人際關係有衝突。'},
    7:{up:'事業突破，靠堅定意志克服困難。',rv:'工作方向不明。'},
    8:{up:'耐心處理職場挑戰，以智取勝。',rv:'缺乏自信影響表現。'},
    9:{up:'需要獨立思考職涯方向。',rv:'過度孤立錯失合作機會。'},
    10:{up:'事業迍來轉折點，好運降臨。',rv:'事業遇瓶頸，耐心等待。'},
    11:{up:'公正的工作評價，努力有回報。',rv:'遭受不公平對待。'},
    13:{up:'舊工作結束迍接新機會，轉型期。',rv:'抗拒職場變化。'},
    16:{up:'現有工作架構崩塌，被迫重建。',rv:'成功避開職場危機。'},
    19:{up:'事業光明，獲得認可與成就。',rv:'暫時的位潮期。'},
    21:{up:'事業達成里程碑，圓滿隍段性目標。',rv:'尚差最後一步努力。'},
    22:{up:'新項目啟動，充滿創造能量。',rv:'項目延遲啟動。'},
    35:{up:'展現領導力，帶領團隊前進。',rv:'領導風格需調整。'},
    64:{up:'新的財務機會出現，升職加薪有望。',rv:'機會錯失，需提高警覺。'},
    71:{up:'精進技藝的時期，專注帶來成果。',rv:'對工作缺乏熱情。'}
  },
  wealth:{
    0:{up:'意外之財的可能，新的財路打開。',rv:'衝動消費，財務失捧。'},
    1:{up:'善用手邊資源創造財富。',rv:'理財方式需要改進。'},
    3:{up:'財運豐饒，投資回報良好。',rv:'花費過度，需要節制。'},
    9:{up:'深思熟慮的財務決定帶來穩健收益。',rv:'投資判斷力下降。'},
    10:{up:'財運轉折，可能有意外收入。',rv:'財運位迷期。'},
    14:{up:'理財需要平衡，不宜偏重單一投資。',rv:'財務失衡，支出大於收入。'},
    15:{up:'小心物質誘惑和高風險投機。',rv:'擺脫不良的消費習慣。'},
    19:{up:'財運亨通，投資回報明顯。',rv:'短期財務壓力。'},
    21:{up:'財務目標達成，圓滿豐收。',rv:'收入不穩定。'},
    64:{up:'新的賺錢機會，財富種子萌發。',rv:'錯過投資良機。'},
    67:{up:'守財有道，財務安全感強。',rv:'過度吝嗇。'},
    72:{up:'財務自由的象徵，豐衣足食。',rv:'過度自滿對致風險。'},
    73:{up:'家族財富累積，長期穩定。',rv:'家庭財務有隱患。'}
  },
  health:{
    4:{up:'身體狀況穩定，規律生活有益。',rv:'壓力過大影響健康。'},
    8:{up:'身心調和，內在力量幫助恢復。',rv:'缺乏信心影響康復。'},
    14:{up:'保持身心平衡是健康關鍵。',rv:'生活失衡影響身心。'},
    17:{up:'健康好轉，充滿希望。',rv:'健康狀況需持續關注。'},
    19:{up:'身心能量充沛，健康狀態良好。',rv:'需注意過度消耗。'},
    53:{up:'身體需要休息，不要硬撐。',rv:'太焦躁，影響恢復。'},
    55:{up:'健康正在改善，度遍位谷期。',rv:'健康恢復緩慢。'},
    58:{up:'焦慮影響睡眠和健康。',rv:'焦慮正在緩解。'}
  },
  relationship:{
    3:{up:'人際關係和諧，社交活躍。',rv:'人際圈過度消耗。'},
    6:{up:'重要的人際選擇，影響未來交友圈。',rv:'人際關係有衝突。'},
    11:{up:'人際互動公平，好人緣。',rv:'遭受不公對待。'},
    38:{up:'友誼歡樂，社交活動豐富。',rv:'過度社交對致疲憊。'},
    45:{up:'團隊和家庭關係圓滿。',rv:'人際紛爭。'},
    54:{up:'人際衝突需要面對和處理。',rv:'和解的可能性出現。'}
  }
};

function getTarotTypeMeaning(cardId, isUp, type){
  const tm=TAROT_TYPE_MEANING[type];
  if(tm&&tm[cardId]){
    return isUp?tm[cardId].up:tm[cardId].rv;
  }
  return null;
}

/* =============================================================
   ENHANCEMENT 4: 紫微亮度（廟旺利平陷）
   ============================================================= */
const ZW_BRIGHTNESS={
  // 簡化：紫微在各地支的廟旺（子丑寅卯辰巳午未申酉戌亥）
  '紫微':['廟','旺','得地','平','旺','得地','廟','旺','得地','平','得地','旺'],
  '天機':['平','廟','旺','廟','得地','平','陷','得地','旺','得地','平','廟'],
  '太陽':['陷','陷','平','旺','廟','廟','廟','旺','平','陷','陷','陷'],
  '武曲':['旺','廟','得地','陷','平','旺','得地','得地','廟','旺','得地','平'],
  '天同':['旺','平','陷','平','得地','得地','陷','平','得地','旺','廟','旺'],
  '廉貞':['得地','平','旺','陷','得地','平','得地','旺','廟','得地','平','旺'],
  '天府':['廟','得地','旺','得地','平','廟','旺','得地','旺','廟','得地','旺'],
  '太陰':['廟','廟','旺','旺','得地','平','陷','陷','陷','平','得地','旺'],
  '貪狼':['旺','平','廟','旺','得地','得地','陷','平','得地','旺','廟','旺'],
  '巨門':['旺','廟','得地','平','陷','旺','得地','平','廟','旺','得地','平'],
  '天相':['廟','得地','旺','旺','平','得地','旺','得地','廟','得地','旺','得地'],
  '天梁':['廟','旺','得地','平','得地','旺','廟','得地','旺','平','得地','旺'],
  '七殺':['廟','旺','平','得地','旺','得地','廟','得地','旺','平','得地','旺'],
  '破軍':['平','旺','廟','得地','旺','得地','平','旺','得地','旺','廟','得地']
};

function getStarBrightness(starName, zhiBranch){
  const idx=DZ.indexOf(zhiBranch);
  if(idx<0)return'';
  const arr=ZW_BRIGHTNESS[starName];
  if(!arr)return'';
  return arr[idx]||'';
}

/* =============================================================
   ENHANCEMENT 5: 增強 renderZiwei 加入亮度
   ============================================================= */
const _origRenderZiwei = renderZiwei;
renderZiwei = function(){
  _origRenderZiwei();
  // Post-process: add brightness tags
  if(!S.ziwei)return;
  S.ziwei.palaces.forEach(p=>{
    p.stars.forEach(s=>{
      if(s.type==='major'){
        s.brightness=getStarBrightness(s.name, p.branch);
      }
    });
  });
  // Re-render grid with brightness
  const zw=S.ziwei;
  const order=[[3,4,5,6],[2,-1,-1,7],[1,-1,-1,8],[0,11,10,9]];
  let html='<div class="zw-grid">';
  for(let row=0;row<4;row++){
    for(let col=0;col<4;col++){
      const idx=order[row][col];
      if(idx===-1){
        if(row===1&&col===1){
          html+=`<div class="zw-cell zw-center" style="grid-column:2/4;grid-row:2/4">
            <div class="serif text-gold" style="font-size:1.1rem;margin-bottom:var(--sp-sm)">紫微斗數</div>
            <p class="text-dim text-xs">命宮：${DZ[zw.mingIdx]}</p>
            <p class="text-dim text-xs">${zw.yGan}${zw.yZhi}年 ｜ ${zw.wuxingJu}局</p></div>`;
        }
        continue;
      }
      const palace=zw.palaces.find(p=>DZ.indexOf(p.branch)===idx);
      if(!palace){html+=`<div class="zw-cell"><span class="zw-palace">${DZ[idx]}</span></div>`;continue}
      const isMing=palace.isMing;
      html+=`<div class="zw-cell${isMing?' active-palace':''}">
        <div class="zw-palace">${palace.name}${isMing?' ⭐':''}</div>
        <div class="zw-branch">${palace.branch}</div><div class="zw-stars">`;
      palace.stars.forEach(s=>{
        const cls=s.type==='major'?'major':s.type==='sha'?'text-danger':'minor';
        const bright=s.brightness?`<span class="text-xs text-muted">(${s.brightness})</span>`:'';
        html+=`<span class="zw-star ${cls}">${s.name}${bright}</span>`;
        if(s.hua)html+=`<span class="zw-hua">${s.hua}</span>`;
      });
      html+=`</div></div>`;
    }
  }
  html+='</div>';
  document.getElementById('d-ziwei-grid').innerHTML=html;
};

/* =============================================================
   ENHANCEMENT 6: 增強 renderBazi 使用新大運
   ============================================================= */
const _origRenderBazi = renderBazi;
renderBazi = function(){
  _origRenderBazi();
  renderDayunEnhanced();
};

/* =============================================================
   ENHANCEMENT 7: 增強 renderTarot 加入類型交叉解讀
   ============================================================= */
const _origRenderTarot = renderTarot;
renderTarot = function(){
  if(!S.tarot.drawn.length){document.getElementById('r-tarot').innerHTML='<p class="text-dim">未進行塔羅抽牌</p>';return}
  const type=S.form.type;
  document.getElementById('r-tarot').innerHTML=S.tarot.drawn.map((c,i)=>{
    const typeMeaning=getTarotTypeMeaning(c.id,c.isUp,type);
    return`<div style="display:flex;gap:var(--sp-sm);align-items:flex-start;padding:var(--sp-sm) 0;border-bottom:1px solid var(--c-border)">
      <span class="tag tag-gold" style="flex:0 0 auto">${i+1}</span>
      <div><strong class="text-gold">${c.pos}</strong>：${c.n} <span class="tag ${c.isUp?'tag-blue':'tag-red'}">${c.isUp?'正':'逆'}</span>
      <p class="text-sm text-dim">${c.isUp?c.up:c.rv}</p>
      ${typeMeaning?`<p class="text-sm mt-sm" style="color:var(--c-gold-light)"><i class="fas fa-star" style="font-size:.6rem"></i> ${getTypeLabel(type)}解讀：${typeMeaning}</p>`:''}</div>
    </div>`;
  }).join('');
};

/* =============================================================
   ENHANCEMENT 8: 增強梅花結果加入爻辭
   ============================================================= */
const _origShowMH = showMH;
showMH = function(r){
  _origShowMH(r);
  // Append yao ci
  const yaoCi=getYaoCi(r.ben.n, r.dong);
  const detailEl=document.getElementById('mh-detail');
  if(detailEl){
    detailEl.innerHTML+=`<div class="divider"></div><p><strong>動爻爻辭（第${r.dong}爻）：</strong><span class="serif text-gold">${yaoCi}</span></p>`;
  }
};

/* =============================================================
   ENHANCEMENT 9: 列印 / 分享
   ============================================================= */
function printResult(){
  window.print();
}

function shareResult(){
  const prob=document.getElementById('r-vprob').textContent;
  const label=document.getElementById('r-vlabel').textContent;
  const text=`靜月之光占卜結果：${label} ${prob}\n問題：${S.form.question}\n\n（更多詳情請使用靜月之光能量占卜儀）`;
  if(navigator.share){
    navigator.share({title:'靜月之光占卜結果',text}).catch(()=>{});
  }else{
    navigator.clipboard.writeText(text).then(()=>alert('結果已複製到剪貼簿！')).catch(()=>{});
  }
  // Track share achievement
  if(typeof incrementAchievement==='function') incrementAchievement('shares',1);
}
/* =============================================================
   CUSTOM ORDER MODAL + FLOATING BUTTONS
   ============================================================= */
function openCustomModal(){
  document.getElementById('custom-modal').style.display='flex';
  document.getElementById('custom-form').style.display='block';
  document.getElementById('cf-sent').classList.add('hidden');
  // Pre-fill from analysis if available
  if(S.form.name)document.getElementById('cf-name').value=S.form.name;
  if(S.form.bdate)document.getElementById('cf-bday').value=S.form.bdate;
  if(S.form.question)document.getElementById('cf-question').value=S.form.question;
  document.body.style.overflow='hidden';
}
function closeCustomModal(){
  document.getElementById('custom-modal').style.display='none';
  document.body.style.overflow='';
}
// Close on overlay click
document.addEventListener('click',function(e){
  if(e.target.id==='custom-modal')closeCustomModal();
});

function submitCustomForm(e){e.preventDefault()} // deprecated, kept for safety

function prepareCustomSubmit(){
  const name=document.getElementById('cf-name').value.trim();
  if(!name)return false;

  // Set subject with name
  document.getElementById('cf-subject-hidden').value='【客製詢問】'+name+' - 能量手鏈';

  // Set _next to current page so user returns after submit
  document.getElementById('cf-next-url').value=window.location.href;

  // Build analysis summary
  let summary='';
  if(S.bazi){
    summary+='日主：'+S.bazi.dm+'（'+S.bazi.dmEl+'）| 身'+(S.bazi.strong?'強':'弱')+'\n';
    summary+='喜用神：'+S.bazi.fav.join('、')+'\n';
    summary+='忌神：'+S.bazi.unfav.join('、')+'\n';
    const curDy=S.bazi.dayun.find(d=>d.isCurrent);
    if(curDy)summary+='當前大運：'+curDy.gz+'（'+curDy.level+'）\n';
    if(S.bazi.shensha.length)summary+='神煞：'+S.bazi.shensha.join('、')+'\n';
    if(S.meihua)summary+='梅花：'+S.meihua.ben.n+'，體用'+S.meihua.ty.r+'（'+S.meihua.ty.f+'）\n';
    if(S.tarot.drawn.length)summary+='塔羅核心牌：'+S.tarot.drawn[0].n+'（'+(S.tarot.drawn[0].isUp?'正位':'逆位')+'）\n';
    const prob=document.getElementById('r-vprob');
    if(prob&&prob.textContent!=='0%')summary+='綜合機率：'+prob.textContent+'\n';
  }
  document.getElementById('cf-analysis-hidden').value=summary||'（使用者未完成占卜分析）';

  // Change button to loading
  const btn=document.getElementById('cf-submit-btn');
  btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> 送出中...';
  btn.disabled=true;

  return true; // allow form submission to formsubmit.co
}

function copyCfContent(){} // no longer needed but kept for safety

function toggleFab(){
  document.getElementById('fab-menu').classList.toggle('hidden');
}

/* =============================================================
   PWA: Inline Manifest + Service Worker Registration
   ============================================================= */
(function(){
  // Inline manifest as blob
  const manifest={
    name:'靜月之光能量占卜儀',
    short_name:'靜月占卜',
    description:'整合八字、紫微斗數、梅花易數、塔羅牌的多維度命理分析',
    start_url:'./',
    display:'standalone',
    background_color:'#0d0404',
    theme_color:'#0d0404',
    orientation:'portrait-primary',
    lang:'zh-TW',
    icons:[{src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">☽</text></svg>',sizes:'any',type:'image/svg+xml'}]
  };
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const link=document.createElement('link');
  link.rel='manifest';
  link.href=URL.createObjectURL(blob);
  document.head.appendChild(link);
})();

/* =============================================================
   KEYBOARD: Escape closes modal
   ============================================================= */
document.addEventListener('keydown',function(e){
  if(e.key==='Escape'){
    closeCustomModal();
    const fabMenu=document.getElementById('fab-menu');
    if(fabMenu&&!fabMenu.classList.contains('hidden'))fabMenu.classList.add('hidden');
  }
});
/* =============================================================
   FEATURE 1: 商品化水晶推薦（含賣場連結 + 商品類別）
   ============================================================= */
const PRODUCT_DB={
  金:[
    {n:'白水晶手鏈',cat:'手鏈',icon:'💍',el:'金',d:'淨化能量場，增強思維清晰度',price:'$580-$1,280',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'左手佩戴',img:''},
    {n:'鈦晶吊墜',cat:'吊墜',icon:'⚡',el:'金',d:'招正財偏財，增強領導氣魄',price:'$1,580-$3,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'貼近心輪佩戴',img:''},
    {n:'白水晶裸石',cat:'裸石',icon:'🔮',el:'金',d:'淨化空間磁場，鍮宅開運',price:'$380-$1,200',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放客廳或書桌',img:''}
  ],
  木:[
    {n:'綠幽靈手鏈',cat:'手鏈',icon:'💚',el:'木',d:'招正財，事業穩步上升',price:'$680-$2,200',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'左手佩戴',img:''},
    {n:'東陵玉吊墜',cat:'吊墜',icon:'🌿',el:'木',d:'舒緩壓力，帶來好運',price:'$480-$1,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'項鍊佩戴',img:''},
    {n:'翡翠裸石擺件',cat:'裸石',icon:'💎',el:'木',d:'護身辟邪，增強健康運',price:'$1,200-$5,000',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放書桌或財位',img:''}
  ],
  水:[
    {n:'海藍寶手鏈',cat:'手鏈',icon:'💙',el:'水',d:'增強溝通力，平靜情緒',price:'$780-$2,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'左手佩戴',img:''},
    {n:'月光石吊墜',cat:'吊墜',icon:'🌙',el:'水',d:'增強直覺，助感情運',price:'$580-$1,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'滿月佩戴更佳',img:''},
    {n:'藍紋瑪瑙裸石',cat:'裸石',icon:'🔵',el:'水',d:'穩定情緒，增強表達力',price:'$350-$980',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放臥室床頭',img:''}
  ],
  火:[
    {n:'紅瑪瑙手鏈',cat:'手鏈',icon:'❤️',el:'火',d:'激發熱情，增強行動力與勇氣',price:'$480-$1,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'右手佩戴增行動力',img:''},
    {n:'石榴石吊墜',cat:'吊墜',icon:'🔴',el:'火',d:'提升活力，增強桃花運',price:'$680-$2,200',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'貼身佩戴',img:''},
    {n:'紅碧璽裸石',cat:'裸石',icon:'💗',el:'火',d:'強力招桃花，增強人際魅力',price:'$1,500-$4,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放桃花位',img:''}
  ],
  土:[
    {n:'黃水晶手鏈',cat:'手鏈',icon:'💛',el:'土',d:'招偏財，提升自信與魅力',price:'$580-$1,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'左手佩戴',img:''},
    {n:'虎眼石吊墜',cat:'吊墜',icon:'🐅',el:'土',d:'增強決斷力，招財辟邪',price:'$480-$1,500',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'出門佩戴',img:''},
    {n:'茶晶裸石擺件',cat:'裸石',icon:'🍵',el:'土',d:'排除負能量，穩定心性',price:'$680-$2,800',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',
     wear:'放客廳',img:''}
  ]
};

// 問題類型特殊商品
const TYPE_PRODUCTS={
  love:[{n:'粉晶手鏈',cat:'手鏈',icon:'💕',el:'土',d:'招桃花首選！增強異性緣',price:'$480-$1,500',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'左手佩戴，約會必備'}],
  career:[{n:'鈦晶手鏈',cat:'手鏈',icon:'⚡',el:'金',d:'事業晉升首選！領導力UP',price:'$1,800-$5,000',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'面試/開會佩戴'}],
  wealth:[{n:'綠幽靈聚寶盆',cat:'裸石',icon:'💰',el:'木',d:'招正財偏財！放辦公桌超旺',price:'$1,200-$3,800',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'放財位或收銀台'}],
  health:[{n:'紫水晶手鏈',cat:'手鏈',icon:'💜',el:'火',d:'安神助眠，促進身心平衡',price:'$580-$1,800',shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232',wear:'睡前佩戴或放枕下'}]
};

function renderProductCrystal(bazi,type){
  const need=bazi.fav[0];
  const base=PRODUCT_DB[need]||PRODUCT_DB['土'];
  const special=TYPE_PRODUCTS[type]||[];
  const all=[...special,...base];
  const display=all.slice(0,4);

  const catIcon={手鏈:'⌚',吊墜:'📿',裸石:'💍',客製:'✨'};

  document.getElementById('r-crystal').innerHTML=`
    <div class="crystal-rec-header">
      <p>根據你的命盤（喜 <span class="tag tag-gold">${need}行</span>）和問題（<span class="tag tag-blue">${getTypeLabel(type)}</span>），為你配對：</p>
    </div>
    <div class="product-grid">${display.map(p=>`
      <div class="product-card">
        ${p.img?`<img class="product-img" src="${p.img}" alt="${p.n}" onerror="this.outerHTML=getCrystalVisual(${JSON.stringify({n:p.n,cat:p.cat}).replace(/"/g,'&quot;')})">`:(typeof getCrystalVisual==='function'?getCrystalVisual(p):`<div class="product-icon">${p.icon}</div>`)}
        <div class="product-body">
          <div class="product-name">${p.n}</div>
          <div class="product-meta">
            <span class="tag tag-gold text-xs">${catIcon[p.cat]||''} ${p.cat}</span>
            <span class="el-tag el-${p.el} text-xs">${p.el}行</span>
          </div>
          <p class="product-desc">${p.d}</p>
          <p class="product-price">${p.price}</p>
          <p class="product-wear"><i class="fas fa-hand-holding-heart"></i> ${p.wear}</p>
          <div class="product-actions">
            <a href="${p.shopee}" target="_blank" rel="noopener" class="product-btn shopee"><i class="fas fa-shopping-cart"></i> 蝦皮</a>
            <a href="${p.seven}" target="_blank" rel="noopener" class="product-btn seven"><i class="fas fa-box"></i> 7-11</a>
          </div>
        </div>
      </div>`).join('')}
    </div>
    <div class="custom-cta mt-lg">
      <button class="btn btn-gold btn-full" onclick="openCustomModal()">
        <i class="fas fa-magic"></i> 依你五行專屬搭配 ─ 點我客製
      </button>
      <p class="text-xs text-muted mt-sm text-center">預算版 $1,000 起 ｜ 48hr 內回覆</p>
    </div>
    <p class="text-xs text-muted mt-md text-center"><i class="fas fa-info-circle"></i> 本建議僅供能量校準參考，不具醫療或命運保證效力。</p>`;
}

/* =============================================================
   FEATURE 2: 結果圖卡 Canvas → 存圖（含 QR 對流）
   ============================================================= */
function generateResultCard(){
  const canvas=document.createElement('canvas');
  const W=750,H=1334; // IG story size
  canvas.width=W;canvas.height=H;
  const ctx=canvas.getContext('2d');

  // Background gradient
  const grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,'#2D0A0A');grad.addColorStop(0.5,'#4A0000');grad.addColorStop(1,'#0d0404');
  ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);

  // Decorative border
  ctx.strokeStyle='rgba(212,175,55,0.4)';ctx.lineWidth=3;
  ctx.strokeRect(24,24,W-48,H-48);
  ctx.strokeStyle='rgba(212,175,55,0.15)';ctx.lineWidth=1;
  ctx.strokeRect(36,36,W-72,H-72);

  // Header
  ctx.fillStyle='#D4AF37';ctx.font='bold 32px "Noto Serif TC",serif';ctx.textAlign='center';
  ctx.fillText('☽ 靜月之光能量占卜儀',W/2,80);
  ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.6)';
  ctx.fillText('你的專屬命理分析結果',W/2,115);

  // Divider
  drawGoldLine(ctx,60,140,W-60);

  // Question
  ctx.textAlign='left';ctx.font='bold 22px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('📋 問題',60,180);
  ctx.font='18px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.9)';
  wrapText(ctx,S.form.question||'綜合運勢',60,210,W-120,26);

  // Verdict
  const prob=document.getElementById('r-vprob')?document.getElementById('r-vprob').textContent:'50%';
  const label=document.getElementById('r-vlabel')?document.getElementById('r-vlabel').textContent:'分析中';
  const y1=290;
  ctx.fillStyle='rgba(212,175,55,0.1)';roundRect(ctx,48,y1-10,W-96,100,12);ctx.fill();
  ctx.strokeStyle='rgba(212,175,55,0.3)';ctx.stroke();
  ctx.font='bold 40px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';ctx.textAlign='center';
  ctx.fillText(prob,W/2,y1+35);
  ctx.font='20px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.85)';
  ctx.fillText(label,W/2,y1+70);

  // BaZi summary
  const y2=420;
  ctx.textAlign='left';ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('🏮 八字命理',60,y2);
  if(S.bazi){
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.8)';
    const p=S.bazi.pillars;
    ctx.fillText(`四柱：${p.year.gan}${p.year.zhi} ${p.month.gan}${p.month.zhi} ${p.day.gan}${p.day.zhi} ${p.hour.gan}${p.hour.zhi}`,60,y2+30);
    ctx.fillText(`日主：${S.bazi.dm}（${S.bazi.dmEl}）｜ 身${S.bazi.strong?'強':'弱'} ｜ 喜用：${S.bazi.fav.join('、')}`,60,y2+58);
    const curDy=S.bazi.dayun.find(d=>d.isCurrent);
    if(curDy)ctx.fillText(`當前大運：${curDy.gz}（${curDy.level}）`,60,y2+86);
  }

  // Five elements bar
  const y3=560;
  ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('🔮 五行能量',60,y3);
  if(S.bazi){
    const els=['金','木','水','火','土'];
    const colors={金:'#c0c0c0',木:'#22c55e',水:'#3b82f6',火:'#ef4444',土:'#a78b5a'};
    els.forEach((e,i)=>{
      const bx=60,by=y3+25+i*32,bw=W-200,pct=S.bazi.ep[e]||0;
      ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle=colors[e];
      ctx.fillText(e,bx,by+14);
      ctx.fillStyle='rgba(255,255,255,0.1)';roundRect(ctx,bx+30,by,bw,18,4);ctx.fill();
      ctx.fillStyle=colors[e];roundRect(ctx,bx+30,by,bw*pct/100,18,4);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.7)';ctx.fillText(pct+'%',bx+bw+40,by+14);
    });
  }

  // Crystal recommendation
  const y4=760;
  ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
  ctx.fillText('💍 專屬水晶處方',60,y4);
  if(S.bazi){
    const need=S.bazi.fav[0];
    const prods=PRODUCT_DB[need]||PRODUCT_DB['土'];
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.85)';
    prods.slice(0,3).forEach((p,i)=>{
      ctx.fillText(`${p.icon} ${p.n}（${p.cat}）— ${p.d}`,60,y4+30+i*28);
    });
  }

  // Meihua + Tarot summary
  const y5=880;
  if(S.meihua){
    ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
    ctx.fillText('☯ 梅花易數',60,y5);
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.8)';
    ctx.fillText(`${S.meihua.ben.n} → ${S.meihua.bian.n}｜體用${S.meihua.ty.r}（${S.meihua.ty.f}）`,60,y5+28);
  }
  if(S.tarot.drawn.length){
    const yt=y5+70;
    ctx.font='bold 20px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';
    ctx.fillText('🃏 塔羅牌',60,yt);
    ctx.font='16px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.8)';
    const core=S.tarot.drawn[0],fin=S.tarot.drawn[9];
    ctx.fillText(`核心：${core.n}（${core.isUp?'正':'逆'}）｜ 結果：${fin?fin.n:''}（${fin?(fin.isUp?'正':'逆'):''}）`,60,yt+28);
  }

  // Divider
  drawGoldLine(ctx,60,1060,W-60);

  // QR Code area (text-based since we can't load QR library)
  const yq=1090;
  ctx.fillStyle='rgba(255,255,255,0.05)';roundRect(ctx,W/2-160,yq,320,100,12);ctx.fill();
  ctx.strokeStyle='rgba(212,175,55,0.3)';ctx.stroke();
  ctx.font='bold 16px "Noto Sans TC",sans-serif';ctx.fillStyle='#D4AF37';ctx.textAlign='center';
  ctx.fillText('🔍 免費測你的命理結果',W/2,yq+30);
  ctx.font='14px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.7)';
  ctx.fillText('靜月之光能量占卜儀',W/2,yq+55);
  ctx.font='12px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.5)';
  ctx.fillText(window.location.href.split('?')[0],W/2,yq+78);

  // Footer
  ctx.font='12px "Noto Sans TC",sans-serif';ctx.fillStyle='rgba(255,255,255,0.35)';
  ctx.fillText('🛒 蝦皮: tw.shp.ee/2n5Mo2w ｜ 📦 7-11賣貨便: 搜尋「靜月之光」',W/2,H-50);
  ctx.fillText(`生成時間：${new Date().toLocaleDateString('zh-TW')}`,W/2,H-30);

  return canvas;
}

function drawGoldLine(ctx,x1,y,x2){
  const g=ctx.createLinearGradient(x1,y,x2,y);
  g.addColorStop(0,'transparent');g.addColorStop(0.5,'rgba(212,175,55,0.6)');g.addColorStop(1,'transparent');
  ctx.strokeStyle=g;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(x1,y);ctx.lineTo(x2,y);ctx.stroke();
}

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

function wrapText(ctx,text,x,y,maxW,lineH){
  const chars=[...text];let line='';
  for(let i=0;i<chars.length;i++){
    const test=line+chars[i];
    if(ctx.measureText(test).width>maxW&&line){ctx.fillText(line,x,y);y+=lineH;line=chars[i]}
    else line=test;
  }
  if(line)ctx.fillText(line,x,y);
}

function saveResultCard(){
  const canvas=generateResultCard();
  canvas.toBlob(function(blob){
    if(!blob)return;
    // Try native share first (mobile)
    if(navigator.share&&navigator.canShare){
      const file=new File([blob],'靜月占卜結果.png',{type:'image/png'});
      if(navigator.canShare({files:[file]})){
        navigator.share({title:'我的靜月占卜結果',text:'免費測你的命理結果！',files:[file]}).catch(()=>downloadBlob(blob));
        return;
      }
    }
    downloadBlob(blob);
  },'image/png');
}

function downloadBlob(blob){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='靜月占卜結果_'+Date.now()+'.png';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),3000);
}

/* =============================================================
   FEATURE 3: 分享解鎖「再測一次」
   ============================================================= */
let hasShared=false;

function shareToUnlock(){
  /* 這個函數會被下方的 patch 覆蓋，保留作 fallback */
  const url=window.location.href.split('?')[0];
  const text='我剛用「靜月之光」測了命理結果，超準！免費測你的 👉 ';
  if(!S.bazi){alert('請先完成占卜分析再分享哦！');return}
  if(navigator.share){
    navigator.share({title:'靜月之光占卜',text:text,url:url}).then(()=>{
      hasShared=true; updateShareGate();
    }).catch(()=>{
      showShareHint('分享取消了，完成分享才能取得折扣碼哦 😊');
    });
  }else{
    showCopyShareDialog(text+url);
  }
}

function showShareHint(msg){
  const gate = document.getElementById('share-gate');
  if(!gate) return;
  let hint = gate.querySelector('.share-hint-msg');
  if(!hint){
    hint = document.createElement('p');
    hint.className = 'share-hint-msg';
    hint.style.cssText = 'color:rgba(232,201,104,0.8);font-size:0.85rem;margin-top:0.5rem;';
    gate.appendChild(hint);
  }
  hint.textContent = msg;
  setTimeout(()=>{ if(hint) hint.textContent=''; }, 4000);
}

function showCopyShareDialog(text){
  // Step 1: Copy to clipboard
  navigator.clipboard.writeText(text).then(()=>{
    // Step 2: Ask user to confirm they've pasted & shared
    const confirmed = confirm(
      '分享連結已複製到剪貼簿！✨\n\n' +
      '請貼到 LINE / IG / FB 分享給朋友。\n\n' +
      '已經分享了嗎？按「確定」解鎖再測一次。'
    );
    if(confirmed){
      hasShared=true;
      updateShareGate();
    } else {
      showShareHint('把連結貼給朋友後，再按一次分享按鈕即可解鎖 ✨');
    }
  }).catch(()=>{
    prompt('複製以下連結分享給朋友：', text);
    // Don't auto-unlock on prompt fallback either
    showShareHint('分享給朋友後，再按一次即可解鎖 ✨');
  });
}

function fallbackCopyShare(text){
  // Keep for backward compat but don't auto-unlock
  navigator.clipboard.writeText(text).catch(()=>{});
}

function updateShareGate(){
  const gate=document.getElementById('share-gate');
  const retestBtn=document.getElementById('btn-retest');
  if(gate&&retestBtn){
    if(hasShared){
      gate.classList.add('hidden');
      retestBtn.classList.remove('hidden');
    }
  }
}

function retestAfterShare(){
  hasShared=false;
  drawnCards=[];
  resetAll();
}
// 實際商品庫 — 依五行分類，取代表性品項（同名取價格帶）
const REAL_PRODUCTS = {
  金: [
    // 白水晶系列
    {n:'白水晶',cat:'手鏈',icon:'💍',el:'金',d:'淨化能量場，增強思維清晰度，萬能調和石',price:'$320-$396',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白水晶手排',cat:'手鏈',icon:'💍',el:'金',d:'大顆粒排珠，淨化能量更強，適合辦公佩戴',price:'$396',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'鈦晶手排',cat:'手鏈',icon:'⚡',el:'金',d:'招正財偏財首選！增強領導力與決斷力',price:'$3,334-$21,950',wear:'面試/簽約時佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白水晶鳳凰項鍊',cat:'項鍊',icon:'🔮',el:'金',d:'鳳凰涅槃，淨化+重生能量，收藏級項鍊',price:'$3,372',wear:'貼近心輪佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'金髮晶',cat:'手鏈',icon:'🌟',el:'金',d:'招財旺事業，金色髮絲象徵財富能量',price:'$761',wear:'左手佩戴招財',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白幽靈',cat:'手鏈',icon:'💠',el:'金',d:'淨化磁場，提升靈性直覺力',price:'$396',wear:'冥想時佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白阿賽設計款',cat:'手鏈',icon:'💫',el:'金',d:'高頻能量石，提升靈性連結與直覺',price:'$420',wear:'冥想/靜心時佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'透石膏',cat:'手鏈',icon:'🗿',el:'金',d:'淨化空間能量，帶來心靈平靜',price:'$358',wear:'放臥室或隨身',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  木: [
    {n:'綠幽靈',cat:'手鏈',icon:'💚',el:'木',d:'招正財首選！事業穩步上升，上班族必備',price:'$684-$10,668',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'抹茶幽靈',cat:'手鏈',icon:'🍵',el:'木',d:'稀有抹茶色幽靈，招正財+安定心性',price:'$8,748',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠碧璽',cat:'手鏈',icon:'💎',el:'木',d:'旺事業財運，激發創造力',price:'$1,644',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'東陵玉',cat:'手鏈',icon:'🌿',el:'木',d:'舒緩壓力，帶來好運與正能量',price:'$176',wear:'隨身佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠水晶隨型',cat:'手鏈',icon:'💍',el:'木',d:'天然隨型綠水晶，招正財聚能量',price:'$2,028',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'四季幽靈手排',cat:'手鏈',icon:'🌈',el:'木',d:'四季色彩幽靈，全方位招財開運',price:'$2,988',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠龍晶',cat:'手鏈',icon:'🐉',el:'木',d:'天然龍紋，旺事業+護身辟邪',price:'$1,068-$2,028',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠檀木手鍊',cat:'手鏈',icon:'🌳',el:'木',d:'天然檀木清香，安神定氣，適合修行佩戴',price:'$224-$492',wear:'隨身佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'綠月光',cat:'手鏈',icon:'🌕',el:'木',d:'稀有綠色月光石，增強直覺+招好運',price:'$108',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  水: [
    {n:'海藍寶',cat:'手鏈',icon:'💙',el:'水',d:'增強溝通力，平靜情緒，談判必備',price:'$2,028-$23,825',wear:'佩戴在喉輪附近最佳',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'海藍寶手排',cat:'手鏈',icon:'🌊',el:'水',d:'大顆粒海藍寶，溝通力與勇氣加倍',price:'$2,988',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'月光石',cat:'手鏈',icon:'🌙',el:'水',d:'增強直覺，助感情運，柔化個性',price:'$9,708',wear:'滿月佩戴效果更佳',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍玉髓',cat:'手鏈',icon:'🔵',el:'水',d:'穩定情緒，增強語言表達力',price:'$588',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍彼得石圓珠',cat:'手鏈',icon:'🌀',el:'水',d:'暴風雨石！激發洞察力與變革勇氣',price:'$9,708',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍磷灰',cat:'手鏈',icon:'💍',el:'水',d:'增強意志力與目標感，學習考試佳',price:'$396',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'堇青石',cat:'手鏈',icon:'🔮',el:'水',d:'指引方向之石，幫助做出正確決定',price:'$875',wear:'需要決策時佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍方解石',cat:'手鏈',icon:'💠',el:'水',d:'溝通之石，打開喉輪，增強表達',price:'$300',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'青晶石',cat:'手鏈',icon:'🌌',el:'水',d:'開啟第三眼，增強直覺與靈性感知',price:'$2,604',wear:'冥想時佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑曜石',cat:'手鏈',icon:'🖤',el:'水',d:'擋煞辟邪首選！以水洩金，化壓力為動力',price:'$300-$500',wear:'右手佩戴辟邪',tags:['辟邪','擋煞'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'金曜石',cat:'手鏈',icon:'🌑',el:'水',d:'金色閃光黑曜石，強力辟邪+洩金護身',price:'$416',wear:'右手佩戴辟邪',tags:['辟邪','擋煞'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'銀曜石',cat:'手鏈',icon:'🌒',el:'水',d:'銀色光澤黑曜石，洩金氣+淨化能量場',price:'$350-$500',wear:'右手佩戴',tags:['辟邪','淨化'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑髮晶',cat:'手鏈',icon:'🕸️',el:'水',d:'排除負能量，增強領袖魅力，官殺太旺者首選',price:'$800-$2000',wear:'左手佩戴',tags:['辟邪','事業'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍虎眼',cat:'手鏈',icon:'👁️',el:'水',d:'增強洞察力與決斷力，水氣護身',price:'$500-$1200',wear:'左手佩戴',tags:['事業','決策'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑碧璽',cat:'手鏈',icon:'⬛',el:'水',d:'電氣石！擋煞辟邪防小人，穩定情緒接地',price:'$600-$1500',wear:'右手佩戴',tags:['辟邪','防小人'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  火: [
    {n:'紅瑪瑙',cat:'手鏈',icon:'❤️',el:'火',d:'激發熱情，增強行動力與勇氣',price:'$300-$454',wear:'右手佩戴增行動力',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'波斯瑪瑙設計款',cat:'手鏈',icon:'💗',el:'火',d:'波斯風情瑪瑙，熱情+時尚兼具',price:'$1,260',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫水晶',cat:'手鏈',icon:'💜',el:'火',d:'安神助眠，穩定情緒，靈性提升首選',price:'$588-$1,606',wear:'睡前佩戴或放枕下',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅虎眼',cat:'手鏈',icon:'🔴',el:'火',d:'增強意志力與行動力，辟邪擋煞',price:'$435',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅花碧玉手排',cat:'手鏈',icon:'🌺',el:'火',d:'天然花紋碧玉，增強生命力與穩定感',price:'$464',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫牙烏',cat:'手鏈',icon:'🍇',el:'火',d:'石榴石系列，提升活力與桃花運',price:'$1,952',wear:'貼身佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'粉紅碧璽圓珠',cat:'手鏈',icon:'💕',el:'火',d:'強力招桃花！增強人際魅力',price:'$13,548',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'薔薇石',cat:'手鏈',icon:'🌹',el:'火',d:'愛情療癒石，修復心輪，招桃花',price:'$1,798',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'煙花雨薔薇石',cat:'手鏈',icon:'🍆',el:'火',d:'獨特煙花紋理，療癒心靈+招桃花',price:'$2,220',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫龍晶',cat:'手鏈',icon:'🐲',el:'火',d:'智慧+靈性提升，紫色龍紋獨特美感',price:'$646',wear:'冥想佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫金砂',cat:'手鏈',icon:'✨',el:'火',d:'閃耀紫金光，辟邪+提升靈性',price:'$339',wear:'隨身佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'利比亞黃金隕石',cat:'手鏈',icon:'☄️',el:'火',d:'來自宇宙的能量！極強顯化力與意志力',price:'$1,644',wear:'冥想/許願時佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  土: [
    {n:'黃水晶',cat:'手鏈',icon:'💛',el:'土',d:'招偏財首選！提升自信與個人魅力',price:'$233-$492',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'茶晶',cat:'手鏈',icon:'🍵',el:'土',d:'排除負能量，穩定心性，接地氣',price:'$684-$742',wear:'佩戴或放客廳',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'虎眼石',cat:'手鏈',icon:'🐯',el:'土',d:'增強決斷力，招財辟邪，穩定心性',price:'$7,600',wear:'右手佩戴增氣場',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'阿拉善',cat:'手鏈',icon:'🗿',el:'土',d:'戈壁能量石，穩定+接地+增強耐力',price:'$281-$454',wear:'隨身佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'超八',cat:'手鏈',icon:'🌈',el:'土',d:'八大礦物共生，全方位平衡五行能量',price:'$454',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'大地瑪瑙手排',cat:'手鏈',icon:'🐅',el:'土',d:'大地能量，穩定踏實，增強耐力',price:'$300',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'鐵膽石手排',cat:'手鏈',icon:'🗿',el:'土',d:'極強接地能量，排負+穩定心性',price:'$185',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白水茶晶設計款',cat:'手鏈',icon:'☕',el:'土',d:'白水晶+茶晶組合，淨化+穩定雙效',price:'$506',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  // 跨五行特殊商品
  special: [
    {n:'彩超七',cat:'手鏈',icon:'🌈',el:'全',d:'七種礦物共生！全方位開運招財',price:'$972-$41,325',wear:'左手佩戴',tags:['全能','招財'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'多寶隕石手鍊',cat:'手鏈',icon:'☄️',el:'全',d:'多種隕石能量集合，宇宙級防護',price:'$5,484',wear:'左手佩戴',tags:['辟邪','全能'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'天鐵五行設計款',cat:'手鏈',icon:'⚔️',el:'全',d:'天鐵（隕鐵）+五行元素，強力護身開運',price:'$5,484',wear:'左手佩戴',tags:['五行','辟邪'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'銀曜石五行設計款',cat:'手鏈',icon:'🌟',el:'全',d:'銀曜石+五行配色，辟邪+五行平衡',price:'$3,622',wear:'右手佩戴',tags:['五行','辟邪'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩色天鐵手鍊',cat:'手鏈',icon:'🌈',el:'全',d:'彩色天鐵，宇宙能量+藝術美感',price:'$4,548-$10,308',wear:'左手佩戴',tags:['全能'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'骨幹太陽石',cat:'手鏈',icon:'☀️',el:'火',d:'正能量之王！自信、領導力、活力全開',price:'$2,777',wear:'日間佩戴',tags:['事業','自信'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'金太陽',cat:'手鏈',icon:'🌞',el:'火',d:'金色太陽光芒，招正財+增強領導力',price:'$8,748-$21,325',wear:'左手佩戴',tags:['財運','事業'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'老山檀香圓珠',cat:'手鏈',icon:'📿',el:'木',d:'百年老山檀香，安神助眠，靜心修行',price:'$3,756',wear:'念佛/冥想佩戴',tags:['健康','靈性'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'沉香無事牌',cat:'吊墜',icon:'🏷️',el:'木',d:'無事牌寓意平安無事，沉香安神定氣',price:'$492',wear:'項鍊佩戴',tags:['平安','健康'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'太陽花手排',cat:'手鏈',icon:'🌻',el:'火',d:'向陽而生，增強正能量與行動力',price:'$1,387-$2,028',wear:'左手佩戴',tags:['事業','自信'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'咖啡鈦太陽花手排',cat:'手鏈',icon:'☕',el:'金',d:'鈦晶+太陽花，招財+正能量雙效',price:'$2,988',wear:'左手佩戴',tags:['財運','事業'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彼得石手排',cat:'手鏈',icon:'🌀',el:'水',d:'暴風雨石！激發洞察力與變革勇氣',price:'$681',wear:'左手佩戴',tags:['事業','決策'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'藍彼得算盤珠',cat:'手鏈',icon:'🌀',el:'水',d:'算盤珠型彼得石，洞察力與智慧象徵',price:'$2,604',wear:'左手佩戴',tags:['事業','智慧'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑髮手排',cat:'手鏈',icon:'🕸️',el:'水',d:'排除負能量，增強領袖魅力與決斷力',price:'$9,708-$16,620',wear:'左手佩戴',tags:['辟邪','事業'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩髮圓珠',cat:'手鏈',icon:'🌈',el:'全',d:'多色髮晶共生，全方位開運旺事業',price:'$5,868',wear:'左手佩戴',tags:['全能','事業'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩超七圓珠',cat:'手鏈',icon:'🌈',el:'全',d:'七礦共生圓珠，全方位能量平衡',price:'$1,387',wear:'左手佩戴',tags:['全能'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩銅超七',cat:'手鏈',icon:'✨',el:'全',d:'含銅礦超七，導能量+增強行動力',price:'$972',wear:'左手佩戴',tags:['全能'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩色天鐵手排',cat:'手鏈',icon:'🌈',el:'全',d:'天鐵手排大顆粒，宇宙能量+氣場強大',price:'$10,308',wear:'左手佩戴',tags:['全能','辟邪'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'阿富汗碧璽',cat:'手鏈',icon:'💎',el:'火',d:'稀有產地碧璽，強力招桃花+旺人緣',price:'$5,484',wear:'左手佩戴',tags:['愛情','人緣'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'糖果碧璽',cat:'手鏈',icon:'🍭',el:'火',d:'多彩糖果色碧璽，療癒心靈+招桃花',price:'$395-$18,825',wear:'左手佩戴',tags:['愛情','療癒'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑曜石貔貅',cat:'擺件',icon:'🖤',el:'水',d:'貔貅招財辟邪，黑曜石加持擋煞力強',price:'$2,988',wear:'放財位或辦公桌',tags:['財運','辟邪'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'白松石x黑曜石設計款',cat:'手鏈',icon:'⚪',el:'全',d:'白松石淨化+黑曜辟邪，設計師款',price:'$400',wear:'左手佩戴',tags:['辟邪','淨化'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紫黃白水設計款',cat:'手鏈',icon:'💜',el:'全',d:'紫水晶+黃水晶+白水晶三色組合',price:'$400',wear:'左手佩戴',tags:['全能'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'摩根石設計款',cat:'手鏈',icon:'💗',el:'水',d:'摩根石設計師款，溫柔療癒招真愛',price:'$400',wear:'左手佩戴',tags:['愛情'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅幽靈設計款',cat:'手鏈',icon:'❤️',el:'火',d:'紅幽靈+設計元素，增強行動力與熱情',price:'$450',wear:'右手佩戴',tags:['事業','行動力'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'紅膠花設計款',cat:'手鏈',icon:'🌺',el:'火',d:'紅膠花水晶，招桃花+增強人際魅力',price:'$506',wear:'左手佩戴',tags:['愛情'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'鷹眼堇青石設計款',cat:'手鏈',icon:'👁️',el:'水',d:'鷹眼石+堇青石，增強決策力與洞察力',price:'$780',wear:'左手佩戴',tags:['事業','決策'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'鐵膽石圓珠',cat:'手鏈',icon:'🗿',el:'土',d:'強力接地能量，排除負面思緒',price:'$185',wear:'右手佩戴',tags:['辟邪'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'龍宮舍利',cat:'手鏈',icon:'🐚',el:'土',d:'龍宮舍利化石，鎮宅安神，靈性修行聖品',price:'$231-$423',wear:'隨身佩戴或供奉',tags:['靈性','平安'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  // 項鍊吊墜
  necklace: [
    {n:'銀曜項鍊（關公）',cat:'項鍊',icon:'⚔️',el:'水',d:'關公護身，招財辟邪，生意人必備',price:'$492',wear:'出門佩戴',tags:['財運','辟邪'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'金曜項鍊（龍牌）',cat:'項鍊',icon:'🐉',el:'水',d:'龍牌護身符，氣場強大，事業亨通',price:'$492',wear:'出門佩戴',tags:['事業','辟邪'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'銀曜項鍊（九尾狐）',cat:'項鍊',icon:'🦊',el:'水',d:'九尾狐招桃花，增強魅力與異性緣',price:'$492',wear:'約會佩戴',tags:['愛情','桃花'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑曜磨砂心經',cat:'項鍊',icon:'📿',el:'水',d:'心經護身符，辟邪化煞，安定心神',price:'$204-$377',wear:'隨身佩戴',tags:['辟邪','平安'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑曜磨砂心經（桶珠）',cat:'項鍊',icon:'📿',el:'水',d:'桶珠款心經護身符，辟邪+個性設計',price:'$300',wear:'隨身佩戴',tags:['辟邪','平安'],
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ],
  // 辟邪系列
  protection: [
    {n:'黑閃靈',cat:'手鏈',icon:'⚫',el:'水',d:'超強辟邪擋煞，排除一切負能量',price:'$1,798',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩閃靈',cat:'手鏈',icon:'🌈',el:'全',d:'辟邪+開運雙效，彩色閃靈能量全面',price:'$4,908',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩虹黑曜石',cat:'手鏈',icon:'🌈',el:'水',d:'黑曜石中的極品，辟邪+七彩光芒',price:'$1,882',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'黑碧璽三圈',cat:'手鏈',icon:'⬛',el:'水',d:'三圈纏繞設計，全面辟邪防護',price:'$588',wear:'右手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
  ],
  // 桃花系列
  love_special: [
    {n:'粉晶',cat:'手鏈',icon:'💕',el:'火',d:'招桃花首選！增強感情運與人際魅力',price:'$204-$272',wear:'左手佩戴，約會必備',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'星光草荓晶',cat:'手鏈',icon:'🍓',el:'火',d:'增強異性緣，帶來甜蜜戀愛機會',price:'$300-$454',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'彩色草荓晶',cat:'手鏈',icon:'🍇',el:'火',d:'多色草荓晶，全面提升人際與桃花運',price:'$608',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'},
    {n:'摩根石',cat:'手鏈',icon:'💗',el:'水',d:'高頻愛情石，溫柔療癒，吸引真愛',price:'$300',wear:'左手佩戴',
     shopee:'https://tw.shp.ee/2n5Mo2w',seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}
  ]
};
/* =============================================================
   智慧推薦引擎 — 取代 PRODUCT_DB + TYPE_PRODUCTS
   根據：喜用神 × 問題類型 × 價格帶分佈 推薦最佳商品
   ============================================================= */
/* =============================================================
   水晶視覺 — 依產品類型用 SVG 產生對應造型
   手鏈=圓環珠串 手排=橫排方珠 項鍊=鏈+吊墜 圓珠=球 etc.
   ============================================================= */
function getCrystalVisual(p){
  const n=p.n||'', cat=p.cat||'';
  /* ── 顏色映射 ── */
  const CMAP=[
    {k:/白水晶|白阿賽|透石膏|白幽靈|白松石/,c:'#ccd',c2:'#aab',c3:'#e8e8f0'},
    {k:/鈦晶|金髮|金太陽|咖啡鈦/,c:'#d4a020',c2:'#8b6508',c3:'#ffe680'},
    {k:/綠幽靈|抹茶|綠碧璽|東陵|綠水晶|四季|綠龍|綠月光/,c:'#3cb371',c2:'#1a6b1a',c3:'#90ee90'},
    {k:/海藍寶|藍玉髓|藍彼得|藍磷灰|堇青石|藍方解|青晶|藍虎眼|鷹眼堇青/,c:'#4682b4',c2:'#1a3c5c',c3:'#87ceeb'},
    {k:/黑曜|金曜|銀曜|黑閃靈|黑碧璽|黑髮|彩虹黑曜/,c:'#444',c2:'#111',c3:'#777'},
    {k:/粉晶|粉紅碧璽|摩根石|薔薇|煙花雨|紅膠花/,c:'#e87fa0',c2:'#c04070',c3:'#ffb6c1'},
    {k:/紫水晶|紫牙烏|紫龍晶|紫金砂|紫黃白/,c:'#9370db',c2:'#5a3d7a',c3:'#d8bfff'},
    {k:/紅瑪|紅虎眼|紅花碧|紅碧璽|紅幽靈|波斯瑪/,c:'#dc3545',c2:'#8b1520',c3:'#ff8a8a'},
    {k:/黃水晶|茶晶|虎眼|阿拉善|鐵膽|大地瑪|白水茶|超八/,c:'#daa520',c2:'#8b6914',c3:'#ffe082'},
    {k:/太陽花|骨幹太陽|利比亞/,c:'#e68a00',c2:'#bf360c',c3:'#ffcc80'},
    {k:/彩超七|彩閃靈|彩色天鐵|彩銅|彩髮|天鐵五行|銀曜石五行/,c:'rainbow',c2:'#888',c3:'#ddd'},
    {k:/碧璽|糖果碧璽|阿富汗/,c:'#20b2aa',c2:'#005555',c3:'#7fffd4'},
    {k:/檀木|檀香|老山|沉香/,c:'#8b6343',c2:'#5d3d20',c3:'#d2a679'},
    {k:/龍宮舍利/,c:'#c4a56e',c2:'#8b7340',c3:'#f0e0c8'},
    {k:/月光石/,c:'#9da8c0',c2:'#6070a0',c3:'#e0e8ff'},
    {k:/草莓|草苺|草荓/,c:'#d66',c2:'#933',c3:'#faa'},
    {k:/隕石|多寶/,c:'#666',c2:'#333',c3:'#999'},
    {k:/心經/,c:'#333',c2:'#111',c3:'#666'},
    {k:/貔貅/,c:'#333',c2:'#111',c3:'#555'},
  ];
  const cm=CMAP.find(m=>m.k.test(n));
  const c=cm?cm.c:'#aaa', c2=cm?cm.c2:'#666', c3=cm?cm.c3:'#ddd';
  const isRainbow=c==='rainbow';
  // rainbow 用多色
  const rc=['#e55','#e92','#da0','#5a5','#48b','#86d'];

  /* ── SVG 生成器 ── */
  const W=76,H=72;
  const hdr=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${W} ${H}" width="${W}" height="${H}" style="flex:0 0 auto">`;
  const hlDef=`<defs><radialGradient id="hl_${n.length}"><stop offset="0%" stop-color="white" stop-opacity="0.6"/><stop offset="100%" stop-color="white" stop-opacity="0"/></radialGradient></defs>`;

  // 畫珠子（圓形，帶高光）
  function bead(cx,cy,r,color){
    return `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${color}" stroke="${c2}" stroke-width="0.5"/>
      <ellipse cx="${cx-r*0.25}" cy="${cy-r*0.25}" rx="${r*0.35}" ry="${r*0.25}" fill="white" opacity="0.45" transform="rotate(-20 ${cx} ${cy})"/>`;
  }

  // ── 項鍊/吊墜/無事牌 ──
  if(/項鍊|吊墜|無事牌/.test(n) || cat==='項鍊'){
    const pc=isRainbow?'#888':c;
    let pendantShape='';
    if(/關公|龍牌|九尾狐|貔貅/.test(n)){
      // 雕刻牌子
      pendantShape=`<rect x="28" y="30" width="20" height="28" rx="4" fill="${pc}" stroke="${c2}" stroke-width="1"/>
        <ellipse cx="35" cy="36" rx="4" ry="3" fill="white" opacity="0.2"/>
        <text x="38" y="51" text-anchor="middle" font-size="12">${/關公/.test(n)?'⚔️':/龍牌/.test(n)?'🐉':/九尾狐/.test(n)?'🦊':'🏺'}</text>`;
    }else if(/心經/.test(n)){
      // 桶珠/圓牌
      pendantShape=`<rect x="26" y="32" width="24" height="26" rx="8" fill="${pc}" stroke="${c2}" stroke-width="1"/>
        <line x1="31" y1="40" x2="45" y2="40" stroke="${c3}" stroke-width="0.5" opacity="0.4"/>
        <line x1="31" y1="44" x2="45" y2="44" stroke="${c3}" stroke-width="0.5" opacity="0.4"/>
        <line x1="31" y1="48" x2="45" y2="48" stroke="${c3}" stroke-width="0.5" opacity="0.4"/>
        <text x="38" y="46" text-anchor="middle" font-size="6" fill="${c3}" opacity="0.5">經</text>`;
    }else{
      // 一般吊墜（水滴形）
      pendantShape=`<path d="M38 30 Q48 42 42 55 Q38 60 34 55 Q28 42 38 30Z" fill="${pc}" stroke="${c2}" stroke-width="0.8"/>
        <ellipse cx="36" cy="40" rx="3" ry="4" fill="white" opacity="0.25"/>`;
    }
    // 金色鏈子
    return `<div style="flex:0 0 auto">${hdr}
      <path d="M20 8 Q38 22 56 8" fill="none" stroke="#d4a020" stroke-width="1.8" stroke-linecap="round"/>
      <circle cx="20" cy="8" r="2" fill="#d4a020"/><circle cx="56" cy="8" r="2" fill="#d4a020"/>
      <line x1="38" y1="20" x2="38" y2="32" stroke="#d4a020" stroke-width="1.2"/>
      <circle cx="38" cy="28" r="3" fill="#d4a020" opacity="0.6"/>
      ${pendantShape}
    </svg></div>`;
  }

  // ── 手排：橫排方珠 ──
  if(/手排/.test(n)){
    const beadW=10,beadH=24,gap=2,count=5;
    const startX=(W-count*(beadW+gap)+gap)/2;
    const y=(H-beadH)/2;
    let beads='';
    for(let i=0;i<count;i++){
      const bc=isRainbow?rc[i%rc.length]:c;
      const x=startX+i*(beadW+gap);
      beads+=`<rect x="${x}" y="${y}" width="${beadW}" height="${beadH}" rx="3" fill="${bc}" stroke="${c2}" stroke-width="0.7"/>
        <rect x="${x+2}" y="${y+3}" width="${beadW*0.4}" height="${beadH*0.15}" rx="1" fill="white" opacity="0.3" transform="rotate(-8 ${x+3} ${y+4})"/>`;
    }
    // 穿繩
    const ropeY=H/2;
    return `<div style="flex:0 0 auto">${hdr}
      <line x1="${startX-4}" y1="${ropeY}" x2="${startX+count*(beadW+gap)}" y2="${ropeY}" stroke="#a08060" stroke-width="1.5" opacity="0.5"/>
      ${beads}
    </svg></div>`;
  }

  // ── 設計款：多色珠子混搭 ──
  if(/設計款/.test(n)){
    // 弧形排列多色珠
    const colors=isRainbow?rc:[c3,c,c2,c3,c];
    let beads='';
    const cx=W/2, cy=H/2+4, r=22;
    for(let i=0;i<colors.length;i++){
      const ang=Math.PI+i*(Math.PI/(colors.length-1));
      const bx=cx+r*Math.cos(ang), by=cy+r*Math.sin(ang);
      beads+=bead(bx,by,6,colors[i]);
    }
    // 穿線
    return `<div style="flex:0 0 auto">${hdr}
      <ellipse cx="${cx}" cy="${cy}" rx="${r}" ry="${r}" fill="none" stroke="#a08060" stroke-width="1" opacity="0.3" stroke-dasharray="3 5"/>
      ${beads}
    </svg></div>`;
  }

  // ── 圓珠/算盤珠：單顆大珠 ──
  if(/圓珠|算盤珠/.test(n)){
    const cx=W/2, cy=H/2;
    const bc=isRainbow?'url(#rb)':c;
    const rbDef=isRainbow?`<defs><linearGradient id="rb" x1="0" y1="0" x2="1" y2="1">${rc.map((co,i)=>`<stop offset="${i/(rc.length-1)*100}%" stop-color="${co}"/>`).join('')}</linearGradient></defs>`:'';
    return `<div style="flex:0 0 auto">${hdr}${rbDef}
      <circle cx="${cx}" cy="${cy}" r="24" fill="${bc}" stroke="${c2}" stroke-width="1"/>
      <circle cx="${cx}" cy="${cy}" r="22" fill="none" stroke="${c2}" stroke-width="0.3" opacity="0.3"/>
      <ellipse cx="${cx-7}" cy="${cy-8}" rx="8" ry="6" fill="white" opacity="0.35" transform="rotate(-15 ${cx-7} ${cy-8})"/>
      <ellipse cx="${cx+8}" cy="${cy+10}" rx="4" ry="3" fill="white" opacity="0.15"/>
      <circle cx="${cx}" cy="${cy-25}" r="2.5" fill="#a08060" opacity="0.6"/>
      <line x1="${cx}" y1="${cy-24}" x2="${cx}" y2="${cy-28}" stroke="#a08060" stroke-width="1" opacity="0.4"/>
    </svg></div>`;
  }

  // ── 貔貅/雕件 ──
  if(/貔貅|關公|龍牌|九尾狐|舍利/.test(n)){
    const icon=/貔貅/.test(n)?'🏺':/關公/.test(n)?'⚔️':/龍牌/.test(n)?'🐉':/九尾狐/.test(n)?'🦊':'📿';
    const bc=isRainbow?'#888':c;
    return `<div style="flex:0 0 auto">${hdr}
      <rect x="18" y="12" width="40" height="48" rx="10" fill="${bc}" stroke="${c2}" stroke-width="1"/>
      <ellipse cx="32" cy="22" rx="8" ry="5" fill="white" opacity="0.15" transform="rotate(-10 32 22)"/>
      <text x="38" y="44" text-anchor="middle" font-size="18">${icon}</text>
    </svg></div>`;
  }

  // ── 裸石/擺件/隨型/聚寶盆 ──
  if(/裸石|擺件|隨型|聚寶盆/.test(n)){
    const bc=isRainbow?'#888':c;
    return `<div style="flex:0 0 auto">${hdr}
      <polygon points="38,8 56,24 52,56 24,56 20,24" fill="${bc}" stroke="${c2}" stroke-width="1"/>
      <polygon points="38,8 48,20 38,16 28,20" fill="${c3}" opacity="0.3"/>
      <line x1="38" y1="16" x2="38" y2="56" stroke="${c2}" stroke-width="0.3" opacity="0.3"/>
      <line x1="20" y1="24" x2="56" y2="24" stroke="${c2}" stroke-width="0.3" opacity="0.3"/>
      <ellipse cx="32" cy="28" rx="5" ry="4" fill="white" opacity="0.2" transform="rotate(-15 32 28)"/>
    </svg></div>`;
  }

  // ── 三圈手鏈 ──
  if(/三圈/.test(n)){
    const cx=W/2, cy=H/2;
    const bc=isRainbow?'#888':c;
    return `<div style="flex:0 0 auto">${hdr}
      <circle cx="${cx}" cy="${cy}" r="28" fill="none" stroke="${bc}" stroke-width="4" opacity="0.5"/>
      <circle cx="${cx}" cy="${cy}" r="22" fill="none" stroke="${bc}" stroke-width="4" opacity="0.7"/>
      <circle cx="${cx}" cy="${cy}" r="16" fill="none" stroke="${bc}" stroke-width="4"/>
      ${bead(cx,cy-28,3,c3)}${bead(cx,cy-22,3,c3)}${bead(cx,cy-16,3,c3)}
      ${bead(cx,cy+28,3,c3)}${bead(cx,cy+22,3,c3)}${bead(cx,cy+16,3,c3)}
    </svg></div>`;
  }

  // ── 默認：手鏈（圓環+珠子） ──
  const cx=W/2, cy=H/2;
  const R=24, beadR=5, beadCount=8;
  let beads='';
  for(let i=0;i<beadCount;i++){
    const ang=i*(2*Math.PI/beadCount)-Math.PI/2;
    const bx=cx+R*Math.cos(ang), by=cy+R*Math.sin(ang);
    const bc=isRainbow?rc[i%rc.length]:c;
    beads+=bead(bx,by,beadR,bc);
  }
  // 穿繩（圓環）
  return `<div style="flex:0 0 auto">${hdr}
    <circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="#a08060" stroke-width="1.5" opacity="0.3"/>
    ${beads}
  </svg></div>`;
}

function smartRecommend(bazi, type, maxItems){
  maxItems = maxItems || 6;
  const need = bazi.fav[0]; // 喜用神第一位
  const need2 = bazi.fav[1]; // 喜用神第二位
  
  // ** 關鍵修正：取得忌神列表，排除忌神五行的商品 **
  const avoidEls = new Set();
  if(bazi.unfav){
    bazi.unfav.forEach(u => avoidEls.add(u));
  }
  
  const results = [];
  const seen = new Set();

  function isAllowed(item){
    // 五行「全」的商品永遠允許
    if(item.el === '全') return true;
    // 忌神五行的商品排除
    if(avoidEls.has(item.el)) return false;
    return true;
  }

  function add(item, priority){
    if(seen.has(item.n)) return;
    if(!isAllowed(item)) return; // 忌神排除
    seen.add(item.n);
    results.push({...item, _priority: priority||0});
  }

  // 1) 問題類型特殊推薦（最高優先，但仍受忌神過濾）
  if(type==='love'){
    (REAL_PRODUCTS.love_special||[]).forEach(p=>add(p,100));
    (REAL_PRODUCTS.necklace||[]).filter(p=>(p.tags||[]).includes('愛情')).forEach(p=>add(p,90));
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('愛情')).forEach(p=>add(p,85));
  }
  if(type==='career'){
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('事業')).forEach(p=>add(p,100));
    /* 鈦晶屬金，只有喜用神含金才推 */
    if(!avoidEls.has('金')) (REAL_PRODUCTS.金||[]).filter(p=>p.n.includes('鈦晶')).forEach(p=>add(p,95));
    /* 水行的黑髮晶也適合事業 */
    (REAL_PRODUCTS.水||[]).filter(p=>(p.tags||[]).includes('事業')).forEach(p=>add(p,90));
    (REAL_PRODUCTS.necklace||[]).filter(p=>(p.tags||[]).includes('事業')).forEach(p=>add(p,85));
  }
  if(type==='wealth'){
    /* 招財水晶要過忌神濾：黃水晶屬土、鈦晶屬金、綠幽靈屬木 */
    if(!avoidEls.has('土')) (REAL_PRODUCTS.土||[]).filter(p=>p.n.includes('黃水晶')).forEach(p=>add(p,100));
    if(!avoidEls.has('木')) (REAL_PRODUCTS.木||[]).filter(p=>p.n.includes('綠幽靈')||p.n.includes('抹茶')).forEach(p=>add(p,95));
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('財運')).forEach(p=>add(p,90));
    if(!avoidEls.has('金')) (REAL_PRODUCTS.金||[]).filter(p=>p.n.includes('鈦晶')).forEach(p=>add(p,85));
  }
  if(type==='health'){
    (REAL_PRODUCTS.special||[]).filter(p=>(p.tags||[]).includes('健康')).forEach(p=>add(p,100));
    if(!avoidEls.has('火')) (REAL_PRODUCTS.火||[]).filter(p=>p.n.includes('紫水晶')).forEach(p=>add(p,95));
    if(!avoidEls.has('土')) (REAL_PRODUCTS.土||[]).filter(p=>p.n.includes('茶晶')).forEach(p=>add(p,85));
  }

  // 2) 喜用神五行商品（一定是安全的，因為喜用神不會是忌神）
  const elProducts = REAL_PRODUCTS[need] || [];
  elProducts.forEach(p => add(p, 70));
  if(need2 && REAL_PRODUCTS[need2]){
    REAL_PRODUCTS[need2].slice(0,3).forEach(p => add(p, 50));
  }

  // 3) 五行設計款 / 超七（全方位，el='全' 永遠允許）
  (REAL_PRODUCTS.special||[]).filter(p=>p.el==='全').forEach(p=>add(p,40));

  // 4) 辟邪類（凶的時候優先，也要過濾忌神）
  const prob = parseFloat((document.getElementById('r-vprob')||{}).textContent)||50;
  if(prob < 40){
    (REAL_PRODUCTS.protection||[]).forEach(p=>add(p,80));
  }

  // 5) 項鍊類補充（過濾忌神）
  (REAL_PRODUCTS.necklace||[]).forEach(p=>add(p,20));

  // Sort by priority desc, then pick top N
  results.sort((a,b)=>b._priority-a._priority);

  // Ensure price diversity: at least 1 under $500, 1 mid, 1 high
  const final = [];
  const low = results.filter(r=>{const p=parseFloat(r.price.replace(/[^0-9]/g,''));return p<=500});
  const mid = results.filter(r=>{const p=parseFloat(r.price.replace(/[^0-9]/g,''));return p>500&&p<=3000});
  const high = results.filter(r=>{const p=parseFloat(r.price.replace(/[^0-9]/g,''));return p>3000});

  if(low[0]) final.push(low[0]);
  if(mid[0]) final.push(mid[0]);
  if(high[0]) final.push(high[0]);

  // Fill remaining from sorted results
  results.forEach(r=>{
    if(final.length>=maxItems) return;
    if(!final.find(f=>f.n===r.n)) final.push(r);
  });

  return final.slice(0, maxItems);
}

/* Override renderProductCrystal to use smart recommend */
const _origRenderProductCrystal = typeof renderProductCrystal === 'function' ? renderProductCrystal : null;
renderProductCrystal = function(bazi, type){
  const need = bazi.fav[0];
  const products = smartRecommend(bazi, type, 6);
  const catIcon = {手鏈:'⌚', 項鍊:'📿', 吊墜:'🏷️', 裸石:'💍', 客製:'✨'};

  document.getElementById('r-crystal').innerHTML = `
    <div class="crystal-rec-header">
      <p>根據你的命盤（喜用 <span class="tag tag-gold">${need}行</span>）和問題（<span class="tag tag-blue">${getTypeLabel(type)}</span>），從我們賣場精選：</p>
    </div>
    <div class="product-grid">${products.map(p=>`
      <div class="product-card">
        ${p.img?`<img class="product-img" src="${p.img}" alt="${p.n}" onerror="this.outerHTML=getCrystalVisual(${JSON.stringify({n:p.n,cat:p.cat}).replace(/"/g,'&quot;')})">`:(typeof getCrystalVisual==='function'?getCrystalVisual(p):`<div class="product-icon">${p.icon}</div>`)}
        <div class="product-body">
          <div class="product-name">${p.n}</div>
          <div class="product-meta">
            <span class="tag tag-gold text-xs">${catIcon[p.cat]||'💍'} ${p.cat}</span>
            ${p.el!=='全'?`<span class="el-tag el-${p.el} text-xs">${p.el}行</span>`:'<span class="tag text-xs" style="background:linear-gradient(90deg,#c00,#fc0,#0a0,#08f,#a78b5a);color:#fff;-webkit-background-clip:text;-webkit-text-fill-color:transparent;border:1px solid rgba(212,175,55,.4)">五行全</span>'}
          </div>
          <p class="product-desc">${p.d}</p>
          <p class="product-price">${p.price}</p>
          <p class="product-wear"><i class="fas fa-hand-holding-heart"></i> ${p.wear}</p>
          <div class="product-actions">
            <a href="${p.shopee}" target="_blank" rel="noopener" class="product-btn shopee"><i class="fas fa-shopping-cart"></i> 蝦皮</a>
            <a href="${p.seven}" target="_blank" rel="noopener" class="product-btn seven"><i class="fas fa-box"></i> 7-11</a>
          </div>
        </div>
      </div>`).join('')}
    </div>
    <div class="custom-cta mt-lg">
      <button class="btn btn-gold btn-full" onclick="openCustomModal()">
        <i class="fas fa-magic"></i> 依你五行專屬搭配 ─ 點我客製
      </button>
      <p class="text-xs text-muted mt-sm text-center">預算版 $1,000 起 ｜ 48hr 內回覆 ｜ 含占卜分析摘要</p>
    </div>
    <p class="text-xs text-muted mt-md text-center"><i class="fas fa-info-circle"></i> 以上商品皆為賣場現貨。點擊蝦皮或7-11直接選購，水晶效果因人而異。</p>`;
};
/* =============================================================
   1) 商品卡「限時提醒」— 庫存數 + 今日N人看遍
   ============================================================= */
function getUrgencyHTML(productName){
  // Removed fake stock/view counts - only show if real data available
  return '';
}

/* =============================================================
   2) 社會認同數據
   ============================================================= */
function getSocialProofHTML(element, type){
  // Removed fabricated statistics - return empty until real data available
  return '';
}

/* =============================================================
   3) 首頁計數器 + 跑馬燈
   ============================================================= */
function initLiveCounter(){
  // Counter removed - no real statistics available
}

/* =============================================================
   4) 分享後顯示專屬折扣碼（真實蝦皮折扣碼）
   ============================================================= */
/* 折扣碼以混淆形式存放，防止直接從原始碼複製 */
/* 折扣碼以數值混淆形式存放 */
const _dc=[
  [68,56,51,75,71,71,74,55,55],
  [68,56,51,75,74,77,92,56,56],
  [68,56,51,75,82,78,55,58,52],
  [68,56,51,75,90,90,73,55,56],
  [68,56,51,75,86,73,58,59,53],
  [68,56,51,75,92,75,73,58,59],
  [68,56,51,75,86,73,59,58,59],
  [68,56,51,75,88,77,56,58,55],
  [68,56,51,75,72,54,54,54],
  [68,56,51,75,72,56,56,53]
];
function _dd(a){return a.map(c=>String.fromCharCode(c-3)).join('')}

function generateDiscountCode(){
  /* 每位用戶只能拿到一個碼，綁定瀏覽器指紋 */
  const fp = navigator.userAgent.length + screen.width + screen.height;
  const idx = fp % _dc.length;
  return _dd(_dc[idx]);
}

function showDiscountAfterShare(){
  const el = document.getElementById('discount-reveal');
  if(!el) return;
  
  /* 防護：同一裝置 24 小時內只能領一次 */
  const lastClaim = localStorage.getItem('jy_last_claim');
  const now = Date.now();
  if(lastClaim && (now - parseInt(lastClaim)) < 86400000){
    const hrs = Math.ceil((86400000 - (now - parseInt(lastClaim))) / 3600000);
    alert('你已經領過折扣碼了！\n\n' + hrs + ' 小時後可再次領取。');
    return;
  }
  
  el.classList.remove('hidden');
  
  /* 延遲顯示：先遮罩，倒數 5 秒後才揭示完整碼 */
  const code = generateDiscountCode();
  const codeEl = document.getElementById('discount-code');
  const masked = code.slice(0,4) + '•••••';
  codeEl.textContent = masked;
  codeEl.style.opacity = '0.5';
  
  let countdown = 5;
  const timer = document.getElementById('discount-timer');
  if(timer) timer.textContent = countdown + ' 秒後顯示完整折扣碼';
  
  const iv = setInterval(()=>{
    countdown--;
    if(timer) timer.textContent = countdown + ' 秒後顯示完整折扣碼';
    if(countdown <= 0){
      clearInterval(iv);
      codeEl.textContent = code;
      codeEl.style.opacity = '1';
      if(timer) timer.textContent = '折扣碼已解鎖！請在蝦皮結帳時輸入';
      localStorage.setItem('jy_last_claim', String(Date.now()));
    }
  }, 1000);
}

function copyDiscountCode(){
  const code = document.getElementById('discount-code').textContent;
  navigator.clipboard.writeText(code).then(()=>{
    alert('折扣碼已複製！去蝦皮下單時貼上即可使用 ✨');
  }).catch(()=>{
    prompt('複製此折扣碼：', code);
  });
}

// Patch shareToUnlock — 強化分享驗證
const _origShareToUnlock = shareToUnlock;
let _shareAttempts = 0;
shareToUnlock = function(){
  const url = window.location.href.split('?')[0];
  const text = '我剛用「靜月之光」測了命理結果，超準！免費測你的 👉 ';
  
  /* 防護：必須完成占卜才能分享（防機器人直接觸發） */
  if(!S.bazi){
    alert('請先完成占卜分析再分享哦！');
    return;
  }
  
  if(navigator.share){
    navigator.share({title:'靜月之光占卜',text:text,url:url}).then(()=>{
      hasShared=true; updateShareGate(); showDiscountAfterShare();
      if(typeof incrementAchievement==='function') incrementAchievement('shares',1);
    }).catch(()=>{
      showShareHint('分享取消了，完成分享才能取得折扣碼哦 😊');
    });
  }else{
    /* 桌面版：複製連結後要求二次確認 + 延遲 */
    _shareAttempts++;
    navigator.clipboard.writeText(text+url).then(()=>{
      /* 第一次按：只複製，提示去分享 */
      if(_shareAttempts <= 1){
        alert('分享連結已複製到剪貼簿！✨\n\n請貼到 LINE / IG / FB 分享給朋友。\n分享完成後，回來再按一次「分享」按鈕領取折扣碼。');
        return;
      }
      /* 第二次按：才給碼（至少經過一次複製動作） */
      const confirmed = confirm(
        '確認你已經把連結分享給朋友了嗎？\n\n按「確定」領取 9 折折扣碼。'
      );
      if(confirmed){
        hasShared=true; updateShareGate(); showDiscountAfterShare();
        if(typeof incrementAchievement==='function') incrementAchievement('shares',1);
      }
    }).catch(()=>{
      prompt('複製以下連結分享給朋友：', text+url);
    });
  }
};

/* =============================================================
   5) PWA 安裝提示橫幅
   ============================================================= */
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', function(e){
  e.preventDefault();
  deferredInstallPrompt = e;
  showPWABanner();
});

function showPWABanner(){
  const banner = document.getElementById('pwa-banner');
  if(!banner) return;
  if(sessionStorage.getItem('pwa_dismissed')) return;
  banner.classList.remove('hidden');
  // Auto dismiss after 8 seconds
  setTimeout(()=>hidePWABanner(), 8000);
}

function installPWA(){
  if(deferredInstallPrompt){
    deferredInstallPrompt.prompt();
    deferredInstallPrompt.userChoice.then(function(choice){
      if(choice.outcome==='accepted') console.log('PWA installed');
      deferredInstallPrompt = null;
      hidePWABanner();
    });
  }else{
    // iOS fallback
    alert('請點擊瀏覽器的「分享」按鈕 → 選擇「加入主畫面」即可安裝！');
    hidePWABanner();
  }
}

function hidePWABanner(){
  const banner = document.getElementById('pwa-banner');
  if(banner) banner.classList.add('hidden');
  sessionStorage.setItem('pwa_dismissed','1');
}

/* =============================================================
   6) AI 風格個人化總結
   ============================================================= */
function generateAIConclusion(type, prob, bazi, mh, tarot){
  const name = S.form.name || '你';
  const dm = bazi ? bazi.dm : '';
  const dmEl = bazi ? bazi.dmEl : '';
  const strong = bazi ? bazi.strong : true;
  const fav = bazi ? bazi.fav[0] : '';
  const curDy = bazi ? (bazi.dayun.find(d=>d.isCurrent)||{}) : {};
  const tl = getTypeLabel(type);

  // Opening — personal touch
  let lines = [];
  if(name!=='你') lines.push(`${name}，看完你的命盤，我想跟你說幾句真心話。`);
  else lines.push(`看完你的命盤，我想跟你說幾句真心話。`);

  // BaZi personality insight
  if(bazi){
    const personality = {
      甲:'你像一棵大樹，外表堅定但內心渴望陽光。',
      乙:'你像柔軟的藤蔓，看似溫柔實則韌性十足。',
      丙:'你像太陽一樣溫暖，天生就有感染力。',
      丁:'你像燭光般細膩，善於觀察與照顧他人。',
      戊:'你像大山一樣穩重，值得信賴但有時太固執。',
      己:'你像田園沃土，包容性強但容易委屈自己。',
      庚:'你像寶劍般果斷，做事乾脆但有時太急。',
      辛:'你像珠寶般精緻，追求完碧但容易想太多。',
      壬:'你像大海般寬廣，想法多但容易分散精力。',
      癸:'你像細雨般溫潤，直覺強但容易猶豫不決。'
    };
    lines.push(personality[dm]||'');
    lines.push(`身${strong?'強':'弱'}的你，${strong?'能量充沛，但要注意別太衝動':'需要更多支持，適合借力使力'}。`);
  }

  // Current situation reading
  if(prob >= 70){
    lines.push(`從你的命盤來看，現在的你確實站在一個好位置上。${curDy.gz?'「'+curDy.gz+'」大運':'當前運勢'}給了你助力，問${tl}的結果是偏向樂觀的。`);
    lines.push('但好運不是等來的 — 是你準備好了，機會才看得見你。');
  }else if(prob >= 45){
    lines.push(`說實話，你現在的狀況是「有機會但有阻力」。${tl}這件事不是不行，而是需要更聰明的做法。`);
    lines.push('我的建議是：不要全押，先小範圍試水溫，有正向回饋再放大。');
  }else{
    lines.push(`我必須坦白說，目前的象徵不太支持你在${tl}上大動作。`);
    lines.push(`這不代表你不好 — 是時機還沒到。與其硬捨，不如先${fav?'補'+fav+'行能量，':''}調整狀態，等更好的時機再出手。`);
  }

  // Meihua
  if(mh){
    lines.push(`梅花易數給了你一個有趣的信號：「${mh.ben.n}」→「${mh.bian.n}」，${mh.ty.r==='生'?'體用相生，事情的發展方向是有利的':mh.ty.r==='同'?'體用比和，維持現狀不會出大問題':mh.ty.r==='剋'?'體用相剋，要特別注意細節和時機':'需要更多耐心卻等待'}。`);
  }

  // Tarot
  if(tarot && tarot.drawn && tarot.drawn.length){
    const core = tarot.drawn[0];
    const fin = tarot.drawn[9];
    lines.push(`塔羅的核心牌是「${core.n}」${core.isUp?'正位':'逆位'} — ${core.isUp?'這張牌告訴你，你問的方向是對的':'這張牌提醒你，可能需要換個角度思考'}。`);
    if(fin) lines.push(`最終結果牌「${fin.n}」${fin.isUp?'正位，整體走向是正面的':'逆位，結果可能跟預期不同，但不一定是壞事'}。`);
  }

  // Crystal advice as personal recommendation
  if(fav){
    lines.push(`最後，如果你想從能量層面幫自己一把，我建議你佩戴${fav}行的水晶。不是迷信，是給自己一個「提醒物」— 每次看到手上的水晶，就想起今天的決定和方向。`);
  }

  // Closing
  const closings = [
    '記住，命理是方向盤，不是定速巡航。方向對了，速度由你決定。',
    '最後送你一句：盡人事，聽天命。你已經在「盡人事」了，這很好。',
    '命盤是地圖，路還是你自己走的。加油。',
    '做好準備，然後相信自己的判斷。祝一切順利 ✨'
  ];
  lines.push(closings[Math.floor(Math.random()*closings.length)]);

  return lines.filter(l=>l).map(l=>`<p>${l}</p>`).join('');
}

/* =============================================================
   7) 7天後提醒再測（日曆事件）
   ============================================================= */
function addReminder7Days(){
  const now = new Date();
  const remind = new Date(now.getTime() + 7*24*60*60*1000);
  const fmt = d => d.toISOString().replace(/[-:]/g,'').replace(/\.\d+/,'');

  const icsContent = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//靜月之光//占卜提醒//ZH',
    'BEGIN:VEVENT',
    'DTSTART:' + fmt(remind),
    'DTEND:' + fmt(new Date(remind.getTime()+30*60*1000)),
    'SUMMARY:⏰ 靜月之光：該回來測一下運勢了！',
    'DESCRIPTION:上次測的結果已經過了7天，運勢可能有變化。\\n免費再測一次：' + window.location.href.split('?')[0],
    'URL:' + window.location.href.split('?')[0],
    'TRANSP:TRANSPARENT',
    'BEGIN:VALARM',
    'TRIGGER:-PT10M',
    'ACTION:DISPLAY',
    'DESCRIPTION:靜月之光占卜提醒',
    'END:VALARM',
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');

  const blob = new Blob([icsContent], {type:'text/calendar;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = '靜月占卜提醒.ics';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),3000);

  // Visual feedback
  const btn = document.getElementById('btn-remind');
  if(btn){
    btn.innerHTML = '<i class="fas fa-check"></i> 已加入日曆！';
    btn.disabled = true;
  }
}

/* =============================================================
   Patch renderProductCrystal to include urgency + social proof
   ============================================================= */
const _origRPC2 = renderProductCrystal;
renderProductCrystal = function(bazi, type){
  _origRPC2(bazi, type);
};

/* =============================================================
   Patch conclusion to use AI style
   ============================================================= */
const _origGenConclusion = generateConclusion;
generateConclusion = function(type, prob, bazi, mh, tarot){
  return generateAIConclusion(type, prob, bazi, mh, tarot);
};

/* =============================================================
   Init on DOMContentLoaded
   ============================================================= */
document.addEventListener('DOMContentLoaded', function(){
  initLiveCounter();
  // Show PWA banner after 5 seconds for iOS
  setTimeout(function(){
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    if(!isStandalone) showPWABanner();
  }, 5000);
});
/* =============================================================
   FEATURE 1: 每日運勢籤（依命主八字 × 當日天干地支）
   ============================================================= */

/* 計算當日天干地支 */
function getTodayGanZhi(){
  const today = new Date();
  const y = today.getFullYear(), m = today.getMonth()+1, d = today.getDate();
  const base = new Date(1900, 0, 1);
  const tgt = new Date(y, m-1, d);
  const diff = Math.floor((tgt - base) / 864e5);
  const dayCycle = ((diff + 10) % 60 + 60) % 60;
  const dGi = dayCycle % 10, dZi = dayCycle % 12;
  // 年干支
  let ly = y;
  if(m < 2 || (m === 2 && d < 4)) ly--;
  const yGi = ((ly-4)%10+10)%10, yZi = ((ly-4)%12+12)%12;
  return {
    dayGan: TG[dGi], dayZhi: DZ[dZi], dayEl: WX_G[TG[dGi]],
    yearGan: TG[yGi], yearZhi: DZ[yZi],
    dGi, dZi, yGi, yZi
  };
}

/* 依命主八字×當日干支計算真實運勢 */
function computeRealFortune(bazi){
  const today = getTodayGanZhi();
  const dm = bazi.dm, dmEl = bazi.dmEl;
  const todayEl = today.dayEl;
  const todayGan = today.dayGan;
  const todayZhi = today.dayZhi;

  let score = 50; // 基礎分

  // 1. 當日天干與日主的十神關係
  const god = tenGod(dm, todayGan);
  const godScores = {
    '比肩': 8, '劫財': 3,
    '食神': 10, '傷官': 2,
    '偏財': 7, '正財': 12,
    '七殺': -8, '正官': 5,
    '偏印': 6, '正印': 10
  };
  score += (godScores[god] || 0);

  // 2. 當日五行是否為喜用神
  if(bazi.fav.includes(todayEl)) score += 15;
  if(bazi.unfav.includes(todayEl)) score -= 15;

  // 3. 當日地支藏干是否有喜用神
  const todayCG = CG[todayZhi] || [];
  todayCG.forEach(g => {
    if(bazi.fav.includes(WX_G[g])) score += 4;
    if(bazi.unfav.includes(WX_G[g])) score -= 4;
  });

  // 4. 當日地支與命盤地支的沖合（簡化）
  const CHONG = {子:'午',丑:'未',寅:'申',卯:'酉',辰:'戌',巳:'亥',午:'子',未:'丑',申:'寅',酉:'卯',戌:'辰',亥:'巳'};
  const HE = {子:'丑',丑:'子',寅:'亥',卯:'戌',辰:'酉',巳:'申',午:'未',未:'午',申:'巳',酉:'辰',戌:'卯',亥:'寅'};
  const dayZhi = bazi.pillars.day.zhi;
  if(CHONG[todayZhi] === dayZhi) score -= 12; // 沖日支
  if(HE[todayZhi] === dayZhi) score += 10;    // 合日支

  // 5. 十二長生狀態
  const csState = changSheng(dm, todayZhi);
  const csScores = {'長生':10,'沐浴':2,'冠帶':6,'臨官':8,'帝旺':12,'衰':-2,'病':-5,'死':-8,'墓':-6,'絕':-10,'胎':1,'養':3};
  score += (csScores[csState] || 0);

  // 6. 大運流年加成
  const curDayun = bazi.dayun.find(d => d.isCurrent);
  if(curDayun){
    if(bazi.fav.includes(curDayun.el)) score += 5;
    if(bazi.unfav.includes(curDayun.el)) score -= 5;
  }

  // 限制範圍 10-95
  score = Math.max(10, Math.min(95, score));

  // 對應籤等
  let sign, icon, msg;
  if(score >= 85)      { sign='上上籤'; icon='🌟'; msg='諸事皆宜，今日天時與命盤高度契合，把握機會！'; }
  else if(score >= 75) { sign='大吉籤'; icon='🍊'; msg='天時地利人和，今日運勢旺盛，適合重要決定。'; }
  else if(score >= 65) { sign='上吉籤'; icon='✨'; msg='貴人星動，行動力強，積極推進事務有佳績。'; }
  else if(score >= 55) { sign='中吉籤'; icon='🌙'; msg='穩中求進，內在能量充沛，適合規劃與學習。'; }
  else if(score >= 45) { sign='小吉籤'; icon='🌤️'; msg='小有進展，耐心等待時機，勿急躁冒進。'; }
  else if(score >= 35) { sign='中平籤'; icon='☁️'; msg='順其自然，今日宜守不宜攻，韜光養晦。'; }
  else if(score >= 25) { sign='小凶籤'; icon='🌊'; msg='運勢低迷，注意人際摩擦，凡事多留退路。'; }
  else                 { sign='凶籤';   icon='⚡'; msg='沖煞之日，宜靜不宜動，避免重大決策與衝突。'; }

  // 推薦水晶：依喜用神五行推薦
  const favEl = bazi.fav[0] || dmEl;
  const crystalMap = {
    '金': [{n:'鈦晶',reason:'強化正財磁場，補金行能量'},{n:'白水晶',reason:'淨化氣場，金行守護石'}],
    '木': [{n:'綠幽靈',reason:'招引貴人與正財，木行生發力'},{n:'東陵玉',reason:'帶來生長與希望能量'}],
    '水': [{n:'海藍寶',reason:'增強溝通力，水行流通能量'},{n:'月光石',reason:'增強直覺，照亮內心方向'}],
    '火': [{n:'紅瑪瑙',reason:'激發勇氣與行動力，火行旺盛'},{n:'紫水晶',reason:'提升思緒清晰度與直覺'}],
    '土': [{n:'黃水晶',reason:'招偏財，提升耐心與自信'},{n:'茶晶',reason:'穩定心性，排除浮躁能量'}]
  };
  const crystalList = crystalMap[favEl] || crystalMap['土'];
  const crystal = crystalList[Math.abs(score) % crystalList.length];

  return {
    sign, icon, msg, score, crystal: crystal.n, crystalReason: crystal.reason,
    el: favEl, god, csState, todayGZ: todayGan + todayZhi, todayEl,
    detail: {
      godDesc: `今日天干${todayGan}(${todayEl})對你為【${god}】`,
      favHit: bazi.fav.includes(todayEl) ? '✓ 當日五行為你的喜用神' : (bazi.unfav.includes(todayEl) ? '✗ 當日五行為你的忌神' : '— 當日五行中性'),
      csDesc: `日主在今日地支${todayZhi}處【${csState}】位`,
      chong: CHONG[todayZhi] === dayZhi ? `⚠ 今日地支${todayZhi}沖你日支${dayZhi}` : null,
      he: HE[todayZhi] === dayZhi ? `✓ 今日地支${todayZhi}合你日支${dayZhi}` : null
    }
  };
}

function renderDailyFortune(){
  const container = document.getElementById('daily-fortune-content');
  if(!container) return;

  // 必須先填寫基本資料
  if(!S.bazi){
    container.innerHTML = `
      <div class="fortune-draw-area">
        <div class="fortune-urn" style="opacity:0.5">🔒</div>
        <p class="text-dim" style="margin-bottom:var(--sp-md)">需要先完成基本資料（生日時辰），才能依你的八字計算今日運勢</p>
        <button class="btn btn-primary" onclick="goStep(0);window.scrollTo({top:0,behavior:'smooth'})">
          <i class="fas fa-pen"></i> 前往填寫資料
        </button>
      </div>`;
    return;
  }

  const today = new Date().toISOString().slice(0,10);
  const key = 'jy_real_fortune_' + today;
  let cached = null;
  try{ cached = JSON.parse(localStorage.getItem(key)); }catch(e){}

  if(cached && cached.drawn){
    showFortuneResult(cached);
  } else {
    container.innerHTML = `
      <div class="fortune-draw-area">
        <div class="fortune-urn">🏮</div>
        <p class="text-dim">依你的八字命盤 × 今日干支，算出專屬運勢</p>
        <p class="text-xs text-muted mb-sm">日主：${S.bazi.dm}（${S.bazi.dmEl}）｜ 喜用：${S.bazi.fav.join('、')}</p>
        <button class="btn btn-gold" onclick="drawDailyFortune()" id="btn-draw-fortune">
          <i class="fas fa-hand-sparkles"></i> 抽今日運勢籤
        </button>
      </div>`;
  }
}

function drawDailyFortune(){
  if(!S.bazi){ alert('請先填寫基本資料（生日時辰）'); return; }
  const btn = document.getElementById('btn-draw-fortune');
  if(btn){ btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> 推算中...'; }

  incrementAchievement('daily_streak');

  setTimeout(()=>{
    const fortune = computeRealFortune(S.bazi);
    fortune.drawn = true;
    const today = new Date().toISOString().slice(0,10);
    try{
      // 清理舊資料
      for(let i=localStorage.length-1;i>=0;i--){
        const k=localStorage.key(i);
        if(k&&k.startsWith('jy_real_fortune_')&&!k.endsWith(today)) localStorage.removeItem(k);
      }
      localStorage.setItem('jy_real_fortune_'+today, JSON.stringify(fortune));
    }catch(e){}
    showFortuneResult(fortune);
  }, 1500);
}

function showFortuneResult(f){
  const container = document.getElementById('daily-fortune-content');
  if(!container) return;

  const prod = findProductByName(f.crystal);
  const scoreColor = f.score>=60?'var(--c-success)':f.score>=40?'var(--c-warn)':'var(--c-danger)';

  container.innerHTML = `
    <div class="fortune-result" style="animation:scaleIn 0.5s ease">
      <div class="fortune-sign-icon">${f.icon}</div>
      <div class="fortune-sign-text">${f.sign}</div>
      <p class="fortune-msg">${f.msg}</p>
      <div style="margin:var(--sp-sm) 0;font-size:0.85rem;color:var(--c-text-dim)">
        今日干支：<span class="tag tag-gold">${f.todayGZ}</span>
        <span style="color:${scoreColor};font-weight:700;margin-left:var(--sp-sm)">運勢分數 ${f.score}</span>
      </div>
      <div style="background:rgba(0,0,0,0.2);border-radius:var(--r-md);padding:var(--sp-sm) var(--sp-md);margin:var(--sp-sm) 0;font-size:0.8rem;color:var(--c-text-dim);line-height:1.8">
        <p>${f.detail.godDesc}</p>
        <p>${f.detail.favHit}</p>
        <p>${f.detail.csDesc}</p>
        ${f.detail.chong?'<p style="color:var(--c-danger)">'+f.detail.chong+'</p>':''}
        ${f.detail.he?'<p style="color:var(--c-success)">'+f.detail.he+'</p>':''}
      </div>
      <div class="fortune-divider"></div>
      <div class="fortune-crystal-rec">
        <p class="text-sm"><strong>今日推薦水晶（依喜用神${f.el}行）：</strong></p>
        <div class="fortune-crystal-card">
          <span class="fortune-crystal-name">${f.crystal}</span>
          <span class="el-tag el-${f.el} text-xs">${f.el}行</span>
        </div>
        <p class="text-xs text-dim">${f.crystalReason}</p>
        <div class="fortune-buy-btns mt-sm">
          <a href="${prod?prod.shopee:'https://tw.shp.ee/2n5Mo2w'}" target="_blank" rel="noopener" class="product-btn shopee"><i class="fas fa-shopping-cart"></i> 蝦皮入手</a>
          <a href="${prod?prod.seven:'https://myship.7-11.com.tw/seller/profile?id=GM2601091690232'}" target="_blank" rel="noopener" class="product-btn seven"><i class="fas fa-box"></i> 7-11</a>
        </div>
      </div>
      <p class="text-xs text-muted mt-md">明天可以再抽一次 ✨ 每日 00:00 重置</p>
    </div>`;
}

function findProductByName(name){
  for(const el of Object.values(REAL_PRODUCTS)){
    if(!Array.isArray(el)) continue;
    const found = el.find(p=>p.n.includes(name));
    if(found) return found;
  }
  return null;
}

/* =============================================================
   FEATURE 2: 成就徽章系統
   ============================================================= */
const ACHIEVEMENTS = [
  {id:'first',name:'初次問卦',icon:'🌱',desc:'完成第一次占卜',need:1},
  {id:'curious',name:'好奇寶寶',icon:'🔍',desc:'累計占卜 3 次',need:3},
  {id:'seeker',name:'命理换索者',icon:'🧭',desc:'累計占卜 5 次',need:5},
  {id:'devoted',name:'虔誠信徒',icon:'🙏',desc:'累計占卜 10 次',need:10},
  {id:'master',name:'占卜大師',icon:'🧙',desc:'累計占卜 20 次',need:20},
  {id:'crystal',name:'水晶達人',icon:'💍',desc:'查看水晶百科 5 種以上',need:5,type:'crystal_views'},
  {id:'sharer',name:'分享王',icon:'📣',desc:'分享結果給朋友',need:1,type:'shares'},
  {id:'daily',name:'每日報到',icon:'📅',desc:'連續 3 天抽運勢籤',need:3,type:'daily_streak'},
  {id:'alltype',name:'全能問卦師',icon:'🍭',desc:'問遍 5 種不同類型的問題',need:5,type:'types_asked'}
];

function getAchievementData(){
  try{
    return JSON.parse(localStorage.getItem('jy_achievements')||'{}');
  }catch(e){ return {}; }
}

function saveAchievementData(data){
  try{ localStorage.setItem('jy_achievements', JSON.stringify(data)); }catch(e){}
}

function incrementAchievement(type, value){
  const data = getAchievementData();
  if(!data.counts) data.counts={};
  if(type === 'divination'){
    data.counts.divination = (data.counts.divination||0) + 1;
  } else if(type === 'crystal_views'){
    if(!data.counts.crystal_views) data.counts.crystal_views = new Set();
    // Sets don't serialize well, use array
    if(!Array.isArray(data.counts.crystal_views)) data.counts.crystal_views = [];
    if(!data.counts.crystal_views.includes(value)){
      data.counts.crystal_views.push(value);
    }
  } else if(type === 'shares'){
    data.counts.shares = (data.counts.shares||0) + 1;
  } else if(type === 'types_asked'){
    if(!Array.isArray(data.counts.types_asked)) data.counts.types_asked = [];
    if(value && !data.counts.types_asked.includes(value)){
      data.counts.types_asked.push(value);
    }
  } else if(type === 'daily_streak'){
    const today = new Date().toISOString().slice(0,10);
    if(!data.counts.daily_dates) data.counts.daily_dates = [];
    if(!data.counts.daily_dates.includes(today)){
      data.counts.daily_dates.push(today);
    }
    // Calculate streak
    data.counts.daily_streak = calcStreak(data.counts.daily_dates);
  }
  saveAchievementData(data);
  checkNewAchievements(data);
}

function calcStreak(dates){
  if(!dates||!dates.length) return 0;
  const sorted = [...dates].sort().reverse();
  let streak = 1;
  for(let i=1;i<sorted.length;i++){
    const prev = new Date(sorted[i-1]);
    const curr = new Date(sorted[i]);
    const diff = (prev - curr) / (1000*60*60*24);
    if(diff === 1) streak++;
    else break;
  }
  return streak;
}

function checkNewAchievements(data){
  if(!data.counts) return;
  if(!data.unlocked) data.unlocked = [];
  
  ACHIEVEMENTS.forEach(a=>{
    if(data.unlocked.includes(a.id)) return;
    let count = 0;
    if(!a.type || a.type === 'divination') count = data.counts.divination || 0;
    else if(a.type === 'crystal_views') count = (data.counts.crystal_views||[]).length;
    else if(a.type === 'shares') count = data.counts.shares || 0;
    else if(a.type === 'daily_streak') count = data.counts.daily_streak || 0;
    else if(a.type === 'types_asked') count = (data.counts.types_asked||[]).length;
    
    if(count >= a.need){
      data.unlocked.push(a.id);
      showAchievementToast(a);
    }
  });
  saveAchievementData(data);
}

function showAchievementToast(a){
  const toast = document.createElement('div');
  toast.className = 'achievement-toast';
  toast.innerHTML = `<span class="at-icon">${a.icon}</span><div><strong>成就解鎖！</strong><br>${a.name}</div>`;
  document.body.appendChild(toast);
  setTimeout(()=>toast.classList.add('show'), 50);
  setTimeout(()=>{toast.classList.remove('show');setTimeout(()=>toast.remove(),500)}, 3500);
}

function renderAchievements(){
  const container = document.getElementById('achievements-grid');
  if(!container) return;
  const data = getAchievementData();
  const unlocked = data.unlocked || [];
  
  container.innerHTML = ACHIEVEMENTS.map(a=>{
    const isUnlocked = unlocked.includes(a.id);
    return `<div class="achievement-badge ${isUnlocked?'unlocked':'locked'}">
      <div class="badge-icon">${isUnlocked?a.icon:'🔒'}</div>
      <div class="badge-name">${a.name}</div>
      <div class="badge-desc text-xs text-muted">${a.desc}</div>
    </div>`;
  }).join('');
  
  const total = ACHIEVEMENTS.length;
  const done = unlocked.length;
  document.getElementById('achievement-progress').textContent = `${done}/${total} 已解鎖`;
}

/* =============================================================
   FEATURE 3: 水晶百科圖鑑
   ============================================================= */
function renderCrystalEncyclopedia(){
  const container = document.getElementById('crystal-encyclopedia-grid');
  if(!container) return;
  
  const allCrystals = [];
  const seen = new Set();
  for(const [category, items] of Object.entries(REAL_PRODUCTS)){
    if(!Array.isArray(items)) continue;
    items.forEach(p=>{
      if(seen.has(p.n)) return;
      seen.add(p.n);
      allCrystals.push({...p, _cat: category});
    });
  }
  
  container.innerHTML = allCrystals.map(c=>`
    <div class="ency-card" onclick="showCrystalDetail('${c.n.replace(/'/g,"\\'")}')">
      <div class="ency-icon">${c.icon}</div>
      <div class="ency-name">${c.n}</div>
      <div class="ency-meta">
        ${c.el!=='全'?`<span class="el-tag el-${c.el} text-xs">${c.el}行</span>`:'<span class="tag text-xs" style="color:var(--c-gold)">五行全</span>'}
        <span class="text-xs text-muted">${c.cat}</span>
      </div>
      <p class="ency-desc">${c.d}</p>
      <p class="ency-price">${c.price}</p>
    </div>`).join('');
}

function showCrystalDetail(name){
  incrementAchievement('crystal_views', name);
  
  let crystal = null;
  for(const items of Object.values(REAL_PRODUCTS)){
    if(!Array.isArray(items)) continue;
    crystal = items.find(p=>p.n === name);
    if(crystal) break;
  }
  if(!crystal) return;
  
  const modal = document.getElementById('crystal-detail-modal');
  if(!modal) return;
  
  modal.innerHTML = `
    <div class="cdm-overlay" onclick="closeCrystalDetail()"></div>
    <div class="cdm-content">
      <button class="cdm-close" onclick="closeCrystalDetail()"><i class="fas fa-times"></i></button>
      <div class="cdm-icon">${crystal.icon}</div>
      <h3 class="cdm-name">${crystal.n}</h3>
      <div class="cdm-tags">
        ${crystal.el!=='全'?`<span class="el-tag el-${crystal.el}">${crystal.el}行</span>`:'<span class="tag" style="color:var(--c-gold)">五行全</span>'}
        <span class="tag tag-gold">${crystal.cat}</span>
      </div>
      <p class="cdm-desc">${crystal.d}</p>
      <div class="cdm-info">
        <div class="cdm-row"><i class="fas fa-tag"></i> 價格：<strong>${crystal.price}</strong></div>
        <div class="cdm-row"><i class="fas fa-hand-holding-heart"></i> 佩戴方式：${crystal.wear}</div>
      </div>
      <div class="cdm-actions">
        <a href="${crystal.shopee}" target="_blank" rel="noopener" class="btn btn-gold"><i class="fas fa-shopping-cart"></i> 蝦皮購買</a>
        <a href="${crystal.seven}" target="_blank" rel="noopener" class="btn btn-outline"><i class="fas fa-box"></i> 7-11</a>
      </div>
    </div>`;
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeCrystalDetail(){
  const modal = document.getElementById('crystal-detail-modal');
  if(modal) modal.classList.add('hidden');
  document.body.style.overflow = '';
}

/* =============================================================
   FEATURE 4: 水晶配對測驗
   ============================================================= */
/* === 題庫：15題隨機抽3題，每次不同組合 === */
const QUIZ_BANK = [
  {q:'面對壓力時，你通常會？',opts:[
    {t:'深呼吸，冷靜分析',el:'水',trait:'理性'},
    {t:'找朋友聊聊傾訴',el:'木',trait:'社交'},
    {t:'立刻行動解決問題',el:'火',trait:'行動'},
    {t:'獨處靜心等靈感',el:'金',trait:'直覺'}
  ]},
  {q:'你最嚮往的生活方式？',opts:[
    {t:'穩定有規律的日常',el:'土',trait:'穩定'},
    {t:'充滿冒險與新鮮感',el:'火',trait:'冒險'},
    {t:'自由自在不受拘束',el:'水',trait:'自由'},
    {t:'和諧溫馨的家庭',el:'木',trait:'溫暖'}
  ]},
  {q:'如果水晶有顏色，最吸引你的是？',opts:[
    {t:'透明 / 白色 — 純淨',el:'金',trait:'純淨'},
    {t:'粉紅 / 紫色 — 浪漫',el:'火',trait:'浪漫'},
    {t:'綠色 / 藍色 — 寧靜',el:'木',trait:'寧靜'},
    {t:'金色 / 棕色 — 大地',el:'土',trait:'踏實'}
  ]},
  {q:'朋友眼中的你是？',opts:[
    {t:'值得信賴的靠山',el:'土',trait:'可靠'},
    {t:'點子王、創意多',el:'火',trait:'創意'},
    {t:'溫柔體貼的傾聽者',el:'水',trait:'溫柔'},
    {t:'行動派的領袖',el:'金',trait:'果斷'}
  ]},
  {q:'週末最想做的事？',opts:[
    {t:'宅在家追劇充電',el:'水',trait:'內斂'},
    {t:'出門走走接觸大自然',el:'木',trait:'自然'},
    {t:'約朋友聚餐聊天',el:'火',trait:'熱情'},
    {t:'整理房間或做計畫',el:'金',trait:'條理'}
  ]},
  {q:'你覺得自己最需要補足的是？',opts:[
    {t:'自信心和行動力',el:'火',trait:'勇氣'},
    {t:'耐心和穩定感',el:'土',trait:'沉穩'},
    {t:'人際關係和桃花',el:'木',trait:'人緣'},
    {t:'財運和事業動力',el:'金',trait:'進取'}
  ]},
  {q:'選一個最能代表你心情的天氣？',opts:[
    {t:'晴空萬里',el:'火',trait:'開朗'},
    {t:'微風徐徐的陰天',el:'金',trait:'沉靜'},
    {t:'綿綿細雨',el:'水',trait:'敏感'},
    {t:'雨後彩虹',el:'木',trait:'希望'}
  ]},
  {q:'挑一個數字？',opts:[
    {t:'1 — 開始',el:'木',trait:'起點'},
    {t:'3 — 變化',el:'火',trait:'變化'},
    {t:'6 — 順利',el:'金',trait:'圓滿'},
    {t:'8 — 豐收',el:'土',trait:'豐盛'}
  ]},
  {q:'你最害怕失卻的是？',opts:[
    {t:'健康',el:'土',trait:'務實'},
    {t:'自由',el:'水',trait:'獨立'},
    {t:'愛情 / 家人',el:'木',trait:'重情'},
    {t:'事業成就',el:'金',trait:'重心'}
  ]},
  {q:'買東西時你最看重？',opts:[
    {t:'CP值高不高',el:'金',trait:'精明'},
    {t:'外型好不好看',el:'火',trait:'美感'},
    {t:'品質耐不耐用',el:'土',trait:'品質'},
    {t:'有沒有特殊意義',el:'水',trait:'寓意'}
  ]},
  {q:'如果有一種超能力，你選？',opts:[
    {t:'讀心術',el:'水',trait:'洞察'},
    {t:'時間暫停',el:'金',trait:'掌控'},
    {t:'瞬間移動',el:'火',trait:'自由'},
    {t:'治癒能力',el:'木',trait:'慈悲'}
  ]},
  {q:'你的睡眠品質如何？',opts:[
    {t:'秒睡到天亮',el:'土',trait:'安穩'},
    {t:'偶爾失眠想太多',el:'水',trait:'多慮'},
    {t:'容易被吵醒',el:'金',trait:'敏銳'},
    {t:'夢很多很精彩',el:'火',trait:'想像力'}
  ]},
  {q:'選一種你喜歡的味道？',opts:[
    {t:'檀香 / 木質',el:'木',trait:'沉穩'},
    {t:'花香 / 獫瑰',el:'火',trait:'浪漫'},
    {t:'海洋 / 清新',el:'水',trait:'清爽'},
    {t:'茶香 / 大地',el:'土',trait:'內斂'}
  ]},
  {q:'你對「命運」的看法？',opts:[
    {t:'三分天注定，七分靠努力',el:'火',trait:'積極'},
    {t:'順其自然就好',el:'水',trait:'隨和'},
    {t:'做好準備，等待時機',el:'金',trait:'謀略'},
    {t:'相信因果，種善因得善果',el:'木',trait:'善良'}
  ]},
  {q:'工作中最讓你有成就感的事？',opts:[
    {t:'完成挑戰性的專案',el:'火',trait:'挑戰'},
    {t:'得到主管或客戶認可',el:'金',trait:'榮譽'},
    {t:'幫助同事解決問題',el:'木',trait:'助人'},
    {t:'存到目標數字的錢',el:'土',trait:'累積'}
  ]}
];

let quizState = {step:0, answers:[], questions:[]};

function startCrystalQuiz(){
  // Shuffle and pick 3 random questions
  const shuffled = [...QUIZ_BANK].sort(()=>Math.random()-0.5);
  quizState = {step:0, answers:[], questions: shuffled.slice(0,3)};
  renderQuizStep();
}

function renderQuizStep(){
  const container = document.getElementById('crystal-quiz-content');
  if(!container) return;
  
  if(quizState.step >= quizState.questions.length){
    showQuizResult();
    return;
  }
  
  const q = quizState.questions[quizState.step];
  const total = quizState.questions.length;
  container.innerHTML = `
    <div class="quiz-progress">第 ${quizState.step+1}/${total} 題</div>
    <div class="quiz-progress-bar"><div class="quiz-fill" style="width:${(quizState.step/total)*100}%"></div></div>
    <h4 class="quiz-question">${q.q}</h4>
    <div class="quiz-options">${q.opts.map((o,i)=>`
      <button class="quiz-option" onclick="answerQuiz(${i})">
        <span>${o.t}</span>
      </button>`).join('')}
    </div>`;
}

function answerQuiz(idx){
  const q = quizState.questions[quizState.step];
  quizState.answers.push(q.opts[idx]);
  quizState.step++;
  renderQuizStep();
}

function showQuizResult(){
  const container = document.getElementById('crystal-quiz-content');
  if(!container) return;
  
  // Count quiz elements
  const elCount = {};
  quizState.answers.forEach(a=>{
    elCount[a.el] = (elCount[a.el]||0) + 1;
  });
  const quizTopEl = Object.entries(elCount).sort((a,b)=>b[1]-a[1])[0][0];
  const traits = quizState.answers.map(a=>a.trait);
  
  // ** 核心修改：以八字喜用神為主，測驗結果為輔 **
  let targetEl = quizTopEl;
  let hasBazi = false;
  let baziNote = '';
  
  if(typeof S !== 'undefined' && S.bazi && S.bazi.fav && S.bazi.fav.length){
    hasBazi = true;
    const favEl = S.bazi.fav[0]; // 第一喜用神
    targetEl = favEl; // 以八字為準
    if(favEl !== quizTopEl){
      baziNote = `<div class="quiz-bazi-note"><i class="fas fa-info-circle"></i> 測驗顯示你偏好「${quizTopEl}行」，但你的八字喜用神是「<strong>${favEl}行</strong>」。依命理卟則，我們以喜用神為你推薦最適合的水晶。</div>`;
    } else {
      baziNote = `<div class="quiz-bazi-match"><i class="fas fa-check-circle"></i> 你的直覺與八字完全吻合！喜用神「<strong>${favEl}行</strong>」正是你最需要的能量。</div>`;
    }
  }
  
  // Find crystal from target element
  const candidates = REAL_PRODUCTS[targetEl] || REAL_PRODUCTS['土'];
  const pick = candidates[Math.floor(Math.random()*Math.min(3,candidates.length))];
  
  container.innerHTML = `
    <div class="quiz-result" style="animation:scaleIn 0.5s">
      <div class="quiz-result-icon">${pick.icon}</div>
      <h3 class="quiz-result-title">你的命定水晶是</h3>
      <div class="quiz-result-crystal">${pick.n}</div>
      <div class="quiz-result-el">
        <span class="el-tag el-${pick.el}">${pick.el}行</span>
        <span class="tag tag-gold">${pick.cat}</span>
      </div>
      ${baziNote}
      <p class="quiz-result-desc">${pick.d}</p>
      <p class="quiz-result-traits text-sm text-dim">你的特質：${traits.join(' · ')}</p>
      ${!hasBazi ? '<p class="text-xs text-muted mt-sm"><i class="fas fa-lightbulb"></i> 提示：先完成「八字占卜」再做測驗，結果會更精準！</p>' : ''}
      <div class="quiz-result-actions mt-md">
        <a href="${pick.shopee}" target="_blank" rel="noopener" class="btn btn-gold"><i class="fas fa-shopping-cart"></i> 去蝦皮擁有它</a>
        <button class="btn btn-outline" onclick="startCrystalQuiz()"><i class="fas fa-redo"></i> 再測一次</button>
      </div>
      <button class="btn btn-outline btn-sm mt-md" onclick="shareQuizResult('${pick.n}','${traits.join('·')}')">
        <i class="fas fa-share-alt"></i> 分享我的命定水晶
      </button>
    </div>`;
}

function shareQuizResult(crystal, traits){
  const text = `我的命定水晶是「${crystal}」！特質：${traits}。你的呢？快來測 👉 `;
  const url = window.location.href.split('?')[0];
  if(navigator.share){
    navigator.share({title:'我的命定水晶',text:text,url:url}).catch(()=>{});
  } else {
    navigator.clipboard.writeText(text+url).then(()=>alert('已複製！貼到 LINE/IG 分享給朋友'));
  }
  incrementAchievement('shares',1);
}

/* =============================================================
   FEATURE 5: 好評輪播
   ============================================================= */
const REVIEWS = [
  {name:'eicheuq8h7',city:'',crystal:'客製款 頂級銀曜石 銀鱗手鍊',stars:5,text:'會配合你的五行及預算卻給你全方位建議，配好的手鍊也非常好看，推薦各位',time:'2025/12/29'},
  {name:'l5v3e74kf8',city:'',crystal:'鋼鐵防禦 頂級天然鐵膽石',stars:5,text:'CP值：讚',time:'2025/12/17'},
  {name:'yeh552798',city:'',crystal:'天然 華青石 手鍊 10mm',stars:5,text:'二色性 維京人的羅盤 指引方向',time:'2025/12/11'},
  {name:'jfc16888',city:'',crystal:'天然龍宮舍利桶珠手鍊',stars:5,text:'收到商品包裝良好，送貨快速，這款桶珠手鍊還蠻喜歡的，有需要會再回購看看其他商品……',time:'2025/12/07'},
  {name:'tasiong109',city:'',crystal:'天然龍宮舍利桶珠手鍊',stars:5,text:'完碧品項 如商品照片 實物更加碧 閃閃 更是服務超好 回應超快 寄件也快速 很完碧的一次購物體驗 大捨呀！',time:'2025/12/01'},
  {name:'mandytseng0511',city:'',crystal:'天鐵設計款 五行手鍊 藍虍眼 海藍寶',stars:5,text:'感謝賣家，針對個人的五行缺乏的部分做設計款補足，溝通也很順暢，推薦給大家！',time:'2025/11/28'},
  {name:'fayefang20',city:'',crystal:'頂級 黑碧璽三圈 6mm+',stars:5,text:'Black 電氣石 擋煞 辟邪 防小人 能量手鍊 穩定情緒 接地',time:'2025/11/20'},
  {name:'c9301115',city:'',crystal:'頂級 佛眼 龍宮舍利 10mm+',stars:5,text:'很好看起來很好很有品質我很喜歡，下次有機會會再回購',time:'2025/11/20'},
  {name:'yct585',city:'',crystal:'巨無霸 大地瑪瑙手排 22mm',stars:5,text:'本來不想寫評價，看到老闆貼心的問候，給予肯定，雙11活動所有東西都可以免運，就瘋狂地買，沒想到這大地瑪瑙這麼這麼的碧，碧到覺得自己好幸運可以買到，感恩所有碧好的事物和人都能得到祝福！值得推薦的好賣家！',time:'2025/11/16'},
  {name:'lovebl927',city:'',crystal:'天然 薔薇輝石 手鍊 12mm',stars:5,text:'出貨超快，很碧的薔薇🌹 開箱比想像中更滿意！實體很讚，賣家經營用心~會推薦朋友購買！',time:'2025/11/13'},
  {name:'jesscia985',city:'',crystal:'天然 頂級 白水晶 鑽切手排 14mm',stars:5,text:'白水晶之王',time:'2026/01/29'},
  {name:'jesscia985',city:'',crystal:'頂級咖啡鈦晶 太陽花手排 14mm',stars:5,text:'賣家很 nice，鈦晶手排與白水晶手排都超碧的，包裝超特別，防護力超強，物流也超神速，總之，一整個就是 "超 讚"',time:'2026/01/29'},
  {name:'yenrensu',city:'',crystal:'天然 咖啡鈦晶 手排 13mm',stars:5,text:'貓眼 鋼鈦晶 招財 旺事業 避邪 擋煞 微調奢華 復古金氣質',time:'2026/01/19'},
  {name:'liudfu',city:'',crystal:'泰國 黃龍宮舍利手鍊 11mm',stars:5,text:'用心包裝溝通良好的賣家😍快速出貨高cp 值的好賣家值得推薦大家一起來賣家逛逛購買，給5星好評喔',time:'2025/10/21'},
  {name:'liudfu',city:'',crystal:'泰國 黃龍宮舍利手鍊 13mm',stars:5,text:'好用心的包裝超愛的😍快速出貨高cp 值的好賣家值得推薦大家一起來賣家逛逛購買，給5星好評喔',time:'2025/10/21'}
];

let reviewIdx = 0;
function initReviewCarousel(){
  const el = document.getElementById('review-carousel');
  if(!el) return;
  function show(){
    const r = REVIEWS[reviewIdx % REVIEWS.length];
    el.style.opacity = '0';
    setTimeout(()=>{
      el.innerHTML = `
        <div class="review-card">
          <div class="review-header">
            <span class="review-stars">${'⭐'.repeat(r.stars)}</span>
            <span class="review-meta">${r.name}${r.city?' · '+r.city:''} · ${r.time}</span>
          </div>
          <p class="review-text">「${r.text}」</p>
          <div class="review-product">
            <span class="tag tag-gold text-xs">購買：${r.crystal}</span>
          </div>
        </div>`;
      el.style.opacity = '1';
      reviewIdx++;
    }, 300);
  }
  show();
  setInterval(show, 6000);
}

/* =============================================================
   FEATURE 6: 商品實拍輪播（框架，等替換照片）
   ============================================================= */
const PRODUCT_PHOTOS = {
  // 格式: '商品名': ['photo1_url', 'photo2_url', ...]
  // 目前用 placeholder，店家提供照片後替換 URL
  '鈦晶手排': [],
  '粉晶': [],
  '綠幽靈': [],
  '海藍寶': [],
  '紫水晶': [],
  '黃水晶': []
};

function initPhotoCarousel(cardEl, productName){
  const photos = PRODUCT_PHOTOS[productName];
  if(!photos || !photos.length) return; // No photos yet, skip
  
  const wrapper = document.createElement('div');
  wrapper.className = 'photo-carousel';
  let pIdx = 0;
  
  function render(){
    wrapper.innerHTML = `
      <img src="${photos[pIdx]}" alt="${productName}" class="photo-slide">
      <div class="photo-dots">${photos.map((_,i)=>`<span class="photo-dot ${i===pIdx?'active':''}"></span>`).join('')}</div>`;
  }
  
  wrapper.addEventListener('click', ()=>{
    pIdx = (pIdx + 1) % photos.length;
    render();
  });
  
  render();
  const iconEl = cardEl.querySelector('.product-icon');
  if(iconEl) iconEl.replaceWith(wrapper);
}

/* =============================================================
   Track divination for achievements
   ============================================================= */
const _origRunAnalysis = typeof runAnalysis === 'function' ? runAnalysis : null;
if(_origRunAnalysis){
  const __origRA = runAnalysis;
  runAnalysis = function(){
    __origRA.apply(this, arguments);
    incrementAchievement('divination');
    try{
      const typeEl = document.getElementById('question-type');
      if(typeEl && typeEl.value) incrementAchievement('types_asked', typeEl.value);
    }catch(e){}
    // Refresh badge display
    setTimeout(renderAchievements, 500);
  };
}

/* =============================================================
   Init all engagement features
   ============================================================= */
document.addEventListener('DOMContentLoaded', function(){
  renderDailyFortune();
  renderAchievements();
  renderCrystalEncyclopedia();
  initReviewCarousel();
  
  // Nav tab switching for new sections
  document.querySelectorAll('.nav-extra-tab').forEach(tab=>{
    tab.addEventListener('click', function(){
      const target = this.dataset.target;
      document.querySelectorAll('.extra-section').forEach(s=>s.classList.add('hidden'));
      const section = document.getElementById(target);
      if(section) section.classList.remove('hidden');
      document.querySelectorAll('.nav-extra-tab').forEach(t=>t.classList.remove('active'));
      this.classList.add('active');
      section.scrollIntoView({behavior:'smooth',block:'start'});
    });
  });
});
/* =============================================================
   塔羅牌面生成器 — Canvas 繪製 78 張牌面
   ============================================================= */
const TAROT_CARD_SYMBOLS = {
  // 大阿爾卡納 0-21
  0:  {sym:'🃏', color:'#FFD700', bg:'#1a0a30', sub:'0'},
  1:  {sym:'∞',  color:'#FFD700', bg:'#2D0A0A', sub:'I'},
  2:  {sym:'☽',  color:'#C0C0FF', bg:'#0a0a2d', sub:'II'},
  3:  {sym:'♀',  color:'#FFB6C1', bg:'#2D0A1A', sub:'III'},
  4:  {sym:'♂',  color:'#DC143C', bg:'#2D0A0A', sub:'IV'},
  5:  {sym:'✝',  color:'#FFD700', bg:'#1a1a0a', sub:'V'},
  6:  {sym:'♡',  color:'#FF69B4', bg:'#2D0A1A', sub:'VI'},
  7:  {sym:'⚔',  color:'#C0C0C0', bg:'#0a1a2d', sub:'VII'},
  8:  {sym:'∞',  color:'#FFD700', bg:'#2D1A0A', sub:'VIII'},
  9:  {sym:'☆',  color:'#C0C0FF', bg:'#0a0a2d', sub:'IX'},
  10: {sym:'☸',  color:'#FFD700', bg:'#1a0a2d', sub:'X'},
  11: {sym:'⚖',  color:'#FFD700', bg:'#2D0A0A', sub:'XI'},
  12: {sym:'⚓',  color:'#4169E1', bg:'#0a1a2d', sub:'XII'},
  13: {sym:'☠',  color:'#F5F5F5', bg:'#0a0a0a', sub:'XIII'},
  14: {sym:'⚗',  color:'#87CEEB', bg:'#0a2d2d', sub:'XIV'},
  15: {sym:'⛧',  color:'#8B0000', bg:'#0a0a0a', sub:'XV'},
  16: {sym:'⚡',  color:'#FF4500', bg:'#1a0a0a', sub:'XVI'},
  17: {sym:'★',  color:'#FFD700', bg:'#0a0a2d', sub:'XVII'},
  18: {sym:'☾',  color:'#C0C0FF', bg:'#0a0a2d', sub:'XVIII'},
  19: {sym:'☀',  color:'#FFD700', bg:'#2D1A0A', sub:'XIX'},
  20: {sym:'♱',  color:'#FFD700', bg:'#1a0a2d', sub:'XX'},
  21: {sym:'⊕',  color:'#FFD700', bg:'#0a2d0a', sub:'XXI'}
};

// 小阿爾卡納花色
const SUIT_STYLES = {
  '權杖': {sym:'🔥', color:'#FF6347', bg:'#2D0A0A', accent:'#FF4500'},
  '聖杯': {sym:'💧', color:'#4169E1', bg:'#0a0a2d', accent:'#1E90FF'},
  '寶劍': {sym:'⚔',  color:'#C0C0C0', bg:'#1a1a1a', accent:'#A9A9A9'},
  '金幣': {sym:'⬟',  color:'#FFD700', bg:'#1a1a0a', accent:'#DAA520'}
};

const COURT_SYMBOLS = {
  '王牌':'✦','二':'II','三':'III','四':'IV','五':'V',
  '六':'VI','七':'VII','八':'VIII','九':'IX','十':'X',
  '侍者':'👤','騎士':'🐍','皇名':'♛','國王':'♚'
};

function generateTarotCardImage(card){
  const canvas = document.createElement('canvas');
  canvas.width = 180;
  canvas.height = 280;
  const ctx = canvas.getContext('2d');
  
  let style;
  if(card.id <= 21){
    // Major Arcana
    style = TAROT_CARD_SYMBOLS[card.id];
    drawMajorCard(ctx, card, style);
  } else {
    // Minor Arcana
    let suit='', rank='';
    for(const s of ['權杖','聖杯','寶劍','金幣']){
      if(card.n.includes(s)){ suit=s; rank=card.n.replace(s,''); break; }
    }
    style = SUIT_STYLES[suit] || SUIT_STYLES['金幣'];
    drawMinorCard(ctx, card, style, suit, rank);
  }
  
  return canvas.toDataURL('image/png');
}

function drawMajorCard(ctx, card, s){
  const W=180, H=280;
  
  // Background gradient
  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, s.bg);
  grad.addColorStop(0.5, lighten(s.bg, 15));
  grad.addColorStop(1, s.bg);
  ctx.fillStyle = grad;
  roundRect(ctx, 0, 0, W, H, 12);
  ctx.fill();
  
  // Border
  ctx.strokeStyle = s.color;
  ctx.lineWidth = 2;
  roundRect(ctx, 3, 3, W-6, H-6, 10);
  ctx.stroke();
  
  // Inner border
  ctx.strokeStyle = 'rgba('+hexToRgb(s.color)+',0.3)';
  ctx.lineWidth = 1;
  roundRect(ctx, 8, 8, W-16, H-16, 8);
  ctx.stroke();
  
  // Decorative corners
  drawCornerDeco(ctx, s.color, W, H);
  
  // Number at top
  ctx.fillStyle = s.color;
  ctx.font = 'bold 16px serif';
  ctx.textAlign = 'center';
  ctx.fillText(s.sub, W/2, 30);
  
  // Main symbol (large)
  ctx.font = '60px serif';
  ctx.fillStyle = s.color;
  ctx.fillText(s.sym, W/2, H/2 - 10);
  
  // Glow effect behind symbol
  ctx.shadowColor = s.color;
  ctx.shadowBlur = 20;
  ctx.fillText(s.sym, W/2, H/2 - 10);
  ctx.shadowBlur = 0;
  
  // Card name at bottom
  ctx.fillStyle = s.color;
  ctx.font = 'bold 18px "Noto Sans TC", sans-serif';
  ctx.fillText(card.n, W/2, H - 40);
  
  // Element
  ctx.font = '12px sans-serif';
  ctx.fillStyle = 'rgba('+hexToRgb(s.color)+',0.6)';
  ctx.fillText(card.el, W/2, H - 20);
}

function drawMinorCard(ctx, card, s, suit, rank){
  const W=180, H=280;
  
  // Background
  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, s.bg);
  grad.addColorStop(0.5, lighten(s.bg, 10));
  grad.addColorStop(1, s.bg);
  ctx.fillStyle = grad;
  roundRect(ctx, 0, 0, W, H, 12);
  ctx.fill();
  
  // Border
  ctx.strokeStyle = s.accent;
  ctx.lineWidth = 2;
  roundRect(ctx, 3, 3, W-6, H-6, 10);
  ctx.stroke();
  
  // Inner frame
  ctx.strokeStyle = 'rgba('+hexToRgb(s.accent)+',0.2)';
  ctx.lineWidth = 1;
  roundRect(ctx, 10, 10, W-20, H-20, 6);
  ctx.stroke();
  
  // Corners
  drawCornerDeco(ctx, s.accent, W, H);
  
  // Suit symbol at top
  ctx.font = '24px serif';
  ctx.fillStyle = s.color;
  ctx.textAlign = 'center';
  ctx.fillText(s.sym, W/2, 35);
  
  // Rank in center
  const courtSym = COURT_SYMBOLS[rank] || rank;
  if(['侍者','騎士','皇名','國王'].includes(rank)){
    // Court card: larger symbol
    ctx.font = '48px serif';
    ctx.fillStyle = s.color;
    ctx.fillText(courtSym, W/2, H/2);
    ctx.font = '14px sans-serif';
    ctx.fillStyle = 'rgba('+hexToRgb(s.color)+',0.7)';
    ctx.fillText(rank, W/2, H/2 + 25);
  } else if(rank === '王牌'){
    // Ace: big symbol
    ctx.font = '64px serif';
    ctx.shadowColor = s.color;
    ctx.shadowBlur = 15;
    ctx.fillStyle = s.color;
    ctx.fillText(s.sym, W/2, H/2 + 5);
    ctx.shadowBlur = 0;
  } else {
    // Number cards: draw pip pattern
    const num = ['二','三','四','五','六','七','八','九','十'].indexOf(rank) + 2;
    drawPips(ctx, s.sym, s.color, W, H, num || 1);
  }
  
  // Card name at bottom
  ctx.fillStyle = s.color;
  ctx.font = 'bold 16px "Noto Sans TC", sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(card.n, W/2, H - 38);
  
  // Suit name
  ctx.font = '11px sans-serif';
  ctx.fillStyle = 'rgba('+hexToRgb(s.color)+',0.5)';
  ctx.fillText(suit+'牌組', W/2, H - 20);
}

function drawPips(ctx, sym, color, W, H, count){
  ctx.font = '22px serif';
  ctx.fillStyle = color;
  ctx.textAlign = 'center';
  
  // Pip positions for 2-10
  const cx = W/2, cy = H/2;
  const positions = {
    2: [[cx,cy-30],[cx,cy+30]],
    3: [[cx,cy-35],[cx,cy],[cx,cy+35]],
    4: [[cx-25,cy-25],[cx+25,cy-25],[cx-25,cy+25],[cx+25,cy+25]],
    5: [[cx-25,cy-25],[cx+25,cy-25],[cx,cy],[cx-25,cy+25],[cx+25,cy+25]],
    6: [[cx-25,cy-30],[cx+25,cy-30],[cx-25,cy],[cx+25,cy],[cx-25,cy+30],[cx+25,cy+30]],
    7: [[cx-25,cy-35],[cx+25,cy-35],[cx-25,cy],[cx,cy],[cx+25,cy],[cx-25,cy+35],[cx+25,cy+35]],
    8: [[cx-25,cy-40],[cx+25,cy-40],[cx-25,cy-13],[cx+25,cy-13],[cx-25,cy+13],[cx+25,cy+13],[cx-25,cy+40],[cx+25,cy+40]],
    9: [[cx-25,cy-40],[cx+25,cy-40],[cx-25,cy-13],[cx+25,cy-13],[cx,cy],[cx-25,cy+13],[cx+25,cy+13],[cx-25,cy+40],[cx+25,cy+40]],
    10:[[cx-25,cy-45],[cx+25,cy-45],[cx-25,cy-18],[cx+25,cy-18],[cx,cy-8],[cx,cy+12],[cx-25,cy+22],[cx+25,cy+22],[cx-25,cy+48],[cx+25,cy+48]]
  };
  
  const pts = positions[count] || positions[2];
  pts.forEach(([x,y]) => ctx.fillText(sym, x, y+6));
}

function drawCornerDeco(ctx, color, W, H){
  ctx.strokeStyle = 'rgba('+hexToRgb(color)+',0.4)';
  ctx.lineWidth = 1;
  const d = 18;
  // Top-left
  ctx.beginPath(); ctx.moveTo(14,14+d); ctx.lineTo(14,14); ctx.lineTo(14+d,14); ctx.stroke();
  // Top-right
  ctx.beginPath(); ctx.moveTo(W-14-d,14); ctx.lineTo(W-14,14); ctx.lineTo(W-14,14+d); ctx.stroke();
  // Bottom-left
  ctx.beginPath(); ctx.moveTo(14,H-14-d); ctx.lineTo(14,H-14); ctx.lineTo(14+d,H-14); ctx.stroke();
  // Bottom-right
  ctx.beginPath(); ctx.moveTo(W-14-d,H-14); ctx.lineTo(W-14,H-14); ctx.lineTo(W-14,H-14-d); ctx.stroke();
}

function roundRect(ctx, x, y, w, h, r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

function hexToRgb(hex){
  hex = hex.replace('#','');
  if(hex.length===3) hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
  const r=parseInt(hex.substring(0,2),16);
  const g=parseInt(hex.substring(2,4),16);
  const b=parseInt(hex.substring(4,6),16);
  return r+','+g+','+b;
}

function lighten(hex, amt){
  hex = hex.replace('#','');
  if(hex.length===3) hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
  let r=parseInt(hex.substring(0,2),16);
  let g=parseInt(hex.substring(2,4),16);
  let b=parseInt(hex.substring(4,6),16);
  r=Math.min(255,r+amt); g=Math.min(255,g+amt); b=Math.min(255,b+amt);
  return '#'+r.toString(16).padStart(2,'0')+g.toString(16).padStart(2,'0')+b.toString(16).padStart(2,'0');
}

// Cache generated card images
const _tarotImageCache = {};
function getTarotCardImage(card){
  if(!_tarotImageCache[card.id]){
    _tarotImageCache[card.id] = generateTarotCardImage(card);
  }
  return _tarotImageCache[card.id];
}

/* =============================================================
   命理小遊戲 1: 五行猜猜看
   ============================================================= */
const WUXING_QUIZ_BANK = [
  {q:'「甲」屬於哪個五行？',a:'木',opts:['金','木','水','火','土']},
  {q:'「丙」屬於哪個五行？',a:'火',opts:['金','木','水','火','土']},
  {q:'「庚」屬於哪個五行？',a:'金',opts:['金','木','水','火','土']},
  {q:'「壬」屬於哪個五行？',a:'水',opts:['金','木','水','火','土']},
  {q:'「己」屬於哪個五行？',a:'土',opts:['金','木','水','火','土']},
  {q:'木生什麼？',a:'火',opts:['金','木','水','火','土']},
  {q:'火生什麼？',a:'土',opts:['金','木','水','火','土']},
  {q:'金生什麼？',a:'水',opts:['金','木','水','火','土']},
  {q:'水生什麼？',a:'木',opts:['金','木','水','火','土']},
  {q:'土生什麼？',a:'金',opts:['金','木','水','火','土']},
  {q:'水克什麼？',a:'火',opts:['金','木','水','火','土']},
  {q:'木克什麼？',a:'土',opts:['金','木','水','火','土']},
  {q:'火克什麼？',a:'金',opts:['金','木','水','火','土']},
  {q:'金克什麼？',a:'木',opts:['金','木','水','火','土']},
  {q:'土克什麼？',a:'水',opts:['金','木','水','火','土']},
  {q:'子時是幾點到幾點？',a:'23-01',opts:['23-01','01-03','05-07','11-13']},
  {q:'午時是幾點到幾點？',a:'11-13',opts:['09-11','11-13','13-15','07-09']},
  {q:'寅時是幾點到幾點？',a:'03-05',opts:['01-03','03-05','05-07','07-09']},
  {q:'紫水晶屬於哪個五行？',a:'火',opts:['金','木','水','火','土']},
  {q:'黃水晶屬於哪個五行？',a:'土',opts:['金','木','水','火','土']},
  {q:'綠幽靈屬於哪個五行？',a:'木',opts:['金','木','水','火','土']},
  {q:'海藍寶屬於哪個五行？',a:'水',opts:['金','木','水','火','土']},
  {q:'鈦晶屬於哪個五行？',a:'金',opts:['金','木','水','火','土']},
  {q:'「比肩」的十神關係是？',a:'同我',opts:['生我','同我','我生','我克','克我']},
  {q:'「正財」的十神關係是？',a:'我克',opts:['生我','同我','我生','我克','克我']},
  {q:'塔羅牌「愚者」的編號是？',a:'0',opts:['0','1','21','22']},
  {q:'塔羅大牌共有幾張？',a:'22',opts:['20','21','22','78']},
  {q:'八字的「日主」指的是？',a:'日柱天干',opts:['年柱天干','月柱天干','日柱天干','時柱天干']},
  {q:'「坤」卦代表什麼？',a:'地',opts:['天','地','水','火']},
  {q:'「乾」卦代表什麼？',a:'天',opts:['天','地','山','澤']}
];

let wxGame = {score:0, total:0, current:null, answered:false};

function startWuxingGame(){
  wxGame = {score:0, total:0, current:null, answered:false, questions:[]};
  // Pick 5 random questions
  const shuffled = [...WUXING_QUIZ_BANK].sort(()=>Math.random()-0.5);
  wxGame.questions = shuffled.slice(0, 5);
  nextWuxingQ();
}

function nextWuxingQ(){
  const container = document.getElementById('wuxing-game-content');
  if(!container) return;
  
  if(wxGame.total >= wxGame.questions.length){
    showWuxingResult();
    return;
  }
  
  wxGame.answered = false;
  wxGame.current = wxGame.questions[wxGame.total];
  const q = wxGame.current;
  
  container.innerHTML = `
    <div class="game-progress">第 ${wxGame.total+1}/${wxGame.questions.length} 題　得分：${wxGame.score}</div>
    <h4 class="game-question">${q.q}</h4>
    <div class="game-options">${q.opts.map(o=>`
      <button class="game-opt" onclick="answerWuxing('${o}',this)">${o}</button>`).join('')}
    </div>
    <div id="game-feedback" class="game-feedback"></div>`;
}

function answerWuxing(ans, btn){
  if(wxGame.answered) return;
  wxGame.answered = true;
  
  const correct = ans === wxGame.current.a;
  if(correct) wxGame.score++;
  wxGame.total++;
  
  // Highlight
  btn.classList.add(correct ? 'correct' : 'wrong');
  document.querySelectorAll('.game-opt').forEach(b=>{
    b.disabled = true;
    if(b.textContent === wxGame.current.a) b.classList.add('correct');
  });
  
  const fb = document.getElementById('game-feedback');
  fb.innerHTML = correct 
    ? '<span class="fb-correct">✅ 正確！</span>'
    : `<span class="fb-wrong">❌ 答案是「${wxGame.current.a}」</span>`;
  
  setTimeout(nextWuxingQ, 1200);
}

function showWuxingResult(){
  const container = document.getElementById('wuxing-game-content');
  if(!container) return;
  const pct = Math.round(wxGame.score / wxGame.questions.length * 100);
  let title, msg;
  if(pct >= 80){ title='🏆 命理達人'; msg='你對五行的掌握非常厲害！'; }
  else if(pct >= 60){ title='📚 用功學生'; msg='基礎不錯，再練練就更強了！'; }
  else if(pct >= 40){ title='🌱 命理新手'; msg='繼續學習，五行世界很有趣！'; }
  else{ title='🔰 初來乍到'; msg='多獩幾次就會進步啦！'; }
  
  container.innerHTML = `
    <div class="game-result">
      <div class="game-result-icon">${pct>=60?'🍉':'💪'}</div>
      <h3>${title}</h3>
      <div class="game-score-big">${wxGame.score} / ${wxGame.questions.length}</div>
      <p class="text-dim">${msg}</p>
      <div class="game-actions mt-md">
        <button class="btn btn-gold" onclick="startWuxingGame()"><i class="fas fa-redo"></i> 再獩一次</button>
      </div>
    </div>`;
}

/* =============================================================
   命理小遊戲 2: 每日生肖配對
   ============================================================= */
const ZODIAC_DATA = [
  {name:'鼠',icon:'🐭',el:'水',best:['龍','猴','牛'],avoid:['馬','羊','兔']},
  {name:'牛',icon:'🐂',el:'土',best:['鼠','蛇','雞'],avoid:['馬','羊','狗']},
  {name:'虍',icon:'🐯',el:'木',best:['馬','狗','豬'],avoid:['蛇','猴']},
  {name:'兔',icon:'🐰',el:'木',best:['羊','狗','豬'],avoid:['鼠','龍','雞']},
  {name:'龍',icon:'🐲',el:'土',best:['鼠','猴','雞'],avoid:['狗','兔']},
  {name:'蛇',icon:'🐍',el:'火',best:['牛','雞'],avoid:['虍','豬']},
  {name:'馬',icon:'🐴',el:'火',best:['虍','羊','狗'],avoid:['鼠','牛']},
  {name:'羊',icon:'🐑',el:'土',best:['兔','馬','豬'],avoid:['鼠','牛','狗']},
  {name:'猴',icon:'🐵',el:'金',best:['鼠','龍'],avoid:['虍','豬']},
  {name:'雞',icon:'🐔',el:'金',best:['牛','龍','蛇'],avoid:['兔','狗']},
  {name:'狗',icon:'🐶',el:'土',best:['虍','兔','馬'],avoid:['龍','牛','羊','雞']},
  {name:'豬',icon:'🐷',el:'水',best:['虍','兔','羊'],avoid:['蛇','猴']}
];

function renderZodiacMatch(){
  const container = document.getElementById('zodiac-match-content');
  if(!container) return;
  container.innerHTML = `
    <p class="text-sm text-dim mb-md">選擇兩個生肖，看看配對結果！</p>
    <div class="zodiac-grid">${ZODIAC_DATA.map(z=>`
      <button class="zodiac-btn" onclick="selectZodiac('${z.name}')" data-zodiac="${z.name}">
        <span class="zodiac-icon">${z.icon}</span>
        <span class="zodiac-name">${z.name}</span>
      </button>`).join('')}
    </div>
    <div id="zodiac-selected" class="zodiac-selected mt-md"></div>
    <div id="zodiac-result-area" class="mt-md"></div>`;
}

let zodiacPair = [];
function selectZodiac(name){
  if(zodiacPair.length >= 2) zodiacPair = [];
  zodiacPair.push(name);
  
  // Highlight
  document.querySelectorAll('.zodiac-btn').forEach(b=>{
    b.classList.toggle('selected', zodiacPair.includes(b.dataset.zodiac));
  });
  
  const selEl = document.getElementById('zodiac-selected');
  selEl.textContent = zodiacPair.join(' ❤️ ');
  
  if(zodiacPair.length === 2){
    showZodiacResult(zodiacPair[0], zodiacPair[1]);
  }
}

function showZodiacResult(a, b){
  const zA = ZODIAC_DATA.find(z=>z.name===a);
  const zB = ZODIAC_DATA.find(z=>z.name===b);
  if(!zA || !zB) return;
  
  let score, level, desc;
  if(zA.best.includes(b) && zB.best.includes(a)){
    score = 95; level = '天生一對 💕'; desc = `${a}與${b}是命理上的絕佳配對！彼此互補，感情和諧。`;
  } else if(zA.best.includes(b) || zB.best.includes(a)){
    score = 80; level = '相合有緣 ✨'; desc = `${a}與${b}有不錯的緣分，相處愉快，值得珍惜。`;
  } else if(zA.avoid.includes(b) || zB.avoid.includes(a)){
    score = 35; level = '需要磨合 ⚡'; desc = `${a}與${b}在傳統命理上有些沖突，但真愛可以跨越一切，多包容多理解就好。`;
  } else {
    score = 65; level = '平穩中性 ☁️'; desc = `${a}與${b}不特別沖也不特別合，關鍵看兩人的經營。`;
  }
  
  const resultEl = document.getElementById('zodiac-result-area');
  resultEl.innerHTML = `
    <div class="zodiac-result card" style="animation:scaleIn 0.4s">
      <div class="zodiac-pair-icons">${zA.icon} ❤️ ${zB.icon}</div>
      <div class="zodiac-match-score">${score}%</div>
      <div class="zodiac-match-level">${level}</div>
      <p class="text-sm">${desc}</p>
      <p class="text-xs text-muted mt-sm">五行：${a}(${zA.el}) × ${b}(${zB.el})</p>
      <button class="btn btn-outline btn-sm mt-md" onclick="shareZodiacMatch('${a}','${b}','${score}')">
        <i class="fas fa-share-alt"></i> 分享配對結果
      </button>
    </div>`;
}

function shareZodiacMatch(a, b, score){
  const text = `${a} ❤️ ${b} 配對指數 ${score}%！你跟誰配？快來測 👉 `;
  const url = window.location.href.split('?')[0];
  if(navigator.share) navigator.share({title:'生肖配對',text,url}).catch(()=>{});
  else { navigator.clipboard.writeText(text+url).then(()=>alert('已複製！')); }
}

/* =============================================================
   命理小遊戲 3: 今日幸運指南（依命主五行喜用神）
   ============================================================= */
function generateLuckyInfo(){
  const container = document.getElementById('lucky-gen-content');
  if(!container) return;

  // 必須先填寫基本資料
  if(!S.bazi){
    container.innerHTML = `
      <div class="fortune-draw-area">
        <div style="font-size:2.5rem;margin-bottom:var(--sp-sm);opacity:0.5">🔒</div>
        <p class="text-dim" style="margin-bottom:var(--sp-md)">需要先完成基本資料（生日時辰），才能依你的五行喜用神算出今日幸運指南</p>
        <button class="btn btn-primary" onclick="goStep(0);window.scrollTo({top:0,behavior:'smooth'})">
          <i class="fas fa-pen"></i> 前往填寫資料
        </button>
      </div>`;
    return;
  }

  const b = S.bazi;
  const today = new Date();
  const dayOfWeek = ['日','一','二','三','四','五','六'][today.getDay()];
  const todayGZ = getTodayGanZhi();

  // 依喜用神五行推薦顏色
  const favEl = b.fav[0] || b.dmEl;
  const favEl2 = b.fav[1] || b.dmEl;

  const colorsByEl = {
    '金': [{name:'白色',hex:'#f5f5f5',meaning:'金行正色，淨化氣場'},{name:'金色',hex:'#d4af37',meaning:'強化權威與成就'},{name:'銀色',hex:'#94a3b8',meaning:'冷靜理性，金行守護'}],
    '木': [{name:'綠色',hex:'#16a34a',meaning:'木行正色，健康成長'},{name:'青色',hex:'#06b6d4',meaning:'生發之力，貴人能量'},{name:'翠綠',hex:'#059669',meaning:'木行生機盎然'}],
    '水': [{name:'黑色',hex:'#1a1a1a',meaning:'水行正色，保護穩重'},{name:'藍色',hex:'#2563eb',meaning:'智慧溝通，水行流通'},{name:'深藍',hex:'#1e3a5f',meaning:'深沉內斂，水行蓄能'}],
    '火': [{name:'紅色',hex:'#dc2626',meaning:'火行正色，熱情行動力'},{name:'紫色',hex:'#9333ea',meaning:'靈性直覺，火行昇華'},{name:'橙色',hex:'#ea580c',meaning:'活力創造，火行擴展'}],
    '土': [{name:'黃色',hex:'#eab308',meaning:'土行正色，財運自信'},{name:'棕色',hex:'#92400e',meaning:'踏實安定，土行厚德'},{name:'米色',hex:'#d2b48c',meaning:'溫和穩重，土行包容'}]
  };

  const dayHash = today.getDate() + today.getMonth()*31;
  const favColors = colorsByEl[favEl] || colorsByEl['土'];
  const luckyColor = favColors[dayHash % favColors.length];

  // 幸運數字：依五行生數
  const elNums = {'木':[3,8],'火':[2,7],'土':[5,10],'金':[4,9],'水':[1,6]};
  const nums = elNums[favEl] || [5,10];
  const luckyNum = nums[dayHash % nums.length];

  // 幸運方位：依喜用神五行
  const elDirs = {'木':'東方','火':'南方','土':'中宮','金':'西方','水':'北方'};
  const elDirs2 = {'木':'東南','火':'西南','土':'東北','金':'西北','水':'正北'};
  const luckyDir = dayHash % 2 === 0 ? elDirs[favEl] : (elDirs2[favEl] || elDirs[favEl]);

  // 最佳時辰：依喜用神五行旺的時辰
  const elTimes = {
    '木': ['寅時(03-05)','卯時(05-07)'],
    '火': ['巳時(09-11)','午時(11-13)'],
    '土': ['辰時(07-09)','未時(13-15)','戌時(19-21)','丑時(01-03)'],
    '金': ['申時(15-17)','酉時(17-19)'],
    '水': ['亥時(21-23)','子時(23-01)']
  };
  const times = elTimes[favEl] || ['辰時(07-09)'];
  const luckyTime = times[dayHash % times.length];

  // 幸運水晶（依喜用神五行）
  const elCrystals = {
    '金': ['白水晶','鈦晶','銀髮晶'],
    '木': ['綠幽靈','東陵玉','橄欖石'],
    '水': ['海藍寶','月光石','藍玉髓'],
    '火': ['紅瑪瑙','紫水晶','石榴石'],
    '土': ['黃水晶','茶晶','虎眼石']
  };
  const crystals = elCrystals[favEl] || ['黃水晶'];
  const luckyCrystal = crystals[dayHash % crystals.length];

  container.innerHTML = `
    <div class="lucky-card" style="animation:scaleIn 0.4s">
      <h4 class="text-gold mb-sm">📅 星期${dayOfWeek}的專屬幸運指南</h4>
      <p class="text-xs text-dim mb-md">依據你的八字喜用神【${b.fav.join('、')}行】計算</p>
      <div class="lucky-grid">
        <div class="lucky-item">
          <div class="lucky-label">幸運色</div>
          <div class="lucky-value">
            <span class="lucky-color-dot" style="background:${luckyColor.hex}"></span>
            ${luckyColor.name}
          </div>
          <div class="lucky-sub">${favEl}行 · ${luckyColor.meaning}</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">幸運數字</div>
          <div class="lucky-value lucky-num">${luckyNum}</div>
          <div class="lucky-sub">${favEl}行生數</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">幸運方位</div>
          <div class="lucky-value">🧭 ${luckyDir}</div>
          <div class="lucky-sub">${favEl}行方位</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">最佳時辰</div>
          <div class="lucky-value">⏰ ${luckyTime}</div>
          <div class="lucky-sub">${favEl}行旺時</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">幸運水晶</div>
          <div class="lucky-value">💎 ${luckyCrystal}</div>
          <div class="lucky-sub">${favEl}行水晶</div>
        </div>
        <div class="lucky-item">
          <div class="lucky-label">今日干支</div>
          <div class="lucky-value">${todayGZ.dayGan}${todayGZ.dayZhi}</div>
          <div class="lucky-sub">${todayGZ.dayEl}行日</div>
        </div>
      </div>
      <p class="text-xs text-muted mt-md">每日 00:00 更新 · 依你命盤喜用神推算</p>
    </div>`;
}

/* Init games */
document.addEventListener('DOMContentLoaded', function(){
  renderZodiacMatch();
  generateLuckyInfo();
});
</script></body></html>
